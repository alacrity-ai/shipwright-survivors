(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const u of c.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function i(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(r){if(r.ep)return;r.ep=!0;const c=i(r);fetch(r.href,c)}})();function wb(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Vu={exports:{}},ho={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Og;function Ab(){if(Og)return ho;Og=1;var a=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function i(n,r,c){var u=null;if(c!==void 0&&(u=""+c),r.key!==void 0&&(u=""+r.key),"key"in r){c={};for(var h in r)h!=="key"&&(c[h]=r[h])}else c=r;return r=c.ref,{$$typeof:a,type:n,key:u,ref:r!==void 0?r:null,props:c}}return ho.Fragment=e,ho.jsx=i,ho.jsxs=i,ho}var Fg;function kb(){return Fg||(Fg=1,Vu.exports=Ab()),Vu.exports}var Gt=kb();function Eb(){window.addEventListener("contextmenu",a=>a.preventDefault()),window.addEventListener("dragover",a=>a.preventDefault()),window.addEventListener("drop",a=>a.preventDefault()),window.addEventListener("keydown",a=>{const e=a.target;if(!(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable))switch(a.code){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Space":case"Tab":a.preventDefault();break}}),window.addEventListener("mousedown",a=>{a.button===1&&a.preventDefault()})}function bi(a){if(a.startsWith("cockpit"))return 10;const e=a.match(/(\d{1,2})$/);return e?parseInt(e[1],10):0}function Rb(a){if(bi(a.id)===0){const i=a.id.replace(/\d+$/,"1");return ni(i)}return a}const z=32,Ch={cockpit0:{id:"cockpit0",name:"Cockpit",armor:20,cost:50,mass:50,behavior:{canFire:!0,isCockpit:!0,fire:{fireRate:.6,fireType:"bullet",fireDamage:4,projectileSpeed:600,lifetime:1.8,accuracy:.3}},sprite:"cockpit0",category:"system",subcategory:"system",dropRate:0},cockpit1:{id:"cockpit1",name:"Cockpit",armor:150,cost:50,mass:50,behavior:{canFire:!0,isCockpit:!0,fire:{fireRate:.8,fireType:"bullet",fireDamage:14,projectileSpeed:800,lifetime:1.8,accuracy:.75}},sprite:"cockpit1",category:"system",subcategory:"system",dropRate:0},hull0:{id:"hull0",name:"Hull Mk 0",armor:15,mass:50,cost:20,sprite:"hull0",category:"system",subcategory:"hull",dropRate:.07},hull1:{id:"hull1",name:"Hull Mk I",armor:50,mass:50,cost:20,sprite:"hull1",category:"hull",subcategory:"hull",dropRate:.05},hull2:{id:"hull2",name:"Hull Mk II",armor:75,mass:60,cost:40,sprite:"hull2",category:"hull",subcategory:"hull",dropRate:.05},hull3:{id:"hull3",name:"Hull Mk III",armor:100,mass:75,cost:80,sprite:"hull3",category:"hull",subcategory:"hull",dropRate:.04},hull4:{id:"hull4",name:"Hull Mk IV",armor:150,mass:90,cost:140,sprite:"hull4",category:"hull",subcategory:"hull",dropRate:.03},facetplate0:{id:"facetplate0",name:"Facetplate Mk 0",armor:20,mass:30,cost:30,sprite:"facetplate0",category:"system",subcategory:"system",behavior:{rammingDamageMultiplier:1.1,rammingArmor:7},dropRate:.05},facetplate1:{id:"facetplate1",name:"Facetplate Mk I",armor:75,mass:30,cost:30,sprite:"facetplate1",category:"hull",subcategory:"facetplate",dropRate:.05,behavior:{rammingDamageMultiplier:1.3,rammingArmor:7}},facetplate2:{id:"facetplate2",name:"Facetplate Mk II",armor:100,mass:40,cost:60,sprite:"facetplate2",category:"hull",subcategory:"facetplate",behavior:{rammingDamageMultiplier:1.5,rammingArmor:12},dropRate:.04},facetplate3:{id:"facetplate3",name:"Facetplate Mk III",armor:125,mass:50,cost:100,sprite:"facetplate3",category:"hull",subcategory:"facetplate",behavior:{rammingDamageMultiplier:1.7,rammingArmor:17},dropRate:.03},facetplate4:{id:"facetplate4",name:"Facetplate Mk IV",armor:175,mass:60,cost:120,sprite:"facetplate4",category:"hull",subcategory:"facetplate",behavior:{rammingDamageMultiplier:2,rammingArmor:22},dropRate:.02},turret0:{id:"turret0",name:"Turret Mk 0",armor:20,cost:40,mass:40,sprite:"turret0",behavior:{canFire:!0,fire:{fireRate:1,fireType:"bullet",fireDamage:2,projectileSpeed:700,lifetime:2.2,accuracy:.5}},category:"system",subcategory:"system",dropRate:.3,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret1:{id:"turret1",name:"Turret Mk I",armor:40,cost:40,mass:40,sprite:"turret1",behavior:{canFire:!0,fire:{fireRate:1,fireType:"bullet",fireDamage:10,projectileSpeed:800,lifetime:1.8,accuracy:.65}},category:"weapon",subcategory:"turret",dropRate:.3,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret2:{id:"turret2",name:"Turret Mk II",armor:50,cost:100,mass:50,sprite:"turret2",behavior:{canFire:!0,fire:{fireRate:2,fireType:"bullet",fireDamage:16,projectileSpeed:800,lifetime:2.2,accuracy:.75}},category:"weapon",subcategory:"turret",dropRate:.2,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret3:{id:"turret3",name:"Turret Mk III",armor:75,cost:200,mass:60,sprite:"turret3",behavior:{canFire:!0,fire:{fireRate:3,fireType:"bullet",fireDamage:20,projectileSpeed:900,lifetime:2.2,accuracy:.9}},category:"weapon",subcategory:"turret",dropRate:.15,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret4:{id:"turret4",name:"Turret Mk IV",armor:100,cost:400,mass:100,sprite:"turret4",behavior:{canFire:!0,fire:{fireRate:4,fireType:"bullet",fireDamage:30,projectileSpeed:1e3,lifetime:2.2,accuracy:.95}},category:"weapon",subcategory:"turret",dropRate:.12,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},explosiveLance0:{id:"explosiveLance0",name:"Explosive Lance Mk 0",armor:60,cost:120,mass:80,sprite:"explosiveLance0",category:"system",subcategory:"system",behavior:{canFire:!0,fire:{fireRate:.5,fireType:"explosiveLance",fireDamage:1,explosionDamage:2,explosionRadiusBlocks:3,detonationDelayMs:1500,projectileSpeed:1e3,lifetime:.8,accuracy:.95}},dropRate:.2},explosiveLance1:{id:"explosiveLance1",name:"Explosive Lance Mk I",armor:60,cost:140,mass:80,sprite:"explosiveLance1",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.5,fireType:"explosiveLance",fireDamage:1,explosionDamage:20,explosionRadiusBlocks:3,detonationDelayMs:1500,projectileSpeed:1600,lifetime:.8,accuracy:.95}},dropRate:.15},explosiveLance2:{id:"explosiveLance2",name:"Explosive Lance Mk II",armor:80,cost:220,mass:90,sprite:"explosiveLance2",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.6,fireType:"explosiveLance",fireDamage:1,explosionDamage:25,explosionRadiusBlocks:4,detonationDelayMs:1500,projectileSpeed:1600,lifetime:.85,accuracy:.97}},dropRate:.14},explosiveLance3:{id:"explosiveLance3",name:"Explosive Lance Mk III",armor:90,cost:360,mass:110,sprite:"explosiveLance3",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.7,fireType:"explosiveLance",fireDamage:1,explosionDamage:30,explosionRadiusBlocks:5,detonationDelayMs:1500,projectileSpeed:1600,lifetime:.9,accuracy:.98}},dropRate:.13},explosiveLance4:{id:"explosiveLance4",name:"Explosive Lance Mk IV",armor:100,cost:600,mass:120,sprite:"explosiveLance4",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.8,fireType:"explosiveLance",fireDamage:1,explosionDamage:40,explosionRadiusBlocks:6,detonationDelayMs:1500,projectileSpeed:1600,lifetime:1,accuracy:.99}},dropRate:.1},laser0:{id:"laser0",name:"Laser Emitter Mk 0",armor:40,cost:500,mass:80,sprite:"laser0",category:"system",subcategory:"system",behavior:{canFire:!0,fire:{fireType:"laser",fireRate:0,energyCost:.15,fireDamage:1,projectileSpeed:0,lifetime:0,accuracy:1}},dropRate:.12},laser1:{id:"laser1",name:"Laser Emitter Mk I",armor:80,cost:500,mass:100,sprite:"laser1",category:"weapon",subcategory:"laser",behavior:{canFire:!0,energyMaxIncrease:60,fire:{fireType:"laser",fireDamage:2,energyCost:.15}},dropRate:.06},laser2:{id:"laser2",name:"Laser Emitter Mk II",armor:100,cost:1e3,mass:160,sprite:"laser2",category:"weapon",subcategory:"laser",behavior:{canFire:!0,energyMaxIncrease:80,fire:{fireType:"laser",fireDamage:3.5,energyCost:.2}},dropRate:.08},laser3:{id:"laser3",name:"Laser Emitter Mk III",armor:100,cost:1800,mass:160,sprite:"laser3",category:"weapon",subcategory:"laser",behavior:{canFire:!0,energyMaxIncrease:100,fire:{fireType:"laser",fireDamage:5,energyCost:.3}},dropRate:.06},reactor0:{id:"reactor0",name:"Reactor Mk 0",armor:25,cost:400,mass:60,behavior:{energyChargeRate:10},sprite:"reactor0",category:"system",subcategory:"system",dropRate:.08},reactor1:{id:"reactor1",name:"Reactor Mk I",armor:50,cost:400,mass:60,behavior:{energyChargeRate:10},sprite:"reactor1",category:"utility",subcategory:"energy",dropRate:.06},reactor2:{id:"reactor2",name:"Reactor Mk II",armor:75,cost:800,mass:80,behavior:{energyChargeRate:20},sprite:"reactor2",category:"utility",subcategory:"energy",dropRate:.03},battery0:{id:"battery0",name:"Battery Mk 0",armor:20,cost:200,mass:40,behavior:{energyMaxIncrease:100},sprite:"battery0",category:"system",subcategory:"system",dropRate:.08},battery1:{id:"battery1",name:"Battery Mk I",armor:30,cost:200,mass:50,behavior:{energyMaxIncrease:50},sprite:"battery1",category:"utility",subcategory:"energy",dropRate:.06},battery2:{id:"battery2",name:"Battery Mk II",armor:40,cost:400,mass:60,behavior:{energyMaxIncrease:100},sprite:"battery2",category:"utility",subcategory:"energy",dropRate:.03},shield0:{id:"shield0",name:"Shield Mk 0",armor:20,cost:200,mass:40,behavior:{shieldEfficiency:.5,shieldRadius:2,energyMaxIncrease:30,shieldEnergyDrain:1},sprite:"shield0",category:"system",subcategory:"system",dropRate:.08},shield1:{id:"shield1",name:"Shield Mk I",armor:60,cost:160,mass:50,behavior:{shieldEfficiency:.65,shieldRadius:2,energyMaxIncrease:30,shieldEnergyDrain:3},sprite:"shield1",category:"utility",subcategory:"shield",dropRate:.08},shield2:{id:"shield2",name:"Shield Mk II",armor:80,cost:300,mass:60,behavior:{shieldEfficiency:.8,shieldRadius:3,energyMaxIncrease:40,shieldEnergyDrain:5},sprite:"shield2",category:"utility",subcategory:"shield",dropRate:.03},shield3:{id:"shield3",name:"Shield Mk III",armor:100,cost:600,mass:70,behavior:{shieldEfficiency:1,shieldRadius:4,energyMaxIncrease:50,shieldEnergyDrain:7},sprite:"shield3",category:"utility",subcategory:"shield",dropRate:.02},engine0:{id:"engine0",name:"Engine Mk 0",armor:15,cost:35,mass:30,behavior:{canThrust:!0,thrustPower:50},sprite:"engine0",category:"system",subcategory:"system",dropRate:.08},engine1:{id:"engine1",name:"Engine Mk I",armor:40,cost:35,mass:30,behavior:{canThrust:!0,thrustPower:50},sprite:"engine1",category:"engine",subcategory:"engine",dropRate:.05},engine2:{id:"engine2",name:"Engine Mk II",armor:45,cost:60,mass:30,behavior:{canThrust:!0,thrustPower:75},sprite:"engine2",category:"engine",subcategory:"engine",dropRate:.08},engine3:{id:"engine3",name:"Engine Mk III",armor:50,cost:80,mass:30,behavior:{canThrust:!0,thrustPower:90},sprite:"engine3",category:"engine",subcategory:"engine",dropRate:.05},engine4:{id:"engine4",name:"Engine Mk IV",armor:55,mass:30,cost:160,behavior:{canThrust:!0,thrustPower:115},sprite:"engine4",category:"engine",subcategory:"engine",dropRate:.04},fin0:{id:"fin0",name:"Fin Mk 0",armor:10,mass:20,cost:30,behavior:{turnPower:.1},sprite:"fin0",category:"system",subcategory:"system",dropRate:.06},fin1:{id:"fin1",name:"Fin Mk I",armor:50,mass:10,cost:40,behavior:{turnPower:.5},sprite:"fin1",category:"hull",subcategory:"fin",dropRate:.06},fin2:{id:"fin2",name:"Fin Mk II",armor:75,mass:10,cost:80,behavior:{turnPower:1},sprite:"fin2",category:"hull",subcategory:"fin",dropRate:.06},fin3:{id:"fin3",name:"Fin Mk III",armor:90,mass:10,cost:120,behavior:{turnPower:1.5},sprite:"fin3",category:"hull",subcategory:"fin",dropRate:.05},fin4:{id:"fin4",name:"Fin Mk IV",armor:120,mass:10,cost:200,behavior:{turnPower:2},sprite:"fin4",category:"hull",subcategory:"fin",dropRate:.05},harvester0:{id:"harvester0",name:"Resource Harvester Mk 0",armor:50,mass:30,cost:120,behavior:{harvestRate:5},sprite:"harvester0",category:"system",subcategory:"system",dropRate:.1},harvester1:{id:"harvester1",name:"Resource Harvester Mk I",armor:50,mass:30,cost:120,behavior:{harvestRate:3},sprite:"harvester1",category:"utility",subcategory:"exploration",dropRate:.1},harvester2:{id:"harvester2",name:"Resource Harvester Mk II",armor:80,mass:40,cost:200,behavior:{harvestRate:5},sprite:"harvester2",category:"utility",subcategory:"exploration",dropRate:.1},haloBlade0:{id:"haloBlade0",name:"Halo Blade Mk 0",armor:100,mass:80,cost:400,behavior:{haloBladeProperties:{orbitingRadius:500,orbitingSpeed:1.2,size:64,damage:1,color:"#FFBF00",sprite:"energyRing0"}},sprite:"haloBlade0",category:"weapon",subcategory:"haloBlade",dropRate:.1},haloBlade1:{id:"haloBlade1",name:"Halo Blade Mk I",armor:120,mass:80,cost:400,behavior:{haloBladeProperties:{orbitingRadius:500,orbitingSpeed:2,size:64,damage:5,color:"#FFBF00",sprite:"energyRing1"}},sprite:"haloBlade1",category:"weapon",subcategory:"haloBlade",dropRate:.18},haloBlade2:{id:"haloBlade2",name:"Halo Blade Mk II",armor:140,mass:80,cost:600,behavior:{haloBladeProperties:{orbitingRadius:700,orbitingSpeed:2.4,size:64,damage:8,color:"#2CFF05",sprite:"energyRing2"}},sprite:"haloBlade2",category:"weapon",subcategory:"haloBlade",dropRate:.14},haloBlade3:{id:"haloBlade3",name:"Halo Blade Mk III",armor:160,mass:80,cost:900,behavior:{haloBladeProperties:{orbitingRadius:900,orbitingSpeed:2.8,size:64,damage:12,color:"#00FFFF",sprite:"energyRing3"}},sprite:"haloBlade3",category:"weapon",subcategory:"haloBlade",dropRate:.12},haloBlade4:{id:"haloBlade4",name:"Halo Blade Mk IV",armor:180,mass:80,cost:1200,behavior:{haloBladeProperties:{orbitingRadius:1100,orbitingSpeed:3.2,size:64,damage:15,color:"#7F00FF",sprite:"energyRing4"}},sprite:"haloBlade4",category:"weapon",subcategory:"haloBlade",dropRate:.1},fuelTank0:{id:"fuelTank0",name:"Fuel Tank Mk 0",armor:50,cost:50,mass:25,behavior:{fuelCapacityIncrease:20},sprite:"fuelTank0",category:"system",subcategory:"system",dropRate:.08},fuelTank1:{id:"fuelTank1",name:"Fuel Tank Mk I",armor:60,cost:50,mass:25,behavior:{fuelCapacityIncrease:25},sprite:"fuelTank1",category:"utility",subcategory:"fuel",dropRate:.08},fuelTank2:{id:"fuelTank2",name:"Fuel Tank Mk II",armor:70,cost:50,mass:30,behavior:{fuelCapacityIncrease:35},sprite:"fuelTank2",category:"utility",subcategory:"fuel",dropRate:.08},fuelTank3:{id:"fuelTank3",name:"Fuel Tank Mk III",armor:80,cost:50,mass:35,behavior:{fuelCapacityIncrease:50},sprite:"fuelTank3",category:"utility",subcategory:"fuel",dropRate:.08},fuelTank4:{id:"fuelTank4",name:"Fuel Tank Mk IV",armor:90,cost:50,mass:40,behavior:{fuelCapacityIncrease:75},sprite:"fuelTank4",category:"utility",subcategory:"fuel",dropRate:.07}};function Ao(){return Object.values(Ch)}function ni(a){return Ch[a]}function nm(a){const e=ni(a);return e?e.cost:void 0}function Bb(a){return Object.values(Ch).filter(e=>bi(e.id)===a)}function Ug(a){return bi(a.id)}function Rt(a,e){const i=a.createTexture();if(!i)throw new Error("Failed to create WebGL texture");return a.bindTexture(a.TEXTURE_2D,i),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),i}function Ib(a,e){const i=a.createTexture();if(!i)throw new Error("Failed to create WebGL texture");return a.bindTexture(a.TEXTURE_2D,i),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),i}function Wr(a,e,i){const n=a.createLinearGradient(0,0,0,e);n.addColorStop(0,i.body[0]),n.addColorStop(.3,i.body[1]),n.addColorStop(.7,i.body[2]),n.addColorStop(1,i.body[3]),a.fillStyle=n,a.fillRect(0,0,e,e),a.fillStyle=i.housing,a.fillRect(2,6,e-4,e-8),a.fillStyle=i.innerHousing,a.fillRect(3,7,e-6,e-10);const r=a.createLinearGradient(0,0,e,0);r.addColorStop(0,i.barrel[0]),r.addColorStop(.5,i.barrel[1]),r.addColorStop(1,i.barrel[2]),a.fillStyle=r,a.fillRect(e/2-3,2,6,e-4),a.fillStyle=i.barrelDetail,a.fillRect(e/2-1,1,2,e-2);const c=a.createRadialGradient(e/2,e-6,0,e/2,e-6,4);c.addColorStop(0,i.glow[0]),c.addColorStop(.7,i.glow[1]),c.addColorStop(1,i.glow[2]),a.fillStyle=c,a.beginPath(),a.arc(e/2,e-6,4,0,Math.PI*2),a.fill();const u=a.createRadialGradient(e/2,2,0,e/2,2,5);u.addColorStop(0,i.muzzleGlow[0]),u.addColorStop(.3,i.muzzleGlow[1]),u.addColorStop(.6,i.muzzleGlow[2]),u.addColorStop(1,i.muzzleGlow[3]),a.fillStyle=u,a.beginPath(),a.arc(e/2,2,5,0,Math.PI*2),a.fill(),a.fillStyle=i.muzzleCore,a.beginPath(),a.arc(e/2,2,1.5,0,Math.PI*2),a.fill()}function zr(a,e,i){const n=a.createLinearGradient(0,0,0,e);for(const[r,c]of i)n.addColorStop(r,c);a.fillStyle=n,a.fillRect(0,0,e,e)}function Vr(a,e,i){const n=a.createLinearGradient(0,e/2,0,e);for(const[r,c]of i)n.addColorStop(r,c);a.fillStyle=n,a.beginPath(),a.moveTo(e/2,e/2),a.lineTo(0,e),a.lineTo(e,e),a.closePath(),a.fill()}function Xr(a,e,i,n){const r=i/2,c=i/2,u=i*.35,h=a.createRadialGradient(r,c,0,r,c,i/2);n.baseGradientColors.forEach((m,y,v)=>h.addColorStop(y/(v.length-1),m)),a.fillStyle=h,a.fillRect(0,0,i,i);const d=e.createRadialGradient(r,c,0,r,c,u);n.rotatingBaseColors.forEach((m,y,v)=>d.addColorStop(y/(v.length-1),m)),xb(e,r,c,u,d),_b(e,r,c,u);const g=e.createLinearGradient(r-n.barrelWidth/2,0,r+n.barrelWidth/2,0);n.barrelGradientStops.forEach(([m,y])=>g.addColorStop(m,y)),Db(e,r,n.barrelWidth,n.barrelLength,g),Pb(e,r)}function xb(a,e,i,n,r){a.fillStyle=r,a.beginPath(),a.arc(e,i,n,0,Math.PI*2),a.fill()}function _b(a,e,i,n){a.strokeStyle="#AAA",a.lineWidth=1,a.beginPath(),a.moveTo(e,i-n*.8),a.lineTo(e,i+n*.8),a.moveTo(e-n*.8,i),a.lineTo(e+n*.8,i),a.stroke()}function Db(a,e,i,n,r){a.fillStyle=r,a.fillRect(e-i/2,0,i,n)}function Pb(a,e){a.fillStyle="#ff6666",a.fillRect(e-2,0,4,4)}function Ng(a,e,i){const n=e/2,r=e/2,c=a.createLinearGradient(0,0,0,e);i.chassisStops.forEach(([d,g])=>c.addColorStop(d,g)),a.fillStyle=c,a.fillRect(0,0,e,e);const u=a.createRadialGradient(n,r,i.coreRingInnerRadius,n,r,e/2);i.coreRingStops.forEach(([d,g])=>u.addColorStop(d,g)),a.fillStyle=u,a.beginPath(),a.arc(n,r,e/2,0,Math.PI*2),a.fill();const h=a.createRadialGradient(n,r,0,n,r,i.coreGlowRadius);i.coreGlowStops.forEach(([d,g])=>h.addColorStop(d,g)),a.fillStyle=h,a.beginPath(),a.arc(n,r,i.coreGlowRadius,0,Math.PI*2),a.fill(),a.strokeStyle=i.boltColor,a.lineWidth=1,a.beginPath(),a.moveTo(4,4),a.lineTo(e-4,4),a.moveTo(4,e-4),a.lineTo(e-4,e-4),a.moveTo(4,4),a.lineTo(4,e-4),a.moveTo(e-4,4),a.lineTo(e-4,e-4),a.stroke()}function Yr(a,e,i){const n=a.createLinearGradient(0,0,0,e);i.bodyStops.forEach(([h,d])=>n.addColorStop(h,d)),a.fillStyle=n,a.fillRect(0,0,e,e);const r=i.thrustInsetX??6,c=i.thrustHeight??4,u=i.thrustInsetY??6;a.fillStyle=i.thrustColor,a.fillRect(r,e-u,e-r*2,c)}function qr(a,e,i){const n=a.createLinearGradient(0,0,e,e);for(const[r,c]of i)n.addColorStop(r,c);a.fillStyle=n,a.beginPath(),a.moveTo(0,e),a.lineTo(e,e),a.lineTo(e,0),a.closePath(),a.fill()}function Hg(a,e,i){const n=e/2,r=e/2,c=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.chassisStops)??[[0,"#222831"],[.5,"#393E46"],[1,"#1E1E2F"]]).forEach(([d,g])=>c.addColorStop(d,g)),a.fillStyle=c,a.fillRect(0,0,e,e);const u=a.createRadialGradient(n,r,0,n,r,(i==null?void 0:i.coreRadius)??e*.4);((i==null?void 0:i.cellGlowStops)??[[0,"#C8E6C9"],[.5,"#81C784"],[1,"rgba(129, 199, 132, 0)"]]).forEach(([d,g])=>u.addColorStop(d,g)),a.fillStyle=u,a.beginPath(),a.arc(n,r,(i==null?void 0:i.coreRadius)??e*.4,0,Math.PI*2),a.fill(),a.fillStyle=(i==null?void 0:i.terminalColor)??"#B0BEC5";const h=(i==null?void 0:i.terminalSize)??3;a.fillRect(n-h/2,2,h,6),a.fillRect(n-h/2,e-8,h,6),a.strokeStyle="#A5D6A7",a.lineWidth=1.2,a.beginPath(),a.arc(n,r,e*.25,0,Math.PI*2),a.stroke()}function Xu(a,e,i){const n=e/2,r=e/2,c=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.chassisStops)??[[0,"#1A1A2E"],[.5,"#16213E"],[1,"#0F3460"]]).forEach(([h,d])=>c.addColorStop(h,d)),a.fillStyle=c,a.fillRect(0,0,e,e);const u=a.createRadialGradient(n,r,0,n,r,(i==null?void 0:i.emitterRadius)??e*.35);((i==null?void 0:i.emitterGlowStops)??[[0,"#BBDEFB"],[.5,"#42A5F5"],[1,"rgba(66, 165, 245, 0)"]]).forEach(([h,d])=>u.addColorStop(h,d)),a.fillStyle=u,a.beginPath(),a.arc(n,r,(i==null?void 0:i.emitterRadius)??e*.35,0,Math.PI*2),a.fill(),a.strokeStyle=(i==null?void 0:i.ringColor)??"#90CAF9",a.lineWidth=1.5,a.beginPath(),a.arc(n,r,e*.38,0,Math.PI*2),a.stroke(),a.fillStyle=(i==null?void 0:i.terminalColor)??"#E3F2FD",a.fillRect(n-1.5,2,3,5),a.fillRect(n-1.5,e-7,3,5),a.fillRect(2,r-1.5,5,3),a.fillRect(e-7,r-1.5,5,3)}function Gg(a,e,i){const n=e/2,r=e/2,c=e*.45,u=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.casingStops)??[[0,"#3E3E3E"],[.5,"#555555"],[1,"#222222"]]).forEach(([d,g])=>u.addColorStop(d,g)),a.fillStyle=u,a.fillRect(0,0,e,e);const h=a.createRadialGradient(n,r,0,n,r,c*.8);h.addColorStop(0,(i==null?void 0:i.vortexColor)??"#66ccff"),h.addColorStop(1,"rgba(102, 204, 255, 0)"),a.fillStyle=h,a.beginPath(),a.arc(n,r,c*.8,0,Math.PI*2),a.fill(),a.fillStyle=(i==null?void 0:i.intakeColor)??"#00B8D4",a.beginPath(),a.arc(n,r,c*.3,0,Math.PI*2),a.fill(),a.strokeStyle=(i==null?void 0:i.ringColor)??"rgba(0, 200, 255, 0.4)",a.lineWidth=1.5;for(let d=1;d<=2;d++)a.beginPath(),a.arc(n,r,c*(.4+.15*d),0,Math.PI*2),a.stroke()}function jr(a,e,i,n){const r=i/2,c=i/2,u=i*.35,h=a.createRadialGradient(r,c,0,r,c,i/2);((n==null?void 0:n.baseGradientColors)??["#222","#444","#111"]).forEach((y,v,M)=>h.addColorStop(v/(M.length-1),y)),a.fillStyle=h,a.fillRect(0,0,i,i);const d=e.createRadialGradient(r,c,0,r,c,u);d.addColorStop(0,"#900"),d.addColorStop(1,"#500"),e.fillStyle=d,e.beginPath(),e.arc(r,c,u,0,Math.PI*2),e.fill(),e.strokeStyle="#f55",e.lineWidth=1,e.beginPath(),e.moveTo(r,c-u*.8),e.lineTo(r,c+u*.8),e.moveTo(r-u*.8,c),e.lineTo(r+u*.8,c),e.stroke();const g=(n==null?void 0:n.barrelLength)??i*.7,m=(n==null?void 0:n.barrelGradientStops)??[[0,"#ffcccb"],[.5,"#ff5555"],[1,"#aa0000"]];Ob(e,r,g,m),Fb(e,r,g,m),Ub(e,r,m)}function Wg(a,e,i){const n=a.replace("#",""),r=e.replace("#",""),c=parseInt(n.substr(0,2),16),u=parseInt(n.substr(2,2),16),h=parseInt(n.substr(4,2),16),d=parseInt(r.substr(0,2),16),g=parseInt(r.substr(2,2),16),m=parseInt(r.substr(4,2),16),y=Math.round(c+(d-c)*i),v=Math.round(u+(g-u)*i),M=Math.round(h+(m-h)*i);return`#${y.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`}function Lb(a,e){const i=a.replace("#",""),n=Math.min(255,Math.round(parseInt(i.substr(0,2),16)*(1+e))),r=Math.min(255,Math.round(parseInt(i.substr(2,2),16)*(1+e))),c=Math.min(255,Math.round(parseInt(i.substr(4,2),16)*(1+e)));return`#${n.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`}function Ob(a,e,i,n){var g,m,y;const c=i/4,u=((g=n[0])==null?void 0:g[1])||"#cccccc",h=((m=n[1])==null?void 0:m[1])||"#888888",d=((y=n[2])==null?void 0:y[1])||"#444444";for(let v=0;v<4;v++){const M=v*c,S=v/3,T=8-S*3,w=T-1;let A;S<=.5?A=Wg(u,h,S*2):A=Wg(h,d,(S-.5)*2),a.fillStyle=A,a.beginPath(),a.moveTo(e-T/2,M),a.lineTo(e+T/2,M),a.lineTo(e+w/2,M+c),a.lineTo(e-w/2,M+c),a.closePath(),a.fill(),v>0&&(a.strokeStyle=Lb(d,.3),a.lineWidth=1,a.beginPath(),a.moveTo(e-T/2,M),a.lineTo(e+T/2,M),a.stroke())}}function Fb(a,e,i,n){var h;const r=((h=n[1])==null?void 0:h[1])||"#ffaa00";a.fillStyle=r;const c=6,u=i/(c+1);for(let d=0;d<c;d++){const g=u*(d+1),m=2;a.fillRect(e-6,g-m/2,m,m),a.fillRect(e+4,g-m/2,m,m)}}function Ub(a,e,i){var c,u;const n=((c=i[2])==null?void 0:c[1])||"#ff6600",r=((u=i[0])==null?void 0:u[1])||"#ffff00";a.fillStyle=n,a.beginPath(),a.moveTo(e-3,0),a.lineTo(e+3,0),a.lineTo(e,-4),a.closePath(),a.fill(),a.fillStyle=r,a.beginPath(),a.arc(e,-1,1.5,0,Math.PI*2),a.fill()}function Kr(a,e,i){const n=e/2,r=e/2,c=e*.45,u=c*.2,h=4,d=a.createLinearGradient(0,0,0,e);for(const[m,y]of i.casingStops)d.addColorStop(m,y);a.fillStyle=d,a.fillRect(0,0,e,e);const g=a.createRadialGradient(n,r,0,n,r,c);g.addColorStop(0,i.glowColor),g.addColorStop(1,"rgba(0,0,0,0)"),a.fillStyle=g,a.beginPath(),a.arc(n,r,c,0,Math.PI*2),a.fill(),a.strokeStyle=i.ringColor,a.lineWidth=h,a.beginPath(),a.arc(n,r,c-h/2,0,Math.PI*2),a.stroke(),a.fillStyle=i.coreColor,a.beginPath(),a.arc(n,r,u,0,Math.PI*2),a.fill()}function Zr(a,e,i){const n=e/2,r=e/2,c=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.casingStops)??[[0,"#2B2B2B"],[.3,"#1F1F1F"],[.6,"#0F0F0F"],[1,"#000000"]]).forEach(([y,v])=>c.addColorStop(y,v)),a.fillStyle=c,a.fillRect(0,0,e,e);const u=e*.28,h=a.createRadialGradient(n,r,0,n,r,u);h.addColorStop(0,(i==null?void 0:i.coreColor)??"#FFD54F"),h.addColorStop(1,"rgba(255, 213, 79, 0)"),a.fillStyle=h,a.beginPath(),a.arc(n,r,u,0,Math.PI*2),a.fill(),a.strokeStyle=(i==null?void 0:i.stripeColor)??"#666",a.lineWidth=2;const d=4;for(let y=0;y<d;y++){const v=(y+1)/(d+1)*e;a.beginPath(),a.moveTo(v,4),a.lineTo(v,e-4),a.stroke()}a.fillStyle=(i==null?void 0:i.terminalHighlightColor)??"#FFECB3";const g=e*.2,m=4;a.fillRect(n-g/2,2,g,m),a.fillRect(n-g/2,e-m-2,g,m)}var Qs=(a=>(a.NONE="none",a.LIGHT="light",a.MODERATE="moderate",a.HEAVY="heavy",a))(Qs||{});const wh=new Map,nl=new Map;function al(){const a=document.createElement("canvas");return a.width=z,a.height=z,a}function jn(a,e){if(e==="none")return a;const i=al(),n=i.getContext("2d"),r=al(),c=r.getContext("2d"),u={light:{opacity:.9,tint:"rgba(255,0,0,0.1)",cracks:!1},moderate:{opacity:.7,tint:"rgba(255,0,0,0.25)",cracks:!0},heavy:{opacity:.4,tint:"rgba(255,0,0,0.4)",cracks:!0}}[e];if(n.globalAlpha=u.opacity,n.drawImage(a,0,0),n.globalAlpha=1,c.clearRect(0,0,z,z),c.fillStyle=u.tint,c.fillRect(0,0,z,z),c.globalCompositeOperation="destination-in",c.drawImage(a,0,0),c.globalCompositeOperation="source-over",n.drawImage(r,0,0),u.cracks){c.clearRect(0,0,z,z),c.strokeStyle=e==="heavy"?"rgba(40,40,40,0.9)":"rgba(60,60,60,0.7)",c.lineWidth=e==="heavy"?2:1;const h=z/2;c.beginPath(),c.moveTo(h*.2,h*.4),c.lineTo(h*1.6,h*1.8),c.moveTo(h*.4,h*1.8),c.lineTo(h*1.8,h*.2),e==="heavy"&&(c.moveTo(0,h),c.lineTo(h*.8,h*1.2),c.moveTo(h*1.2,h*.8),c.lineTo(z,h)),c.stroke(),c.globalCompositeOperation="destination-in",c.drawImage(a,0,0),c.globalCompositeOperation="source-over",n.drawImage(r,0,0)}return i}function Nb(a){return{none:a,light:{base:jn(a.base,"light"),overlay:a.overlay?jn(a.overlay,"light"):void 0},moderate:{base:jn(a.base,"moderate"),overlay:a.overlay?jn(a.overlay,"moderate"):void 0},heavy:{base:jn(a.base,"heavy"),overlay:a.overlay?jn(a.overlay,"heavy"):void 0}}}function Hb(a){const e=al(),i=e.getContext("2d"),n=al(),r=n.getContext("2d");switch(a){case"cockpit0":i.fillStyle="#444",i.fillRect(0,0,z,z),i.fillStyle="#ff2222",i.beginPath(),i.arc(z/2,z/2,8,0,Math.PI*2),i.fill();break;case"cockpit1":i.fillStyle="#444",i.fillRect(0,0,z,z),i.fillStyle="#0ff",i.beginPath(),i.arc(z/2,z/2,8,0,Math.PI*2),i.fill();break;case"hull0":case"hull1":zr(i,z,[[0,"#C0C0C0"],[.3,"#A0A0A0"],[.7,"#808080"],[1,"#606060"]]);break;case"hull2":zr(i,z,[[0,"#66FF66"],[.2,"#4CAF50"],[.6,"#388E3C"],[1,"#1B5E20"]]);break;case"hull3":zr(i,z,[[0,"#64B5F6"],[.2,"#2196F3"],[.6,"#1976D2"],[1,"#0D47A1"]]);break;case"hull4":zr(i,z,[[0,"#E1BEE7"],[.15,"#BA68C8"],[.4,"#9C27B0"],[.7,"#7B1FA2"],[1,"#4A148C"]]);break;case"facetplate0":case"facetplate1":Vr(i,z,[[0,"#C0C0C0"],[.3,"#A0A0A0"],[.7,"#808080"],[1,"#606060"]]);break;case"facetplate2":Vr(i,z,[[0,"#66FF66"],[.2,"#4CAF50"],[.6,"#388E3C"],[1,"#1B5E20"]]);break;case"facetplate3":Vr(i,z,[[0,"#64B5F6"],[.2,"#2196F3"],[.6,"#1976D2"],[1,"#0D47A1"]]);break;case"facetplate4":Vr(i,z,[[0,"#E1BEE7"],[.15,"#BA68C8"],[.4,"#9C27B0"],[.7,"#7B1FA2"],[1,"#4A148C"]]);break;case"fuelTank0":case"fuelTank1":Zr(i,z,{casingStops:[[0,"#C0C0C0"],[.3,"#A0A0A0"],[.6,"#808080"],[1,"#606060"]],coreColor:"#FFF176",stripeColor:"#999",terminalHighlightColor:"#F0F4C3"});break;case"fuelTank2":Zr(i,z,{casingStops:[[0,"#66FF66"],[.2,"#4CAF50"],[.6,"#388E3C"],[1,"#1B5E20"]],coreColor:"#B2FF59",stripeColor:"#33691E",terminalHighlightColor:"#DCEDC8"});break;case"fuelTank3":Zr(i,z,{casingStops:[[0,"#64B5F6"],[.2,"#2196F3"],[.6,"#1976D2"],[1,"#0D47A1"]],coreColor:"#81D4FA",stripeColor:"#1565C0",terminalHighlightColor:"#E3F2FD"});break;case"fuelTank4":Zr(i,z,{casingStops:[[0,"#E1BEE7"],[.15,"#BA68C8"],[.4,"#9C27B0"],[.7,"#7B1FA2"],[1,"#4A148C"]],coreColor:"#CE93D8",stripeColor:"#8E24AA",terminalHighlightColor:"#F3E5F5"});break;case"turret0":case"turret1":Xr(i,r,z,{baseGradientColors:["#777","#555","#333"],rotatingBaseColors:["#888","#666","#444"],barrelGradientStops:[[0,"#444"],[.3,"#f44"],[.7,"#c22"],[1,"#822"]],barrelWidth:6,barrelLength:z*.6});break;case"turret2":Xr(i,r,z,{baseGradientColors:["#66BB6A","#4CAF50","#2E7D32"],rotatingBaseColors:["#81C784","#4CAF50","#1B5E20"],barrelGradientStops:[[0,"#1B5E20"],[.2,"#388E3C"],[.5,"#4CAF50"],[.8,"#66BB6A"],[1,"#2E7D32"]],barrelWidth:7,barrelLength:z*.65});break;case"turret3":Xr(i,r,z,{baseGradientColors:["#64B5F6","#2196F3","#1565C0"],rotatingBaseColors:["#90CAF9","#42A5F5","#1976D2","#0D47A1"],barrelGradientStops:[[0,"#0D47A1"],[.15,"#1565C0"],[.4,"#1976D2"],[.6,"#2196F3"],[.85,"#64B5F6"],[1,"#1565C0"]],barrelWidth:8,barrelLength:z*.7});break;case"turret4":Xr(i,r,z,{baseGradientColors:["#E1BEE7","#BA68C8","#9C27B0","#7B1FA2","#4A148C"],rotatingBaseColors:["#F3E5F5","#E1BEE7","#CE93D8","#AB47BC","#8E24AA"],barrelGradientStops:[[0,"#4A148C"],[.1,"#6A1B99"],[.25,"#7B1FA2"],[.4,"#8E24AA"],[.6,"#AB47BC"],[.75,"#CE93D8"],[.9,"#E1BEE7"],[1,"#7B1FA2"]],barrelWidth:10,barrelLength:z*.75});break;case"laser0":Wr(i,z,{body:["#3A3A3A","#2A2A2A","#1A1A1A","#101010"],housing:"#64B5F6",innerHousing:"#1565C0",barrel:["#81D4FA","#0288D1","#81D4FA"],barrelDetail:"#B3E5FC",glow:["#4FC3F7","#0288D1","rgba(2, 136, 209, 0)"],muzzleGlow:["#FFFFFF","#4FC3F7","#0288D1","rgba(2, 136, 209, 0)"],muzzleCore:"#FFFFFF"});break;case"laser1":Wr(i,z,{body:["#555D66","#3C444D","#2B3036","#1E2227"],housing:"#90A4AE",innerHousing:"#546E7A",barrel:["#B0BEC5","#78909C","#B0BEC5"],barrelDetail:"#CFD8DC",glow:["#4FC3F7","#0288D1","rgba(2, 136, 209, 0)"],muzzleGlow:["#E1F5FE","#81D4FA","#0288D1","rgba(2, 136, 209, 0)"],muzzleCore:"#E0F7FA"});break;case"laser2":Wr(i,z,{body:["#355E3B","#254D32","#1B3C29","#122D21"],housing:"#AED581",innerHousing:"#7CB342",barrel:["#C5E1A5","#8BC34A","#C5E1A5"],barrelDetail:"#DCEDC8",glow:["#76FF03","#64DD17","rgba(100, 221, 23, 0)"],muzzleGlow:["#CCFF90","#AEEA00","#64DD17","rgba(174, 234, 0, 0)"],muzzleCore:"#F0F4C3"});break;case"laser3":Wr(i,z,{body:["#2E003E","#1D002A","#14001F","#0A0014"],housing:"#9575CD",innerHousing:"#673AB7",barrel:["#B39DDB","#7E57C2","#B39DDB"],barrelDetail:"#D1C4E9",glow:["#D500F9","#AA00FF","rgba(170, 0, 255, 0)"],muzzleGlow:["#E1BEE7","#BA68C8","#8E24AA","rgba(142, 36, 170, 0)"],muzzleCore:"#F3E5F5"});break;case"reactor0":case"reactor1":Ng(i,z,{chassisStops:[[0,"#2C2C2C"],[.5,"#1E1E1E"],[1,"#0F0F0F"]],coreRingStops:[[0,"#4FC3F7"],[.4,"#0288D1"],[1,"#00000000"]],coreRingInnerRadius:4,coreGlowStops:[[0,"#81D4FA"],[.4,"#4FC3F7"],[1,"rgba(129, 212, 250, 0)"]],coreGlowRadius:6,boltColor:"#64B5F6"});break;case"reactor2":Ng(i,z,{chassisStops:[[0,"#1C0D2B"],[.5,"#2A1850"],[1,"#100820"]],coreRingStops:[[0,"#BA68C8"],[.4,"#8E24AA"],[1,"#00000000"]],coreRingInnerRadius:5,coreGlowStops:[[0,"#CE93D8"],[.5,"#AB47BC"],[1,"rgba(171, 71, 188, 0)"]],coreGlowRadius:7,boltColor:"#D1C4E9"});break;case"battery0":case"battery1":Hg(i,z,{chassisStops:[[0,"#263238"],[.5,"#37474F"],[1,"#102027"]],cellGlowStops:[[0,"#B2EBF2"],[.5,"#4DD0E1"],[1,"rgba(77, 208, 225, 0)"]],coreRadius:7,terminalColor:"#B0BEC5",terminalSize:3});break;case"battery2":Hg(i,z,{chassisStops:[[0,"#311B92"],[.5,"#512DA8"],[1,"#1A237E"]],cellGlowStops:[[0,"#D1C4E9"],[.5,"#9575CD"],[1,"rgba(149, 117, 205, 0)"]],coreRadius:8,terminalColor:"#EDE7F6",terminalSize:3});break;case"shield0":case"shield1":Xu(i,z,{chassisStops:[[0,"#1A1A2E"],[.5,"#16213E"],[1,"#0F3460"]],emitterGlowStops:[[0,"#BBDEFB"],[.5,"#42A5F5"],[1,"rgba(66, 165, 245, 0)"]],emitterRadius:10,ringColor:"#90CAF9",terminalColor:"#E3F2FD"});break;case"shield2":Xu(i,z,{chassisStops:[[0,"#003322"],[.5,"#005533"],[1,"#00261A"]],emitterGlowStops:[[0,"#66FFCC"],[.5,"#00CC88"],[1,"rgba(0, 204, 136, 0)"]],emitterRadius:11,ringColor:"#00E6A8",terminalColor:"#CCFFEE"});break;case"shield3":Xu(i,z,{chassisStops:[[0,"#4A0033"],[.5,"#800080"],[1,"#2E003E"]],emitterGlowStops:[[0,"#FFB3E6"],[.5,"#E040FB"],[1,"rgba(224, 64, 251, 0)"]],emitterRadius:12,ringColor:"#FF80AB",terminalColor:"#FFD6F9"});break;case"engine0":case"engine1":Yr(i,z,{bodyStops:[[0,"#C0C0C0"],[.5,"#A0A0A0"],[1,"#808080"]],thrustColor:"#09f"});break;case"engine2":Yr(i,z,{bodyStops:[[0,"#66FF66"],[.5,"#4CAF50"],[1,"#388E3C"]],thrustColor:"#0f0"});break;case"engine3":Yr(i,z,{bodyStops:[[0,"#64B5F6"],[.5,"#2196F3"],[1,"#1976D2"]],thrustColor:"#00f"});break;case"engine4":Yr(i,z,{bodyStops:[[0,"#B39DDB"],[.5,"#7B1FA2"],[1,"#4A148C"]],thrustColor:"#f0f"});break;case"fin0":case"fin1":qr(i,z,[[0,"#E0E0E0"],[.3,"#B0B0B0"],[.7,"#808080"],[1,"#404040"]]);break;case"fin2":qr(i,z,[[0,"#81C784"],[.2,"#66BB6A"],[.5,"#4CAF50"],[.8,"#2E7D32"],[1,"#1B5E20"]]);break;case"fin3":qr(i,z,[[0,"#90CAF9"],[.15,"#64B5F6"],[.4,"#42A5F5"],[.7,"#1E88E5"],[.9,"#1565C0"],[1,"#0D47A1"]]);break;case"fin4":qr(i,z,[[0,"#F3E5F5"],[.1,"#E1BEE7"],[.25,"#CE93D8"],[.45,"#BA68C8"],[.65,"#AB47BC"],[.8,"#8E24AA"],[.95,"#6A1B99"],[1,"#4A148C"]]);break;case"harvester0":case"harvester1":Gg(i,z,{intakeColor:"#00ACC1",vortexColor:"#4DD0E1",ringColor:"rgba(0, 200, 255, 0.35)",casingStops:[[0,"#263238"],[.5,"#37474F"],[1,"#212121"]]});break;case"harvester2":Gg(i,z,{intakeColor:"#00BFA5",vortexColor:"#1DE9B6",ringColor:"rgba(106, 0, 255, 0.4)",casingStops:[[0,"#004D40"],[.5,"#00695C"],[1,"#00251A"]]});break;case"explosiveLance0":case"explosiveLance1":jr(i,r,z,{baseGradientColors:["#2e2e2e","#3c3c3c","#121212"],barrelGradientStops:[[0,"#cccccc"],[.5,"#888888"],[1,"#444444"]]});break;case"explosiveLance2":jr(i,r,z,{baseGradientColors:["#1b3d2f","#2c704f","#09251a"],barrelGradientStops:[[0,"#a8e6cf"],[.5,"#56c596"],[1,"#228b22"]]});break;case"explosiveLance3":jr(i,r,z,{baseGradientColors:["#0d47a1","#1976d2","#0a1a3f"],barrelGradientStops:[[0,"#82b1ff"],[.5,"#448aff"],[1,"#2962ff"]]});break;case"explosiveLance4":jr(i,r,z,{baseGradientColors:["#4a148c","#7b1fa2","#12002e"],barrelGradientStops:[[0,"#e1bee7"],[.5,"#ba68c8"],[1,"#8e24aa"]]});break;case"haloBlade0":case"haloBlade1":Kr(i,z,{ringColor:"#FFBF00",coreColor:"#FFEB3B",glowColor:"rgba(255, 191, 0, 0.4)",casingStops:[[0,"#3A3A3A"],[.5,"#2A2A2A"],[1,"#101010"]]});break;case"haloBlade2":Kr(i,z,{ringColor:"#2CFF05",coreColor:"#B2FF59",glowColor:"rgba(44, 255, 5, 0.35)",casingStops:[[0,"#1B3C29"],[.5,"#254D32"],[1,"#122D21"]]});break;case"haloBlade3":Kr(i,z,{ringColor:"#00FFFF",coreColor:"#80DEEA",glowColor:"rgba(0, 255, 255, 0.35)",casingStops:[[0,"#263238"],[.5,"#37474F"],[1,"#212121"]]});break;case"haloBlade4":Kr(i,z,{ringColor:"#7F00FF",coreColor:"#D1C4E9",glowColor:"rgba(127, 0, 255, 0.4)",casingStops:[[0,"#2E003E"],[.5,"#1D002A"],[1,"#0A0014"]]});break}const c={base:e,overlay:a.startsWith("turret")||a.startsWith("explosiveLance")?n:void 0},u=Nb(c);wh.set(a,u)}function Gb(){for(const a of Ao())Hb(a.id)}function Wb(a){let e=0;for(const i of Ao()){const n=wh.get(i.id);if(!n){console.warn(`[GL2Cache] No raster sprite found for block: ${i.id}`);continue}try{const r={none:{base:Rt(a,n.none.base),overlay:n.none.overlay?Rt(a,n.none.overlay):void 0},light:{base:Rt(a,n.light.base),overlay:n.light.overlay?Rt(a,n.light.overlay):void 0},moderate:{base:Rt(a,n.moderate.base),overlay:n.moderate.overlay?Rt(a,n.moderate.overlay):void 0},heavy:{base:Rt(a,n.heavy.base),overlay:n.heavy.overlay?Rt(a,n.heavy.overlay):void 0}};nl.set(i.id,r),e++}catch(r){console.error(`[GL2Cache] Failed to convert block sprite to GL2 texture: ${i.id}`,r)}}console.log(`[GL2Cache] Total GL2 textures initialized: ${e}`)}function zb(a){for(const[e,i]of nl.entries())for(const n of Object.values(Qs)){const r=i[n];r.base&&a.isTexture(r.base)&&a.deleteTexture(r.base),r.overlay&&a.isTexture(r.overlay)&&a.deleteTexture(r.overlay)}nl.clear()}function Vb(a,e){const i=Math.max(0,a/e);return i>.75?"none":i>.5?"light":i>.25?"moderate":"heavy"}function Yi(a,e="none"){const i=wh.get(a);if(!i)throw new Error(`Block sprite not cached: ${a}`);return i[e]}function am(a,e="none"){const i=nl.get(a);if(!i)throw new Error(`GL2 block sprite not cached: ${a}`);return i[e]}const Mo=32,om=new Map,ol=new Map;function Xb(){return["currency","repair"]}function Yb(){const a=document.createElement("canvas");a.width=Mo,a.height=Mo;const e=a.getContext("2d",{alpha:!0});return{canvas:a,ctx:e}}function qb(a){const{canvas:e,ctx:i}=Yb(),n=Mo/2;i.clearRect(0,0,Mo,Mo);const r=i.createRadialGradient(n,n,0,n,n,n);switch(a){case"currency":r.addColorStop(0,"#ffcc00"),r.addColorStop(.6,"#ffaa00"),r.addColorStop(1,"#cc6600");break;case"repair":r.addColorStop(0,"#ff6666"),r.addColorStop(.7,"#cc2222"),r.addColorStop(1,"#880000");break;default:console.warn(`[PickupSpriteCache] Unknown pickup type: ${a}`);break}i.fillStyle=r,i.beginPath(),i.arc(n,n,n,0,Math.PI*2),i.fill(),om.set(a,{canvas:e})}function jb(){for(const a of Xb())qb(a)}function Kb(a){let e=0;for(const[i,n]of om.entries())try{const r=Rt(a,n.canvas);ol.set(i,{texture:r}),e++}catch(r){console.error(`[GLPickupSpriteCache] Failed to create texture for ${i}:`,r)}console.log(`[GLPickupSpriteCache] Initialized ${e} GL2 pickup textures.`)}function Zb(a){for(const{texture:e}of ol.values())e&&a.isTexture(e)&&a.deleteTexture(e);ol.clear()}function Qb(a){const e=ol.get(a);if(!e)throw new Error(`GL pickup sprite not cached: ${a}`);return e}const rm={circleRock0:{id:"circleRock0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"circleRock0",category:"environment",subcategory:"asteroid",dropRate:0},rock0:{id:"rock0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"rock0",category:"environment",subcategory:"asteroid",dropRate:0},facetRock0:{id:"facetRock0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"facetRock0",category:"environment",subcategory:"asteroid",dropRate:0},facetRock1:{id:"facetRock1",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"facetRock1",category:"environment",subcategory:"asteroid",dropRate:0},facetRockSlim0:{id:"facetRockSlim0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"facetRockSlim0",category:"environment",subcategory:"asteroid",dropRate:0}};function lm(a){return rm[a]}function cm(){return Object.values(rm)}function $b(a){const e=z/2-2,i=z/2,n=z/2;a.save(),a.fillStyle="#444",a.beginPath(),a.moveTo(i,n-e+3),a.bezierCurveTo(i+12,n-e,i+e,n-10,i+e-2,n),a.bezierCurveTo(i+e,n+10,i+10,n+e-4,i,n+e),a.bezierCurveTo(i-10,n+e-6,i-e,n+10,i-e+2,n),a.bezierCurveTo(i-e,n-10,i-10,n-e,i,n-e+3),a.closePath(),a.fill(),a.fillStyle="rgba(255,255,255,0.05)";for(let r=0;r<10;r++){const c=Math.random()*z,u=Math.random()*z;a.beginPath(),a.arc(c,u,1+Math.random()*1.5,0,Math.PI*2),a.fill()}a.restore()}function Jb(a){const e=z,i=z;a.save();const n=a.createRadialGradient(e*.3,i*.3,0,e*.5,i*.5,e*.8);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i),a.fillStyle="rgba(20, 20, 20, 0.3)";for(let u=0;u<5;u++){const h=Math.random()*e,d=Math.random()*i,g=8+Math.random()*12;a.beginPath();for(let m=0;m<8;m++){const y=m/8*Math.PI*2,v=g*(.7+Math.random()*.6),M=h+Math.cos(y)*v,S=d+Math.sin(y)*v;m===0?a.moveTo(M,S):a.lineTo(M,S)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.4)";for(let u=0;u<4;u++){const h=Math.random()*e,d=Math.random()*i,g=6+Math.random()*10;a.beginPath();for(let m=0;m<6;m++){const y=m/6*Math.PI*2,v=g*(.8+Math.random()*.4),M=h+Math.cos(y)*v,S=d+Math.sin(y)*v;m===0?a.moveTo(M,S):a.lineTo(M,S)}a.closePath(),a.fill()}const r=a.createLinearGradient(0,0,e*.3,i*.3);r.addColorStop(0,"rgba(255, 255, 255, 0.08)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=r,a.fillRect(0,0,e*.3,i*.3);const c=a.createLinearGradient(e*.7,i*.7,e,i);c.addColorStop(0,"rgba(0, 0, 0, 0)"),c.addColorStop(1,"rgba(0, 0, 0, 0.15)"),a.fillStyle=c,a.fillRect(e*.7,i*.7,e*.3,i*.3),a.fillStyle="rgba(255, 255, 255, 0.06)";for(let u=0;u<12;u++){const h=Math.random()*e,d=Math.random()*i,g=.5+Math.random()*1;a.beginPath(),a.arc(h,d,g,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.3)";for(let u=0;u<8;u++){const h=Math.random()*e,d=Math.random()*i,g=.3+Math.random()*.7;a.beginPath(),a.arc(h,d,g,0,Math.PI*2),a.fill()}a.restore()}function eS(a){const e=z,i=z;a.save(),a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.quadraticCurveTo(e*.55+(Math.random()-.5)*4,-2,0,i),a.closePath(),a.clip();const n=a.createRadialGradient(e*.4,i*.7,0,e*.5,i*.6,e*.9);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i);const r=a.createLinearGradient(e*.2,i*.2,e*.8,i*.8);r.addColorStop(0,"rgba(255, 255, 255, 0.12)"),r.addColorStop(.5,"rgba(255, 255, 255, 0.04)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=r,a.fillRect(0,0,e,i);const c=a.createLinearGradient(0,i*.8,0,i);c.addColorStop(0,"rgba(0, 0, 0, 0)"),c.addColorStop(1,"rgba(0, 0, 0, 0.2)"),a.fillStyle=c,a.fillRect(0,i*.8,e,i*.2),a.fillStyle="rgba(20, 20, 20, 0.25)";for(let u=0;u<4;u++){const h=Math.random()*e,d=i*.3+Math.random()*i*.6,g=6+Math.random()*8;a.beginPath();for(let m=0;m<6;m++){const y=m/6*Math.PI*2,v=g*(.7+Math.random()*.6),M=h+Math.cos(y)*v,S=d+Math.sin(y)*v;m===0?a.moveTo(M,S):a.lineTo(M,S)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.3)";for(let u=0;u<3;u++){const h=Math.random()*e,d=i*.4+Math.random()*i*.5,g=4+Math.random()*6;a.beginPath();for(let m=0;m<5;m++){const y=m/5*Math.PI*2,v=g*(.8+Math.random()*.4),M=h+Math.cos(y)*v,S=d+Math.sin(y)*v;m===0?a.moveTo(M,S):a.lineTo(M,S)}a.closePath(),a.fill()}a.fillStyle="rgba(255, 255, 255, 0.06)";for(let u=0;u<8;u++){const h=Math.random()*e,d=i*.2+Math.random()*i*.7,g=.5+Math.random()*1;a.beginPath(),a.arc(h,d,g,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.25)";for(let u=0;u<6;u++){const h=Math.random()*e,d=i*.3+Math.random()*i*.6,g=.3+Math.random()*.7;a.beginPath(),a.arc(h,d,g,0,Math.PI*2),a.fill()}a.restore(),a.strokeStyle="rgba(0, 0, 0, 0.1)",a.lineWidth=.5,a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.stroke(),a.restore()}function tS(a){const e=z,i=z;a.save(),a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.bezierCurveTo(e*.8,i*.3,e*.2,i*.1,0,i),a.closePath(),a.clip();const n=a.createRadialGradient(e*.3,i*.8,0,e*.5,i*.6,e*.9);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i);const r=a.createLinearGradient(e*.1,i*.1,e*.9,i*.6);r.addColorStop(0,"rgba(255, 255, 255, 0.15)"),r.addColorStop(.3,"rgba(255, 255, 255, 0.08)"),r.addColorStop(.7,"rgba(255, 255, 255, 0.02)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=r,a.fillRect(0,0,e,i);const c=a.createRadialGradient(e*.7,i*.2,0,e*.7,i*.2,e*.3);c.addColorStop(0,"rgba(255, 255, 255, 0.1)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=c,a.fillRect(e*.4,0,e*.6,i*.4);const u=a.createLinearGradient(0,i*.85,0,i);u.addColorStop(0,"rgba(0, 0, 0, 0)"),u.addColorStop(1,"rgba(0, 0, 0, 0.18)"),a.fillStyle=u,a.fillRect(0,i*.85,e,i*.15),a.fillStyle="rgba(20, 20, 20, 0.28)";for(let h=0;h<5;h++){const d=Math.random()*e,g=i*.25+Math.random()*i*.7,m=5+Math.random()*9;a.beginPath();for(let y=0;y<7;y++){const v=y/7*Math.PI*2,M=m*(.6+Math.random()*.8),S=d+Math.cos(v)*M,T=g+Math.sin(v)*M;y===0?a.moveTo(S,T):a.lineTo(S,T)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.35)";for(let h=0;h<4;h++){const d=Math.random()*e,g=i*.3+Math.random()*i*.6,m=3+Math.random()*7;a.beginPath();for(let y=0;y<6;y++){const v=y/6*Math.PI*2,M=m*(.7+Math.random()*.5),S=d+Math.cos(v)*M,T=g+Math.sin(v)*M;y===0?a.moveTo(S,T):a.lineTo(S,T)}a.closePath(),a.fill()}a.fillStyle="rgba(255, 255, 255, 0.065)";for(let h=0;h<10;h++){const d=Math.random()*e,g=i*.15+Math.random()*i*.8,m=.4+Math.random()*1.2;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.28)";for(let h=0;h<7;h++){const d=Math.random()*e,g=i*.2+Math.random()*i*.7,m=.2+Math.random()*.8;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(45, 45, 45, 0.4)";for(let h=0;h<3;h++){const d=Math.random()*e,g=i*.4+Math.random()*i*.5,m=2+Math.random()*3;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.restore(),a.strokeStyle="rgba(0, 0, 0, 0.08)",a.lineWidth=.5,a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.stroke(),a.restore()}function iS(a){const e=z,i=z;a.save(),a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.arc(e/2,i,e/2,0,Math.PI,!0),a.closePath(),a.clip();const n=a.createRadialGradient(e*.5,i*.9,0,e*.5,i*.7,e*.7);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i);const r=a.createLinearGradient(0,i*.3,e,i*.7);r.addColorStop(0,"rgba(255, 255, 255, 0.1)"),r.addColorStop(.5,"rgba(255, 255, 255, 0.05)"),r.addColorStop(1,"rgba(255, 255, 255, 0.1)"),a.fillStyle=r,a.fillRect(0,0,e,i);const c=a.createRadialGradient(e*.5,i*.5,0,e*.5,i*.5,e*.4);c.addColorStop(0,"rgba(255, 255, 255, 0.08)"),c.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=c,a.fillRect(e*.2,i*.2,e*.6,i*.6);const u=a.createLinearGradient(0,i*.9,0,i);u.addColorStop(0,"rgba(0, 0, 0, 0)"),u.addColorStop(1,"rgba(0, 0, 0, 0.15)"),a.fillStyle=u,a.fillRect(0,i*.9,e,i*.1),a.fillStyle="rgba(20, 20, 20, 0.25)";for(let h=0;h<3;h++){const d=e*.2+Math.random()*e*.6,g=i*.4+Math.random()*i*.5,m=3+Math.random()*5;a.beginPath();for(let y=0;y<5;y++){const v=y/5*Math.PI*2,M=m*(.7+Math.random()*.6),S=d+Math.cos(v)*M,T=g+Math.sin(v)*M;y===0?a.moveTo(S,T):a.lineTo(S,T)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.3)";for(let h=0;h<2;h++){const d=e*.3+Math.random()*e*.4,g=i*.5+Math.random()*i*.4,m=2+Math.random()*4;a.beginPath();for(let y=0;y<4;y++){const v=y/4*Math.PI*2,M=m*(.8+Math.random()*.4),S=d+Math.cos(v)*M,T=g+Math.sin(v)*M;y===0?a.moveTo(S,T):a.lineTo(S,T)}a.closePath(),a.fill()}a.fillStyle="rgba(255, 255, 255, 0.06)";for(let h=0;h<6;h++){const d=e*.1+Math.random()*e*.8,g=i*.3+Math.random()*i*.6,m=.3+Math.random()*.8;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.25)";for(let h=0;h<4;h++){const d=e*.2+Math.random()*e*.6,g=i*.4+Math.random()*i*.5,m=.2+Math.random()*.5;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(45, 45, 45, 0.35)";for(let h=0;h<2;h++){const d=e*.3+Math.random()*e*.4,g=i*.5+Math.random()*i*.4,m=1+Math.random()*2;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.restore(),a.strokeStyle="rgba(0, 0, 0, 0.06)",a.lineWidth=.3,a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.stroke(),a.restore()}var To=(a=>(a.NONE="none",a.FRACTURED="fractured",a.CRUMBLING="crumbling",a))(To||{});const um=new Map,rl=new Map;function fh(){const a=document.createElement("canvas");return a.width=z,a.height=z,a}function zg(a,e){if(e==="none")return a;const i=fh(),n=i.getContext("2d"),r=fh(),c=r.getContext("2d"),u={fractured:{opacity:.8,tint:"rgba(100, 100, 100, 0.15)",cracks:!0,cracksColor:"rgba(80, 80, 80, 0.7)",lineWidth:1},crumbling:{opacity:.6,tint:"rgba(150, 75, 0, 0.3)",cracks:!0,cracksColor:"rgba(60, 30, 0, 0.85)",lineWidth:2}}[e];return n.globalAlpha=u.opacity,n.drawImage(a,0,0),n.globalAlpha=1,c.clearRect(0,0,z,z),c.fillStyle=u.tint,c.fillRect(0,0,z,z),c.globalCompositeOperation="destination-in",c.drawImage(a,0,0),c.globalCompositeOperation="source-over",n.drawImage(r,0,0),u.cracks&&(c.clearRect(0,0,z,z),c.strokeStyle=u.cracksColor,c.lineWidth=u.lineWidth,c.beginPath(),c.moveTo(4,4),c.lineTo(28,28),c.moveTo(10,22),c.lineTo(22,10),c.moveTo(0,16),c.lineTo(32,16),c.stroke(),c.globalCompositeOperation="destination-in",c.drawImage(a,0,0),c.globalCompositeOperation="source-over",n.drawImage(r,0,0)),i}function sS(a){return{none:a,fractured:{base:zg(a.base,"fractured")},crumbling:{base:zg(a.base,"crumbling")}}}function nS(a){const e=fh(),i=e.getContext("2d");switch(a){case"circleRock0":$b(i);break;case"rock0":Jb(i);break;case"facetRock0":eS(i);break;case"facetRock1":tS(i);break;case"facetRockSlim0":iS(i);break;default:throw new Error(`Unknown asteroid block type: ${a}`)}const r=sS({base:e});um.set(a,r)}function aS(){for(const a of cm())nS(a.id)}function oS(a){let e=0;for(const i of cm()){const n=um.get(i.id);if(!n){console.warn(`[GL2Cache] No raster asteroid sprite for: ${i.id}`);continue}try{const r={none:{base:Rt(a,n.none.base)},fractured:{base:Rt(a,n.fractured.base)},crumbling:{base:Rt(a,n.crumbling.base)}};rl.set(i.id,r),e++}catch(r){console.error(`[GL2Cache] Failed to create GL2 asteroid sprite: ${i.id}`,r)}}console.log(`[GL2Cache] Total GL2 asteroid textures initialized: ${e}`)}function rS(a){for(const e of rl.values())for(const i of Object.values(To)){const n=e[i];n.base&&a.isTexture(n.base)&&a.deleteTexture(n.base)}rl.clear()}function lS(a,e="none"){const i=rl.get(a);if(!i)throw new Error(`GL2 asteroid sprite not cached: ${a}`);return i[e]}function Qr(a,e,i,n,r){a.save(),a.clearRect(0,0,a.canvas.width,a.canvas.height);const c=n*.35,u=n-c,h=a.createRadialGradient(e,i,u,e,i,n*1.5);h.addColorStop(0,$r(r,.3)),h.addColorStop(.7,$r(r,.1)),h.addColorStop(1,$r(r,0)),a.beginPath(),a.fillStyle=h,a.arc(e,i,n*1.5,0,Math.PI*2),a.fill(),a.beginPath(),a.arc(e,i,n,0,Math.PI*2),a.fillStyle=r,a.fill(),a.globalCompositeOperation="destination-out",a.beginPath(),a.arc(e,i,u,0,Math.PI*2),a.fill(),a.globalCompositeOperation="source-over",a.beginPath(),a.arc(e,i,n-c*.5,0,Math.PI*2),a.strokeStyle=$r("#FFFFFF",.2),a.lineWidth=1.5,a.stroke(),a.restore()}function $r(a,e){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!i)return a;const n=parseInt(i[1],16),r=parseInt(i[2],16),c=parseInt(i[3],16);return`rgba(${n},${r},${c},${e})`}const dh=128,hm=new Map,ll=new Map;function cS(){return["energyRing0","energyRing1","energyRing2","energyRing3","energyRing4"]}function uS(){const a=document.createElement("canvas");a.width=dh,a.height=dh;const e=a.getContext("2d",{alpha:!0});return{canvas:a,ctx:e}}function hS(a){const{canvas:e,ctx:i}=uS(),n=dh/2;switch(i.clearRect(0,0,e.width,e.height),a){case"energyRing0":case"energyRing1":Qr(i,n,n,64,"#FFBF00");break;case"energyRing2":Qr(i,n,n,64,"#2CFF05");break;case"energyRing3":Qr(i,n,n,64,"#00FFFF");break;case"energyRing4":Qr(i,n,n,64,"#7F00FF");break;default:console.warn(`[ProjectileSpriteCache] Unknown projectile type: ${a}`);break}hm.set(a,{canvas:e})}function fS(){for(const a of cS())hS(a)}function dS(a){let e=0;for(const[i,n]of hm.entries())try{const r=Rt(a,n.canvas);ll.set(i,{texture:r}),e++}catch(r){console.error(`[GLProjectileSpriteCache] Failed to create texture for ${i}:`,r)}console.log(`[GLProjectileSpriteCache] Initialized ${e} GL2 projectile textures.`)}function gS(a){for(const{texture:e}of ll.values())e&&a.isTexture(e)&&a.deleteTexture(e);ll.clear()}function fo(a){const e=ll.get(a);if(!e)throw new Error(`GL projectile sprite not cached: ${a}`);return e}var Yu={exports:{}},go={},qu={exports:{}},ju={};/**
 * @license React
 * scheduler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Vg;function pS(){return Vg||(Vg=1,function(a){function e(_,X){var se=_.length;_.push(X);e:for(;0<se;){var oe=se-1>>>1,k=_[oe];if(0<r(k,X))_[oe]=X,_[se]=k,se=oe;else break e}}function i(_){return _.length===0?null:_[0]}function n(_){if(_.length===0)return null;var X=_[0],se=_.pop();if(se!==X){_[0]=se;e:for(var oe=0,k=_.length,G=k>>>1;oe<G;){var ee=2*(oe+1)-1,J=_[ee],re=ee+1,ve=_[re];if(0>r(J,se))re<k&&0>r(ve,J)?(_[oe]=ve,_[re]=se,oe=re):(_[oe]=J,_[ee]=se,oe=ee);else if(re<k&&0>r(ve,se))_[oe]=ve,_[re]=se,oe=re;else break e}}return X}function r(_,X){var se=_.sortIndex-X.sortIndex;return se!==0?se:_.id-X.id}if(a.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var c=performance;a.unstable_now=function(){return c.now()}}else{var u=Date,h=u.now();a.unstable_now=function(){return u.now()-h}}var d=[],g=[],m=1,y=null,v=3,M=!1,S=!1,T=!1,w=!1,A=typeof setTimeout=="function"?setTimeout:null,R=typeof clearTimeout=="function"?clearTimeout:null,I=typeof setImmediate<"u"?setImmediate:null;function x(_){for(var X=i(g);X!==null;){if(X.callback===null)n(g);else if(X.startTime<=_)n(g),X.sortIndex=X.expirationTime,e(d,X);else break;X=i(g)}}function P(_){if(T=!1,x(_),!S)if(i(d)!==null)S=!0,N||(N=!0,K());else{var X=i(g);X!==null&&te(P,X.startTime-_)}}var N=!1,W=-1,H=5,q=-1;function ie(){return w?!0:!(a.unstable_now()-q<H)}function $(){if(w=!1,N){var _=a.unstable_now();q=_;var X=!0;try{e:{S=!1,T&&(T=!1,R(W),W=-1),M=!0;var se=v;try{t:{for(x(_),y=i(d);y!==null&&!(y.expirationTime>_&&ie());){var oe=y.callback;if(typeof oe=="function"){y.callback=null,v=y.priorityLevel;var k=oe(y.expirationTime<=_);if(_=a.unstable_now(),typeof k=="function"){y.callback=k,x(_),X=!0;break t}y===i(d)&&n(d),x(_)}else n(d);y=i(d)}if(y!==null)X=!0;else{var G=i(g);G!==null&&te(P,G.startTime-_),X=!1}}break e}finally{y=null,v=se,M=!1}X=void 0}}finally{X?K():N=!1}}}var K;if(typeof I=="function")K=function(){I($)};else if(typeof MessageChannel<"u"){var ne=new MessageChannel,Z=ne.port2;ne.port1.onmessage=$,K=function(){Z.postMessage(null)}}else K=function(){A($,0)};function te(_,X){W=A(function(){_(a.unstable_now())},X)}a.unstable_IdlePriority=5,a.unstable_ImmediatePriority=1,a.unstable_LowPriority=4,a.unstable_NormalPriority=3,a.unstable_Profiling=null,a.unstable_UserBlockingPriority=2,a.unstable_cancelCallback=function(_){_.callback=null},a.unstable_forceFrameRate=function(_){0>_||125<_?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):H=0<_?Math.floor(1e3/_):5},a.unstable_getCurrentPriorityLevel=function(){return v},a.unstable_next=function(_){switch(v){case 1:case 2:case 3:var X=3;break;default:X=v}var se=v;v=X;try{return _()}finally{v=se}},a.unstable_requestPaint=function(){w=!0},a.unstable_runWithPriority=function(_,X){switch(_){case 1:case 2:case 3:case 4:case 5:break;default:_=3}var se=v;v=_;try{return X()}finally{v=se}},a.unstable_scheduleCallback=function(_,X,se){var oe=a.unstable_now();switch(typeof se=="object"&&se!==null?(se=se.delay,se=typeof se=="number"&&0<se?oe+se:oe):se=oe,_){case 1:var k=-1;break;case 2:k=250;break;case 5:k=1073741823;break;case 4:k=1e4;break;default:k=5e3}return k=se+k,_={id:m++,callback:X,priorityLevel:_,startTime:se,expirationTime:k,sortIndex:-1},se>oe?(_.sortIndex=se,e(g,_),i(d)===null&&_===i(g)&&(T?(R(W),W=-1):T=!0,te(P,se-oe))):(_.sortIndex=k,e(d,_),S||M||(S=!0,N||(N=!0,K()))),_},a.unstable_shouldYield=ie,a.unstable_wrapCallback=function(_){var X=v;return function(){var se=v;v=X;try{return _.apply(this,arguments)}finally{v=se}}}}(ju)),ju}var Xg;function mS(){return Xg||(Xg=1,qu.exports=pS()),qu.exports}var Ku={exports:{}},ye={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Yg;function yS(){if(Yg)return ye;Yg=1;var a=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),n=Symbol.for("react.strict_mode"),r=Symbol.for("react.profiler"),c=Symbol.for("react.consumer"),u=Symbol.for("react.context"),h=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),g=Symbol.for("react.memo"),m=Symbol.for("react.lazy"),y=Symbol.iterator;function v(k){return k===null||typeof k!="object"?null:(k=y&&k[y]||k["@@iterator"],typeof k=="function"?k:null)}var M={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},S=Object.assign,T={};function w(k,G,ee){this.props=k,this.context=G,this.refs=T,this.updater=ee||M}w.prototype.isReactComponent={},w.prototype.setState=function(k,G){if(typeof k!="object"&&typeof k!="function"&&k!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,k,G,"setState")},w.prototype.forceUpdate=function(k){this.updater.enqueueForceUpdate(this,k,"forceUpdate")};function A(){}A.prototype=w.prototype;function R(k,G,ee){this.props=k,this.context=G,this.refs=T,this.updater=ee||M}var I=R.prototype=new A;I.constructor=R,S(I,w.prototype),I.isPureReactComponent=!0;var x=Array.isArray,P={H:null,A:null,T:null,S:null,V:null},N=Object.prototype.hasOwnProperty;function W(k,G,ee,J,re,ve){return ee=ve.ref,{$$typeof:a,type:k,key:G,ref:ee!==void 0?ee:null,props:ve}}function H(k,G){return W(k.type,G,void 0,void 0,void 0,k.props)}function q(k){return typeof k=="object"&&k!==null&&k.$$typeof===a}function ie(k){var G={"=":"=0",":":"=2"};return"$"+k.replace(/[=:]/g,function(ee){return G[ee]})}var $=/\/+/g;function K(k,G){return typeof k=="object"&&k!==null&&k.key!=null?ie(""+k.key):G.toString(36)}function ne(){}function Z(k){switch(k.status){case"fulfilled":return k.value;case"rejected":throw k.reason;default:switch(typeof k.status=="string"?k.then(ne,ne):(k.status="pending",k.then(function(G){k.status==="pending"&&(k.status="fulfilled",k.value=G)},function(G){k.status==="pending"&&(k.status="rejected",k.reason=G)})),k.status){case"fulfilled":return k.value;case"rejected":throw k.reason}}throw k}function te(k,G,ee,J,re){var ve=typeof k;(ve==="undefined"||ve==="boolean")&&(k=null);var he=!1;if(k===null)he=!0;else switch(ve){case"bigint":case"string":case"number":he=!0;break;case"object":switch(k.$$typeof){case a:case e:he=!0;break;case m:return he=k._init,te(he(k._payload),G,ee,J,re)}}if(he)return re=re(k),he=J===""?"."+K(k,0):J,x(re)?(ee="",he!=null&&(ee=he.replace($,"$&/")+"/"),te(re,G,ee,"",function(ui){return ui})):re!=null&&(q(re)&&(re=H(re,ee+(re.key==null||k&&k.key===re.key?"":(""+re.key).replace($,"$&/")+"/")+he)),G.push(re)),1;he=0;var ct=J===""?".":J+":";if(x(k))for(var Fe=0;Fe<k.length;Fe++)J=k[Fe],ve=ct+K(J,Fe),he+=te(J,G,ee,ve,re);else if(Fe=v(k),typeof Fe=="function")for(k=Fe.call(k),Fe=0;!(J=k.next()).done;)J=J.value,ve=ct+K(J,Fe++),he+=te(J,G,ee,ve,re);else if(ve==="object"){if(typeof k.then=="function")return te(Z(k),G,ee,J,re);throw G=String(k),Error("Objects are not valid as a React child (found: "+(G==="[object Object]"?"object with keys {"+Object.keys(k).join(", ")+"}":G)+"). If you meant to render a collection of children, use an array instead.")}return he}function _(k,G,ee){if(k==null)return k;var J=[],re=0;return te(k,J,"","",function(ve){return G.call(ee,ve,re++)}),J}function X(k){if(k._status===-1){var G=k._result;G=G(),G.then(function(ee){(k._status===0||k._status===-1)&&(k._status=1,k._result=ee)},function(ee){(k._status===0||k._status===-1)&&(k._status=2,k._result=ee)}),k._status===-1&&(k._status=0,k._result=G)}if(k._status===1)return k._result.default;throw k._result}var se=typeof reportError=="function"?reportError:function(k){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var G=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof k=="object"&&k!==null&&typeof k.message=="string"?String(k.message):String(k),error:k});if(!window.dispatchEvent(G))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",k);return}console.error(k)};function oe(){}return ye.Children={map:_,forEach:function(k,G,ee){_(k,function(){G.apply(this,arguments)},ee)},count:function(k){var G=0;return _(k,function(){G++}),G},toArray:function(k){return _(k,function(G){return G})||[]},only:function(k){if(!q(k))throw Error("React.Children.only expected to receive a single React element child.");return k}},ye.Component=w,ye.Fragment=i,ye.Profiler=r,ye.PureComponent=R,ye.StrictMode=n,ye.Suspense=d,ye.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=P,ye.__COMPILER_RUNTIME={__proto__:null,c:function(k){return P.H.useMemoCache(k)}},ye.cache=function(k){return function(){return k.apply(null,arguments)}},ye.cloneElement=function(k,G,ee){if(k==null)throw Error("The argument must be a React element, but you passed "+k+".");var J=S({},k.props),re=k.key,ve=void 0;if(G!=null)for(he in G.ref!==void 0&&(ve=void 0),G.key!==void 0&&(re=""+G.key),G)!N.call(G,he)||he==="key"||he==="__self"||he==="__source"||he==="ref"&&G.ref===void 0||(J[he]=G[he]);var he=arguments.length-2;if(he===1)J.children=ee;else if(1<he){for(var ct=Array(he),Fe=0;Fe<he;Fe++)ct[Fe]=arguments[Fe+2];J.children=ct}return W(k.type,re,void 0,void 0,ve,J)},ye.createContext=function(k){return k={$$typeof:u,_currentValue:k,_currentValue2:k,_threadCount:0,Provider:null,Consumer:null},k.Provider=k,k.Consumer={$$typeof:c,_context:k},k},ye.createElement=function(k,G,ee){var J,re={},ve=null;if(G!=null)for(J in G.key!==void 0&&(ve=""+G.key),G)N.call(G,J)&&J!=="key"&&J!=="__self"&&J!=="__source"&&(re[J]=G[J]);var he=arguments.length-2;if(he===1)re.children=ee;else if(1<he){for(var ct=Array(he),Fe=0;Fe<he;Fe++)ct[Fe]=arguments[Fe+2];re.children=ct}if(k&&k.defaultProps)for(J in he=k.defaultProps,he)re[J]===void 0&&(re[J]=he[J]);return W(k,ve,void 0,void 0,null,re)},ye.createRef=function(){return{current:null}},ye.forwardRef=function(k){return{$$typeof:h,render:k}},ye.isValidElement=q,ye.lazy=function(k){return{$$typeof:m,_payload:{_status:-1,_result:k},_init:X}},ye.memo=function(k,G){return{$$typeof:g,type:k,compare:G===void 0?null:G}},ye.startTransition=function(k){var G=P.T,ee={};P.T=ee;try{var J=k(),re=P.S;re!==null&&re(ee,J),typeof J=="object"&&J!==null&&typeof J.then=="function"&&J.then(oe,se)}catch(ve){se(ve)}finally{P.T=G}},ye.unstable_useCacheRefresh=function(){return P.H.useCacheRefresh()},ye.use=function(k){return P.H.use(k)},ye.useActionState=function(k,G,ee){return P.H.useActionState(k,G,ee)},ye.useCallback=function(k,G){return P.H.useCallback(k,G)},ye.useContext=function(k){return P.H.useContext(k)},ye.useDebugValue=function(){},ye.useDeferredValue=function(k,G){return P.H.useDeferredValue(k,G)},ye.useEffect=function(k,G,ee){var J=P.H;if(typeof ee=="function")throw Error("useEffect CRUD overload is not enabled in this build of React.");return J.useEffect(k,G)},ye.useId=function(){return P.H.useId()},ye.useImperativeHandle=function(k,G,ee){return P.H.useImperativeHandle(k,G,ee)},ye.useInsertionEffect=function(k,G){return P.H.useInsertionEffect(k,G)},ye.useLayoutEffect=function(k,G){return P.H.useLayoutEffect(k,G)},ye.useMemo=function(k,G){return P.H.useMemo(k,G)},ye.useOptimistic=function(k,G){return P.H.useOptimistic(k,G)},ye.useReducer=function(k,G,ee){return P.H.useReducer(k,G,ee)},ye.useRef=function(k){return P.H.useRef(k)},ye.useState=function(k){return P.H.useState(k)},ye.useSyncExternalStore=function(k,G,ee){return P.H.useSyncExternalStore(k,G,ee)},ye.useTransition=function(){return P.H.useTransition()},ye.version="19.1.0",ye}var qg;function Ah(){return qg||(qg=1,Ku.exports=yS()),Ku.exports}var Zu={exports:{}},ft={};/**
 * @license React
 * react-dom.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var jg;function vS(){if(jg)return ft;jg=1;var a=Ah();function e(d){var g="https://react.dev/errors/"+d;if(1<arguments.length){g+="?args[]="+encodeURIComponent(arguments[1]);for(var m=2;m<arguments.length;m++)g+="&args[]="+encodeURIComponent(arguments[m])}return"Minified React error #"+d+"; visit "+g+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function i(){}var n={d:{f:i,r:function(){throw Error(e(522))},D:i,C:i,L:i,m:i,X:i,S:i,M:i},p:0,findDOMNode:null},r=Symbol.for("react.portal");function c(d,g,m){var y=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:r,key:y==null?null:""+y,children:d,containerInfo:g,implementation:m}}var u=a.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function h(d,g){if(d==="font")return"";if(typeof g=="string")return g==="use-credentials"?g:""}return ft.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=n,ft.createPortal=function(d,g){var m=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!g||g.nodeType!==1&&g.nodeType!==9&&g.nodeType!==11)throw Error(e(299));return c(d,g,null,m)},ft.flushSync=function(d){var g=u.T,m=n.p;try{if(u.T=null,n.p=2,d)return d()}finally{u.T=g,n.p=m,n.d.f()}},ft.preconnect=function(d,g){typeof d=="string"&&(g?(g=g.crossOrigin,g=typeof g=="string"?g==="use-credentials"?g:"":void 0):g=null,n.d.C(d,g))},ft.prefetchDNS=function(d){typeof d=="string"&&n.d.D(d)},ft.preinit=function(d,g){if(typeof d=="string"&&g&&typeof g.as=="string"){var m=g.as,y=h(m,g.crossOrigin),v=typeof g.integrity=="string"?g.integrity:void 0,M=typeof g.fetchPriority=="string"?g.fetchPriority:void 0;m==="style"?n.d.S(d,typeof g.precedence=="string"?g.precedence:void 0,{crossOrigin:y,integrity:v,fetchPriority:M}):m==="script"&&n.d.X(d,{crossOrigin:y,integrity:v,fetchPriority:M,nonce:typeof g.nonce=="string"?g.nonce:void 0})}},ft.preinitModule=function(d,g){if(typeof d=="string")if(typeof g=="object"&&g!==null){if(g.as==null||g.as==="script"){var m=h(g.as,g.crossOrigin);n.d.M(d,{crossOrigin:m,integrity:typeof g.integrity=="string"?g.integrity:void 0,nonce:typeof g.nonce=="string"?g.nonce:void 0})}}else g==null&&n.d.M(d)},ft.preload=function(d,g){if(typeof d=="string"&&typeof g=="object"&&g!==null&&typeof g.as=="string"){var m=g.as,y=h(m,g.crossOrigin);n.d.L(d,m,{crossOrigin:y,integrity:typeof g.integrity=="string"?g.integrity:void 0,nonce:typeof g.nonce=="string"?g.nonce:void 0,type:typeof g.type=="string"?g.type:void 0,fetchPriority:typeof g.fetchPriority=="string"?g.fetchPriority:void 0,referrerPolicy:typeof g.referrerPolicy=="string"?g.referrerPolicy:void 0,imageSrcSet:typeof g.imageSrcSet=="string"?g.imageSrcSet:void 0,imageSizes:typeof g.imageSizes=="string"?g.imageSizes:void 0,media:typeof g.media=="string"?g.media:void 0})}},ft.preloadModule=function(d,g){if(typeof d=="string")if(g){var m=h(g.as,g.crossOrigin);n.d.m(d,{as:typeof g.as=="string"&&g.as!=="script"?g.as:void 0,crossOrigin:m,integrity:typeof g.integrity=="string"?g.integrity:void 0})}else n.d.m(d)},ft.requestFormReset=function(d){n.d.r(d)},ft.unstable_batchedUpdates=function(d,g){return d(g)},ft.useFormState=function(d,g,m){return u.H.useFormState(d,g,m)},ft.useFormStatus=function(){return u.H.useHostTransitionStatus()},ft.version="19.1.0",ft}var Kg;function bS(){if(Kg)return Zu.exports;Kg=1;function a(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(a)}catch(e){console.error(e)}}return a(),Zu.exports=vS(),Zu.exports}/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Zg;function SS(){if(Zg)return go;Zg=1;var a=mS(),e=Ah(),i=bS();function n(t){var s="https://react.dev/errors/"+t;if(1<arguments.length){s+="?args[]="+encodeURIComponent(arguments[1]);for(var o=2;o<arguments.length;o++)s+="&args[]="+encodeURIComponent(arguments[o])}return"Minified React error #"+t+"; visit "+s+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function r(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11)}function c(t){var s=t,o=t;if(t.alternate)for(;s.return;)s=s.return;else{t=s;do s=t,(s.flags&4098)!==0&&(o=s.return),t=s.return;while(t)}return s.tag===3?o:null}function u(t){if(t.tag===13){var s=t.memoizedState;if(s===null&&(t=t.alternate,t!==null&&(s=t.memoizedState)),s!==null)return s.dehydrated}return null}function h(t){if(c(t)!==t)throw Error(n(188))}function d(t){var s=t.alternate;if(!s){if(s=c(t),s===null)throw Error(n(188));return s!==t?null:t}for(var o=t,l=s;;){var f=o.return;if(f===null)break;var p=f.alternate;if(p===null){if(l=f.return,l!==null){o=l;continue}break}if(f.child===p.child){for(p=f.child;p;){if(p===o)return h(f),t;if(p===l)return h(f),s;p=p.sibling}throw Error(n(188))}if(o.return!==l.return)o=f,l=p;else{for(var b=!1,C=f.child;C;){if(C===o){b=!0,o=f,l=p;break}if(C===l){b=!0,l=f,o=p;break}C=C.sibling}if(!b){for(C=p.child;C;){if(C===o){b=!0,o=p,l=f;break}if(C===l){b=!0,l=p,o=f;break}C=C.sibling}if(!b)throw Error(n(189))}}if(o.alternate!==l)throw Error(n(190))}if(o.tag!==3)throw Error(n(188));return o.stateNode.current===o?t:s}function g(t){var s=t.tag;if(s===5||s===26||s===27||s===6)return t;for(t=t.child;t!==null;){if(s=g(t),s!==null)return s;t=t.sibling}return null}var m=Object.assign,y=Symbol.for("react.element"),v=Symbol.for("react.transitional.element"),M=Symbol.for("react.portal"),S=Symbol.for("react.fragment"),T=Symbol.for("react.strict_mode"),w=Symbol.for("react.profiler"),A=Symbol.for("react.provider"),R=Symbol.for("react.consumer"),I=Symbol.for("react.context"),x=Symbol.for("react.forward_ref"),P=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),W=Symbol.for("react.memo"),H=Symbol.for("react.lazy"),q=Symbol.for("react.activity"),ie=Symbol.for("react.memo_cache_sentinel"),$=Symbol.iterator;function K(t){return t===null||typeof t!="object"?null:(t=$&&t[$]||t["@@iterator"],typeof t=="function"?t:null)}var ne=Symbol.for("react.client.reference");function Z(t){if(t==null)return null;if(typeof t=="function")return t.$$typeof===ne?null:t.displayName||t.name||null;if(typeof t=="string")return t;switch(t){case S:return"Fragment";case w:return"Profiler";case T:return"StrictMode";case P:return"Suspense";case N:return"SuspenseList";case q:return"Activity"}if(typeof t=="object")switch(t.$$typeof){case M:return"Portal";case I:return(t.displayName||"Context")+".Provider";case R:return(t._context.displayName||"Context")+".Consumer";case x:var s=t.render;return t=t.displayName,t||(t=s.displayName||s.name||"",t=t!==""?"ForwardRef("+t+")":"ForwardRef"),t;case W:return s=t.displayName||null,s!==null?s:Z(t.type)||"Memo";case H:s=t._payload,t=t._init;try{return Z(t(s))}catch{}}return null}var te=Array.isArray,_=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,X=i.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,se={pending:!1,data:null,method:null,action:null},oe=[],k=-1;function G(t){return{current:t}}function ee(t){0>k||(t.current=oe[k],oe[k]=null,k--)}function J(t,s){k++,oe[k]=t.current,t.current=s}var re=G(null),ve=G(null),he=G(null),ct=G(null);function Fe(t,s){switch(J(he,s),J(ve,t),J(re,null),s.nodeType){case 9:case 11:t=(t=s.documentElement)&&(t=t.namespaceURI)?ug(t):0;break;default:if(t=s.tagName,s=s.namespaceURI)s=ug(s),t=hg(s,t);else switch(t){case"svg":t=1;break;case"math":t=2;break;default:t=0}}ee(re),J(re,t)}function ui(){ee(re),ee(ve),ee(he)}function da(t){t.memoizedState!==null&&J(ct,t);var s=re.current,o=hg(s,t.type);s!==o&&(J(ve,t),J(re,o))}function Ki(t){ve.current===t&&(ee(re),ee(ve)),ct.current===t&&(ee(ct),oo._currentValue=se)}var Il=Object.prototype.hasOwnProperty,xl=a.unstable_scheduleCallback,_l=a.unstable_cancelCallback,iy=a.unstable_shouldYield,sy=a.unstable_requestPaint,hi=a.unstable_now,ny=a.unstable_getCurrentPriorityLevel,zh=a.unstable_ImmediatePriority,Vh=a.unstable_UserBlockingPriority,Ro=a.unstable_NormalPriority,ay=a.unstable_LowPriority,Xh=a.unstable_IdlePriority,oy=a.log,ry=a.unstable_setDisableYieldValue,ga=null,_t=null;function Zi(t){if(typeof oy=="function"&&ry(t),_t&&typeof _t.setStrictMode=="function")try{_t.setStrictMode(ga,t)}catch{}}var Dt=Math.clz32?Math.clz32:uy,ly=Math.log,cy=Math.LN2;function uy(t){return t>>>=0,t===0?32:31-(ly(t)/cy|0)|0}var Bo=256,Io=4194304;function Es(t){var s=t&42;if(s!==0)return s;switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t&4194048;case 4194304:case 8388608:case 16777216:case 33554432:return t&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return t}}function xo(t,s,o){var l=t.pendingLanes;if(l===0)return 0;var f=0,p=t.suspendedLanes,b=t.pingedLanes;t=t.warmLanes;var C=l&134217727;return C!==0?(l=C&~p,l!==0?f=Es(l):(b&=C,b!==0?f=Es(b):o||(o=C&~t,o!==0&&(f=Es(o))))):(C=l&~p,C!==0?f=Es(C):b!==0?f=Es(b):o||(o=l&~t,o!==0&&(f=Es(o)))),f===0?0:s!==0&&s!==f&&(s&p)===0&&(p=f&-f,o=s&-s,p>=o||p===32&&(o&4194048)!==0)?s:f}function pa(t,s){return(t.pendingLanes&~(t.suspendedLanes&~t.pingedLanes)&s)===0}function hy(t,s){switch(t){case 1:case 2:case 4:case 8:case 64:return s+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return s+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Yh(){var t=Bo;return Bo<<=1,(Bo&4194048)===0&&(Bo=256),t}function qh(){var t=Io;return Io<<=1,(Io&62914560)===0&&(Io=4194304),t}function Dl(t){for(var s=[],o=0;31>o;o++)s.push(t);return s}function ma(t,s){t.pendingLanes|=s,s!==268435456&&(t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0)}function fy(t,s,o,l,f,p){var b=t.pendingLanes;t.pendingLanes=o,t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0,t.expiredLanes&=o,t.entangledLanes&=o,t.errorRecoveryDisabledLanes&=o,t.shellSuspendCounter=0;var C=t.entanglements,E=t.expirationTimes,O=t.hiddenUpdates;for(o=b&~o;0<o;){var V=31-Dt(o),j=1<<V;C[V]=0,E[V]=-1;var F=O[V];if(F!==null)for(O[V]=null,V=0;V<F.length;V++){var U=F[V];U!==null&&(U.lane&=-536870913)}o&=~j}l!==0&&jh(t,l,0),p!==0&&f===0&&t.tag!==0&&(t.suspendedLanes|=p&~(b&~s))}function jh(t,s,o){t.pendingLanes|=s,t.suspendedLanes&=~s;var l=31-Dt(s);t.entangledLanes|=s,t.entanglements[l]=t.entanglements[l]|1073741824|o&4194090}function Kh(t,s){var o=t.entangledLanes|=s;for(t=t.entanglements;o;){var l=31-Dt(o),f=1<<l;f&s|t[l]&s&&(t[l]|=s),o&=~f}}function Pl(t){switch(t){case 2:t=1;break;case 8:t=4;break;case 32:t=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:t=128;break;case 268435456:t=134217728;break;default:t=0}return t}function Ll(t){return t&=-t,2<t?8<t?(t&134217727)!==0?32:268435456:8:2}function Zh(){var t=X.p;return t!==0?t:(t=window.event,t===void 0?32:Ig(t.type))}function dy(t,s){var o=X.p;try{return X.p=t,s()}finally{X.p=o}}var Qi=Math.random().toString(36).slice(2),ut="__reactFiber$"+Qi,Ct="__reactProps$"+Qi,cn="__reactContainer$"+Qi,Ol="__reactEvents$"+Qi,gy="__reactListeners$"+Qi,py="__reactHandles$"+Qi,Qh="__reactResources$"+Qi,ya="__reactMarker$"+Qi;function Fl(t){delete t[ut],delete t[Ct],delete t[Ol],delete t[gy],delete t[py]}function un(t){var s=t[ut];if(s)return s;for(var o=t.parentNode;o;){if(s=o[cn]||o[ut]){if(o=s.alternate,s.child!==null||o!==null&&o.child!==null)for(t=pg(t);t!==null;){if(o=t[ut])return o;t=pg(t)}return s}t=o,o=t.parentNode}return null}function hn(t){if(t=t[ut]||t[cn]){var s=t.tag;if(s===5||s===6||s===13||s===26||s===27||s===3)return t}return null}function va(t){var s=t.tag;if(s===5||s===26||s===27||s===6)return t.stateNode;throw Error(n(33))}function fn(t){var s=t[Qh];return s||(s=t[Qh]={hoistableStyles:new Map,hoistableScripts:new Map}),s}function Je(t){t[ya]=!0}var $h=new Set,Jh={};function Rs(t,s){dn(t,s),dn(t+"Capture",s)}function dn(t,s){for(Jh[t]=s,t=0;t<s.length;t++)$h.add(s[t])}var my=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),ef={},tf={};function yy(t){return Il.call(tf,t)?!0:Il.call(ef,t)?!1:my.test(t)?tf[t]=!0:(ef[t]=!0,!1)}function _o(t,s,o){if(yy(s))if(o===null)t.removeAttribute(s);else{switch(typeof o){case"undefined":case"function":case"symbol":t.removeAttribute(s);return;case"boolean":var l=s.toLowerCase().slice(0,5);if(l!=="data-"&&l!=="aria-"){t.removeAttribute(s);return}}t.setAttribute(s,""+o)}}function Do(t,s,o){if(o===null)t.removeAttribute(s);else{switch(typeof o){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(s);return}t.setAttribute(s,""+o)}}function wi(t,s,o,l){if(l===null)t.removeAttribute(o);else{switch(typeof l){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(o);return}t.setAttributeNS(s,o,""+l)}}var Ul,sf;function gn(t){if(Ul===void 0)try{throw Error()}catch(o){var s=o.stack.trim().match(/\n( *(at )?)/);Ul=s&&s[1]||"",sf=-1<o.stack.indexOf(`
    at`)?" (<anonymous>)":-1<o.stack.indexOf("@")?"@unknown:0:0":""}return`
`+Ul+t+sf}var Nl=!1;function Hl(t,s){if(!t||Nl)return"";Nl=!0;var o=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var l={DetermineComponentFrameRoot:function(){try{if(s){var j=function(){throw Error()};if(Object.defineProperty(j.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(j,[])}catch(U){var F=U}Reflect.construct(t,[],j)}else{try{j.call()}catch(U){F=U}t.call(j.prototype)}}else{try{throw Error()}catch(U){F=U}(j=t())&&typeof j.catch=="function"&&j.catch(function(){})}}catch(U){if(U&&F&&typeof U.stack=="string")return[U.stack,F.stack]}return[null,null]}};l.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var f=Object.getOwnPropertyDescriptor(l.DetermineComponentFrameRoot,"name");f&&f.configurable&&Object.defineProperty(l.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var p=l.DetermineComponentFrameRoot(),b=p[0],C=p[1];if(b&&C){var E=b.split(`
`),O=C.split(`
`);for(f=l=0;l<E.length&&!E[l].includes("DetermineComponentFrameRoot");)l++;for(;f<O.length&&!O[f].includes("DetermineComponentFrameRoot");)f++;if(l===E.length||f===O.length)for(l=E.length-1,f=O.length-1;1<=l&&0<=f&&E[l]!==O[f];)f--;for(;1<=l&&0<=f;l--,f--)if(E[l]!==O[f]){if(l!==1||f!==1)do if(l--,f--,0>f||E[l]!==O[f]){var V=`
`+E[l].replace(" at new "," at ");return t.displayName&&V.includes("<anonymous>")&&(V=V.replace("<anonymous>",t.displayName)),V}while(1<=l&&0<=f);break}}}finally{Nl=!1,Error.prepareStackTrace=o}return(o=t?t.displayName||t.name:"")?gn(o):""}function vy(t){switch(t.tag){case 26:case 27:case 5:return gn(t.type);case 16:return gn("Lazy");case 13:return gn("Suspense");case 19:return gn("SuspenseList");case 0:case 15:return Hl(t.type,!1);case 11:return Hl(t.type.render,!1);case 1:return Hl(t.type,!0);case 31:return gn("Activity");default:return""}}function nf(t){try{var s="";do s+=vy(t),t=t.return;while(t);return s}catch(o){return`
Error generating stack: `+o.message+`
`+o.stack}}function Vt(t){switch(typeof t){case"bigint":case"boolean":case"number":case"string":case"undefined":return t;case"object":return t;default:return""}}function af(t){var s=t.type;return(t=t.nodeName)&&t.toLowerCase()==="input"&&(s==="checkbox"||s==="radio")}function by(t){var s=af(t)?"checked":"value",o=Object.getOwnPropertyDescriptor(t.constructor.prototype,s),l=""+t[s];if(!t.hasOwnProperty(s)&&typeof o<"u"&&typeof o.get=="function"&&typeof o.set=="function"){var f=o.get,p=o.set;return Object.defineProperty(t,s,{configurable:!0,get:function(){return f.call(this)},set:function(b){l=""+b,p.call(this,b)}}),Object.defineProperty(t,s,{enumerable:o.enumerable}),{getValue:function(){return l},setValue:function(b){l=""+b},stopTracking:function(){t._valueTracker=null,delete t[s]}}}}function Po(t){t._valueTracker||(t._valueTracker=by(t))}function of(t){if(!t)return!1;var s=t._valueTracker;if(!s)return!0;var o=s.getValue(),l="";return t&&(l=af(t)?t.checked?"true":"false":t.value),t=l,t!==o?(s.setValue(t),!0):!1}function Lo(t){if(t=t||(typeof document<"u"?document:void 0),typeof t>"u")return null;try{return t.activeElement||t.body}catch{return t.body}}var Sy=/[\n"\\]/g;function Xt(t){return t.replace(Sy,function(s){return"\\"+s.charCodeAt(0).toString(16)+" "})}function Gl(t,s,o,l,f,p,b,C){t.name="",b!=null&&typeof b!="function"&&typeof b!="symbol"&&typeof b!="boolean"?t.type=b:t.removeAttribute("type"),s!=null?b==="number"?(s===0&&t.value===""||t.value!=s)&&(t.value=""+Vt(s)):t.value!==""+Vt(s)&&(t.value=""+Vt(s)):b!=="submit"&&b!=="reset"||t.removeAttribute("value"),s!=null?Wl(t,b,Vt(s)):o!=null?Wl(t,b,Vt(o)):l!=null&&t.removeAttribute("value"),f==null&&p!=null&&(t.defaultChecked=!!p),f!=null&&(t.checked=f&&typeof f!="function"&&typeof f!="symbol"),C!=null&&typeof C!="function"&&typeof C!="symbol"&&typeof C!="boolean"?t.name=""+Vt(C):t.removeAttribute("name")}function rf(t,s,o,l,f,p,b,C){if(p!=null&&typeof p!="function"&&typeof p!="symbol"&&typeof p!="boolean"&&(t.type=p),s!=null||o!=null){if(!(p!=="submit"&&p!=="reset"||s!=null))return;o=o!=null?""+Vt(o):"",s=s!=null?""+Vt(s):o,C||s===t.value||(t.value=s),t.defaultValue=s}l=l??f,l=typeof l!="function"&&typeof l!="symbol"&&!!l,t.checked=C?t.checked:!!l,t.defaultChecked=!!l,b!=null&&typeof b!="function"&&typeof b!="symbol"&&typeof b!="boolean"&&(t.name=b)}function Wl(t,s,o){s==="number"&&Lo(t.ownerDocument)===t||t.defaultValue===""+o||(t.defaultValue=""+o)}function pn(t,s,o,l){if(t=t.options,s){s={};for(var f=0;f<o.length;f++)s["$"+o[f]]=!0;for(o=0;o<t.length;o++)f=s.hasOwnProperty("$"+t[o].value),t[o].selected!==f&&(t[o].selected=f),f&&l&&(t[o].defaultSelected=!0)}else{for(o=""+Vt(o),s=null,f=0;f<t.length;f++){if(t[f].value===o){t[f].selected=!0,l&&(t[f].defaultSelected=!0);return}s!==null||t[f].disabled||(s=t[f])}s!==null&&(s.selected=!0)}}function lf(t,s,o){if(s!=null&&(s=""+Vt(s),s!==t.value&&(t.value=s),o==null)){t.defaultValue!==s&&(t.defaultValue=s);return}t.defaultValue=o!=null?""+Vt(o):""}function cf(t,s,o,l){if(s==null){if(l!=null){if(o!=null)throw Error(n(92));if(te(l)){if(1<l.length)throw Error(n(93));l=l[0]}o=l}o==null&&(o=""),s=o}o=Vt(s),t.defaultValue=o,l=t.textContent,l===o&&l!==""&&l!==null&&(t.value=l)}function mn(t,s){if(s){var o=t.firstChild;if(o&&o===t.lastChild&&o.nodeType===3){o.nodeValue=s;return}}t.textContent=s}var My=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function uf(t,s,o){var l=s.indexOf("--")===0;o==null||typeof o=="boolean"||o===""?l?t.setProperty(s,""):s==="float"?t.cssFloat="":t[s]="":l?t.setProperty(s,o):typeof o!="number"||o===0||My.has(s)?s==="float"?t.cssFloat=o:t[s]=(""+o).trim():t[s]=o+"px"}function hf(t,s,o){if(s!=null&&typeof s!="object")throw Error(n(62));if(t=t.style,o!=null){for(var l in o)!o.hasOwnProperty(l)||s!=null&&s.hasOwnProperty(l)||(l.indexOf("--")===0?t.setProperty(l,""):l==="float"?t.cssFloat="":t[l]="");for(var f in s)l=s[f],s.hasOwnProperty(f)&&o[f]!==l&&uf(t,f,l)}else for(var p in s)s.hasOwnProperty(p)&&uf(t,p,s[p])}function zl(t){if(t.indexOf("-")===-1)return!1;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Ty=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),Cy=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function Oo(t){return Cy.test(""+t)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":t}var Vl=null;function Xl(t){return t=t.target||t.srcElement||window,t.correspondingUseElement&&(t=t.correspondingUseElement),t.nodeType===3?t.parentNode:t}var yn=null,vn=null;function ff(t){var s=hn(t);if(s&&(t=s.stateNode)){var o=t[Ct]||null;e:switch(t=s.stateNode,s.type){case"input":if(Gl(t,o.value,o.defaultValue,o.defaultValue,o.checked,o.defaultChecked,o.type,o.name),s=o.name,o.type==="radio"&&s!=null){for(o=t;o.parentNode;)o=o.parentNode;for(o=o.querySelectorAll('input[name="'+Xt(""+s)+'"][type="radio"]'),s=0;s<o.length;s++){var l=o[s];if(l!==t&&l.form===t.form){var f=l[Ct]||null;if(!f)throw Error(n(90));Gl(l,f.value,f.defaultValue,f.defaultValue,f.checked,f.defaultChecked,f.type,f.name)}}for(s=0;s<o.length;s++)l=o[s],l.form===t.form&&of(l)}break e;case"textarea":lf(t,o.value,o.defaultValue);break e;case"select":s=o.value,s!=null&&pn(t,!!o.multiple,s,!1)}}}var Yl=!1;function df(t,s,o){if(Yl)return t(s,o);Yl=!0;try{var l=t(s);return l}finally{if(Yl=!1,(yn!==null||vn!==null)&&(Mr(),yn&&(s=yn,t=vn,vn=yn=null,ff(s),t)))for(s=0;s<t.length;s++)ff(t[s])}}function ba(t,s){var o=t.stateNode;if(o===null)return null;var l=o[Ct]||null;if(l===null)return null;o=l[s];e:switch(s){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(l=!l.disabled)||(t=t.type,l=!(t==="button"||t==="input"||t==="select"||t==="textarea")),t=!l;break e;default:t=!1}if(t)return null;if(o&&typeof o!="function")throw Error(n(231,s,typeof o));return o}var Ai=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),ql=!1;if(Ai)try{var Sa={};Object.defineProperty(Sa,"passive",{get:function(){ql=!0}}),window.addEventListener("test",Sa,Sa),window.removeEventListener("test",Sa,Sa)}catch{ql=!1}var $i=null,jl=null,Fo=null;function gf(){if(Fo)return Fo;var t,s=jl,o=s.length,l,f="value"in $i?$i.value:$i.textContent,p=f.length;for(t=0;t<o&&s[t]===f[t];t++);var b=o-t;for(l=1;l<=b&&s[o-l]===f[p-l];l++);return Fo=f.slice(t,1<l?1-l:void 0)}function Uo(t){var s=t.keyCode;return"charCode"in t?(t=t.charCode,t===0&&s===13&&(t=13)):t=s,t===10&&(t=13),32<=t||t===13?t:0}function No(){return!0}function pf(){return!1}function wt(t){function s(o,l,f,p,b){this._reactName=o,this._targetInst=f,this.type=l,this.nativeEvent=p,this.target=b,this.currentTarget=null;for(var C in t)t.hasOwnProperty(C)&&(o=t[C],this[C]=o?o(p):p[C]);return this.isDefaultPrevented=(p.defaultPrevented!=null?p.defaultPrevented:p.returnValue===!1)?No:pf,this.isPropagationStopped=pf,this}return m(s.prototype,{preventDefault:function(){this.defaultPrevented=!0;var o=this.nativeEvent;o&&(o.preventDefault?o.preventDefault():typeof o.returnValue!="unknown"&&(o.returnValue=!1),this.isDefaultPrevented=No)},stopPropagation:function(){var o=this.nativeEvent;o&&(o.stopPropagation?o.stopPropagation():typeof o.cancelBubble!="unknown"&&(o.cancelBubble=!0),this.isPropagationStopped=No)},persist:function(){},isPersistent:No}),s}var Bs={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Ho=wt(Bs),Ma=m({},Bs,{view:0,detail:0}),wy=wt(Ma),Kl,Zl,Ta,Go=m({},Ma,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:$l,button:0,buttons:0,relatedTarget:function(t){return t.relatedTarget===void 0?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==Ta&&(Ta&&t.type==="mousemove"?(Kl=t.screenX-Ta.screenX,Zl=t.screenY-Ta.screenY):Zl=Kl=0,Ta=t),Kl)},movementY:function(t){return"movementY"in t?t.movementY:Zl}}),mf=wt(Go),Ay=m({},Go,{dataTransfer:0}),ky=wt(Ay),Ey=m({},Ma,{relatedTarget:0}),Ql=wt(Ey),Ry=m({},Bs,{animationName:0,elapsedTime:0,pseudoElement:0}),By=wt(Ry),Iy=m({},Bs,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),xy=wt(Iy),_y=m({},Bs,{data:0}),yf=wt(_y),Dy={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Py={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Ly={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function Oy(t){var s=this.nativeEvent;return s.getModifierState?s.getModifierState(t):(t=Ly[t])?!!s[t]:!1}function $l(){return Oy}var Fy=m({},Ma,{key:function(t){if(t.key){var s=Dy[t.key]||t.key;if(s!=="Unidentified")return s}return t.type==="keypress"?(t=Uo(t),t===13?"Enter":String.fromCharCode(t)):t.type==="keydown"||t.type==="keyup"?Py[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:$l,charCode:function(t){return t.type==="keypress"?Uo(t):0},keyCode:function(t){return t.type==="keydown"||t.type==="keyup"?t.keyCode:0},which:function(t){return t.type==="keypress"?Uo(t):t.type==="keydown"||t.type==="keyup"?t.keyCode:0}}),Uy=wt(Fy),Ny=m({},Go,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),vf=wt(Ny),Hy=m({},Ma,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:$l}),Gy=wt(Hy),Wy=m({},Bs,{propertyName:0,elapsedTime:0,pseudoElement:0}),zy=wt(Wy),Vy=m({},Go,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),Xy=wt(Vy),Yy=m({},Bs,{newState:0,oldState:0}),qy=wt(Yy),jy=[9,13,27,32],Jl=Ai&&"CompositionEvent"in window,Ca=null;Ai&&"documentMode"in document&&(Ca=document.documentMode);var Ky=Ai&&"TextEvent"in window&&!Ca,bf=Ai&&(!Jl||Ca&&8<Ca&&11>=Ca),Sf=" ",Mf=!1;function Tf(t,s){switch(t){case"keyup":return jy.indexOf(s.keyCode)!==-1;case"keydown":return s.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Cf(t){return t=t.detail,typeof t=="object"&&"data"in t?t.data:null}var bn=!1;function Zy(t,s){switch(t){case"compositionend":return Cf(s);case"keypress":return s.which!==32?null:(Mf=!0,Sf);case"textInput":return t=s.data,t===Sf&&Mf?null:t;default:return null}}function Qy(t,s){if(bn)return t==="compositionend"||!Jl&&Tf(t,s)?(t=gf(),Fo=jl=$i=null,bn=!1,t):null;switch(t){case"paste":return null;case"keypress":if(!(s.ctrlKey||s.altKey||s.metaKey)||s.ctrlKey&&s.altKey){if(s.char&&1<s.char.length)return s.char;if(s.which)return String.fromCharCode(s.which)}return null;case"compositionend":return bf&&s.locale!=="ko"?null:s.data;default:return null}}var $y={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function wf(t){var s=t&&t.nodeName&&t.nodeName.toLowerCase();return s==="input"?!!$y[t.type]:s==="textarea"}function Af(t,s,o,l){yn?vn?vn.push(l):vn=[l]:yn=l,s=Er(s,"onChange"),0<s.length&&(o=new Ho("onChange","change",null,o,l),t.push({event:o,listeners:s}))}var wa=null,Aa=null;function Jy(t){ag(t,0)}function Wo(t){var s=va(t);if(of(s))return t}function kf(t,s){if(t==="change")return s}var Ef=!1;if(Ai){var ec;if(Ai){var tc="oninput"in document;if(!tc){var Rf=document.createElement("div");Rf.setAttribute("oninput","return;"),tc=typeof Rf.oninput=="function"}ec=tc}else ec=!1;Ef=ec&&(!document.documentMode||9<document.documentMode)}function Bf(){wa&&(wa.detachEvent("onpropertychange",If),Aa=wa=null)}function If(t){if(t.propertyName==="value"&&Wo(Aa)){var s=[];Af(s,Aa,t,Xl(t)),df(Jy,s)}}function ev(t,s,o){t==="focusin"?(Bf(),wa=s,Aa=o,wa.attachEvent("onpropertychange",If)):t==="focusout"&&Bf()}function tv(t){if(t==="selectionchange"||t==="keyup"||t==="keydown")return Wo(Aa)}function iv(t,s){if(t==="click")return Wo(s)}function sv(t,s){if(t==="input"||t==="change")return Wo(s)}function nv(t,s){return t===s&&(t!==0||1/t===1/s)||t!==t&&s!==s}var Pt=typeof Object.is=="function"?Object.is:nv;function ka(t,s){if(Pt(t,s))return!0;if(typeof t!="object"||t===null||typeof s!="object"||s===null)return!1;var o=Object.keys(t),l=Object.keys(s);if(o.length!==l.length)return!1;for(l=0;l<o.length;l++){var f=o[l];if(!Il.call(s,f)||!Pt(t[f],s[f]))return!1}return!0}function xf(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function _f(t,s){var o=xf(t);t=0;for(var l;o;){if(o.nodeType===3){if(l=t+o.textContent.length,t<=s&&l>=s)return{node:o,offset:s-t};t=l}e:{for(;o;){if(o.nextSibling){o=o.nextSibling;break e}o=o.parentNode}o=void 0}o=xf(o)}}function Df(t,s){return t&&s?t===s?!0:t&&t.nodeType===3?!1:s&&s.nodeType===3?Df(t,s.parentNode):"contains"in t?t.contains(s):t.compareDocumentPosition?!!(t.compareDocumentPosition(s)&16):!1:!1}function Pf(t){t=t!=null&&t.ownerDocument!=null&&t.ownerDocument.defaultView!=null?t.ownerDocument.defaultView:window;for(var s=Lo(t.document);s instanceof t.HTMLIFrameElement;){try{var o=typeof s.contentWindow.location.href=="string"}catch{o=!1}if(o)t=s.contentWindow;else break;s=Lo(t.document)}return s}function ic(t){var s=t&&t.nodeName&&t.nodeName.toLowerCase();return s&&(s==="input"&&(t.type==="text"||t.type==="search"||t.type==="tel"||t.type==="url"||t.type==="password")||s==="textarea"||t.contentEditable==="true")}var av=Ai&&"documentMode"in document&&11>=document.documentMode,Sn=null,sc=null,Ea=null,nc=!1;function Lf(t,s,o){var l=o.window===o?o.document:o.nodeType===9?o:o.ownerDocument;nc||Sn==null||Sn!==Lo(l)||(l=Sn,"selectionStart"in l&&ic(l)?l={start:l.selectionStart,end:l.selectionEnd}:(l=(l.ownerDocument&&l.ownerDocument.defaultView||window).getSelection(),l={anchorNode:l.anchorNode,anchorOffset:l.anchorOffset,focusNode:l.focusNode,focusOffset:l.focusOffset}),Ea&&ka(Ea,l)||(Ea=l,l=Er(sc,"onSelect"),0<l.length&&(s=new Ho("onSelect","select",null,s,o),t.push({event:s,listeners:l}),s.target=Sn)))}function Is(t,s){var o={};return o[t.toLowerCase()]=s.toLowerCase(),o["Webkit"+t]="webkit"+s,o["Moz"+t]="moz"+s,o}var Mn={animationend:Is("Animation","AnimationEnd"),animationiteration:Is("Animation","AnimationIteration"),animationstart:Is("Animation","AnimationStart"),transitionrun:Is("Transition","TransitionRun"),transitionstart:Is("Transition","TransitionStart"),transitioncancel:Is("Transition","TransitionCancel"),transitionend:Is("Transition","TransitionEnd")},ac={},Of={};Ai&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete Mn.animationend.animation,delete Mn.animationiteration.animation,delete Mn.animationstart.animation),"TransitionEvent"in window||delete Mn.transitionend.transition);function xs(t){if(ac[t])return ac[t];if(!Mn[t])return t;var s=Mn[t],o;for(o in s)if(s.hasOwnProperty(o)&&o in Of)return ac[t]=s[o];return t}var Ff=xs("animationend"),Uf=xs("animationiteration"),Nf=xs("animationstart"),ov=xs("transitionrun"),rv=xs("transitionstart"),lv=xs("transitioncancel"),Hf=xs("transitionend"),Gf=new Map,oc="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");oc.push("scrollEnd");function ai(t,s){Gf.set(t,s),Rs(s,[t])}var Wf=new WeakMap;function Yt(t,s){if(typeof t=="object"&&t!==null){var o=Wf.get(t);return o!==void 0?o:(s={value:t,source:s,stack:nf(s)},Wf.set(t,s),s)}return{value:t,source:s,stack:nf(s)}}var qt=[],Tn=0,rc=0;function zo(){for(var t=Tn,s=rc=Tn=0;s<t;){var o=qt[s];qt[s++]=null;var l=qt[s];qt[s++]=null;var f=qt[s];qt[s++]=null;var p=qt[s];if(qt[s++]=null,l!==null&&f!==null){var b=l.pending;b===null?f.next=f:(f.next=b.next,b.next=f),l.pending=f}p!==0&&zf(o,f,p)}}function Vo(t,s,o,l){qt[Tn++]=t,qt[Tn++]=s,qt[Tn++]=o,qt[Tn++]=l,rc|=l,t.lanes|=l,t=t.alternate,t!==null&&(t.lanes|=l)}function lc(t,s,o,l){return Vo(t,s,o,l),Xo(t)}function Cn(t,s){return Vo(t,null,null,s),Xo(t)}function zf(t,s,o){t.lanes|=o;var l=t.alternate;l!==null&&(l.lanes|=o);for(var f=!1,p=t.return;p!==null;)p.childLanes|=o,l=p.alternate,l!==null&&(l.childLanes|=o),p.tag===22&&(t=p.stateNode,t===null||t._visibility&1||(f=!0)),t=p,p=p.return;return t.tag===3?(p=t.stateNode,f&&s!==null&&(f=31-Dt(o),t=p.hiddenUpdates,l=t[f],l===null?t[f]=[s]:l.push(s),s.lane=o|536870912),p):null}function Xo(t){if(50<$a)throw $a=0,gu=null,Error(n(185));for(var s=t.return;s!==null;)t=s,s=t.return;return t.tag===3?t.stateNode:null}var wn={};function cv(t,s,o,l){this.tag=t,this.key=o,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=s,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=l,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Lt(t,s,o,l){return new cv(t,s,o,l)}function cc(t){return t=t.prototype,!(!t||!t.isReactComponent)}function ki(t,s){var o=t.alternate;return o===null?(o=Lt(t.tag,s,t.key,t.mode),o.elementType=t.elementType,o.type=t.type,o.stateNode=t.stateNode,o.alternate=t,t.alternate=o):(o.pendingProps=s,o.type=t.type,o.flags=0,o.subtreeFlags=0,o.deletions=null),o.flags=t.flags&65011712,o.childLanes=t.childLanes,o.lanes=t.lanes,o.child=t.child,o.memoizedProps=t.memoizedProps,o.memoizedState=t.memoizedState,o.updateQueue=t.updateQueue,s=t.dependencies,o.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext},o.sibling=t.sibling,o.index=t.index,o.ref=t.ref,o.refCleanup=t.refCleanup,o}function Vf(t,s){t.flags&=65011714;var o=t.alternate;return o===null?(t.childLanes=0,t.lanes=s,t.child=null,t.subtreeFlags=0,t.memoizedProps=null,t.memoizedState=null,t.updateQueue=null,t.dependencies=null,t.stateNode=null):(t.childLanes=o.childLanes,t.lanes=o.lanes,t.child=o.child,t.subtreeFlags=0,t.deletions=null,t.memoizedProps=o.memoizedProps,t.memoizedState=o.memoizedState,t.updateQueue=o.updateQueue,t.type=o.type,s=o.dependencies,t.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext}),t}function Yo(t,s,o,l,f,p){var b=0;if(l=t,typeof t=="function")cc(t)&&(b=1);else if(typeof t=="string")b=hb(t,o,re.current)?26:t==="html"||t==="head"||t==="body"?27:5;else e:switch(t){case q:return t=Lt(31,o,s,f),t.elementType=q,t.lanes=p,t;case S:return _s(o.children,f,p,s);case T:b=8,f|=24;break;case w:return t=Lt(12,o,s,f|2),t.elementType=w,t.lanes=p,t;case P:return t=Lt(13,o,s,f),t.elementType=P,t.lanes=p,t;case N:return t=Lt(19,o,s,f),t.elementType=N,t.lanes=p,t;default:if(typeof t=="object"&&t!==null)switch(t.$$typeof){case A:case I:b=10;break e;case R:b=9;break e;case x:b=11;break e;case W:b=14;break e;case H:b=16,l=null;break e}b=29,o=Error(n(130,t===null?"null":typeof t,"")),l=null}return s=Lt(b,o,s,f),s.elementType=t,s.type=l,s.lanes=p,s}function _s(t,s,o,l){return t=Lt(7,t,l,s),t.lanes=o,t}function uc(t,s,o){return t=Lt(6,t,null,s),t.lanes=o,t}function hc(t,s,o){return s=Lt(4,t.children!==null?t.children:[],t.key,s),s.lanes=o,s.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},s}var An=[],kn=0,qo=null,jo=0,jt=[],Kt=0,Ds=null,Ei=1,Ri="";function Ps(t,s){An[kn++]=jo,An[kn++]=qo,qo=t,jo=s}function Xf(t,s,o){jt[Kt++]=Ei,jt[Kt++]=Ri,jt[Kt++]=Ds,Ds=t;var l=Ei;t=Ri;var f=32-Dt(l)-1;l&=~(1<<f),o+=1;var p=32-Dt(s)+f;if(30<p){var b=f-f%5;p=(l&(1<<b)-1).toString(32),l>>=b,f-=b,Ei=1<<32-Dt(s)+f|o<<f|l,Ri=p+t}else Ei=1<<p|o<<f|l,Ri=t}function fc(t){t.return!==null&&(Ps(t,1),Xf(t,1,0))}function dc(t){for(;t===qo;)qo=An[--kn],An[kn]=null,jo=An[--kn],An[kn]=null;for(;t===Ds;)Ds=jt[--Kt],jt[Kt]=null,Ri=jt[--Kt],jt[Kt]=null,Ei=jt[--Kt],jt[Kt]=null}var vt=null,We=null,Ee=!1,Ls=null,fi=!1,gc=Error(n(519));function Os(t){var s=Error(n(418,""));throw Ia(Yt(s,t)),gc}function Yf(t){var s=t.stateNode,o=t.type,l=t.memoizedProps;switch(s[ut]=t,s[Ct]=l,o){case"dialog":Te("cancel",s),Te("close",s);break;case"iframe":case"object":case"embed":Te("load",s);break;case"video":case"audio":for(o=0;o<eo.length;o++)Te(eo[o],s);break;case"source":Te("error",s);break;case"img":case"image":case"link":Te("error",s),Te("load",s);break;case"details":Te("toggle",s);break;case"input":Te("invalid",s),rf(s,l.value,l.defaultValue,l.checked,l.defaultChecked,l.type,l.name,!0),Po(s);break;case"select":Te("invalid",s);break;case"textarea":Te("invalid",s),cf(s,l.value,l.defaultValue,l.children),Po(s)}o=l.children,typeof o!="string"&&typeof o!="number"&&typeof o!="bigint"||s.textContent===""+o||l.suppressHydrationWarning===!0||cg(s.textContent,o)?(l.popover!=null&&(Te("beforetoggle",s),Te("toggle",s)),l.onScroll!=null&&Te("scroll",s),l.onScrollEnd!=null&&Te("scrollend",s),l.onClick!=null&&(s.onclick=Rr),s=!0):s=!1,s||Os(t)}function qf(t){for(vt=t.return;vt;)switch(vt.tag){case 5:case 13:fi=!1;return;case 27:case 3:fi=!0;return;default:vt=vt.return}}function Ra(t){if(t!==vt)return!1;if(!Ee)return qf(t),Ee=!0,!1;var s=t.tag,o;if((o=s!==3&&s!==27)&&((o=s===5)&&(o=t.type,o=!(o!=="form"&&o!=="button")||Iu(t.type,t.memoizedProps)),o=!o),o&&We&&Os(t),qf(t),s===13){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(n(317));e:{for(t=t.nextSibling,s=0;t;){if(t.nodeType===8)if(o=t.data,o==="/$"){if(s===0){We=ri(t.nextSibling);break e}s--}else o!=="$"&&o!=="$!"&&o!=="$?"||s++;t=t.nextSibling}We=null}}else s===27?(s=We,gs(t.type)?(t=Pu,Pu=null,We=t):We=s):We=vt?ri(t.stateNode.nextSibling):null;return!0}function Ba(){We=vt=null,Ee=!1}function jf(){var t=Ls;return t!==null&&(Et===null?Et=t:Et.push.apply(Et,t),Ls=null),t}function Ia(t){Ls===null?Ls=[t]:Ls.push(t)}var pc=G(null),Fs=null,Bi=null;function Ji(t,s,o){J(pc,s._currentValue),s._currentValue=o}function Ii(t){t._currentValue=pc.current,ee(pc)}function mc(t,s,o){for(;t!==null;){var l=t.alternate;if((t.childLanes&s)!==s?(t.childLanes|=s,l!==null&&(l.childLanes|=s)):l!==null&&(l.childLanes&s)!==s&&(l.childLanes|=s),t===o)break;t=t.return}}function yc(t,s,o,l){var f=t.child;for(f!==null&&(f.return=t);f!==null;){var p=f.dependencies;if(p!==null){var b=f.child;p=p.firstContext;e:for(;p!==null;){var C=p;p=f;for(var E=0;E<s.length;E++)if(C.context===s[E]){p.lanes|=o,C=p.alternate,C!==null&&(C.lanes|=o),mc(p.return,o,t),l||(b=null);break e}p=C.next}}else if(f.tag===18){if(b=f.return,b===null)throw Error(n(341));b.lanes|=o,p=b.alternate,p!==null&&(p.lanes|=o),mc(b,o,t),b=null}else b=f.child;if(b!==null)b.return=f;else for(b=f;b!==null;){if(b===t){b=null;break}if(f=b.sibling,f!==null){f.return=b.return,b=f;break}b=b.return}f=b}}function xa(t,s,o,l){t=null;for(var f=s,p=!1;f!==null;){if(!p){if((f.flags&524288)!==0)p=!0;else if((f.flags&262144)!==0)break}if(f.tag===10){var b=f.alternate;if(b===null)throw Error(n(387));if(b=b.memoizedProps,b!==null){var C=f.type;Pt(f.pendingProps.value,b.value)||(t!==null?t.push(C):t=[C])}}else if(f===ct.current){if(b=f.alternate,b===null)throw Error(n(387));b.memoizedState.memoizedState!==f.memoizedState.memoizedState&&(t!==null?t.push(oo):t=[oo])}f=f.return}t!==null&&yc(s,t,o,l),s.flags|=262144}function Ko(t){for(t=t.firstContext;t!==null;){if(!Pt(t.context._currentValue,t.memoizedValue))return!0;t=t.next}return!1}function Us(t){Fs=t,Bi=null,t=t.dependencies,t!==null&&(t.firstContext=null)}function ht(t){return Kf(Fs,t)}function Zo(t,s){return Fs===null&&Us(t),Kf(t,s)}function Kf(t,s){var o=s._currentValue;if(s={context:s,memoizedValue:o,next:null},Bi===null){if(t===null)throw Error(n(308));Bi=s,t.dependencies={lanes:0,firstContext:s},t.flags|=524288}else Bi=Bi.next=s;return o}var uv=typeof AbortController<"u"?AbortController:function(){var t=[],s=this.signal={aborted:!1,addEventListener:function(o,l){t.push(l)}};this.abort=function(){s.aborted=!0,t.forEach(function(o){return o()})}},hv=a.unstable_scheduleCallback,fv=a.unstable_NormalPriority,Ze={$$typeof:I,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function vc(){return{controller:new uv,data:new Map,refCount:0}}function _a(t){t.refCount--,t.refCount===0&&hv(fv,function(){t.controller.abort()})}var Da=null,bc=0,En=0,Rn=null;function dv(t,s){if(Da===null){var o=Da=[];bc=0,En=Mu(),Rn={status:"pending",value:void 0,then:function(l){o.push(l)}}}return bc++,s.then(Zf,Zf),s}function Zf(){if(--bc===0&&Da!==null){Rn!==null&&(Rn.status="fulfilled");var t=Da;Da=null,En=0,Rn=null;for(var s=0;s<t.length;s++)(0,t[s])()}}function gv(t,s){var o=[],l={status:"pending",value:null,reason:null,then:function(f){o.push(f)}};return t.then(function(){l.status="fulfilled",l.value=s;for(var f=0;f<o.length;f++)(0,o[f])(s)},function(f){for(l.status="rejected",l.reason=f,f=0;f<o.length;f++)(0,o[f])(void 0)}),l}var Qf=_.S;_.S=function(t,s){typeof s=="object"&&s!==null&&typeof s.then=="function"&&dv(t,s),Qf!==null&&Qf(t,s)};var Ns=G(null);function Sc(){var t=Ns.current;return t!==null?t:Ue.pooledCache}function Qo(t,s){s===null?J(Ns,Ns.current):J(Ns,s.pool)}function $f(){var t=Sc();return t===null?null:{parent:Ze._currentValue,pool:t}}var Pa=Error(n(460)),Jf=Error(n(474)),$o=Error(n(542)),Mc={then:function(){}};function ed(t){return t=t.status,t==="fulfilled"||t==="rejected"}function Jo(){}function td(t,s,o){switch(o=t[o],o===void 0?t.push(s):o!==s&&(s.then(Jo,Jo),s=o),s.status){case"fulfilled":return s.value;case"rejected":throw t=s.reason,sd(t),t;default:if(typeof s.status=="string")s.then(Jo,Jo);else{if(t=Ue,t!==null&&100<t.shellSuspendCounter)throw Error(n(482));t=s,t.status="pending",t.then(function(l){if(s.status==="pending"){var f=s;f.status="fulfilled",f.value=l}},function(l){if(s.status==="pending"){var f=s;f.status="rejected",f.reason=l}})}switch(s.status){case"fulfilled":return s.value;case"rejected":throw t=s.reason,sd(t),t}throw La=s,Pa}}var La=null;function id(){if(La===null)throw Error(n(459));var t=La;return La=null,t}function sd(t){if(t===Pa||t===$o)throw Error(n(483))}var es=!1;function Tc(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function Cc(t,s){t=t.updateQueue,s.updateQueue===t&&(s.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,callbacks:null})}function ts(t){return{lane:t,tag:0,payload:null,callback:null,next:null}}function is(t,s,o){var l=t.updateQueue;if(l===null)return null;if(l=l.shared,(Ie&2)!==0){var f=l.pending;return f===null?s.next=s:(s.next=f.next,f.next=s),l.pending=s,s=Xo(t),zf(t,null,o),s}return Vo(t,l,s,o),Xo(t)}function Oa(t,s,o){if(s=s.updateQueue,s!==null&&(s=s.shared,(o&4194048)!==0)){var l=s.lanes;l&=t.pendingLanes,o|=l,s.lanes=o,Kh(t,o)}}function wc(t,s){var o=t.updateQueue,l=t.alternate;if(l!==null&&(l=l.updateQueue,o===l)){var f=null,p=null;if(o=o.firstBaseUpdate,o!==null){do{var b={lane:o.lane,tag:o.tag,payload:o.payload,callback:null,next:null};p===null?f=p=b:p=p.next=b,o=o.next}while(o!==null);p===null?f=p=s:p=p.next=s}else f=p=s;o={baseState:l.baseState,firstBaseUpdate:f,lastBaseUpdate:p,shared:l.shared,callbacks:l.callbacks},t.updateQueue=o;return}t=o.lastBaseUpdate,t===null?o.firstBaseUpdate=s:t.next=s,o.lastBaseUpdate=s}var Ac=!1;function Fa(){if(Ac){var t=Rn;if(t!==null)throw t}}function Ua(t,s,o,l){Ac=!1;var f=t.updateQueue;es=!1;var p=f.firstBaseUpdate,b=f.lastBaseUpdate,C=f.shared.pending;if(C!==null){f.shared.pending=null;var E=C,O=E.next;E.next=null,b===null?p=O:b.next=O,b=E;var V=t.alternate;V!==null&&(V=V.updateQueue,C=V.lastBaseUpdate,C!==b&&(C===null?V.firstBaseUpdate=O:C.next=O,V.lastBaseUpdate=E))}if(p!==null){var j=f.baseState;b=0,V=O=E=null,C=p;do{var F=C.lane&-536870913,U=F!==C.lane;if(U?(we&F)===F:(l&F)===F){F!==0&&F===En&&(Ac=!0),V!==null&&(V=V.next={lane:0,tag:C.tag,payload:C.payload,callback:null,next:null});e:{var ge=t,fe=C;F=s;var Le=o;switch(fe.tag){case 1:if(ge=fe.payload,typeof ge=="function"){j=ge.call(Le,j,F);break e}j=ge;break e;case 3:ge.flags=ge.flags&-65537|128;case 0:if(ge=fe.payload,F=typeof ge=="function"?ge.call(Le,j,F):ge,F==null)break e;j=m({},j,F);break e;case 2:es=!0}}F=C.callback,F!==null&&(t.flags|=64,U&&(t.flags|=8192),U=f.callbacks,U===null?f.callbacks=[F]:U.push(F))}else U={lane:F,tag:C.tag,payload:C.payload,callback:C.callback,next:null},V===null?(O=V=U,E=j):V=V.next=U,b|=F;if(C=C.next,C===null){if(C=f.shared.pending,C===null)break;U=C,C=U.next,U.next=null,f.lastBaseUpdate=U,f.shared.pending=null}}while(!0);V===null&&(E=j),f.baseState=E,f.firstBaseUpdate=O,f.lastBaseUpdate=V,p===null&&(f.shared.lanes=0),us|=b,t.lanes=b,t.memoizedState=j}}function nd(t,s){if(typeof t!="function")throw Error(n(191,t));t.call(s)}function ad(t,s){var o=t.callbacks;if(o!==null)for(t.callbacks=null,t=0;t<o.length;t++)nd(o[t],s)}var Bn=G(null),er=G(0);function od(t,s){t=Fi,J(er,t),J(Bn,s),Fi=t|s.baseLanes}function kc(){J(er,Fi),J(Bn,Bn.current)}function Ec(){Fi=er.current,ee(Bn),ee(er)}var ss=0,be=null,De=null,je=null,tr=!1,In=!1,Hs=!1,ir=0,Na=0,xn=null,pv=0;function Xe(){throw Error(n(321))}function Rc(t,s){if(s===null)return!1;for(var o=0;o<s.length&&o<t.length;o++)if(!Pt(t[o],s[o]))return!1;return!0}function Bc(t,s,o,l,f,p){return ss=p,be=s,s.memoizedState=null,s.updateQueue=null,s.lanes=0,_.H=t===null||t.memoizedState===null?zd:Vd,Hs=!1,p=o(l,f),Hs=!1,In&&(p=ld(s,o,l,f)),rd(t),p}function rd(t){_.H=lr;var s=De!==null&&De.next!==null;if(ss=0,je=De=be=null,tr=!1,Na=0,xn=null,s)throw Error(n(300));t===null||et||(t=t.dependencies,t!==null&&Ko(t)&&(et=!0))}function ld(t,s,o,l){be=t;var f=0;do{if(In&&(xn=null),Na=0,In=!1,25<=f)throw Error(n(301));if(f+=1,je=De=null,t.updateQueue!=null){var p=t.updateQueue;p.lastEffect=null,p.events=null,p.stores=null,p.memoCache!=null&&(p.memoCache.index=0)}_.H=Tv,p=s(o,l)}while(In);return p}function mv(){var t=_.H,s=t.useState()[0];return s=typeof s.then=="function"?Ha(s):s,t=t.useState()[0],(De!==null?De.memoizedState:null)!==t&&(be.flags|=1024),s}function Ic(){var t=ir!==0;return ir=0,t}function xc(t,s,o){s.updateQueue=t.updateQueue,s.flags&=-2053,t.lanes&=~o}function _c(t){if(tr){for(t=t.memoizedState;t!==null;){var s=t.queue;s!==null&&(s.pending=null),t=t.next}tr=!1}ss=0,je=De=be=null,In=!1,Na=ir=0,xn=null}function At(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return je===null?be.memoizedState=je=t:je=je.next=t,je}function Ke(){if(De===null){var t=be.alternate;t=t!==null?t.memoizedState:null}else t=De.next;var s=je===null?be.memoizedState:je.next;if(s!==null)je=s,De=t;else{if(t===null)throw be.alternate===null?Error(n(467)):Error(n(310));De=t,t={memoizedState:De.memoizedState,baseState:De.baseState,baseQueue:De.baseQueue,queue:De.queue,next:null},je===null?be.memoizedState=je=t:je=je.next=t}return je}function Dc(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Ha(t){var s=Na;return Na+=1,xn===null&&(xn=[]),t=td(xn,t,s),s=be,(je===null?s.memoizedState:je.next)===null&&(s=s.alternate,_.H=s===null||s.memoizedState===null?zd:Vd),t}function sr(t){if(t!==null&&typeof t=="object"){if(typeof t.then=="function")return Ha(t);if(t.$$typeof===I)return ht(t)}throw Error(n(438,String(t)))}function Pc(t){var s=null,o=be.updateQueue;if(o!==null&&(s=o.memoCache),s==null){var l=be.alternate;l!==null&&(l=l.updateQueue,l!==null&&(l=l.memoCache,l!=null&&(s={data:l.data.map(function(f){return f.slice()}),index:0})))}if(s==null&&(s={data:[],index:0}),o===null&&(o=Dc(),be.updateQueue=o),o.memoCache=s,o=s.data[s.index],o===void 0)for(o=s.data[s.index]=Array(t),l=0;l<t;l++)o[l]=ie;return s.index++,o}function xi(t,s){return typeof s=="function"?s(t):s}function nr(t){var s=Ke();return Lc(s,De,t)}function Lc(t,s,o){var l=t.queue;if(l===null)throw Error(n(311));l.lastRenderedReducer=o;var f=t.baseQueue,p=l.pending;if(p!==null){if(f!==null){var b=f.next;f.next=p.next,p.next=b}s.baseQueue=f=p,l.pending=null}if(p=t.baseState,f===null)t.memoizedState=p;else{s=f.next;var C=b=null,E=null,O=s,V=!1;do{var j=O.lane&-536870913;if(j!==O.lane?(we&j)===j:(ss&j)===j){var F=O.revertLane;if(F===0)E!==null&&(E=E.next={lane:0,revertLane:0,action:O.action,hasEagerState:O.hasEagerState,eagerState:O.eagerState,next:null}),j===En&&(V=!0);else if((ss&F)===F){O=O.next,F===En&&(V=!0);continue}else j={lane:0,revertLane:O.revertLane,action:O.action,hasEagerState:O.hasEagerState,eagerState:O.eagerState,next:null},E===null?(C=E=j,b=p):E=E.next=j,be.lanes|=F,us|=F;j=O.action,Hs&&o(p,j),p=O.hasEagerState?O.eagerState:o(p,j)}else F={lane:j,revertLane:O.revertLane,action:O.action,hasEagerState:O.hasEagerState,eagerState:O.eagerState,next:null},E===null?(C=E=F,b=p):E=E.next=F,be.lanes|=j,us|=j;O=O.next}while(O!==null&&O!==s);if(E===null?b=p:E.next=C,!Pt(p,t.memoizedState)&&(et=!0,V&&(o=Rn,o!==null)))throw o;t.memoizedState=p,t.baseState=b,t.baseQueue=E,l.lastRenderedState=p}return f===null&&(l.lanes=0),[t.memoizedState,l.dispatch]}function Oc(t){var s=Ke(),o=s.queue;if(o===null)throw Error(n(311));o.lastRenderedReducer=t;var l=o.dispatch,f=o.pending,p=s.memoizedState;if(f!==null){o.pending=null;var b=f=f.next;do p=t(p,b.action),b=b.next;while(b!==f);Pt(p,s.memoizedState)||(et=!0),s.memoizedState=p,s.baseQueue===null&&(s.baseState=p),o.lastRenderedState=p}return[p,l]}function cd(t,s,o){var l=be,f=Ke(),p=Ee;if(p){if(o===void 0)throw Error(n(407));o=o()}else o=s();var b=!Pt((De||f).memoizedState,o);b&&(f.memoizedState=o,et=!0),f=f.queue;var C=fd.bind(null,l,f,t);if(Ga(2048,8,C,[t]),f.getSnapshot!==s||b||je!==null&&je.memoizedState.tag&1){if(l.flags|=2048,_n(9,ar(),hd.bind(null,l,f,o,s),null),Ue===null)throw Error(n(349));p||(ss&124)!==0||ud(l,s,o)}return o}function ud(t,s,o){t.flags|=16384,t={getSnapshot:s,value:o},s=be.updateQueue,s===null?(s=Dc(),be.updateQueue=s,s.stores=[t]):(o=s.stores,o===null?s.stores=[t]:o.push(t))}function hd(t,s,o,l){s.value=o,s.getSnapshot=l,dd(s)&&gd(t)}function fd(t,s,o){return o(function(){dd(s)&&gd(t)})}function dd(t){var s=t.getSnapshot;t=t.value;try{var o=s();return!Pt(t,o)}catch{return!0}}function gd(t){var s=Cn(t,2);s!==null&&Ht(s,t,2)}function Fc(t){var s=At();if(typeof t=="function"){var o=t;if(t=o(),Hs){Zi(!0);try{o()}finally{Zi(!1)}}}return s.memoizedState=s.baseState=t,s.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:xi,lastRenderedState:t},s}function pd(t,s,o,l){return t.baseState=o,Lc(t,De,typeof l=="function"?l:xi)}function yv(t,s,o,l,f){if(rr(t))throw Error(n(485));if(t=s.action,t!==null){var p={payload:f,action:t,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(b){p.listeners.push(b)}};_.T!==null?o(!0):p.isTransition=!1,l(p),o=s.pending,o===null?(p.next=s.pending=p,md(s,p)):(p.next=o.next,s.pending=o.next=p)}}function md(t,s){var o=s.action,l=s.payload,f=t.state;if(s.isTransition){var p=_.T,b={};_.T=b;try{var C=o(f,l),E=_.S;E!==null&&E(b,C),yd(t,s,C)}catch(O){Uc(t,s,O)}finally{_.T=p}}else try{p=o(f,l),yd(t,s,p)}catch(O){Uc(t,s,O)}}function yd(t,s,o){o!==null&&typeof o=="object"&&typeof o.then=="function"?o.then(function(l){vd(t,s,l)},function(l){return Uc(t,s,l)}):vd(t,s,o)}function vd(t,s,o){s.status="fulfilled",s.value=o,bd(s),t.state=o,s=t.pending,s!==null&&(o=s.next,o===s?t.pending=null:(o=o.next,s.next=o,md(t,o)))}function Uc(t,s,o){var l=t.pending;if(t.pending=null,l!==null){l=l.next;do s.status="rejected",s.reason=o,bd(s),s=s.next;while(s!==l)}t.action=null}function bd(t){t=t.listeners;for(var s=0;s<t.length;s++)(0,t[s])()}function Sd(t,s){return s}function Md(t,s){if(Ee){var o=Ue.formState;if(o!==null){e:{var l=be;if(Ee){if(We){t:{for(var f=We,p=fi;f.nodeType!==8;){if(!p){f=null;break t}if(f=ri(f.nextSibling),f===null){f=null;break t}}p=f.data,f=p==="F!"||p==="F"?f:null}if(f){We=ri(f.nextSibling),l=f.data==="F!";break e}}Os(l)}l=!1}l&&(s=o[0])}}return o=At(),o.memoizedState=o.baseState=s,l={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Sd,lastRenderedState:s},o.queue=l,o=Hd.bind(null,be,l),l.dispatch=o,l=Fc(!1),p=zc.bind(null,be,!1,l.queue),l=At(),f={state:s,dispatch:null,action:t,pending:null},l.queue=f,o=yv.bind(null,be,f,p,o),f.dispatch=o,l.memoizedState=t,[s,o,!1]}function Td(t){var s=Ke();return Cd(s,De,t)}function Cd(t,s,o){if(s=Lc(t,s,Sd)[0],t=nr(xi)[0],typeof s=="object"&&s!==null&&typeof s.then=="function")try{var l=Ha(s)}catch(b){throw b===Pa?$o:b}else l=s;s=Ke();var f=s.queue,p=f.dispatch;return o!==s.memoizedState&&(be.flags|=2048,_n(9,ar(),vv.bind(null,f,o),null)),[l,p,t]}function vv(t,s){t.action=s}function wd(t){var s=Ke(),o=De;if(o!==null)return Cd(s,o,t);Ke(),s=s.memoizedState,o=Ke();var l=o.queue.dispatch;return o.memoizedState=t,[s,l,!1]}function _n(t,s,o,l){return t={tag:t,create:o,deps:l,inst:s,next:null},s=be.updateQueue,s===null&&(s=Dc(),be.updateQueue=s),o=s.lastEffect,o===null?s.lastEffect=t.next=t:(l=o.next,o.next=t,t.next=l,s.lastEffect=t),t}function ar(){return{destroy:void 0,resource:void 0}}function Ad(){return Ke().memoizedState}function or(t,s,o,l){var f=At();l=l===void 0?null:l,be.flags|=t,f.memoizedState=_n(1|s,ar(),o,l)}function Ga(t,s,o,l){var f=Ke();l=l===void 0?null:l;var p=f.memoizedState.inst;De!==null&&l!==null&&Rc(l,De.memoizedState.deps)?f.memoizedState=_n(s,p,o,l):(be.flags|=t,f.memoizedState=_n(1|s,p,o,l))}function kd(t,s){or(8390656,8,t,s)}function Ed(t,s){Ga(2048,8,t,s)}function Rd(t,s){return Ga(4,2,t,s)}function Bd(t,s){return Ga(4,4,t,s)}function Id(t,s){if(typeof s=="function"){t=t();var o=s(t);return function(){typeof o=="function"?o():s(null)}}if(s!=null)return t=t(),s.current=t,function(){s.current=null}}function xd(t,s,o){o=o!=null?o.concat([t]):null,Ga(4,4,Id.bind(null,s,t),o)}function Nc(){}function _d(t,s){var o=Ke();s=s===void 0?null:s;var l=o.memoizedState;return s!==null&&Rc(s,l[1])?l[0]:(o.memoizedState=[t,s],t)}function Dd(t,s){var o=Ke();s=s===void 0?null:s;var l=o.memoizedState;if(s!==null&&Rc(s,l[1]))return l[0];if(l=t(),Hs){Zi(!0);try{t()}finally{Zi(!1)}}return o.memoizedState=[l,s],l}function Hc(t,s,o){return o===void 0||(ss&1073741824)!==0?t.memoizedState=s:(t.memoizedState=o,t=O0(),be.lanes|=t,us|=t,o)}function Pd(t,s,o,l){return Pt(o,s)?o:Bn.current!==null?(t=Hc(t,o,l),Pt(t,s)||(et=!0),t):(ss&42)===0?(et=!0,t.memoizedState=o):(t=O0(),be.lanes|=t,us|=t,s)}function Ld(t,s,o,l,f){var p=X.p;X.p=p!==0&&8>p?p:8;var b=_.T,C={};_.T=C,zc(t,!1,s,o);try{var E=f(),O=_.S;if(O!==null&&O(C,E),E!==null&&typeof E=="object"&&typeof E.then=="function"){var V=gv(E,l);Wa(t,s,V,Nt(t))}else Wa(t,s,l,Nt(t))}catch(j){Wa(t,s,{then:function(){},status:"rejected",reason:j},Nt())}finally{X.p=p,_.T=b}}function bv(){}function Gc(t,s,o,l){if(t.tag!==5)throw Error(n(476));var f=Od(t).queue;Ld(t,f,s,se,o===null?bv:function(){return Fd(t),o(l)})}function Od(t){var s=t.memoizedState;if(s!==null)return s;s={memoizedState:se,baseState:se,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:xi,lastRenderedState:se},next:null};var o={};return s.next={memoizedState:o,baseState:o,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:xi,lastRenderedState:o},next:null},t.memoizedState=s,t=t.alternate,t!==null&&(t.memoizedState=s),s}function Fd(t){var s=Od(t).next.queue;Wa(t,s,{},Nt())}function Wc(){return ht(oo)}function Ud(){return Ke().memoizedState}function Nd(){return Ke().memoizedState}function Sv(t){for(var s=t.return;s!==null;){switch(s.tag){case 24:case 3:var o=Nt();t=ts(o);var l=is(s,t,o);l!==null&&(Ht(l,s,o),Oa(l,s,o)),s={cache:vc()},t.payload=s;return}s=s.return}}function Mv(t,s,o){var l=Nt();o={lane:l,revertLane:0,action:o,hasEagerState:!1,eagerState:null,next:null},rr(t)?Gd(s,o):(o=lc(t,s,o,l),o!==null&&(Ht(o,t,l),Wd(o,s,l)))}function Hd(t,s,o){var l=Nt();Wa(t,s,o,l)}function Wa(t,s,o,l){var f={lane:l,revertLane:0,action:o,hasEagerState:!1,eagerState:null,next:null};if(rr(t))Gd(s,f);else{var p=t.alternate;if(t.lanes===0&&(p===null||p.lanes===0)&&(p=s.lastRenderedReducer,p!==null))try{var b=s.lastRenderedState,C=p(b,o);if(f.hasEagerState=!0,f.eagerState=C,Pt(C,b))return Vo(t,s,f,0),Ue===null&&zo(),!1}catch{}finally{}if(o=lc(t,s,f,l),o!==null)return Ht(o,t,l),Wd(o,s,l),!0}return!1}function zc(t,s,o,l){if(l={lane:2,revertLane:Mu(),action:l,hasEagerState:!1,eagerState:null,next:null},rr(t)){if(s)throw Error(n(479))}else s=lc(t,o,l,2),s!==null&&Ht(s,t,2)}function rr(t){var s=t.alternate;return t===be||s!==null&&s===be}function Gd(t,s){In=tr=!0;var o=t.pending;o===null?s.next=s:(s.next=o.next,o.next=s),t.pending=s}function Wd(t,s,o){if((o&4194048)!==0){var l=s.lanes;l&=t.pendingLanes,o|=l,s.lanes=o,Kh(t,o)}}var lr={readContext:ht,use:sr,useCallback:Xe,useContext:Xe,useEffect:Xe,useImperativeHandle:Xe,useLayoutEffect:Xe,useInsertionEffect:Xe,useMemo:Xe,useReducer:Xe,useRef:Xe,useState:Xe,useDebugValue:Xe,useDeferredValue:Xe,useTransition:Xe,useSyncExternalStore:Xe,useId:Xe,useHostTransitionStatus:Xe,useFormState:Xe,useActionState:Xe,useOptimistic:Xe,useMemoCache:Xe,useCacheRefresh:Xe},zd={readContext:ht,use:sr,useCallback:function(t,s){return At().memoizedState=[t,s===void 0?null:s],t},useContext:ht,useEffect:kd,useImperativeHandle:function(t,s,o){o=o!=null?o.concat([t]):null,or(4194308,4,Id.bind(null,s,t),o)},useLayoutEffect:function(t,s){return or(4194308,4,t,s)},useInsertionEffect:function(t,s){or(4,2,t,s)},useMemo:function(t,s){var o=At();s=s===void 0?null:s;var l=t();if(Hs){Zi(!0);try{t()}finally{Zi(!1)}}return o.memoizedState=[l,s],l},useReducer:function(t,s,o){var l=At();if(o!==void 0){var f=o(s);if(Hs){Zi(!0);try{o(s)}finally{Zi(!1)}}}else f=s;return l.memoizedState=l.baseState=f,t={pending:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:f},l.queue=t,t=t.dispatch=Mv.bind(null,be,t),[l.memoizedState,t]},useRef:function(t){var s=At();return t={current:t},s.memoizedState=t},useState:function(t){t=Fc(t);var s=t.queue,o=Hd.bind(null,be,s);return s.dispatch=o,[t.memoizedState,o]},useDebugValue:Nc,useDeferredValue:function(t,s){var o=At();return Hc(o,t,s)},useTransition:function(){var t=Fc(!1);return t=Ld.bind(null,be,t.queue,!0,!1),At().memoizedState=t,[!1,t]},useSyncExternalStore:function(t,s,o){var l=be,f=At();if(Ee){if(o===void 0)throw Error(n(407));o=o()}else{if(o=s(),Ue===null)throw Error(n(349));(we&124)!==0||ud(l,s,o)}f.memoizedState=o;var p={value:o,getSnapshot:s};return f.queue=p,kd(fd.bind(null,l,p,t),[t]),l.flags|=2048,_n(9,ar(),hd.bind(null,l,p,o,s),null),o},useId:function(){var t=At(),s=Ue.identifierPrefix;if(Ee){var o=Ri,l=Ei;o=(l&~(1<<32-Dt(l)-1)).toString(32)+o,s=""+s+"R"+o,o=ir++,0<o&&(s+="H"+o.toString(32)),s+=""}else o=pv++,s=""+s+"r"+o.toString(32)+"";return t.memoizedState=s},useHostTransitionStatus:Wc,useFormState:Md,useActionState:Md,useOptimistic:function(t){var s=At();s.memoizedState=s.baseState=t;var o={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return s.queue=o,s=zc.bind(null,be,!0,o),o.dispatch=s,[t,s]},useMemoCache:Pc,useCacheRefresh:function(){return At().memoizedState=Sv.bind(null,be)}},Vd={readContext:ht,use:sr,useCallback:_d,useContext:ht,useEffect:Ed,useImperativeHandle:xd,useInsertionEffect:Rd,useLayoutEffect:Bd,useMemo:Dd,useReducer:nr,useRef:Ad,useState:function(){return nr(xi)},useDebugValue:Nc,useDeferredValue:function(t,s){var o=Ke();return Pd(o,De.memoizedState,t,s)},useTransition:function(){var t=nr(xi)[0],s=Ke().memoizedState;return[typeof t=="boolean"?t:Ha(t),s]},useSyncExternalStore:cd,useId:Ud,useHostTransitionStatus:Wc,useFormState:Td,useActionState:Td,useOptimistic:function(t,s){var o=Ke();return pd(o,De,t,s)},useMemoCache:Pc,useCacheRefresh:Nd},Tv={readContext:ht,use:sr,useCallback:_d,useContext:ht,useEffect:Ed,useImperativeHandle:xd,useInsertionEffect:Rd,useLayoutEffect:Bd,useMemo:Dd,useReducer:Oc,useRef:Ad,useState:function(){return Oc(xi)},useDebugValue:Nc,useDeferredValue:function(t,s){var o=Ke();return De===null?Hc(o,t,s):Pd(o,De.memoizedState,t,s)},useTransition:function(){var t=Oc(xi)[0],s=Ke().memoizedState;return[typeof t=="boolean"?t:Ha(t),s]},useSyncExternalStore:cd,useId:Ud,useHostTransitionStatus:Wc,useFormState:wd,useActionState:wd,useOptimistic:function(t,s){var o=Ke();return De!==null?pd(o,De,t,s):(o.baseState=t,[t,o.queue.dispatch])},useMemoCache:Pc,useCacheRefresh:Nd},Dn=null,za=0;function cr(t){var s=za;return za+=1,Dn===null&&(Dn=[]),td(Dn,t,s)}function Va(t,s){s=s.props.ref,t.ref=s!==void 0?s:null}function ur(t,s){throw s.$$typeof===y?Error(n(525)):(t=Object.prototype.toString.call(s),Error(n(31,t==="[object Object]"?"object with keys {"+Object.keys(s).join(", ")+"}":t)))}function Xd(t){var s=t._init;return s(t._payload)}function Yd(t){function s(D,B){if(t){var L=D.deletions;L===null?(D.deletions=[B],D.flags|=16):L.push(B)}}function o(D,B){if(!t)return null;for(;B!==null;)s(D,B),B=B.sibling;return null}function l(D){for(var B=new Map;D!==null;)D.key!==null?B.set(D.key,D):B.set(D.index,D),D=D.sibling;return B}function f(D,B){return D=ki(D,B),D.index=0,D.sibling=null,D}function p(D,B,L){return D.index=L,t?(L=D.alternate,L!==null?(L=L.index,L<B?(D.flags|=67108866,B):L):(D.flags|=67108866,B)):(D.flags|=1048576,B)}function b(D){return t&&D.alternate===null&&(D.flags|=67108866),D}function C(D,B,L,Y){return B===null||B.tag!==6?(B=uc(L,D.mode,Y),B.return=D,B):(B=f(B,L),B.return=D,B)}function E(D,B,L,Y){var le=L.type;return le===S?V(D,B,L.props.children,Y,L.key):B!==null&&(B.elementType===le||typeof le=="object"&&le!==null&&le.$$typeof===H&&Xd(le)===B.type)?(B=f(B,L.props),Va(B,L),B.return=D,B):(B=Yo(L.type,L.key,L.props,null,D.mode,Y),Va(B,L),B.return=D,B)}function O(D,B,L,Y){return B===null||B.tag!==4||B.stateNode.containerInfo!==L.containerInfo||B.stateNode.implementation!==L.implementation?(B=hc(L,D.mode,Y),B.return=D,B):(B=f(B,L.children||[]),B.return=D,B)}function V(D,B,L,Y,le){return B===null||B.tag!==7?(B=_s(L,D.mode,Y,le),B.return=D,B):(B=f(B,L),B.return=D,B)}function j(D,B,L){if(typeof B=="string"&&B!==""||typeof B=="number"||typeof B=="bigint")return B=uc(""+B,D.mode,L),B.return=D,B;if(typeof B=="object"&&B!==null){switch(B.$$typeof){case v:return L=Yo(B.type,B.key,B.props,null,D.mode,L),Va(L,B),L.return=D,L;case M:return B=hc(B,D.mode,L),B.return=D,B;case H:var Y=B._init;return B=Y(B._payload),j(D,B,L)}if(te(B)||K(B))return B=_s(B,D.mode,L,null),B.return=D,B;if(typeof B.then=="function")return j(D,cr(B),L);if(B.$$typeof===I)return j(D,Zo(D,B),L);ur(D,B)}return null}function F(D,B,L,Y){var le=B!==null?B.key:null;if(typeof L=="string"&&L!==""||typeof L=="number"||typeof L=="bigint")return le!==null?null:C(D,B,""+L,Y);if(typeof L=="object"&&L!==null){switch(L.$$typeof){case v:return L.key===le?E(D,B,L,Y):null;case M:return L.key===le?O(D,B,L,Y):null;case H:return le=L._init,L=le(L._payload),F(D,B,L,Y)}if(te(L)||K(L))return le!==null?null:V(D,B,L,Y,null);if(typeof L.then=="function")return F(D,B,cr(L),Y);if(L.$$typeof===I)return F(D,B,Zo(D,L),Y);ur(D,L)}return null}function U(D,B,L,Y,le){if(typeof Y=="string"&&Y!==""||typeof Y=="number"||typeof Y=="bigint")return D=D.get(L)||null,C(B,D,""+Y,le);if(typeof Y=="object"&&Y!==null){switch(Y.$$typeof){case v:return D=D.get(Y.key===null?L:Y.key)||null,E(B,D,Y,le);case M:return D=D.get(Y.key===null?L:Y.key)||null,O(B,D,Y,le);case H:var Se=Y._init;return Y=Se(Y._payload),U(D,B,L,Y,le)}if(te(Y)||K(Y))return D=D.get(L)||null,V(B,D,Y,le,null);if(typeof Y.then=="function")return U(D,B,L,cr(Y),le);if(Y.$$typeof===I)return U(D,B,L,Zo(B,Y),le);ur(B,Y)}return null}function ge(D,B,L,Y){for(var le=null,Se=null,ce=B,de=B=0,it=null;ce!==null&&de<L.length;de++){ce.index>de?(it=ce,ce=null):it=ce.sibling;var ke=F(D,ce,L[de],Y);if(ke===null){ce===null&&(ce=it);break}t&&ce&&ke.alternate===null&&s(D,ce),B=p(ke,B,de),Se===null?le=ke:Se.sibling=ke,Se=ke,ce=it}if(de===L.length)return o(D,ce),Ee&&Ps(D,de),le;if(ce===null){for(;de<L.length;de++)ce=j(D,L[de],Y),ce!==null&&(B=p(ce,B,de),Se===null?le=ce:Se.sibling=ce,Se=ce);return Ee&&Ps(D,de),le}for(ce=l(ce);de<L.length;de++)it=U(ce,D,de,L[de],Y),it!==null&&(t&&it.alternate!==null&&ce.delete(it.key===null?de:it.key),B=p(it,B,de),Se===null?le=it:Se.sibling=it,Se=it);return t&&ce.forEach(function(bs){return s(D,bs)}),Ee&&Ps(D,de),le}function fe(D,B,L,Y){if(L==null)throw Error(n(151));for(var le=null,Se=null,ce=B,de=B=0,it=null,ke=L.next();ce!==null&&!ke.done;de++,ke=L.next()){ce.index>de?(it=ce,ce=null):it=ce.sibling;var bs=F(D,ce,ke.value,Y);if(bs===null){ce===null&&(ce=it);break}t&&ce&&bs.alternate===null&&s(D,ce),B=p(bs,B,de),Se===null?le=bs:Se.sibling=bs,Se=bs,ce=it}if(ke.done)return o(D,ce),Ee&&Ps(D,de),le;if(ce===null){for(;!ke.done;de++,ke=L.next())ke=j(D,ke.value,Y),ke!==null&&(B=p(ke,B,de),Se===null?le=ke:Se.sibling=ke,Se=ke);return Ee&&Ps(D,de),le}for(ce=l(ce);!ke.done;de++,ke=L.next())ke=U(ce,D,de,ke.value,Y),ke!==null&&(t&&ke.alternate!==null&&ce.delete(ke.key===null?de:ke.key),B=p(ke,B,de),Se===null?le=ke:Se.sibling=ke,Se=ke);return t&&ce.forEach(function(Cb){return s(D,Cb)}),Ee&&Ps(D,de),le}function Le(D,B,L,Y){if(typeof L=="object"&&L!==null&&L.type===S&&L.key===null&&(L=L.props.children),typeof L=="object"&&L!==null){switch(L.$$typeof){case v:e:{for(var le=L.key;B!==null;){if(B.key===le){if(le=L.type,le===S){if(B.tag===7){o(D,B.sibling),Y=f(B,L.props.children),Y.return=D,D=Y;break e}}else if(B.elementType===le||typeof le=="object"&&le!==null&&le.$$typeof===H&&Xd(le)===B.type){o(D,B.sibling),Y=f(B,L.props),Va(Y,L),Y.return=D,D=Y;break e}o(D,B);break}else s(D,B);B=B.sibling}L.type===S?(Y=_s(L.props.children,D.mode,Y,L.key),Y.return=D,D=Y):(Y=Yo(L.type,L.key,L.props,null,D.mode,Y),Va(Y,L),Y.return=D,D=Y)}return b(D);case M:e:{for(le=L.key;B!==null;){if(B.key===le)if(B.tag===4&&B.stateNode.containerInfo===L.containerInfo&&B.stateNode.implementation===L.implementation){o(D,B.sibling),Y=f(B,L.children||[]),Y.return=D,D=Y;break e}else{o(D,B);break}else s(D,B);B=B.sibling}Y=hc(L,D.mode,Y),Y.return=D,D=Y}return b(D);case H:return le=L._init,L=le(L._payload),Le(D,B,L,Y)}if(te(L))return ge(D,B,L,Y);if(K(L)){if(le=K(L),typeof le!="function")throw Error(n(150));return L=le.call(L),fe(D,B,L,Y)}if(typeof L.then=="function")return Le(D,B,cr(L),Y);if(L.$$typeof===I)return Le(D,B,Zo(D,L),Y);ur(D,L)}return typeof L=="string"&&L!==""||typeof L=="number"||typeof L=="bigint"?(L=""+L,B!==null&&B.tag===6?(o(D,B.sibling),Y=f(B,L),Y.return=D,D=Y):(o(D,B),Y=uc(L,D.mode,Y),Y.return=D,D=Y),b(D)):o(D,B)}return function(D,B,L,Y){try{za=0;var le=Le(D,B,L,Y);return Dn=null,le}catch(ce){if(ce===Pa||ce===$o)throw ce;var Se=Lt(29,ce,null,D.mode);return Se.lanes=Y,Se.return=D,Se}finally{}}}var Pn=Yd(!0),qd=Yd(!1),Zt=G(null),di=null;function ns(t){var s=t.alternate;J(Qe,Qe.current&1),J(Zt,t),di===null&&(s===null||Bn.current!==null||s.memoizedState!==null)&&(di=t)}function jd(t){if(t.tag===22){if(J(Qe,Qe.current),J(Zt,t),di===null){var s=t.alternate;s!==null&&s.memoizedState!==null&&(di=t)}}else as()}function as(){J(Qe,Qe.current),J(Zt,Zt.current)}function _i(t){ee(Zt),di===t&&(di=null),ee(Qe)}var Qe=G(0);function hr(t){for(var s=t;s!==null;){if(s.tag===13){var o=s.memoizedState;if(o!==null&&(o=o.dehydrated,o===null||o.data==="$?"||Du(o)))return s}else if(s.tag===19&&s.memoizedProps.revealOrder!==void 0){if((s.flags&128)!==0)return s}else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===t)break;for(;s.sibling===null;){if(s.return===null||s.return===t)return null;s=s.return}s.sibling.return=s.return,s=s.sibling}return null}function Vc(t,s,o,l){s=t.memoizedState,o=o(l,s),o=o==null?s:m({},s,o),t.memoizedState=o,t.lanes===0&&(t.updateQueue.baseState=o)}var Xc={enqueueSetState:function(t,s,o){t=t._reactInternals;var l=Nt(),f=ts(l);f.payload=s,o!=null&&(f.callback=o),s=is(t,f,l),s!==null&&(Ht(s,t,l),Oa(s,t,l))},enqueueReplaceState:function(t,s,o){t=t._reactInternals;var l=Nt(),f=ts(l);f.tag=1,f.payload=s,o!=null&&(f.callback=o),s=is(t,f,l),s!==null&&(Ht(s,t,l),Oa(s,t,l))},enqueueForceUpdate:function(t,s){t=t._reactInternals;var o=Nt(),l=ts(o);l.tag=2,s!=null&&(l.callback=s),s=is(t,l,o),s!==null&&(Ht(s,t,o),Oa(s,t,o))}};function Kd(t,s,o,l,f,p,b){return t=t.stateNode,typeof t.shouldComponentUpdate=="function"?t.shouldComponentUpdate(l,p,b):s.prototype&&s.prototype.isPureReactComponent?!ka(o,l)||!ka(f,p):!0}function Zd(t,s,o,l){t=s.state,typeof s.componentWillReceiveProps=="function"&&s.componentWillReceiveProps(o,l),typeof s.UNSAFE_componentWillReceiveProps=="function"&&s.UNSAFE_componentWillReceiveProps(o,l),s.state!==t&&Xc.enqueueReplaceState(s,s.state,null)}function Gs(t,s){var o=s;if("ref"in s){o={};for(var l in s)l!=="ref"&&(o[l]=s[l])}if(t=t.defaultProps){o===s&&(o=m({},o));for(var f in t)o[f]===void 0&&(o[f]=t[f])}return o}var fr=typeof reportError=="function"?reportError:function(t){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var s=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof t=="object"&&t!==null&&typeof t.message=="string"?String(t.message):String(t),error:t});if(!window.dispatchEvent(s))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",t);return}console.error(t)};function Qd(t){fr(t)}function $d(t){console.error(t)}function Jd(t){fr(t)}function dr(t,s){try{var o=t.onUncaughtError;o(s.value,{componentStack:s.stack})}catch(l){setTimeout(function(){throw l})}}function e0(t,s,o){try{var l=t.onCaughtError;l(o.value,{componentStack:o.stack,errorBoundary:s.tag===1?s.stateNode:null})}catch(f){setTimeout(function(){throw f})}}function Yc(t,s,o){return o=ts(o),o.tag=3,o.payload={element:null},o.callback=function(){dr(t,s)},o}function t0(t){return t=ts(t),t.tag=3,t}function i0(t,s,o,l){var f=o.type.getDerivedStateFromError;if(typeof f=="function"){var p=l.value;t.payload=function(){return f(p)},t.callback=function(){e0(s,o,l)}}var b=o.stateNode;b!==null&&typeof b.componentDidCatch=="function"&&(t.callback=function(){e0(s,o,l),typeof f!="function"&&(hs===null?hs=new Set([this]):hs.add(this));var C=l.stack;this.componentDidCatch(l.value,{componentStack:C!==null?C:""})})}function Cv(t,s,o,l,f){if(o.flags|=32768,l!==null&&typeof l=="object"&&typeof l.then=="function"){if(s=o.alternate,s!==null&&xa(s,o,f,!0),o=Zt.current,o!==null){switch(o.tag){case 13:return di===null?mu():o.alternate===null&&ze===0&&(ze=3),o.flags&=-257,o.flags|=65536,o.lanes=f,l===Mc?o.flags|=16384:(s=o.updateQueue,s===null?o.updateQueue=new Set([l]):s.add(l),vu(t,l,f)),!1;case 22:return o.flags|=65536,l===Mc?o.flags|=16384:(s=o.updateQueue,s===null?(s={transitions:null,markerInstances:null,retryQueue:new Set([l])},o.updateQueue=s):(o=s.retryQueue,o===null?s.retryQueue=new Set([l]):o.add(l)),vu(t,l,f)),!1}throw Error(n(435,o.tag))}return vu(t,l,f),mu(),!1}if(Ee)return s=Zt.current,s!==null?((s.flags&65536)===0&&(s.flags|=256),s.flags|=65536,s.lanes=f,l!==gc&&(t=Error(n(422),{cause:l}),Ia(Yt(t,o)))):(l!==gc&&(s=Error(n(423),{cause:l}),Ia(Yt(s,o))),t=t.current.alternate,t.flags|=65536,f&=-f,t.lanes|=f,l=Yt(l,o),f=Yc(t.stateNode,l,f),wc(t,f),ze!==4&&(ze=2)),!1;var p=Error(n(520),{cause:l});if(p=Yt(p,o),Qa===null?Qa=[p]:Qa.push(p),ze!==4&&(ze=2),s===null)return!0;l=Yt(l,o),o=s;do{switch(o.tag){case 3:return o.flags|=65536,t=f&-f,o.lanes|=t,t=Yc(o.stateNode,l,t),wc(o,t),!1;case 1:if(s=o.type,p=o.stateNode,(o.flags&128)===0&&(typeof s.getDerivedStateFromError=="function"||p!==null&&typeof p.componentDidCatch=="function"&&(hs===null||!hs.has(p))))return o.flags|=65536,f&=-f,o.lanes|=f,f=t0(f),i0(f,t,o,l),wc(o,f),!1}o=o.return}while(o!==null);return!1}var s0=Error(n(461)),et=!1;function st(t,s,o,l){s.child=t===null?qd(s,null,o,l):Pn(s,t.child,o,l)}function n0(t,s,o,l,f){o=o.render;var p=s.ref;if("ref"in l){var b={};for(var C in l)C!=="ref"&&(b[C]=l[C])}else b=l;return Us(s),l=Bc(t,s,o,b,p,f),C=Ic(),t!==null&&!et?(xc(t,s,f),Di(t,s,f)):(Ee&&C&&fc(s),s.flags|=1,st(t,s,l,f),s.child)}function a0(t,s,o,l,f){if(t===null){var p=o.type;return typeof p=="function"&&!cc(p)&&p.defaultProps===void 0&&o.compare===null?(s.tag=15,s.type=p,o0(t,s,p,l,f)):(t=Yo(o.type,null,l,s,s.mode,f),t.ref=s.ref,t.return=s,s.child=t)}if(p=t.child,!eu(t,f)){var b=p.memoizedProps;if(o=o.compare,o=o!==null?o:ka,o(b,l)&&t.ref===s.ref)return Di(t,s,f)}return s.flags|=1,t=ki(p,l),t.ref=s.ref,t.return=s,s.child=t}function o0(t,s,o,l,f){if(t!==null){var p=t.memoizedProps;if(ka(p,l)&&t.ref===s.ref)if(et=!1,s.pendingProps=l=p,eu(t,f))(t.flags&131072)!==0&&(et=!0);else return s.lanes=t.lanes,Di(t,s,f)}return qc(t,s,o,l,f)}function r0(t,s,o){var l=s.pendingProps,f=l.children,p=t!==null?t.memoizedState:null;if(l.mode==="hidden"){if((s.flags&128)!==0){if(l=p!==null?p.baseLanes|o:o,t!==null){for(f=s.child=t.child,p=0;f!==null;)p=p|f.lanes|f.childLanes,f=f.sibling;s.childLanes=p&~l}else s.childLanes=0,s.child=null;return l0(t,s,l,o)}if((o&536870912)!==0)s.memoizedState={baseLanes:0,cachePool:null},t!==null&&Qo(s,p!==null?p.cachePool:null),p!==null?od(s,p):kc(),jd(s);else return s.lanes=s.childLanes=536870912,l0(t,s,p!==null?p.baseLanes|o:o,o)}else p!==null?(Qo(s,p.cachePool),od(s,p),as(),s.memoizedState=null):(t!==null&&Qo(s,null),kc(),as());return st(t,s,f,o),s.child}function l0(t,s,o,l){var f=Sc();return f=f===null?null:{parent:Ze._currentValue,pool:f},s.memoizedState={baseLanes:o,cachePool:f},t!==null&&Qo(s,null),kc(),jd(s),t!==null&&xa(t,s,l,!0),null}function gr(t,s){var o=s.ref;if(o===null)t!==null&&t.ref!==null&&(s.flags|=4194816);else{if(typeof o!="function"&&typeof o!="object")throw Error(n(284));(t===null||t.ref!==o)&&(s.flags|=4194816)}}function qc(t,s,o,l,f){return Us(s),o=Bc(t,s,o,l,void 0,f),l=Ic(),t!==null&&!et?(xc(t,s,f),Di(t,s,f)):(Ee&&l&&fc(s),s.flags|=1,st(t,s,o,f),s.child)}function c0(t,s,o,l,f,p){return Us(s),s.updateQueue=null,o=ld(s,l,o,f),rd(t),l=Ic(),t!==null&&!et?(xc(t,s,p),Di(t,s,p)):(Ee&&l&&fc(s),s.flags|=1,st(t,s,o,p),s.child)}function u0(t,s,o,l,f){if(Us(s),s.stateNode===null){var p=wn,b=o.contextType;typeof b=="object"&&b!==null&&(p=ht(b)),p=new o(l,p),s.memoizedState=p.state!==null&&p.state!==void 0?p.state:null,p.updater=Xc,s.stateNode=p,p._reactInternals=s,p=s.stateNode,p.props=l,p.state=s.memoizedState,p.refs={},Tc(s),b=o.contextType,p.context=typeof b=="object"&&b!==null?ht(b):wn,p.state=s.memoizedState,b=o.getDerivedStateFromProps,typeof b=="function"&&(Vc(s,o,b,l),p.state=s.memoizedState),typeof o.getDerivedStateFromProps=="function"||typeof p.getSnapshotBeforeUpdate=="function"||typeof p.UNSAFE_componentWillMount!="function"&&typeof p.componentWillMount!="function"||(b=p.state,typeof p.componentWillMount=="function"&&p.componentWillMount(),typeof p.UNSAFE_componentWillMount=="function"&&p.UNSAFE_componentWillMount(),b!==p.state&&Xc.enqueueReplaceState(p,p.state,null),Ua(s,l,p,f),Fa(),p.state=s.memoizedState),typeof p.componentDidMount=="function"&&(s.flags|=4194308),l=!0}else if(t===null){p=s.stateNode;var C=s.memoizedProps,E=Gs(o,C);p.props=E;var O=p.context,V=o.contextType;b=wn,typeof V=="object"&&V!==null&&(b=ht(V));var j=o.getDerivedStateFromProps;V=typeof j=="function"||typeof p.getSnapshotBeforeUpdate=="function",C=s.pendingProps!==C,V||typeof p.UNSAFE_componentWillReceiveProps!="function"&&typeof p.componentWillReceiveProps!="function"||(C||O!==b)&&Zd(s,p,l,b),es=!1;var F=s.memoizedState;p.state=F,Ua(s,l,p,f),Fa(),O=s.memoizedState,C||F!==O||es?(typeof j=="function"&&(Vc(s,o,j,l),O=s.memoizedState),(E=es||Kd(s,o,E,l,F,O,b))?(V||typeof p.UNSAFE_componentWillMount!="function"&&typeof p.componentWillMount!="function"||(typeof p.componentWillMount=="function"&&p.componentWillMount(),typeof p.UNSAFE_componentWillMount=="function"&&p.UNSAFE_componentWillMount()),typeof p.componentDidMount=="function"&&(s.flags|=4194308)):(typeof p.componentDidMount=="function"&&(s.flags|=4194308),s.memoizedProps=l,s.memoizedState=O),p.props=l,p.state=O,p.context=b,l=E):(typeof p.componentDidMount=="function"&&(s.flags|=4194308),l=!1)}else{p=s.stateNode,Cc(t,s),b=s.memoizedProps,V=Gs(o,b),p.props=V,j=s.pendingProps,F=p.context,O=o.contextType,E=wn,typeof O=="object"&&O!==null&&(E=ht(O)),C=o.getDerivedStateFromProps,(O=typeof C=="function"||typeof p.getSnapshotBeforeUpdate=="function")||typeof p.UNSAFE_componentWillReceiveProps!="function"&&typeof p.componentWillReceiveProps!="function"||(b!==j||F!==E)&&Zd(s,p,l,E),es=!1,F=s.memoizedState,p.state=F,Ua(s,l,p,f),Fa();var U=s.memoizedState;b!==j||F!==U||es||t!==null&&t.dependencies!==null&&Ko(t.dependencies)?(typeof C=="function"&&(Vc(s,o,C,l),U=s.memoizedState),(V=es||Kd(s,o,V,l,F,U,E)||t!==null&&t.dependencies!==null&&Ko(t.dependencies))?(O||typeof p.UNSAFE_componentWillUpdate!="function"&&typeof p.componentWillUpdate!="function"||(typeof p.componentWillUpdate=="function"&&p.componentWillUpdate(l,U,E),typeof p.UNSAFE_componentWillUpdate=="function"&&p.UNSAFE_componentWillUpdate(l,U,E)),typeof p.componentDidUpdate=="function"&&(s.flags|=4),typeof p.getSnapshotBeforeUpdate=="function"&&(s.flags|=1024)):(typeof p.componentDidUpdate!="function"||b===t.memoizedProps&&F===t.memoizedState||(s.flags|=4),typeof p.getSnapshotBeforeUpdate!="function"||b===t.memoizedProps&&F===t.memoizedState||(s.flags|=1024),s.memoizedProps=l,s.memoizedState=U),p.props=l,p.state=U,p.context=E,l=V):(typeof p.componentDidUpdate!="function"||b===t.memoizedProps&&F===t.memoizedState||(s.flags|=4),typeof p.getSnapshotBeforeUpdate!="function"||b===t.memoizedProps&&F===t.memoizedState||(s.flags|=1024),l=!1)}return p=l,gr(t,s),l=(s.flags&128)!==0,p||l?(p=s.stateNode,o=l&&typeof o.getDerivedStateFromError!="function"?null:p.render(),s.flags|=1,t!==null&&l?(s.child=Pn(s,t.child,null,f),s.child=Pn(s,null,o,f)):st(t,s,o,f),s.memoizedState=p.state,t=s.child):t=Di(t,s,f),t}function h0(t,s,o,l){return Ba(),s.flags|=256,st(t,s,o,l),s.child}var jc={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function Kc(t){return{baseLanes:t,cachePool:$f()}}function Zc(t,s,o){return t=t!==null?t.childLanes&~o:0,s&&(t|=Qt),t}function f0(t,s,o){var l=s.pendingProps,f=!1,p=(s.flags&128)!==0,b;if((b=p)||(b=t!==null&&t.memoizedState===null?!1:(Qe.current&2)!==0),b&&(f=!0,s.flags&=-129),b=(s.flags&32)!==0,s.flags&=-33,t===null){if(Ee){if(f?ns(s):as(),Ee){var C=We,E;if(E=C){e:{for(E=C,C=fi;E.nodeType!==8;){if(!C){C=null;break e}if(E=ri(E.nextSibling),E===null){C=null;break e}}C=E}C!==null?(s.memoizedState={dehydrated:C,treeContext:Ds!==null?{id:Ei,overflow:Ri}:null,retryLane:536870912,hydrationErrors:null},E=Lt(18,null,null,0),E.stateNode=C,E.return=s,s.child=E,vt=s,We=null,E=!0):E=!1}E||Os(s)}if(C=s.memoizedState,C!==null&&(C=C.dehydrated,C!==null))return Du(C)?s.lanes=32:s.lanes=536870912,null;_i(s)}return C=l.children,l=l.fallback,f?(as(),f=s.mode,C=pr({mode:"hidden",children:C},f),l=_s(l,f,o,null),C.return=s,l.return=s,C.sibling=l,s.child=C,f=s.child,f.memoizedState=Kc(o),f.childLanes=Zc(t,b,o),s.memoizedState=jc,l):(ns(s),Qc(s,C))}if(E=t.memoizedState,E!==null&&(C=E.dehydrated,C!==null)){if(p)s.flags&256?(ns(s),s.flags&=-257,s=$c(t,s,o)):s.memoizedState!==null?(as(),s.child=t.child,s.flags|=128,s=null):(as(),f=l.fallback,C=s.mode,l=pr({mode:"visible",children:l.children},C),f=_s(f,C,o,null),f.flags|=2,l.return=s,f.return=s,l.sibling=f,s.child=l,Pn(s,t.child,null,o),l=s.child,l.memoizedState=Kc(o),l.childLanes=Zc(t,b,o),s.memoizedState=jc,s=f);else if(ns(s),Du(C)){if(b=C.nextSibling&&C.nextSibling.dataset,b)var O=b.dgst;b=O,l=Error(n(419)),l.stack="",l.digest=b,Ia({value:l,source:null,stack:null}),s=$c(t,s,o)}else if(et||xa(t,s,o,!1),b=(o&t.childLanes)!==0,et||b){if(b=Ue,b!==null&&(l=o&-o,l=(l&42)!==0?1:Pl(l),l=(l&(b.suspendedLanes|o))!==0?0:l,l!==0&&l!==E.retryLane))throw E.retryLane=l,Cn(t,l),Ht(b,t,l),s0;C.data==="$?"||mu(),s=$c(t,s,o)}else C.data==="$?"?(s.flags|=192,s.child=t.child,s=null):(t=E.treeContext,We=ri(C.nextSibling),vt=s,Ee=!0,Ls=null,fi=!1,t!==null&&(jt[Kt++]=Ei,jt[Kt++]=Ri,jt[Kt++]=Ds,Ei=t.id,Ri=t.overflow,Ds=s),s=Qc(s,l.children),s.flags|=4096);return s}return f?(as(),f=l.fallback,C=s.mode,E=t.child,O=E.sibling,l=ki(E,{mode:"hidden",children:l.children}),l.subtreeFlags=E.subtreeFlags&65011712,O!==null?f=ki(O,f):(f=_s(f,C,o,null),f.flags|=2),f.return=s,l.return=s,l.sibling=f,s.child=l,l=f,f=s.child,C=t.child.memoizedState,C===null?C=Kc(o):(E=C.cachePool,E!==null?(O=Ze._currentValue,E=E.parent!==O?{parent:O,pool:O}:E):E=$f(),C={baseLanes:C.baseLanes|o,cachePool:E}),f.memoizedState=C,f.childLanes=Zc(t,b,o),s.memoizedState=jc,l):(ns(s),o=t.child,t=o.sibling,o=ki(o,{mode:"visible",children:l.children}),o.return=s,o.sibling=null,t!==null&&(b=s.deletions,b===null?(s.deletions=[t],s.flags|=16):b.push(t)),s.child=o,s.memoizedState=null,o)}function Qc(t,s){return s=pr({mode:"visible",children:s},t.mode),s.return=t,t.child=s}function pr(t,s){return t=Lt(22,t,null,s),t.lanes=0,t.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null},t}function $c(t,s,o){return Pn(s,t.child,null,o),t=Qc(s,s.pendingProps.children),t.flags|=2,s.memoizedState=null,t}function d0(t,s,o){t.lanes|=s;var l=t.alternate;l!==null&&(l.lanes|=s),mc(t.return,s,o)}function Jc(t,s,o,l,f){var p=t.memoizedState;p===null?t.memoizedState={isBackwards:s,rendering:null,renderingStartTime:0,last:l,tail:o,tailMode:f}:(p.isBackwards=s,p.rendering=null,p.renderingStartTime=0,p.last=l,p.tail=o,p.tailMode=f)}function g0(t,s,o){var l=s.pendingProps,f=l.revealOrder,p=l.tail;if(st(t,s,l.children,o),l=Qe.current,(l&2)!==0)l=l&1|2,s.flags|=128;else{if(t!==null&&(t.flags&128)!==0)e:for(t=s.child;t!==null;){if(t.tag===13)t.memoizedState!==null&&d0(t,o,s);else if(t.tag===19)d0(t,o,s);else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===s)break e;for(;t.sibling===null;){if(t.return===null||t.return===s)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}l&=1}switch(J(Qe,l),f){case"forwards":for(o=s.child,f=null;o!==null;)t=o.alternate,t!==null&&hr(t)===null&&(f=o),o=o.sibling;o=f,o===null?(f=s.child,s.child=null):(f=o.sibling,o.sibling=null),Jc(s,!1,f,o,p);break;case"backwards":for(o=null,f=s.child,s.child=null;f!==null;){if(t=f.alternate,t!==null&&hr(t)===null){s.child=f;break}t=f.sibling,f.sibling=o,o=f,f=t}Jc(s,!0,o,null,p);break;case"together":Jc(s,!1,null,null,void 0);break;default:s.memoizedState=null}return s.child}function Di(t,s,o){if(t!==null&&(s.dependencies=t.dependencies),us|=s.lanes,(o&s.childLanes)===0)if(t!==null){if(xa(t,s,o,!1),(o&s.childLanes)===0)return null}else return null;if(t!==null&&s.child!==t.child)throw Error(n(153));if(s.child!==null){for(t=s.child,o=ki(t,t.pendingProps),s.child=o,o.return=s;t.sibling!==null;)t=t.sibling,o=o.sibling=ki(t,t.pendingProps),o.return=s;o.sibling=null}return s.child}function eu(t,s){return(t.lanes&s)!==0?!0:(t=t.dependencies,!!(t!==null&&Ko(t)))}function wv(t,s,o){switch(s.tag){case 3:Fe(s,s.stateNode.containerInfo),Ji(s,Ze,t.memoizedState.cache),Ba();break;case 27:case 5:da(s);break;case 4:Fe(s,s.stateNode.containerInfo);break;case 10:Ji(s,s.type,s.memoizedProps.value);break;case 13:var l=s.memoizedState;if(l!==null)return l.dehydrated!==null?(ns(s),s.flags|=128,null):(o&s.child.childLanes)!==0?f0(t,s,o):(ns(s),t=Di(t,s,o),t!==null?t.sibling:null);ns(s);break;case 19:var f=(t.flags&128)!==0;if(l=(o&s.childLanes)!==0,l||(xa(t,s,o,!1),l=(o&s.childLanes)!==0),f){if(l)return g0(t,s,o);s.flags|=128}if(f=s.memoizedState,f!==null&&(f.rendering=null,f.tail=null,f.lastEffect=null),J(Qe,Qe.current),l)break;return null;case 22:case 23:return s.lanes=0,r0(t,s,o);case 24:Ji(s,Ze,t.memoizedState.cache)}return Di(t,s,o)}function p0(t,s,o){if(t!==null)if(t.memoizedProps!==s.pendingProps)et=!0;else{if(!eu(t,o)&&(s.flags&128)===0)return et=!1,wv(t,s,o);et=(t.flags&131072)!==0}else et=!1,Ee&&(s.flags&1048576)!==0&&Xf(s,jo,s.index);switch(s.lanes=0,s.tag){case 16:e:{t=s.pendingProps;var l=s.elementType,f=l._init;if(l=f(l._payload),s.type=l,typeof l=="function")cc(l)?(t=Gs(l,t),s.tag=1,s=u0(null,s,l,t,o)):(s.tag=0,s=qc(null,s,l,t,o));else{if(l!=null){if(f=l.$$typeof,f===x){s.tag=11,s=n0(null,s,l,t,o);break e}else if(f===W){s.tag=14,s=a0(null,s,l,t,o);break e}}throw s=Z(l)||l,Error(n(306,s,""))}}return s;case 0:return qc(t,s,s.type,s.pendingProps,o);case 1:return l=s.type,f=Gs(l,s.pendingProps),u0(t,s,l,f,o);case 3:e:{if(Fe(s,s.stateNode.containerInfo),t===null)throw Error(n(387));l=s.pendingProps;var p=s.memoizedState;f=p.element,Cc(t,s),Ua(s,l,null,o);var b=s.memoizedState;if(l=b.cache,Ji(s,Ze,l),l!==p.cache&&yc(s,[Ze],o,!0),Fa(),l=b.element,p.isDehydrated)if(p={element:l,isDehydrated:!1,cache:b.cache},s.updateQueue.baseState=p,s.memoizedState=p,s.flags&256){s=h0(t,s,l,o);break e}else if(l!==f){f=Yt(Error(n(424)),s),Ia(f),s=h0(t,s,l,o);break e}else{switch(t=s.stateNode.containerInfo,t.nodeType){case 9:t=t.body;break;default:t=t.nodeName==="HTML"?t.ownerDocument.body:t}for(We=ri(t.firstChild),vt=s,Ee=!0,Ls=null,fi=!0,o=qd(s,null,l,o),s.child=o;o;)o.flags=o.flags&-3|4096,o=o.sibling}else{if(Ba(),l===f){s=Di(t,s,o);break e}st(t,s,l,o)}s=s.child}return s;case 26:return gr(t,s),t===null?(o=bg(s.type,null,s.pendingProps,null))?s.memoizedState=o:Ee||(o=s.type,t=s.pendingProps,l=Br(he.current).createElement(o),l[ut]=s,l[Ct]=t,at(l,o,t),Je(l),s.stateNode=l):s.memoizedState=bg(s.type,t.memoizedProps,s.pendingProps,t.memoizedState),null;case 27:return da(s),t===null&&Ee&&(l=s.stateNode=mg(s.type,s.pendingProps,he.current),vt=s,fi=!0,f=We,gs(s.type)?(Pu=f,We=ri(l.firstChild)):We=f),st(t,s,s.pendingProps.children,o),gr(t,s),t===null&&(s.flags|=4194304),s.child;case 5:return t===null&&Ee&&((f=l=We)&&(l=$v(l,s.type,s.pendingProps,fi),l!==null?(s.stateNode=l,vt=s,We=ri(l.firstChild),fi=!1,f=!0):f=!1),f||Os(s)),da(s),f=s.type,p=s.pendingProps,b=t!==null?t.memoizedProps:null,l=p.children,Iu(f,p)?l=null:b!==null&&Iu(f,b)&&(s.flags|=32),s.memoizedState!==null&&(f=Bc(t,s,mv,null,null,o),oo._currentValue=f),gr(t,s),st(t,s,l,o),s.child;case 6:return t===null&&Ee&&((t=o=We)&&(o=Jv(o,s.pendingProps,fi),o!==null?(s.stateNode=o,vt=s,We=null,t=!0):t=!1),t||Os(s)),null;case 13:return f0(t,s,o);case 4:return Fe(s,s.stateNode.containerInfo),l=s.pendingProps,t===null?s.child=Pn(s,null,l,o):st(t,s,l,o),s.child;case 11:return n0(t,s,s.type,s.pendingProps,o);case 7:return st(t,s,s.pendingProps,o),s.child;case 8:return st(t,s,s.pendingProps.children,o),s.child;case 12:return st(t,s,s.pendingProps.children,o),s.child;case 10:return l=s.pendingProps,Ji(s,s.type,l.value),st(t,s,l.children,o),s.child;case 9:return f=s.type._context,l=s.pendingProps.children,Us(s),f=ht(f),l=l(f),s.flags|=1,st(t,s,l,o),s.child;case 14:return a0(t,s,s.type,s.pendingProps,o);case 15:return o0(t,s,s.type,s.pendingProps,o);case 19:return g0(t,s,o);case 31:return l=s.pendingProps,o=s.mode,l={mode:l.mode,children:l.children},t===null?(o=pr(l,o),o.ref=s.ref,s.child=o,o.return=s,s=o):(o=ki(t.child,l),o.ref=s.ref,s.child=o,o.return=s,s=o),s;case 22:return r0(t,s,o);case 24:return Us(s),l=ht(Ze),t===null?(f=Sc(),f===null&&(f=Ue,p=vc(),f.pooledCache=p,p.refCount++,p!==null&&(f.pooledCacheLanes|=o),f=p),s.memoizedState={parent:l,cache:f},Tc(s),Ji(s,Ze,f)):((t.lanes&o)!==0&&(Cc(t,s),Ua(s,null,null,o),Fa()),f=t.memoizedState,p=s.memoizedState,f.parent!==l?(f={parent:l,cache:l},s.memoizedState=f,s.lanes===0&&(s.memoizedState=s.updateQueue.baseState=f),Ji(s,Ze,l)):(l=p.cache,Ji(s,Ze,l),l!==f.cache&&yc(s,[Ze],o,!0))),st(t,s,s.pendingProps.children,o),s.child;case 29:throw s.pendingProps}throw Error(n(156,s.tag))}function Pi(t){t.flags|=4}function m0(t,s){if(s.type!=="stylesheet"||(s.state.loading&4)!==0)t.flags&=-16777217;else if(t.flags|=16777216,!wg(s)){if(s=Zt.current,s!==null&&((we&4194048)===we?di!==null:(we&62914560)!==we&&(we&536870912)===0||s!==di))throw La=Mc,Jf;t.flags|=8192}}function mr(t,s){s!==null&&(t.flags|=4),t.flags&16384&&(s=t.tag!==22?qh():536870912,t.lanes|=s,Un|=s)}function Xa(t,s){if(!Ee)switch(t.tailMode){case"hidden":s=t.tail;for(var o=null;s!==null;)s.alternate!==null&&(o=s),s=s.sibling;o===null?t.tail=null:o.sibling=null;break;case"collapsed":o=t.tail;for(var l=null;o!==null;)o.alternate!==null&&(l=o),o=o.sibling;l===null?s||t.tail===null?t.tail=null:t.tail.sibling=null:l.sibling=null}}function Ge(t){var s=t.alternate!==null&&t.alternate.child===t.child,o=0,l=0;if(s)for(var f=t.child;f!==null;)o|=f.lanes|f.childLanes,l|=f.subtreeFlags&65011712,l|=f.flags&65011712,f.return=t,f=f.sibling;else for(f=t.child;f!==null;)o|=f.lanes|f.childLanes,l|=f.subtreeFlags,l|=f.flags,f.return=t,f=f.sibling;return t.subtreeFlags|=l,t.childLanes=o,s}function Av(t,s,o){var l=s.pendingProps;switch(dc(s),s.tag){case 31:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Ge(s),null;case 1:return Ge(s),null;case 3:return o=s.stateNode,l=null,t!==null&&(l=t.memoizedState.cache),s.memoizedState.cache!==l&&(s.flags|=2048),Ii(Ze),ui(),o.pendingContext&&(o.context=o.pendingContext,o.pendingContext=null),(t===null||t.child===null)&&(Ra(s)?Pi(s):t===null||t.memoizedState.isDehydrated&&(s.flags&256)===0||(s.flags|=1024,jf())),Ge(s),null;case 26:return o=s.memoizedState,t===null?(Pi(s),o!==null?(Ge(s),m0(s,o)):(Ge(s),s.flags&=-16777217)):o?o!==t.memoizedState?(Pi(s),Ge(s),m0(s,o)):(Ge(s),s.flags&=-16777217):(t.memoizedProps!==l&&Pi(s),Ge(s),s.flags&=-16777217),null;case 27:Ki(s),o=he.current;var f=s.type;if(t!==null&&s.stateNode!=null)t.memoizedProps!==l&&Pi(s);else{if(!l){if(s.stateNode===null)throw Error(n(166));return Ge(s),null}t=re.current,Ra(s)?Yf(s):(t=mg(f,l,o),s.stateNode=t,Pi(s))}return Ge(s),null;case 5:if(Ki(s),o=s.type,t!==null&&s.stateNode!=null)t.memoizedProps!==l&&Pi(s);else{if(!l){if(s.stateNode===null)throw Error(n(166));return Ge(s),null}if(t=re.current,Ra(s))Yf(s);else{switch(f=Br(he.current),t){case 1:t=f.createElementNS("http://www.w3.org/2000/svg",o);break;case 2:t=f.createElementNS("http://www.w3.org/1998/Math/MathML",o);break;default:switch(o){case"svg":t=f.createElementNS("http://www.w3.org/2000/svg",o);break;case"math":t=f.createElementNS("http://www.w3.org/1998/Math/MathML",o);break;case"script":t=f.createElement("div"),t.innerHTML="<script><\/script>",t=t.removeChild(t.firstChild);break;case"select":t=typeof l.is=="string"?f.createElement("select",{is:l.is}):f.createElement("select"),l.multiple?t.multiple=!0:l.size&&(t.size=l.size);break;default:t=typeof l.is=="string"?f.createElement(o,{is:l.is}):f.createElement(o)}}t[ut]=s,t[Ct]=l;e:for(f=s.child;f!==null;){if(f.tag===5||f.tag===6)t.appendChild(f.stateNode);else if(f.tag!==4&&f.tag!==27&&f.child!==null){f.child.return=f,f=f.child;continue}if(f===s)break e;for(;f.sibling===null;){if(f.return===null||f.return===s)break e;f=f.return}f.sibling.return=f.return,f=f.sibling}s.stateNode=t;e:switch(at(t,o,l),o){case"button":case"input":case"select":case"textarea":t=!!l.autoFocus;break e;case"img":t=!0;break e;default:t=!1}t&&Pi(s)}}return Ge(s),s.flags&=-16777217,null;case 6:if(t&&s.stateNode!=null)t.memoizedProps!==l&&Pi(s);else{if(typeof l!="string"&&s.stateNode===null)throw Error(n(166));if(t=he.current,Ra(s)){if(t=s.stateNode,o=s.memoizedProps,l=null,f=vt,f!==null)switch(f.tag){case 27:case 5:l=f.memoizedProps}t[ut]=s,t=!!(t.nodeValue===o||l!==null&&l.suppressHydrationWarning===!0||cg(t.nodeValue,o)),t||Os(s)}else t=Br(t).createTextNode(l),t[ut]=s,s.stateNode=t}return Ge(s),null;case 13:if(l=s.memoizedState,t===null||t.memoizedState!==null&&t.memoizedState.dehydrated!==null){if(f=Ra(s),l!==null&&l.dehydrated!==null){if(t===null){if(!f)throw Error(n(318));if(f=s.memoizedState,f=f!==null?f.dehydrated:null,!f)throw Error(n(317));f[ut]=s}else Ba(),(s.flags&128)===0&&(s.memoizedState=null),s.flags|=4;Ge(s),f=!1}else f=jf(),t!==null&&t.memoizedState!==null&&(t.memoizedState.hydrationErrors=f),f=!0;if(!f)return s.flags&256?(_i(s),s):(_i(s),null)}if(_i(s),(s.flags&128)!==0)return s.lanes=o,s;if(o=l!==null,t=t!==null&&t.memoizedState!==null,o){l=s.child,f=null,l.alternate!==null&&l.alternate.memoizedState!==null&&l.alternate.memoizedState.cachePool!==null&&(f=l.alternate.memoizedState.cachePool.pool);var p=null;l.memoizedState!==null&&l.memoizedState.cachePool!==null&&(p=l.memoizedState.cachePool.pool),p!==f&&(l.flags|=2048)}return o!==t&&o&&(s.child.flags|=8192),mr(s,s.updateQueue),Ge(s),null;case 4:return ui(),t===null&&Au(s.stateNode.containerInfo),Ge(s),null;case 10:return Ii(s.type),Ge(s),null;case 19:if(ee(Qe),f=s.memoizedState,f===null)return Ge(s),null;if(l=(s.flags&128)!==0,p=f.rendering,p===null)if(l)Xa(f,!1);else{if(ze!==0||t!==null&&(t.flags&128)!==0)for(t=s.child;t!==null;){if(p=hr(t),p!==null){for(s.flags|=128,Xa(f,!1),t=p.updateQueue,s.updateQueue=t,mr(s,t),s.subtreeFlags=0,t=o,o=s.child;o!==null;)Vf(o,t),o=o.sibling;return J(Qe,Qe.current&1|2),s.child}t=t.sibling}f.tail!==null&&hi()>br&&(s.flags|=128,l=!0,Xa(f,!1),s.lanes=4194304)}else{if(!l)if(t=hr(p),t!==null){if(s.flags|=128,l=!0,t=t.updateQueue,s.updateQueue=t,mr(s,t),Xa(f,!0),f.tail===null&&f.tailMode==="hidden"&&!p.alternate&&!Ee)return Ge(s),null}else 2*hi()-f.renderingStartTime>br&&o!==536870912&&(s.flags|=128,l=!0,Xa(f,!1),s.lanes=4194304);f.isBackwards?(p.sibling=s.child,s.child=p):(t=f.last,t!==null?t.sibling=p:s.child=p,f.last=p)}return f.tail!==null?(s=f.tail,f.rendering=s,f.tail=s.sibling,f.renderingStartTime=hi(),s.sibling=null,t=Qe.current,J(Qe,l?t&1|2:t&1),s):(Ge(s),null);case 22:case 23:return _i(s),Ec(),l=s.memoizedState!==null,t!==null?t.memoizedState!==null!==l&&(s.flags|=8192):l&&(s.flags|=8192),l?(o&536870912)!==0&&(s.flags&128)===0&&(Ge(s),s.subtreeFlags&6&&(s.flags|=8192)):Ge(s),o=s.updateQueue,o!==null&&mr(s,o.retryQueue),o=null,t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(o=t.memoizedState.cachePool.pool),l=null,s.memoizedState!==null&&s.memoizedState.cachePool!==null&&(l=s.memoizedState.cachePool.pool),l!==o&&(s.flags|=2048),t!==null&&ee(Ns),null;case 24:return o=null,t!==null&&(o=t.memoizedState.cache),s.memoizedState.cache!==o&&(s.flags|=2048),Ii(Ze),Ge(s),null;case 25:return null;case 30:return null}throw Error(n(156,s.tag))}function kv(t,s){switch(dc(s),s.tag){case 1:return t=s.flags,t&65536?(s.flags=t&-65537|128,s):null;case 3:return Ii(Ze),ui(),t=s.flags,(t&65536)!==0&&(t&128)===0?(s.flags=t&-65537|128,s):null;case 26:case 27:case 5:return Ki(s),null;case 13:if(_i(s),t=s.memoizedState,t!==null&&t.dehydrated!==null){if(s.alternate===null)throw Error(n(340));Ba()}return t=s.flags,t&65536?(s.flags=t&-65537|128,s):null;case 19:return ee(Qe),null;case 4:return ui(),null;case 10:return Ii(s.type),null;case 22:case 23:return _i(s),Ec(),t!==null&&ee(Ns),t=s.flags,t&65536?(s.flags=t&-65537|128,s):null;case 24:return Ii(Ze),null;case 25:return null;default:return null}}function y0(t,s){switch(dc(s),s.tag){case 3:Ii(Ze),ui();break;case 26:case 27:case 5:Ki(s);break;case 4:ui();break;case 13:_i(s);break;case 19:ee(Qe);break;case 10:Ii(s.type);break;case 22:case 23:_i(s),Ec(),t!==null&&ee(Ns);break;case 24:Ii(Ze)}}function Ya(t,s){try{var o=s.updateQueue,l=o!==null?o.lastEffect:null;if(l!==null){var f=l.next;o=f;do{if((o.tag&t)===t){l=void 0;var p=o.create,b=o.inst;l=p(),b.destroy=l}o=o.next}while(o!==f)}}catch(C){Oe(s,s.return,C)}}function os(t,s,o){try{var l=s.updateQueue,f=l!==null?l.lastEffect:null;if(f!==null){var p=f.next;l=p;do{if((l.tag&t)===t){var b=l.inst,C=b.destroy;if(C!==void 0){b.destroy=void 0,f=s;var E=o,O=C;try{O()}catch(V){Oe(f,E,V)}}}l=l.next}while(l!==p)}}catch(V){Oe(s,s.return,V)}}function v0(t){var s=t.updateQueue;if(s!==null){var o=t.stateNode;try{ad(s,o)}catch(l){Oe(t,t.return,l)}}}function b0(t,s,o){o.props=Gs(t.type,t.memoizedProps),o.state=t.memoizedState;try{o.componentWillUnmount()}catch(l){Oe(t,s,l)}}function qa(t,s){try{var o=t.ref;if(o!==null){switch(t.tag){case 26:case 27:case 5:var l=t.stateNode;break;case 30:l=t.stateNode;break;default:l=t.stateNode}typeof o=="function"?t.refCleanup=o(l):o.current=l}}catch(f){Oe(t,s,f)}}function gi(t,s){var o=t.ref,l=t.refCleanup;if(o!==null)if(typeof l=="function")try{l()}catch(f){Oe(t,s,f)}finally{t.refCleanup=null,t=t.alternate,t!=null&&(t.refCleanup=null)}else if(typeof o=="function")try{o(null)}catch(f){Oe(t,s,f)}else o.current=null}function S0(t){var s=t.type,o=t.memoizedProps,l=t.stateNode;try{e:switch(s){case"button":case"input":case"select":case"textarea":o.autoFocus&&l.focus();break e;case"img":o.src?l.src=o.src:o.srcSet&&(l.srcset=o.srcSet)}}catch(f){Oe(t,t.return,f)}}function tu(t,s,o){try{var l=t.stateNode;qv(l,t.type,o,s),l[Ct]=s}catch(f){Oe(t,t.return,f)}}function M0(t){return t.tag===5||t.tag===3||t.tag===26||t.tag===27&&gs(t.type)||t.tag===4}function iu(t){e:for(;;){for(;t.sibling===null;){if(t.return===null||M0(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.tag===27&&gs(t.type)||t.flags&2||t.child===null||t.tag===4)continue e;t.child.return=t,t=t.child}if(!(t.flags&2))return t.stateNode}}function su(t,s,o){var l=t.tag;if(l===5||l===6)t=t.stateNode,s?(o.nodeType===9?o.body:o.nodeName==="HTML"?o.ownerDocument.body:o).insertBefore(t,s):(s=o.nodeType===9?o.body:o.nodeName==="HTML"?o.ownerDocument.body:o,s.appendChild(t),o=o._reactRootContainer,o!=null||s.onclick!==null||(s.onclick=Rr));else if(l!==4&&(l===27&&gs(t.type)&&(o=t.stateNode,s=null),t=t.child,t!==null))for(su(t,s,o),t=t.sibling;t!==null;)su(t,s,o),t=t.sibling}function yr(t,s,o){var l=t.tag;if(l===5||l===6)t=t.stateNode,s?o.insertBefore(t,s):o.appendChild(t);else if(l!==4&&(l===27&&gs(t.type)&&(o=t.stateNode),t=t.child,t!==null))for(yr(t,s,o),t=t.sibling;t!==null;)yr(t,s,o),t=t.sibling}function T0(t){var s=t.stateNode,o=t.memoizedProps;try{for(var l=t.type,f=s.attributes;f.length;)s.removeAttributeNode(f[0]);at(s,l,o),s[ut]=t,s[Ct]=o}catch(p){Oe(t,t.return,p)}}var Li=!1,Ye=!1,nu=!1,C0=typeof WeakSet=="function"?WeakSet:Set,tt=null;function Ev(t,s){if(t=t.containerInfo,Ru=Lr,t=Pf(t),ic(t)){if("selectionStart"in t)var o={start:t.selectionStart,end:t.selectionEnd};else e:{o=(o=t.ownerDocument)&&o.defaultView||window;var l=o.getSelection&&o.getSelection();if(l&&l.rangeCount!==0){o=l.anchorNode;var f=l.anchorOffset,p=l.focusNode;l=l.focusOffset;try{o.nodeType,p.nodeType}catch{o=null;break e}var b=0,C=-1,E=-1,O=0,V=0,j=t,F=null;t:for(;;){for(var U;j!==o||f!==0&&j.nodeType!==3||(C=b+f),j!==p||l!==0&&j.nodeType!==3||(E=b+l),j.nodeType===3&&(b+=j.nodeValue.length),(U=j.firstChild)!==null;)F=j,j=U;for(;;){if(j===t)break t;if(F===o&&++O===f&&(C=b),F===p&&++V===l&&(E=b),(U=j.nextSibling)!==null)break;j=F,F=j.parentNode}j=U}o=C===-1||E===-1?null:{start:C,end:E}}else o=null}o=o||{start:0,end:0}}else o=null;for(Bu={focusedElem:t,selectionRange:o},Lr=!1,tt=s;tt!==null;)if(s=tt,t=s.child,(s.subtreeFlags&1024)!==0&&t!==null)t.return=s,tt=t;else for(;tt!==null;){switch(s=tt,p=s.alternate,t=s.flags,s.tag){case 0:break;case 11:case 15:break;case 1:if((t&1024)!==0&&p!==null){t=void 0,o=s,f=p.memoizedProps,p=p.memoizedState,l=o.stateNode;try{var ge=Gs(o.type,f,o.elementType===o.type);t=l.getSnapshotBeforeUpdate(ge,p),l.__reactInternalSnapshotBeforeUpdate=t}catch(fe){Oe(o,o.return,fe)}}break;case 3:if((t&1024)!==0){if(t=s.stateNode.containerInfo,o=t.nodeType,o===9)_u(t);else if(o===1)switch(t.nodeName){case"HEAD":case"HTML":case"BODY":_u(t);break;default:t.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((t&1024)!==0)throw Error(n(163))}if(t=s.sibling,t!==null){t.return=s.return,tt=t;break}tt=s.return}}function w0(t,s,o){var l=o.flags;switch(o.tag){case 0:case 11:case 15:rs(t,o),l&4&&Ya(5,o);break;case 1:if(rs(t,o),l&4)if(t=o.stateNode,s===null)try{t.componentDidMount()}catch(b){Oe(o,o.return,b)}else{var f=Gs(o.type,s.memoizedProps);s=s.memoizedState;try{t.componentDidUpdate(f,s,t.__reactInternalSnapshotBeforeUpdate)}catch(b){Oe(o,o.return,b)}}l&64&&v0(o),l&512&&qa(o,o.return);break;case 3:if(rs(t,o),l&64&&(t=o.updateQueue,t!==null)){if(s=null,o.child!==null)switch(o.child.tag){case 27:case 5:s=o.child.stateNode;break;case 1:s=o.child.stateNode}try{ad(t,s)}catch(b){Oe(o,o.return,b)}}break;case 27:s===null&&l&4&&T0(o);case 26:case 5:rs(t,o),s===null&&l&4&&S0(o),l&512&&qa(o,o.return);break;case 12:rs(t,o);break;case 13:rs(t,o),l&4&&E0(t,o),l&64&&(t=o.memoizedState,t!==null&&(t=t.dehydrated,t!==null&&(o=Ov.bind(null,o),eb(t,o))));break;case 22:if(l=o.memoizedState!==null||Li,!l){s=s!==null&&s.memoizedState!==null||Ye,f=Li;var p=Ye;Li=l,(Ye=s)&&!p?ls(t,o,(o.subtreeFlags&8772)!==0):rs(t,o),Li=f,Ye=p}break;case 30:break;default:rs(t,o)}}function A0(t){var s=t.alternate;s!==null&&(t.alternate=null,A0(s)),t.child=null,t.deletions=null,t.sibling=null,t.tag===5&&(s=t.stateNode,s!==null&&Fl(s)),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}var He=null,kt=!1;function Oi(t,s,o){for(o=o.child;o!==null;)k0(t,s,o),o=o.sibling}function k0(t,s,o){if(_t&&typeof _t.onCommitFiberUnmount=="function")try{_t.onCommitFiberUnmount(ga,o)}catch{}switch(o.tag){case 26:Ye||gi(o,s),Oi(t,s,o),o.memoizedState?o.memoizedState.count--:o.stateNode&&(o=o.stateNode,o.parentNode.removeChild(o));break;case 27:Ye||gi(o,s);var l=He,f=kt;gs(o.type)&&(He=o.stateNode,kt=!1),Oi(t,s,o),io(o.stateNode),He=l,kt=f;break;case 5:Ye||gi(o,s);case 6:if(l=He,f=kt,He=null,Oi(t,s,o),He=l,kt=f,He!==null)if(kt)try{(He.nodeType===9?He.body:He.nodeName==="HTML"?He.ownerDocument.body:He).removeChild(o.stateNode)}catch(p){Oe(o,s,p)}else try{He.removeChild(o.stateNode)}catch(p){Oe(o,s,p)}break;case 18:He!==null&&(kt?(t=He,gg(t.nodeType===9?t.body:t.nodeName==="HTML"?t.ownerDocument.body:t,o.stateNode),uo(t)):gg(He,o.stateNode));break;case 4:l=He,f=kt,He=o.stateNode.containerInfo,kt=!0,Oi(t,s,o),He=l,kt=f;break;case 0:case 11:case 14:case 15:Ye||os(2,o,s),Ye||os(4,o,s),Oi(t,s,o);break;case 1:Ye||(gi(o,s),l=o.stateNode,typeof l.componentWillUnmount=="function"&&b0(o,s,l)),Oi(t,s,o);break;case 21:Oi(t,s,o);break;case 22:Ye=(l=Ye)||o.memoizedState!==null,Oi(t,s,o),Ye=l;break;default:Oi(t,s,o)}}function E0(t,s){if(s.memoizedState===null&&(t=s.alternate,t!==null&&(t=t.memoizedState,t!==null&&(t=t.dehydrated,t!==null))))try{uo(t)}catch(o){Oe(s,s.return,o)}}function Rv(t){switch(t.tag){case 13:case 19:var s=t.stateNode;return s===null&&(s=t.stateNode=new C0),s;case 22:return t=t.stateNode,s=t._retryCache,s===null&&(s=t._retryCache=new C0),s;default:throw Error(n(435,t.tag))}}function au(t,s){var o=Rv(t);s.forEach(function(l){var f=Fv.bind(null,t,l);o.has(l)||(o.add(l),l.then(f,f))})}function Ot(t,s){var o=s.deletions;if(o!==null)for(var l=0;l<o.length;l++){var f=o[l],p=t,b=s,C=b;e:for(;C!==null;){switch(C.tag){case 27:if(gs(C.type)){He=C.stateNode,kt=!1;break e}break;case 5:He=C.stateNode,kt=!1;break e;case 3:case 4:He=C.stateNode.containerInfo,kt=!0;break e}C=C.return}if(He===null)throw Error(n(160));k0(p,b,f),He=null,kt=!1,p=f.alternate,p!==null&&(p.return=null),f.return=null}if(s.subtreeFlags&13878)for(s=s.child;s!==null;)R0(s,t),s=s.sibling}var oi=null;function R0(t,s){var o=t.alternate,l=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:Ot(s,t),Ft(t),l&4&&(os(3,t,t.return),Ya(3,t),os(5,t,t.return));break;case 1:Ot(s,t),Ft(t),l&512&&(Ye||o===null||gi(o,o.return)),l&64&&Li&&(t=t.updateQueue,t!==null&&(l=t.callbacks,l!==null&&(o=t.shared.hiddenCallbacks,t.shared.hiddenCallbacks=o===null?l:o.concat(l))));break;case 26:var f=oi;if(Ot(s,t),Ft(t),l&512&&(Ye||o===null||gi(o,o.return)),l&4){var p=o!==null?o.memoizedState:null;if(l=t.memoizedState,o===null)if(l===null)if(t.stateNode===null){e:{l=t.type,o=t.memoizedProps,f=f.ownerDocument||f;t:switch(l){case"title":p=f.getElementsByTagName("title")[0],(!p||p[ya]||p[ut]||p.namespaceURI==="http://www.w3.org/2000/svg"||p.hasAttribute("itemprop"))&&(p=f.createElement(l),f.head.insertBefore(p,f.querySelector("head > title"))),at(p,l,o),p[ut]=t,Je(p),l=p;break e;case"link":var b=Tg("link","href",f).get(l+(o.href||""));if(b){for(var C=0;C<b.length;C++)if(p=b[C],p.getAttribute("href")===(o.href==null||o.href===""?null:o.href)&&p.getAttribute("rel")===(o.rel==null?null:o.rel)&&p.getAttribute("title")===(o.title==null?null:o.title)&&p.getAttribute("crossorigin")===(o.crossOrigin==null?null:o.crossOrigin)){b.splice(C,1);break t}}p=f.createElement(l),at(p,l,o),f.head.appendChild(p);break;case"meta":if(b=Tg("meta","content",f).get(l+(o.content||""))){for(C=0;C<b.length;C++)if(p=b[C],p.getAttribute("content")===(o.content==null?null:""+o.content)&&p.getAttribute("name")===(o.name==null?null:o.name)&&p.getAttribute("property")===(o.property==null?null:o.property)&&p.getAttribute("http-equiv")===(o.httpEquiv==null?null:o.httpEquiv)&&p.getAttribute("charset")===(o.charSet==null?null:o.charSet)){b.splice(C,1);break t}}p=f.createElement(l),at(p,l,o),f.head.appendChild(p);break;default:throw Error(n(468,l))}p[ut]=t,Je(p),l=p}t.stateNode=l}else Cg(f,t.type,t.stateNode);else t.stateNode=Mg(f,l,t.memoizedProps);else p!==l?(p===null?o.stateNode!==null&&(o=o.stateNode,o.parentNode.removeChild(o)):p.count--,l===null?Cg(f,t.type,t.stateNode):Mg(f,l,t.memoizedProps)):l===null&&t.stateNode!==null&&tu(t,t.memoizedProps,o.memoizedProps)}break;case 27:Ot(s,t),Ft(t),l&512&&(Ye||o===null||gi(o,o.return)),o!==null&&l&4&&tu(t,t.memoizedProps,o.memoizedProps);break;case 5:if(Ot(s,t),Ft(t),l&512&&(Ye||o===null||gi(o,o.return)),t.flags&32){f=t.stateNode;try{mn(f,"")}catch(U){Oe(t,t.return,U)}}l&4&&t.stateNode!=null&&(f=t.memoizedProps,tu(t,f,o!==null?o.memoizedProps:f)),l&1024&&(nu=!0);break;case 6:if(Ot(s,t),Ft(t),l&4){if(t.stateNode===null)throw Error(n(162));l=t.memoizedProps,o=t.stateNode;try{o.nodeValue=l}catch(U){Oe(t,t.return,U)}}break;case 3:if(_r=null,f=oi,oi=Ir(s.containerInfo),Ot(s,t),oi=f,Ft(t),l&4&&o!==null&&o.memoizedState.isDehydrated)try{uo(s.containerInfo)}catch(U){Oe(t,t.return,U)}nu&&(nu=!1,B0(t));break;case 4:l=oi,oi=Ir(t.stateNode.containerInfo),Ot(s,t),Ft(t),oi=l;break;case 12:Ot(s,t),Ft(t);break;case 13:Ot(s,t),Ft(t),t.child.flags&8192&&t.memoizedState!==null!=(o!==null&&o.memoizedState!==null)&&(hu=hi()),l&4&&(l=t.updateQueue,l!==null&&(t.updateQueue=null,au(t,l)));break;case 22:f=t.memoizedState!==null;var E=o!==null&&o.memoizedState!==null,O=Li,V=Ye;if(Li=O||f,Ye=V||E,Ot(s,t),Ye=V,Li=O,Ft(t),l&8192)e:for(s=t.stateNode,s._visibility=f?s._visibility&-2:s._visibility|1,f&&(o===null||E||Li||Ye||Ws(t)),o=null,s=t;;){if(s.tag===5||s.tag===26){if(o===null){E=o=s;try{if(p=E.stateNode,f)b=p.style,typeof b.setProperty=="function"?b.setProperty("display","none","important"):b.display="none";else{C=E.stateNode;var j=E.memoizedProps.style,F=j!=null&&j.hasOwnProperty("display")?j.display:null;C.style.display=F==null||typeof F=="boolean"?"":(""+F).trim()}}catch(U){Oe(E,E.return,U)}}}else if(s.tag===6){if(o===null){E=s;try{E.stateNode.nodeValue=f?"":E.memoizedProps}catch(U){Oe(E,E.return,U)}}}else if((s.tag!==22&&s.tag!==23||s.memoizedState===null||s===t)&&s.child!==null){s.child.return=s,s=s.child;continue}if(s===t)break e;for(;s.sibling===null;){if(s.return===null||s.return===t)break e;o===s&&(o=null),s=s.return}o===s&&(o=null),s.sibling.return=s.return,s=s.sibling}l&4&&(l=t.updateQueue,l!==null&&(o=l.retryQueue,o!==null&&(l.retryQueue=null,au(t,o))));break;case 19:Ot(s,t),Ft(t),l&4&&(l=t.updateQueue,l!==null&&(t.updateQueue=null,au(t,l)));break;case 30:break;case 21:break;default:Ot(s,t),Ft(t)}}function Ft(t){var s=t.flags;if(s&2){try{for(var o,l=t.return;l!==null;){if(M0(l)){o=l;break}l=l.return}if(o==null)throw Error(n(160));switch(o.tag){case 27:var f=o.stateNode,p=iu(t);yr(t,p,f);break;case 5:var b=o.stateNode;o.flags&32&&(mn(b,""),o.flags&=-33);var C=iu(t);yr(t,C,b);break;case 3:case 4:var E=o.stateNode.containerInfo,O=iu(t);su(t,O,E);break;default:throw Error(n(161))}}catch(V){Oe(t,t.return,V)}t.flags&=-3}s&4096&&(t.flags&=-4097)}function B0(t){if(t.subtreeFlags&1024)for(t=t.child;t!==null;){var s=t;B0(s),s.tag===5&&s.flags&1024&&s.stateNode.reset(),t=t.sibling}}function rs(t,s){if(s.subtreeFlags&8772)for(s=s.child;s!==null;)w0(t,s.alternate,s),s=s.sibling}function Ws(t){for(t=t.child;t!==null;){var s=t;switch(s.tag){case 0:case 11:case 14:case 15:os(4,s,s.return),Ws(s);break;case 1:gi(s,s.return);var o=s.stateNode;typeof o.componentWillUnmount=="function"&&b0(s,s.return,o),Ws(s);break;case 27:io(s.stateNode);case 26:case 5:gi(s,s.return),Ws(s);break;case 22:s.memoizedState===null&&Ws(s);break;case 30:Ws(s);break;default:Ws(s)}t=t.sibling}}function ls(t,s,o){for(o=o&&(s.subtreeFlags&8772)!==0,s=s.child;s!==null;){var l=s.alternate,f=t,p=s,b=p.flags;switch(p.tag){case 0:case 11:case 15:ls(f,p,o),Ya(4,p);break;case 1:if(ls(f,p,o),l=p,f=l.stateNode,typeof f.componentDidMount=="function")try{f.componentDidMount()}catch(O){Oe(l,l.return,O)}if(l=p,f=l.updateQueue,f!==null){var C=l.stateNode;try{var E=f.shared.hiddenCallbacks;if(E!==null)for(f.shared.hiddenCallbacks=null,f=0;f<E.length;f++)nd(E[f],C)}catch(O){Oe(l,l.return,O)}}o&&b&64&&v0(p),qa(p,p.return);break;case 27:T0(p);case 26:case 5:ls(f,p,o),o&&l===null&&b&4&&S0(p),qa(p,p.return);break;case 12:ls(f,p,o);break;case 13:ls(f,p,o),o&&b&4&&E0(f,p);break;case 22:p.memoizedState===null&&ls(f,p,o),qa(p,p.return);break;case 30:break;default:ls(f,p,o)}s=s.sibling}}function ou(t,s){var o=null;t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(o=t.memoizedState.cachePool.pool),t=null,s.memoizedState!==null&&s.memoizedState.cachePool!==null&&(t=s.memoizedState.cachePool.pool),t!==o&&(t!=null&&t.refCount++,o!=null&&_a(o))}function ru(t,s){t=null,s.alternate!==null&&(t=s.alternate.memoizedState.cache),s=s.memoizedState.cache,s!==t&&(s.refCount++,t!=null&&_a(t))}function pi(t,s,o,l){if(s.subtreeFlags&10256)for(s=s.child;s!==null;)I0(t,s,o,l),s=s.sibling}function I0(t,s,o,l){var f=s.flags;switch(s.tag){case 0:case 11:case 15:pi(t,s,o,l),f&2048&&Ya(9,s);break;case 1:pi(t,s,o,l);break;case 3:pi(t,s,o,l),f&2048&&(t=null,s.alternate!==null&&(t=s.alternate.memoizedState.cache),s=s.memoizedState.cache,s!==t&&(s.refCount++,t!=null&&_a(t)));break;case 12:if(f&2048){pi(t,s,o,l),t=s.stateNode;try{var p=s.memoizedProps,b=p.id,C=p.onPostCommit;typeof C=="function"&&C(b,s.alternate===null?"mount":"update",t.passiveEffectDuration,-0)}catch(E){Oe(s,s.return,E)}}else pi(t,s,o,l);break;case 13:pi(t,s,o,l);break;case 23:break;case 22:p=s.stateNode,b=s.alternate,s.memoizedState!==null?p._visibility&2?pi(t,s,o,l):ja(t,s):p._visibility&2?pi(t,s,o,l):(p._visibility|=2,Ln(t,s,o,l,(s.subtreeFlags&10256)!==0)),f&2048&&ou(b,s);break;case 24:pi(t,s,o,l),f&2048&&ru(s.alternate,s);break;default:pi(t,s,o,l)}}function Ln(t,s,o,l,f){for(f=f&&(s.subtreeFlags&10256)!==0,s=s.child;s!==null;){var p=t,b=s,C=o,E=l,O=b.flags;switch(b.tag){case 0:case 11:case 15:Ln(p,b,C,E,f),Ya(8,b);break;case 23:break;case 22:var V=b.stateNode;b.memoizedState!==null?V._visibility&2?Ln(p,b,C,E,f):ja(p,b):(V._visibility|=2,Ln(p,b,C,E,f)),f&&O&2048&&ou(b.alternate,b);break;case 24:Ln(p,b,C,E,f),f&&O&2048&&ru(b.alternate,b);break;default:Ln(p,b,C,E,f)}s=s.sibling}}function ja(t,s){if(s.subtreeFlags&10256)for(s=s.child;s!==null;){var o=t,l=s,f=l.flags;switch(l.tag){case 22:ja(o,l),f&2048&&ou(l.alternate,l);break;case 24:ja(o,l),f&2048&&ru(l.alternate,l);break;default:ja(o,l)}s=s.sibling}}var Ka=8192;function On(t){if(t.subtreeFlags&Ka)for(t=t.child;t!==null;)x0(t),t=t.sibling}function x0(t){switch(t.tag){case 26:On(t),t.flags&Ka&&t.memoizedState!==null&&db(oi,t.memoizedState,t.memoizedProps);break;case 5:On(t);break;case 3:case 4:var s=oi;oi=Ir(t.stateNode.containerInfo),On(t),oi=s;break;case 22:t.memoizedState===null&&(s=t.alternate,s!==null&&s.memoizedState!==null?(s=Ka,Ka=16777216,On(t),Ka=s):On(t));break;default:On(t)}}function _0(t){var s=t.alternate;if(s!==null&&(t=s.child,t!==null)){s.child=null;do s=t.sibling,t.sibling=null,t=s;while(t!==null)}}function Za(t){var s=t.deletions;if((t.flags&16)!==0){if(s!==null)for(var o=0;o<s.length;o++){var l=s[o];tt=l,P0(l,t)}_0(t)}if(t.subtreeFlags&10256)for(t=t.child;t!==null;)D0(t),t=t.sibling}function D0(t){switch(t.tag){case 0:case 11:case 15:Za(t),t.flags&2048&&os(9,t,t.return);break;case 3:Za(t);break;case 12:Za(t);break;case 22:var s=t.stateNode;t.memoizedState!==null&&s._visibility&2&&(t.return===null||t.return.tag!==13)?(s._visibility&=-3,vr(t)):Za(t);break;default:Za(t)}}function vr(t){var s=t.deletions;if((t.flags&16)!==0){if(s!==null)for(var o=0;o<s.length;o++){var l=s[o];tt=l,P0(l,t)}_0(t)}for(t=t.child;t!==null;){switch(s=t,s.tag){case 0:case 11:case 15:os(8,s,s.return),vr(s);break;case 22:o=s.stateNode,o._visibility&2&&(o._visibility&=-3,vr(s));break;default:vr(s)}t=t.sibling}}function P0(t,s){for(;tt!==null;){var o=tt;switch(o.tag){case 0:case 11:case 15:os(8,o,s);break;case 23:case 22:if(o.memoizedState!==null&&o.memoizedState.cachePool!==null){var l=o.memoizedState.cachePool.pool;l!=null&&l.refCount++}break;case 24:_a(o.memoizedState.cache)}if(l=o.child,l!==null)l.return=o,tt=l;else e:for(o=t;tt!==null;){l=tt;var f=l.sibling,p=l.return;if(A0(l),l===o){tt=null;break e}if(f!==null){f.return=p,tt=f;break e}tt=p}}}var Bv={getCacheForType:function(t){var s=ht(Ze),o=s.data.get(t);return o===void 0&&(o=t(),s.data.set(t,o)),o}},Iv=typeof WeakMap=="function"?WeakMap:Map,Ie=0,Ue=null,Me=null,we=0,xe=0,Ut=null,cs=!1,Fn=!1,lu=!1,Fi=0,ze=0,us=0,zs=0,cu=0,Qt=0,Un=0,Qa=null,Et=null,uu=!1,hu=0,br=1/0,Sr=null,hs=null,nt=0,fs=null,Nn=null,Hn=0,fu=0,du=null,L0=null,$a=0,gu=null;function Nt(){if((Ie&2)!==0&&we!==0)return we&-we;if(_.T!==null){var t=En;return t!==0?t:Mu()}return Zh()}function O0(){Qt===0&&(Qt=(we&536870912)===0||Ee?Yh():536870912);var t=Zt.current;return t!==null&&(t.flags|=32),Qt}function Ht(t,s,o){(t===Ue&&(xe===2||xe===9)||t.cancelPendingCommit!==null)&&(Gn(t,0),ds(t,we,Qt,!1)),ma(t,o),((Ie&2)===0||t!==Ue)&&(t===Ue&&((Ie&2)===0&&(zs|=o),ze===4&&ds(t,we,Qt,!1)),mi(t))}function F0(t,s,o){if((Ie&6)!==0)throw Error(n(327));var l=!o&&(s&124)===0&&(s&t.expiredLanes)===0||pa(t,s),f=l?Dv(t,s):yu(t,s,!0),p=l;do{if(f===0){Fn&&!l&&ds(t,s,0,!1);break}else{if(o=t.current.alternate,p&&!xv(o)){f=yu(t,s,!1),p=!1;continue}if(f===2){if(p=s,t.errorRecoveryDisabledLanes&p)var b=0;else b=t.pendingLanes&-536870913,b=b!==0?b:b&536870912?536870912:0;if(b!==0){s=b;e:{var C=t;f=Qa;var E=C.current.memoizedState.isDehydrated;if(E&&(Gn(C,b).flags|=256),b=yu(C,b,!1),b!==2){if(lu&&!E){C.errorRecoveryDisabledLanes|=p,zs|=p,f=4;break e}p=Et,Et=f,p!==null&&(Et===null?Et=p:Et.push.apply(Et,p))}f=b}if(p=!1,f!==2)continue}}if(f===1){Gn(t,0),ds(t,s,0,!0);break}e:{switch(l=t,p=f,p){case 0:case 1:throw Error(n(345));case 4:if((s&4194048)!==s)break;case 6:ds(l,s,Qt,!cs);break e;case 2:Et=null;break;case 3:case 5:break;default:throw Error(n(329))}if((s&62914560)===s&&(f=hu+300-hi(),10<f)){if(ds(l,s,Qt,!cs),xo(l,0,!0)!==0)break e;l.timeoutHandle=fg(U0.bind(null,l,o,Et,Sr,uu,s,Qt,zs,Un,cs,p,2,-0,0),f);break e}U0(l,o,Et,Sr,uu,s,Qt,zs,Un,cs,p,0,-0,0)}}break}while(!0);mi(t)}function U0(t,s,o,l,f,p,b,C,E,O,V,j,F,U){if(t.timeoutHandle=-1,j=s.subtreeFlags,(j&8192||(j&16785408)===16785408)&&(ao={stylesheets:null,count:0,unsuspend:fb},x0(s),j=gb(),j!==null)){t.cancelPendingCommit=j(X0.bind(null,t,s,p,o,l,f,b,C,E,V,1,F,U)),ds(t,p,b,!O);return}X0(t,s,p,o,l,f,b,C,E)}function xv(t){for(var s=t;;){var o=s.tag;if((o===0||o===11||o===15)&&s.flags&16384&&(o=s.updateQueue,o!==null&&(o=o.stores,o!==null)))for(var l=0;l<o.length;l++){var f=o[l],p=f.getSnapshot;f=f.value;try{if(!Pt(p(),f))return!1}catch{return!1}}if(o=s.child,s.subtreeFlags&16384&&o!==null)o.return=s,s=o;else{if(s===t)break;for(;s.sibling===null;){if(s.return===null||s.return===t)return!0;s=s.return}s.sibling.return=s.return,s=s.sibling}}return!0}function ds(t,s,o,l){s&=~cu,s&=~zs,t.suspendedLanes|=s,t.pingedLanes&=~s,l&&(t.warmLanes|=s),l=t.expirationTimes;for(var f=s;0<f;){var p=31-Dt(f),b=1<<p;l[p]=-1,f&=~b}o!==0&&jh(t,o,s)}function Mr(){return(Ie&6)===0?(Ja(0),!1):!0}function pu(){if(Me!==null){if(xe===0)var t=Me.return;else t=Me,Bi=Fs=null,_c(t),Dn=null,za=0,t=Me;for(;t!==null;)y0(t.alternate,t),t=t.return;Me=null}}function Gn(t,s){var o=t.timeoutHandle;o!==-1&&(t.timeoutHandle=-1,Kv(o)),o=t.cancelPendingCommit,o!==null&&(t.cancelPendingCommit=null,o()),pu(),Ue=t,Me=o=ki(t.current,null),we=s,xe=0,Ut=null,cs=!1,Fn=pa(t,s),lu=!1,Un=Qt=cu=zs=us=ze=0,Et=Qa=null,uu=!1,(s&8)!==0&&(s|=s&32);var l=t.entangledLanes;if(l!==0)for(t=t.entanglements,l&=s;0<l;){var f=31-Dt(l),p=1<<f;s|=t[f],l&=~p}return Fi=s,zo(),o}function N0(t,s){be=null,_.H=lr,s===Pa||s===$o?(s=id(),xe=3):s===Jf?(s=id(),xe=4):xe=s===s0?8:s!==null&&typeof s=="object"&&typeof s.then=="function"?6:1,Ut=s,Me===null&&(ze=1,dr(t,Yt(s,t.current)))}function H0(){var t=_.H;return _.H=lr,t===null?lr:t}function G0(){var t=_.A;return _.A=Bv,t}function mu(){ze=4,cs||(we&4194048)!==we&&Zt.current!==null||(Fn=!0),(us&134217727)===0&&(zs&134217727)===0||Ue===null||ds(Ue,we,Qt,!1)}function yu(t,s,o){var l=Ie;Ie|=2;var f=H0(),p=G0();(Ue!==t||we!==s)&&(Sr=null,Gn(t,s)),s=!1;var b=ze;e:do try{if(xe!==0&&Me!==null){var C=Me,E=Ut;switch(xe){case 8:pu(),b=6;break e;case 3:case 2:case 9:case 6:Zt.current===null&&(s=!0);var O=xe;if(xe=0,Ut=null,Wn(t,C,E,O),o&&Fn){b=0;break e}break;default:O=xe,xe=0,Ut=null,Wn(t,C,E,O)}}_v(),b=ze;break}catch(V){N0(t,V)}while(!0);return s&&t.shellSuspendCounter++,Bi=Fs=null,Ie=l,_.H=f,_.A=p,Me===null&&(Ue=null,we=0,zo()),b}function _v(){for(;Me!==null;)W0(Me)}function Dv(t,s){var o=Ie;Ie|=2;var l=H0(),f=G0();Ue!==t||we!==s?(Sr=null,br=hi()+500,Gn(t,s)):Fn=pa(t,s);e:do try{if(xe!==0&&Me!==null){s=Me;var p=Ut;t:switch(xe){case 1:xe=0,Ut=null,Wn(t,s,p,1);break;case 2:case 9:if(ed(p)){xe=0,Ut=null,z0(s);break}s=function(){xe!==2&&xe!==9||Ue!==t||(xe=7),mi(t)},p.then(s,s);break e;case 3:xe=7;break e;case 4:xe=5;break e;case 7:ed(p)?(xe=0,Ut=null,z0(s)):(xe=0,Ut=null,Wn(t,s,p,7));break;case 5:var b=null;switch(Me.tag){case 26:b=Me.memoizedState;case 5:case 27:var C=Me;if(!b||wg(b)){xe=0,Ut=null;var E=C.sibling;if(E!==null)Me=E;else{var O=C.return;O!==null?(Me=O,Tr(O)):Me=null}break t}}xe=0,Ut=null,Wn(t,s,p,5);break;case 6:xe=0,Ut=null,Wn(t,s,p,6);break;case 8:pu(),ze=6;break e;default:throw Error(n(462))}}Pv();break}catch(V){N0(t,V)}while(!0);return Bi=Fs=null,_.H=l,_.A=f,Ie=o,Me!==null?0:(Ue=null,we=0,zo(),ze)}function Pv(){for(;Me!==null&&!iy();)W0(Me)}function W0(t){var s=p0(t.alternate,t,Fi);t.memoizedProps=t.pendingProps,s===null?Tr(t):Me=s}function z0(t){var s=t,o=s.alternate;switch(s.tag){case 15:case 0:s=c0(o,s,s.pendingProps,s.type,void 0,we);break;case 11:s=c0(o,s,s.pendingProps,s.type.render,s.ref,we);break;case 5:_c(s);default:y0(o,s),s=Me=Vf(s,Fi),s=p0(o,s,Fi)}t.memoizedProps=t.pendingProps,s===null?Tr(t):Me=s}function Wn(t,s,o,l){Bi=Fs=null,_c(s),Dn=null,za=0;var f=s.return;try{if(Cv(t,f,s,o,we)){ze=1,dr(t,Yt(o,t.current)),Me=null;return}}catch(p){if(f!==null)throw Me=f,p;ze=1,dr(t,Yt(o,t.current)),Me=null;return}s.flags&32768?(Ee||l===1?t=!0:Fn||(we&536870912)!==0?t=!1:(cs=t=!0,(l===2||l===9||l===3||l===6)&&(l=Zt.current,l!==null&&l.tag===13&&(l.flags|=16384))),V0(s,t)):Tr(s)}function Tr(t){var s=t;do{if((s.flags&32768)!==0){V0(s,cs);return}t=s.return;var o=Av(s.alternate,s,Fi);if(o!==null){Me=o;return}if(s=s.sibling,s!==null){Me=s;return}Me=s=t}while(s!==null);ze===0&&(ze=5)}function V0(t,s){do{var o=kv(t.alternate,t);if(o!==null){o.flags&=32767,Me=o;return}if(o=t.return,o!==null&&(o.flags|=32768,o.subtreeFlags=0,o.deletions=null),!s&&(t=t.sibling,t!==null)){Me=t;return}Me=t=o}while(t!==null);ze=6,Me=null}function X0(t,s,o,l,f,p,b,C,E){t.cancelPendingCommit=null;do Cr();while(nt!==0);if((Ie&6)!==0)throw Error(n(327));if(s!==null){if(s===t.current)throw Error(n(177));if(p=s.lanes|s.childLanes,p|=rc,fy(t,o,p,b,C,E),t===Ue&&(Me=Ue=null,we=0),Nn=s,fs=t,Hn=o,fu=p,du=f,L0=l,(s.subtreeFlags&10256)!==0||(s.flags&10256)!==0?(t.callbackNode=null,t.callbackPriority=0,Uv(Ro,function(){return Z0(),null})):(t.callbackNode=null,t.callbackPriority=0),l=(s.flags&13878)!==0,(s.subtreeFlags&13878)!==0||l){l=_.T,_.T=null,f=X.p,X.p=2,b=Ie,Ie|=4;try{Ev(t,s,o)}finally{Ie=b,X.p=f,_.T=l}}nt=1,Y0(),q0(),j0()}}function Y0(){if(nt===1){nt=0;var t=fs,s=Nn,o=(s.flags&13878)!==0;if((s.subtreeFlags&13878)!==0||o){o=_.T,_.T=null;var l=X.p;X.p=2;var f=Ie;Ie|=4;try{R0(s,t);var p=Bu,b=Pf(t.containerInfo),C=p.focusedElem,E=p.selectionRange;if(b!==C&&C&&C.ownerDocument&&Df(C.ownerDocument.documentElement,C)){if(E!==null&&ic(C)){var O=E.start,V=E.end;if(V===void 0&&(V=O),"selectionStart"in C)C.selectionStart=O,C.selectionEnd=Math.min(V,C.value.length);else{var j=C.ownerDocument||document,F=j&&j.defaultView||window;if(F.getSelection){var U=F.getSelection(),ge=C.textContent.length,fe=Math.min(E.start,ge),Le=E.end===void 0?fe:Math.min(E.end,ge);!U.extend&&fe>Le&&(b=Le,Le=fe,fe=b);var D=_f(C,fe),B=_f(C,Le);if(D&&B&&(U.rangeCount!==1||U.anchorNode!==D.node||U.anchorOffset!==D.offset||U.focusNode!==B.node||U.focusOffset!==B.offset)){var L=j.createRange();L.setStart(D.node,D.offset),U.removeAllRanges(),fe>Le?(U.addRange(L),U.extend(B.node,B.offset)):(L.setEnd(B.node,B.offset),U.addRange(L))}}}}for(j=[],U=C;U=U.parentNode;)U.nodeType===1&&j.push({element:U,left:U.scrollLeft,top:U.scrollTop});for(typeof C.focus=="function"&&C.focus(),C=0;C<j.length;C++){var Y=j[C];Y.element.scrollLeft=Y.left,Y.element.scrollTop=Y.top}}Lr=!!Ru,Bu=Ru=null}finally{Ie=f,X.p=l,_.T=o}}t.current=s,nt=2}}function q0(){if(nt===2){nt=0;var t=fs,s=Nn,o=(s.flags&8772)!==0;if((s.subtreeFlags&8772)!==0||o){o=_.T,_.T=null;var l=X.p;X.p=2;var f=Ie;Ie|=4;try{w0(t,s.alternate,s)}finally{Ie=f,X.p=l,_.T=o}}nt=3}}function j0(){if(nt===4||nt===3){nt=0,sy();var t=fs,s=Nn,o=Hn,l=L0;(s.subtreeFlags&10256)!==0||(s.flags&10256)!==0?nt=5:(nt=0,Nn=fs=null,K0(t,t.pendingLanes));var f=t.pendingLanes;if(f===0&&(hs=null),Ll(o),s=s.stateNode,_t&&typeof _t.onCommitFiberRoot=="function")try{_t.onCommitFiberRoot(ga,s,void 0,(s.current.flags&128)===128)}catch{}if(l!==null){s=_.T,f=X.p,X.p=2,_.T=null;try{for(var p=t.onRecoverableError,b=0;b<l.length;b++){var C=l[b];p(C.value,{componentStack:C.stack})}}finally{_.T=s,X.p=f}}(Hn&3)!==0&&Cr(),mi(t),f=t.pendingLanes,(o&4194090)!==0&&(f&42)!==0?t===gu?$a++:($a=0,gu=t):$a=0,Ja(0)}}function K0(t,s){(t.pooledCacheLanes&=s)===0&&(s=t.pooledCache,s!=null&&(t.pooledCache=null,_a(s)))}function Cr(t){return Y0(),q0(),j0(),Z0()}function Z0(){if(nt!==5)return!1;var t=fs,s=fu;fu=0;var o=Ll(Hn),l=_.T,f=X.p;try{X.p=32>o?32:o,_.T=null,o=du,du=null;var p=fs,b=Hn;if(nt=0,Nn=fs=null,Hn=0,(Ie&6)!==0)throw Error(n(331));var C=Ie;if(Ie|=4,D0(p.current),I0(p,p.current,b,o),Ie=C,Ja(0,!1),_t&&typeof _t.onPostCommitFiberRoot=="function")try{_t.onPostCommitFiberRoot(ga,p)}catch{}return!0}finally{X.p=f,_.T=l,K0(t,s)}}function Q0(t,s,o){s=Yt(o,s),s=Yc(t.stateNode,s,2),t=is(t,s,2),t!==null&&(ma(t,2),mi(t))}function Oe(t,s,o){if(t.tag===3)Q0(t,t,o);else for(;s!==null;){if(s.tag===3){Q0(s,t,o);break}else if(s.tag===1){var l=s.stateNode;if(typeof s.type.getDerivedStateFromError=="function"||typeof l.componentDidCatch=="function"&&(hs===null||!hs.has(l))){t=Yt(o,t),o=t0(2),l=is(s,o,2),l!==null&&(i0(o,l,s,t),ma(l,2),mi(l));break}}s=s.return}}function vu(t,s,o){var l=t.pingCache;if(l===null){l=t.pingCache=new Iv;var f=new Set;l.set(s,f)}else f=l.get(s),f===void 0&&(f=new Set,l.set(s,f));f.has(o)||(lu=!0,f.add(o),t=Lv.bind(null,t,s,o),s.then(t,t))}function Lv(t,s,o){var l=t.pingCache;l!==null&&l.delete(s),t.pingedLanes|=t.suspendedLanes&o,t.warmLanes&=~o,Ue===t&&(we&o)===o&&(ze===4||ze===3&&(we&62914560)===we&&300>hi()-hu?(Ie&2)===0&&Gn(t,0):cu|=o,Un===we&&(Un=0)),mi(t)}function $0(t,s){s===0&&(s=qh()),t=Cn(t,s),t!==null&&(ma(t,s),mi(t))}function Ov(t){var s=t.memoizedState,o=0;s!==null&&(o=s.retryLane),$0(t,o)}function Fv(t,s){var o=0;switch(t.tag){case 13:var l=t.stateNode,f=t.memoizedState;f!==null&&(o=f.retryLane);break;case 19:l=t.stateNode;break;case 22:l=t.stateNode._retryCache;break;default:throw Error(n(314))}l!==null&&l.delete(s),$0(t,o)}function Uv(t,s){return xl(t,s)}var wr=null,zn=null,bu=!1,Ar=!1,Su=!1,Vs=0;function mi(t){t!==zn&&t.next===null&&(zn===null?wr=zn=t:zn=zn.next=t),Ar=!0,bu||(bu=!0,Hv())}function Ja(t,s){if(!Su&&Ar){Su=!0;do for(var o=!1,l=wr;l!==null;){if(t!==0){var f=l.pendingLanes;if(f===0)var p=0;else{var b=l.suspendedLanes,C=l.pingedLanes;p=(1<<31-Dt(42|t)+1)-1,p&=f&~(b&~C),p=p&201326741?p&201326741|1:p?p|2:0}p!==0&&(o=!0,ig(l,p))}else p=we,p=xo(l,l===Ue?p:0,l.cancelPendingCommit!==null||l.timeoutHandle!==-1),(p&3)===0||pa(l,p)||(o=!0,ig(l,p));l=l.next}while(o);Su=!1}}function Nv(){J0()}function J0(){Ar=bu=!1;var t=0;Vs!==0&&(jv()&&(t=Vs),Vs=0);for(var s=hi(),o=null,l=wr;l!==null;){var f=l.next,p=eg(l,s);p===0?(l.next=null,o===null?wr=f:o.next=f,f===null&&(zn=o)):(o=l,(t!==0||(p&3)!==0)&&(Ar=!0)),l=f}Ja(t)}function eg(t,s){for(var o=t.suspendedLanes,l=t.pingedLanes,f=t.expirationTimes,p=t.pendingLanes&-62914561;0<p;){var b=31-Dt(p),C=1<<b,E=f[b];E===-1?((C&o)===0||(C&l)!==0)&&(f[b]=hy(C,s)):E<=s&&(t.expiredLanes|=C),p&=~C}if(s=Ue,o=we,o=xo(t,t===s?o:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),l=t.callbackNode,o===0||t===s&&(xe===2||xe===9)||t.cancelPendingCommit!==null)return l!==null&&l!==null&&_l(l),t.callbackNode=null,t.callbackPriority=0;if((o&3)===0||pa(t,o)){if(s=o&-o,s===t.callbackPriority)return s;switch(l!==null&&_l(l),Ll(o)){case 2:case 8:o=Vh;break;case 32:o=Ro;break;case 268435456:o=Xh;break;default:o=Ro}return l=tg.bind(null,t),o=xl(o,l),t.callbackPriority=s,t.callbackNode=o,s}return l!==null&&l!==null&&_l(l),t.callbackPriority=2,t.callbackNode=null,2}function tg(t,s){if(nt!==0&&nt!==5)return t.callbackNode=null,t.callbackPriority=0,null;var o=t.callbackNode;if(Cr()&&t.callbackNode!==o)return null;var l=we;return l=xo(t,t===Ue?l:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),l===0?null:(F0(t,l,s),eg(t,hi()),t.callbackNode!=null&&t.callbackNode===o?tg.bind(null,t):null)}function ig(t,s){if(Cr())return null;F0(t,s,!0)}function Hv(){Zv(function(){(Ie&6)!==0?xl(zh,Nv):J0()})}function Mu(){return Vs===0&&(Vs=Yh()),Vs}function sg(t){return t==null||typeof t=="symbol"||typeof t=="boolean"?null:typeof t=="function"?t:Oo(""+t)}function ng(t,s){var o=s.ownerDocument.createElement("input");return o.name=s.name,o.value=s.value,t.id&&o.setAttribute("form",t.id),s.parentNode.insertBefore(o,s),t=new FormData(t),o.parentNode.removeChild(o),t}function Gv(t,s,o,l,f){if(s==="submit"&&o&&o.stateNode===f){var p=sg((f[Ct]||null).action),b=l.submitter;b&&(s=(s=b[Ct]||null)?sg(s.formAction):b.getAttribute("formAction"),s!==null&&(p=s,b=null));var C=new Ho("action","action",null,l,f);t.push({event:C,listeners:[{instance:null,listener:function(){if(l.defaultPrevented){if(Vs!==0){var E=b?ng(f,b):new FormData(f);Gc(o,{pending:!0,data:E,method:f.method,action:p},null,E)}}else typeof p=="function"&&(C.preventDefault(),E=b?ng(f,b):new FormData(f),Gc(o,{pending:!0,data:E,method:f.method,action:p},p,E))},currentTarget:f}]})}}for(var Tu=0;Tu<oc.length;Tu++){var Cu=oc[Tu],Wv=Cu.toLowerCase(),zv=Cu[0].toUpperCase()+Cu.slice(1);ai(Wv,"on"+zv)}ai(Ff,"onAnimationEnd"),ai(Uf,"onAnimationIteration"),ai(Nf,"onAnimationStart"),ai("dblclick","onDoubleClick"),ai("focusin","onFocus"),ai("focusout","onBlur"),ai(ov,"onTransitionRun"),ai(rv,"onTransitionStart"),ai(lv,"onTransitionCancel"),ai(Hf,"onTransitionEnd"),dn("onMouseEnter",["mouseout","mouseover"]),dn("onMouseLeave",["mouseout","mouseover"]),dn("onPointerEnter",["pointerout","pointerover"]),dn("onPointerLeave",["pointerout","pointerover"]),Rs("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Rs("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Rs("onBeforeInput",["compositionend","keypress","textInput","paste"]),Rs("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Rs("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Rs("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var eo="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Vv=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(eo));function ag(t,s){s=(s&4)!==0;for(var o=0;o<t.length;o++){var l=t[o],f=l.event;l=l.listeners;e:{var p=void 0;if(s)for(var b=l.length-1;0<=b;b--){var C=l[b],E=C.instance,O=C.currentTarget;if(C=C.listener,E!==p&&f.isPropagationStopped())break e;p=C,f.currentTarget=O;try{p(f)}catch(V){fr(V)}f.currentTarget=null,p=E}else for(b=0;b<l.length;b++){if(C=l[b],E=C.instance,O=C.currentTarget,C=C.listener,E!==p&&f.isPropagationStopped())break e;p=C,f.currentTarget=O;try{p(f)}catch(V){fr(V)}f.currentTarget=null,p=E}}}}function Te(t,s){var o=s[Ol];o===void 0&&(o=s[Ol]=new Set);var l=t+"__bubble";o.has(l)||(og(s,t,2,!1),o.add(l))}function wu(t,s,o){var l=0;s&&(l|=4),og(o,t,l,s)}var kr="_reactListening"+Math.random().toString(36).slice(2);function Au(t){if(!t[kr]){t[kr]=!0,$h.forEach(function(o){o!=="selectionchange"&&(Vv.has(o)||wu(o,!1,t),wu(o,!0,t))});var s=t.nodeType===9?t:t.ownerDocument;s===null||s[kr]||(s[kr]=!0,wu("selectionchange",!1,s))}}function og(t,s,o,l){switch(Ig(s)){case 2:var f=yb;break;case 8:f=vb;break;default:f=Nu}o=f.bind(null,s,o,t),f=void 0,!ql||s!=="touchstart"&&s!=="touchmove"&&s!=="wheel"||(f=!0),l?f!==void 0?t.addEventListener(s,o,{capture:!0,passive:f}):t.addEventListener(s,o,!0):f!==void 0?t.addEventListener(s,o,{passive:f}):t.addEventListener(s,o,!1)}function ku(t,s,o,l,f){var p=l;if((s&1)===0&&(s&2)===0&&l!==null)e:for(;;){if(l===null)return;var b=l.tag;if(b===3||b===4){var C=l.stateNode.containerInfo;if(C===f)break;if(b===4)for(b=l.return;b!==null;){var E=b.tag;if((E===3||E===4)&&b.stateNode.containerInfo===f)return;b=b.return}for(;C!==null;){if(b=un(C),b===null)return;if(E=b.tag,E===5||E===6||E===26||E===27){l=p=b;continue e}C=C.parentNode}}l=l.return}df(function(){var O=p,V=Xl(o),j=[];e:{var F=Gf.get(t);if(F!==void 0){var U=Ho,ge=t;switch(t){case"keypress":if(Uo(o)===0)break e;case"keydown":case"keyup":U=Uy;break;case"focusin":ge="focus",U=Ql;break;case"focusout":ge="blur",U=Ql;break;case"beforeblur":case"afterblur":U=Ql;break;case"click":if(o.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":U=mf;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":U=ky;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":U=Gy;break;case Ff:case Uf:case Nf:U=By;break;case Hf:U=zy;break;case"scroll":case"scrollend":U=wy;break;case"wheel":U=Xy;break;case"copy":case"cut":case"paste":U=xy;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":U=vf;break;case"toggle":case"beforetoggle":U=qy}var fe=(s&4)!==0,Le=!fe&&(t==="scroll"||t==="scrollend"),D=fe?F!==null?F+"Capture":null:F;fe=[];for(var B=O,L;B!==null;){var Y=B;if(L=Y.stateNode,Y=Y.tag,Y!==5&&Y!==26&&Y!==27||L===null||D===null||(Y=ba(B,D),Y!=null&&fe.push(to(B,Y,L))),Le)break;B=B.return}0<fe.length&&(F=new U(F,ge,null,o,V),j.push({event:F,listeners:fe}))}}if((s&7)===0){e:{if(F=t==="mouseover"||t==="pointerover",U=t==="mouseout"||t==="pointerout",F&&o!==Vl&&(ge=o.relatedTarget||o.fromElement)&&(un(ge)||ge[cn]))break e;if((U||F)&&(F=V.window===V?V:(F=V.ownerDocument)?F.defaultView||F.parentWindow:window,U?(ge=o.relatedTarget||o.toElement,U=O,ge=ge?un(ge):null,ge!==null&&(Le=c(ge),fe=ge.tag,ge!==Le||fe!==5&&fe!==27&&fe!==6)&&(ge=null)):(U=null,ge=O),U!==ge)){if(fe=mf,Y="onMouseLeave",D="onMouseEnter",B="mouse",(t==="pointerout"||t==="pointerover")&&(fe=vf,Y="onPointerLeave",D="onPointerEnter",B="pointer"),Le=U==null?F:va(U),L=ge==null?F:va(ge),F=new fe(Y,B+"leave",U,o,V),F.target=Le,F.relatedTarget=L,Y=null,un(V)===O&&(fe=new fe(D,B+"enter",ge,o,V),fe.target=L,fe.relatedTarget=Le,Y=fe),Le=Y,U&&ge)t:{for(fe=U,D=ge,B=0,L=fe;L;L=Vn(L))B++;for(L=0,Y=D;Y;Y=Vn(Y))L++;for(;0<B-L;)fe=Vn(fe),B--;for(;0<L-B;)D=Vn(D),L--;for(;B--;){if(fe===D||D!==null&&fe===D.alternate)break t;fe=Vn(fe),D=Vn(D)}fe=null}else fe=null;U!==null&&rg(j,F,U,fe,!1),ge!==null&&Le!==null&&rg(j,Le,ge,fe,!0)}}e:{if(F=O?va(O):window,U=F.nodeName&&F.nodeName.toLowerCase(),U==="select"||U==="input"&&F.type==="file")var le=kf;else if(wf(F))if(Ef)le=sv;else{le=tv;var Se=ev}else U=F.nodeName,!U||U.toLowerCase()!=="input"||F.type!=="checkbox"&&F.type!=="radio"?O&&zl(O.elementType)&&(le=kf):le=iv;if(le&&(le=le(t,O))){Af(j,le,o,V);break e}Se&&Se(t,F,O),t==="focusout"&&O&&F.type==="number"&&O.memoizedProps.value!=null&&Wl(F,"number",F.value)}switch(Se=O?va(O):window,t){case"focusin":(wf(Se)||Se.contentEditable==="true")&&(Sn=Se,sc=O,Ea=null);break;case"focusout":Ea=sc=Sn=null;break;case"mousedown":nc=!0;break;case"contextmenu":case"mouseup":case"dragend":nc=!1,Lf(j,o,V);break;case"selectionchange":if(av)break;case"keydown":case"keyup":Lf(j,o,V)}var ce;if(Jl)e:{switch(t){case"compositionstart":var de="onCompositionStart";break e;case"compositionend":de="onCompositionEnd";break e;case"compositionupdate":de="onCompositionUpdate";break e}de=void 0}else bn?Tf(t,o)&&(de="onCompositionEnd"):t==="keydown"&&o.keyCode===229&&(de="onCompositionStart");de&&(bf&&o.locale!=="ko"&&(bn||de!=="onCompositionStart"?de==="onCompositionEnd"&&bn&&(ce=gf()):($i=V,jl="value"in $i?$i.value:$i.textContent,bn=!0)),Se=Er(O,de),0<Se.length&&(de=new yf(de,t,null,o,V),j.push({event:de,listeners:Se}),ce?de.data=ce:(ce=Cf(o),ce!==null&&(de.data=ce)))),(ce=Ky?Zy(t,o):Qy(t,o))&&(de=Er(O,"onBeforeInput"),0<de.length&&(Se=new yf("onBeforeInput","beforeinput",null,o,V),j.push({event:Se,listeners:de}),Se.data=ce)),Gv(j,t,O,o,V)}ag(j,s)})}function to(t,s,o){return{instance:t,listener:s,currentTarget:o}}function Er(t,s){for(var o=s+"Capture",l=[];t!==null;){var f=t,p=f.stateNode;if(f=f.tag,f!==5&&f!==26&&f!==27||p===null||(f=ba(t,o),f!=null&&l.unshift(to(t,f,p)),f=ba(t,s),f!=null&&l.push(to(t,f,p))),t.tag===3)return l;t=t.return}return[]}function Vn(t){if(t===null)return null;do t=t.return;while(t&&t.tag!==5&&t.tag!==27);return t||null}function rg(t,s,o,l,f){for(var p=s._reactName,b=[];o!==null&&o!==l;){var C=o,E=C.alternate,O=C.stateNode;if(C=C.tag,E!==null&&E===l)break;C!==5&&C!==26&&C!==27||O===null||(E=O,f?(O=ba(o,p),O!=null&&b.unshift(to(o,O,E))):f||(O=ba(o,p),O!=null&&b.push(to(o,O,E)))),o=o.return}b.length!==0&&t.push({event:s,listeners:b})}var Xv=/\r\n?/g,Yv=/\u0000|\uFFFD/g;function lg(t){return(typeof t=="string"?t:""+t).replace(Xv,`
`).replace(Yv,"")}function cg(t,s){return s=lg(s),lg(t)===s}function Rr(){}function Pe(t,s,o,l,f,p){switch(o){case"children":typeof l=="string"?s==="body"||s==="textarea"&&l===""||mn(t,l):(typeof l=="number"||typeof l=="bigint")&&s!=="body"&&mn(t,""+l);break;case"className":Do(t,"class",l);break;case"tabIndex":Do(t,"tabindex",l);break;case"dir":case"role":case"viewBox":case"width":case"height":Do(t,o,l);break;case"style":hf(t,l,p);break;case"data":if(s!=="object"){Do(t,"data",l);break}case"src":case"href":if(l===""&&(s!=="a"||o!=="href")){t.removeAttribute(o);break}if(l==null||typeof l=="function"||typeof l=="symbol"||typeof l=="boolean"){t.removeAttribute(o);break}l=Oo(""+l),t.setAttribute(o,l);break;case"action":case"formAction":if(typeof l=="function"){t.setAttribute(o,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof p=="function"&&(o==="formAction"?(s!=="input"&&Pe(t,s,"name",f.name,f,null),Pe(t,s,"formEncType",f.formEncType,f,null),Pe(t,s,"formMethod",f.formMethod,f,null),Pe(t,s,"formTarget",f.formTarget,f,null)):(Pe(t,s,"encType",f.encType,f,null),Pe(t,s,"method",f.method,f,null),Pe(t,s,"target",f.target,f,null)));if(l==null||typeof l=="symbol"||typeof l=="boolean"){t.removeAttribute(o);break}l=Oo(""+l),t.setAttribute(o,l);break;case"onClick":l!=null&&(t.onclick=Rr);break;case"onScroll":l!=null&&Te("scroll",t);break;case"onScrollEnd":l!=null&&Te("scrollend",t);break;case"dangerouslySetInnerHTML":if(l!=null){if(typeof l!="object"||!("__html"in l))throw Error(n(61));if(o=l.__html,o!=null){if(f.children!=null)throw Error(n(60));t.innerHTML=o}}break;case"multiple":t.multiple=l&&typeof l!="function"&&typeof l!="symbol";break;case"muted":t.muted=l&&typeof l!="function"&&typeof l!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(l==null||typeof l=="function"||typeof l=="boolean"||typeof l=="symbol"){t.removeAttribute("xlink:href");break}o=Oo(""+l),t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",o);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":l!=null&&typeof l!="function"&&typeof l!="symbol"?t.setAttribute(o,""+l):t.removeAttribute(o);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":l&&typeof l!="function"&&typeof l!="symbol"?t.setAttribute(o,""):t.removeAttribute(o);break;case"capture":case"download":l===!0?t.setAttribute(o,""):l!==!1&&l!=null&&typeof l!="function"&&typeof l!="symbol"?t.setAttribute(o,l):t.removeAttribute(o);break;case"cols":case"rows":case"size":case"span":l!=null&&typeof l!="function"&&typeof l!="symbol"&&!isNaN(l)&&1<=l?t.setAttribute(o,l):t.removeAttribute(o);break;case"rowSpan":case"start":l==null||typeof l=="function"||typeof l=="symbol"||isNaN(l)?t.removeAttribute(o):t.setAttribute(o,l);break;case"popover":Te("beforetoggle",t),Te("toggle",t),_o(t,"popover",l);break;case"xlinkActuate":wi(t,"http://www.w3.org/1999/xlink","xlink:actuate",l);break;case"xlinkArcrole":wi(t,"http://www.w3.org/1999/xlink","xlink:arcrole",l);break;case"xlinkRole":wi(t,"http://www.w3.org/1999/xlink","xlink:role",l);break;case"xlinkShow":wi(t,"http://www.w3.org/1999/xlink","xlink:show",l);break;case"xlinkTitle":wi(t,"http://www.w3.org/1999/xlink","xlink:title",l);break;case"xlinkType":wi(t,"http://www.w3.org/1999/xlink","xlink:type",l);break;case"xmlBase":wi(t,"http://www.w3.org/XML/1998/namespace","xml:base",l);break;case"xmlLang":wi(t,"http://www.w3.org/XML/1998/namespace","xml:lang",l);break;case"xmlSpace":wi(t,"http://www.w3.org/XML/1998/namespace","xml:space",l);break;case"is":_o(t,"is",l);break;case"innerText":case"textContent":break;default:(!(2<o.length)||o[0]!=="o"&&o[0]!=="O"||o[1]!=="n"&&o[1]!=="N")&&(o=Ty.get(o)||o,_o(t,o,l))}}function Eu(t,s,o,l,f,p){switch(o){case"style":hf(t,l,p);break;case"dangerouslySetInnerHTML":if(l!=null){if(typeof l!="object"||!("__html"in l))throw Error(n(61));if(o=l.__html,o!=null){if(f.children!=null)throw Error(n(60));t.innerHTML=o}}break;case"children":typeof l=="string"?mn(t,l):(typeof l=="number"||typeof l=="bigint")&&mn(t,""+l);break;case"onScroll":l!=null&&Te("scroll",t);break;case"onScrollEnd":l!=null&&Te("scrollend",t);break;case"onClick":l!=null&&(t.onclick=Rr);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!Jh.hasOwnProperty(o))e:{if(o[0]==="o"&&o[1]==="n"&&(f=o.endsWith("Capture"),s=o.slice(2,f?o.length-7:void 0),p=t[Ct]||null,p=p!=null?p[o]:null,typeof p=="function"&&t.removeEventListener(s,p,f),typeof l=="function")){typeof p!="function"&&p!==null&&(o in t?t[o]=null:t.hasAttribute(o)&&t.removeAttribute(o)),t.addEventListener(s,l,f);break e}o in t?t[o]=l:l===!0?t.setAttribute(o,""):_o(t,o,l)}}}function at(t,s,o){switch(s){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Te("error",t),Te("load",t);var l=!1,f=!1,p;for(p in o)if(o.hasOwnProperty(p)){var b=o[p];if(b!=null)switch(p){case"src":l=!0;break;case"srcSet":f=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(n(137,s));default:Pe(t,s,p,b,o,null)}}f&&Pe(t,s,"srcSet",o.srcSet,o,null),l&&Pe(t,s,"src",o.src,o,null);return;case"input":Te("invalid",t);var C=p=b=f=null,E=null,O=null;for(l in o)if(o.hasOwnProperty(l)){var V=o[l];if(V!=null)switch(l){case"name":f=V;break;case"type":b=V;break;case"checked":E=V;break;case"defaultChecked":O=V;break;case"value":p=V;break;case"defaultValue":C=V;break;case"children":case"dangerouslySetInnerHTML":if(V!=null)throw Error(n(137,s));break;default:Pe(t,s,l,V,o,null)}}rf(t,p,C,E,O,b,f,!1),Po(t);return;case"select":Te("invalid",t),l=b=p=null;for(f in o)if(o.hasOwnProperty(f)&&(C=o[f],C!=null))switch(f){case"value":p=C;break;case"defaultValue":b=C;break;case"multiple":l=C;default:Pe(t,s,f,C,o,null)}s=p,o=b,t.multiple=!!l,s!=null?pn(t,!!l,s,!1):o!=null&&pn(t,!!l,o,!0);return;case"textarea":Te("invalid",t),p=f=l=null;for(b in o)if(o.hasOwnProperty(b)&&(C=o[b],C!=null))switch(b){case"value":l=C;break;case"defaultValue":f=C;break;case"children":p=C;break;case"dangerouslySetInnerHTML":if(C!=null)throw Error(n(91));break;default:Pe(t,s,b,C,o,null)}cf(t,l,f,p),Po(t);return;case"option":for(E in o)if(o.hasOwnProperty(E)&&(l=o[E],l!=null))switch(E){case"selected":t.selected=l&&typeof l!="function"&&typeof l!="symbol";break;default:Pe(t,s,E,l,o,null)}return;case"dialog":Te("beforetoggle",t),Te("toggle",t),Te("cancel",t),Te("close",t);break;case"iframe":case"object":Te("load",t);break;case"video":case"audio":for(l=0;l<eo.length;l++)Te(eo[l],t);break;case"image":Te("error",t),Te("load",t);break;case"details":Te("toggle",t);break;case"embed":case"source":case"link":Te("error",t),Te("load",t);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(O in o)if(o.hasOwnProperty(O)&&(l=o[O],l!=null))switch(O){case"children":case"dangerouslySetInnerHTML":throw Error(n(137,s));default:Pe(t,s,O,l,o,null)}return;default:if(zl(s)){for(V in o)o.hasOwnProperty(V)&&(l=o[V],l!==void 0&&Eu(t,s,V,l,o,void 0));return}}for(C in o)o.hasOwnProperty(C)&&(l=o[C],l!=null&&Pe(t,s,C,l,o,null))}function qv(t,s,o,l){switch(s){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var f=null,p=null,b=null,C=null,E=null,O=null,V=null;for(U in o){var j=o[U];if(o.hasOwnProperty(U)&&j!=null)switch(U){case"checked":break;case"value":break;case"defaultValue":E=j;default:l.hasOwnProperty(U)||Pe(t,s,U,null,l,j)}}for(var F in l){var U=l[F];if(j=o[F],l.hasOwnProperty(F)&&(U!=null||j!=null))switch(F){case"type":p=U;break;case"name":f=U;break;case"checked":O=U;break;case"defaultChecked":V=U;break;case"value":b=U;break;case"defaultValue":C=U;break;case"children":case"dangerouslySetInnerHTML":if(U!=null)throw Error(n(137,s));break;default:U!==j&&Pe(t,s,F,U,l,j)}}Gl(t,b,C,E,O,V,p,f);return;case"select":U=b=C=F=null;for(p in o)if(E=o[p],o.hasOwnProperty(p)&&E!=null)switch(p){case"value":break;case"multiple":U=E;default:l.hasOwnProperty(p)||Pe(t,s,p,null,l,E)}for(f in l)if(p=l[f],E=o[f],l.hasOwnProperty(f)&&(p!=null||E!=null))switch(f){case"value":F=p;break;case"defaultValue":C=p;break;case"multiple":b=p;default:p!==E&&Pe(t,s,f,p,l,E)}s=C,o=b,l=U,F!=null?pn(t,!!o,F,!1):!!l!=!!o&&(s!=null?pn(t,!!o,s,!0):pn(t,!!o,o?[]:"",!1));return;case"textarea":U=F=null;for(C in o)if(f=o[C],o.hasOwnProperty(C)&&f!=null&&!l.hasOwnProperty(C))switch(C){case"value":break;case"children":break;default:Pe(t,s,C,null,l,f)}for(b in l)if(f=l[b],p=o[b],l.hasOwnProperty(b)&&(f!=null||p!=null))switch(b){case"value":F=f;break;case"defaultValue":U=f;break;case"children":break;case"dangerouslySetInnerHTML":if(f!=null)throw Error(n(91));break;default:f!==p&&Pe(t,s,b,f,l,p)}lf(t,F,U);return;case"option":for(var ge in o)if(F=o[ge],o.hasOwnProperty(ge)&&F!=null&&!l.hasOwnProperty(ge))switch(ge){case"selected":t.selected=!1;break;default:Pe(t,s,ge,null,l,F)}for(E in l)if(F=l[E],U=o[E],l.hasOwnProperty(E)&&F!==U&&(F!=null||U!=null))switch(E){case"selected":t.selected=F&&typeof F!="function"&&typeof F!="symbol";break;default:Pe(t,s,E,F,l,U)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var fe in o)F=o[fe],o.hasOwnProperty(fe)&&F!=null&&!l.hasOwnProperty(fe)&&Pe(t,s,fe,null,l,F);for(O in l)if(F=l[O],U=o[O],l.hasOwnProperty(O)&&F!==U&&(F!=null||U!=null))switch(O){case"children":case"dangerouslySetInnerHTML":if(F!=null)throw Error(n(137,s));break;default:Pe(t,s,O,F,l,U)}return;default:if(zl(s)){for(var Le in o)F=o[Le],o.hasOwnProperty(Le)&&F!==void 0&&!l.hasOwnProperty(Le)&&Eu(t,s,Le,void 0,l,F);for(V in l)F=l[V],U=o[V],!l.hasOwnProperty(V)||F===U||F===void 0&&U===void 0||Eu(t,s,V,F,l,U);return}}for(var D in o)F=o[D],o.hasOwnProperty(D)&&F!=null&&!l.hasOwnProperty(D)&&Pe(t,s,D,null,l,F);for(j in l)F=l[j],U=o[j],!l.hasOwnProperty(j)||F===U||F==null&&U==null||Pe(t,s,j,F,l,U)}var Ru=null,Bu=null;function Br(t){return t.nodeType===9?t:t.ownerDocument}function ug(t){switch(t){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function hg(t,s){if(t===0)switch(s){case"svg":return 1;case"math":return 2;default:return 0}return t===1&&s==="foreignObject"?0:t}function Iu(t,s){return t==="textarea"||t==="noscript"||typeof s.children=="string"||typeof s.children=="number"||typeof s.children=="bigint"||typeof s.dangerouslySetInnerHTML=="object"&&s.dangerouslySetInnerHTML!==null&&s.dangerouslySetInnerHTML.__html!=null}var xu=null;function jv(){var t=window.event;return t&&t.type==="popstate"?t===xu?!1:(xu=t,!0):(xu=null,!1)}var fg=typeof setTimeout=="function"?setTimeout:void 0,Kv=typeof clearTimeout=="function"?clearTimeout:void 0,dg=typeof Promise=="function"?Promise:void 0,Zv=typeof queueMicrotask=="function"?queueMicrotask:typeof dg<"u"?function(t){return dg.resolve(null).then(t).catch(Qv)}:fg;function Qv(t){setTimeout(function(){throw t})}function gs(t){return t==="head"}function gg(t,s){var o=s,l=0,f=0;do{var p=o.nextSibling;if(t.removeChild(o),p&&p.nodeType===8)if(o=p.data,o==="/$"){if(0<l&&8>l){o=l;var b=t.ownerDocument;if(o&1&&io(b.documentElement),o&2&&io(b.body),o&4)for(o=b.head,io(o),b=o.firstChild;b;){var C=b.nextSibling,E=b.nodeName;b[ya]||E==="SCRIPT"||E==="STYLE"||E==="LINK"&&b.rel.toLowerCase()==="stylesheet"||o.removeChild(b),b=C}}if(f===0){t.removeChild(p),uo(s);return}f--}else o==="$"||o==="$?"||o==="$!"?f++:l=o.charCodeAt(0)-48;else l=0;o=p}while(o);uo(s)}function _u(t){var s=t.firstChild;for(s&&s.nodeType===10&&(s=s.nextSibling);s;){var o=s;switch(s=s.nextSibling,o.nodeName){case"HTML":case"HEAD":case"BODY":_u(o),Fl(o);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(o.rel.toLowerCase()==="stylesheet")continue}t.removeChild(o)}}function $v(t,s,o,l){for(;t.nodeType===1;){var f=o;if(t.nodeName.toLowerCase()!==s.toLowerCase()){if(!l&&(t.nodeName!=="INPUT"||t.type!=="hidden"))break}else if(l){if(!t[ya])switch(s){case"meta":if(!t.hasAttribute("itemprop"))break;return t;case"link":if(p=t.getAttribute("rel"),p==="stylesheet"&&t.hasAttribute("data-precedence"))break;if(p!==f.rel||t.getAttribute("href")!==(f.href==null||f.href===""?null:f.href)||t.getAttribute("crossorigin")!==(f.crossOrigin==null?null:f.crossOrigin)||t.getAttribute("title")!==(f.title==null?null:f.title))break;return t;case"style":if(t.hasAttribute("data-precedence"))break;return t;case"script":if(p=t.getAttribute("src"),(p!==(f.src==null?null:f.src)||t.getAttribute("type")!==(f.type==null?null:f.type)||t.getAttribute("crossorigin")!==(f.crossOrigin==null?null:f.crossOrigin))&&p&&t.hasAttribute("async")&&!t.hasAttribute("itemprop"))break;return t;default:return t}}else if(s==="input"&&t.type==="hidden"){var p=f.name==null?null:""+f.name;if(f.type==="hidden"&&t.getAttribute("name")===p)return t}else return t;if(t=ri(t.nextSibling),t===null)break}return null}function Jv(t,s,o){if(s==="")return null;for(;t.nodeType!==3;)if((t.nodeType!==1||t.nodeName!=="INPUT"||t.type!=="hidden")&&!o||(t=ri(t.nextSibling),t===null))return null;return t}function Du(t){return t.data==="$!"||t.data==="$?"&&t.ownerDocument.readyState==="complete"}function eb(t,s){var o=t.ownerDocument;if(t.data!=="$?"||o.readyState==="complete")s();else{var l=function(){s(),o.removeEventListener("DOMContentLoaded",l)};o.addEventListener("DOMContentLoaded",l),t._reactRetry=l}}function ri(t){for(;t!=null;t=t.nextSibling){var s=t.nodeType;if(s===1||s===3)break;if(s===8){if(s=t.data,s==="$"||s==="$!"||s==="$?"||s==="F!"||s==="F")break;if(s==="/$")return null}}return t}var Pu=null;function pg(t){t=t.previousSibling;for(var s=0;t;){if(t.nodeType===8){var o=t.data;if(o==="$"||o==="$!"||o==="$?"){if(s===0)return t;s--}else o==="/$"&&s++}t=t.previousSibling}return null}function mg(t,s,o){switch(s=Br(o),t){case"html":if(t=s.documentElement,!t)throw Error(n(452));return t;case"head":if(t=s.head,!t)throw Error(n(453));return t;case"body":if(t=s.body,!t)throw Error(n(454));return t;default:throw Error(n(451))}}function io(t){for(var s=t.attributes;s.length;)t.removeAttributeNode(s[0]);Fl(t)}var $t=new Map,yg=new Set;function Ir(t){return typeof t.getRootNode=="function"?t.getRootNode():t.nodeType===9?t:t.ownerDocument}var Ui=X.d;X.d={f:tb,r:ib,D:sb,C:nb,L:ab,m:ob,X:lb,S:rb,M:cb};function tb(){var t=Ui.f(),s=Mr();return t||s}function ib(t){var s=hn(t);s!==null&&s.tag===5&&s.type==="form"?Fd(s):Ui.r(t)}var Xn=typeof document>"u"?null:document;function vg(t,s,o){var l=Xn;if(l&&typeof s=="string"&&s){var f=Xt(s);f='link[rel="'+t+'"][href="'+f+'"]',typeof o=="string"&&(f+='[crossorigin="'+o+'"]'),yg.has(f)||(yg.add(f),t={rel:t,crossOrigin:o,href:s},l.querySelector(f)===null&&(s=l.createElement("link"),at(s,"link",t),Je(s),l.head.appendChild(s)))}}function sb(t){Ui.D(t),vg("dns-prefetch",t,null)}function nb(t,s){Ui.C(t,s),vg("preconnect",t,s)}function ab(t,s,o){Ui.L(t,s,o);var l=Xn;if(l&&t&&s){var f='link[rel="preload"][as="'+Xt(s)+'"]';s==="image"&&o&&o.imageSrcSet?(f+='[imagesrcset="'+Xt(o.imageSrcSet)+'"]',typeof o.imageSizes=="string"&&(f+='[imagesizes="'+Xt(o.imageSizes)+'"]')):f+='[href="'+Xt(t)+'"]';var p=f;switch(s){case"style":p=Yn(t);break;case"script":p=qn(t)}$t.has(p)||(t=m({rel:"preload",href:s==="image"&&o&&o.imageSrcSet?void 0:t,as:s},o),$t.set(p,t),l.querySelector(f)!==null||s==="style"&&l.querySelector(so(p))||s==="script"&&l.querySelector(no(p))||(s=l.createElement("link"),at(s,"link",t),Je(s),l.head.appendChild(s)))}}function ob(t,s){Ui.m(t,s);var o=Xn;if(o&&t){var l=s&&typeof s.as=="string"?s.as:"script",f='link[rel="modulepreload"][as="'+Xt(l)+'"][href="'+Xt(t)+'"]',p=f;switch(l){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":p=qn(t)}if(!$t.has(p)&&(t=m({rel:"modulepreload",href:t},s),$t.set(p,t),o.querySelector(f)===null)){switch(l){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(o.querySelector(no(p)))return}l=o.createElement("link"),at(l,"link",t),Je(l),o.head.appendChild(l)}}}function rb(t,s,o){Ui.S(t,s,o);var l=Xn;if(l&&t){var f=fn(l).hoistableStyles,p=Yn(t);s=s||"default";var b=f.get(p);if(!b){var C={loading:0,preload:null};if(b=l.querySelector(so(p)))C.loading=5;else{t=m({rel:"stylesheet",href:t,"data-precedence":s},o),(o=$t.get(p))&&Lu(t,o);var E=b=l.createElement("link");Je(E),at(E,"link",t),E._p=new Promise(function(O,V){E.onload=O,E.onerror=V}),E.addEventListener("load",function(){C.loading|=1}),E.addEventListener("error",function(){C.loading|=2}),C.loading|=4,xr(b,s,l)}b={type:"stylesheet",instance:b,count:1,state:C},f.set(p,b)}}}function lb(t,s){Ui.X(t,s);var o=Xn;if(o&&t){var l=fn(o).hoistableScripts,f=qn(t),p=l.get(f);p||(p=o.querySelector(no(f)),p||(t=m({src:t,async:!0},s),(s=$t.get(f))&&Ou(t,s),p=o.createElement("script"),Je(p),at(p,"link",t),o.head.appendChild(p)),p={type:"script",instance:p,count:1,state:null},l.set(f,p))}}function cb(t,s){Ui.M(t,s);var o=Xn;if(o&&t){var l=fn(o).hoistableScripts,f=qn(t),p=l.get(f);p||(p=o.querySelector(no(f)),p||(t=m({src:t,async:!0,type:"module"},s),(s=$t.get(f))&&Ou(t,s),p=o.createElement("script"),Je(p),at(p,"link",t),o.head.appendChild(p)),p={type:"script",instance:p,count:1,state:null},l.set(f,p))}}function bg(t,s,o,l){var f=(f=he.current)?Ir(f):null;if(!f)throw Error(n(446));switch(t){case"meta":case"title":return null;case"style":return typeof o.precedence=="string"&&typeof o.href=="string"?(s=Yn(o.href),o=fn(f).hoistableStyles,l=o.get(s),l||(l={type:"style",instance:null,count:0,state:null},o.set(s,l)),l):{type:"void",instance:null,count:0,state:null};case"link":if(o.rel==="stylesheet"&&typeof o.href=="string"&&typeof o.precedence=="string"){t=Yn(o.href);var p=fn(f).hoistableStyles,b=p.get(t);if(b||(f=f.ownerDocument||f,b={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},p.set(t,b),(p=f.querySelector(so(t)))&&!p._p&&(b.instance=p,b.state.loading=5),$t.has(t)||(o={rel:"preload",as:"style",href:o.href,crossOrigin:o.crossOrigin,integrity:o.integrity,media:o.media,hrefLang:o.hrefLang,referrerPolicy:o.referrerPolicy},$t.set(t,o),p||ub(f,t,o,b.state))),s&&l===null)throw Error(n(528,""));return b}if(s&&l!==null)throw Error(n(529,""));return null;case"script":return s=o.async,o=o.src,typeof o=="string"&&s&&typeof s!="function"&&typeof s!="symbol"?(s=qn(o),o=fn(f).hoistableScripts,l=o.get(s),l||(l={type:"script",instance:null,count:0,state:null},o.set(s,l)),l):{type:"void",instance:null,count:0,state:null};default:throw Error(n(444,t))}}function Yn(t){return'href="'+Xt(t)+'"'}function so(t){return'link[rel="stylesheet"]['+t+"]"}function Sg(t){return m({},t,{"data-precedence":t.precedence,precedence:null})}function ub(t,s,o,l){t.querySelector('link[rel="preload"][as="style"]['+s+"]")?l.loading=1:(s=t.createElement("link"),l.preload=s,s.addEventListener("load",function(){return l.loading|=1}),s.addEventListener("error",function(){return l.loading|=2}),at(s,"link",o),Je(s),t.head.appendChild(s))}function qn(t){return'[src="'+Xt(t)+'"]'}function no(t){return"script[async]"+t}function Mg(t,s,o){if(s.count++,s.instance===null)switch(s.type){case"style":var l=t.querySelector('style[data-href~="'+Xt(o.href)+'"]');if(l)return s.instance=l,Je(l),l;var f=m({},o,{"data-href":o.href,"data-precedence":o.precedence,href:null,precedence:null});return l=(t.ownerDocument||t).createElement("style"),Je(l),at(l,"style",f),xr(l,o.precedence,t),s.instance=l;case"stylesheet":f=Yn(o.href);var p=t.querySelector(so(f));if(p)return s.state.loading|=4,s.instance=p,Je(p),p;l=Sg(o),(f=$t.get(f))&&Lu(l,f),p=(t.ownerDocument||t).createElement("link"),Je(p);var b=p;return b._p=new Promise(function(C,E){b.onload=C,b.onerror=E}),at(p,"link",l),s.state.loading|=4,xr(p,o.precedence,t),s.instance=p;case"script":return p=qn(o.src),(f=t.querySelector(no(p)))?(s.instance=f,Je(f),f):(l=o,(f=$t.get(p))&&(l=m({},o),Ou(l,f)),t=t.ownerDocument||t,f=t.createElement("script"),Je(f),at(f,"link",l),t.head.appendChild(f),s.instance=f);case"void":return null;default:throw Error(n(443,s.type))}else s.type==="stylesheet"&&(s.state.loading&4)===0&&(l=s.instance,s.state.loading|=4,xr(l,o.precedence,t));return s.instance}function xr(t,s,o){for(var l=o.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),f=l.length?l[l.length-1]:null,p=f,b=0;b<l.length;b++){var C=l[b];if(C.dataset.precedence===s)p=C;else if(p!==f)break}p?p.parentNode.insertBefore(t,p.nextSibling):(s=o.nodeType===9?o.head:o,s.insertBefore(t,s.firstChild))}function Lu(t,s){t.crossOrigin==null&&(t.crossOrigin=s.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=s.referrerPolicy),t.title==null&&(t.title=s.title)}function Ou(t,s){t.crossOrigin==null&&(t.crossOrigin=s.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=s.referrerPolicy),t.integrity==null&&(t.integrity=s.integrity)}var _r=null;function Tg(t,s,o){if(_r===null){var l=new Map,f=_r=new Map;f.set(o,l)}else f=_r,l=f.get(o),l||(l=new Map,f.set(o,l));if(l.has(t))return l;for(l.set(t,null),o=o.getElementsByTagName(t),f=0;f<o.length;f++){var p=o[f];if(!(p[ya]||p[ut]||t==="link"&&p.getAttribute("rel")==="stylesheet")&&p.namespaceURI!=="http://www.w3.org/2000/svg"){var b=p.getAttribute(s)||"";b=t+b;var C=l.get(b);C?C.push(p):l.set(b,[p])}}return l}function Cg(t,s,o){t=t.ownerDocument||t,t.head.insertBefore(o,s==="title"?t.querySelector("head > title"):null)}function hb(t,s,o){if(o===1||s.itemProp!=null)return!1;switch(t){case"meta":case"title":return!0;case"style":if(typeof s.precedence!="string"||typeof s.href!="string"||s.href==="")break;return!0;case"link":if(typeof s.rel!="string"||typeof s.href!="string"||s.href===""||s.onLoad||s.onError)break;switch(s.rel){case"stylesheet":return t=s.disabled,typeof s.precedence=="string"&&t==null;default:return!0}case"script":if(s.async&&typeof s.async!="function"&&typeof s.async!="symbol"&&!s.onLoad&&!s.onError&&s.src&&typeof s.src=="string")return!0}return!1}function wg(t){return!(t.type==="stylesheet"&&(t.state.loading&3)===0)}var ao=null;function fb(){}function db(t,s,o){if(ao===null)throw Error(n(475));var l=ao;if(s.type==="stylesheet"&&(typeof o.media!="string"||matchMedia(o.media).matches!==!1)&&(s.state.loading&4)===0){if(s.instance===null){var f=Yn(o.href),p=t.querySelector(so(f));if(p){t=p._p,t!==null&&typeof t=="object"&&typeof t.then=="function"&&(l.count++,l=Dr.bind(l),t.then(l,l)),s.state.loading|=4,s.instance=p,Je(p);return}p=t.ownerDocument||t,o=Sg(o),(f=$t.get(f))&&Lu(o,f),p=p.createElement("link"),Je(p);var b=p;b._p=new Promise(function(C,E){b.onload=C,b.onerror=E}),at(p,"link",o),s.instance=p}l.stylesheets===null&&(l.stylesheets=new Map),l.stylesheets.set(s,t),(t=s.state.preload)&&(s.state.loading&3)===0&&(l.count++,s=Dr.bind(l),t.addEventListener("load",s),t.addEventListener("error",s))}}function gb(){if(ao===null)throw Error(n(475));var t=ao;return t.stylesheets&&t.count===0&&Fu(t,t.stylesheets),0<t.count?function(s){var o=setTimeout(function(){if(t.stylesheets&&Fu(t,t.stylesheets),t.unsuspend){var l=t.unsuspend;t.unsuspend=null,l()}},6e4);return t.unsuspend=s,function(){t.unsuspend=null,clearTimeout(o)}}:null}function Dr(){if(this.count--,this.count===0){if(this.stylesheets)Fu(this,this.stylesheets);else if(this.unsuspend){var t=this.unsuspend;this.unsuspend=null,t()}}}var Pr=null;function Fu(t,s){t.stylesheets=null,t.unsuspend!==null&&(t.count++,Pr=new Map,s.forEach(pb,t),Pr=null,Dr.call(t))}function pb(t,s){if(!(s.state.loading&4)){var o=Pr.get(t);if(o)var l=o.get(null);else{o=new Map,Pr.set(t,o);for(var f=t.querySelectorAll("link[data-precedence],style[data-precedence]"),p=0;p<f.length;p++){var b=f[p];(b.nodeName==="LINK"||b.getAttribute("media")!=="not all")&&(o.set(b.dataset.precedence,b),l=b)}l&&o.set(null,l)}f=s.instance,b=f.getAttribute("data-precedence"),p=o.get(b)||l,p===l&&o.set(null,f),o.set(b,f),this.count++,l=Dr.bind(this),f.addEventListener("load",l),f.addEventListener("error",l),p?p.parentNode.insertBefore(f,p.nextSibling):(t=t.nodeType===9?t.head:t,t.insertBefore(f,t.firstChild)),s.state.loading|=4}}var oo={$$typeof:I,Provider:null,Consumer:null,_currentValue:se,_currentValue2:se,_threadCount:0};function mb(t,s,o,l,f,p,b,C){this.tag=1,this.containerInfo=t,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Dl(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Dl(0),this.hiddenUpdates=Dl(null),this.identifierPrefix=l,this.onUncaughtError=f,this.onCaughtError=p,this.onRecoverableError=b,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=C,this.incompleteTransitions=new Map}function Ag(t,s,o,l,f,p,b,C,E,O,V,j){return t=new mb(t,s,o,b,C,E,O,j),s=1,p===!0&&(s|=24),p=Lt(3,null,null,s),t.current=p,p.stateNode=t,s=vc(),s.refCount++,t.pooledCache=s,s.refCount++,p.memoizedState={element:l,isDehydrated:o,cache:s},Tc(p),t}function kg(t){return t?(t=wn,t):wn}function Eg(t,s,o,l,f,p){f=kg(f),l.context===null?l.context=f:l.pendingContext=f,l=ts(s),l.payload={element:o},p=p===void 0?null:p,p!==null&&(l.callback=p),o=is(t,l,s),o!==null&&(Ht(o,t,s),Oa(o,t,s))}function Rg(t,s){if(t=t.memoizedState,t!==null&&t.dehydrated!==null){var o=t.retryLane;t.retryLane=o!==0&&o<s?o:s}}function Uu(t,s){Rg(t,s),(t=t.alternate)&&Rg(t,s)}function Bg(t){if(t.tag===13){var s=Cn(t,67108864);s!==null&&Ht(s,t,67108864),Uu(t,67108864)}}var Lr=!0;function yb(t,s,o,l){var f=_.T;_.T=null;var p=X.p;try{X.p=2,Nu(t,s,o,l)}finally{X.p=p,_.T=f}}function vb(t,s,o,l){var f=_.T;_.T=null;var p=X.p;try{X.p=8,Nu(t,s,o,l)}finally{X.p=p,_.T=f}}function Nu(t,s,o,l){if(Lr){var f=Hu(l);if(f===null)ku(t,s,l,Or,o),xg(t,l);else if(Sb(f,t,s,o,l))l.stopPropagation();else if(xg(t,l),s&4&&-1<bb.indexOf(t)){for(;f!==null;){var p=hn(f);if(p!==null)switch(p.tag){case 3:if(p=p.stateNode,p.current.memoizedState.isDehydrated){var b=Es(p.pendingLanes);if(b!==0){var C=p;for(C.pendingLanes|=2,C.entangledLanes|=2;b;){var E=1<<31-Dt(b);C.entanglements[1]|=E,b&=~E}mi(p),(Ie&6)===0&&(br=hi()+500,Ja(0))}}break;case 13:C=Cn(p,2),C!==null&&Ht(C,p,2),Mr(),Uu(p,2)}if(p=Hu(l),p===null&&ku(t,s,l,Or,o),p===f)break;f=p}f!==null&&l.stopPropagation()}else ku(t,s,l,null,o)}}function Hu(t){return t=Xl(t),Gu(t)}var Or=null;function Gu(t){if(Or=null,t=un(t),t!==null){var s=c(t);if(s===null)t=null;else{var o=s.tag;if(o===13){if(t=u(s),t!==null)return t;t=null}else if(o===3){if(s.stateNode.current.memoizedState.isDehydrated)return s.tag===3?s.stateNode.containerInfo:null;t=null}else s!==t&&(t=null)}}return Or=t,null}function Ig(t){switch(t){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(ny()){case zh:return 2;case Vh:return 8;case Ro:case ay:return 32;case Xh:return 268435456;default:return 32}default:return 32}}var Wu=!1,ps=null,ms=null,ys=null,ro=new Map,lo=new Map,vs=[],bb="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function xg(t,s){switch(t){case"focusin":case"focusout":ps=null;break;case"dragenter":case"dragleave":ms=null;break;case"mouseover":case"mouseout":ys=null;break;case"pointerover":case"pointerout":ro.delete(s.pointerId);break;case"gotpointercapture":case"lostpointercapture":lo.delete(s.pointerId)}}function co(t,s,o,l,f,p){return t===null||t.nativeEvent!==p?(t={blockedOn:s,domEventName:o,eventSystemFlags:l,nativeEvent:p,targetContainers:[f]},s!==null&&(s=hn(s),s!==null&&Bg(s)),t):(t.eventSystemFlags|=l,s=t.targetContainers,f!==null&&s.indexOf(f)===-1&&s.push(f),t)}function Sb(t,s,o,l,f){switch(s){case"focusin":return ps=co(ps,t,s,o,l,f),!0;case"dragenter":return ms=co(ms,t,s,o,l,f),!0;case"mouseover":return ys=co(ys,t,s,o,l,f),!0;case"pointerover":var p=f.pointerId;return ro.set(p,co(ro.get(p)||null,t,s,o,l,f)),!0;case"gotpointercapture":return p=f.pointerId,lo.set(p,co(lo.get(p)||null,t,s,o,l,f)),!0}return!1}function _g(t){var s=un(t.target);if(s!==null){var o=c(s);if(o!==null){if(s=o.tag,s===13){if(s=u(o),s!==null){t.blockedOn=s,dy(t.priority,function(){if(o.tag===13){var l=Nt();l=Pl(l);var f=Cn(o,l);f!==null&&Ht(f,o,l),Uu(o,l)}});return}}else if(s===3&&o.stateNode.current.memoizedState.isDehydrated){t.blockedOn=o.tag===3?o.stateNode.containerInfo:null;return}}}t.blockedOn=null}function Fr(t){if(t.blockedOn!==null)return!1;for(var s=t.targetContainers;0<s.length;){var o=Hu(t.nativeEvent);if(o===null){o=t.nativeEvent;var l=new o.constructor(o.type,o);Vl=l,o.target.dispatchEvent(l),Vl=null}else return s=hn(o),s!==null&&Bg(s),t.blockedOn=o,!1;s.shift()}return!0}function Dg(t,s,o){Fr(t)&&o.delete(s)}function Mb(){Wu=!1,ps!==null&&Fr(ps)&&(ps=null),ms!==null&&Fr(ms)&&(ms=null),ys!==null&&Fr(ys)&&(ys=null),ro.forEach(Dg),lo.forEach(Dg)}function Ur(t,s){t.blockedOn===s&&(t.blockedOn=null,Wu||(Wu=!0,a.unstable_scheduleCallback(a.unstable_NormalPriority,Mb)))}var Nr=null;function Pg(t){Nr!==t&&(Nr=t,a.unstable_scheduleCallback(a.unstable_NormalPriority,function(){Nr===t&&(Nr=null);for(var s=0;s<t.length;s+=3){var o=t[s],l=t[s+1],f=t[s+2];if(typeof l!="function"){if(Gu(l||o)===null)continue;break}var p=hn(o);p!==null&&(t.splice(s,3),s-=3,Gc(p,{pending:!0,data:f,method:o.method,action:l},l,f))}}))}function uo(t){function s(E){return Ur(E,t)}ps!==null&&Ur(ps,t),ms!==null&&Ur(ms,t),ys!==null&&Ur(ys,t),ro.forEach(s),lo.forEach(s);for(var o=0;o<vs.length;o++){var l=vs[o];l.blockedOn===t&&(l.blockedOn=null)}for(;0<vs.length&&(o=vs[0],o.blockedOn===null);)_g(o),o.blockedOn===null&&vs.shift();if(o=(t.ownerDocument||t).$$reactFormReplay,o!=null)for(l=0;l<o.length;l+=3){var f=o[l],p=o[l+1],b=f[Ct]||null;if(typeof p=="function")b||Pg(o);else if(b){var C=null;if(p&&p.hasAttribute("formAction")){if(f=p,b=p[Ct]||null)C=b.formAction;else if(Gu(f)!==null)continue}else C=b.action;typeof C=="function"?o[l+1]=C:(o.splice(l,3),l-=3),Pg(o)}}}function zu(t){this._internalRoot=t}Hr.prototype.render=zu.prototype.render=function(t){var s=this._internalRoot;if(s===null)throw Error(n(409));var o=s.current,l=Nt();Eg(o,l,t,s,null,null)},Hr.prototype.unmount=zu.prototype.unmount=function(){var t=this._internalRoot;if(t!==null){this._internalRoot=null;var s=t.containerInfo;Eg(t.current,2,null,t,null,null),Mr(),s[cn]=null}};function Hr(t){this._internalRoot=t}Hr.prototype.unstable_scheduleHydration=function(t){if(t){var s=Zh();t={blockedOn:null,target:t,priority:s};for(var o=0;o<vs.length&&s!==0&&s<vs[o].priority;o++);vs.splice(o,0,t),o===0&&_g(t)}};var Lg=e.version;if(Lg!=="19.1.0")throw Error(n(527,Lg,"19.1.0"));X.findDOMNode=function(t){var s=t._reactInternals;if(s===void 0)throw typeof t.render=="function"?Error(n(188)):(t=Object.keys(t).join(","),Error(n(268,t)));return t=d(s),t=t!==null?g(t):null,t=t===null?null:t.stateNode,t};var Tb={bundleType:0,version:"19.1.0",rendererPackageName:"react-dom",currentDispatcherRef:_,reconcilerVersion:"19.1.0"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Gr=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Gr.isDisabled&&Gr.supportsFiber)try{ga=Gr.inject(Tb),_t=Gr}catch{}}return go.createRoot=function(t,s){if(!r(t))throw Error(n(299));var o=!1,l="",f=Qd,p=$d,b=Jd,C=null;return s!=null&&(s.unstable_strictMode===!0&&(o=!0),s.identifierPrefix!==void 0&&(l=s.identifierPrefix),s.onUncaughtError!==void 0&&(f=s.onUncaughtError),s.onCaughtError!==void 0&&(p=s.onCaughtError),s.onRecoverableError!==void 0&&(b=s.onRecoverableError),s.unstable_transitionCallbacks!==void 0&&(C=s.unstable_transitionCallbacks)),s=Ag(t,1,!1,null,null,o,l,f,p,b,C,null),t[cn]=s.current,Au(t),new zu(s)},go.hydrateRoot=function(t,s,o){if(!r(t))throw Error(n(299));var l=!1,f="",p=Qd,b=$d,C=Jd,E=null,O=null;return o!=null&&(o.unstable_strictMode===!0&&(l=!0),o.identifierPrefix!==void 0&&(f=o.identifierPrefix),o.onUncaughtError!==void 0&&(p=o.onUncaughtError),o.onCaughtError!==void 0&&(b=o.onCaughtError),o.onRecoverableError!==void 0&&(C=o.onRecoverableError),o.unstable_transitionCallbacks!==void 0&&(E=o.unstable_transitionCallbacks),o.formState!==void 0&&(O=o.formState)),s=Ag(t,1,!0,s,o??null,l,f,p,b,C,E,O),s.context=kg(null),o=s.current,l=Nt(),l=Pl(l),f=ts(l),f.callback=null,is(o,f,l),o=l,s.current.lanes=o,ma(s,o),mi(s),t[cn]=s.current,Au(t),new Hr(s)},go.version="19.1.0",go}var Qg;function MS(){if(Qg)return Yu.exports;Qg=1;function a(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(a)}catch(e){console.error(e)}}return a(),Yu.exports=SS(),Yu.exports}var TS=MS();const CS=wb(TS);var cl=Ah();function Mi(a){const e=a.replace(/^\/+/,""),i=window.location.pathname.startsWith("/shipwright-survivors");return i&&e.startsWith("shipwright-survivors/")?"/"+e:(i?"/shipwright-survivors/":"./")+e}const Qu=.2;class wS{constructor(){this.bufferCache=new Map,this.currentlyPlaying=new Map,this.activeLoops=new Map,this.loopStartLocks=new Map,this.currentMusicSource=null,this.currentMusicFile=null,this.isMusicLooping=!1,this.context=new AudioContext,this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.channelGains={music:this.context.createGain(),sfx:this.context.createGain(),dialogue:this.context.createGain()};for(const e of Object.values(this.channelGains))e.connect(this.masterGain)}async play(e,i,n){const r=(n==null?void 0:n.maxSimultaneous)??1,c=Math.max(0,Math.min(1,(n==null?void 0:n.volume)??1)),u=Math.max(-1,Math.min(1,(n==null?void 0:n.pan)??0)),h=this.currentlyPlaying.get(e)??0;if(h>=r)return!1;let d=this.bufferCache.get(e);if(!d)try{const M=await(await fetch(Mi(e))).arrayBuffer();d=await this.context.decodeAudioData(M),this.bufferCache.set(e,d)}catch(v){return console.warn(`Failed to load audio file: ${e}`,v),!1}const g=this.context.createBufferSource();g.buffer=d,g.playbackRate.value=(n==null?void 0:n.pitch)??1;const m=this.context.createGain();m.gain.value=c;const y=this.context.createStereoPanner();return y.pan.value=u,g.connect(m),m.connect(y),y.connect(this.channelGains[i]),this.currentlyPlaying.set(e,h+1),g.onended=()=>{const v=this.currentlyPlaying.get(e)??1,M=Math.max(0,v-1);M===0?this.currentlyPlaying.delete(e):this.currentlyPlaying.set(e,M)},g.start(0),!0}async startLoop(e,i,n){if(this.activeLoops.has(e)&&this.activeLoops.get(e).size>0)return;if(this.loopStartLocks.has(e)){await this.loopStartLocks.get(e);return}const r=this._startLoopInternal(e,i,n);this.loopStartLocks.set(e,r),await r,this.loopStartLocks.delete(e)}async _startLoopInternal(e,i,n){let r=this.bufferCache.get(e);if(!r)try{const S=await(await fetch(Mi(e))).arrayBuffer();r=await this.context.decodeAudioData(S),this.bufferCache.set(e,r)}catch(M){console.warn(`[AudioManager] Failed to load audio file: ${e}`,M);return}const c=Math.max(0,Math.min(1,(n==null?void 0:n.volume)??1)),u=Math.max(-1,Math.min(1,(n==null?void 0:n.pan)??0)),h=(n==null?void 0:n.pitch)??1,d=this.context.createBufferSource();d.buffer=r,d.loop=!0,d.playbackRate.value=h;const g=this.context.createGain(),m=this.context.currentTime;g.gain.setValueAtTime(0,m),g.gain.linearRampToValueAtTime(c,m+Qu);const y=this.context.createStereoPanner();y.pan.value=u,d.connect(g),g.connect(y),y.connect(this.channelGains[i]);const v={source:d,gain:g,pan:y};this.activeLoops.has(e)||this.activeLoops.set(e,new Set),this.activeLoops.get(e).add(v),d.start(0)}stopLoop(e){const i=this.activeLoops.get(e);if(!i||i.size===0)return;const n=this.context.currentTime;for(const{source:r,gain:c,pan:u}of i){try{c.gain.cancelScheduledValues(n),c.gain.setValueAtTime(c.gain.value,n),c.gain.linearRampToValueAtTime(0,n+Qu)}catch(h){console.warn(`[AudioManager] Fade-out error for ${e}`,h)}setTimeout(()=>{try{r.stop()}catch(h){console.warn(`[AudioManager] Failed to stop source for ${e}`,h)}try{r.disconnect(),c.disconnect(),u.disconnect()}catch(h){console.warn(`[AudioManager] Failed to disconnect nodes for ${e}`,h)}},Qu*1e3)}this.activeLoops.delete(e)}stopAllLoops(){for(const e of this.activeLoops.keys())this.stopLoop(e)}setChannelVolume(e,i){const n=Math.max(0,Math.min(1,i));this.channelGains[e].gain.value=n}getChannelVolume(e){return this.channelGains[e].gain.value}setMasterVolume(e){this.masterGain.gain.value=Math.max(0,Math.min(1,e))}getMasterVolume(){return this.masterGain.gain.value}unlock(){this.context.state==="suspended"&&this.context.resume()}clearCache(){this.bufferCache.clear()}async playMusic(e){const{file:i,loopStartMs:n=0}=e;if(this.currentMusicFile===i&&this.isMusicLooping)return;this.stopMusic();let r=this.bufferCache.get(i);if(!r)try{const u=await(await fetch(Mi(i))).arrayBuffer();r=await this.context.decodeAudioData(u),this.bufferCache.set(i,r)}catch(c){console.warn(`Failed to load music file: ${i}`,c);return}if(n>0){const c=this.context.createBufferSource();c.buffer=r,c.loop=!1,c.connect(this.channelGains.music),c.start(0),this.currentMusicSource=c,this.currentMusicFile=i,this.isMusicLooping=!1,c.onended=()=>{if(this.currentMusicSource===c){const u=this.context.createBufferSource();u.buffer=r,u.loop=!0,u.loopStart=n/1e3,u.loopEnd=r.duration,u.connect(this.channelGains.music),u.start(0,n/1e3),this.currentMusicSource=u,this.currentMusicFile=i,this.isMusicLooping=!0}}}else{const c=this.context.createBufferSource();c.buffer=r,c.loop=!0,c.connect(this.channelGains.music),c.start(0),this.currentMusicSource=c,this.currentMusicFile=i,this.isMusicLooping=!0}}stopMusic(){this.currentMusicSource&&(this.currentMusicSource.stop(),this.currentMusicSource.disconnect(),this.currentMusicSource=null,this.currentMusicFile=null,this.isMusicLooping=!1)}}const Q=new wS;class AS{constructor(){this.listeners=new Map}on(e,i){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(i)}off(e,i){var n;(n=this.listeners.get(e))==null||n.delete(i)}emit(e,i){var n;(n=this.listeners.get(e))==null||n.forEach(r=>r(i))}}const pe=new AS;function $g(a,e){pe.emit("resolution:changed",{width:a,height:e})}class Ae{constructor(){this.masterVolume=1,this.musicVolume=1,this.sfxVolume=1,this.dialogueVolume=1,this.particlesEnabled=!0,this.lightingEnabled=!0,this.collisionsEnabled=!0,this.viewportWidth=1920,this.viewportHeight=1080,this.resolutionChangeCallbacks=[],this.interfaceScaleChangeCallbacks=[],this.interfaceScale=1}static getInstance(){return Ae.instance||(Ae.instance=new Ae),Ae.instance}onResolutionChange(e){return this.resolutionChangeCallbacks.push(e),()=>{this.resolutionChangeCallbacks=this.resolutionChangeCallbacks.filter(i=>i!==e)}}notifyResolutionChange(){for(const e of this.resolutionChangeCallbacks)e()}onInterfaceScaleChange(e){return this.interfaceScaleChangeCallbacks.push(e),()=>{this.interfaceScaleChangeCallbacks=this.interfaceScaleChangeCallbacks.filter(i=>i!==e)}}notifyInterfaceScaleChange(){for(const e of this.interfaceScaleChangeCallbacks)e()}setViewportWidth(e){this.viewportWidth=Math.max(640,e),this.notifyResolutionChange(),$g(this.viewportWidth,this.viewportHeight)}setViewportHeight(e){this.viewportHeight=Math.max(480,e),this.notifyResolutionChange(),$g(this.viewportWidth,this.viewportHeight)}getViewportWidth(){return this.viewportWidth}getViewportHeight(){return this.viewportHeight}setInterfaceScale(e){const i=Math.max(.5,Math.min(2,e));this.interfaceScale!==i&&(this.interfaceScale=i,this.notifyInterfaceScaleChange())}getInterfaceScale(){return 2}setMasterVolume(e){this.masterVolume=this.clampVolume(e),Q.setMasterVolume(this.masterVolume)}setMusicVolume(e){this.musicVolume=this.clampVolume(e),Q.setChannelVolume("music",this.musicVolume)}setSfxVolume(e){this.sfxVolume=this.clampVolume(e),Q.setChannelVolume("sfx",this.sfxVolume)}setDialogueVolume(e){this.dialogueVolume=this.clampVolume(e),Q.setChannelVolume("dialogue",this.dialogueVolume)}setParticlesEnabled(e){this.particlesEnabled=e}setLightingEnabled(e){this.lightingEnabled=e}setCollisionsEnabled(e){this.collisionsEnabled=e}getMasterVolume(){return this.masterVolume}getMusicVolume(){return this.musicVolume}getSfxVolume(){return this.sfxVolume}getDialogueVolume(){return this.dialogueVolume}isCollisionsEnabled(){return this.collisionsEnabled}isParticlesEnabled(){return this.particlesEnabled}isLightingEnabled(){return this.lightingEnabled}toJSON(){return JSON.stringify({masterVolume:this.masterVolume,musicVolume:this.musicVolume,sfxVolume:this.sfxVolume,dialogueVolume:this.dialogueVolume,particlesEnabled:this.particlesEnabled,lightingEnabled:this.lightingEnabled,viewportWidth:this.viewportWidth,viewportHeight:this.viewportHeight,interfaceScale:this.interfaceScale})}fromJSON(e){try{const i=JSON.parse(e);typeof i=="object"&&i!==null&&(this.setMasterVolume(i.masterVolume??this.masterVolume),this.setMusicVolume(i.musicVolume??this.musicVolume),this.setSfxVolume(i.sfxVolume??this.sfxVolume),this.setDialogueVolume(i.dialogueVolume??this.dialogueVolume),this.particlesEnabled=!!(i.particlesEnabled??this.particlesEnabled),this.lightingEnabled=!!(i.lightingEnabled??this.lightingEnabled),this.viewportWidth=Math.max(640,i.viewportWidth??this.viewportWidth),this.viewportHeight=Math.max(480,i.viewportHeight??this.viewportHeight),this.interfaceScale=Math.max(.5,Math.min(2,i.interfaceScale??this.interfaceScale)))}catch(i){console.warn("Failed to load player settings from JSON:",i)}}reset(){this.masterVolume=1,this.musicVolume=1,this.sfxVolume=1,this.dialogueVolume=1,this.particlesEnabled=!0,this.lightingEnabled=!0,this.interfaceScale=1}clampVolume(e){return Math.min(1,Math.max(0,e))}}const fm=1280,dm=720;function gh(a){return a*ci()/fm}function oa(a){return a*vi()/dm}function ul(a){return{x:gh(a.x),y:oa(a.y),width:gh(a.width),height:oa(a.height)}}function ci(){return Ae.getInstance().getViewportWidth()}function vi(){return Ae.getInstance().getViewportHeight()}function kS(){return ci()/fm}function ES(){return vi()/dm}function ae(){return Math.min(kS(),ES())}function RS(){const a=ci(),e=vi();return a>=3840?1.8:a>=2560?1.2:e>=1200?1:.8}const Jg={background:"background-canvas",entities:"entity-canvas",polygon:"polygon-canvas",fx:"fx-canvas",particles:"particles-canvas",ui:"ui-canvas",overlay:"overlay-canvas",dialogue:"dialogue-canvas",unifiedgl2:"unifiedgl2-canvas"},Ks=class Ks{constructor(){this.canvases={},this.contexts={},performance.mark("canvasManager-init-start"),this.initializeCanvases(),this.setFixedSize(),performance.mark("canvasManager-init-end"),performance.measure("CanvasManager Initialization","canvasManager-init-start","canvasManager-init-end")}static getInstance(){return Ks._instance||(Ks._instance=new Ks),Ks._instance}initializeCanvases(){for(const e of Object.keys(Jg)){const i=Jg[e],n=document.getElementById(i);if(!n||!(n instanceof HTMLCanvasElement))throw new Error(`CanvasManager error: element with ID "${i}" not found. Ensure canvases are in the DOM before sceneManager.setScene(...)`);if(!["polygon","unifiedgl2"].includes(e)){const r=n.getContext("2d",{willReadFrequently:!1});if(!r)throw new Error(`2D context not supported for "${i}"`);this.contexts[e]=r}n.style.zIndex=this.getZIndexForLayer(e).toString(),n.style.pointerEvents=e==="ui"?"auto":"none",n.style.position="absolute",this.canvases[e]=n}}setFixedSize(){const e=ci(),i=vi();for(const[n,r]of Object.entries(this.canvases))r.width=e,r.height=i,r.style.width=`${e}px`,r.style.height=`${i}px`}getZIndexForLayer(e){switch(e){case"background":return 1;case"polygon":return 3;case"entities":return 4;case"unifiedgl2":return 6;case"fx":return 7;case"particles":return 8;case"ui":return 9;case"overlay":return 10;case"dialogue":return 11}}getCanvas(e){return this.canvases[e]}getContext(e){return this.contexts[e]}getWebGLContext(e){const n=this.getCanvas(e).getContext("webgl");if(!n)throw new Error(`WebGL context not supported for "${e}"`);return n}getWebGL2Context(e){const n=this.getCanvas(e).getContext("webgl2");if(!n)throw new Error(`WebGL2 context not supported for layer "${e}"`);return n}clearLayer(e){e==="unifiedgl2"?this.clearWebGL2Layer(e):e==="polygon"?this.clearWebGLLayer(e):this.getContext(e).clearRect(0,0,ci(),vi())}clearWebGLLayer(e,i=[0,0,0,0]){const n=this.getCanvas(e),r=n.getContext("webgl");if(!r)throw new Error(`Cannot clear WebGL layer '${e}': no WebGL context available`);r.viewport(0,0,n.width,n.height),r.clearColor(...i),r.clear(r.COLOR_BUFFER_BIT)}clearWebGL2Layer(e,i=[0,0,0,0]){const n=this.getCanvas(e),r=n.getContext("webgl2");if(!r)throw new Error(`Cannot clear WebGL2 layer '${e}': no WebGL2 context available`);r.viewport(0,0,n.width,n.height),r.clearColor(...i),r.clear(r.COLOR_BUFFER_BIT)}clearAll(){for(const e of Object.keys(this.contexts))this.clearLayer(e)}getWidth(){return ci()}getHeight(){return vi()}getDimensions(){return{width:ci(),height:vi()}}resize(){performance.mark("canvasManager-resize-start");const e=ci(),i=vi();for(const[n,r]of Object.entries(this.canvases))r.width=e,r.height=i,r.style.width=`${e}px`,r.style.height=`${i}px`;performance.mark("canvasManager-resize-end"),performance.measure("CanvasManager Resize","canvasManager-resize-start","canvasManager-resize-end")}};Ks._instance=null;let Ti=Ks;function BS(){if(document.fullscreenElement)document.exitFullscreen?document.exitFullscreen().catch(a=>{console.warn("Failed to exit fullscreen:",a)}):document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen();else{const a=document.documentElement;a.requestFullscreen?a.requestFullscreen().catch(e=>{console.warn("Failed to enter fullscreen:",e)}):a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.warn("Fullscreen API not supported in this browser")}}const Zs=class Zs{constructor(){this.lastUsed="keyboard",this.lastUsedTimestamp=performance.now()}static getInstance(){return Zs._instance||(Zs._instance=new Zs),Zs._instance}updateDevice(e){this.lastUsed!==e&&(this.lastUsed=e,this.lastUsedTimestamp=performance.now())}getLastUsed(){return this.lastUsed}getLastUsedTimestamp(){return this.lastUsedTimestamp}};Zs._instance=null;let xt=Zs;const $u=.2;class IS{constructor(){this.connected=!1,this.prevButtons=new Set,this.currentButtons=new Set,this.justPressed=new Set,this.justReleased=new Set,this.leftStick={x:0,y:0},this.rightStick={x:0,y:0}}updateFrame(){this.justPressed.clear(),this.justReleased.clear();const e=this.getPrimaryGamepad();if(!e){this.connected=!1,this.currentButtons.clear();return}this.connected=!0;const i={...this.leftStick},n={...this.rightStick};this.currentButtons.size,this.pollButtons(e),this.pollSticks(e);const r=this.justPressed.size>0||this.justReleased.size>0,c=Math.abs(i.x-this.leftStick.x)>.05||Math.abs(i.y-this.leftStick.y)>.05,u=Math.abs(n.x-this.rightStick.x)>.05||Math.abs(n.y-this.rightStick.y)>.05;(r||c||u)&&xt.getInstance().updateDevice("gamepad")}isActionPressed(e){return this.currentButtons.has(e)}wasActionJustPressed(e){return this.justPressed.has(e)}wasActionJustReleased(e){return this.justReleased.has(e)}getLeftStick(){return this.leftStick}getRightStick(){return this.rightStick}isConnected(){return this.connected}getPrimaryGamepad(){var i;const e=((i=navigator.getGamepads)==null?void 0:i.call(navigator))??[];for(const n of e)if(n&&n.connected&&n.mapping==="standard")return n;return null}pollButtons(e){const i=new Set,n=this.prevButtons;for(let r=0;r<e.buttons.length;r++)if(e.buttons[r].pressed){const u=this.mapButtonIndexToAlias(r);u&&i.add(u)}for(const r of i)n.has(r)||this.justPressed.add(r);for(const r of n)i.has(r)||this.justReleased.add(r);this.prevButtons=new Set(i),this.currentButtons=i}pollSticks(e){const i=e.axes[0]??0,n=e.axes[1]??0,r=Math.hypot(i,n);if(r<$u)this.leftStick={x:0,y:0};else{const d=i/r,g=n/r;this.leftStick={x:d,y:g}}const c=e.axes[2]??0,u=e.axes[3]??0,h=Math.hypot(c,u);if(h<$u)this.rightStick={x:0,y:0};else{const d=c/h,g=u/h;this.rightStick={x:d,y:g}}}applyDeadzone(e){return Math.abs(e)<$u?0:e}mapButtonIndexToAlias(e){switch(e){case 0:return"A";case 1:return"B";case 2:return"X";case 3:return"Y";case 4:return"leftBumper";case 5:return"rightBumper";case 6:return"leftTrigger";case 7:return"rightTrigger";case 8:return"start";case 9:return"select";case 10:return"leftStickButton";case 11:return"rightStickButton";case 12:return"dpadUp";case 13:return"dpadDown";case 14:return"dpadLeft";case 15:return"dpadRight";case 16:return"home";default:return null}}normalize(e,i){const n=Math.hypot(e,i);return n>1e-5?{x:e/n,y:i/n}:{x:0,y:0}}}const Ni={thrustForward:{keys:["KeyW"],gamepadButtons:["leftTrigger"]},afterburner:{keys:["ShiftLeft"],gamepadButtons:["leftBumper"]},brake:{keys:["KeyS"],gamepadButtons:["B"]},powerSlide:{keys:[],gamepadButtons:[]},rotateLeft:{keys:["KeyA"],gamepadButtons:[]},rotateRight:{keys:["KeyD"],gamepadButtons:[]},strafeLeft:{keys:["KeyQ"],gamepadButtons:["dpadLeft"]},strafeRight:{keys:["KeyE"],gamepadButtons:["dpadRight"]},firePrimary:{keys:["MouseLeft"],gamepadButtons:["rightBumper"]},fireSecondary:{keys:["MouseRight"],gamepadButtons:["rightTrigger"]},fireTertiary:{keys:["Space"],gamepadButtons:["leftTrigger"]},fireQuaternary:{keys:["KeyC"],gamepadButtons:[]},switchFiringMode:{keys:["KeyX"],gamepadButtons:["X"]},openMenu:{keys:["Escape"],gamepadButtons:["start"]},openShipBuilder:{keys:["Tab"],gamepadButtons:["Y"]},select:{keys:["Enter"],gamepadButtons:["A"]},cancel:{keys:["Escape"],gamepadButtons:["B"]},pause:{keys:["Escape"],gamepadButtons:["start"]}};function kh(){return typeof window<"u"&&typeof navigator=="object"&&navigator.userAgent.toLowerCase().includes("electron")}class xS{constructor(){this.strength=0,this.duration=0,this.maxDuration=0,this.frequency=30,this.time=0,this.phaseX=0,this.phaseY=0,this.offsetX=0,this.offsetY=0}trigger(e,i,n=30){this.strength=e,this.duration=i,this.maxDuration=i,this.frequency=n,this.time=0,this.phaseX=Math.random()*Math.PI*2,this.phaseY=Math.random()*Math.PI*2}update(e){if(this.duration<=0){this.offsetX=0,this.offsetY=0;return}this.time+=e,this.duration-=e;const i=Math.max(0,this.duration/this.maxDuration),n=this.frequency*2*Math.PI,r=this.strength*i;this.offsetX=Math.sin(this.time*n+this.phaseX)*r,this.offsetY=Math.sin(this.time*n+this.phaseY)*r}getOffset(){return{x:this.offsetX,y:this.offsetY}}isActive(){return this.duration>0}stop(){this.duration=0,this.offsetX=0,this.offsetY=0}}const yi=class yi{constructor(e,i){this.screenShake=new xS,this.x=0,this.y=0,this.zoom=.3,this.targetX=0,this.targetY=0,this.skipSmoothingThisFrame=!1,this.deadZoneRadius=12,this.zoomAnimationTarget=null,this.zoomAnimationSpeed=.025,this.handleShakeEvent=({strength:n,duration:r,frequency:c})=>{this.screenShake.trigger(n,r,c)},this.viewportWidth=e,this.viewportHeight=i,pe.on("camera:shake",this.handleShakeEvent)}static getInstance(e,i){if(!yi._instance){if(e==null||i==null)throw new Error("[Camera] Must supply viewport dimensions on first initialization");yi._instance=new yi(e,i)}return yi._instance}static destroy(){yi._instance&&(yi._instance.cleanup(),yi._instance=null)}update(e){this.screenShake.update(e);const i=this.targetX-this.x,n=this.targetY-this.y,r=i*i+n*n;if(this.skipSmoothingThisFrame)this.x=this.targetX,this.y=this.targetY;else if(r>this.deadZoneRadius*this.deadZoneRadius){const h=(d,g,m)=>d+(g-d)*m;this.x=h(this.x,this.targetX,1.05),this.y=h(this.y,this.targetY,1.05)}const c=this.screenShake.getOffset();if(this.x+=c.x/this.zoom,this.y+=c.y/this.zoom,this.zoomAnimationTarget!==null){const u=this.zoomAnimationTarget-this.zoom;if(Math.abs(u)>.001){const h=this.zoomAnimationSpeed*u,d=this.zoom+h,g=Math.log(d/this.zoom)/Math.log(1.08);this.adjustZoom(g)}else this.zoom=this.zoomAnimationTarget,this.zoomAnimationTarget=null}this.skipSmoothingThisFrame=!1}follow(e){this.targetX=e.x-this.viewportWidth/2/this.zoom,this.targetY=e.y-this.viewportHeight/2/this.zoom}worldToScreen(e,i){return{x:(e-this.x)*this.zoom,y:(i-this.y)*this.zoom}}screenToWorld(e,i){return{x:e/this.zoom+this.x,y:i/this.zoom+this.y}}getOffset(){return{x:this.x,y:this.y}}getPosition(){return{x:this.x+this.viewportWidth/2/this.zoom,y:this.y+this.viewportHeight/2/this.zoom}}adjustZoom(e){const n=Math.max(-1,Math.min(1,e)),r=this.screenToWorld(this.viewportWidth/2,this.viewportHeight/2),c=n>0?this.zoom*Math.pow(1.08,n):this.zoom/Math.pow(1.08,-n),u=ae(),h=.15*u,d=.5*u;this.zoom=Math.min(d,Math.max(h,c));const g=this.screenToWorld(this.viewportWidth/2,this.viewportHeight/2),m=r.x-g.x,y=r.y-g.y;this.x+=m,this.y+=y,this.targetX+=m,this.targetY+=y,this.skipSmoothingThisFrame=!0}animateZoomTo(e,i=.025){const n=ae(),r=.15*n,c=.5*n;this.zoomAnimationTarget=Math.min(c,Math.max(r,e)),this.zoomAnimationSpeed=i}getZoom(){return this.zoom}abortZoomAnimation(){this.zoomAnimationTarget=null}getViewportBounds(){const e=this.viewportWidth/this.zoom,i=this.viewportHeight/this.zoom;return{x:this.x,y:this.y,width:e,height:i}}getViewBounds(e){const i=e.getCanvas("unifiedgl2"),n=i.width/this.zoom,r=i.height/this.zoom;return{left:this.x,right:this.x+n,bottom:this.y+r,top:this.y}}getViewportWidth(){return this.viewportWidth}getViewportHeight(){return this.viewportHeight}resize(e,i){this.viewportWidth=e,this.viewportHeight=i}cleanup(){pe.off("camera:shake",this.handleShakeEvent),this.x=0,this.y=0,this.zoom=.3,this.targetX=0,this.targetY=0,this.skipSmoothingThisFrame=!1,this.viewportWidth=0,this.viewportHeight=0,this.screenShake.trigger(0,0)}};yi._instance=null;let yt=yi;class gm{constructor(e){this.canvasElement=e,this.gamepadManager=new IS,this.keyState={},this.prevKeyState={},this.justPressedKeys=new Set,this.justReleasedKeys=new Set,this.disabledKeys=new Set,this.disabledGamepadButtons=new Set,this.inputDisabled=!1,this.leftStickDisabled=!1,this.rightStickDisabled=!1,this.mouseMoved=!1,this.mouseState={x:0,y:0,leftDown:!1,rightDown:!1},this.scrollUpDetected=!1,this.scrollDownDetected=!1,this.initialized=!1,this.mouseMoveHandler=i=>{const n=i.target,r=n.getBoundingClientRect(),c=n.width/r.width,u=n.height/r.height,h=(i.clientX-r.left)*c,d=(i.clientY-r.top)*u;(h!==this.mouseState.x||d!==this.mouseState.y)&&(this.mouseMoved=!0,xt.getInstance().updateDevice("mouse")),this.mouseState.x=h,this.mouseState.y=d},this.keyDownHandler=i=>{this.keyState[i.code]={pressed:!0},xt.getInstance().updateDevice("keyboard")},this.keyUpHandler=i=>{this.keyState[i.code]={pressed:!1}},this.mouseDownHandler=i=>{i.button===0&&(this.mouseState.leftDown=!0),i.button===2&&(this.mouseState.rightDown=!0),xt.getInstance().updateDevice("mouse")},this.mouseUpHandler=i=>{i.button===0&&(this.mouseState.leftDown=!1),i.button===2&&(this.mouseState.rightDown=!1)},this.wheelHandler=i=>{const n=Math.sign(i.deltaY);n<0?this.scrollUpDetected=!0:n>0&&(this.scrollDownDetected=!0)},this.contextMenuHandler=i=>{i.preventDefault()},this.initialize()}disableInput(){this.inputDisabled=!0}enableInput(){this.inputDisabled=!1}getMousePosition(){return{x:this.mouseState.x,y:this.mouseState.y}}initialize(){this.initialized||(this.initialized=!0,window.addEventListener("keydown",this.keyDownHandler),window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("mousedown",this.mouseDownHandler),window.addEventListener("mouseup",this.mouseUpHandler),this.canvasElement.addEventListener("mousemove",this.mouseMoveHandler),window.addEventListener("wheel",this.wheelHandler),window.addEventListener("contextmenu",this.contextMenuHandler))}destroy(){this.initialized&&(this.initialized=!1,window.removeEventListener("keydown",this.keyDownHandler),window.removeEventListener("keyup",this.keyUpHandler),window.removeEventListener("mousedown",this.mouseDownHandler),window.removeEventListener("mouseup",this.mouseUpHandler),this.canvasElement.removeEventListener("mousemove",this.mouseMoveHandler),window.removeEventListener("wheel",this.wheelHandler),window.removeEventListener("contextmenu",this.contextMenuHandler))}updateFrame(){var e,i;this.gamepadManager.updateFrame(),this.mouseMoved=!1,this.justPressedKeys.clear(),this.justReleasedKeys.clear(),this.scrollUpDetected=!1,this.scrollDownDetected=!1,!this.prevKeyState.MouseLeft&&this.mouseState.leftDown&&this.justPressedKeys.add("MouseLeft"),this.prevKeyState.MouseLeft&&!this.mouseState.leftDown&&this.justReleasedKeys.add("MouseLeft"),!this.prevKeyState.MouseRight&&this.mouseState.rightDown&&this.justPressedKeys.add("MouseRight"),this.prevKeyState.MouseRight&&!this.mouseState.rightDown&&this.justReleasedKeys.add("MouseRight"),this.prevKeyState.MouseLeft=this.mouseState.leftDown,this.prevKeyState.MouseRight=this.mouseState.rightDown;for(const n in this.keyState){if(this.disabledKeys.has(n))continue;const r=((e=this.keyState[n])==null?void 0:e.pressed)??!1,c=this.prevKeyState[n]??!1;!c&&r&&this.justPressedKeys.add(n),c&&!r&&this.justReleasedKeys.add(n),this.prevKeyState[n]=r}this.wasKeyJustPressed("KeyY")&&(kh()&&((i=window.electronAPI)!=null&&i.toggleFullscreen)?window.electronAPI.toggleFullscreen():BS())}disableKey(e){this.disabledKeys.add(e)}enableKey(e){this.disabledKeys.delete(e)}enableAllKeys(){this.disabledKeys.clear()}isKeyPressed(e){var i;return this.inputDisabled||this.disabledKeys.has(e)?!1:e==="MouseLeft"?this.mouseState.leftDown:e==="MouseRight"?this.mouseState.rightDown:((i=this.keyState[e])==null?void 0:i.pressed)??!1}wasKeyJustPressed(e){return this.inputDisabled||this.disabledKeys.has(e)?!1:this.justPressedKeys.has(e)}wasKeyJustReleased(e){return this.inputDisabled||this.disabledKeys.has(e)?!1:this.justReleasedKeys.has(e)}wasMouseClicked(){return this.inputDisabled?!1:this.wasKeyJustPressed("MouseLeft")}wasLeftClicked(){return this.inputDisabled?!1:this.wasKeyJustPressed("MouseLeft")}wasRightClicked(){return this.inputDisabled?!1:this.wasKeyJustPressed("MouseRight")}wasMouseMoved(){return this.inputDisabled?!1:this.mouseMoved}wasScrollWheelUp(){return this.inputDisabled?!1:this.scrollUpDetected}wasScrollWheelDown(){return this.inputDisabled?!1:this.scrollDownDetected}isShiftPressed(){return this.inputDisabled?!1:this.isKeyPressed("ShiftLeft")||this.isKeyPressed("ShiftRight")}consumeZoomDelta(){if(this.inputDisabled)return 0;const e=this.scrollUpDetected||this.isKeyPressed("KeyR"),i=this.scrollDownDetected||this.isKeyPressed("KeyT");return(e||i)&&yt.getInstance().abortZoomAnimation(),(e?10:0)+(i?-10:0)}isEscapePressed(){return this.isKeyPressed("Escape")}isMouseLeftPressed(){return this.isKeyPressed("MouseLeft")}isMouseRightPressed(){return this.isKeyPressed("MouseRight")}isTabPressed(){return this.isKeyPressed("Tab")}is0Pressed(){return this.isKeyPressed("Digit0")}isLPressed(){return this.isKeyPressed("KeyL")}wasLeftBracketPressed(){return this.wasKeyJustPressed("BracketLeft")}wasRightBracketPressed(){return this.wasKeyJustPressed("BracketRight")}isGamepadConnected(){return this.gamepadManager.isConnected()}getGamepadMovementVector(){return this.leftStickDisabled?{x:0,y:0}:this.gamepadManager.getLeftStick()}getGamepadAimVector(){return this.rightStickDisabled?{x:0,y:0}:this.gamepadManager.getRightStick()}disableGamepadButton(e){this.disabledGamepadButtons.add(e)}enableGamepadButton(e){this.disabledGamepadButtons.delete(e)}enableAllGamepadButtons(){this.disabledGamepadButtons.clear()}disableLeftStick(){this.leftStickDisabled=!0}enableLeftStick(){this.leftStickDisabled=!1}disableRightStick(){this.rightStickDisabled=!0}enableRightStick(){this.rightStickDisabled=!1}enableAllSticks(){this.leftStickDisabled=!1,this.rightStickDisabled=!1}isLeftStickMoved(){if(this.leftStickDisabled)return!1;const{x:e,y:i}=this.gamepadManager.getLeftStick();return Math.abs(e)>0||Math.abs(i)>0}isRightStickMoved(){if(this.rightStickDisabled)return!1;const{x:e,y:i}=this.gamepadManager.getRightStick();return Math.abs(e)>0||Math.abs(i)>0}isLeftTriggerPressed(){return!this.disabledGamepadButtons.has("leftTrigger")&&this.gamepadManager.isActionPressed("leftTrigger")}disableAllActions(){var e,i;for(const n in Ni){const r=Ni[n];(e=r.keys)==null||e.forEach(c=>this.disableKey(c)),(i=r.gamepadButtons)==null||i.forEach(c=>this.disableGamepadButton(c)),this.disableLeftStick(),this.disableRightStick()}}enableAllActions(){var e,i;for(const n in Ni){const r=Ni[n];(e=r.keys)==null||e.forEach(c=>this.enableKey(c)),(i=r.gamepadButtons)==null||i.forEach(c=>this.enableGamepadButton(c)),this.enableLeftStick(),this.enableRightStick()}}disableAction(e){var n,r;const i=Ni[e];(n=i.keys)==null||n.forEach(c=>this.disableKey(c)),(r=i.gamepadButtons)==null||r.forEach(c=>this.disableGamepadButton(c))}enableAction(e){var n,r;const i=Ni[e];(n=i.keys)==null||n.forEach(c=>this.enableKey(c)),(r=i.gamepadButtons)==null||r.forEach(c=>this.enableGamepadButton(c))}isActionPressed(e){var c,u;const i=Ni[e],n=((c=i.keys)==null?void 0:c.some(h=>this.isKeyPressed(h)))??!1,r=((u=i.gamepadButtons)==null?void 0:u.some(h=>!this.disabledGamepadButtons.has(h)&&this.gamepadManager.isActionPressed(h)))??!1;return n||r}wasActionJustPressed(e){var c,u;const i=Ni[e],n=((c=i.keys)==null?void 0:c.some(h=>this.wasKeyJustPressed(h)))??!1,r=((u=i.gamepadButtons)==null?void 0:u.some(h=>!this.disabledGamepadButtons.has(h)&&this.gamepadManager.wasActionJustPressed(h)))??!1;return n||r}wasActionJustReleased(e){var c,u;const i=Ni[e],n=((c=i.keys)==null?void 0:c.some(h=>this.wasKeyJustReleased(h)))??!1,r=((u=i.gamepadButtons)==null?void 0:u.some(h=>!this.disabledGamepadButtons.has(h)&&this.gamepadManager.wasActionJustReleased(h)))??!1;return n||r}}class pm{constructor(){this.lastFrameTime=performance.now(),this.startTime=this.lastFrameTime,this.isRunning=!1,this.updateCallbacks=[],this.renderCallbacks=[],this.frameRequestId=null,this.currentDeltaTime=0,this.tick=e=>{if(!this.isRunning)return;const i=(e-this.lastFrameTime)/1e3;this.lastFrameTime=e,this.currentDeltaTime=i,this.updateCallbacks.forEach(n=>n(i)),this.renderCallbacks.forEach(n=>n(i)),this.frameRequestId=requestAnimationFrame(this.tick)}}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.startTime=this.lastFrameTime,this.frameRequestId=requestAnimationFrame(this.tick))}stop(){this.isRunning=!1,this.frameRequestId!==null&&(cancelAnimationFrame(this.frameRequestId),this.frameRequestId=null)}getElapsedSeconds(){return(performance.now()-this.startTime)/1e3}getDeltaTime(){return this.currentDeltaTime}onUpdate(e){this.updateCallbacks.push(e)}offUpdate(e){this.updateCallbacks=this.updateCallbacks.filter(i=>i!==e)}onRender(e){this.renderCallbacks.push(e)}offRender(e){this.renderCallbacks=this.renderCallbacks.filter(i=>i!==e)}}const ep={"mission.mission_001.unlocked":{description:"Unlocks the first mission in the campaign."},"mission.mission_001.complete":{description:"Marks the first mission as completed."},"mission.mission_002.unlocked":{description:"Unlocks the second mission."},"mission.mission_002.complete":{description:"Marks the second mission as completed."},"mission.scrapper-revenant.unlocked":{description:"Unlocks the third mission."},"mission.mission_003_00.unlocked":{description:"Unlocks the third mission."},"mission.mission_003_00.complete":{description:"Marks the third mission as completed."},"mission.mission_004_00.unlocked":{description:"Unlocks the fourth mission."},"mission.mission_004_00.complete":{description:"Marks the fourth mission as completed."},"mission.mission_005_00.unlocked":{description:"Unlocks the fifth mission."},"mission.mission_005_00.complete":{description:"Marks the fifth mission as completed."},"mission.mission_006_00.unlocked":{description:"Unlocks the sixth mission."},"mission.mission_006_00.complete":{description:"Marks the sixth mission as completed."},"mission.intro-briefing.complete":{description:"Marks the intro briefing as completed."},"hub.mission-computer.unlocked":{description:"Unlocks the mission computer in the hub."},"hub.passive-terminal.unlocked":{description:"Unlocks the passive terminal in the hub."},"hub.breakroom.unlocked":{description:"Unlocks the breakroom in the hub."},"hub.introduction-1.complete":{description:"Marks the first introduction dialogue as completed."},"hub.introduction-2.complete":{description:"Marks the second introduction dialogue as completed."},"hub.introduction-3.complete":{description:"Marks the third introduction dialogue as completed."}};class _S{constructor(){this.flags=new Set}set(e){this.flags.add(e)}unset(e){this.flags.delete(e)}has(e){return this.flags.has(e)}clear(){this.flags.clear()}toJSON(){return JSON.stringify(Array.from(this.flags))}fromJSON(e){try{const i=JSON.parse(e);if(Array.isArray(i)){const n=i.filter(r=>r in ep);this.flags=new Set(n)}}catch(i){console.warn("Failed to load player flags from JSON:",i)}}getAll(){return Array.from(this.flags)}unlockAllFlags(){Object.keys(ep).forEach(e=>{this.flags.add(e)})}}const Re=new _S;class DS{constructor(){this.result=null}initialize(){this.result={outcome:"victory",enemiesDestroyed:0,currencyGathered:0,blocksUnlocked:[],blockPlacedCount:0,passivePointsEarned:0,bonusObjectives:[],timeTakenSeconds:0,blocksLost:0,blockRefinedCount:0,blocksCollected:0,wavesCleared:0,incidentsCompleted:0,massAchieved:0}}finalize(e,i){this.ensureInitialized(),this.result.outcome=e,this.result.timeTakenSeconds=Math.round(i)}setOutcome(e){this.ensureInitialized(),this.result.outcome=e}addCurrency(e){this.ensureInitialized(),this.result.currencyGathered+=e}incrementKillCount(e=1){this.ensureInitialized(),pe.emit("camera:shake",{strength:10,duration:.2,frequency:10}),this.result.enemiesDestroyed+=e}incrementBlockCollectedCount(e=1){this.ensureInitialized(),this.result.blocksCollected+=e}incrementWavesCleared(e=1){this.ensureInitialized(),this.result.wavesCleared+=e}incrementIncidentsCompleted(e=1){this.ensureInitialized(),this.result.incidentsCompleted+=e}incrementMassAchieved(e){this.ensureInitialized(),e>this.result.massAchieved&&(this.result.massAchieved=e)}incrementBlockPlacedCount(e=1){this.ensureInitialized(),this.result.blockPlacedCount+=e}incrementBlockRefinedCount(e=1){this.ensureInitialized(),this.result.blockRefinedCount+=e}addBlockPickup(e){this.ensureInitialized();const i=this.result.blocksUnlocked;i.includes(e)||i.push(e)}incrementBlocksLost(e=1){this.ensureInitialized(),this.result.blocksLost+=e}getBlocksLost(){return this.ensureInitialized(),this.result.blocksLost}addBonusObjective(e){this.ensureInitialized(),this.result.bonusObjectives.push(e)}setPassivePoints(e){this.ensureInitialized(),this.result.passivePointsEarned=e}get(){return this.ensureInitialized(),this.result}clear(){this.result=null}hasResult(){return this.result!==null}ensureInitialized(){if(!this.result)throw new Error("MissionResultStore accessed before initialize()")}}const Ce=new DS;class ii{constructor(){this.unlockedBlockIds=new Set}static getInstance(){return ii.instance||(ii.instance=new ii),ii.instance}unlock(e){this.unlockedBlockIds.add(e),Ce.addBlockPickup(e)}unlockMany(e){e.forEach(i=>this.unlockedBlockIds.add(i))}unlockAll(){Ao().map(i=>i.id).forEach(i=>this.unlockedBlockIds.add(i))}isUnlocked(e){return this.unlockedBlockIds.has(e)}getUnlockedBlockIds(){return Array.from(this.unlockedBlockIds)}reset(){this.unlockedBlockIds.clear()}destroy(){this.unlockedBlockIds.clear()}toJSON(){return JSON.stringify(Array.from(this.unlockedBlockIds))}fromJSON(e){try{const i=JSON.parse(e);Array.isArray(i)&&(this.unlockedBlockIds=new Set(i))}catch(i){console.warn("Failed to load player technology from JSON:",i)}}}class gt{constructor(){this.metaCurrency=0}static getInstance(){return gt.instance||(gt.instance=new gt),gt.instance}getMetaCurrency(){return this.metaCurrency}setMetaCurrency(e){this.metaCurrency=Math.max(0,Math.floor(e))}addMetaCurrency(e){this.metaCurrency=Math.max(0,this.metaCurrency+Math.floor(e))}subtractMetaCurrency(e){const i=Math.floor(e);return this.metaCurrency<i?!1:(this.metaCurrency-=i,!0)}canAfford(e){return this.metaCurrency>=Math.floor(e)}toJSON(){return JSON.stringify({metaCurrency:this.metaCurrency})}fromJSON(e){try{const i=JSON.parse(e);typeof i=="object"&&i!==null&&typeof i.metaCurrency=="number"&&this.setMetaCurrency(i.metaCurrency)}catch(i){console.warn("Failed to parse PlayerMetaCurrencyManager data:",i)}}reset(){this.metaCurrency=0}}class pt{constructor(){this.passives=new Map,this.passivePoints=0}static getInstance(){return pt.instance||(pt.instance=new pt),pt.instance}addPassivePoints(e){gt.getInstance().addMetaCurrency(e)}getAvailablePoints(){return gt.getInstance().getMetaCurrency()}getUpgradeCost(e,i=null){const n=i??0,r=u=>{switch(u){case 1:return 5;case 2:return 10;case 3:return 15;default:return 0}};let c=0;for(let u=n+1;u<=e;u++)c+=r(u);return c}canAfford(e){return gt.getInstance().canAfford(e)}setPassiveTier(e,i){const n=this.passives.get(e)??null,r=this.getUpgradeCost(i,n);return r<0||!gt.getInstance().canAfford(r)?!1:(gt.getInstance().subtractMetaCurrency(r),this.passives.set(e,i),!0)}getPassiveTier(e){return this.passives.get(e)??null}hasPassive(e){return this.passives.has(e)}getAllPassives(){return new Map(this.passives)}getTotalPassivesSpent(){let e=0;for(const i of this.passives.values())e+=i;return e}hasAnyPassives(){return this.passives.size>0}refundAll(){let e=0;for(const i of this.passives.values())e+=i;gt.getInstance().addMetaCurrency(e),this.passives.clear()}clear(){this.passives.clear(),this.passivePoints=0}toJSON(){const e={passivePoints:this.passivePoints,passives:{}};for(const[i,n]of this.passives.entries())e.passives[i]=n;return JSON.stringify(e)}fromJSON(e){this.passives.clear(),this.passivePoints=0;try{const i=JSON.parse(e);if(typeof i.passivePoints=="number"&&(this.passivePoints=i.passivePoints),i.passives&&typeof i.passives=="object")for(const[n,r]of Object.entries(i.passives))this.isValidPassiveId(n)&&this.isValidTier(r)&&this.passives.set(n,r)}catch(i){console.warn("Failed to parse PlayerPassiveManager data:",i)}}isValidPassiveId(e){return["harvester-range","laser-damage","laser-energy-drain","laser-block-cost","explosive-lance-radius","explosive-lance-firing-rate","block-durability","fin-turn-power","engine-thrust","charger-rate","battery-capacity","turret-firing-rate","turret-damage","turret-accuracy","shield-energy-drain","shield-radius","shield-efficiency","facetplate-armor","hull-armor","hull-mass","cockpit-armor","block-repair-cost","entropium-pickup-bonus","block-drop-rate"].includes(e)}isValidTier(e){return e===1||e===2||e===3}}const tp="lastSaveSlot";class rt{constructor(e){this.saveSlot=e}static initialize(e=0){rt.instance||(rt.instance=new rt(e))}static getInstance(){if(!rt.instance)throw new Error("SaveGameManager not initialized. Call initialize(slot) first.");return rt.instance}getStorageKey(){return`save${this.saveSlot}`}loadData(){const e=localStorage.getItem(this.getStorageKey());if(!e)return{flags:[],unlockedBlockIds:[]};try{return JSON.parse(e)}catch(i){return console.warn(`Failed to parse save data from ${this.getStorageKey()}:`,i),{flags:[],unlockedBlockIds:[]}}}writeData(e){localStorage.setItem(this.getStorageKey(),JSON.stringify(e))}saveAll(){const e={flags:JSON.parse(Re.toJSON()),unlockedBlockIds:JSON.parse(ii.getInstance().toJSON()),settings:Ae.getInstance().toJSON(),passives:JSON.parse(pt.getInstance().toJSON()),metaCurrency:JSON.parse(gt.getInstance().toJSON()),version:1};this.writeData(e),localStorage.setItem(tp,String(this.saveSlot))}loadAll(){const e=this.loadData();Re.fromJSON(JSON.stringify(e.flags??[])),ii.getInstance().fromJSON(JSON.stringify(e.unlockedBlockIds??[])),e.settings&&Ae.getInstance().fromJSON(e.settings),e.passives&&pt.getInstance().fromJSON(JSON.stringify(e.passives)),e.metaCurrency&&gt.getInstance().fromJSON(JSON.stringify(e.metaCurrency))}changeSlot(e){this.saveSlot=e}static eraseSave(e){const i=`save${e}`;localStorage.removeItem(i),console.log(`Save slot ${e} erased.`)}static getFirstAvailableResolution(){const e={width:1920,height:1080},i=rt.getLastSaveSlot();if(i!==null){const n=`save${i}`,r=localStorage.getItem(n);if(r)try{const c=JSON.parse(r);if(c.settings){const u=JSON.parse(c.settings),h=parseInt(u.viewportWidth),d=parseInt(u.viewportHeight);if(Number.isFinite(h)&&h>0&&Number.isFinite(d)&&d>0)return{width:h,height:d}}}catch(c){console.warn(`Failed to parse save data from last slot ${i}:`,c)}}return e}static getLastSaveSlot(){const e=localStorage.getItem(tp),i=parseInt(e??"",10);return Number.isInteger(i)?i:null}saveFlags(){const e=this.loadData();e.flags=JSON.parse(Re.toJSON()),this.writeData(e)}saveTechnology(){const e=this.loadData();e.unlockedBlockIds=JSON.parse(ii.getInstance().toJSON()),this.writeData(e)}saveSettings(){const e=this.loadData();e.settings=Ae.getInstance().toJSON(),this.writeData(e)}savePassives(){const e=this.loadData();e.passives=JSON.parse(pt.getInstance().toJSON()),this.writeData(e)}saveMetaCurrency(){const e=this.loadData();e.metaCurrency=JSON.parse(gt.getInstance().toJSON()),this.writeData(e)}loadFlags(){const e=this.loadData();Re.fromJSON(JSON.stringify(e.flags??[]))}loadTechnology(){const e=this.loadData();ii.getInstance().fromJSON(JSON.stringify(e.unlockedBlockIds??[]))}loadSettings(){const e=this.loadData();e.settings&&Ae.getInstance().fromJSON(e.settings)}loadPassives(){const e=this.loadData();e.passives&&pt.getInstance().fromJSON(JSON.stringify(e.passives))}loadMetaCurrency(){const e=this.loadData();e.metaCurrency&&gt.getInstance().fromJSON(JSON.stringify(e.metaCurrency))}}function la(a,e,i,n,r){const c=e.width*r,u=e.height*r;a.drawImage(e,i-c/2,n-u/2,c,u)}const bl=document.createElement("canvas");bl.width=24;bl.height=24;const Ne=bl.getContext("2d");Ne.clearRect(0,0,24,24);const Ci=12;Ne.strokeStyle="black";Ne.lineWidth=5;Ne.beginPath();Ne.moveTo(Ci,2);Ne.lineTo(Ci,22);Ne.moveTo(2,Ci);Ne.lineTo(22,Ci);Ne.stroke();Ne.strokeStyle="#00ff00";Ne.lineWidth=2;Ne.shadowColor="#00ff00";Ne.shadowBlur=4;Ne.beginPath();Ne.moveTo(Ci,2);Ne.lineTo(Ci,22);Ne.moveTo(2,Ci);Ne.lineTo(22,Ci);Ne.stroke();Ne.shadowBlur=6;Ne.fillStyle="#00ff00";Ne.beginPath();Ne.arc(Ci,Ci,2.2,0,Math.PI*2);Ne.fill();Ne.shadowBlur=0;Ne.shadowColor="transparent";function an(){return bl}const Sl=document.createElement("canvas");Sl.width=24;Sl.height=24;{const a=Sl.getContext("2d");a.clearRect(0,0,24,24);const e=12;a.strokeStyle="black",a.lineWidth=5,a.beginPath(),a.moveTo(e,2),a.lineTo(e,7),a.moveTo(e,17),a.lineTo(e,22),a.moveTo(2,e),a.lineTo(7,e),a.moveTo(17,e),a.lineTo(22,e),a.stroke(),a.strokeStyle="#00ff00",a.lineWidth=2,a.shadowColor="#00ff00",a.shadowBlur=4,a.beginPath(),a.moveTo(e,2),a.lineTo(e,7),a.moveTo(e,17),a.lineTo(e,22),a.moveTo(2,e),a.lineTo(7,e),a.moveTo(17,e),a.lineTo(22,e),a.stroke(),a.shadowBlur=6,a.fillStyle="#00ff00",a.beginPath(),a.arc(e,e,2.2,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function PS(){return Sl}const Ml=document.createElement("canvas");Ml.width=28;Ml.height=28;{const a=Ml.getContext("2d");a.clearRect(0,0,28,28);const e=14,i=14;a.strokeStyle="black",a.lineWidth=4,a.beginPath(),a.moveTo(e,i-10),a.lineTo(e+10,i),a.lineTo(e,i+10),a.lineTo(e-10,i),a.closePath(),a.stroke(),a.strokeStyle="#00ff00",a.lineWidth=2,a.shadowColor="#00ff00",a.shadowBlur=4,a.beginPath(),a.moveTo(e,i-10),a.lineTo(e+10,i),a.lineTo(e,i+10),a.lineTo(e-10,i),a.closePath(),a.stroke(),a.fillStyle="#00ff00",a.shadowBlur=6,a.beginPath(),a.arc(e,i,2.2,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function Eh(){return Ml}function Tl(a){const i=document.createElement("canvas");i.width=28,i.height=28;const n=i.getContext("2d");n.clearRect(0,0,28,28),n.lineJoin="round";const r=28/2,c=28/2,u=new Path2D;switch(u.moveTo(r,c-10),u.lineTo(r-6,c+6),u.lineTo(r,c+2),u.lineTo(r+6,c+6),u.closePath(),n.save(),n.translate(r,c),a){case"right":n.rotate(Math.PI/2);break;case"down":n.rotate(Math.PI);break;case"left":n.rotate(-Math.PI/2);break}return n.translate(-14,-14),n.strokeStyle="black",n.lineWidth=5,n.stroke(u),n.strokeStyle="#00ff00",n.lineWidth=2,n.shadowColor="#00ff00",n.shadowBlur=4,n.stroke(u),n.shadowBlur=6,n.fillStyle="#00ff00",n.beginPath(),n.arc(r,c,2.2,0,Math.PI*2),n.fill(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),i}const LS=Tl("up"),OS=Tl("right"),FS=Tl("down"),US=Tl("left");function NS(a){switch(a){case"up":return LS;case"right":return OS;case"down":return FS;case"left":return US}}const Cl=document.createElement("canvas");Cl.width=28;Cl.height=28;{const a=Cl.getContext("2d");a.clearRect(0,0,28,28);const e=14,i=14;a.lineJoin="round",a.lineCap="round";const n=new Path2D;n.moveTo(e,i+8),n.lineTo(e,i-4),n.moveTo(e-4,i-8),n.lineTo(e+4,i-8),n.lineTo(e+4,i-4),n.moveTo(e-4,i-4),n.lineTo(e-4,i-8),a.strokeStyle="black",a.lineWidth=5,a.stroke(n),a.strokeStyle="#00ff00",a.lineWidth=2,a.shadowColor="#00ff00",a.shadowBlur=4,a.stroke(n),a.shadowBlur=6,a.fillStyle="#00ff00",a.beginPath(),a.arc(e,i,1.5,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function HS(){return Cl}const wl=document.createElement("canvas");wl.width=18;wl.height=18;{const a=wl.getContext("2d");a.clearRect(0,0,18,18);const e=9;a.shadowBlur=4,a.fillStyle="#00ff00",a.beginPath(),a.arc(e,e,1.5,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function GS(){return wl}function WS(a,e,i,n=255){const r=m=>Math.max(0,Math.min(255,Math.round(m))),c=m=>r(m).toString(16).padStart(2,"0"),u=c(a),h=c(e),d=c(i),g=c(n);return n===255?`#${u}${h}${d}`:`#${u}${h}${d}${g}`}function zS(a){if(!a)return"#ffffff";if(a.startsWith("#"))return a;try{return VS(a)}catch{return console.warn("[ExplosionSystem] Invalid color format, defaulting to white:",a),"#ffffff"}}function VS(a){const e=a.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([.\d]+))?\)/i);if(!e)throw new Error(`Invalid rgba() color string: ${a}`);const i=parseInt(e[1],10),n=parseInt(e[2],10),r=parseInt(e[3],10),c=e[4]!==void 0?Math.round(parseFloat(e[4])*255):255;return WS(i,n,r,c)}function Vi(a,e){const i=h=>Math.max(0,Math.min(255,h)),n=parseInt(a.slice(1),16),r=i((n>>16)+255*e),c=i((n>>8&255)+255*e),u=i((n&255)+255*e);return`rgb(${r}, ${c}, ${u})`}function ei(a,e){if(/^#[0-9a-f]{3}$/i.test(a)){const[i,n,r]=a.slice(1);return`#${i}${i}${n}${n}${r}${r}${e}`}if(/^#[0-9a-f]{6}$/i.test(a))return`${a}${e}`;throw new Error(`Invalid hex color format: ${a}`)}function lt(a,e,i=1){const{x:n,y:r,width:c,height:u,label:h,isHovered:d,style:g={},disabled:m=!1}=e,{borderRadius:y=6,backgroundColor:v,borderColor:M="#666",textColor:S="#fff",textFont:T="13px monospace",alpha:w=1,backgroundGradient:A}=g,R=c*i,I=u*i,x=T.replace(/(\d+)(px)/,(q,ie,$)=>`${Math.round(parseInt(ie)*i)}${$}`),P=m?.4:w,N=m?"#444":M,W=m?"#888":S;a.save(),a.globalAlpha=P;let H;if(A){const{type:q,stops:ie,from:$=[n,r],to:K=[n+R,r+I],radius:ne=R/2}=A,Z=q==="linear"?a.createLinearGradient($[0],$[1],K[0],K[1]):a.createRadialGradient($[0],$[1],0,$[0],$[1],ne),te=ie.map(_=>({offset:_.offset,color:m?"#111":d?Vi(_.color,.1):_.color}));for(const _ of te)Z.addColorStop(_.offset,_.color);H=Z}else H=m?"#111":d?"#333":v??"#222";a.fillStyle=H,a.strokeStyle=N,a.lineWidth=1*i,a.beginPath(),a.roundRect(n,r,R,I,y),a.fill(),a.stroke(),a.fillStyle=W,a.font=x,a.textAlign="center",a.textBaseline="middle",a.fillText(h,n+R/2,r+I/2),a.restore()}function As(a,e,i,n,r=1){if(a.disabled)return a.isHovered=!1,a.wasHovered=!1,!1;const c=a.width*r,u=a.height*r,h=e>=a.x&&e<=a.x+c&&i>=a.y&&i<=a.y+u,d=h&&!a.wasHovered,g=!h&&a.wasHovered;return a.isHovered=h,a.wasHovered=h,d&&(a.onHover?a.onHover():Q.play("assets/sounds/sfx/ui/hover_00.wav","sfx",{maxSimultaneous:4}),pe.emit("cursor:change",{type:"hovered"})),g&&pe.emit("cursor:restore",void 0),h&&n?(a.onClick(),!0):!1}function Mt(a){const{ctx:e,x:i,y:n,width:r,height:c,title:u,tabs:h,mouse:d,clicked:g,options:m={},uiScale:y=1}=a,{borderRadius:v=8,backgroundColor:M="#111",borderColor:S="#555",alpha:T=1,activeTabColor:w=S,backgroundGradient:A}=m,R=r*y,I=c*y,x=v*y;e.save(),e.globalAlpha=T;let P=M;if(A){const{type:$,stops:K,from:ne=[i,n],to:Z=[i+r,n+c],radius:te=r/2}=A,_=[ne[0]*y,ne[1]*y],X=[Z[0]*y,Z[1]*y],se=$==="linear"?e.createLinearGradient(_[0],_[1],X[0],X[1]):e.createRadialGradient(_[0],_[1],0,_[0],_[1],te*y);for(const oe of K)se.addColorStop(oe.offset,oe.color);P=se}e.fillStyle=P,e.strokeStyle=S,e.lineWidth=2*y,e.beginPath(),e.roundRect(i,n,R,I,x),e.fill(),e.stroke(),u&&(e.fillStyle="#fff",e.font=`bold ${Math.round(14*y)}px monospace`,e.textAlign="start",e.textBaseline="top",e.fillText(u,i+42*y,n+8*y));let N=!1;if(!(h!=null&&h.length))return e.restore(),!1;const W=ae(),H=24*y*W,q=8*y*W,ie=Math.floor((R-2*q)/h.length);for(let $=0;$<h.length;$++){const K=h[$],ne=i+q+$*ie,Z=n-H,te=ie-4*y,_=d&&d.x>=ne&&d.x<=ne+te&&d.y>=Z&&d.y<=Z+H;g&&_&&(h.forEach(X=>X.isActive=!1),K.isActive=!0,K.onClick(),N=!0),e.fillStyle=K.isActive?w:P,e.strokeStyle=S,e.beginPath(),e.roundRect(ne,Z,te,H,[x,x,0,0]),e.fill(),e.stroke(),e.font=`${Math.round(12*y*W)}px monospace`,e.fillStyle=K.isActive?"#000":S,e.textAlign="center",e.textBaseline="middle",e.fillText(K.label,ne+te/2,Z+H/2)}return e.textAlign="start",e.textBaseline="alphabetic",e.restore(),N}const Ju=new Map;async function ca(a){const e=Mi(a);return Ju.has(e)?Ju.get(e):new Promise((i,n)=>{const r=new Image;r.src=e,r.onload=()=>{Ju.set(e,r),i(r)},r.onerror=n})}const ip=[{id:1,type:"wave",mods:[],ships:[{shipId:"wave_0_00",count:40},{shipId:"wave_0_01",count:40},{shipId:"wave_0_02",count:32,hunter:!0},{shipId:"wave_0_03",count:24,hunter:!0},{shipId:"wave_0_04",count:12,hunter:!0}]},{id:2,type:"wave",mods:["extra-aggressive"],ships:[{shipId:"ship_0_00",count:20},{shipId:"ship_0_01",count:18},{shipId:"ship_0_02",count:12},{shipId:"ship_0_03",count:8,hunter:!0},{shipId:"ship_0_04",count:6,hunter:!0},{shipId:"ship_0_station",count:6}]},{id:3,type:"wave",mods:["shielded"],ships:[{shipId:"ship_scrapper_0",count:12,hunter:!0},{shipId:"ship_scrapper_1",count:10},{shipId:"ship_scrapper_2",count:8,hunter:!0},{shipId:"ship_scrapper_3",count:6},{shipId:"ship_scrapper_4",count:5,hunter:!0},{shipId:"ship_scrapper_5",count:4,hunter:!0},{shipId:"ship_scrapper_6",count:3,hunter:!0}]},{id:4,type:"boss",mods:["shielded","extra-aggressive"],ships:[{shipId:"boss_0_00",count:1,hunter:!0}],music:{file:"assets/sounds/music/track_03_boss.mp3"},lightingSettings:{clearColor:[.25,0,0,0]}}];class Tt{constructor(){this.ships=new Set,this.shipIdMap=new Map,this.playerShip=null}static getInstance(){return Tt.instance||(Tt.instance=new Tt),Tt.instance}getById(e){return this.shipIdMap.get(e)}add(e){this.ships.add(e),this.shipIdMap.set(e.id,e)}remove(e){this.ships.delete(e),this.shipIdMap.delete(e.id),this.playerShip===e&&(this.playerShip=null)}getAll(){return this.ships}clear(){this.ships.clear(),this.shipIdMap.clear(),this.playerShip=null}count(){return this.ships.size}setPlayerShip(e){this.ships.has(e)||this.add(e),this.playerShip=e}getPlayerShip(){return this.playerShip}}function Rh(a,e){const i=e.x-a.x,n=e.y-a.y;return Math.sqrt(i*i+n*n)}function Co(a,e){return{x:a.x-e.x,y:a.y-e.y}}function $s(a){const e=Math.sqrt(a.x*a.x+a.y*a.y);return e===0?{x:0,y:0}:{x:a.x/e,y:a.y/e}}function ph(a){return Math.sqrt(a.x*a.x+a.y*a.y)}function on(a,e){return a.x*e.x+a.y*e.y}function mm(a,e){let i=(e-a+Math.PI)%(2*Math.PI);return i<0&&(i+=2*Math.PI),i-Math.PI}function XS(a,e,i){return{x:a.x+e.x*i,y:a.y+e.y*i}}class ko{constructor(e,i){this.controller=e,this.ship=i}}function YS(a){const e=a*(Math.PI/180),i=Math.sin(e),n=Math.cos(e);return{x:i,y:-n}}function qS(a,e){const i=Math.cos(e),n=Math.sin(e);return{x:a.x*i-a.y*n,y:a.x*n+a.y*i}}function Bh(a){var r;let e=0,i=0;const n=a.getTransform().rotation;for(const[c,u]of a.getAllBlocks()){if(!((r=u.type.behavior)!=null&&r.canThrust))continue;const h=u.type.behavior.thrustPower??5,d=YS(u.rotation??0),g=qS(d,n);e+=g.x*h,i+=g.y*h}return $s({x:e,y:i})}function ua(a,e,i){return Rh(a,e)<=i}function jS(a,e){const i=a.getTransform().position,n=Bh(a),r=Co(e,i),c=$s(r),u=on(n,c);return Math.acos(Math.max(-1,Math.min(1,u)))}function KS(a,e,i=.15){return jS(a,e)<=i}function ym(a,e){const i=a.getFaction(),n=a.getTransform().position;let r=null,c=1/0;const u=Tt.getInstance().getPlayerShip();if(!u)return null;for(const h of[u]){if(h===a||h.getFaction()===i)continue;const d=h.getTransform().position,g=Rh(n,d);g<=e&&g<c&&(r=h,c=g)}return r}function Ih(a,e,i){const n=a.getTransform().position,r=Co(e,n),c=ph(r),u=$s(r),h=KS(a,e,.15),d=on(i,u);let g=!1,m=!1;c<100?m=d>10:h&&(g=!0);const y=Bh(a),v=Math.atan2(u.y,u.x),M=Math.atan2(y.y,y.x),S=mm(M,v),T=S<-.05,w=S>.05;return{thrustForward:g,brake:m,rotateLeft:T,rotateRight:w,strafeLeft:!1,strafeRight:!1}}function sp(a,e,i,n){const r=a.getTransform().position,c=Co(i,r),h=ph(c)-n,d=$s(c),g={x:-d.y,y:d.x},m=Bh(a),y=Math.atan2(g.y,g.x),v=Math.atan2(m.y,m.x),M=mm(v,y),S=.05,T=M<-.05,w=M>S;let A=!1,R=!1;const I=ph(e),x=I>0?on($s(e),g):0,P=x<.5;if(h>20)A=!0;else if(h<-40){const N=$s(Co(r,i));(I>0?on($s(e),N):0)<.6?A=!0:R=!1}else P?A=!0:x>.7&&h<0&&(R=!0);return{thrustForward:A,brake:R,rotateLeft:T,rotateRight:w,strafeLeft:!1,strafeRight:!1}}function vm(a,e,i,n){const r=Co(e,a),c=on(i,i)-n*n,u=2*on(r,i),h=on(r,r),d=u*u-4*c*h;if(d<0||Math.abs(c)<1e-5)return e;const g=Math.sqrt(d),m=(-u-g)/(2*c),y=(-u+g)/(2*c),v=Math.max(m,y);return XS(e,i,Math.max(v,0))}class ZS extends ko{constructor(e,i,n){super(e,i),this.disengageRange=1400,this.orbitRadius=300,this.projectileSpeed=400,this.phase=0,this.phaseTimer=0,this.ramDuration=10,this.orbitDuration=10,this.target=n}update(e){const i=this.controller.getBehaviorProfile().attack,n=this.ship.getTransform(),r=this.target.getTransform();if(i==="ram"){if(this.phase===0?this.ship.isColliding()&&(this.phase=1,this.phaseTimer=0):this.phase===1&&(this.phaseTimer+=e,this.phaseTimer>=this.orbitDuration&&(this.phase=0,this.phaseTimer=0)),this.phase===0)return{movement:Ih(this.ship,r.position,n.velocity),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:r.position},utility:{toggleShields:!0}};if(this.phase===1)return{movement:sp(this.ship,n.velocity,r.position,this.orbitRadius),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:r.position},utility:{toggleShields:!1}}}return i==="orbit"?{movement:sp(this.ship,n.velocity,r.position,this.orbitRadius),weapons:{firePrimary:!0,fireSecondary:!1,aimAt:vm(n.position,r.position,r.velocity,this.projectileSpeed)},utility:{toggleShields:!1}}:{movement:{thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:r.position},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.ship.getTransform(),i=this.target.getTransform();return ua(e.position,i.position,this.disengageRange)?null:new ra(this.controller,this.ship,this.target)}}class ra extends ko{constructor(e,i,n){super(e,i),this.engagementRange=1200,this.disengagementRange=5e3,this.target=n}update(){const e=this.ship.getTransform(),i=this.target.getTransform();return{movement:Ih(this.ship,i.position,e.velocity),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:i.position},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.ship.getTransform(),i=this.target.getTransform();if(ua(e.position,i.position,this.engagementRange))return new ZS(this.controller,this.ship,this.target);if(!this.controller.isHunter()){const n=Tt.getInstance().getPlayerShip();if(n){const r=n.getTransform();if(Rh(e.position,r.position)>4e3){const u=this.controller.getInitialState();if(u)return u}}}return null}}const rn=32e3,ha=32e3,hl={x:0,y:0};class bm extends ko{constructor(e,i){super(e,i),this.dwellTime=0,this.dwellDuration=4,this.patrolRadius=6e3,this.wakeRadius=3600,this.patrolTarget=this.chooseNewPatrolTarget()}update(e){const i=this.ship.getTransform().position,n=this.ship.getTransform().velocity;return ua(i,this.patrolTarget,100)?(this.dwellTime+=e,this.dwellTime>=this.dwellDuration&&(this.patrolTarget=this.chooseNewPatrolTarget(),this.dwellTime=0),{movement:{thrustForward:!1,brake:!0,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.patrolTarget},utility:{toggleShields:!1}}):{movement:Ih(this.ship,this.patrolTarget,n),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.patrolTarget},utility:{toggleShields:!1}}}transitionIfNeeded(){if(this.controller.isHunter()){const c=Tt.getInstance().getPlayerShip();if(c)return this.controller.setInitialState(new ra(this.controller,this.ship,c)),new ra(this.controller,this.ship,c)}const e=ym(this.ship,this.wakeRadius);if(!e)return null;const i=e.getTransform().position,n=this.ship.getTransform().position;return ua(n,i,this.wakeRadius)?new ra(this.controller,this.ship,e):null}chooseNewPatrolTarget(){const e=this.ship.getTransform().position,i=Math.random()*2*Math.PI,n=Math.random()*this.patrolRadius,r=e.x+Math.cos(i)*n,c=e.y+Math.sin(i)*n,u=1e3,h=-16e3+u,d=16e3-u,g=-16e3+u,m=16e3-u;return{x:Math.max(h,Math.min(d,r)),y:Math.max(g,Math.min(m,c))}}}class QS extends ko{constructor(e,i,n){super(e,i),this.attackRange=1600,this.projectileSpeed=400,this.target=n}update(e){const i=this.ship.getTransform(),n=this.target.getTransform();return{movement:{thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!0,fireSecondary:!1,aimAt:vm(i.position,n.position,n.velocity,this.projectileSpeed)},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.ship.getTransform(),i=this.target.getTransform();return ua(e.position,i.position,this.attackRange)?null:new Al(this.controller,this.ship)}}class Al extends ko{constructor(){super(...arguments),this.wakeRadius=1600}update(){return{movement:{thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:{x:0,y:0}},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.controller.getBehaviorProfile(),i=ym(this.ship,this.wakeRadius);if(!i)return null;const n=this.ship.getTransform().position,r=i.getTransform().position;return ua(n,r,this.wakeRadius)?(console.log("[AI] Behavior profile: ",e),e===Mm?new QS(this.controller,this.ship,i):new ra(this.controller,this.ship,i)):null}}const Sm={attack:"orbit",seek:"direct",initialStateFactory:a=>new bm(a,a.getShip())},js={attack:"ram",seek:"direct",initialStateFactory:a=>{const e=Tt.getInstance().getPlayerShip();return e?new ra(a,a.getShip(),e):(console.warn("[AI] RammingBehaviorProfile: Player ship not found, defaulting to IdleState"),new Al(a,a.getShip()))}},$S={attack:"strafe",seek:"flank",initialStateFactory:a=>new bm(a,a.getShip())},Mm={attack:"orbit",seek:"direct",initialStateFactory:a=>new Al(a,a.getShip())},po={rammingDamageInflictMultiplier:2,thrustPowerMulti:2,turnPowerMulti:2},Xs={thrustPowerMulti:3,turnPowerMulti:3},JS=[{id:1,type:"wave",mods:[],ships:[{shipId:"wave_0_00",count:24},{shipId:"wave_0_01",count:22},{shipId:"wave_0_02",count:16},{shipId:"wave_0_03",count:16},{shipId:"wave_0_04",count:18},{shipId:"wave_0_00",count:8,hunter:!0,affixes:Xs},{shipId:"wave_0_01",count:6,hunter:!0,affixes:Xs},{shipId:"wave_0_02",count:8,hunter:!0,affixes:Xs},{shipId:"wave_0_03",count:4,hunter:!0,affixes:Xs},{shipId:"wave_0_04",count:6,hunter:!0,affixes:Xs},{shipId:"/earlygame/ship_turret_00",count:4},{shipId:"/earlygame/ship_miniturret_00",count:8},{shipId:"/earlygame/ship_rammerspear_00",count:4,hunter:!0,behaviorProfile:js,affixes:po}]},{id:2,type:"wave",mods:["extra-aggressive"],ships:[{shipId:"wave_0_02",count:16,affixes:Xs},{shipId:"wave_0_03",count:16,affixes:Xs},{shipId:"/earlygame/ship_turret_00",count:10},{shipId:"/earlygame/ship_miniturret_00",count:8},{shipId:"/earlygame/ship_rammerspear_00",count:6,hunter:!0,behaviorProfile:js,affixes:po},{shipId:"/earlygame/ship_rammerhead_00",count:2,hunter:!0,behaviorProfile:js,affixes:po},{shipId:"/earlygame/ship_dragonfly_00",count:8,hunter:!0},{shipId:"/earlygame/ship_minifly_00",count:12,hunter:!0},{shipId:"/earlygame/ship_lanceturret_00",count:10},{shipId:"/earlygame/ship_sentry_00",count:12},{shipId:"/earlygame/ship_stalker_00",count:4,hunter:!0}]},{id:3,type:"wave",mods:["shielded"],ships:[{shipId:"/earlygame/ship_turret_00",count:14},{shipId:"/earlygame/ship_miniturret_00",count:22},{shipId:"/earlygame/ship_rammerspear_00",count:10,hunter:!0,behaviorProfile:js,affixes:po},{shipId:"/earlygame/ship_rammerhead_00",count:4,hunter:!0,behaviorProfile:js,affixes:po},{shipId:"/earlygame/ship_dragonfly_00",count:10,hunter:!0},{shipId:"/earlygame/ship_minifly_00",count:12,hunter:!0}]},{id:4,type:"boss",mods:["shielded","extra-aggressive"],ships:[{shipId:"boss_0_00",count:1,hunter:!0}],music:{file:"assets/sounds/music/track_03_boss.mp3"},lightingSettings:{clearColor:[.25,0,0,0]}}],e1={rammingDamageInflictMultiplier:2,thrustPowerMulti:2,turnPowerMulti:2},Kn={thrustPowerMulti:3,turnPowerMulti:3},eh=[{id:1,type:"wave",mods:[],ships:[{shipId:"wave_0_00",count:24},{shipId:"wave_0_01",count:22},{shipId:"wave_0_02",count:34},{shipId:"wave_0_03",count:22},{shipId:"wave_0_04",count:32},{shipId:"/earlygame/ship_rammerspear_00",count:4,hunter:!0,behaviorProfile:js,affixes:e1},{shipId:"mission_03/haloblade_pod_00",count:12},{shipId:"mission_03/haloblade_pod_01",count:8},{shipId:"mission_03/haloblade_pod_mini_00",count:10},{shipId:"mission_03/haloblade_speeder_00",count:4},{shipId:"mission_03/haloblade_beatle_00",count:2},{shipId:"mission_03/haloblade_beatle_01",count:4},{shipId:"mission_03/lance_miner_00",count:8},{shipId:"mission_03/lance_miner_00",count:2,hunter:!0},{shipId:"mission_03/lance_miner_station_00",count:4}]},{id:2,type:"wave",mods:[],ships:[{shipId:"wave_0_02",count:16,affixes:Kn},{shipId:"wave_0_03",count:16,affixes:Kn},{shipId:"mission_03/haloblade_pod_00",count:12},{shipId:"mission_03/haloblade_pod_01",count:8},{shipId:"mission_03/haloblade_pod_mini_00",count:12},{shipId:"mission_03/haloblade_speeder_00",count:4,hunter:!0},{shipId:"mission_03/haloblade_beetle_00",count:4,hunter:!0},{shipId:"mission_03/lance_miner_00",count:2},{shipId:"mission_03/lance_miner_station_00",count:4},{shipId:"mission_03/lance_miner_station_01",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:2},{shipId:"mission_03/haloblade_minicruiser_00",count:2},{shipId:"mission_03/haloblade_minicruiser_00",count:6},{shipId:"mission_03/lance_miner_00",count:12}]},{id:3,type:"wave",mods:[],ships:[{shipId:"mission_03/haloblade_minicruiser_00",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:6},{shipId:"mission_03/horrorhunter_00",count:4,hunter:!0},{shipId:"mission_03/horror_station_00",count:2},{shipId:"mission_03/horrorhunter_01",count:2,hunter:!0},{shipId:"mission_03/horrorhunter_02",count:2,hunter:!0},{shipId:"mission_03/horrorhunter_00",count:6},{shipId:"mission_03/horrorhunter_01",count:6},{shipId:"mission_03/horrorhunter_02",count:6},{shipId:"mission_03/speedhunter_00",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:4}]},{id:4,type:"wave",mods:[],ships:[{shipId:"mission_03/haloblade_minicruiser_00",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:6},{shipId:"mission_03/horrorhunter_00",count:10},{shipId:"mission_03/horror_station_00",count:2},{shipId:"mission_03/horrorhunter_01",count:4,hunter:!0},{shipId:"mission_03/horrorhunter_02",count:4,hunter:!0},{shipId:"mission_03/speedhunter_00",count:8},{shipId:"mission_03/haloblade_cruiser_00",count:4,hunter:!0}]},{id:5,type:"wave",mods:[],ships:[{shipId:"mission_03/haloblade_pod_00",count:6},{shipId:"mission_03/haloblade_pod_01",count:4},{shipId:"mission_03/haloblade_pod_mini_00",count:9,affixes:Kn},{shipId:"mission_03/haloblade_speeder_00",count:10,hunter:!0,affixes:Kn},{shipId:"mission_03/haloblade_beetle_00",count:12,hunter:!0,affixes:Kn},{shipId:"mission_03/lance_miner_00",count:4,hunter:!0},{shipId:"mission_03/lance_miner_station_00",count:6},{shipId:"mission_03/lance_miner_station_01",count:6},{shipId:"mission_03/haloblade_cruiser_00",count:12,hunter:!0,affixes:Kn},{shipId:"mission_03/haloblade_minicruiser_00",count:14,hunter:!0},{shipId:"mission_03/haloblade_minicruiser_00",count:16}]},{id:6,type:"boss",mods:["shielded","extra-aggressive"],ships:[{shipId:"mission_03/boss_03",count:1,hunter:!0}],music:{file:"assets/sounds/music/track_03_boss.mp3"},lightingSettings:{clearColor:[0,0,0,0]}}],fl={mission_001:{id:"mission_001",name:"Shipwright Second-Class",dialogue:"intro-briefing",waves:ip,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_4_00.png",gravity:0},music:{file:"assets/sounds/music/track_02_mission1.mp3"},enemyPower:.5,bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,requiredFlag:"mission.mission_001.unlocked",missionPortrait:null},mission_002:{id:"mission_002",name:"Starfield Gauntlet",dialogue:"mission-generic",waves:ip,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_4_00.png",gravity:0},music:{file:"assets/sounds/music/track_02_mission1.mp3"},enemyPower:1,bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,requiredFlag:"mission.mission_002.unlocked",missionPortrait:"assets/characters/bosses/character_boss_wildjoe.png"},mission_003_00:{id:"mission_003_00",name:"The Scrapyard Revenant",dialogue:"mission_003_00",waves:JS,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_9_00.png",gravity:0},planets:[{name:"Ferrust",x:-3e3,y:4e3},{name:"Gilipe",x:9e3,y:-4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_09_junkyard.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_003_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_crusher-mae.png"},mission_004_00:{id:"mission_004_00",name:"The Miner's Dillemma",dialogue:"mission-generic",waves:eh,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_10_00.png",gravity:0},planets:[{name:"Arsea",x:6e3,y:4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_05_mission3.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_004_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_executron-9b.png"},mission_005_00:{id:"mission_005_00",name:"WIP",dialogue:"mission-generic",waves:eh,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_10_00.png",gravity:0},planets:[{name:"Arsea",x:6e3,y:4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_05_mission3.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_005_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_jackpot-vera.png"},mission_006_00:{id:"mission_006_00",name:"WIP",dialogue:"mission-generic",waves:eh,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_10_00.png",gravity:0},planets:[{name:"Arsea",x:6e3,y:4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_05_mission3.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_006_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_admiral-pith.png"}};class t1{constructor(){this.currentMission=null}setMission(e){this.currentMission=e,e.music&&Q.playMusic(e.music)}getMission(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission}getDropMultiplier(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.dropMultiplier??1}getMissionById(e){return fl[e]??null}getMissionDialogue(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.dialogue??null}getEnemyPower(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.enemyPower??1}getPlanetSpawnConfigs(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.planets??[]}clear(){this.currentMission=null}}const qi=new t1,i1="assets/title_screen.png";function s1(a){return!!localStorage.getItem(`save${a}`)}const np=300,n1=10,a1=16,o1=2,ap=280,op=280,r1=320,l1=120;class c1{constructor(e,i,n){this.backgroundImage=null,this.buttons=[],this.saveSlotButtons=[],this.showingSaveSlots=!1,this.confirmingDeleteSlot=null,this.confirmationButtons=[],this.saveSlotYOffsets=[0,0,0],this.saveSlotAnimationPhase=null,this.isAnimatingSlots=!1,this.update=r=>{const c=ae(),u=n1*c,h=a1*c,d=o1*c,g=np*c;if(this.isAnimatingSlots){if(this.saveSlotAnimationPhase==="sliding-up"){for(let S=0;S<this.saveSlotYOffsets.length;S++)this.saveSlotYOffsets[S]-=u;this.saveSlotYOffsets[0]<=-h&&(this.saveSlotAnimationPhase="settling")}else if(this.saveSlotAnimationPhase==="settling"){for(let S=0;S<this.saveSlotYOffsets.length;S++)this.saveSlotYOffsets[S]+=d,this.saveSlotYOffsets[S]>0&&(this.saveSlotYOffsets[S]=0);this.saveSlotYOffsets.every(S=>S===0)&&(this.isAnimatingSlots=!1,this.saveSlotAnimationPhase=null)}else if(this.saveSlotAnimationPhase==="sliding-down"){for(let S=0;S<this.saveSlotYOffsets.length;S++)this.saveSlotYOffsets[S]+=u;this.saveSlotYOffsets[0]>=g&&(this.isAnimatingSlots=!1,this.saveSlotAnimationPhase=null,this.showingSaveSlots=!1,this.saveSlotButtons=[],this.buttons=this.createMainButtons(),this.saveSlotYOffsets=[0,0,0])}}this.inputManager.updateFrame();const{x:m,y}=this.inputManager.getMousePosition(),v=this.inputManager.wasMouseClicked(),M=this.confirmingDeleteSlot!==null?this.confirmationButtons:[...this.buttons,...this.saveSlotButtons];for(const S of M)As(S,m,y,v,c)},this.render=r=>{this.canvasManager.clearAll();const c=ae(),u=this.canvasManager.getContext("background"),h=this.canvasManager.getContext("ui");this.backgroundImage&&u.drawImage(this.backgroundImage,0,0,u.canvas.width,u.canvas.height);for(const m of this.buttons)lt(h,m,c);if(this.showingSaveSlots)for(const m of this.saveSlotButtons){const y=m.slotIndex,v=this.saveSlotYOffsets[y]??0,M=m.y;m.y+=v,lt(h,m,c),m.y=M}if(this.confirmingDeleteSlot!==null){Mt({ctx:h,x:ap*c,y:op*c,width:r1,height:l1,title:"Confirm Deletion",mouse:this.inputManager.getMousePosition(),clicked:this.inputManager.wasMouseClicked(),uiScale:c,options:{borderColor:"#ff0000",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#200000"},{offset:1,color:"#100000"}]}}});const m=14*c;h.fillStyle="#ff4444",h.font=`${Math.round(m)}px monospace`,h.fillText("Erase this save file?",300*c,320*c);for(const y of this.confirmationButtons)lt(h,y,c)}const d=this.inputManager.getMousePosition(),g=an();la(h,g,d.x,d.y,c)},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.buttons=this.createMainButtons()}async start(){Q.playMusic({file:"assets/sounds/music/track_08_debriefing.mp3"}),this.backgroundImage=await ca(i1),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}createMainButtons(){const e=ae(),i=40,n=460*e,r=200,c=60,u=10,h={borderRadius:10,alpha:1,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}},d={borderRadius:10,alpha:1,borderColor:"#ffaa00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#221100"},{offset:1,color:"#150a00"}]}},g=[],m=c*e+u*e;return g.push({x:i,y:n+m*0,width:r,height:c,label:this.showingSaveSlots?"Back":"Play",isHovered:!1,onClick:()=>{if(Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),this.showingSaveSlots)this.saveSlotAnimationPhase="sliding-down",this.isAnimatingSlots=!0;else{const y=np*e;this.saveSlotYOffsets=[y,y,y],this.saveSlotAnimationPhase="sliding-up",this.isAnimatingSlots=!0,this.showingSaveSlots=!0,this.saveSlotButtons=this.createSaveSlotButtons(),this.buttons=this.createMainButtons()}},style:this.showingSaveSlots?d:h}),g.push({x:i,y:n+m*1,width:r,height:c,label:"Credits",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),console.log("Credits clicked (not implemented)")},style:h}),kh()&&g.push({x:i,y:n+m*2,width:r,height:c,label:"Quit",isHovered:!1,onClick:()=>{var y;Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),(y=window==null?void 0:window.electronAPI)!=null&&y.closeGame?window.electronAPI.closeGame():console.warn("Quit button pressed, but electronAPI.closeGame is not available.")},style:h}),g}createSaveSlotButtons(){const e=ae(),i=260,n=460*e,r=260,c=60,u=10,h={borderRadius:10,alpha:1,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}},d=[];for(let g=0;g<3;g++){const m=s1(g),y=m?`Load Save ${g+1}`:"New Game",v=c*e+u*e,M=r*e+u*e,S=r*e;d.push({x:i*e,y:n+v*g,width:r,height:c,label:y,isHovered:!1,onClick:()=>{rt.initialize(g);const T=rt.getInstance();Q.play("assets/sounds/sfx/ui/start_00.wav","sfx"),T.changeSlot(g),m?(T.loadAll(),this.stop(),mt.fadeToScene("hub")):(qi.setMission(fl.mission_001),this.stop(),mt.fadeToScene("mission"))},style:h,slotIndex:g}),m&&d.push({x:i+M+.65*S,y:n+v*g,width:40,height:c,label:"X",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.confirmingDeleteSlot=g,this.createConfirmationButtons()},style:{...h,borderColor:"#ff0000",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#220000"},{offset:1,color:"#110000"}]}},slotIndex:g})}return d}createConfirmationButtons(){const e=ae(),i=ap*e,n=op*e,r=i+40*e,c=n+60*e,u=100,h=40,g=u*e+20*e;this.confirmationButtons=[{x:r,y:c,width:u,height:h,label:"Yes",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),this.confirmingDeleteSlot!==null&&(rt.eraseSave(this.confirmingDeleteSlot),this.saveSlotButtons=this.createSaveSlotButtons()),this.confirmingDeleteSlot=null,this.confirmationButtons=[]},style:{borderRadius:6,borderColor:"#00ff00",textFont:"16px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#003300"},{offset:1,color:"#001900"}]}}},{x:r+g,y:c,width:u,height:h,label:"No",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),this.confirmingDeleteSlot=null,this.confirmationButtons=[]},style:{borderRadius:6,borderColor:"#ff0000",textFont:"16px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#330000"},{offset:1,color:"#190000"}]}}}]}}class Cs{constructor(){this.stack=[],this.registry={}}static getInstance(){return Cs.instance||(Cs.instance=new Cs),Cs.instance}reset(){this.clearAll();for(const e in this.registry)delete this.registry[e];this.pauseFn=void 0,this.resumeFn=void 0}registerPauseHandlers(e,i){this.pauseFn=e,this.resumeFn=i}pause(){var e;(e=this.pauseFn)==null||e.call(this)}resume(){var e;(e=this.resumeFn)==null||e.call(this)}open(e){this.getTop()!==e&&(this.stack.includes(e)||this.stack.push(e),e.openMenu())}close(e){const i=this.stack.indexOf(e);i!==-1&&(this.stack.splice(i,1),e.closeMenu())}transition(e){this.pop(),this.open(e)}pop(){const e=this.stack.pop();e==null||e.closeMenu()}getTop(){return this.stack.length>0?this.stack[this.stack.length-1]:null}anyOpen(){return this.stack.length>0}clearAll(){var e;for(;this.stack.length>0;)(e=this.stack.pop())==null||e.closeMenu()}registerMenu(e,i){this.registry[e]=i}getMenu(e){return this.registry[e]}}function xh(a){const{mode:e,fontOverride:i,forceErgonomic:n=!0}=a,r=ae(),c=e==="inPerson";let u=a.side;n&&Cs.getInstance().anyOpen()&&(u="right");const h=u==="right",d=c?{x:320*r,y:120*r,width:520*r,height:140*r}:h?{x:590*r,y:20*r,width:500*r,height:120*r}:{x:180*r,y:20*r,width:500*r,height:120*r},g=c?{x:80*r,y:420*r}:h?{x:1130*r,y:20*r}:{x:20*r,y:20*r},y=i??`${Math.round((c?24:20)*r)}px monospace`;return{textBoxRect:d,position:g,font:y}}class u1{constructor(){this.profiles=new Map,this.portraitCache=new Map,this.loadDefaults()}loadDefaults(){this.register({id:"marla",portrait:this.loadImage("assets/characters/character_marla-thinx.png"),blipAudioFile:"assets/sounds/bleeps/girl_ah.wav",basePitch:1.2,textSpeed:.04,pitchVariance:.3,syllableDuration:120,portraitOffset:{x:-100,y:-200}}),this.register({id:"rexor",portrait:this.loadImage("assets/characters/character_rexor-the-intern.png"),blipAudioFile:"assets/sounds/bleeps/man_eh.wav",textSpeed:.04,basePitch:.85,pitchVariance:.15,portraitOffset:{x:-100,y:-200}}),this.register({id:"carl",portrait:this.loadImage("assets/characters/character_carl.png"),blipAudioFile:"assets/sounds/bleeps/man_ah.wav",textSpeed:.04,pitchVariance:.5,syllableDuration:100,basePitch:.95}),this.register({id:"hero",portrait:this.loadImage("assets/characters/character_hero.png"),blipAudioFile:"assets/sounds/bleeps/man_ee.wav",basePitch:1}),this.register({id:"the-board",portrait:this.loadImage("assets/characters/character_the-board.png"),blipAudioFile:"assets/sounds/bleeps/girl_oh.wav",basePitch:1.1}),this.register({id:"crazy-moe",portrait:this.loadImage("assets/characters/bosses/character_boss_wildjoe.png"),blipAudioFile:"assets/sounds/bleeps/man_eh.wav",basePitch:.8,textSpeed:.05,pitchVariance:.5}),this.register({id:"executron",portrait:this.loadImage("assets/characters/bosses/character_boss_executron-9b.png"),blipAudioFile:"assets/sounds/bleeps/man_ah.wav",basePitch:.9,textSpeed:.05,pitchVariance:.5})}loadImage(e){const i=Mi(e);if(this.portraitCache.has(i))return this.portraitCache.get(i);const n=new Image;return n.src=i,this.portraitCache.set(i,n),n}register(e){this.profiles.set(e.id,e)}getProfile(e){return this.profiles.get(e)}getAll(){return this.profiles}}const _h=new u1;class h1{constructor(e,i,n=()=>!1){this.events=e,this.orchestrator=i,this.shouldInterrupt=n,this.index=0,this.isBlocked=!1,this.pauseTimerMs=null,this.pendingCommand=null,this.requestedVisualFocus=!1,this.hasVisualFocus=!1,this.forceRightSide=!1,this.onMenuOpened=({id:r})=>{r==="blockDropDecisionMenu"&&(this.forceRightSide=!0)},this.onMenuClosed=({id:r})=>{r==="blockDropDecisionMenu"&&(this.forceRightSide=!1)},pe.on("menu:opened",this.onMenuOpened),pe.on("menu:closed",this.onMenuClosed)}destroy(){pe.off("menu:opened",this.onMenuOpened),pe.off("menu:closed",this.onMenuClosed),this.orchestrator.destroy()}update(e){var n,r,c,u,h,d;if(this.shouldInterrupt()){this.clear();return}if(this.orchestrator.update(e),this.pauseTimerMs!==null){this.pauseTimerMs-=e*1e3,this.pauseTimerMs<=0&&(this.pauseTimerMs=null,this.isBlocked=!1);return}if(this.pendingCommand||this.isBlocked&&!this.orchestrator.isFinished()||this.index>=this.events.length)return;const i=this.events[this.index++];switch(i.type){case"line":{if(this.requestedVisualFocus=!0,!this.hasVisualFocus){this.index--;return}this.orchestrator.setVisualsVisible(!0),this.isBlocked=!0;const g=((n=i.options)==null?void 0:n.side)??"left",m=this.forceRightSide?"right":g,y=((r=i.options)==null?void 0:r.mode)??"transmission",v=(c=i.options)==null?void 0:c.font,{textBoxRect:M,position:S,font:T}=xh({mode:y,side:m,fontOverride:v});this.orchestrator.startDialogue({speakerId:i.speakerId,text:i.text,textColor:(u=i.options)==null?void 0:u.textColor,font:T,textBoxRect:M,textBoxAlpha:((h=i.options)==null?void 0:h.textBoxAlpha)??.8,position:S,mode:y,side:m,textSpeed:(d=_h.getProfile(i.speakerId))==null?void 0:d.textSpeed});return}case"pause":{this.isBlocked=!0,this.pauseTimerMs=i.durationMs;return}case"command":{this.isBlocked=!0;const g=i.run();g instanceof Promise?this.pendingCommand=g.then(()=>{this.isBlocked=!1,this.pendingCommand=null}):this.isBlocked=!1;return}case"showUI":{this.orchestrator.setVisualsVisible(!0);return}case"hideUI":{this.orchestrator.setVisualsVisible(!1);return}case"endIf":{i.condition()&&this.clear();return}}}render(e){this.orchestrator.render(e)}isFinished(){return this.index>=this.events.length&&!this.isBlocked}wantsVisualFocus(){return this.requestedVisualFocus&&!this.hasVisualFocus}grantVisualFocus(){this.hasVisualFocus=!0}clear(){this.index=this.events.length,this.orchestrator.clear()}skipToEnd(){var e,i;(i=(e=this.orchestrator).skipToEnd)==null||i.call(e)}}class f1{constructor(e){this.orchestratorFactory=e,this.allRunners=new Set,this.renderQueue=[],this.currentRenderer=null,this.runnerMap=new Map}startAsync(e,i,n){if(n&&this.runnerMap.has(n))return;const r=new h1(e,this.orchestratorFactory(),i);this.allRunners.add(r),n&&this.runnerMap.set(n,r)}update(e){for(const i of this.allRunners)if(i.update(e),i.wantsVisualFocus()&&!this.renderQueue.includes(i)&&this.renderQueue.push(i),i.isFinished()){this.allRunners.delete(i),i===this.currentRenderer&&(this.currentRenderer=null);for(const[n,r]of this.runnerMap.entries())if(r===i){this.runnerMap.delete(n);break}i.destroy()}!this.currentRenderer&&this.renderQueue.length>0&&(this.currentRenderer=this.renderQueue.shift(),this.currentRenderer.grantVisualFocus())}render(e){var i;(i=this.currentRenderer)==null||i.render(e)}clearAll(){for(const e of this.allRunners)e.clear();this.allRunners.clear(),this.runnerMap.clear(),this.renderQueue.length=0,this.currentRenderer=null}destroy(){for(const e of this.allRunners)e.destroy();this.allRunners.clear(),this.runnerMap.clear(),this.renderQueue.length=0,this.currentRenderer=null}hasActiveRunners(){return this.allRunners.size>0}getActiveRunnerCount(){return this.allRunners.size}}class d1{constructor(){this.vowels=new Set("aeiouyAEIOUY")}segment(e){if(!e)return[];const i=[];let n="";for(let r=0;r<e.length;r++){const c=e[r],u=e[r+1];if(n+=c,this.vowels.has(c)&&(!u||!this.vowels.has(u))){let h=r+1;for(;h<e.length&&!this.vowels.has(e[h]);)h++;(h-r===2&&h<e.length||h-r>2||h===e.length)&&(i.push(n),n="")}}return n&&i.push(n),i.length>0?i:[e]}}const g1=new d1;function p1(a,e){const i=a.trim().split(/\s+/),n=[];let r=0;const c=e.syllableDuration??120,u=e.pitchVariance??0;for(const h of i){const d=g1.segment(h);for(const g of d){const m=e.basePitch+u*(Math.random()-.5);n.push({syllable:g,timestamp:r/1e3,duration:c/1e3,audioFile:e.blipAudioFile,pitch:m}),r+=c}r+=80}return n}class m1{constructor(e,i,n,r,c){this.portraitRenderer=e,this.textboxRenderer=i,this.textRenderer=n,this.audioSynchronizer=r,this.speakerRegistry=c,this.activeLine=null,this.blipTimeline=[],this.elapsed=0,this.finished=!1,this.visualsVisible=!0,this.forceRightSide=!1,this.onMenuOpened=({id:u})=>{u==="blockDropDecisionMenu"&&(this.forceRightSide=!0)},this.onMenuClosed=({id:u})=>{u==="blockDropDecisionMenu"&&(this.forceRightSide=!1)},pe.on("menu:opened",this.onMenuOpened),pe.on("menu:closed",this.onMenuClosed)}destroy(){pe.off("menu:opened",this.onMenuOpened),pe.off("menu:closed",this.onMenuClosed)}startDialogue(e){const i=this.speakerRegistry.getProfile(e.speakerId);if(!i){console.warn(`Unknown speaker ID: ${e.speakerId}`);return}this.activeLine=e,this.elapsed=0,this.finished=!1,this.textRenderer.start(e),this.blipTimeline=p1(e.text,i),this.audioSynchronizer.start(this.blipTimeline)}update(e){!this.activeLine||this.finished||(this.elapsed+=e,this.textRenderer.update(e),this.audioSynchronizer.update(this.elapsed),this.textRenderer.isFinished()&&(this.finished=!0))}render(e){if(!this.visualsVisible||!this.activeLine)return;const i=this.activeLine,n=this.speakerRegistry.getProfile(i.speakerId);if(!n)return;const r=xh({mode:i.mode,side:this.forceRightSide?"right":i.side,fontOverride:i.font});this.portraitRenderer.render(e,r.position,i,n),this.textboxRenderer.render(e,r.textBoxRect,i,n),this.textRenderer.render(e,r.textBoxRect,r.font,i)}skipToEnd(){var e,i,n,r;!this.activeLine||this.finished||((i=(e=this.textRenderer).skipToEnd)==null||i.call(e),(r=(n=this.audioSynchronizer).skipToEnd)==null||r.call(n),this.finished=!0)}isFinished(){return this.finished}clear(){this.activeLine=null,this.elapsed=0,this.finished=!1,this.textRenderer.clear(),this.audioSynchronizer.clear()}setVisualsVisible(e){this.visualsVisible=e}getVisualsVisible(){return this.visualsVisible}}class y1{constructor(){this.baseLargePortraitSize={width:512,height:512},this.baseSmallPortraitSize={width:128,height:128}}render(e,i,n,r){const c=ae(),{portrait:u,portraitOffset:h}=r,{x:d,y:g}=i,m=n.mode==="transmission",y=((h==null?void 0:h.x)??0)*c,v=((h==null?void 0:h.y)??0)*c,M=d+y,S=g+v,T=m?this.baseSmallPortraitSize:this.baseLargePortraitSize,w=T.width*c,A=T.height*c;m&&this.drawTransmissionFrame(e,M,S,w,A,c),e.drawImage(u,M,S,w,A),m&&this.drawTransmissionOverlay(e,M,S,w,A,c)}drawTransmissionFrame(e,i,n,r,c,u){e.save(),e.strokeStyle="#00ff88",e.lineWidth=2*u;const h=4*u;e.strokeRect(i-h,n-h,r+2*h,c+2*h),e.restore()}drawTransmissionOverlay(e,i,n,r,c,u){e.save(),e.fillStyle="rgba(0, 255, 100, 0.05)",e.fillRect(i,n,r,c),e.strokeStyle="rgba(0, 255, 100, 0.12)",e.lineWidth=1*u;const h=4*u;for(let d=0;d<c;d+=h)e.beginPath(),e.moveTo(i,n+d),e.lineTo(i+r,n+d),e.stroke();e.restore()}}class v1{render(e,i,n,r){const{x:c,y:u,width:h,height:d}=i;n.mode==="transmission"||r.transmissionStyle?this.drawTransmissionBox(e,c,u,h,d):this.drawSpeechBubble(e,c,u,h,d,n.textBoxAlpha??.8)}drawSpeechBubble(e,i,n,r,c,u){e.save(),e.fillStyle="#000000",e.globalAlpha=u,e.beginPath(),e.moveTo(i+16,n),e.lineTo(i+r-16,n),e.quadraticCurveTo(i+r,n,i+r,n+16),e.lineTo(i+r,n+c-16),e.quadraticCurveTo(i+r,n+c,i+r-16,n+c),e.lineTo(i+16,n+c),e.quadraticCurveTo(i,n+c,i,n+c-16),e.lineTo(i,n+16),e.quadraticCurveTo(i,n,i+16,n),e.closePath(),e.fill(),e.beginPath(),e.moveTo(i+40,n+c),e.lineTo(i+32,n+c+12),e.lineTo(i+48,n+c),e.fill(),e.restore()}drawTransmissionBox(e,i,n,r,c){e.save(),e.fillStyle="rgba(0, 255, 100, 0.08)",e.fillRect(i,n,r,c),e.strokeStyle="#00ff88",e.lineWidth=2,e.strokeRect(i-1,n-1,r+2,c+2),e.strokeStyle="rgba(0, 255, 100, 0.07)";for(let u=2;u<c;u+=4)e.beginPath(),e.moveTo(i,n+u),e.lineTo(i+r,n+u),e.stroke();e.restore()}}class b1{constructor(){this.fullText="",this.lines=[],this.revealedCharCount=0,this.elapsed=0,this.charDelay=.075,this.paddingX=16,this.baseLineHeight=22}start(e){this.fullText=e.text,this.lines=this.wrapText(e),this.revealedCharCount=0,this.elapsed=0,this.charDelay=e.textSpeed??this.charDelay}update(e){this.elapsed+=e;const i=Math.floor(this.elapsed/this.charDelay);this.revealedCharCount=Math.min(i,this.fullText.length)}render(e,i,n,r){const c=ae(),{x:u,y:h,width:d,height:g}=i,m=r.textColor??(r.mode==="transmission"?"#00ff88":"#ffffff"),y=this.baseLineHeight*c,v=this.paddingX*c;e.save(),e.font=n,e.fillStyle=m,e.textAlign="left";const M=Math.floor(g/y)-1;let S=this.revealedCharCount,T=h+32*c;for(let w=0;w<this.lines.length&&w<M;w++){const A=this.lines[w];if(S<=0)break;const R=A.slice(0,S);e.fillText(R,u+v,T),T+=y,S-=A.length}this.lines.length>M&&S>0&&e.fillText("",u+d-v-8*c,T-y),e.restore()}isFinished(){return this.revealedCharCount>=this.fullText.length}clear(){this.fullText="",this.lines=[],this.revealedCharCount=0,this.elapsed=0}skipToEnd(){this.revealedCharCount=this.fullText.length,this.elapsed=this.fullText.length*this.charDelay}wrapText(e){const{width:i}=e.textBoxRect,n=e.text.split(/\s+/),r=document.createElement("canvas").getContext("2d");r.font=e.font??"24px monospace";const c=ae(),u=this.paddingX*c,h=[];let d="";for(const g of n){const m=d?`${d} ${g}`:g;r.measureText(m).width>i-2*u&&d?(h.push(d),d=g):d=m}return d&&h.push(d),h}}class S1{constructor(e){this.playSound=e,this.timeline=[],this.currentIndex=0}start(e){this.timeline=e,this.currentIndex=0}update(e){for(;this.currentIndex<this.timeline.length&&this.timeline[this.currentIndex].timestamp<=e;){const i=this.timeline[this.currentIndex];this.playSound(i.audioFile,{pitch:i.pitch}),this.currentIndex++}}skipToEnd(){for(;this.currentIndex<this.timeline.length;this.currentIndex++){const e=this.timeline[this.currentIndex];this.playSound(e.audioFile,{pitch:e.pitch})}}clear(){this.timeline=[],this.currentIndex=0}}class Tm{static create(){return new m1(new y1,new v1,new b1,new S1((e,i)=>Q.play(e,"dialogue",i)),_h)}}const rp=800;class M1{constructor(e){this.orchestrator=e,this.currentScript=null,this.currentIndex=0,this.isActive=!1,this.isBlocked=!1,this.pauseTimerMs=null,this.postLineDelay=0,this.pendingCommand=null,this.activeSpeakerId=null,this.activeSpeakerOptions={},this.asyncManager=new f1(()=>Tm.create())}startScript(e){this.currentScript=e,this.currentIndex=0,this.postLineDelay=0,this.isActive=!0,this.isBlocked=!1,this.pendingCommand=null,this.advance()}advance(){var i,n,r,c,u,h;if(!this.currentScript||this.currentIndex>=this.currentScript.events.length){this.clear();return}const e=this.currentScript.events[this.currentIndex];switch(this.currentIndex++,e.type){case"line":{this.orchestrator.setVisualsVisible(!0),this.isBlocked=!0;const d=this.currentScript.defaultMode??"inPerson",g=((i=e.options)==null?void 0:i.mode)??this.activeSpeakerOptions.mode??d,m=((n=e.options)==null?void 0:n.side)??this.activeSpeakerOptions.side??"left",y=e.speakerId??this.activeSpeakerId;if(!y){console.warn("No speaker defined for line event"),this.advance();return}const v=((r=e.options)==null?void 0:r.textColor)??this.activeSpeakerOptions.textColor,M=((c=e.options)==null?void 0:c.font)??this.activeSpeakerOptions.font,{textBoxRect:S,position:T,font:w}=xh({mode:g,side:m,fontOverride:M});this.orchestrator.startDialogue({speakerId:y,text:e.text,textColor:v,font:w,textBoxRect:S,textBoxAlpha:((u=e.options)==null?void 0:u.textBoxAlpha)??.8,position:T,mode:g,side:m,textSpeed:(h=_h.getProfile(y))==null?void 0:h.textSpeed});return}case"pause":{this.isBlocked=!0,this.pauseTimerMs=e.durationMs;return}case"command":{this.isBlocked=!0;const d=e.run();d instanceof Promise?this.pendingCommand=d.then(()=>{this.isBlocked=!1,this.pendingCommand=null}):this.isBlocked=!1;return}case"async":{this.asyncManager.startAsync(e.dialogue,()=>!this.isRunning()),this.advance();return}case"hideUI":{this.orchestrator.setVisualsVisible(!1),this.advance();return}case"showUI":{this.orchestrator.setVisualsVisible(!0),this.advance();return}case"endIf":{e.condition()?this.clear():this.advance();return}case"changespeaker":{this.activeSpeakerId=e.speakerId,this.activeSpeakerOptions=e.options??{},this.advance();return}default:{console.warn(`Unknown dialogue event type: ${e.type}`),this.advance();return}}}update(e){if(this.isActive){if(this.asyncManager.update(e),this.orchestrator.update(e),this.pauseTimerMs!==null){this.pauseTimerMs-=e*1e3,this.pauseTimerMs<=0&&(this.pauseTimerMs=null,this.isBlocked=!1,this.postLineDelay=rp);return}if(this.postLineDelay>0){this.postLineDelay-=e*1e3;return}if(!this.pendingCommand){if(this.isBlocked){this.orchestrator.isFinished()&&(this.isBlocked=!1,this.postLineDelay=rp);return}this.advance()}}}render(e){this.isActive&&(this.orchestrator.render(e),this.asyncManager.render(e))}skipOrAdvance(){var e,i;this.isActive&&(this.orchestrator.isFinished()?!this.pendingCommand&&!this.isBlocked&&this.postLineDelay<=0&&this.advance():(i=(e=this.orchestrator).skipToEnd)==null||i.call(e))}isRunning(){return this.isActive}clear(){this.currentScript=null,this.currentIndex=0,this.postLineDelay=0,this.isActive=!1,this.isBlocked=!1,this.pendingCommand=null,this.orchestrator.clear(),this.asyncManager.clearAll()}destroy(){this.clear(),this.orchestrator.destroy(),this.asyncManager.destroy()}}class Eo{static create(){const e=Tm.create();return new M1(e)}}function T1(a){return{id:"test-script",defaultMode:"inPerson",events:[{type:"line",speakerId:"marla",text:"Excuse me. You are not authorized to take a break right now Shipwright!"}]}}function ot(a,e=100){return new Promise(i=>{const n=()=>{a()?i():setTimeout(n,e)};n()})}function C1(a){const{inputManager:e}=a;if(!e)throw new Error("Input manager is required for hub arrival dialogue");return{id:"hub-introduction-1",defaultMode:"inPerson",events:[{type:"pause",durationMs:500},{type:"line",speakerId:"marla",text:"Welcome to HQ. Please do not mistake this for a place of safety. It is merely where the paperwork lives."},{type:"line",speakerId:"marla",text:"I'm Marla Thinx, Account Liaison. My role is to observe, log, and gently discourage noncompliance. Occasionally I blink."},{type:"line",speakerId:"marla",text:"Your continued operation has triggered a provisional classification of 'survivor'. Please do not interpret this as encouragement."},{type:"line",speakerId:"marla",text:"You've been assigned a docking alcove, a breakroom with two functioning chairs, and access to the Passive Allocation Terminal."},{type:"line",speakerId:"marla",text:"You are now eligible for one (1) certified enhancement. The intern will explain. He insisted."},{type:"pause",durationMs:500},{type:"line",speakerId:"rexor",text:"Hey! You're not soup! That's great news!"},{type:"line",speakerId:"rexor",text:"You got your first passive point. The terminal still thinks it's a coffee machine, but it'll work."},{type:"line",speakerId:"rexor",text:"Go poke it and pick something. Might even help you not die. Or at least die slightly slower."},{type:"command",run:()=>{Re.set("hub.passive-terminal.unlocked"),Re.set("hub.introduction-1.complete")}}]}}function w1(a){const{inputManager:e}=a;if(!e)throw new Error("Input manager is required for hub arrival dialogue");return{id:"hub-introduction-2",defaultMode:"inPerson",events:[{type:"command",run:()=>{e.disableInput()}},{type:"pause",durationMs:2e3},{type:"line",options:{textBoxAlpha:1},speakerId:"rexor",text:"Pick a categoryOffense, Defense, Utility. Then slap a point into whatever looks shiny."},{type:"line",options:{textBoxAlpha:1},speakerId:"rexor",text:"Each upgrade stacks up to three times. Click confirm to make it official and mildly irreversible."},{type:"command",run:()=>{pt.getInstance().getAvailablePoints()===0&&pt.getInstance().addPassivePoints(1)}},{type:"hideUI"},{type:"command",run:()=>{e.enableInput()}},{type:"command",run:()=>ot(()=>pt.getInstance().hasAnyPassives())},{type:"showUI"},{type:"line",speakerId:"rexor",text:"Nice! You're now technically enhanced. Should make it slightly easier to extract value from volatile assets."},{type:"command",run:()=>{Re.set("hub.introduction-2.complete")}}]}}function A1(a){const{inputManager:e}=a;if(!e)throw new Error("Input manager is required for hub arrival dialogue");return{id:"hub-introduction-3",defaultMode:"inPerson",events:[{type:"line",speakerId:"marla",text:"Now that you've invested in personal development, you're eligible for further hazard deployment."},{type:"line",speakerId:"marla",text:"We've identified an unsanctioned scrapper cluster operating in Entropium-positive territory under Deep Void jurisdiction."},{type:"line",speakerId:"marla",text:"They are not employees. Their ships are not assets. Their existence constitutes a yield inefficiency."},{type:"line",speakerId:"marla",text:"Your directive is to reclaim all viable matter. Structural integrity is optional. Entropium output is not."},{type:"line",speakerId:"marla",text:"Proceed to the mission terminal. Further delays will be logged."},{type:"command",run:()=>{Re.set("hub.introduction-3.complete"),Re.set("hub.mission-computer.unlocked"),Re.set("hub.breakroom.unlocked"),Re.set("mission.scrapper-revenant.unlocked")}}]}}class Be{constructor(){this.currency=0,this.blockQueue=[],this.onCurrencyChangeCallbacks=new Set}static getInstance(){return Be.instance||(Be.instance=new Be),Be.instance}initialize(e=0){this.currency=e}getCurrency(){return this.currency}hasEnoughCurrency(e){return this.currency>=e}addCurrency(e){return e<=0?this.currency:(this.currency+=e,this.notifyCurrencyChange(),this.currency)}spendCurrency(e){return e<=0?!0:this.currency<e?!1:(this.currency-=e,this.notifyCurrencyChange(),!0)}onCurrencyChange(e){return this.onCurrencyChangeCallbacks.add(e),()=>this.onCurrencyChangeCallbacks.delete(e)}notifyCurrencyChange(){for(const e of this.onCurrencyChangeCallbacks)e(this.currency)}enqueueBlock(e){this.blockQueue.push(e)}enqueueBlockToFront(e){this.blockQueue.unshift(e)}dequeueBlock(){return this.blockQueue.shift()??null}getBlockQueue(){return this.blockQueue}getBlockCount(){return this.blockQueue.length}hasBlocks(){return this.blockQueue.length>0}queueSize(){return this.blockQueue.length}getLastGatheredBlock(){return this.blockQueue.length>0?this.blockQueue[this.blockQueue.length-1]:null}reset(){this.currency=0,this.blockQueue=[],this.notifyCurrencyChange()}destroy(){this.currency=0,this.blockQueue=[],this.onCurrencyChangeCallbacks.clear()}postMissionClear(){this.blockQueue=[],this.onCurrencyChangeCallbacks.clear()}}function k1(a,e,i){xt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadShoulders",highlighted:["leftBumper"],width:160,height:80,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"key",keyLabel:"Shift",width:60,height:60,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0})}function E1(a,e,i){xt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadFaceButtons",highlightButton:"Y",radius:50,fontSize:18,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",textColor:"#FFFFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"key",keyLabel:"Tab",width:50,height:50,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0})}function R1(a,e,i){xt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadFaceButtons",highlightButton:"X",radius:50,fontSize:18,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",textColor:"#FFFFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"key",keyLabel:"X",width:50,height:50,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0})}function B1(a,e,i){xt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadSticks",wiggleStick:"right",highlightStick:"right",width:120,height:60,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"mouse",interactionMode:"wiggle",width:60,height:90,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0})}function I1(a,e,i){xt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadShoulders",highlighted:["rightBumper"],width:160,height:80,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"mouse",interactionMode:"leftClick",width:60,height:90,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0})}function x1(a,e,i){if(xt.getInstance().getLastUsed()==="gamepad")a.createScreenCoachMark("",e,i,{type:"gamepadSticks",wiggleStick:"left",highlightStick:"left",width:120,height:60,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0});else{const c={type:"key",width:50,height:50,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0};a.createScreenCoachMark("",e,i-80,{...c,keyLabel:"W"}),a.createScreenCoachMark("",e-80,i,{...c,keyLabel:"A"}),a.createScreenCoachMark("",e,i,{...c,keyLabel:"S"}),a.createScreenCoachMark("",e+80,i,{...c,keyLabel:"D"})}}const lp=Be.getInstance();function _1(a){const{inputManager:e,waveSpawner:i,playerShip:n,coachMarkManager:r}=a;if(!e)throw new Error("Input manager is required for intro briefing");if(!i)throw new Error("Wave spawner is required for intro briefing");if(!n)throw new Error("Player ship is required for intro briefing");if(!r)throw new Error("Coach mark manager is required for intro briefing");return{id:"intro-briefing",defaultMode:"transmission",events:[{type:"endIf",condition:()=>Re.has("mission.intro-briefing.complete")},{type:"command",run:()=>{e.disableAllActions()}},{type:"pause",durationMs:1e3},{type:"line",speakerId:"carl",text:"Greetings, Shipwright Second Class. Assessing your consciousness status..."},{type:"pause",durationMs:500},{type:"line",speakerId:"carl",text:"Neural activity meets minimum viable contractor threshold. Initiating pre-flight checks."},{type:"line",speakerId:"carl",text:"Activating Engine Systems. Please do remain stationary until accidents are formally authorized."},{type:"command",run:()=>{Q.play("assets/sounds/sfx/ship/computing_00.wav","sfx")}},{type:"pause",durationMs:500},{type:"line",speakerId:"carl",text:"Thruster interface enabled. W, A, S, D keys mappedpending your keyboard competency certification..."},{type:"command",run:()=>{e.enableAllActions(),e.disableAction("firePrimary"),e.disableAction("openShipBuilder"),e.disableAction("pause")}},{type:"command",run:()=>{x1(r,200,400)}},{type:"command",run:()=>new Promise(c=>{const u=()=>{e.isKeyPressed("KeyW")||e.isKeyPressed("KeyA")||e.isKeyPressed("KeyS")||e.isKeyPressed("KeyD")||e.isLeftStickMoved()?c():requestAnimationFrame(u)};u()})},{type:"line",speakerId:"carl",text:"Mobility nominal. Unexpectedly, your motor cortex appears to be functional."},{type:"command",run:()=>{r.clear()}},{type:"line",speakerId:"carl",text:"Now engage your Afterburner with Left Shift. Or Left Bumper, if you're using a thumb-calibrated stick."},{type:"command",run:()=>{k1(r,200,400)}},{type:"command",run:()=>new Promise(c=>{const u=()=>{e.isActionPressed("afterburner")?(r.clear(),c()):requestAnimationFrame(u)};u()})},{type:"line",speakerId:"carl",text:"Acceleration spike detected. Try not to hit anything valuablelike me."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Firing vector locked. Wiggle the mouseyes, the rodent-shaped input relicto express hostility."},{type:"command",run:()=>(B1(r,200,400),new Promise(c=>{const u=()=>{e.wasMouseMoved()||e.isRightStickMoved()?(r.clear(),c()):requestAnimationFrame(u)};u()}))},{type:"command",run:()=>{r.clear()}},{type:"line",speakerId:"carl",text:"Please Left-click to discharge kinetic discouragement..."},{type:"command",run:()=>{e.enableAction("firePrimary"),e.enableAction("pause"),I1(r,200,400)}},{type:"command",run:()=>new Promise(c=>{const u=()=>{e.isActionPressed("firePrimary")?(r.clear(),c()):requestAnimationFrame(u)};u()})},{type:"command",run:()=>{r.clear()}},{type:"line",speakerId:"carl",text:"Weapon discharge successful. No signs of sabotage by operator. Unexpected."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Press X to toggle between firing modes. 'Synced' for sustained fire, 'Sequence' for burst fire."},{type:"command",run:()=>{e.enableKey("KeyX")}},{type:"command",run:()=>{R1(r,200,400)}},{type:"command",run:()=>new Promise(c=>{const u=()=>{e.isActionPressed("switchFiringMode")?c():requestAnimationFrame(u)};u()})},{type:"command",run:()=>{r.clear()}},{type:"pause",durationMs:200},{type:"line",speakerId:"carl",text:"Use the scroll wheel or R/T to zoom in and out. Don't break it."},{type:"command",run:()=>{r.createScreenCoachMark("",200,400,{type:"mouse",interactionMode:"scroll",width:60,height:90,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0})}},{type:"command",run:()=>new Promise(c=>{const u=()=>{e.wasScrollWheelUp()||e.wasScrollWheelDown()||e.isKeyPressed("KeyR")||e.isKeyPressed("KeyT")||e.isLeftTriggerPressed()&&e.isRightStickMoved()?c():requestAnimationFrame(u)};u()})},{type:"command",run:()=>{r.clear()}},{type:"line",speakerId:"carl",text:"Zoom functionality confirmed. Your biomechanics are improving... Slightly."},{type:"command",run:()=>{i.start()}},{type:"command",run:()=>{Q.play("assets/sounds/sfx/ship/computing_00.wav","sfx")}},{type:"line",speakerId:"carl",text:"Telemetry indicates unidentified salvage targets approaching. Classification: 'reclaimable liability clusters'."},{type:"line",speakerId:"carl",text:"Standard procedure: convert threats into revenue. Failure to do so may impact your survivability rating."},{type:"pause",durationMs:3e3},{type:"hideUI"},{type:"command",run:()=>ot(()=>Ce.get().enemiesDestroyed>=1)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Enemy presence reduced. Efficiency confirmed. Continue extraction until Entropium reserves reach acceptable thresholds."},{type:"command",run:()=>ot(()=>lp.getBlockCount()>=1)},{type:"line",speakerId:"carl",text:"Block acquisition confirmed. Your first salvage target has been neutralized."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Press Tab to access the shipbuilding module."},{type:"command",run:()=>{E1(r,200,400)}},{type:"command",run:()=>{e.enableAction("openShipBuilder")}},{type:"command",run:()=>new Promise(c=>{const u=()=>{e.wasActionJustPressed("openShipBuilder")?c():requestAnimationFrame(u)};u()})},{type:"command",run:()=>{r.clear()}},{type:"command",run:()=>{e.disableAction("openShipBuilder")}},{type:"line",speakerId:"carl",text:"Place the block on the ship by clicking on the ship. Alternatively, refine the block into Entropium by clicking on the refine button.",options:{side:"right"}},{type:"command",run:()=>ot(()=>Ce.get().blockRefinedCount>=1||Ce.get().blockPlacedCount>=1)},{type:"line",speakerId:"carl",text:"Block placement or refinement confirmed. Your ship's structural integrity has been bolstered.",options:{side:"right"}},{type:"command",run:()=>{e.enableAction("openShipBuilder"),e.enableAction("pause")}},{type:"line",speakerId:"carl",text:"While you have at least one block, press Tab to place more blocks.",options:{side:"right"}},{type:"line",speakerId:"carl",text:"TIP: Right-click on any block on your ship to sell. Press Spacebar to rotate a block before placing.",options:{side:"right"}},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Gather Entropium to meet your quota. Your current target is 300 units.",options:{side:"right"}},{type:"hideUI"},{type:"command",run:()=>ot(()=>lp.getCurrency()>=300)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Entropium extraction threshold reached. Your contract remains marginally unbroken."},{type:"line",speakerId:"carl",text:"Entropium has many uses. For now, know that it is the lifeblood of Deep Void operations."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Survive incoming waves in order to receive permission to return to headquarters."},{type:"line",speakerId:"carl",text:"Remember: Always build toward revenue."},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>ot(()=>i.isBossWaveActive())},{type:"showUI"},{type:"line",speakerId:"carl",text:"Powerful hostile detected. Proceed to center coordinates."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"carl",text:"Survival probability: 0.0001%. But hey, you never know."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"crazy-moe",text:"WELL WHADDYA KNOW! A flyin' lunchbox full'a alloys!"},{type:"pause",durationMs:500},{type:"line",speakerId:"crazy-moe",text:"HehI'ma pop yer cockpit like a soda tab and sniff the coolant fumes!"},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>ot(()=>i.shouldCompleteMission())},{type:"command",run:()=>{console.log("Added passive point!"),pt.getInstance().addPassivePoints(1)}},{type:"command",run:()=>{Re.set("mission.intro-briefing.complete"),Re.set("mission.mission_002.unlocked"),Re.set("mission.mission_003_00.unlocked")}},{type:"showUI"},{type:"line",speakerId:"crazy-moe",text:"Y'got me! Sweet entropy, I see the light*AND SHE'S MADE OF REBAR AND RADIATION!*"}]}}function D1(a){const{inputManager:e,waveSpawner:i,playerShip:n}=a;if(!e)throw new Error("Input manager is required for generic mission dialogue");if(!i)throw new Error("Wave spawner is required for generic mission dialogue");if(!n)throw new Error("Player ship is required for generic mission dialogue");return{id:"mission-generic",defaultMode:"transmission",events:[{type:"showUI"},{type:"command",run:()=>{i.start()}},{type:"line",speakerId:"carl",text:"Survive incoming waves in order to receive permission to return to headquarters."},{type:"line",speakerId:"carl",text:"Remember: Always build toward revenue."},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>ot(()=>i.isBossWaveActive())},{type:"showUI"},{type:"line",speakerId:"carl",text:"Powerful hostile detected. Proceed to center coordinates."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"carl",text:"Survival probability: 0.0001%. But hey, you never know."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"crazy-moe",text:"WELL WHADDYA KNOW! A flyin' lunchbox full'a alloys!"},{type:"pause",durationMs:1e3},{type:"line",speakerId:"crazy-moe",text:"HehI'ma pop yer cockpit like a soda tab and sniff the coolant fumes!"},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>ot(()=>i.shouldCompleteMission())},{type:"showUI"},{type:"line",speakerId:"crazy-moe",text:"Y'got me! Sweet entropy, I see the light*AND SHE'S MADE OF REBAR AND RADIATION!*"},{type:"pause",durationMs:2e3}]}}function P1(a){const{inputManager:e,waveSpawner:i,playerShip:n}=a;if(!e)throw new Error("Input manager is required for generic planet dialogue");if(!i)throw new Error("Wave spawner is required for generic planet dialogue");if(!n)throw new Error("Player ship is required for generic planet dialogue");return{id:"planet-generic",defaultMode:"transmission",events:[{type:"command",run:()=>{Q.play("assets/sounds/sfx/ship/computing_00.wav","sfx")}},{type:"line",speakerId:"carl",text:"Nobody appears to be home."},{type:"pause",durationMs:1e3}]}}function L1(a){const{inputManager:e,waveSpawner:i,playerShip:n}=a;if(!e)throw new Error("Input manager is required for mission dialogue");if(!i)throw new Error("Wave spawner is required for mission dialogue");if(!n)throw new Error("Player ship is required for mission dialogue");return{id:"mission_003_00",defaultMode:"transmission",events:[{type:"showUI"},{type:"line",speakerId:"carl",text:"Deployment confirmed. SYSTEM: FERRUST. CONDITION: METALLURGICALLY HOSTILE."},{type:"command",run:()=>{i.start()}},{type:"pause",durationMs:400},{type:"line",speakerId:"carl",text:"OBJECTIVE: Convert hostile scrap into Entropium. Try not to diebut either outcome generates data."},{type:"pause",durationMs:400},{type:"line",speakerId:"carl",text:"Remember: Survival is admirable. Profitability is mandatory."},{type:"pause",durationMs:700},{type:"hideUI"},{type:"async",dialogue:[{type:"command",run:()=>ot(()=>Ce.get().enemiesDestroyed>=5)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Five kills? I'll adjust your obituary."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>ot(()=>Ce.get().blocksUnlocked.length>=1)},{type:"showUI"},{type:"line",speakerId:"carl",text:"BLOCK UNLOCKED! Please be aware that all new technology is the intellectual property of Deep Void."},{type:"pause",durationMs:200},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>ot(()=>Ce.get().blocksLost>=1)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Please avoid asset loss. Repair damaged blocks in Ship Building Console before damage becomes permanent."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>ot(()=>Ce.get().enemiesDestroyed>=20)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Twenty construct terminations logged. Exceeding expectations will not result in a raise."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>ot(()=>Ce.get().enemiesDestroyed>=50)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Fifty? Very efficient. Disturbingly so. Filing a concern."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>ot(()=>Be.getInstance().getCurrency()>=1e3)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Reminder: All Entropium is property of Deep Void Salvage Co. Unauthorized enrichment is discouraged."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"command",run:()=>ot(()=>i.isBossWaveActive())},{type:"showUI"},{type:"line",speakerId:"carl",text:"Detecting massive kinetic disturbance. Signature: industrial-grade excavation unit... with delusions of grandeur."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"executron",text:"I WAS BUILT TO DIG. THEN THEY GAVE ME LEGS. BIG MISTAKE."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"executron",text:"YOUR SHIP LOOKS LIKE A LOW-YIELD ASTEROID. PREPARE FOR AUTOMATED EXTRACTION."},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>ot(()=>i.shouldCompleteMission())},{type:"command",run:()=>{Re.set("mission.mission_003_00.complete"),Re.set("mission.mission_004_00.unlocked")}},{type:"showUI"},{type:"line",speakerId:"executron",text:"SYSTEM FAILURE. CORE MELTDOWN IMMINENT. I REGRET NOTHING... EXCEPT THE LEGS."},{type:"pause",durationMs:2e3}]}}const O1=new Map([["test-script",T1],["hub-introduction-1",C1],["hub-introduction-2",w1],["hub-introduction-3",A1],["intro-briefing",_1],["mission-generic",D1],["planet-generic",P1],["mission_003_00",L1]]);function ln(a,e){const i=O1.get(a);return i?i(e):void 0}const F1="assets/hub/backgrounds/scene_main-room.png",mo={terminal:{x:50,y:280,width:300,height:360},map:{x:440,y:160,width:490,height:380},breakroom:{x:970,y:230,width:230,height:300}},U1={terminal:"hub.passive-terminal.unlocked",map:"hub.mission-computer.unlocked",breakroom:"hub.breakroom.unlocked"};class N1{constructor(e,i,n){this.backgroundImage=null,this.dialogueQueueManager=null,this.isHoveringInteraction=!1,this.update=r=>{var d;this.inputManager.updateFrame(),this.inputManager.wasKeyJustPressed("KeyF")&&Re.clear();const c=this.inputManager.getMousePosition(),u=this.inputManager.wasMouseClicked();if((d=this.dialogueQueueManager)!=null&&d.isRunning()){this.dialogueQueueManager.update(this.gameLoop.getDeltaTime()),u&&this.dialogueQueueManager.skipOrAdvance();return}const h=g=>{const m=ul(g);return c.x>=m.x&&c.x<=m.x+m.width&&c.y>=m.y&&c.y<=m.y+m.height};if(this.isHoveringInteraction=Object.entries(mo).some(([g,m])=>h(m)&&Re.has(U1[g])),u){if(Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),h(mo.terminal)&&Re.has("hub.passive-terminal.unlocked")){this.stop(),mt.fadeToScene("passives");return}else if(h(mo.map)&&Re.has("hub.mission-computer.unlocked")){this.stop(),mt.fadeToScene("galaxy");return}else if(h(mo.breakroom)&&Re.has("hub.breakroom.unlocked")){this.stop(),mt.fadeToScene("breakroom");return}}As(this.quitButton,c.x,c.y,u,ae())},this.render=r=>{var g;this.canvasManager.clearAll();const c=this.canvasManager.getContext("background"),u=this.canvasManager.getContext("ui"),h=this.inputManager.getMousePosition();this.backgroundImage&&c.drawImage(this.backgroundImage,0,0,c.canvas.width,c.canvas.height),(g=this.dialogueQueueManager)!=null&&g.isRunning()||lt(u,this.quitButton,ae()),this.dialogueQueueManager&&this.dialogueQueueManager.render(u);const d=this.isHoveringInteraction?Eh():an();la(u,d,h.x,h.y,ae())},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.quitButton={x:20,y:20,width:120,height:50,label:" Quit",isHovered:!1,onClick:()=>{this.stop(),Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),mt.fadeToScene("title")},style:{borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}}async start(){if(this.backgroundImage=await ca(F1),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start(),rt.getInstance().saveAll(),Q.playMusic({file:"assets/sounds/music/track_01_hub.mp3"}),this.dialogueQueueManager=Eo.create(),Re.has("hub.introduction-1.complete")){if(Re.has("hub.introduction-1.complete")&&Re.has("hub.introduction-2.complete")&&!Re.has("hub.introduction-3.complete")){const e=ln("hub-introduction-3",{inputManager:this.inputManager});e&&this.dialogueQueueManager.startScript(e)}}else{const e=ln("hub-introduction-1",{inputManager:this.inputManager});e&&this.dialogueQueueManager.startScript(e)}}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}drawInteractionZones(e){e.strokeStyle="#0f0",e.lineWidth=1;for(const i of Object.values(mo)){const n=ul(i);e.strokeRect(n.x,n.y,n.width,n.height)}}}function H1(a,e,i=1){const{x:n,y:r,width:c,height:u,style:h={}}=e,{backgroundColor:d="#0a0a0a",borderColor:g="#00ff41",glow:m=!0,scanlineIntensity:y=.3,cornerBevel:v=!0,chromaticAberration:M=!0}=h,S=c*i,T=u*i,w=Math.min(3,u*.2);a.save(),v&&(a.beginPath(),a.moveTo(n+w,r),a.lineTo(n+S-w,r),a.lineTo(n+S,r+w),a.lineTo(n+S,r+T-w),a.lineTo(n+S-w,r+T),a.lineTo(n+w,r+T),a.lineTo(n,r+T-w),a.lineTo(n,r+w),a.closePath(),a.clip());const A=a.createLinearGradient(n,r,n,r+T);if(A.addColorStop(0,ei(d,"ff")),A.addColorStop(.5,ei(d,"cc")),A.addColorStop(1,ei(d,"ff")),a.fillStyle=A,a.fillRect(n,r,S,T),y>0){a.fillStyle=`rgba(255,255,255,${y*.05})`;for(let R=0;R<T;R+=2*i)a.fillRect(n,r+R,S,i)}a.restore(),m&&(a.save(),a.shadowColor=g,a.shadowBlur=10*i,a.strokeStyle=g,a.lineWidth=2*i,v?(a.beginPath(),a.moveTo(n+w,r),a.lineTo(n+S-w,r),a.lineTo(n+S,r+w),a.lineTo(n+S,r+T-w),a.lineTo(n+S-w,r+T),a.lineTo(n+w,r+T),a.lineTo(n,r+T-w),a.lineTo(n,r+w),a.closePath(),a.stroke()):a.strokeRect(n,r,S,T),a.restore()),M&&(a.save(),a.globalAlpha=.2,a.lineWidth=1*i,a.strokeStyle="#ff0000",a.strokeRect(n-.5*i,r,S,T),a.strokeStyle="#0000ff",a.strokeRect(n+.5*i,r,S,T),a.restore()),a.save(),a.strokeStyle=`${g}40`,a.lineWidth=1,a.strokeRect(n+1*i,r+1*i,S-2*i,T-2*i),a.restore()}function mh(a){const e=qi.getMissionById(a);return e?Re.has(e.requiredFlag):!1}function cp(a,e,i){const n=a.createShader(e);return n?(a.shaderSource(n,i),a.compileShader(n),a.getShaderParameter(n,a.COMPILE_STATUS)?n:(console.error("Shader compile error:",a.getShaderInfoLog(n)),a.deleteShader(n),null)):(console.error("Failed to create shader"),null)}function G1(a,e,i){const n=a.createProgram();return n?(a.attachShader(n,e),a.attachShader(n,i),a.linkProgram(n),a.getProgramParameter(n,a.LINK_STATUS)?n:(console.error("Program link error:",a.getProgramInfoLog(n)),a.deleteProgram(n),null)):(console.error("Failed to create program"),null)}const W1=`
    attribute vec3 position;
    attribute vec3 normal;
    
    uniform mat4 modelMatrix;
    uniform mat4 viewMatrix;
    uniform mat4 projectionMatrix;
    uniform mat3 normalMatrix;
    
    varying vec3 vNormal;
    varying vec3 vPosition;
    
    void main() {
        vec4 worldPosition = modelMatrix * vec4(position, 1.0);
        vPosition = worldPosition.xyz;
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
`,z1=`
    precision mediump float;

    varying vec3 vNormal;
    varying vec3 vPosition;

    uniform vec3 color;
    uniform float alpha; // NEW
    uniform vec3 lightPosition;
    uniform vec3 lightColor;
    uniform vec3 ambientColor;

    void main() {
        vec3 lightDirection = normalize(lightPosition - vPosition);
        float lightIntensity = max(dot(vNormal, lightDirection), 0.0);

        vec3 ambient = ambientColor * color;
        vec3 diffuse = lightColor * color * lightIntensity;

        gl_FragColor = vec4(ambient + diffuse, alpha); // MODIFIED
    }
`;function Wi(){return new Float32Array(3)}function V1(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])}function Jt(a,e,i){return new Float32Array([a,e,i])}function up(a,e){const i=e[0]-a[0],n=e[1]-a[1],r=e[2]-a[2];return Math.sqrt(i*i+n*n+r*r)}function Cm(a,e,i){return a[0]=e[0]-i[0],a[1]=e[1]-i[1],a[2]=e[2]-i[2],a}function X1(a,e,i){return a[0]=e[0]+i[0],a[1]=e[1]+i[1],a[2]=e[2]+i[2],a}function Y1(a,e,i){return a[0]=e[0]*i,a[1]=e[1]*i,a[2]=e[2]*i,a}function wm(a,e){const i=V1(e);return i>0&&(a[0]=e[0]/i,a[1]=e[1]/i,a[2]=e[2]/i),a}function q1(a,e){const i=[],n=[],r=[];for(let c=0;c<=e;c++){const u=c*Math.PI/e,h=Math.sin(u),d=Math.cos(u);for(let g=0;g<=e;g++){const m=g*2*Math.PI/e,y=Math.sin(m),M=Math.cos(m)*h,S=d,T=y*h;i.push(a*M,a*S,a*T),n.push(M,S,T)}}for(let c=0;c<e;c++)for(let u=0;u<e;u++){const h=c*(e+1)+u,d=h+e+1;r.push(h,d,h+1),r.push(d,d+1,h+1)}return{vertices:new Float32Array(i),normals:new Float32Array(n),indices:new Uint16Array(r)}}function Js(){return new Float32Array(16)}function Am(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function km(a,e,i,n,r){const c=1/Math.tan(e/2),u=1/(n-r);return a[0]=c/i,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=c,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(r+n)*u,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*r*n*u,a[15]=0,a}function j1(a,e,i){const n=i[0],r=i[1],c=i[2];return a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11],a[12]=e[0]*n+e[4]*r+e[8]*c+e[12],a[13]=e[1]*n+e[5]*r+e[9]*c+e[13],a[14]=e[2]*n+e[6]*r+e[10]*c+e[14],a[15]=e[3]*n+e[7]*r+e[11]*c+e[15],a}function K1(a,e,i){const n=Math.sin(i),r=Math.cos(i),c=e[0],u=e[1],h=e[2],d=e[3],g=e[8],m=e[9],y=e[10],v=e[11];return a[0]=c*r-g*n,a[1]=u*r-m*n,a[2]=h*r-y*n,a[3]=d*r-v*n,a[8]=c*n+g*r,a[9]=u*n+m*r,a[10]=h*n+y*r,a[11]=d*n+v*r,a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15],a}function Z1(a,e,i){const n=i[0],r=i[1],c=i[2];return a[0]=e[0]*n,a[1]=e[1]*n,a[2]=e[2]*n,a[3]=e[3]*n,a[4]=e[4]*r,a[5]=e[5]*r,a[6]=e[6]*r,a[7]=e[7]*r,a[8]=e[8]*c,a[9]=e[9]*c,a[10]=e[10]*c,a[11]=e[11]*c,a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15],a}function Q1(a,e){const i=e[0],n=e[1],r=e[2],c=e[4],u=e[5],h=e[6],d=e[8],g=e[9],m=e[10],y=m*u-h*g,v=-m*c+h*d,M=g*c-u*d;let S=i*y+n*v+r*M;return S?(S=1/S,a[0]=y*S,a[1]=(-m*n+r*g)*S,a[2]=(h*n-r*u)*S,a[3]=v*S,a[4]=(m*i-r*d)*S,a[5]=(-h*i+r*c)*S,a[6]=M*S,a[7]=(-g*i+n*d)*S,a[8]=(u*i-n*c)*S,a):null}function hp(a,e){const i=e[0],n=e[1],r=e[2],c=e[3],u=e[4],h=e[5],d=e[6],g=e[7],m=e[8],y=e[9],v=e[10],M=e[11],S=e[12],T=e[13],w=e[14],A=e[15],R=i*h-n*u,I=i*d-r*u,x=i*g-c*u,P=n*d-r*h,N=n*g-c*h,W=r*g-c*d,H=m*T-y*S,q=m*w-v*S,ie=m*A-M*S,$=y*w-v*T,K=y*A-M*T,ne=v*A-M*w;let Z=R*ne-I*K+x*$+P*ie-N*q+W*H;return Z?(Z=1/Z,a[0]=(h*ne-d*K+g*$)*Z,a[1]=(r*K-n*ne-c*$)*Z,a[2]=(T*W-w*N+A*P)*Z,a[3]=(v*N-y*W-M*P)*Z,a[4]=(d*ie-u*ne-g*q)*Z,a[5]=(i*ne-r*ie+c*q)*Z,a[6]=(w*x-S*W-A*I)*Z,a[7]=(m*W-v*x+M*I)*Z,a[8]=(u*K-h*ie+g*H)*Z,a[9]=(n*ie-i*K-c*H)*Z,a[10]=(S*N-T*x+A*R)*Z,a[11]=(y*x-m*N-M*R)*Z,a[12]=(h*q-u*$-d*H)*Z,a[13]=(i*$-n*q+r*H)*Z,a[14]=(T*I-S*P-w*R)*Z,a[15]=(m*P-y*I+v*R)*Z,a):null}function Em(a,e,i,n){const r=e[0],c=e[1],u=e[2],h=i[0],d=i[1],g=i[2],m=n[0],y=n[1],v=n[2];if(Math.abs(r-h)<1e-6&&Math.abs(c-d)<1e-6&&Math.abs(u-g)<1e-6)return Am(a);let M=r-h,S=c-d,T=u-g,w=1/Math.hypot(M,S,T);M*=w,S*=w,T*=w;let A=y*T-v*S,R=v*M-m*T,I=m*S-y*M;w=Math.hypot(A,R,I),w>0?(w=1/w,A*=w,R*=w,I*=w):A=R=I=0;let x=S*I-T*R,P=T*A-M*I,N=M*R-S*A;return w=Math.hypot(x,P,N),w>0?(w=1/w,x*=w,P*=w,N*=w):x=P=N=0,a[0]=A,a[1]=x,a[2]=M,a[3]=0,a[4]=R,a[5]=P,a[6]=S,a[7]=0,a[8]=I,a[9]=N,a[10]=T,a[11]=0,a[12]=-(A*r+R*c+I*u),a[13]=-(x*r+P*c+N*u),a[14]=-(M*r+S*c+T*u),a[15]=1,a}class $1{constructor(e,i){this.program=null,this.sphere=q1(1,24),this.positionBuffer=null,this.normalBuffer=null,this.indexBuffer=null,this.locations=null,this.time=0,this.gl=e,this.camera=i}initialize(){const e=this.gl,i=cp(e,e.VERTEX_SHADER,W1),n=cp(e,e.FRAGMENT_SHADER,z1);this.program=G1(e,i,n),this.locations={position:e.getAttribLocation(this.program,"position"),normal:e.getAttribLocation(this.program,"normal"),modelMatrix:e.getUniformLocation(this.program,"modelMatrix"),viewMatrix:e.getUniformLocation(this.program,"viewMatrix"),projectionMatrix:e.getUniformLocation(this.program,"projectionMatrix"),normalMatrix:e.getUniformLocation(this.program,"normalMatrix"),color:e.getUniformLocation(this.program,"color"),lightPosition:e.getUniformLocation(this.program,"lightPosition"),lightColor:e.getUniformLocation(this.program,"lightColor"),ambientColor:e.getUniformLocation(this.program,"ambientColor"),alpha:e.getUniformLocation(this.program,"alpha")},this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.sphere.vertices),e.STATIC_DRAW),this.normalBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.sphere.normals),e.STATIC_DRAW),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.sphere.indices),e.STATIC_DRAW)}render(e,i){if(!this.program||!this.locations)return;const n=this.gl;this.time+=.016;const r=n.canvas;n.viewport(0,0,r.width,r.height),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.DEPTH_TEST),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);const c=Js(),u=Js(),h=Js(),d=new Float32Array(9);Em(u,this.camera.position,this.camera.target,new Float32Array([0,1,0])),km(h,Math.PI/4,r.width/r.height,.1,100),n.useProgram(this.program),n.uniform3f(this.locations.lightPosition,0,0,40),n.uniform3f(this.locations.lightColor,1,1,1),n.uniform3f(this.locations.ambientColor,.2,.2,.2),n.uniformMatrix4fv(this.locations.viewMatrix,!1,u),n.uniformMatrix4fv(this.locations.projectionMatrix,!1,h),n.bindBuffer(n.ARRAY_BUFFER,this.positionBuffer),n.enableVertexAttribArray(this.locations.position),n.vertexAttribPointer(this.locations.position,3,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this.normalBuffer),n.enableVertexAttribArray(this.locations.normal),n.vertexAttribPointer(this.locations.normal,3,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer);for(const g of e){Am(c),j1(c,c,g.position),K1(c,c,this.time*g.rotationSpeed),Z1(c,c,Jt(g.scale,g.scale,g.scale)),Q1(d,c);const m=mh(g.missionId),y=m?g.color:Jt(.25,.25,.25),v=Wi();for(let T=0;T<3;T++)v[T]=Math.min(1,y[T]*1.5);const M=g===i?v:y,S=m?1:.3;n.uniform1f(this.locations.alpha,S),n.uniformMatrix4fv(this.locations.modelMatrix,!1,c),n.uniformMatrix3fv(this.locations.normalMatrix,!1,d),n.uniform3f(this.locations.color,M[0],M[1],M[2]),n.drawElements(n.TRIANGLES,this.sphere.indices.length,n.UNSIGNED_SHORT,0)}}destroy(){const e=this.gl;this.positionBuffer&&e.deleteBuffer(this.positionBuffer),this.normalBuffer&&e.deleteBuffer(this.normalBuffer),this.indexBuffer&&e.deleteBuffer(this.indexBuffer),this.program&&e.deleteProgram(this.program),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT)}}function fp(a,e,i){return a+(e-a)*i}class J1{constructor(){this.position=Wi(),this.target=Wi(),this.targetPosition=Wi(),this.targetTarget=Wi(),this.isMoving=!1,this.moveSpeed=.08,this.position[0]=0,this.position[1]=0,this.position[2]=60,this.target[0]=0,this.target[1]=0,this.target[2]=0,this.targetPosition.set(this.position),this.targetTarget.set(this.target)}update(){if(!this.isMoving)return;let e=!1;for(let i=0;i<3;i++){const n=this.position[i];this.position[i]=fp(this.position[i],this.targetPosition[i],this.moveSpeed),this.target[i]=fp(this.target[i],this.targetTarget[i],this.moveSpeed),Math.abs(this.position[i]-n)>.001&&(e=!0)}this.isMoving=e}focusOnLocation(e){const i=Wi();Cm(i,this.position,e.position),wm(i,i);const n=e.scale*3;Y1(i,i,n);const r=Wi();X1(r,e.position,i),this.targetPosition.set(r),this.targetTarget.set(e.position),this.isMoving=!0}resetView(){this.targetPosition[0]=0,this.targetPosition[1]=0,this.targetPosition[2]=60,this.targetTarget[0]=0,this.targetTarget[1]=0,this.targetTarget[2]=0,this.isMoving=!0}destroy(){}}const e2=[{id:"casina",name:"Casina System",position:Jt(-22,-10,0),scale:2,color:Jt(.1,.4,.1),rotationSpeed:-.15,missionId:"mission_002"},{id:"naxos",name:"Naxos System",position:Jt(32,2,-20),scale:4,color:Jt(.4,0,0),rotationSpeed:-.3,missionId:"mission_003_00"},{id:"prexus",name:"Prexus System",position:Jt(20,18,-40),scale:8,color:Jt(.8,.3,.9),rotationSpeed:.3,missionId:"mission_004_00"},{id:"mitron",name:"Mitron System",position:Jt(-30,5,-10),scale:7,color:Jt(.2,.6,1),rotationSpeed:.2,missionId:"mission_005_00"},{id:"solarum",name:"Solarum System",position:Jt(0,0,0),scale:9,color:Jt(1,.8,.1),rotationSpeed:-.1,missionId:"mission_006_00"}],ml=class ml{constructor(){this.locationMap=new Map;for(const e of e2)this.locationMap.set(e.id.toLowerCase(),e)}static getInstance(){return this.instance||(this.instance=new ml),this.instance}static destroy(){this.instance=null}getLocationById(e){return this.locationMap.get(e.toLowerCase())??null}getAllLocations(){return Array.from(this.locationMap.values())}};ml.instance=null;let dl=ml;function dp(a,e,i,n){const r=Wi();Cm(r,a,i);const c=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],u=2*(r[0]*e[0]+r[1]*e[1]+r[2]*e[2]),h=r[0]*r[0]+r[1]*r[1]+r[2]*r[2]-n*n,d=u*u-4*c*h;if(d<0)return!1;const g=(-u-Math.sqrt(d))/(2*c),m=(-u+Math.sqrt(d))/(2*c);return g>0||m>0}function t2(a,e,i,n){const r=2*a/i.width-1,c=1-2*e/i.height,u=i.width/i.height,h=Js(),d=Js(),g=Js(),m=Js();km(h,Math.PI/4,u,.1,100),Em(d,n.position,n.target,new Float32Array([0,1,0])),hp(g,h),hp(m,d);const y=[r,c,-1,1],v=[g[0]*y[0]+g[4]*y[1]+g[8]*y[2]+g[12]*y[3],g[1]*y[0]+g[5]*y[1]+g[9]*y[2]+g[13]*y[3],-1,0],M=new Float32Array([m[0]*v[0]+m[4]*v[1]+m[8]*v[2]+m[12]*v[3],m[1]*v[0]+m[5]*v[1]+m[9]*v[2]+m[13]*v[3],m[2]*v[0]+m[6]*v[1]+m[10]*v[2]+m[14]*v[3]]),S=Wi();return S[0]=M[0],S[1]=M[1],S[2]=M[2],wm(S,S),{origin:new Float32Array([n.position[0],n.position[1],n.position[2]]),direction:S}}class i2{constructor(e,i){this.canvasManager=e,this.inputManager=i,this.locations=dl.getInstance().getAllLocations(),this.selectedLocation=null,this.hoveredLocation=null,this.locationHoverStates=new Map,this.HOVER_SCALE_MULTIPLIER=1.2,this.SCALE_LERP_SPEED=.15,this.gl=this.canvasManager.getWebGLContext("polygon"),this.camera=new J1,this.renderer=new $1(this.gl,this.camera),this.initializeHoverStates()}initializeHoverStates(){for(const e of this.locations)this.locationHoverStates.set(e.id||e.name,{location:e,currentScale:e.scale,targetScale:e.scale})}lerp(e,i,n){return e+(i-e)*n}updateHoverStates(){for(const e of this.locationHoverStates.values())Math.abs(e.currentScale-e.targetScale)>.001?e.currentScale=this.lerp(e.currentScale,e.targetScale,this.SCALE_LERP_SPEED):e.currentScale=e.targetScale}initialize(){this.renderer.initialize()}update(){const{x:e,y:i}=this.inputManager.getMousePosition(),{origin:n,direction:r}=t2(e,i,this.gl.canvas,this.camera);let c=null,u=1/0;for(const h of this.locations){const d=this.locationHoverStates.get(h.id||h.name),g=(d==null?void 0:d.currentScale)||h.scale;if(dp(n,r,h.position,g)&&mh(h.missionId)){const y=up(n,h.position);y<u&&(u=y,c=h)}}if(c!==this.hoveredLocation){if(this.hoveredLocation&&this.hoveredLocation!==this.selectedLocation){const h=this.locationHoverStates.get(this.hoveredLocation.id||this.hoveredLocation.name);h&&(h.targetScale=this.hoveredLocation.scale)}if(this.hoveredLocation=c,this.hoveredLocation&&!this.selectedLocation&&Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:2}),this.hoveredLocation&&this.hoveredLocation!==this.selectedLocation){const h=this.locationHoverStates.get(this.hoveredLocation.id||this.hoveredLocation.name);h&&(h.targetScale=this.hoveredLocation.scale*this.HOVER_SCALE_MULTIPLIER)}}if(this.selectedLocation){const h=this.locationHoverStates.get(this.selectedLocation.id||this.selectedLocation.name);h&&(h.targetScale=this.selectedLocation.scale,h.currentScale=this.selectedLocation.scale)}if(this.inputManager.wasLeftClicked()){let h=null,d=1/0;for(const g of this.locations){const m=this.locationHoverStates.get(g.id||g.name),y=(m==null?void 0:m.currentScale)||g.scale;if(dp(n,r,g.position,y)){const M=up(n,g.position);M<d&&(d=M,h=g)}}h?mh(h.missionId)&&(this.selectedLocation||(this.selectedLocation=h,this.camera.focusOnLocation(h),Q.play("assets/sounds/sfx/ui/planetselect_01.wav","sfx",{maxSimultaneous:2}))):(this.selectedLocation&&Q.play("assets/sounds/sfx/ui/planetselect_00.wav","sfx",{maxSimultaneous:2}),this.selectedLocation=null,this.camera.resetView())}this.updateHoverStates(),this.camera.update()}render(){const e=this.locations.map(i=>{const n=this.locationHoverStates.get(i.id||i.name),r=this.selectedLocation&&i.id===this.selectedLocation.id;return n&&!r&&n.currentScale!==i.scale?{...i,scale:n.currentScale}:i});this.renderer.render(e,this.selectedLocation)}destroy(){this.renderer.destroy(),this.camera.destroy(),this.locationHoverStates.clear(),dl.destroy()}getSelectedLocation(){return this.selectedLocation}getHoveredLocation(){return this.hoveredLocation}}const s2="assets/hub/backgrounds/scene_galaxy-map.png",gp={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};class n2{constructor(e,i,n){this.backgroundImage=null,this.missionPortraitCache=new Map,this.currentlyLoadingPortraitId=null,this.selectedLocationLaunchButton=null,this.update=()=>{this.inputManager.updateFrame();const r=ae(),{x:c,y:u}=this.inputManager.getMousePosition(),h=this.inputManager.wasMouseClicked();this.galaxyMapController.update();for(const g of this.buttons)g.isHovered=c>=g.x&&c<=g.x+g.width&&u>=g.y&&u<=g.y+g.height,As(g,c,u,h,r);const d=this.galaxyMapController.getSelectedLocation();if(d&&d.missionId){const g=fl[d.missionId];if(!g)return;this.selectedLocationLaunchButton={x:this.canvasManager.getContext("ui").canvas.width/2-180*r,y:this.canvasManager.getContext("ui").canvas.height/2+140*r,width:360,height:40,label:`Launch "${g.name}"`,isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/start_00.wav","sfx",{maxSimultaneous:4}),qi.setMission(g),this.stop(),mt.fadeToScene("mission")},style:gp};const m=g.missionPortrait;m&&!this.missionPortraitCache.has(m)&&this.currentlyLoadingPortraitId!==m&&(this.currentlyLoadingPortraitId=m,ca(Mi(m)).then(y=>{this.missionPortraitCache.set(m,y),this.currentlyLoadingPortraitId=null}).catch(y=>{console.warn(`Failed to load mission portrait: ${m}`,y),this.currentlyLoadingPortraitId=null}))}else this.selectedLocationLaunchButton=null;if(this.selectedLocationLaunchButton){const g=this.selectedLocationLaunchButton;g.isHovered=c>=g.x&&c<=g.x+g.width&&u>=g.y&&u<=g.y+g.height,As(g,c,u,h,r)}},this.render=()=>{var M;this.canvasManager.clearAll();const r=ae(),c=this.canvasManager.getContext("background"),u=this.canvasManager.getContext("ui"),{x:h,y:d}=this.inputManager.getMousePosition();this.backgroundImage&&c.drawImage(this.backgroundImage,0,0,c.canvas.width,c.canvas.height),this.galaxyMapController.render();for(const S of this.buttons)lt(u,S,r);this.selectedLocationLaunchButton&&lt(u,this.selectedLocationLaunchButton,r);const g=this.galaxyMapController.getSelectedLocation();if(g&&g.missionId){const S=fl[g.missionId];if(S&&S.missionPortrait){const T=this.missionPortraitCache.get(S.missionPortrait);if(T){const w=u.canvas,A=256*r,R=4*r,I=A-R*2,x=w.width/2-I/2,P=180*r;H1(u,{x,y:P,width:A,height:A}),u.drawImage(T,x+R,P+R,I,I)}}}let m=an();const y=this.galaxyMapController.getHoveredLocation(),v=this.galaxyMapController.getSelectedLocation();(y&&!v||(M=this.selectedLocationLaunchButton)!=null&&M.isHovered)&&(m=Eh()),la(u,m,h,d,r)},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.galaxyMapController=new i2(e,n),this.buttons=[{x:20,y:20,width:120,height:50,label:" Back",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.stop(),mt.fadeToScene("hub")},style:gp}]}async start(){this.backgroundImage=await ca(s2),this.galaxyMapController.initialize(),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start(),Q.play("assets/sounds/sfx/ui/galaxymap_00.wav","sfx",{maxSimultaneous:1})}stop(){this.galaxyMapController.destroy(),this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}}class a2{constructor(e,i,n,r,c={}){this.x=e,this.y=i,this.width=n,this.height=r,this.options=c,this.scanlineOffset=0,this.lastTime=0}update(e){this.lastTime===0&&(this.lastTime=e);const i=e-this.lastTime;this.lastTime=e;const n=this.options.scanlineSpacing??6;this.scanlineOffset=(this.scanlineOffset+i*.03)%n}draw(e,i=1){const{borderRadius:n=10,backgroundColor:r="#000a00",borderColor:c="#00ff41",glowColor:u="#00ff41",alpha:h=1,scanlineSpacing:d=6,backgroundGradient:g}=this.options;e.save(),e.globalAlpha=h;let m=r;if(g){const{type:y,stops:v,from:M=[this.x,this.y],to:S=[this.x+this.width*i,this.y+this.height*i],radius:T=this.width*i/2}=g,w=y==="linear"?e.createLinearGradient(M[0],M[1],S[0],S[1]):e.createRadialGradient(M[0],M[1],0,M[0],M[1],T);for(const A of v)w.addColorStop(A.offset,A.color);m=w}e.fillStyle=m,e.strokeStyle=c,e.lineWidth=2,e.shadowColor=u,e.shadowBlur=12,e.beginPath(),e.roundRect(this.x,this.y,this.width*i,this.height*i,n),e.fill(),e.stroke(),e.shadowBlur=0,e.globalAlpha=.06,e.fillStyle=u;for(let y=-this.scanlineOffset;y<this.height*i;y+=d)e.fillRect(this.x,this.y+y,this.width*i,1);e.restore()}}function Bt(a,e,i,n,r={},c=1){const{font:u='14px "Courier New", monospace',color:h="#00ff41",glow:d=!0,chromaticAberration:g=!0,align:m="left",baseline:y="top"}=r,v=u.replace(/(\d+)(px)/,(S,T,w)=>`${Math.round(parseInt(T)*c)}${w}`),M=.5*c;a.save(),a.font=v,a.textAlign=m,a.textBaseline=y,d&&(a.shadowColor=h,a.shadowBlur=4*c),g&&(a.save(),a.shadowBlur=0,a.globalAlpha=.25,a.fillStyle="#ff0000",a.fillText(n,e-M,i),a.fillStyle="#0000ff",a.fillText(n,e+M,i),a.restore()),a.globalAlpha=1,a.fillStyle=h,a.fillText(n,e,i),a.restore()}class th{constructor(e,i,n=0){this.fullText=e,this.baseDelayMs=i,this.jitter=n,this.currentLength=0,this.startTime=0,this.isFinished=!1,this.schedule=[]}start(e){this.startTime=e,this.currentLength=0,this.isFinished=!1,this.schedule=[];let i=0;for(let n=0;n<this.fullText.length;n++){const r=this.baseDelayMs+(Math.random()*2-1)*this.jitter;i+=Math.max(0,r),this.schedule.push(i)}}update(e){if(this.isFinished)return;const i=e-this.startTime;for(;this.currentLength<this.schedule.length&&i>=this.schedule[this.currentLength];)this.currentLength++;this.currentLength>=this.fullText.length&&(this.currentLength=this.fullText.length,this.isFinished=!0)}getText(){return this.fullText.slice(0,this.currentLength)}done(){return this.isFinished}}function o2(a,e="monospace"){return`${Math.round(oa(a))}px ${e}`}class r2{constructor(){this.phase="loginPrompt",this.timer=0,this.lastTime=0,this.username=new th("Shipwright SecondClass",30,40),this.password=new th("************",60,20),this.bootText=new th("VIEW_PASSIVES()    ",50,1),this.delayAfterPhaseComplete=600}update(e){const i=e-this.lastTime;switch(this.lastTime=e,this.timer+=i,this.phase){case"usernameInput":this.username.update(e),this.username.done()&&this.timer>this.delayAfterPhaseComplete&&this.advance("passwordPrompt");break;case"passwordInput":this.password.update(e),this.password.done()&&this.timer>this.delayAfterPhaseComplete&&this.advance("clear1");break;case"bootMessage":this.bootText.update(e),this.bootText.done()&&this.timer>this.delayAfterPhaseComplete&&this.advance("clear2");break}}draw(e){const i=gh(300);let n=oa(160);const r={font:o2(18),color:"#00ff41",glow:!0,chromaticAberration:!0};switch(e.save(),e.fillStyle="#000",e.restore(),this.phase){case"loginPrompt":Bt(e,i,n,"login:",r),this.advance("usernameInput");break;case"usernameInput":Bt(e,i,n,"login: "+this.username.getText(),r);break;case"passwordPrompt":Bt(e,i,n,"login: Shipwright SecondClass",r),n+=oa(32),Bt(e,i,n,"password:",r),this.advance("passwordInput");break;case"passwordInput":Bt(e,i,n-oa(32),"login: Shipwright SecondClass",r),Bt(e,i,n,"password: "+this.password.getText(),r);break;case"clear1":this.advance("bootMessage");break;case"bootMessage":Bt(e,i,n,this.bootText.getText(),r);break;case"clear2":this.advance("done");break}}advance(e){this.phase=e,this.timer=0;const i=performance.now();e==="usernameInput"&&this.username.start(i),e==="passwordInput"&&this.password.start(i),e==="bootMessage"&&this.bootText.start(i)}isComplete(){return this.phase==="done"}}function ih(a,e,i=1){const{x:n,y:r,width:c,height:u,label:h,isHovered:d,style:g={}}=e,{backgroundColor:m="#001100",borderColor:y="#00ff41",textColor:v="#00ff41",font:M='13px "Courier New", monospace',glow:S=!0,chromaticAberration:T=!0,alpha:w=1}=g,A=c*i,R=u*i,I=M.replace(/(\d+)(px)/,(q,ie,$)=>`${Math.round(parseInt(ie)*i)}${$}`),x=.8,P=d?Vi(y,x):y,N=d?Vi(v,x):v;a.save(),a.globalAlpha=w,a.fillStyle=m,a.fillRect(n,r,A,R),S&&(a.shadowColor=P,a.shadowBlur=8*i),a.strokeStyle=P,a.lineWidth=2*i,a.strokeRect(n,r,A,R),a.restore();const W=n+A/2,H=r+R/2;a.save(),a.font=I,a.textAlign="center",a.textBaseline="middle",S&&(a.shadowColor=N,a.shadowBlur=4*i),T&&(a.save(),a.globalAlpha=.25,a.shadowBlur=0,a.fillStyle="#ff0000",a.fillText(h,W-.5*i,H),a.fillStyle="#0000ff",a.fillText(h,W+.5*i,H),a.restore()),a.globalAlpha=1,a.fillStyle=N,a.fillText(h,W,H),a.restore()}const pp={offense:"Offense",defense:"Defense",utility:"Utility"},l2={"harvester-range":{label:"Harvester Range",category:"utility",tiers:{1:20,2:40,3:60},unit:"%"},"laser-damage":{label:"Laser Damage",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"laser-energy-drain":{label:"Laser Energy Drain",category:"offense",tiers:{1:-10,2:-20,3:-30},unit:"%"},"laser-block-cost":{label:"Laser Block Cost",category:"offense",tiers:{1:-10,2:-20,3:-30},unit:"%"},"explosive-lance-radius":{label:"Explosive Lance Radius",category:"offense",tiers:{1:1,2:2,3:3}},"explosive-lance-firing-rate":{label:"Explosive Lance Firing Rate",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"block-durability":{label:"Block Durability",category:"defense",tiers:{1:5,2:10,3:15},unit:"%"},"fin-turn-power":{label:"Fin Turn Power",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"engine-thrust":{label:"Engine Thrust",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"charger-rate":{label:"Charger Rate",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"battery-capacity":{label:"Battery Capacity",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"turret-firing-rate":{label:"Turret Firing Rate",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"turret-damage":{label:"Turret Damage",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"turret-accuracy":{label:"Turret Accuracy",category:"offense",tiers:{1:10,2:20,3:30},unit:"%"},"shield-energy-drain":{label:"Shield Energy Drain",category:"defense",tiers:{1:-10,2:-20,3:-30},unit:"%"},"shield-radius":{label:"Shield Radius",category:"defense",tiers:{1:1,2:2,3:3}},"shield-efficiency":{label:"Shield Efficiency",category:"defense",tiers:{1:10,2:20,3:30},unit:"%"},"facetplate-armor":{label:"Facetplate Armor",category:"defense",tiers:{1:10,2:20,3:30},unit:"%"},"hull-armor":{label:"Hull Armor",category:"defense",tiers:{1:10,2:20,3:30},unit:"%"},"hull-mass":{label:"Hull Mass",category:"utility",tiers:{1:-10,2:-20,3:-30},unit:"%"},"cockpit-armor":{label:"Cockpit Armor",category:"defense",tiers:{1:30,2:60,3:100}},"block-repair-cost":{label:"Block Repair Cost",category:"utility",tiers:{1:-10,2:-20,3:-30},unit:"%"},"entropium-pickup-bonus":{label:"Entropium Pickup Bonus",category:"utility",tiers:{1:5,2:10,3:15},unit:"%"},"block-drop-rate":{label:"Block Drop Rate",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"}};class c2{constructor(e,i,n){this.inputManager=e,this.passiveManager=i,this.bounds=n,this.scrollOffset=0,this.baseScrollSpeed=40,this.isDraggingThumb=!1,this.thumbDragOffsetY=0,this.contentHeight=0,this.activeButtons=[]}update(){const e=ae(),i=Math.floor(this.baseScrollSpeed*e),n=Math.floor(28*e),r=Math.floor(24*e),c=this.bounds.x+this.bounds.width-n,u=Math.max(0,this.contentHeight-this.bounds.height);(this.inputManager.wasScrollWheelDown()||this.inputManager.isKeyPressed("KeyS"))&&(this.scrollOffset=Math.min(this.scrollOffset+i,u)),(this.inputManager.wasScrollWheelUp()||this.inputManager.isKeyPressed("KeyW"))&&(this.scrollOffset=Math.max(0,this.scrollOffset-i));const{x:h,y:d}=this.inputManager.getMousePosition(),g=this.inputManager.wasMouseClicked(),m=this.inputManager.isKeyPressed("MouseLeft"),y=this.inputManager.wasKeyJustReleased("MouseLeft"),v=this.inputManager.wasKeyJustPressed("MouseLeft"),M=this.bounds.y+r,S=this.bounds.height-r*2,T=this.bounds.height/Math.max(this.contentHeight,1),w=Math.max(Math.floor(30*e),T*S),A=c+Math.floor(2*e),R=M+this.scrollOffset/u*(S-w),I=h>=A&&h<=A+(n-Math.floor(4*e))&&d>=R&&d<=R+w;if(v&&I&&(this.isDraggingThumb=!0,this.thumbDragOffsetY=d-R),this.isDraggingThumb&&m){const x=d-this.bounds.y-r-this.thumbDragOffsetY,P=S-w;if(P>0){const N=Math.floor(32*e),W=Math.max(0,this.contentHeight-this.bounds.height),H=Math.round(W/N)*N,$=Math.max(0,Math.min(P,x))/P*H,K=Math.round($/N)*N;this.scrollOffset=Math.min(K,H)}else this.scrollOffset=0}y&&(this.isDraggingThumb=!1);for(const x of this.activeButtons)if(x.isHovered=h>=x.x&&h<=x.x+x.width&&d>=x.y&&d<=x.y+x.height,x.isHovered&&g){x.onClick();break}}render(e){const i=ae(),{x:n,y:r,width:c,height:u}=this.bounds;e.save(),e.beginPath(),e.rect(n,r,c,u),e.clip();let h=r-this.scrollOffset;const d=Math.floor(32*i),g=Math.floor(28*i),m=Math.floor(70*i),y=n+Math.floor(320*i),v=Math.floor(28*i),M=Math.floor(24*i),S=n+c-v;this.activeButtons=[];let T=0;for(const q of Object.keys(pp)){const ie=pp[q];Bt(e,n+d,h,ie.toUpperCase(),{font:`${Math.floor(18*i)}px monospace`,color:"#00ff00"}),h+=g;for(const[$,K]of Object.entries(l2)){if(K.category!==q)continue;const ne=this.passiveManager.getPassiveTier($);Bt(e,n+d,h,K.label,{font:`${Math.floor(15*i)}px monospace`,color:"#ffffff"});let Z=0;for(const k of[1,2,3]){const ee=`${K.tiers[k]}${K.unit??""}`,J=y+Z*m;Bt(e,J,h,ee,{font:`${Math.floor(15*i)}px monospace`,color:ne!==null&&k<=ne?"#00ff41":"#666666"}),Z++}const te=(ne??0)+1;te<=3&&this.passiveManager.canAfford(te);let _=y+3*m+Math.floor(10*i);const X=te<=3,se=X?this.passiveManager.getUpgradeCost(te,ne):0,oe=X&&this.passiveManager.canAfford(te);if(X){const k={x:_,y:h-Math.floor(2*i),width:Math.floor(30*i),height:Math.floor(20*i),label:"+",onClick:oe?()=>{this.passiveManager.setPassiveTier($,te)}:()=>{},style:{font:`${Math.floor(14*i)}px monospace`,backgroundColor:"#111111",borderColor:oe?"#00ff00":"#444444",textColor:oe?"#00ff00":"#666666",alpha:.8,glow:oe,chromaticAberration:oe}};this.activeButtons.push(k),ih(e,k),Bt(e,k.x+k.width+Math.floor(8*i),h,`Cost: ${se}`,{font:`${Math.floor(13*i)}px monospace`,color:oe?"#00ff00":"#666666"}),_=k.x+k.width+Math.floor(80*i)}if(T===0){const k=this.passiveManager.getAvailablePoints();Bt(e,_,h,`Passive Licenses: ${k}`,{font:`${Math.floor(14*i)}px monospace`,color:"#00ff00"})}T++,h+=g}h+=Math.floor(6*i)}this.contentHeight=h-r;const w=Math.max(0,this.contentHeight-u);this.scrollOffset=Math.min(this.scrollOffset,w),e.restore(),e.save();const A=Math.floor(this.baseScrollSpeed*i),R={x:S,y:r+Math.floor(32*i),width:v,height:M,label:"",onClick:()=>{this.scrollOffset=Math.max(0,this.scrollOffset-A)},style:{font:`${Math.floor(13*i)}px monospace`,backgroundColor:"#001100",borderColor:"#00ff00",textColor:"#00ff00",alpha:1,glow:!0,chromaticAberration:!0}},I={x:S,y:r+u-M-Math.floor(32*i),width:v,height:M,label:"",onClick:()=>{this.scrollOffset=Math.min(this.scrollOffset+A,w)},style:R.style};this.activeButtons.push(R,I),ih(e,R),ih(e,I);const x=r+M+Math.floor(32*i),P=u-M*2-Math.floor(64*i),N=u/Math.max(this.contentHeight,1),W=Math.max(Math.floor(30*i),N*P),H=x+this.scrollOffset/w*(P-W);e.fillStyle="#00ff00",e.globalAlpha=.3,e.fillRect(S+Math.floor(2*i),H,v-Math.floor(4*i),W),e.restore()}}const u2="assets/hub/backgrounds/scene_passives-menu.png";class h2{constructor(e,i,n){this.backgroundImage=null,this.dialogueQueueManager=null,this.loopSoundStopped=!1,this.update=()=>{var y;const h=performance.now();this.inputManager.updateFrame(),this.crtMonitor.update(h),this.introAnimationController.update(h);const{x:d,y:g}=this.inputManager.getMousePosition(),m=this.inputManager.wasMouseClicked();if(this.introAnimationController.isComplete()){if(this.dialogueQueueManager&&!this.dialogueQueueManager.isRunning()&&!Re.has("hub.introduction-2.complete")){const v=ln("hub-introduction-2",{inputManager:this.inputManager});v&&this.dialogueQueueManager.startScript(v)}(y=this.dialogueQueueManager)!=null&&y.isRunning()&&(this.dialogueQueueManager.update(this.gameLoop.getDeltaTime()),m&&this.dialogueQueueManager.skipOrAdvance());for(const v of this.buttons)As(v,d,g,m,ae());this.inputManager.wasKeyJustPressed("KeyP")&&pt.getInstance().addPassivePoints(1),this.inputManager.wasKeyJustPressed("KeyR")&&pt.getInstance().refundAll(),this.passiveMenuManager.update()}},this.render=()=>{var M;this.canvasManager.clearAll();const h=this.canvasManager.getContext("background"),d=this.canvasManager.getContext("ui"),g=this.canvasManager.getContext("overlay"),{x:m,y}=this.inputManager.getMousePosition();if(this.backgroundImage&&h.drawImage(this.backgroundImage,0,0,h.canvas.width,h.canvas.height),this.crtMonitor.draw(d),!this.introAnimationController.isComplete())this.introAnimationController.draw(g);else{if(this.loopSoundStopped||(Q.stopLoop("assets/sounds/sfx/ui/typing_00.wav"),this.loopSoundStopped=!0),!((M=this.dialogueQueueManager)!=null&&M.isRunning()))for(const S of this.buttons)lt(d,S,ae());this.dialogueQueueManager&&this.dialogueQueueManager.render(g),this.passiveMenuManager.render(d)}const v=an();la(d,v,m,y,ae())},this.canvasManager=e,this.gameLoop=i,this.inputManager=n;const r={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};this.buttons=[{x:20,y:20,width:120,height:50,label:" Back",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.stop(),mt.fadeToScene("hub")},style:r}];const c=ul({x:275,y:98,width:885,height:542});this.crtMonitor=new a2(c.x,c.y,c.width,c.height,{alpha:.95,borderRadius:60,borderColor:"#00ff33",glowColor:"#00ff33",scanlineSpacing:6,backgroundGradient:{type:"linear",stops:[{offset:0,color:"#000900"},{offset:1,color:"#000000"}]}});const u=ul({x:285,y:108,width:865,height:522});this.passiveMenuManager=new c2(this.inputManager,pt.getInstance(),u),this.introAnimationController=new r2}async start(){Q.startLoop("assets/sounds/sfx/ui/typing_00.wav","sfx",{volume:1,pitch:1,pan:0}),this.backgroundImage=await ca(u2),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start(),this.dialogueQueueManager=Eo.create()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}}const mp=800;class Dh{constructor(e,i,n){this.inputManager=i,this.playerShip=n,this.cursorWorldPos={x:0,y:0},this.hasInitializedCursor=!1,this.cursorChangeHandler=r=>this.setCursorFromType(r.type),this.cursorRestoreHandler=()=>this.setDefaultCursor(),this.camera=n?yt.getInstance():null,this.cursorSprite=an(),this.ctx=e.getContext("overlay"),pe.on("cursor:change",this.cursorChangeHandler),pe.on("cursor:restore",this.cursorRestoreHandler)}render(){if(!this.cursorSprite)return;const e=ae(),i=xt.getInstance().getLastUsed();if(i==="keyboard"||i==="mouse"){const n=this.inputManager.getMousePosition();la(this.ctx,this.cursorSprite,n.x,n.y,e);return}if(i==="gamepad"){if(!this.playerShip)return;const n=this.inputManager.getGamepadAimVector(),r=n.x!==0||n.y!==0,c=this.playerShip.getTransform(),u=c.position,h=r?n:{x:Math.cos(c.rotation-Math.PI/2),y:Math.sin(c.rotation-Math.PI/2)},d=u.x+h.x*mp,g=u.y+h.y*mp;if(this.hasInitializedCursor?(this.cursorWorldPos.x+=(d-this.cursorWorldPos.x)*.25,this.cursorWorldPos.y+=(g-this.cursorWorldPos.y)*.25):(this.cursorWorldPos.x=d,this.cursorWorldPos.y=g,this.hasInitializedCursor=!0),!this.camera)return;const m=this.camera.worldToScreen(this.cursorWorldPos.x,this.cursorWorldPos.y);la(this.ctx,this.cursorSprite,m.x,m.y,e)}}setCursorFromType(e){switch(e){case"crosshair":this.setCrosshairCursor();break;case"target":this.setTargetCrosshairCursor();break;case"hovered":this.setHoveredCursor();break;case"wrench":this.setWrenchCursor();break;case"up":this.setUpCursor();break;case"right":this.setRightCursor();break;case"down":this.setDownCursor();break;case"left":this.setLeftCursor();break;case"small-circle":this.setSmallCircleCursor();break}}setCursorSprite(e){this.cursorSprite=e}setDefaultCursor(){this.setCursorSprite(an())}setCrosshairCursor(){this.setCursorSprite(an())}setTargetCrosshairCursor(){this.setCursorSprite(PS())}setHoveredCursor(){this.setCursorSprite(Eh())}setWrenchCursor(){this.setCursorSprite(HS())}setArrowCursor(e){this.setCursorSprite(NS(e))}setUpCursor(){this.setArrowCursor("up")}setRightCursor(){this.setArrowCursor("right")}setDownCursor(){this.setArrowCursor("down")}setLeftCursor(){this.setArrowCursor("left")}setSmallCircleCursor(){this.setCursorSprite(GS())}destroy(){pe.off("cursor:change",this.cursorChangeHandler),pe.off("cursor:restore",this.cursorRestoreHandler)}}const f2="assets/hub/backgrounds/scene_break-room.png";class d2{constructor(e,i,n){this.backgroundImage=null,this.dialogueQueueManager=null,this.update=()=>{var d;this.inputManager.updateFrame();const{x:c,y:u}=this.inputManager.getMousePosition(),h=this.inputManager.wasMouseClicked();if((d=this.dialogueQueueManager)!=null&&d.isRunning()){this.dialogueQueueManager.update(this.gameLoop.getDeltaTime()),h&&this.dialogueQueueManager.skipOrAdvance();return}As(this.buttons[0],c,u,h,ae())},this.render=()=>{var d;this.canvasManager.clearAll();const c=this.canvasManager.getContext("background"),u=this.canvasManager.getContext("ui"),h=this.canvasManager.getContext("overlay");if(this.backgroundImage&&c.drawImage(this.backgroundImage,0,0,c.canvas.width,c.canvas.height),!((d=this.dialogueQueueManager)!=null&&d.isRunning()))for(const g of this.buttons)lt(u,g,ae());this.dialogueQueueManager&&this.dialogueQueueManager.render(h),this.cursorRenderer.render()},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.cursorRenderer=new Dh(e,n,null);const r={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};this.buttons=[{x:20,y:20,width:120,height:50,label:" Back",isHovered:!1,onClick:()=>{Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.stop(),mt.fadeToScene("hub")},style:r}]}async start(){this.backgroundImage=await ca(f2),this.dialogueQueueManager=Eo.create();const e=ln("test-script",{});e&&this.dialogueQueueManager.startScript(e),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render),this.cursorRenderer.destroy()}}function Ve(a,e,i,n,r,c=1){const{font:u="12px monospace",align:h="left",alpha:d=1,shadowBlur:g=0,shadowColor:m="",glow:y=!1,color:v="#00ff00"}=r??{},M=u.replace(/(\d+)(px)/,(S,T,w)=>`${Math.round(parseInt(T)*c)}${w}`);if(a.save(),a.globalAlpha=d,a.font=M,a.textAlign=h,a.textBaseline="top",y?(a.shadowBlur=6*c,a.shadowColor="#00ff00"):g>0&&m&&(a.shadowBlur=g*c,a.shadowColor=m),typeof n=="string")a.fillStyle=v,a.fillText(n,e,i);else{let S=e;for(const T of n)a.fillStyle=T.color??v,a.fillText(T.text,S,i),S+=a.measureText(T.text).width}a.restore()}class yp{constructor(e,i,n,r,c=.8){this.timer=0,this.triggered=!1,this.text=e,this.x=i,this.y=n,this.options=r,this.duration=c}trigger(){this.timer=0,this.triggered=!0}update(e){this.triggered&&(this.timer+=e)}render(e,i){if(!this.triggered)return;const n=Math.min(this.timer/this.duration,1),r=n*n*(3-2*n),c=r,u=1+(1-r)*.4;e.save(),e.translate(this.x,this.y),e.scale(u,u),Ve(e,0,0,this.text,{...this.options,align:"center",alpha:c},i),e.restore()}hasCompleted(){return this.triggered&&this.timer>=this.duration}}function g2(){const a=Ce.get();return{fromWaves:a.wavesCleared*3,fromKills:Math.floor(a.enemiesDestroyed/25),fromBlocks:Math.floor(a.blocksCollected/100),fromCurrency:Math.floor(a.currencyGathered/1e3),fromMass:Math.floor(a.massAchieved/2e3),fromIncidents:a.incidentsCompleted,fromVictory:a.outcome==="victory"?5:0}}let Zn=null,ue=null;function p2(a,e,i,n,r=1){if(!Zn){Zn=document.createElement("canvas"),Zn.width=64,Zn.height=64,ue=Zn.getContext("2d"),ue.clearRect(0,0,64,64),ue.save();const c=32,u=32,h=28,d=ue.createRadialGradient(c,u,h*.7,c,u,h);d.addColorStop(0,"#00ffff"),d.addColorStop(.8,"#0088ff"),d.addColorStop(1,"#0044aa"),ue.strokeStyle=d,ue.lineWidth=3,ue.shadowColor="#00ffff",ue.shadowBlur=8,ue.beginPath(),ue.arc(c,u,h,0,Math.PI*2),ue.stroke();const g=ue.createRadialGradient(c,u,0,c,u,h*.6);g.addColorStop(0,"#ffffff"),g.addColorStop(.3,"#00ffff"),g.addColorStop(.7,"#0088ff"),g.addColorStop(1,"#003366"),ue.fillStyle=g,ue.shadowBlur=12,ue.beginPath(),ue.arc(c,u,h*.6,0,Math.PI*2),ue.fill(),ue.strokeStyle="#ffffff",ue.lineWidth=1.5,ue.shadowBlur=4;for(let M=0;M<6;M++){const S=M*Math.PI/3,T=c+Math.cos(S)*h*.3,w=u+Math.sin(S)*h*.3,A=c+Math.cos(S)*h*.5,R=u+Math.sin(S)*h*.5;ue.beginPath(),ue.moveTo(T,w),ue.lineTo(A,R),ue.stroke()}const m=ue.createRadialGradient(c,u,0,c,u,6);m.addColorStop(0,"#ffffff"),m.addColorStop(.5,"#00ffff"),m.addColorStop(1,"#0088ff"),ue.fillStyle=m,ue.shadowColor="#ffffff",ue.shadowBlur=6,ue.beginPath(),ue.arc(c,u,4,0,Math.PI*2),ue.fill(),ue.strokeStyle="#00ffff",ue.lineWidth=2,ue.shadowBlur=4;const y=8,v=6;ue.beginPath(),ue.moveTo(v,v+y),ue.lineTo(v,v),ue.lineTo(v+y,v),ue.stroke(),ue.beginPath(),ue.moveTo(64-v-y,v),ue.lineTo(64-v,v),ue.lineTo(64-v,v+y),ue.stroke(),ue.beginPath(),ue.moveTo(64-v,64-v-y),ue.lineTo(64-v,64-v),ue.lineTo(64-v-y,64-v),ue.stroke(),ue.beginPath(),ue.moveTo(v+y,64-v),ue.lineTo(v,64-v),ue.lineTo(v,64-v-y),ue.stroke(),ue.restore()}a.save(),a.globalAlpha=r,a.drawImage(Zn,e,i,n,n),a.restore()}class m2{constructor(e,i,n,r,c){this.phase="hidden",this.settleTimer=0,this.cores=[],this.isFloating=!1,this.floatTimer=0,this.settleDuration=.2,this.overshoot=20,this.pulseTimer=0,this.PULSE_DURATION=.5,this.targetX=e,this.y=i,this.width=n,this.height=r,this.x=e+200,this.slideSpeed=c??1200}trigger(){this.phase==="hidden"&&(this.phase="sliding-in")}setFloatingState(){this.isFloating=!0,this.floatTimer=0}update(e){switch(this.phase){case"sliding-in":{const i=this.targetX+this.overshoot,n=Math.sign(i-this.x);this.x+=n*this.slideSpeed*e,(n>0&&this.x>=i||n<0&&this.x<=i)&&(this.x=i,this.phase="settling",this.settleTimer=this.settleDuration);break}case"settling":{this.settleTimer-=e;const i=1-Math.max(0,this.settleTimer/this.settleDuration);this.x=this.targetX+this.overshoot*(1-i),this.settleTimer<=0&&(this.x=this.targetX,this.phase="appeared");break}}this.pulseTimer>0&&(this.pulseTimer-=e,this.pulseTimer<0&&(this.pulseTimer=0)),this.isFloating&&(this.floatTimer+=e)}render(e){if(this.phase==="hidden")return;const i=ae(),n=this.x,r=this.y,c=this.width*i,u=this.height*i;e.save(),e.lineWidth=2*i,e.strokeStyle="#00ff00",e.shadowBlur=6*i,e.shadowColor="#00ff00",e.globalAlpha=1,e.strokeRect(n,r,c,u);const h=`Cores Generated: ${this.cores.length}`,d=this.pulseTimer>0?this.pulseTimer/this.PULSE_DURATION:0,g=this.isFloating?.5+.5*Math.sin(this.floatTimer*3):0,m=6*i*(1+d*2+g);e.font=`${Math.round(18*i*(1+.1*d))}px monospace`,e.fillStyle="#00ff00",e.textAlign="center",e.textBaseline="bottom",e.shadowColor="#00ff00",e.shadowBlur=m;const y=n+c/2,v=r-8*i;e.fillText(h,y,v);const M=16*i,S=12*i,T=32*i,w=4*i,A=c-2*M,R=this.cores.length;if(R>0){let I=T+w;R*T+(R-1)*w>A&&(I=(A-T)/(R-1));const P=T+(R-1)*I,N=n+M+(A-P)/2,W=r+S;for(let H=0;H<R;H++){const q=N+H*I,ie=this.isFloating?4*i*Math.sin(this.floatTimer*2+H*.6):0;p2(e,q,W+ie,T,1)}}e.restore()}addCore(){this.cores.push(this.cores.length),this.pulseTimer=this.PULSE_DURATION}isAppeared(){return this.phase==="appeared"}forceCoreCount(e){this.cores=[];for(let i=0;i<e;i++)this.cores.push(i);this.pulseTimer=0}}class y2{constructor(e,i,n,r){var h;this.phase="hidden",this.settleTimer=0,this.settleDuration=.2,this.overshoot=20,this.isActive=!1,this.originalText=e,this.targetX=i,this.y=n,this.slideSpeed=r??1200;const c=ae();this.x=i-200*c;const u=e.split(":");this.labelPrefix=u[0].trim(),this.displayedValue=parseInt(((h=u[1])==null?void 0:h.trim())??"0")}trigger(){this.phase==="hidden"&&(this.phase="sliding-in")}setActive(e){this.isActive=e}update(e){switch(this.phase){case"sliding-in":{const i=this.targetX+this.overshoot,n=Math.sign(i-this.x);this.x+=n*this.slideSpeed*e,(n>0&&this.x>=i||n<0&&this.x<=i)&&(this.x=i,this.phase="settling",this.settleTimer=this.settleDuration);break}case"settling":{this.settleTimer-=e;const i=1-Math.max(0,this.settleTimer/this.settleDuration);this.x=this.targetX+this.overshoot*(1-i),this.settleTimer<=0&&(this.x=this.targetX,this.phase="appeared");break}}}render(e){if(this.phase==="hidden")return;const i=ae();Ve(e,this.x*i,this.y*i,this.getRenderedText(),{font:`${Math.round(18*i)}px monospace`,color:this.isActive?"#ffffff":"#00ff00",glow:!0,align:"left"})}getRenderedText(){return`${this.labelPrefix}: ${this.displayedValue}`}decrementDynamic(e){return this.displayedValue<=0?!1:(this.displayedValue=Math.max(0,this.displayedValue-e),!0)}isAppeared(){return this.phase==="appeared"}}const vp=200,bp=50,v2=300,b2=160,S2=28,Sp=520,M2=60;Ce.initialize();Ce.get().outcome="victory";Ce.incrementBlockCollectedCount(220);Ce.incrementWavesCleared(3);Ce.incrementKillCount(100);Ce.addCurrency(4542);Ce.incrementMassAchieved(4040);Ce.incrementIncidentsCompleted(2);class T2{constructor(e,i,n){var I;this.state="reveal",this.flyInLabels=[],this.labelRevealTimer=1,this.nextLabelIndex=0,this.summaryBox=null,this.boxTriggered=!1,this.coresToAdd=[],this.tallyIndex=0,this.tallyTimer=0,this.tallyPitchAdd=0,this.totalCores=0,this.coresAdded=0,this.currentDecrement=1,this.decrementAcceleration=1.2,this.missionResult=null,this.initialBlackoutTimer=1.2,this.introDelayTimer=1.2,this.update=()=>{var q;const x=this.gameLoop.getDeltaTime();if(this.initialBlackoutTimer>0){this.initialBlackoutTimer-=x;return}if(this.introDelayTimer>0){this.introDelayTimer-=x,this.introDelayTimer<=0&&(this.headerLabel.trigger(),this.subtitleLabel.trigger());return}const P=ae();this.inputManager.updateFrame();const{x:N,y:W}=this.inputManager.getMousePosition(),H=this.inputManager.wasMouseClicked();As(this.buttons[0],N,W,H,P),this.state==="reveal"?this.updateReveal(x):this.state==="tally"&&this.updateTally(x),this.headerLabel.update(x),this.subtitleLabel.update(x);for(const ie of this.flyInLabels)ie.update(x);(q=this.summaryBox)==null||q.update(x)},this.render=()=>{var N;if(this.initialBlackoutTimer>0)return;this.canvasManager.clearAll();const x=this.canvasManager.getContext("ui"),P=ae();if(this.headerLabel.render(x,P),this.subtitleLabel.render(x,P),!!this.hasHeaderFinished()){for(const W of this.flyInLabels)W.render(x);(N=this.summaryBox)==null||N.render(x);for(const W of this.buttons)lt(x,W);this.cursorRenderer.render()}},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.cursorRenderer=new Dh(e,n,null),this.missionResult=Ce.get().outcome;const r=g2(),c=Object.values(r).reduce((x,P)=>x+P,0);gt.getInstance().addMetaCurrency(c),this.missionResult==="victory"?(Q.play("assets/sounds/sfx/debriefing/debriefing_succeeded_00.wav","sfx"),Q.playMusic({file:"assets/sounds/music/track_06_mission4.mp3"})):(Q.play("assets/sounds/sfx/debriefing/debriefing_failed_00.wav","sfx"),Q.playMusic({file:"assets/sounds/music/track_06_mission4.mp3"}));const u=ae(),h=ci(),d=vi(),g={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:`${Math.round(18*u)}px monospace`,backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};this.buttons=[{x:h/2-vp*u/2,y:d-80*u-bp*u/2,width:vp*u,height:bp*u,label:"Return to Base",isHovered:!1,onClick:()=>{if(Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.state!=="done"){this.skipToDone();return}zb(this.canvasManager.getWebGL2Context("unifiedgl2")),Ti.getInstance().clearWebGL2Layer("unifiedgl2"),this.stop(),mt.fadeToScene("hub")},style:g}];const m="Mission Debriefing",y=((I=this.missionResult)==null?void 0:I.toUpperCase())??"ERROR";this.headerLabel=new yp(m,h/2,40*u,{align:"center",font:`${Math.round(36)}px monospace`,color:"#00ff00",glow:!0}),this.subtitleLabel=new yp(y,h/2,80*u,{align:"center",font:`${Math.round(24)}px monospace`,color:this.missionResult==="victory"?"#00ff00":"#ff0000",glow:!0});const v=b2,M=S2,S=v2,T=Ce.get(),w=[[`Waves Cleared: ${T.wavesCleared}`,r.fromWaves],[`Enemies Destroyed: ${T.enemiesDestroyed}`,r.fromKills],[`Blocks Collected: ${T.blocksCollected}`,r.fromBlocks],[`Entropium Gathered: ${T.currencyGathered}`,r.fromCurrency],[`Mass Achieved: ${T.massAchieved}`,r.fromMass],[`Incidents Completed: ${T.incidentsCompleted}`,r.fromIncidents]];this.missionResult==="victory"&&w.push(["Victory Bonus: 1000",r.fromVictory]),this.flyInLabels=w.map(([x],P)=>new y2(x,S,v+P*M)),this.coresToAdd=w.map(([x,P])=>P);const A=h/2-Sp*u/2,R=d-220*u;this.summaryBox=new m2(A,R,Sp,M2)}start(){this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render),this.cursorRenderer.destroy()}updateReveal(e){var i,n;this.labelRevealTimer-=e,this.labelRevealTimer<=0&&this.nextLabelIndex<this.flyInLabels.length&&(Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:5}),Q.play("assets/sounds/sfx/debriefing/debriefing_whoosh_00.wav","sfx",{maxSimultaneous:5}),Q.play("assets/sounds/sfx/debriefing/debriefing_whoosh_01.wav","sfx",{maxSimultaneous:5}),this.flyInLabels[this.nextLabelIndex].trigger(),this.nextLabelIndex++,this.labelRevealTimer=1),!this.boxTriggered&&this.nextLabelIndex===this.flyInLabels.length&&this.labelRevealTimer<=0&&((i=this.summaryBox)==null||i.trigger(),this.boxTriggered=!0),this.boxTriggered&&((n=this.summaryBox)!=null&&n.isAppeared())&&(this.beginTally(),this.state="tally")}beginTally(){var e;Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:10}),this.totalCores=this.coresToAdd.reduce((i,n)=>i+n,0),this.tallyIndex=0,this.tallyTimer=.5,this.currentDecrement=1,this.flyInLabels.forEach(i=>i.setActive(!1)),(e=this.flyInLabels[0])==null||e.setActive(!0)}updateTally(e){var c,u;if(this.tallyIndex>=this.coresToAdd.length){this.state="done",(c=this.summaryBox)==null||c.setFloatingState(),Q.play("assets/sounds/sfx/debriefing/debriefing_end_00.wav","sfx",{maxSimultaneous:2});return}if(this.tallyTimer-=e,this.tallyTimer>0)return;const i=this.coresToAdd[this.tallyIndex],n=this.flyInLabels[this.tallyIndex];n==null||n.setActive(!0),(n==null?void 0:n.decrementDynamic(Math.floor(this.currentDecrement)))??!1?(Q.play("assets/sounds/sfx/debriefing/debriefing_tally_01.wav","sfx",{maxSimultaneous:25,pitch:1+this.tallyPitchAdd}),this.currentDecrement*=this.decrementAcceleration,this.tallyTimer=.05,this.tallyPitchAdd-=.005):i>0?(Q.play("assets/sounds/sfx/debriefing/debriefing_addcores_00.wav","sfx",{maxSimultaneous:25}),(u=this.summaryBox)==null||u.addCore(),this.coresAdded++,this.coresToAdd[this.tallyIndex]--,this.tallyTimer=.15,this.currentDecrement=1):(Q.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:10}),n==null||n.setActive(!1),this.tallyIndex++,this.tallyPitchAdd=0,this.tallyIndex<this.flyInLabels.length&&this.flyInLabels[this.tallyIndex].setActive(!0),this.tallyTimer=.5,this.currentDecrement=1)}hasHeaderFinished(){return this.headerLabel.hasCompleted()&&this.subtitleLabel.hasCompleted()}skipToDone(){var i,n;for(const r of this.flyInLabels)r.trigger(),r.setActive(!1);this.summaryBox&&!this.boxTriggered&&(this.summaryBox.trigger(),this.boxTriggered=!0);const e=this.coresToAdd.reduce((r,c)=>r+c,0);(i=this.summaryBox)==null||i.forceCoreCount(e),this.coresAdded=e,this.coresToAdd=this.coresToAdd.map(()=>0),this.state="done",(n=this.summaryBox)==null||n.setFloatingState(),Q.play("assets/sounds/sfx/debriefing/debriefing_end_00.wav","sfx",{maxSimultaneous:2})}}class en{constructor(){this.fadeAlpha=0,this.isFading=!1,this.fadeDuration=500,this.fadeStartTime=0,this.onComplete=null}static getInstance(){return en.instance||(en.instance=new en),en.instance}startFade(e,i=500){this.isFading||(this.isFading=!0,this.fadeDuration=i,this.fadeAlpha=0,this.fadeStartTime=performance.now(),this.onComplete=e)}update(){if(!this.isFading)return;const i=performance.now()-this.fadeStartTime,n=Math.min(i/this.fadeDuration,1);this.fadeAlpha=n,n>=1&&(this.isFading=!1,this.fadeAlpha=0,this.onComplete&&(this.onComplete(),this.onComplete=null))}render(){if(!this.isFading||this.fadeAlpha<=0)return;const e=Ti.getInstance().getContext("overlay");e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=`rgba(0, 0, 0, ${this.fadeAlpha})`,e.fillRect(0,0,e.canvas.width,e.canvas.height))}isFadeInProgress(){return this.isFading}}class C2{constructor(){this.currentScene=null,this.listeners=new Set,this.canvasManager=null,this.inputManager=null,this.gameLoop=new pm,this.activeSceneManager=null;const e=en.getInstance();this.gameLoop.onRender(()=>e.render()),this.gameLoop.onUpdate(()=>e.update())}ensureCanvasManager(){return this.canvasManager||(this.canvasManager=Ti.getInstance()),this.canvasManager}ensureInputManager(){return this.inputManager||(this.canvasManager||(this.canvasManager=this.ensureCanvasManager()),this.inputManager=new gm(this.canvasManager.getCanvas("ui"))),this.inputManager}destroyTransientManagers(){this.inputManager&&(this.inputManager.destroy(),this.inputManager=null),this.canvasManager=null}setScene(e){if(Q.stopAllLoops(),this.currentScene!==e){switch(this.currentScene=e,this.activeSceneManager&&(this.activeSceneManager.stop(),this.activeSceneManager=null),e){case"title":{const i=new c1(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"hub":{const i=new N1(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"galaxy":{const i=new n2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"passives":{const i=new h2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"breakroom":{const i=new d2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"debriefing":{const i=new T2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"mission":{this.destroyTransientManagers();break}}this.listeners.forEach(i=>i(e))}}getScene(){return this.currentScene??"title"}onSceneChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getCanvasManager(){return this.canvasManager}getInputManager(){return this.inputManager}fadeToScene(e){const i=en.getInstance();i.isFadeInProgress()||i.startFade(()=>this.setScene(e))}}const mt=new C2;function gl(a=null,e=null,i){const n=Ae.getInstance(),r=n.getViewportWidth(),c=n.getViewportHeight(),u=["background-canvas","entity-canvas","fx-canvas","particles-canvas","ui-canvas","overlay-canvas","dialogue-canvas"];for(const d of u){const g=document.getElementById(d);g&&(g.width=r,g.height=c,g.style.width=`${r}px`,g.style.height=`${c}px`)}a&&a.resize(),e&&e.resize(r,c);const h=document.getElementById("canvas-root");if(h){const d=window.innerWidth,g=window.innerHeight,m=d/r,y=g/c,v=Math.min(m,y);h.style.zoom=v.toString(),h.style.width=`${r}px`,h.style.height=`${c}px`,h.style.overflow="hidden"}}class w2{constructor(){this.requests=[]}add(e){this.requests.push(e)}addMany(e){this.requests.push(...e)}getAndClear(){const e=this.requests;return this.requests=[],e}clear(){this.requests=[]}}const Ph=new w2;function Rm(a,e,i=1){const{x:n,y:r,size:c,sprite:u,overlaySprite:h,isHovered:d,isSelected:g,isLocked:m}=e,y=4*i,v=c-y;a.fillStyle=g?"#4f4":d?"#888":"#333",a.fillRect(n,r,v,v);const M=32*i*ae(),S=n+(c-M)/2,T=r+(c-M)/2;a.drawImage(u,S,T,M,M),h&&a.drawImage(h,S,T,M,M),m&&(a.fillStyle="rgba(0, 0, 0, 0.6)",a.fillRect(n,r,v,v),a.fillStyle="#ccc",a.font=`bold ${Math.round(12*i)}px sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText("",n+v/2,r+v/2)),g&&(a.strokeStyle="#0f0",a.lineWidth=2*i,a.strokeRect(n+1*i,r+1*i,v-2*i,v-2*i))}function Bm(a,e,i=1){const{x:n,y:r,width:c,height:u,label:h,isHovered:d,isActive:g,style:m={}}=e,{borderRadius:y=0,backgroundColor:v,borderColor:M,alpha:S=1,activeColor:T,backgroundGradient:w}=m,A=c*i,R=u*i,I=y;a.save(),a.globalAlpha=S;let x;if(g&&T)x=T;else if(!g&&w){const{type:N,stops:W,from:H=[n,r],to:q=[n+c,r+u],radius:ie=c/2}=w,$=N==="linear"?a.createLinearGradient(H[0],H[1],q[0],q[1]):a.createRadialGradient(H[0],H[1],0,H[0],H[1],ie*i);for(const K of W)$.addColorStop(K.offset,d?Vi(K.color,.1):K.color);x=$}else x=v??(g?"#4f4":d?"#444":"#222");const P=M??(g?"#0f0":"#888");a.fillStyle=x,a.strokeStyle=P,a.lineWidth=1*i,I>0?(a.beginPath(),a.roundRect(n,r,A,R,I),a.fill(),a.stroke()):(a.fillRect(n,r,A,R),a.strokeRect(n,r,A,R)),a.fillStyle="#fff",a.font=`${Math.round(12*i*ae())}px sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText(h,n+A/2,r+R/2),a.restore()}function Im(a){var i,n;const e=new Map;for(const r of a){const c=((i=r.subcategory)==null?void 0:i.toLowerCase())??((n=r.id.match(/^[a-z]+/))==null?void 0:n[0])??"default";e.has(c)||e.set(c,[]),e.get(c).push(r)}return e}var _e=(a=>(a.PLACE="PLACE",a.REPAIR="REPAIR",a.REPAIR_ALL="REPAIR_ALL",a.SAVE="SAVE",a.LOAD="LOAD",a))(_e||{});function Si(a){const{type:e,hp:i}=a,n=Math.max(0,e.armor-i);if(n===0)return 0;const r=e.cost/e.armor;return Math.ceil(r*n)}function me(a,e,i,n,r,c="#888",u,h=1){const g=`${Math.round(14*h)}px monospace`,m=16*h;a.font=g;const v=`${n}: ${r}`.split(" "),M=[];let S="";for(const T of v){const w=S?`${S} ${T}`:T;a.measureText(w).width>u&&S?(M.push(S),S=T):S=w}S&&M.push(S);for(const T of M){const w=T.indexOf(":"),A=w!==-1,R=A?T.slice(0,w+1):"",I=A?T.slice(w+1).trim():T;Ve(a,e,i,[...A?[{text:R+" ",color:c}]:[],{text:I,color:"#fff"}],{font:g,align:"left"}),i+=m}return i}function Jr(){return Ae.getInstance().getInterfaceScale()||2}function sh(a){const e=ci(),i=1920,n=.75,c=n+(Math.min(e,3840)-i)*(1.25-n)/(3840-i);return a*c}const A2=new Set(["canThrust","canFire"]),k2=["hull","engine","weapon","utility"];class E2{constructor(e,i){this.repairAllHandler=null,this.activeTab="hull",this.selectedBlockId="hull1",this.activeTool=_e.PLACE,this.hoveredShipBlock=void 0,this.hoveredUtilityTool=null,this.open=!1,this.originalZoom=0,this.PADDING=0,this.TILE_SIZE=0,this.GRID_COLS=6,this.GRID_ROWS=6,this.WINDOW_HEADER_HEIGHT=0,this.BLOCK_INFO_OFFSET=0,this.INFO_WINDOW_HEIGHT=0,this.WINDOW_X=0,this.WINDOW_Y=0,this.WINDOW_WIDTH=0,this.WINDOW_HEIGHT=0,this.BLOCKINFO_WINDOW_WIDTH=0,this.UTILITY_WINDOW_WIDTH=0,this.UTILITY_BUTTON_VERTICAL_MARGIN=0,this.UTILITY_BUTTON_SPACING=0,this.UTILITY_BUTTON_HEIGHT=0,this.TOTAL_MENU_WIDTH=0,this.SLIDE_SPEED=0,this.OVERSHOOT_DISTANCE=0,this.SETTLE_SPEED=0,this.slideX=0,this.isAnimating=!1,this.animationPhase=null,this.targetX=0,this.resize(),this.inputManager=e,this.cursorRenderer=i,this.slideX=-(this.TOTAL_MENU_WIDTH+50)}resize(){const e=Math.max(1,Jr()*RS());this.PADDING=16*e,this.TILE_SIZE=40*e,this.WINDOW_HEADER_HEIGHT=28*e,this.BLOCK_INFO_OFFSET=12*e,this.INFO_WINDOW_HEIGHT=200*e,this.WINDOW_X=20*e,this.WINDOW_Y=40*e,this.WINDOW_WIDTH=this.TILE_SIZE*this.GRID_COLS+this.PADDING*2,this.WINDOW_HEIGHT=this.TILE_SIZE*this.GRID_ROWS+60*e,this.BLOCKINFO_WINDOW_WIDTH=this.TILE_SIZE*(this.GRID_COLS-2)+this.PADDING*2,this.UTILITY_WINDOW_WIDTH=this.TILE_SIZE+this.PADDING*2,this.UTILITY_BUTTON_VERTICAL_MARGIN=14*e,this.UTILITY_BUTTON_SPACING=8*e,this.UTILITY_BUTTON_HEIGHT=32*e,this.TOTAL_MENU_WIDTH=this.WINDOW_WIDTH+this.BLOCKINFO_WINDOW_WIDTH+this.UTILITY_WINDOW_WIDTH+this.PADDING,this.SLIDE_SPEED=6*e,this.OVERSHOOT_DISTANCE=30*e,this.SETTLE_SPEED=2*e}render(e){const i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked(),r=this.buildCategoryTabs(),c=Mt({ctx:e,x:this.WINDOW_X+this.slideX,y:this.WINDOW_Y,width:this.WINDOW_WIDTH,height:this.WINDOW_HEIGHT,title:"",tabs:r,mouse:i,clicked:n,options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",activeTabColor:"#66ff66",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),u=Ao(),h=u.filter(v=>v.category===this.activeTab),d=u.find(v=>v.id===this.selectedBlockId)??null,g=this.renderBlockGrid(e,h,i,n,this.WINDOW_X+this.PADDING+this.slideX,this.WINDOW_Y+this.WINDOW_HEADER_HEIGHT,c),m=this.WINDOW_X+this.slideX,y=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET;if(this.hoveredUtilityTool)this.renderToolInfo(e,this.hoveredUtilityTool,m,y,this.BLOCKINFO_WINDOW_WIDTH),this.cursorRenderer.setHoveredCursor();else if(this.activeTool===_e.REPAIR)this.renderRepairInfoForBlock(e,this.hoveredShipBlock,m,y,this.BLOCKINFO_WINDOW_WIDTH),this.cursorRenderer.setWrenchCursor();else{const v=g??d??null;this.renderBlockInfo(e,v,m,y,this.BLOCKINFO_WINDOW_WIDTH),g?this.cursorRenderer.setHoveredCursor():this.activeTool===_e.PLACE&&!this.isPointInBounds(i.x,i.y)?this.cursorRenderer.setSmallCircleCursor():this.cursorRenderer.setDefaultCursor()}this.renderUtilityWindow(e,this.WINDOW_X+this.BLOCKINFO_WINDOW_WIDTH+.5*this.PADDING+this.slideX,this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET,this.UTILITY_WINDOW_WIDTH,this.INFO_WINDOW_HEIGHT,i,n)}buildCategoryTabs(){return k2.map(e=>({label:e.toUpperCase(),isActive:this.activeTab===e,onClick:()=>{this.activeTab!==e&&(this.activeTab=e)}}))}renderBlockGrid(e,i,n,r,c,u,h){const d=ii.getInstance(),g=Im(i),m=this.TILE_SIZE;let y=0,v=null;for(const[,M]of g){for(let S=0;S<M.length;S++){const T=M[S],w=S%this.GRID_COLS,A=y,R=c+w*this.TILE_SIZE,I=u+A*m,x=n.x>=R&&n.x<=R+this.TILE_SIZE&&n.y>=I&&n.y<=I+this.TILE_SIZE,P=this.selectedBlockId===T.id,N=d.isUnlocked(T.id),W=Yi(T.id);Rm(e,{x:R,y:I,size:this.TILE_SIZE,sprite:W.base,overlaySprite:W.overlay,isHovered:x,isSelected:P,isLocked:!N}),x&&(v=T),x&&r&&!h&&N&&(Q.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.selectedBlockId=T.id,this.setActiveTool(_e.PLACE),this.setHoveredShipBlock(void 0))}y++}return v}renderBlockInfo(e,i,n,r,c){Mt({ctx:e,x:n,y:r,width:c,height:this.INFO_WINDOW_HEIGHT,title:"Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const u=n+this.PADDING;let h=r+32;const d=c,g=v=>v.charAt(0).toUpperCase()+v.slice(1),m=v=>v===void 0?"":typeof v=="boolean"?v?"Yes":"No":typeof v=="number"||typeof v=="string"?v:String(v);if(!i)return;const y=Math.max(.75,sh(Jr()));h=me(e,u,h,"Name",i.name,"#6cf",d,y),h=me(e,u,h,"Armor",m(i.armor),"#09f",d,y),h=me(e,u,h,"Mass",m(i.mass),"#999",d,y),h=me(e,u,h,"Cost",m(i.cost),"#6f6",d,y),i.behavior&&Object.entries(i.behavior).forEach(([v,M])=>{A2.has(v)||(M&&typeof M=="object"&&!Array.isArray(M)?(h=me(e,u,h,g(v),"","#fc6",d,y),Object.entries(M).forEach(([S,T])=>{const w=` ${g(S)}`;h=me(e,u,h,w,m(T),"#999",d,y)})):h=me(e,u,h,g(v),m(M),"#fc6",d,y))})}renderRepairInfoForBlock(e,i,n,r,c){Mt({ctx:e,x:n,y:r,width:c,height:this.INFO_WINDOW_HEIGHT,title:"Repair Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const u=n+this.PADDING;let h=r+32;const d=c,g=Math.max(.75,sh(Jr()));if(!i){h=me(e,u,h,"Hover block","to inspect","#888",d,g),h=me(e,u,h,"Repair","Left-click","#888",d,g);return}const{type:m,hp:y}=i,v=m.armor-y;h=me(e,u,h,"Name",m.name,"#6cf",d,g),h=me(e,u,h,"Armor",`${y} / ${m.armor}`,"#09f",d,g),h=me(e,u,h,"Damage",v>0?v:"None","#f66",d,g),h=me(e,u,h,"Repair Cost",v>0?Si(i):"","#6f6",d,g)}renderUtilityWindow(e,i,n,r,c,u,h){Mt({ctx:e,x:i,y:n,width:r,height:c,title:"",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const d=this.UTILITY_BUTTON_SPACING,g=this.UTILITY_BUTTON_HEIGHT,m=r-this.PADDING*2,y=i+this.PADDING;let v=n+this.WINDOW_HEADER_HEIGHT+d-this.UTILITY_BUTTON_VERTICAL_MARGIN;this.hoveredUtilityTool=null;const M=[{label:"",tool:_e.REPAIR,action:()=>{Q.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.setActiveTool(_e.REPAIR),this.setSelectedBlockId(null)}},{label:"",tool:_e.REPAIR_ALL,action:()=>{var S;Q.play("assets/sounds/sfx/ui/click_00.wav","sfx"),(S=this.repairAllHandler)==null||S.call(this)}},{label:"",tool:_e.SAVE,action:()=>{Q.play("assets/sounds/sfx/ui/click_00.wav","sfx")}},{label:"",tool:_e.LOAD,action:()=>{Q.play("assets/sounds/sfx/ui/click_00.wav","sfx")}}];for(const{label:S,tool:T,action:w}of M){const A=u.x>=y&&u.x<=y+m&&u.y>=v&&u.y<=v+g,R=T!=null&&this.getActiveTool()===T;A&&T&&(this.hoveredUtilityTool=T),Bm(e,{x:y,y:v,width:m,height:g,label:S,isHovered:A,isActive:R,style:{alpha:.6,borderRadius:8,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),A&&h&&w(),v+=g+d}}renderToolInfo(e,i,n,r,c){Mt({ctx:e,x:n,y:r,width:c,height:this.INFO_WINDOW_HEIGHT,title:"Tool Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const u=n+this.PADDING;let h=r+32;const d=c-this.PADDING,g=Math.max(.75,sh(Jr()));i===_e.REPAIR&&(h=me(e,u,h,"Repair Mode","Individual block repair","#888",d,g),h=me(e,u,h,"Cost","Based on damage","#888",d,g)),i===_e.REPAIR_ALL&&(h=me(e,u,h,"Repair All","Repairs all damaged blocks","#888",d,g),h=me(e,u,h,"Cost","As much as you can afford","#888",d,g),h=me(e,u,h,"Order","Repairs most damaged blocks first","#888",d,g))}update(){yt.getInstance(),this.isAnimating&&(this.animationPhase==="sliding-in"?(this.slideX+=this.SLIDE_SPEED,this.slideX>=this.targetX+this.OVERSHOOT_DISTANCE&&(this.animationPhase="settling")):this.animationPhase==="settling"?(this.slideX-=this.SETTLE_SPEED,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.isAnimating=!1,this.animationPhase=null)):this.animationPhase==="sliding-out"&&(this.slideX-=this.SLIDE_SPEED,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.animationPhase=null,this.isAnimating=!1,this.open=!1,this.cursorRenderer.setDefaultCursor())))}isBlocking(){return!0}getSelectedBlockId(){return this.selectedBlockId}setSelectedBlockId(e){this.selectedBlockId=e}setHoveredShipBlock(e){this.hoveredShipBlock=e}isOpen(){return this.open}openMenu(){this.resize(),Q.play("assets/sounds/sfx/ui/activate_01.wav","sfx"),this.open=!0;const e=yt.getInstance();this.originalZoom=e.getZoom(),e.animateZoomTo(this.getMenuTargetZoom()),this.slideX=-(this.TOTAL_MENU_WIDTH+50),this.targetX=0,this.isAnimating=!0,this.animationPhase="sliding-in"}closeMenu(){this.targetX=-(this.TOTAL_MENU_WIDTH+50),this.animationPhase="sliding-out",this.isAnimating=!0,yt.getInstance().animateZoomTo(this.originalZoom)}setActiveTool(e){this.activeTool=e}getActiveTool(){return this.activeTool}isPointInBounds(e,i){const n=this.WINDOW_X+this.WINDOW_WIDTH+this.slideX,r=this.WINDOW_Y+this.WINDOW_HEIGHT,c=this.WINDOW_X+this.BLOCKINFO_WINDOW_WIDTH+this.slideX,u=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET+this.INFO_WINDOW_HEIGHT,h=this.WINDOW_X+this.BLOCKINFO_WINDOW_WIDTH+this.PADDING+this.slideX,d=h+this.UTILITY_WINDOW_WIDTH,g=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET,m=g+this.INFO_WINDOW_HEIGHT,v=e>=this.WINDOW_X+this.slideX&&e<=n&&i>=this.WINDOW_Y-30*ae()&&i<=r,M=e>=this.WINDOW_X+this.slideX&&e<=c&&i>=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET&&i<=u,S=e>=h&&e<=d&&i>=g&&i<=m;return v||M||S}setRepairAllHandler(e){this.repairAllHandler=e}getCursorRenderer(){return this.cursorRenderer}getMenuTargetZoom(){return .5*ae()}}const li=16,zi=40,Lh=6,R2=6,Mp=28,yo=12,Qn=200,Hi=20,Gi=40,Tp=zi*Lh+li*2,Ys=zi*R2+60,$n=zi*(Lh-2)+li*3,Cp=zi+li,B2=14,wp=10,I2=30,x2=4,_2=new Set(["canThrust","canFire"]),D2=["hull","engine","weapon","utility"];class P2{constructor(e,i){this.repairAllHandler=null,this.activeTab="hull",this.selectedBlockId="hull1",this.activeTool=_e.PLACE,this.hoveredShipBlock=void 0,this.hoveredUtilityTool=null,this.open=!1,this.slideX=0,this.isAnimating=!1,this.animationPhase=null,this.targetX=0,this.inputManager=e,this.cursorRenderer=i,this.slideX=-602}render(e){const i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked(),r=this.buildCategoryTabs(),c=Mt({ctx:e,x:Hi+this.slideX,y:Gi,width:Tp,height:Ys,title:"",tabs:r,mouse:i,clicked:n,options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",activeTabColor:"#66ff66",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),u=Ao(),h=u.filter(v=>v.category===this.activeTab),d=u.find(v=>v.id===this.selectedBlockId)??null,g=this.renderBlockGrid(e,h,i,n,Hi+li+this.slideX,Gi+Mp,c),m=Hi+this.slideX,y=Gi+Ys+yo;if(this.hoveredUtilityTool)this.renderToolInfo(e,this.hoveredUtilityTool,m,y,$n),this.cursorRenderer.setHoveredCursor();else if(this.activeTool===_e.REPAIR)this.renderRepairInfoForBlock(e,this.hoveredShipBlock,m,y,$n),this.cursorRenderer.setWrenchCursor();else{const v=g??d??null;this.renderBlockInfo(e,v,m,y,$n),g?this.cursorRenderer.setHoveredCursor():this.activeTool===_e.PLACE&&!this.isPointInBounds(i.x,i.y)?this.cursorRenderer.setSmallCircleCursor():this.cursorRenderer.setDefaultCursor()}this.renderUtilityWindow(e,Hi+$n+li+this.slideX,Gi+Ys+yo,Cp,Qn,i,n)}buildCategoryTabs(){return D2.map(e=>({label:e.toUpperCase(),isActive:this.activeTab===e,onClick:()=>{this.activeTab!==e&&(this.activeTab=e)}}))}renderBlockGrid(e,i,n,r,c,u,h){const d=ii.getInstance(),g=Im(i),m=zi;let y=0,v=null;for(const[,M]of g){for(let S=0;S<M.length;S++){const T=M[S],w=S%Lh,A=y,R=c+w*zi,I=u+A*m,x=n.x>=R&&n.x<=R+zi&&n.y>=I&&n.y<=I+zi,P=this.selectedBlockId===T.id,N=d.isUnlocked(T.id),W=Yi(T.id);Rm(e,{x:R,y:I,size:zi,sprite:W.base,overlaySprite:W.overlay,isHovered:x,isSelected:P,isLocked:!N}),x&&(v=T),x&&r&&!h&&N&&(Q.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.selectedBlockId=T.id,this.setActiveTool(_e.PLACE),this.setHoveredShipBlock(void 0))}y++}return v}renderBlockInfo(e,i,n,r,c){Mt({ctx:e,x:n,y:r,width:c,height:Qn,title:"Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const u=n+li;let h=r+32;const d=c+10,g=y=>y.charAt(0).toUpperCase()+y.slice(1),m=y=>y===void 0?"":typeof y=="boolean"?y?"Yes":"No":typeof y=="number"||typeof y=="string"?y:String(y);i&&(h=me(e,u,h,"Name",i.name,"#6cf",d),h=me(e,u,h,"Armor",m(i.armor),"#09f",d),h=me(e,u,h,"Mass",m(i.mass),"#999",d),h=me(e,u,h,"Cost",m(i.cost),"#6f6",d),i.behavior&&Object.entries(i.behavior).forEach(([y,v])=>{_2.has(y)||(v&&typeof v=="object"&&!Array.isArray(v)?(h=me(e,u,h,g(y),"","#fc6",d),Object.entries(v).forEach(([M,S])=>{const T=` ${g(M)}`;h=me(e,u,h,T,m(S),"#999",d)})):h=me(e,u,h,g(y),m(v),"#fc6",d))}))}renderRepairInfoForBlock(e,i,n,r,c){Mt({ctx:e,x:n,y:r,width:c,height:Qn,title:"Repair Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const u=n+li;let h=r+32;const d=c+10;if(!i){h=me(e,u,h,"Hover block","to inspect","#888",d),h=me(e,u,h,"Repair","Left-click","#888",d);return}const{type:g,hp:m}=i,y=g.armor-m;h=me(e,u,h,"Name",g.name,"#6cf",d),h=me(e,u,h,"Armor",`${m} / ${g.armor}`,"#09f",d),h=me(e,u,h,"Damage",y>0?y:"None","#f66",d),h=me(e,u,h,"Repair Cost",y>0?Si(i):"","#6f6",d)}renderUtilityWindow(e,i,n,r,c,u,h){Mt({ctx:e,x:i,y:n,width:r,height:c,title:"",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const d=32,g=8,m=r-li*2,y=i+li;let v=n+Mp+g-B2;this.hoveredUtilityTool=null;const M=[{label:"",tool:_e.REPAIR,action:()=>{Q.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.setActiveTool(_e.REPAIR),this.setSelectedBlockId(null)}},{label:"",tool:_e.REPAIR_ALL,action:()=>{var S;Q.play("assets/sounds/sfx/ui/click_00.wav","sfx"),(S=this.repairAllHandler)==null||S.call(this)}},{label:"",tool:_e.SAVE,action:()=>{Q.play("assets/sounds/sfx/ui/click_00.wav","sfx")}},{label:"",tool:_e.LOAD,action:()=>{Q.play("assets/sounds/sfx/ui/click_00.wav","sfx")}}];for(const{label:S,tool:T,action:w}of M){const A=u.x>=y&&u.x<=y+m&&u.y>=v&&u.y<=v+d,R=T!=null&&this.getActiveTool()===T;A&&T&&(this.hoveredUtilityTool=T),Bm(e,{x:y,y:v,width:m,height:d,label:S,isHovered:A,isActive:R,style:{alpha:.6,borderRadius:8,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),A&&h&&w(),v+=d+g}}renderToolInfo(e,i,n,r,c){Mt({ctx:e,x:n,y:r,width:c,height:Qn,title:"Tool Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const u=n+li;let h=r+32;const d=c+10;i===_e.REPAIR&&(h=me(e,u,h,"Repair Mode","Individual block repair","#888",d),h=me(e,u,h,"Cost","Based on damage","#888",d)),i===_e.REPAIR_ALL&&(h=me(e,u,h,"Repair All","Repairs all damaged blocks","#888",d),h=me(e,u,h,"Cost","As much as you can afford","#888",d),h=me(e,u,h,"Order","Repairs most damaged blocks first","#888",d))}update(){this.isAnimating&&(this.animationPhase==="sliding-in"?(this.slideX+=wp,this.slideX>=this.targetX+I2&&(this.animationPhase="settling")):this.animationPhase==="settling"?(this.slideX-=x2,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.isAnimating=!1,this.animationPhase=null)):this.animationPhase==="sliding-out"&&(this.slideX-=wp,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.animationPhase=null,this.isAnimating=!1,this.open=!1,this.cursorRenderer.setDefaultCursor())))}isBlocking(){return!0}getSelectedBlockId(){return this.selectedBlockId}setSelectedBlockId(e){this.selectedBlockId=e}setHoveredShipBlock(e){this.hoveredShipBlock=e}isOpen(){return this.open}openMenu(){Q.play("assets/sounds/sfx/ui/activate_01.wav","sfx"),this.open=!0,this.slideX=-602,this.targetX=0,this.isAnimating=!0,this.animationPhase="sliding-in"}closeMenu(){this.targetX=-602,this.animationPhase="sliding-out",this.isAnimating=!0}setActiveTool(e){this.activeTool=e}getActiveTool(){return this.activeTool}isPointInBounds(e,i){const n=Hi+Tp+this.slideX,r=Gi+Ys,c=Hi+$n+this.slideX,u=Gi+Ys+yo+Qn,h=Hi+$n+li+this.slideX,d=h+Cp,g=Gi+Ys+yo,m=g+Qn,v=e>=Hi+this.slideX&&e<=n&&i>=Gi-30&&i<=r,M=e>=Hi+this.slideX&&e<=c&&i>=Gi+Ys+yo&&i<=u,S=e>=h&&e<=d&&i>=g&&i<=m;return v||M||S}setRepairAllHandler(e){this.repairAllHandler=e}getCursorRenderer(){return this.cursorRenderer}}const Ap=new Map;function xm(a,e,i=0,n="rgba(100, 255, 255, 0.4)"){const r=`${e}_${i}_${n}`;let c=Ap.get(r);if(!c){const h=Yi(e).base;if(!h)return;const d=document.createElement("canvas");d.width=z,d.height=z;const g=d.getContext("2d");g.fillStyle=n,g.fillRect(0,0,z,z),g.save(),g.translate(z/2,z/2),g.rotate(i*Math.PI/180),g.translate(-32/2,-32/2),g.globalCompositeOperation="destination-in",g.drawImage(h,0,0),g.restore(),g.globalCompositeOperation="source-over",c=d,Ap.set(r,c)}a.drawImage(c,-32/2,-32/2)}function _m(a,e="rgba(0,255,0,0.3)"){a.save(),a.fillStyle=e,a.fillRect(-32/2,-32/2,z,z),a.restore()}function Oh(a,e){a.save(),a.fillStyle=e?"rgba(0,255,0,0.3)":"rgba(255,0,0,0.3)",a.fillRect(-32/2,-32/2,z,z),a.restore()}function fa(a,e,i,n){const r=e.screenToWorld(a.x,a.y),c=r.x-i.x,u=r.y-i.y,h=Math.cos(-n),d=Math.sin(-n),g=c*h-u*d,m=c*d+u*h;return{x:Math.round(g/z),y:Math.round(m/z)}}function Fh(a,e){return[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].some(n=>a.hasBlockAt(n))}class L2{constructor(e,i,n,r,c){this.spaceStation=e,this.menu=i,this.camera=n,this.shipBuilderEffects=r,this.inputManager=c,this.rotation=0,this.lastBlockId=null,this.hasSaved=!1,this.hoveredShipCoord=null}update(e){this.inputManager.wasKeyJustPressed("Space")&&(this.rotation=(this.rotation+90)%360);const i=this.inputManager.getMousePosition();if(this.isCursorOverMenu(i))return;const n=fa(i,this.camera,e.position,e.rotation);if(this.menu.getActiveTool()===_e.REPAIR){const h=this.spaceStation.getBlock(n);this.menu.setHoveredShipBlock(h),h&&this.inputManager.wasMouseClicked()&&(Q.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n));return}const r=this.menu.getSelectedBlockId();if(!r||(r!==this.lastBlockId&&(this.rotation=0,this.lastBlockId=r),!Yi(r)))return;const u=nm(r);if(u!==void 0){if(this.inputManager.wasRightClicked()){const h=this.spaceStation.getBlock(n);if(!h)return;if(!h.type.id.startsWith("cockpit")){this.spaceStation.removeBlock(n),Q.play("assets/sounds/sfx/ui/click_00.wav","sfx",{maxSimultaneous:3});const d=Math.round(u/2);Be.getInstance().addCurrency(d)}}this.inputManager.wasMouseClicked()&&(this.spaceStation.placeBlockById(n,r,this.rotation),Q.play("assets/sounds/sfx/ship/attach_00.wav","sfx",{maxSimultaneous:3}),Be.getInstance().spendCurrency(u),Ce.incrementBlockPlacedCount()),this.inputManager.isLPressed()&&!this.hasSaved&&(this.hasSaved=!0),!this.inputManager.isLPressed()&&this.hasSaved&&(this.hasSaved=!1)}}render(e,i){const n=this.inputManager.getMousePosition();if(this.isCursorOverMenu(n))return;const r=fa(n,this.camera,i.position,i.rotation),c=r.x*z,u=r.y*z,h=Math.cos(i.rotation),d=Math.sin(i.rotation),g=c*h-u*d,m=c*d+u*h,y=i.position.x+g,v=i.position.y+m,M=this.camera.worldToScreen(y,v);e.save(),e.translate(M.x,M.y),e.scale(this.camera.getZoom(),this.camera.getZoom()),e.rotate(i.rotation);const S=this.menu.getActiveTool();if(S===_e.REPAIR)this.spaceStation.getBlock(r)&&_m(e,"rgba(0,255,0,0.3)");else if(S===_e.PLACE){const T=this.menu.getSelectedBlockId();if(!T){e.restore();return}if(this.spaceStation.getBlock(r)){const A=this.spaceStation.isDeletionSafe(r);Oh(e,A)}else{const A=Yi(T);e.save(),e.rotate(this.rotation*Math.PI/180),e.globalAlpha=.6,e.drawImage(A.base,-32/2,-32/2,z,z),e.restore()}}e.restore()}isCursorOverMenu(e){return this.menu.isPointInBounds(e.x,e.y)}repairBlockAt(e){const i=this.spaceStation.getBlock(e);if(!i||i.type.armor-i.hp<=0)return;const r=Si(i),c=Be.getInstance();c.hasEnoughCurrency(r)&&(c.spendCurrency(r),i.hp=i.type.armor,this.shipBuilderEffects.createRepairEffect(i.position))}repairAllBlocks(){const e=Be.getInstance(),i=this.spaceStation.getAllBlocks().filter(([,n])=>n.hp<n.type.armor).map(([n,r])=>({coord:n,block:r})).sort((n,r)=>{const c=n.block.type.armor-n.block.hp,u=r.block.type.armor-r.block.hp;if(c!==u)return u-c;const h=Si(n.block),d=Si(r.block);return h-d});for(const{coord:n,block:r}of i){const c=Si(r);if(e.hasEnoughCurrency(c))Q.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n);else{console.log("Stopped repair: insufficient funds.");break}}}getHoveredShipBlock(){return this.hoveredShipCoord?this.spaceStation.getBlock(this.hoveredShipCoord):void 0}}const O2=[["#ffffff","#ffffff","#dddddd"],["#ffffff","#ffffff","#dddddd"],["#66ff66","#33cc33","#99ff99"],["#66ccff","#3399ff","#99ddff"],["#cc88ff","#9933ff","#ddaaff"]],ia=["#ffdd00","#ffaa00","#ff6600","#ff2200","#ffffff"],F2={engine0:["#ffeeb0","#ffc04d","#ffd966"],engine1:["#ffeeb0","#ffc04d","#ffd966"],engine2:["#66ff66","#33cc33","#99ff99"],engine3:["#66ccff","#3399ff","#99ddff"],engine4:["#cc88ff","#9933ff","#ddaaff"]},kp={turret0:["#ffff88","#ffaa00","#ffcc33"],turret1:["#ff8888","#ff3333","#ffaaaa"],turret2:["#88ff88","#33dd33","#aaffaa"],turret3:["#88ccff","#3399ff","#66ddff"],turret4:["#cc88ff","#9933ff","#ddaaff"]},Ep={laser0:["#00CCFF","#00FFFF","#00faff"],laser1:["#00CCFF","#00FFFF","#00faff"],laser2:["#E6FFED","#76FF03","#33691E"],laser3:["#F3E5F5","#D500F9","#4A148C"]},Dm={shield0:["#88ddff","#44bbff","#00aaff"],shield1:["#88ddff","#44bbff","#00aaff"],shield2:["#aaffaa","#66dd66","#22bb22"],shield3:["#ffbbff","#dd66dd","#cc33cc"]},U2={shield0:"rgba(100, 255, 255, 0.4)",shield1:"rgba(100, 255, 255, 0.4)",shield2:"rgba(91, 255, 91, 0.4)",shield3:"rgba(255, 86, 255, 0.4)"},vo={explosiveLance0:["#ffcc00","#ff6600","#cc2200"],explosiveLance1:["#ffcc00","#ff6600","#cc2200"],explosiveLance2:["#aaffaa","#66dd66","#228822"],explosiveLance3:["#ccccff","#9999ff","#4444aa"],explosiveLance4:["#ff66cc","#ff3399","#990066"]},Rp={0:"#ffffff",1:"#ffffff",2:"#00aa33",3:"#0033cc",4:"#6600cc",5:"#ffcc00",10:"#ff3366"},Pm={0:"#A9A9A9",1:"#A9A9A9",2:"#00aa33",3:"#0033cc",4:"#6600cc",5:"#ffcc00",10:"#ff3366"},N2={currency:"#FFD700",repair:"#FF4444",block:"#CC66FF"};function H2(a){pe.emit("menu:opened",{id:a})}function Bp(a){pe.emit("menu:closed",{id:a})}const G2={id:"fighter",name:"Fighter",description:"Sleek fighter with forward hull and symmetric wings",primaryAxis:"vertical",symmetryAxis:"x",shapeScoreMap:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;let r=0;return n<=0&&(r+=20+Math.abs(n)*5),n>0&&n<=3&&(r+=15-n*2),Math.abs(i)>=2&&Math.abs(i)<=5&&n>=-1&&n<=2&&(r+=25),Math.abs(i)>1&&Math.abs(n)<=1&&(r-=15),r},featureZones:{leftWing:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i<=-2&&n>=-1&&n<=3},rightWing:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i>=2&&n>=-1&&n<=3},hull:(a,e)=>{const i=a.x-e.x;return Math.abs(i)<=1},nose:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&n<=-1},engineBay:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&n>=1&&n<=3}},blockBiases:{engine:{preferredZones:["engineBay","hull"],bonusInZone:30,penaltyOutsideZone:20},weapon:{preferredZones:["nose","leftWing","rightWing"],bonusInZone:25,penaltyOutsideZone:15},fin:{preferredZones:["leftWing","rightWing"],bonusInZone:35,penaltyOutsideZone:25,avoidZones:["hull"]},facetplate:{preferredZones:["leftWing","rightWing","nose"],bonusInZone:20,penaltyOutsideZone:10},hull:{preferredZones:["hull"],bonusInZone:15},system:{preferredZones:["hull"],bonusInZone:20,penaltyOutsideZone:15},utility:{preferredZones:["hull"],bonusInZone:15}},minimumStructureRules:[{zone:"leftWing",minCount:3,description:"Left wing needs structure"},{zone:"rightWing",minCount:3,description:"Right wing needs structure"},{zone:"engineBay",minCount:1,description:"Need rear propulsion"}],weights:{shapeScore:1,symmetryScore:.8,zoneAffinityScore:1.2,structuralGoalScore:1.5}},W2={id:"carrier",name:"Carrier",description:"Broad carrier with wide deck and central command",primaryAxis:"horizontal",symmetryAxis:"y",shapeScoreMap:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;let r=0;return Math.abs(i)<=6&&(r+=25-Math.abs(i)*2),Math.abs(n)<=2&&(r+=30),Math.abs(n)>3&&(r-=Math.abs(n)*8),r},featureZones:{centralHull:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=2&&Math.abs(n)<=1},deck:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=6&&Math.abs(n)<=2},leftFlank:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i<=-3&&Math.abs(n)<=2},rightFlank:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i>=3&&Math.abs(n)<=2},superstructure:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&n<=-1}},blockBiases:{weapon:{preferredZones:["deck","leftFlank","rightFlank","superstructure"],bonusInZone:25,penaltyOutsideZone:10},engine:{preferredZones:["centralHull"],bonusInZone:30,penaltyOutsideZone:25},system:{preferredZones:["centralHull","superstructure"],bonusInZone:20,penaltyOutsideZone:15},utility:{preferredZones:["centralHull","deck"],bonusInZone:15},hull:{preferredZones:["deck"],bonusInZone:10},facetplate:{preferredZones:["leftFlank","rightFlank"],bonusInZone:20}},minimumStructureRules:[{zone:"deck",minCount:8,description:"Need substantial deck area"},{zone:"centralHull",minCount:4,description:"Need central structure"}],weights:{shapeScore:1.2,symmetryScore:1,zoneAffinityScore:1.1,structuralGoalScore:1.3}},z2={id:"interceptor",name:"Interceptor",description:"Compact, fast interceptor with minimal profile",primaryAxis:"vertical",symmetryAxis:"x",shapeScoreMap:(a,e)=>{const i=a.x-e.x,n=a.y-e.y,r=Math.sqrt(i*i+n*n);let c=0;return r<=3?c+=35-r*8:c-=r*15,n<=0&&(c+=5),Math.abs(i)<=1&&(c+=15),c},featureZones:{core:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&Math.abs(n)<=2},wingtips:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)===2&&Math.abs(n)<=1}},blockBiases:{engine:{preferredZones:["core"],bonusInZone:35,penaltyOutsideZone:30},weapon:{preferredZones:["core","wingtips"],bonusInZone:25,penaltyOutsideZone:20},fin:{preferredZones:["wingtips"],bonusInZone:30,penaltyOutsideZone:25}},minimumStructureRules:[{zone:"core",minCount:5,maxCount:12,description:"Compact core design"}],weights:{shapeScore:1.5,symmetryScore:.6,zoneAffinityScore:1.3,structuralGoalScore:1.4}},V2={fighter:G2,carrier:W2,interceptor:z2};function Ip(a){return V2[a]||null}function xp(a,e,i,n){return i.some(r=>{const c=n.featureZones[r];return c&&c(a,e)})}function X2(a,e,i){const n=[];for(const[r,c]of Object.entries(i.featureZones))c(a,e)&&n.push(r);return n}function Y2(a,e,i,n){if(!i||i==="none")return 0;let r=0;if(i==="x"||i==="both"){const c={x:e.x-(a.x-e.x),y:a.y};n.hasBlockAt(c)?r+=15:r-=5}if(i==="y"||i==="both"){const c={x:a.x,y:e.y-(a.y-e.y)};n.hasBlockAt(c)?r+=15:r-=5}return r}function q2(a,e,i,n){return a.name.toLowerCase().includes("facetplate")?Om(e,i,n):a.name.toLowerCase().includes("fin")?Lm(e,i,n):!0}function j2(a,e){const i=[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}];let n=!1;for(const r of i){const c={x:a.x+r.x,y:a.y+r.y},u=e.getBlock(c);if(u){const h=u.type.name.toLowerCase();if(!h.includes("fin")&&!h.includes("facetplate")){n=!0;break}}}return n}function Lm(a,e,i){let n;switch(e){case 0:n=[{x:a.x+1,y:a.y},{x:a.x,y:a.y+1}];break;case 90:n=[{x:a.x-1,y:a.y},{x:a.x,y:a.y+1}];break;case 180:n=[{x:a.x-1,y:a.y},{x:a.x,y:a.y-1}];break;case 270:n=[{x:a.x+1,y:a.y},{x:a.x,y:a.y-1}];break;default:return!1}for(const r of n){const c=i.getBlock(r);if(c){const u=c.type.name.toLowerCase();if(!u.includes("facetplate")&&!u.includes("fin"))return!0}}return!1}function Om(a,e,i){let n;switch(e){case 0:n={x:a.x,y:a.y+1};break;case 90:n={x:a.x-1,y:a.y};break;case 180:n={x:a.x,y:a.y-1};break;case 270:n={x:a.x+1,y:a.y};break;default:return!1}const r=i.getBlock(n);if(!r)return!1;const c=r.type.name.toLowerCase();return!c.includes("facetplate")&&!c.includes("fin")}function K2(a,e,i){return a.name.toLowerCase().includes("fin")?e.x<i.x?0:90:a.name.toLowerCase().includes("facetplate")?Z2(e,i):(a.category==="weapon"||a.category==="engine",0)}function Z2(a,e){const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)>=Math.abs(n)?i>0?90:i<0?270:0:n>0?180:0}function Q2(a,e,i){const n=a.y-e.y;return n>0?30+n*5:n===0?10:-20}function $2(a,e,i){const n=a.y-e.y,r=Math.abs(a.x-e.x);return n<0?25:n===0&&r>0?20:n>0?5:0}function J2(a,e,i){return kl(a,i)*8}function eM(a,e,i){return Math.abs(a.x-e.x)+Math.abs(a.y-e.y)===1?15:5}function tM(a,e,i){const n=a.x<e.x,r=a.x>e.x;let c=10;if(n){const u={x:a.x-1,y:a.y};i.hasBlockAt(u)||(c+=25)}else if(r){const u={x:a.x+1,y:a.y};i.hasBlockAt(u)||(c+=25)}return c}function iM(a,e,i){const n=a.x<e.x,r=a.x>e.x;return n&&i===0||r&&i===90?20:n&&i===90||r&&i===0?-5:0}function sM(a,e,i,n){let r=5;const c=kl(a,i);c===1?r+=50:c===2?r+=25:c===3?r-=15:r-=30;const u=nM(a,e,n);r+=u;const d=[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].filter(m=>{const y={x:a.x+m.x,y:a.y+m.y};return!i.hasBlockAt(y)}).length;return r+=d*15,Math.abs(a.x-e.x)+Math.abs(a.y-e.y)>=2&&(r+=20),r}function nM(a,e,i){const n=a.x-e.x,r=a.y-e.y;let c;return Math.abs(n)>=Math.abs(r)?c=n>0?90:n<0?270:0:c=r>0?180:0,i===c?30:-10}function aM(a,e){return kl(a,e)*5}function kl(a,e){return[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].reduce((n,r)=>{const c={x:a.x+r.x,y:a.y+r.y};return e.hasBlockAt(c)?n+1:n},0)}function oM(a,e,i){const n=rM(a,e,i);return n>3?-10*(n-3):kl(a,i)>=2?10:0}function rM(a,e,i){const n=[{coord:e,distance:0}],r=new Set;r.add(`${e.x},${e.y}`);const c=[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}];for(;n.length>0;){const u=n.shift();if(u.coord.x===a.x&&u.coord.y===a.y)return u.distance;for(const h of c){const d={x:u.coord.x+h.x,y:u.coord.y+h.y},g=`${d.x},${d.y}`;!r.has(g)&&(i.hasBlockAt(d)||d.x===a.x&&d.y===a.y)&&(r.add(g),n.push({coord:d,distance:u.distance+1}))}}return 999}function nh(a,e,i,n,r=0,c){let u=0;const h=Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2)),d=c?.5:1;switch(u+=Math.max(0,50-h*3)*d,a.category){case"engine":u+=Q2(e,i);break;case"weapon":u+=$2(e,i);break;case"hull":u+=J2(e,i,n);break;case"system":case"utility":u+=eM(e,i);break}if(a.name.toLowerCase().includes("fin")&&(u+=tM(e,i,n),u+=iM(e,i,r)),a.name.toLowerCase().includes("facetplate")&&(u+=sM(e,i,n,r)),u+=aM(e,n),u+=oM(e,i,n),c){const g=c.weights||{},m=c.shapeScoreMap(e,i);u+=m*(g.shapeScore??1);const y=Y2(e,i,c.symmetryAxis,n);u+=y*(g.symmetryScore??1);const v=lM(a,e,i,c);u+=v*(g.zoneAffinityScore??1);const M=cM(e,i,n,c);u+=M*(g.structuralGoalScore??1)}return u}function lM(a,e,i,n){const r=n.blockBiases;if(!r)return 0;let c=r[a.name.toLowerCase()];if(!c&&a.category&&(c=r[a.category.toLowerCase()]),c||(a.name.toLowerCase().includes("fin")?c=r.fin:a.name.toLowerCase().includes("facetplate")&&(c=r.facetplate)),!c)return 0;let u=0;return c.preferredZones&&c.preferredZones.length>0&&(xp(e,i,c.preferredZones,n)?u+=c.bonusInZone??20:u-=c.penaltyOutsideZone??10),c.avoidZones&&c.avoidZones.length>0&&xp(e,i,c.avoidZones,n)&&(u-=25),u}function cM(a,e,i,n){if(!n.minimumStructureRules)return 0;let r=0;for(const c of n.minimumStructureRules){const u=n.featureZones[c.zone];if(!u)continue;let h=0;const d=i.getAllBlocks();for(const[g,m]of d)u(g,e)&&h++;if(u(a,e))if(h<c.minCount){const g=c.minCount-h;r+=30+g*10}else c.maxCount&&h>=c.maxCount&&(r-=20)}return r}function uM(a,e,i){const n=a.getCockpitCoord();if(!n)return null;const r=[],c=20;for(let u=-20;u<=c;u++)for(let h=-20;h<=c;h++){const d={x:u,y:h};if(!a.hasBlockAt(d)&&Fh(a,d)&&j2(d,a))if(e.name.toLowerCase().includes("facetplate"))for(const g of[0,90,180,270]){if(!Om(d,g,a))continue;const m=nh(e,d,n,a,g,i);r.push({coord:d,rotation:g,score:m})}else if(e.name.toLowerCase().includes("fin"))for(const g of[0,90,180,270]){if(!Lm(d,g,a))continue;const m=nh(e,d,n,a,g,i);r.push({coord:d,rotation:g,score:m})}else{const g=i?hM(e,d,n,i):K2(e,d,n);if(!q2(e,d,g,a))continue;const m=nh(e,d,n,a,g,i);r.push({coord:d,rotation:g,score:m})}}return r.length>0?r.reduce((u,h)=>h.score>u.score?h:u):null}function hM(a,e,i,n){return a.category==="weapon"||a.category==="engine"||X2(e,i,n),0}function _p(a,e,i,n){if(!e)return!1;const r=uM(a,e,n);if(!r||!a.placeBlockById(r.coord,e.id,r.rotation))return!1;const u=a.getBlock(r.coord);u!=null&&u.position&&i.createRepairEffect(u.position);const h=e.placementSound??"assets/sounds/sfx/ship/gather_00.wav";return Q.play(h,"sfx",{maxSimultaneous:3}),!0}class sl{constructor(e,i=1,n=2){this.blockType=e,this.baseSpinSpeed=i,this.overlaySpinSpeed=n,this.baseAngle=0,this.overlayAngle=0,this.size=z}update(e){this.baseAngle+=this.baseSpinSpeed*e,this.overlayAngle+=this.overlaySpinSpeed*e,this.baseAngle>Math.PI*2&&(this.baseAngle-=Math.PI*2),this.overlayAngle>Math.PI*2&&(this.overlayAngle-=Math.PI*2)}render(e,i,n,r,c,u=1,h=null){const d=h??this.blockType,g=Yi(d.id),m=i+r/2,y=n+c/2;e.save(),e.translate(m,y),e.globalAlpha*=u,e.rotate(this.baseAngle),e.drawImage(g.base,-r/2,-c/2,r,c),e.restore(),g.overlay&&(e.save(),e.translate(m,y),e.globalAlpha*=u,e.rotate(this.overlayAngle),e.drawImage(g.overlay,-r/2,-c/2,r,c),e.restore())}}const fM=new Set(["type","icon","sprite","id","size","canFire","canThrust"]),dM=new Set(["fire.fireType","fire.detonationDelayMs","fire.lifetime","fire.projectileSpeed","haloBladeProperties.color","haloBladeProperties.size","haloBladeProperties.sprite"]);function Dp(a){return dM.has(a)}function gM(a,e,i,n,r,c){if(!e)return n;const u=g=>g.charAt(0).toUpperCase()+g.slice(1),h=g=>g===void 0?"":typeof g=="boolean"?g?"Yes":"No":typeof g=="number"||typeof g=="string"?g:String(g);let d=n;if(d=me(a,i,d,"Armor",h(e.armor),"#09f",r,c),d=me(a,i,d,"Mass",h(e.mass),"#999",r,c),d=me(a,i,d,"Cost",h(e.cost),"#6f6",r,c),e.behavior){for(const[g,m]of Object.entries(e.behavior))if(!fM.has(g))if(m&&typeof m=="object"&&!Array.isArray(m)){let y=!1;for(const[v,M]of Object.entries(m)){const S=`${g}.${v}`;if(Dp(S))continue;y||(d=me(a,i,d,u(g),"","#fc6",r,c),y=!0);const T=` ${u(v)}`;d=me(a,i,d,T,h(M),"#999",r,c)}}else{if(Dp(g))continue;d=me(a,i,d,u(g),h(m),"#fc6",r,c)}}return d}class pM{constructor(e,i,n,r,c){this.ship=e,this.inputManager=i,this.open=!1,this.queue=[],this.currentBlockType=null,this.blockPreviewRenderer=null,this.nextBlockPreviewRenderer=null,this.isAutoPlacingAll=!1,this.animationPhase=null,this.slideX=-800,this.targetX=0,this.isAnimating=!1,this.originalZoom=0,this.hoveredButton=null,this.clickedButton=null,this.didAdvance=!1,this.SLIDE_SPEED=1280,this.SETTLE_SPEED=320,this.OVERSHOOT_DISTANCE=40,this.preOpenTimer=0,this.PRE_OPEN_DURATION=300,this.LABEL_FONT_SIZE=14,this.BASE_WINDOW_X=20,this.BASE_WINDOW_Y=20,this.BASE_WINDOW_WIDTH=330,this.BASE_WINDOW_HEIGHT=500,this.BASE_BUTTON_WIDTH=120,this.BASE_BUTTON_HEIGHT=40,this.BASE_BUTTON_VERTICAL_GAP=10,this.BASE_BLOCK_PREVIEW_HEIGHT=82,this.BASE_BLOCK_PREVIEW_WIDTH=82,this.BASE_BLOCK_SPIN_SPEED=1,this.BASE_MINI_PREVIEW_HEIGHT=32,this.BASE_MINI_PREVIEW_WIDTH=32,this.refineButton={},this.autoplaceButton={},this.randomRollButton={},this.autoPlaceAllButton={},this.shipBuilderEffects=n,this.pause=r,this.resume=c,this.initialize()}initialize(){const e=ae(),i=32*e,n=this.BASE_BUTTON_WIDTH*2+i,r=this.BASE_WINDOW_X+(this.BASE_WINDOW_WIDTH-n)/2,c=this.BASE_WINDOW_Y+this.BASE_WINDOW_HEIGHT-(this.BASE_BUTTON_HEIGHT+32)*e;this.refineButton={x:r+this.slideX*e,y:c,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Refine",onClick:()=>this.handleRefine(),style:{borderRadius:8,alpha:.9,borderColor:"#ffcc00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#332800"},{offset:1,color:"#1f1800"}]},textColor:"#ffffaa"}},this.randomRollButton={x:r+this.slideX*e,y:c-this.BASE_BUTTON_VERTICAL_GAP*e,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Reroll",onClick:()=>this.handleRoll(),style:{borderRadius:8,alpha:.95,borderColor:"#cc66ff",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#330033"},{offset:1,color:"#1a0022"}]},textColor:"#ffccff"}},this.autoplaceButton={x:r+this.BASE_BUTTON_WIDTH+i+this.slideX*e,y:c,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Attach",onClick:()=>this.handleAutoplace(),style:{borderRadius:8,alpha:.95,borderColor:"#00ccff",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#003344"},{offset:1,color:"#001a22"}]},textColor:"#aaffff"}},this.autoPlaceAllButton={x:r+this.BASE_BUTTON_WIDTH+i+this.slideX*e,y:c-this.BASE_BUTTON_VERTICAL_GAP*e,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Attach All",onClick:()=>this.autoPlaceAll(),style:{borderRadius:8,alpha:.95,borderColor:"#66ff66",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#003300"},{offset:1,color:"#001a00"}]},textColor:"#ccffcc"}}}openMenu(){if(!this.queue.length){Q.play("assets/sounds/sfx/ui/error_00.wav","sfx");return}this.open||this.animationPhase!==null||(Q.play("assets/sounds/sfx/ui/activate_01.wav","sfx"),this.slideX=-this.BASE_WINDOW_WIDTH-320,this.animationPhase="pre-open",this.preOpenTimer=this.PRE_OPEN_DURATION,this.open=!0,H2("blockDropDecisionMenu"))}enqueueBlock(e){this.queue.push({blockType:e}),Be.getInstance().enqueueBlock(e),this.updateNextBlockPreview()}updateNextBlockPreview(){var i;const e=this.queue.length>0?(i=this.queue[0])==null?void 0:i.blockType:null;this.nextBlockPreviewRenderer=e?new sl(e,0,0):null}update(e){var d,g;if(!this.open)return;const i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked(),r=ae();if((d=this.blockPreviewRenderer)==null||d.update(e),(g=this.nextBlockPreviewRenderer)==null||g.update(e),this.animationPhase==="pre-open"){this.preOpenTimer-=e*1e3,this.preOpenTimer<=0&&this.beginSlideIn();return}if(this.isAnimating){if(this.animationPhase==="sliding-in")this.pause(),yt.getInstance().animateZoomTo(this.getMenuTargetZoom()),this.slideX+=this.SLIDE_SPEED*e,this.slideX>=this.targetX+this.OVERSHOOT_DISTANCE&&(this.animationPhase="settling",this.slideX=this.targetX+this.OVERSHOOT_DISTANCE);else if(this.animationPhase==="settling")this.slideX-=this.SETTLE_SPEED*e,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.animationPhase="open",this.isAnimating=!1);else if(this.animationPhase==="sliding-out"&&(this.slideX-=this.SLIDE_SPEED*e,this.slideX<=-this.BASE_WINDOW_WIDTH-200)){const P=this.ship.getTotalMass();Ce.incrementMassAchieved(P),this.slideX=-this.BASE_WINDOW_WIDTH-320,this.animationPhase=null,this.isAnimating=!1,this.open=!1,this.currentBlockType=null,this.blockPreviewRenderer=null,this.nextBlockPreviewRenderer=null,this.hoveredButton=null,this.clickedButton=null,this.didAdvance=!1,this.resume()}const m=this.slideX*r,y=this.BASE_WINDOW_X*r,v=this.BASE_WINDOW_Y*r,M=this.BASE_WINDOW_WIDTH*r,S=this.BASE_WINDOW_HEIGHT*r,T=this.BASE_BUTTON_WIDTH*r,w=this.BASE_BUTTON_HEIGHT*r,A=32*r,R=T*2+A,I=y+m+(M-R)/2,x=v+S-(w+32);this.refineButton.x=I,this.refineButton.y=x,this.autoplaceButton.x=I+T+A,this.autoplaceButton.y=x,this.autoPlaceAllButton.x=I+T+A,this.autoPlaceAllButton.y=x-w-this.BASE_BUTTON_VERTICAL_GAP*r,this.randomRollButton.x=I,this.randomRollButton.y=x-w-this.BASE_BUTTON_VERTICAL_GAP*r;return}if(!i)return;const{x:c,y:u}=i;if(this.isAutoPlacingAll)return;this.hoveredButton=null,this.clickedButton=null,this.didAdvance=!1;const h=[[this.refineButton,"refine",()=>{this.clickedButton="refine"}],[this.autoplaceButton,"autoplace",()=>{this.clickedButton="autoplace"}],[this.randomRollButton,"roll",()=>{this.clickedButton="roll"}],[this.autoPlaceAllButton,"autoPlaceAll",()=>{this.clickedButton="autoPlaceAll"}]];for(const[m,y,v]of h){const M=As(m,c,u,n,r);m.isHovered&&(this.hoveredButton=y),M&&v()}this.inputManager.wasActionJustPressed("cancel")&&(this.refineButton.onClick(),this.clickedButton="refine"),this.inputManager.wasActionJustPressed("select")&&(this.autoplaceButton.onClick(),this.clickedButton="autoplace")}beginSlideIn(){var i;this.initialize(),this.open=!0,this.targetX=0,this.isAnimating=!0,this.animationPhase="sliding-in";const e=yt.getInstance();this.originalZoom=e.getZoom(),this.currentBlockType=((i=this.queue.shift())==null?void 0:i.blockType)??null,this.blockPreviewRenderer=this.currentBlockType?new sl(this.currentBlockType):null,this.updateNextBlockPreview()}disableButton(e){e.disabled=!0}restoreButtons(){this.isAutoPlacingAll=!1,this.refineButton.disabled=!1,this.autoplaceButton.disabled=!1,this.randomRollButton.disabled=!1,this.autoPlaceAllButton.disabled=!1,this.refineButton.onClick=()=>this.handleRefine(),this.autoplaceButton.onClick=()=>this.handleAutoplace(),this.randomRollButton.onClick=()=>this.handleRoll(),this.autoPlaceAllButton.onClick=()=>this.autoPlaceAll()}handleRefine(){var e;Be.getInstance().addCurrency(((e=this.currentBlockType)==null?void 0:e.cost)??0),Be.getInstance().dequeueBlock(),Q.play("assets/sounds/sfx/ui/coin_00.wav","sfx",{maxSimultaneous:4}),Ce.incrementBlockRefinedCount(),this.advanceQueueOrClose(),this.clickedButton="refine"}handleAutoplace(){if(!this.currentBlockType)return;const e=Ip("interceptor");if(!_p(this.ship,this.currentBlockType,this.shipBuilderEffects,e??void 0)){Q.play("assets/sounds/sfx/ui/error_00.wav","sfx");return}Be.getInstance().dequeueBlock(),Ce.incrementBlockPlacedCount(),this.advanceQueueOrClose(),this.clickedButton="autoplace"}async autoPlaceAll(){if(this.isAutoPlacingAll)return;this.isAutoPlacingAll=!0,this.refineButton.onClick=()=>{},this.autoplaceButton.onClick=()=>{},this.randomRollButton.onClick=()=>{},this.autoPlaceAllButton.onClick=()=>{},this.disableButton(this.refineButton),this.disableButton(this.autoplaceButton),this.disableButton(this.randomRollButton),this.disableButton(this.autoPlaceAllButton);const e=Ip("interceptor"),i=300,n=50,r=.85;let c=i;for(;this.currentBlockType&&this.queue.length>=0;){if(!_p(this.ship,this.currentBlockType,this.shipBuilderEffects,e??void 0)){Q.play("assets/sounds/sfx/ui/error_00.wav","sfx"),this.restoreButtons();return}if(Be.getInstance().dequeueBlock(),Ce.incrementBlockPlacedCount(),this.advanceQueueOrClose(),!this.currentBlockType)break;await new Promise(h=>setTimeout(h,c)),c=Math.max(c*r,n)}this.currentBlockType&&this.restoreButtons(),this.clickedButton="autoPlaceAll"}handleRoll(){if(this.queue.length+1<3||!this.currentBlockType){Q.play("assets/sounds/sfx/ui/error_00.wav","sfx");return}const e=[this.currentBlockType,...this.queue.slice(0,2).map(m=>m.blockType)],i=Math.floor(e.reduce((m,y)=>m+Ug(y),0)/e.length);let n=i;const r=Math.random();r<.02?n=Math.min(i+2,4):r<.15&&(n=Math.min(i+1,4));const c=n-i,u=Bb(n);if(!u.length){console.warn(`[handleRoll] No blocks found for tier ${n}`);return}const h=u[Math.floor(Math.random()*u.length)];Be.getInstance().dequeueBlock();for(let m=0;m<2;m++)this.queue.length>0&&(this.queue.shift(),Be.getInstance().dequeueBlock());this.queue.unshift({blockType:h}),Be.getInstance().enqueueBlockToFront(h);const d={0:"assets/sounds/sfx/ui/gamblewin_00.wav",1:"assets/sounds/sfx/ui/gamblewin_01.wav",2:"assets/sounds/sfx/ui/gamblewin_02.wav"},g=d[c]??d[0];Q.play(g,"sfx",{maxSimultaneous:5}),this.advanceQueueOrClose(),this.clickedButton="roll"}advanceQueueOrClose(){var e;this.currentBlockType=((e=this.queue.shift())==null?void 0:e.blockType)??null,this.blockPreviewRenderer=this.currentBlockType?new sl(this.currentBlockType,this.BASE_BLOCK_SPIN_SPEED,this.BASE_BLOCK_SPIN_SPEED*2):null,this.updateNextBlockPreview(),this.currentBlockType?this.didAdvance=!0:(this.isAnimating=!0,this.animationPhase="sliding-out",yt.getInstance().animateZoomTo(this.originalZoom),this.isAutoPlacingAll=!1,Bp("blockDropDecisionMenu"))}render(e){var T;if(this.animationPhase===null&&!this.open)return;const i=ae(),n=this.slideX*i,r=this.BASE_WINDOW_X*i,c=this.BASE_WINDOW_Y*i,u=this.BASE_WINDOW_WIDTH*i,h=this.BASE_WINDOW_HEIGHT*i,d=this.BASE_BLOCK_PREVIEW_HEIGHT*i,g=this.BASE_BLOCK_PREVIEW_WIDTH*i,m=Math.floor(this.LABEL_FONT_SIZE*i),y=this.BASE_MINI_PREVIEW_HEIGHT*i,v=this.BASE_MINI_PREVIEW_WIDTH*i;Mt({ctx:e,x:r+n,y:c,width:u,height:h,options:{borderRadius:12,alpha:.6,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const M=this.currentBlockType?Ug(this.currentBlockType):1,S=Pm[M]??"#ffffff";if(Ve(e,r+n+u/2,c+42*i,((T=this.currentBlockType)==null?void 0:T.name)??"",{font:`${m}px monospace`,align:"center",color:Vi(S,.5)}),this.blockPreviewRenderer){const w=r+n+u/2-g/2,A=c+128*i;this.blockPreviewRenderer.render(e,w,A,g,d)}if(this.queue.length>0&&Ve(e,r+n+16*i,c+16*i,`+${this.queue.length} more`,{font:`${m}px monospace`,align:"left",glow:!1}),this.queue.length>0&&this.nextBlockPreviewRenderer){const w="Next:",A=r+n+u-16*i-v-8*i,R=c+16*i;Ve(e,A,R,w,{font:`${m}px monospace`,align:"right",glow:!1});const I=r+n+u-16*i-v,x=c+8*i;this.nextBlockPreviewRenderer.render(e,I,x,v,y)}if(this.currentBlockType){const w=r+n+32*i,A=c+128*i+d+32*i,R=u-64*i;gM(e,this.currentBlockType,w,A,R,i)}(this.animationPhase==="open"||this.currentBlockType)&&(lt(e,this.refineButton,i),lt(e,this.autoplaceButton,i),lt(e,this.randomRollButton,i),lt(e,this.autoPlaceAllButton,i))}getCurrentBlockType(){return this.currentBlockType}isOpen(){return this.open}closeMenu(){this.open=!1,this.queue.length=0,this.currentBlockType=null,this.nextBlockPreviewRenderer=null,Bp("blockDropDecisionMenu")}isBlocking(){return this.open}isPointInBounds(e,i){const n=ae(),r=this.BASE_WINDOW_X+this.slideX*n,c=r+this.BASE_WINDOW_WIDTH*n,u=this.BASE_WINDOW_Y+this.BASE_WINDOW_HEIGHT*n;return e>=r&&e<=c&&i>=this.BASE_WINDOW_Y&&i<=u}hasBlocksInQueue(){return this.queue.length>0}getMenuTargetZoom(){return .5*ae()}getHoveredButton(){return this.hoveredButton}getClickedButton(){return this.clickedButton}didAdvanceQueue(){return this.didAdvance}destroy(){this.pause=()=>{},this.resume=()=>{},this.nextBlockPreviewRenderer=null}}class mM{constructor(e,i,n,r,c){this.ship=e,this.menu=i,this.camera=n,this.shipBuilderEffects=r,this.inputManager=c,this.rotation=0,this.lastBlockId=null,this.hoveredShipCoord=null}update(e){var u,h;this.inputManager.wasKeyJustPressed("Space")&&(this.rotation=(this.rotation+90)%360);const i=this.inputManager.getMousePosition();if(this.isCursorOverMenu(i))return;const n=fa(i,this.camera,e.position,e.rotation);this.hoveredShipCoord=n;const r=this.menu.getCurrentBlockType(),c=(r==null?void 0:r.id)??null;if(!(!c||!r)){if(this.inputManager.wasRightClicked()&&this.hoveredShipCoord){const d=this.ship.getBlock(this.hoveredShipCoord);if(!d)return;if(!d.type.id.startsWith("cockpit")){if(!this.ship.isDeletionSafe(this.hoveredShipCoord)){Q.play("assets/sounds/sfx/ui/error_00.wav","sfx",{maxSimultaneous:3});return}const m=((u=ni(d.type.id))==null?void 0:u.cost)??0,y=Math.round(m/2);this.shipBuilderEffects.createSellEffect(d.position),this.ship.removeBlock(this.hoveredShipCoord),Q.play("assets/sounds/sfx/ui/click_00.wav","sfx",{maxSimultaneous:3}),Be.getInstance().addCurrency(y)}}if(c!==this.lastBlockId&&(this.rotation=0,this.lastBlockId=c),this.inputManager.wasMouseClicked()&&!this.ship.hasBlockAt(n)&&Fh(this.ship,n)){this.ship.placeBlockById(n,c,this.rotation);const d=this.ship.getBlock(n);d!=null&&d.position&&this.shipBuilderEffects.createRepairEffect(d.position);const g=((h=ni(c))==null?void 0:h.placementSound)??"assets/sounds/sfx/ship/gather_00.wav";Q.play(g,"sfx",{maxSimultaneous:3}),Ce.incrementBlockPlacedCount(),Be.getInstance().dequeueBlock(),this.menu.advanceQueueOrClose()}}}render(e,i){const n=this.inputManager.getMousePosition();if(this.isCursorOverMenu(n))return;const r=fa(n,this.camera,i.position,i.rotation),c=r.x*z,u=r.y*z,h=Math.cos(i.rotation),d=Math.sin(i.rotation),g=c*h-u*d,m=c*d+u*h,y=i.position.x+g,v=i.position.y+m,M=this.camera.worldToScreen(y,v);e.save(),e.translate(M.x,M.y),e.scale(this.camera.getZoom(),this.camera.getZoom()),e.rotate(i.rotation);const S=this.menu.getCurrentBlockType(),T=(S==null?void 0:S.id)??null;if(!T){e.restore();return}if(this.ship.getBlock(r)){const A=this.ship.isDeletionSafe(r);Oh(e,A)}else{const A=Yi(T);e.save(),e.rotate(this.rotation*Math.PI/180),e.globalAlpha=.6,e.drawImage(A.base,-32/2,-32/2,z,z),e.restore()}e.restore()}isCursorOverMenu(e){return this.menu.isPointInBounds(e.x,e.y)}getHoveredShipBlock(){return this.hoveredShipCoord?this.ship.getBlock(this.hoveredShipCoord):void 0}}const yM={boxColor:"#222",checkColor:"#0f0",hoverColor:"#444",labelColor:"#ccc",borderColor:"#0f0",font:"12px monospace"};function ah(a,e,i=1){const{x:n,y:r,size:c,label:u,checked:h,isHovered:d,style:g={}}=e,{boxColor:m,checkColor:y,hoverColor:v,labelColor:M,borderColor:S,font:T}={...yM,...g},w=c*i,A=T.replace(/(\d+)(px)/,(R,I,x)=>`${Math.round(parseInt(I)*i)}${x}`);a.fillStyle=d?v:m,a.fillRect(n,r,w,w),a.strokeStyle=S,a.lineWidth=1*i,a.strokeRect(n,r,w,w),h&&(a.strokeStyle=y,a.lineWidth=2*i,a.beginPath(),a.moveTo(n+3*i,r+w/2),a.lineTo(n+w/2,r+w-3*i),a.lineTo(n+w-3*i,r+3*i),a.stroke()),u&&(a.font=A,a.fillStyle=M,a.textAlign="left",a.textBaseline="middle",a.fillText(u,n+w+8*i,r+w/2))}function tn(a,e,i,n){const r=i.x,c=i.y,u=i.width*n,h=i.height*n;return a>=r&&a<=r+u&&e>=c&&e<=c+h}function vM(a,e,i){const{x:n,y:r,width:c,height:u,isOpen:h,items:d}=a,g={x:n,y:r,width:c,height:u},m=tn(e.x,e.y,g,i);if(!h)return{isHovered:m};const y=u*i;for(let v=0;v<d.length;v++){const M=r+u*i+v*y,S={x:n,y:M,width:c,height:u};if(tn(e.x,e.y,S,i))return{isHovered:m,hoverIndex:v}}return{isHovered:m}}const bM={barColor:"#0f0",knobColor:"#6f6",backgroundColor:"#111",borderColor:"#0f0",labelColor:"#ccc"};function SM(a,e,i=1,n,r=!0){const{x:c,y:u,width:h,height:d,value:g,style:m={},isHovered:y}=e,{barColor:v,knobColor:M,backgroundColor:S,borderColor:T,labelColor:w}={...bM,...m},A=h*i,R=d*i,I=`${Math.round(12*i)}px monospace`,x=u+R/2;a.fillStyle=S,a.fillRect(c,u,A,R);const P=Math.round(g*A);a.fillStyle=v,a.fillRect(c,u,P,R);const N=c+P,W=R/2;a.beginPath(),a.arc(N,x,W,0,Math.PI*2),a.fillStyle=y?"#fff":M,a.fill(),a.strokeStyle=T,a.lineWidth=1*i,a.strokeRect(c,u,A,R);let H=c+A;if(a.font=I,a.fillStyle=w,a.textAlign="left",a.textBaseline="middle",r){const q=8*i;H+=q;const ie=`${Math.round(g*100)}%`;a.fillText(ie,H,x);const $=a.measureText(ie);H+=$.width}if(n){const q=12*i;H+=q,a.fillText(n,H,x)}}function MM(a,e,i=1,n){const{x:r,y:c,width:u,height:h,items:d,selectedIndex:g,isOpen:m,hoverIndex:y,isHovered:v,style:M={}}=e,{backgroundColor:S="#001100",borderColor:T="#00ff41",textColor:w="#00ff41",font:A='13px "Courier New", monospace',glow:R=!0,chromaticAberration:I=!0,alpha:x=1}=M,P=u*i,N=h*i,W=A.replace(/(\d+)(px)/,(Z,te,_)=>`${Math.round(parseInt(te)*i)}${_}`),H=.5*i,q=v?Vi(T,.8):T,ie=v?Vi(w,.8):w;a.save(),a.globalAlpha=x,a.fillStyle=S,a.fillRect(r,c,P,N),R&&(a.shadowColor=q,a.shadowBlur=8*i),a.strokeStyle=q,a.lineWidth=2*i,a.strokeRect(r,c,P,N),a.restore();const $=r+6*i,K=c+N/2,ne=d[g];if(a.save(),a.font=W,a.textAlign="left",a.textBaseline="middle",R&&(a.shadowColor=ie,a.shadowBlur=4*i),I&&(a.save(),a.globalAlpha=.25,a.shadowBlur=0,a.fillStyle="#ff0000",a.fillText(ne.label,$-H,K),a.fillStyle="#0000ff",a.fillText(ne.label,$+H,K),a.restore()),a.globalAlpha=1,a.fillStyle=ie,a.fillText(ne.label,$,K),a.restore(),Ve(a,r+P+12,c+N/2,n,{font:W,color:"#ccc",align:"left"}),m){const Z=N;d.forEach((te,_)=>{const X=c+N+_*Z,se=y===_,oe=se?Vi(S,.2):S,k=se?Vi(w,.8):w;a.save(),a.globalAlpha=x,a.fillStyle=oe,a.fillRect(r,X,P,Z),R&&(a.shadowColor=T,a.shadowBlur=6*i),a.strokeStyle=T,a.lineWidth=1*i,a.strokeRect(r,X,P,Z),a.font=W,a.textAlign="left",a.textBaseline="middle";const G=X+Z/2;I&&(a.save(),a.globalAlpha=.25,a.shadowBlur=0,a.fillStyle="#ff0000",a.fillText(te.label,$-H,G),a.fillStyle="#0000ff",a.fillText(te.label,$+H,G),a.restore()),a.globalAlpha=1,a.fillStyle=k,a.fillText(te.label,$,G),a.restore()})}}const TM=[{kind:"master"},{kind:"channel",channel:"music"},{kind:"channel",channel:"sfx"},{kind:"channel",channel:"dialogue"}],CM={master:()=>Ae.getInstance().getMasterVolume(),music:()=>Ae.getInstance().getMusicVolume(),sfx:()=>Ae.getInstance().getSfxVolume(),dialogue:()=>Ae.getInstance().getDialogueVolume()},wM={master:a=>Ae.getInstance().setMasterVolume(a),music:a=>Ae.getInstance().setMusicVolume(a),sfx:a=>Ae.getInstance().setSfxVolume(a),dialogue:a=>Ae.getInstance().setDialogueVolume(a)};class AM{constructor(e,i,n,r){this.activeTab="display",this.open=!1,this.volumeLabels=["Master Volume","Music Volume","Sound Effects","Dialogue Volume"],this.closeButton=null,this.volumeSliders=[],this.particleCheckbox=null,this.lightingCheckbox=null,this.collisionsCheckbox=null,this.resolutionDropdown=null,this.windowX=120,this.windowY=80,this.windowHeight=460,this.windowWidth=440,this.headerStartY=20,this.headerStartX=80,this.headerHeight=40,this.headerItemWidth=80,this.headerHorizontalPadding=12,this.headerVerticalPadding=6,this.buttonWidth=120,this.buttonHeight=40,this.sliderWidth=120,this.sliderHeight=12,this.dropdownWidth=120,this.dropdownHeight=28,this.checkboxSize=14,this.itemVerticalSpacing=40,this.margin=20,this.inputManager=e,this.menuManager=i,this.canvasManager=n,this.camera=r,this.initialize()}initialize(){const e=Ae.getInstance(),i=ae(),n=this.margin*i,r=this.headerHeight*i,c=this.itemVerticalSpacing*i,u=this.windowHeight*i,h=this.windowWidth*i,d=this.buttonWidth*i,g=this.buttonHeight*i,m=160,y=this.windowY+n+r;this.closeButton={x:this.windowX+h-d-n,y:this.windowY+u-g-n,width:this.buttonWidth,height:this.buttonHeight,label:"Close",onClick:()=>{const S=this.menuManager.getMenu("pauseMenu");S&&this.menuManager.transition(S)},style:{borderRadius:10,alpha:.8,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}},this.volumeSliders=TM.map((S,T)=>{const w=S.kind==="master"?"master":S.channel;return{x:m,y:y+T*c,width:this.sliderWidth,height:this.sliderHeight,value:CM[w](),onChange:A=>{wM[w](A),rt.getInstance().saveSettings()}}}),this.particleCheckbox={x:m,y,size:this.checkboxSize,label:"Particles Enabled",checked:e.isParticlesEnabled(),onToggle:S=>{this.particleCheckbox.checked=S,e.setParticlesEnabled(S),rt.getInstance().saveSettings()}},this.lightingCheckbox={x:m,y:y+c,size:this.checkboxSize,label:"Lighting Enabled",checked:e.isLightingEnabled(),onToggle:S=>{this.lightingCheckbox.checked=S,e.setLightingEnabled(S),rt.getInstance().saveSettings()}},this.collisionsCheckbox={x:m,y:y+c*2,size:this.checkboxSize,label:"Collisions Enabled",checked:e.isCollisionsEnabled(),onToggle:S=>{this.collisionsCheckbox.checked=S,e.setCollisionsEnabled(S),rt.getInstance().saveSettings()}};const v=`${e.getViewportWidth()}x${e.getViewportHeight()}`,M=[{label:"1920x1080",value:"1920x1080"},{label:"1920x1200",value:"1920x1200"},{label:"2560x1440",value:"2560x1440"},{label:"3840x2160",value:"3840x2160"}];this.resolutionDropdown={x:m,y:y+c*3,width:this.dropdownWidth,height:this.dropdownHeight,items:M,selectedIndex:M.findIndex(S=>S.value===v)||0,isOpen:!1,onSelect:S=>{const[T,w]=S.value.split("x");e.setViewportWidth(parseInt(T,10)),e.setViewportHeight(parseInt(w,10)),gl(this.canvasManager,this.camera),rt.getInstance().saveSettings(),this.initialize()},style:{backgroundColor:"#001100",borderColor:"#00ff41",textColor:"#00ff41",glow:!0,chromaticAberration:!0,alpha:1}}}update(){var g,m,y,v,M;const e=this.inputManager.getMousePosition(),i=(m=(g=this.inputManager).wasLeftClicked)==null?void 0:m.call(g),n=(v=(y=this.inputManager).isMouseLeftPressed)==null?void 0:v.call(y),r=ae(),c=this.headerItemWidth*r,u=this.headerHorizontalPadding*r;if(i){const S=this.headerStartX+this.windowX,T=this.headerStartY+this.windowY,w=[{tab:"display",label:"General"},{tab:"volume",label:"Volume"},{tab:"controls",label:"Controls"},{tab:"keybinds",label:"Keybinds"}];for(let A=0;A<w.length;A++){const R=S+A*(c+u);if(tn(e.x,e.y,{x:R,y:T+this.headerVerticalPadding*r,width:this.headerItemWidth,height:this.headerHeight},r)){this.activeTab=w[A].tab;break}}}if(this.activeTab==="display")for(const S of[this.particleCheckbox,this.lightingCheckbox,this.collisionsCheckbox]){if(!S)continue;const T={x:S.x,y:S.y,width:S.size,height:S.size};S.isHovered=tn(e.x,e.y,T,r),i&&S.isHovered&&S.onToggle(!S.checked)}if(this.activeTab==="volume")for(const S of this.volumeSliders){const T={x:S.x,y:S.y,width:S.width,height:S.height};if(S.isHovered=tn(e.x,e.y,T,r),n&&S.isHovered){const w=e.x-S.x,A=Math.min(1,Math.max(0,w/(S.width*r)));S.value=A,S.onChange(A),S.isDragging=!0}else n||(S.isDragging=!1)}const h=this.resolutionDropdown;if(h){const{isHovered:S,hoverIndex:T}=vM(h,e,r);h.isHovered=S,h.hoverIndex=T,i&&S&&T===void 0&&(h.isOpen=!h.isOpen),h.isOpen&&typeof T=="number"&&i&&(h.selectedIndex=T,h.isOpen=!1,(M=h.onSelect)==null||M.call(h,h.items[T]))}const d=this.closeButton;if(d){const S={x:d.x,y:d.y,width:d.width,height:d.height};d.isHovered=tn(e.x,e.y,S,r),i&&d.isHovered&&d.onClick()}}render(e){const i=ae(),n=this.headerItemWidth*i,r=this.headerHorizontalPadding*i;if(Mt({ctx:e,x:this.windowX,y:this.windowY,width:this.windowWidth,height:this.windowHeight,uiScale:i,options:{alpha:.6,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),[{tab:"display",label:"General"},{tab:"volume",label:"Volume"},{tab:"controls",label:"Controls"},{tab:"keybinds",label:"Keybinds"}].forEach((u,h)=>{Ve(e,this.headerStartX+this.windowX+h*(n+r),this.headerStartY+this.windowY+this.headerVerticalPadding*i,u.label,{font:"16px monospace",align:"left",color:this.activeTab===u.tab?"#6f6":"#888"},i)}),this.activeTab==="display")ah(e,this.particleCheckbox,i),ah(e,this.lightingCheckbox,i),ah(e,this.collisionsCheckbox,i),MM(e,this.resolutionDropdown,i,"Resolution");else if(this.activeTab==="volume")for(let u=0;u<this.volumeSliders.length;u++){const h=this.volumeSliders[u],d=this.volumeLabels[u];SM(e,h,i,d)}else this.activeTab==="controls"?Ve(e,this.windowX+this.margin*i,this.windowY+100*i,"Controls tab coming soon...",{font:"14px monospace",align:"left",color:"#ccc"},i):this.activeTab==="keybinds"&&Ve(e,this.windowX+this.margin*i,this.windowY+100*i,"Keybinds tab coming soon...",{font:"14px monospace",align:"left",color:"#ccc"},i);lt(e,this.closeButton,i)}isOpen(){return this.open}openMenu(){this.open=!0}closeMenu(){this.open=!1}isBlocking(){return!0}}function So(a,e){pe.emit("postprocess:effect:add",{effect:a,params:e})}function kM(a){pe.emit("postprocess:effect:remove",{effect:a})}function oh(){pe.emit("postprocess:effect:clear",void 0)}function EM(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:1.9,contrast:1,saturation:1.15,temperature:.25,tint:-.05,vignetteStrength:.25,filmGrainStrength:.08,shadowsLift:-.01,highlightsGain:.4,cinematicIntensity:.002}}]})}function RM(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:.95,contrast:1,saturation:.9,temperature:-.2,tint:.1,vignetteStrength:.4,filmGrainStrength:.12,shadowsLift:-.05,highlightsGain:1.1,cinematicIntensity:.8}}]})}function BM(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:.5,contrast:1,saturation:1.2,temperature:.25,tint:-.1,vignetteStrength:.5,filmGrainStrength:.2,shadowsLift:.1,highlightsGain:.9,cinematicIntensity:.7}}]})}function IM(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:1.02,contrast:1.08,saturation:1.03,temperature:.05,tint:0,vignetteStrength:.15,filmGrainStrength:.04,shadowsLift:.01,highlightsGain:1.01,cinematicIntensity:.5}}]})}class xM{constructor(e,i,n){this.inputManager=e,this.onAbandon=i,this.menuManager=n,this.open=!1,this.windowX=120,this.windowY=100,this.windowWidth=220,this.windowHeight=240,this.buttonWidth=140,this.buttonHeight=40,this.sharedStyle={borderRadius:10,alpha:.9,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}},this.disabledStyle={borderRadius:10,alpha:.5,borderColor:"#445544",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#111911"},{offset:1,color:"#0a120a"}]}},this.settingsButton={},this.abandonButton={},this.resumeButton={},this.initialize()}initialize(){const e=ae(),i=this.buttonHeight*e,n=i*.5,r=this.windowWidth*e,c=this.windowHeight*e,u=.2*r+this.windowX,h=.2*c+this.windowY;this.settingsButton={x:u,y:h,width:this.buttonWidth,height:this.buttonHeight,label:"Settings",onClick:()=>{const d=this.menuManager.getMenu("settingsMenu");d&&this.menuManager.transition(d)},style:this.sharedStyle},this.abandonButton={x:u,y:h+n*1+i*1,width:this.buttonWidth,height:this.buttonHeight,label:"Abandon Mission",onClick:Re.has("mission.intro-briefing.complete")?this.onAbandon:()=>{},style:Re.has("mission.intro-briefing.complete")?this.sharedStyle:this.disabledStyle},this.resumeButton={x:u,y:h+n*2+i*2,width:this.buttonWidth,height:this.buttonHeight,label:"Resume",onClick:()=>{this.menuManager.close(this),this.menuManager.resume()},style:this.sharedStyle}}update(){const e=ae(),i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked();if(!i)return;const{x:r,y:c}=i,u=[this.settingsButton,this.abandonButton,this.resumeButton];for(const h of u){const d={x:h.x,y:h.y,width:h.width,height:h.height};h.isHovered=tn(r,c,d,e)}n&&(this.settingsButton.isHovered?this.settingsButton.onClick():this.abandonButton.isHovered?this.abandonButton.onClick():this.resumeButton.isHovered&&this.resumeButton.onClick())}render(e){const i=ae();Mt({ctx:e,x:this.windowX,y:this.windowY,width:this.windowWidth,height:this.windowHeight,uiScale:i,options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),Ve(e,this.windowX+this.windowWidth*i/2,this.windowY+10*i,"Game Paused",{font:"16px monospace",align:"center",glow:!0},i),lt(e,this.settingsButton,i),lt(e,this.abandonButton,i),lt(e,this.resumeButton,i)}isOpen(){return this.open}openMenu(){this.initialize(),this.open=!0,So("blackwhite")}closeMenu(){this.open=!1,kM("blackwhite")}isBlocking(){return!0}}const yh={barColor:"#00ff41",backgroundColor:"#0a0a0a",borderColor:"#00ff41",textColor:"#00ff41",glow:!0,font:'11px "Courier New", monospace',scanlineIntensity:.3,chromaticAberration:!0,phosphorDecay:!0,cornerBevel:!0,warningThreshold:.3,criticalThreshold:.15,warningColor:"#ffaa00",criticalColor:"#ff0040",animated:!0};class sa{constructor(){this.cache=new Map,this.maxCacheSize=50,this.maxAge=3e4}static getInstance(){return sa.instance||(sa.instance=new sa),sa.instance}generateCacheKey(e,i){const{width:n,height:r,style:c={}}=e,u={...yh,...c},h=Math.max(0,Math.min(1,e.value));let d=u.borderColor;switch(h<=u.criticalThreshold?d=u.criticalColor:h<=u.warningThreshold&&(d=u.warningColor),i){case"background":return`bg_${n}_${r}_${u.backgroundColor}_${u.cornerBevel}`;case"border":return`border_${n}_${r}_${d}_${u.cornerBevel}`;case"scanlines":return`scan_${n}_${r}_${u.scanlineIntensity}`;default:return""}}getOrCreate(e,i){const n=this.generateCacheKey(e,i),r=this.cache.get(n);if(r&&Date.now()-r.timestamp<this.maxAge)return r;this.cleanup();const c=document.createElement("canvas");c.width=e.width+20,c.height=e.height+20;const u=c.getContext("2d"),h={canvas:c,ctx:u,cacheKey:n,timestamp:Date.now()};return this.renderStaticElement(e,i,u),this.cache.set(n,h),h}renderStaticElement(e,i,n){const{width:r,height:c,style:u={}}=e,h={...yh,...u},d=10,g=10;switch(i){case"background":this.renderBackground(n,d,g,r,c,h);break;case"border":const m=Math.max(0,Math.min(1,e.value));let y=h.borderColor;m<=h.criticalThreshold?y=h.criticalColor:m<=h.warningThreshold&&(y=h.warningColor),this.renderBorder(n,d,g,r,c,{...h,borderColor:y});break;case"scanlines":this.renderScanlines(n,d,g,r,c,h);break}}renderBackground(e,i,n,r,c,u){if(e.save(),u.cornerBevel){const d=Math.min(3,c*.2);e.beginPath(),e.moveTo(i+d,n),e.lineTo(i+r-d,n),e.lineTo(i+r,n+d),e.lineTo(i+r,n+c-d),e.lineTo(i+r-d,n+c),e.lineTo(i+d,n+c),e.lineTo(i,n+c-d),e.lineTo(i,n+d),e.closePath(),e.clip()}const h=e.createLinearGradient(i,n,i,n+c);h.addColorStop(0,ei(u.backgroundColor,"ff")),h.addColorStop(.5,ei(u.backgroundColor,"cc")),h.addColorStop(1,ei(u.backgroundColor,"ff")),e.fillStyle=h,e.fillRect(i,n,r,c),e.restore()}renderBorder(e,i,n,r,c,u){if(e.save(),e.strokeStyle=u.borderColor,e.lineWidth=2,u.cornerBevel){const d=Math.min(3,c*.2);e.beginPath(),e.moveTo(i+d,n),e.lineTo(i+r-d,n),e.lineTo(i+r,n+d),e.lineTo(i+r,n+c-d),e.lineTo(i+r-d,n+c),e.lineTo(i+d,n+c),e.lineTo(i,n+c-d),e.lineTo(i,n+d),e.closePath(),e.stroke()}else e.strokeRect(i,n,r,c);e.strokeStyle=`${u.borderColor}40`,e.lineWidth=1,e.strokeRect(i+1,n+1,r-2,c-2),e.strokeStyle=u.borderColor,e.lineWidth=2,e.globalAlpha=.7;const h=Math.min(8,c*.4);e.beginPath(),e.moveTo(i-4,n+h),e.lineTo(i-4,n-4),e.lineTo(i+h,n-4),e.stroke(),e.beginPath(),e.moveTo(i+r-h,n-4),e.lineTo(i+r+4,n-4),e.lineTo(i+r+4,n+h),e.stroke(),e.beginPath(),e.moveTo(i+r+4,n+c-h),e.lineTo(i+r+4,n+c+4),e.lineTo(i+r-h,n+c+4),e.stroke(),e.beginPath(),e.moveTo(i+h,n+c+4),e.lineTo(i-4,n+c+4),e.lineTo(i-4,n+c-h),e.stroke(),e.restore()}renderScanlines(e,i,n,r,c,u){if(u.scanlineIntensity<=0)return;e.save();const h=2,d=1;e.fillStyle=`rgba(255, 255, 255, ${u.scanlineIntensity*.08})`;for(let g=0;g<c+h;g+=h)n+g>=n&&n+g<n+c&&e.fillRect(i,n+g,r,d);e.restore()}cleanup(){if(this.cache.size<=this.maxCacheSize)return;const e=Date.now(),i=Array.from(this.cache.entries());i.forEach(([n,r])=>{e-r.timestamp>this.maxAge&&this.cache.delete(n)}),this.cache.size>this.maxCacheSize&&i.sort((r,c)=>r[1].timestamp-c[1].timestamp).slice(0,this.cache.size-this.maxCacheSize).forEach(([r])=>this.cache.delete(r))}clear(){this.cache.clear()}}class na{constructor(){this.cache=new Map}static getInstance(){return na.instance||(na.instance=new na),na.instance}getBarGradient(e,i,n,r,c,u,h){const d=`bar_${r}_${c}_${u}_${h}`;if(!this.cache.has(d)){const g=e.createLinearGradient(i,n,i,n+c),m=Math.floor(h*255).toString(16).padStart(2,"0"),y=Math.floor(h*180).toString(16).padStart(2,"0");g.addColorStop(0,ei(u,m)),g.addColorStop(.5,ei(u,y)),g.addColorStop(1,ei(u,m)),this.cache.set(d,g)}return this.cache.get(d)}getPhosphorGradient(e,i,n,r,c){const u=`phosphor_${n}_${r}_${c}`;if(!this.cache.has(u)){const h=e.createLinearGradient(i,0,i+n,0);h.addColorStop(0,ei(r,"08")),h.addColorStop(.7,ei(r,"15")),h.addColorStop(1,ei(r,Math.floor(c*255).toString(16).padStart(2,"0"))),this.cache.set(u,h)}return this.cache.get(u)}clear(){this.cache.clear()}}function Pp(a,e,i=Date.now()){const{x:n,y:r,width:c,height:u,value:h,label:d,style:g={}}=e,m={...yh,...g},{barColor:y,glow:v,textColor:M,font:S,scanlineIntensity:T,chromaticAberration:w,phosphorDecay:A,warningThreshold:R,criticalThreshold:I,warningColor:x,criticalColor:P,animated:N}=m,W=Math.max(0,Math.min(1,h)),H=W*c;let q=y;W<=I?q=P:W<=R&&(q=x);let ie=1,$=0;N&&(W<=I&&(ie=.7+.3*Math.sin(i*.008)),$=i*.02%4);const K=sa.getInstance(),ne=na.getInstance(),Z=K.getOrCreate(e,"background");if(Z&&a.drawImage(Z.canvas,n-10,r-10),A&&H>0){const _=ne.getPhosphorGradient(a,n,H,q,ie);a.fillStyle=_,a.fillRect(n,r,H,u)}if(H>0){const _=ne.getBarGradient(a,n,r,c,u,q,ie);a.fillStyle=_,a.fillRect(n,r,H,u)}if(v&&H>0&&(a.save(),a.shadowColor=q,a.shadowBlur=12,a.shadowOffsetX=0,a.shadowOffsetY=0,a.globalAlpha=.4*ie,a.fillStyle=q,a.fillRect(n-1,r-1,H+2,u+2),a.shadowBlur=6,a.globalAlpha=.6*ie,a.fillRect(n,r,H,u),a.restore()),w&&H>0&&(a.save(),a.globalAlpha=.15,a.fillStyle="#ff0000",a.fillRect(n-.5,r,H,u),a.fillStyle="#0000ff",a.fillRect(n+.5,r,H,u),a.restore()),T>0){const _=K.getOrCreate(e,"scanlines");if(_){if(a.save(),a.globalAlpha=1,a.drawImage(_.canvas,n-10,r-10-$),N&&Math.sin(i*.003)>.95){a.fillStyle=`rgba(255, 255, 255, ${T*.2})`;const X=r+(Math.sin(i*.007)*.5+.5)*u;a.fillRect(n,X,c,1)}a.restore()}}const te=K.getOrCreate(e,"border");te&&(a.save(),a.globalAlpha=ie,a.drawImage(te.canvas,n-10,r-10),a.restore()),d&&(a.save(),a.font=S,a.fillStyle=M,a.textAlign="center",a.textBaseline="middle",a.globalAlpha=ie,v&&(a.shadowColor=M,a.shadowBlur=4,a.shadowOffsetX=0,a.shadowOffsetY=0),w&&(a.save(),a.globalAlpha=.3,a.fillStyle="#ff000040",a.fillText(d,n+c/2-.5,r+u/2),a.fillStyle="#0000ff40",a.fillText(d,n+c/2+.5,r+u/2),a.restore()),a.fillText(d,n+c/2,r+u/2),a.restore()),W<=I&&(a.save(),a.fillStyle=P,a.globalAlpha=(Math.sin(i*.015)+1)*.3,a.fillRect(n-2,r-2,4,4),a.fillRect(n+c-2,r-2,4,4),a.restore())}const Fm={barColor:"#0af",backgroundColor:"#111",borderColor:"#0ff",glow:!0,textColor:"#fff",showLabel:!0,unit:""};class aa{constructor(){this.cache=new Map,this.maxAge=3e4}static getInstance(){return aa.instance||(aa.instance=new aa),aa.instance}getOrCreate(e,i){const{width:n,height:r,style:c={}}=e,u={...Fm,...c},h=Math.round(n*i),d=Math.round(r*i),g=`vbar_${h}_${d}_${u.backgroundColor}_${u.borderColor}`,m=this.cache.get(g);if(m&&Date.now()-m.timestamp<this.maxAge)return m;const y=document.createElement("canvas");y.width=h+4,y.height=d+4;const v=y.getContext("2d");v.save(),v.fillStyle=u.backgroundColor,v.fillRect(2,2,h,d),v.strokeStyle=u.borderColor,v.lineWidth=1,v.strokeRect(1.5,1.5,h+1,d+1),v.fillStyle="rgba(255,255,255,0.05)";for(let S=0;S<d;S+=2)v.fillRect(2,2+S,h,1);v.restore();const M={canvas:y,ctx:v,cacheKey:g,timestamp:Date.now()};return this.cache.set(g,M),M}clear(){this.cache.clear()}}function _M(a,e,i=1){const{x:n,y:r,width:c,height:u,value:h,maxValue:d,style:g={}}=e,{barColor:m,glow:y,textColor:v,showLabel:M,unit:S}={...Fm,...g},T=c*i,w=u*i,R=Math.max(0,Math.min(h,d))/d*w,I=r+w-R,x=aa.getInstance().getOrCreate(e,i);if(a.drawImage(x.canvas,n-2,r-2),a.fillStyle=m,a.fillRect(n,I,T,R),y&&(a.save(),a.shadowColor=m,a.shadowBlur=8*i,a.shadowOffsetX=0,a.shadowOffsetY=0,a.fillStyle=m,a.fillRect(n,I,T,R),a.restore()),M){a.save(),a.font=`${Math.round(11*ae())}px monospace`,a.fillStyle=v,a.textAlign="center",a.textBaseline="bottom";const P=`${Math.round(h)}${S?` ${S}`:""}`;a.fillText(P,n+T/2,r-4*ae()),a.restore()}}var Wt=(a=>(a.Synced="synced",a.Sequence="sequence",a))(Wt||{});function DM(a,e,i=performance.now()){const{x:n,y:r,mode:c,style:u={}}=e,{width:h=120,height:d=24,backgroundColor:g="#001122",borderColor:m="#0066cc",activeColor:y="#00aaff",inactiveColor:v="#003366",textColor:M="#00ccff",glowColor:S="#00aaff",font:T='10px "Courier New", monospace',glow:w=!0,animated:A=!0,scanlineIntensity:R=.2,chromaticAberration:I=!0}=u,x=c===Wt.Synced,P=4,N=h*.45,W=d-6,H=r+3,q=x?n+3:n+h-N-3,$=A?Math.sin(i*.008)*.5:0,K=q+$;a.save(),w&&(a.shadowColor=S,a.shadowBlur=8,a.shadowOffsetX=0,a.shadowOffsetY=0),a.fillStyle=g,a.strokeStyle=m,a.lineWidth=1,a.beginPath(),a.roundRect(n,r,h,d,P),a.fill(),a.stroke(),a.shadowBlur=0,a.fillStyle=M,a.font=T,a.textAlign="center",a.textBaseline="middle";const ne=x?1:.4;a.save(),a.globalAlpha=ne,a.fillText("SYNC",n+h*.25,r+d*.5),a.restore();const Z=x?.4:1;a.save(),a.globalAlpha=Z,a.fillText("SEQ",n+h*.75,r+d*.5),a.restore();const te=x?y:"#ff6600";w&&(a.save(),a.shadowColor=te,a.shadowBlur=6,a.fillStyle=te,a.globalAlpha=.3,a.beginPath(),a.roundRect(K-2,H-2,N+4,W+4,P),a.fill(),a.restore()),a.fillStyle=te,a.strokeStyle=te,a.lineWidth=1,a.beginPath(),a.roundRect(K,H,N,W,P-1),a.fill();const _=a.createLinearGradient(K,H,K,H+W);if(_.addColorStop(0,"rgba(255, 255, 255, 0.3)"),_.addColorStop(.5,"rgba(255, 255, 255, 0.1)"),_.addColorStop(1,"rgba(0, 0, 0, 0.2)"),a.fillStyle=_,a.beginPath(),a.roundRect(K,H,N,W*.6,P-1),a.fill(),R>0){a.save(),a.globalAlpha=R,a.strokeStyle="#00ffff",a.lineWidth=.5;for(let oe=0;oe<d;oe+=3)a.beginPath(),a.moveTo(n,r+oe),a.lineTo(n+h,r+oe),a.stroke();a.restore()}if(I&&A){const oe=Math.sin(i*.003)*.5;a.save(),a.globalAlpha=.1,a.globalCompositeOperation="screen",a.fillStyle="#ff0000",a.beginPath(),a.roundRect(n+oe,r,h,d,P),a.fill(),a.fillStyle="#0000ff",a.beginPath(),a.roundRect(n-oe,r,h,d,P),a.fill(),a.restore()}const X=2,se=r+d+8;a.fillStyle=x?y:v,a.beginPath(),a.arc(n+h*.25,se,X,0,Math.PI*2),a.fill(),a.fillStyle=x?v:"#ff6600",a.beginPath(),a.arc(n+h*.75,se,X,0,Math.PI*2),a.fill(),a.restore()}const Lp=new Map,PM={gray:{backgroundColor:"#444444",borderColor:"#888888"},green:{backgroundColor:"#003300",borderColor:"#00ff00"},blue:{backgroundColor:"#002244",borderColor:"#00ccff"},purple:{backgroundColor:"#220033",borderColor:"#cc66ff"}};function LM(a,e){const i=h=>Math.max(0,Math.min(255,h)),n=parseInt(a.slice(1),16),r=i((n>>16&255)+e*255),c=i((n>>8&255)+e*255),u=i((n&255)+e*255);return`rgb(${r},${c},${u})`}function OM(a){const{ctx:e,x:i,y:n,width:r,height:c,borderRadius:u,baseStyleId:h,alpha:d=1,scale:g=1,brighten:m=0}=a,y=PM[h];if(!y){console.warn(`[drawBlockCard] Unknown style: ${h}`);return}const v=h;let M=Lp.get(v);if(!M){M=document.createElement("canvas"),M.width=r,M.height=c;const w=M.getContext("2d");w.fillStyle=y.backgroundColor,w.strokeStyle=y.borderColor,w.lineWidth=2,w.beginPath(),w.roundRect(0,0,r,c,u),w.fill(),w.stroke(),Lp.set(v,M)}e.save(),e.globalAlpha*=d;const S=i+r/2,T=n+c/2;e.translate(S,T),e.scale(g,g),e.translate(-r/2,-c/2),m>.01?(e.drawImage(M,0,0,r,c),e.fillStyle=LM(y.backgroundColor,m),e.globalAlpha*=.2,e.fillRect(0,0,r,c)):e.drawImage(M,0,0,r,c),e.restore()}function FM(a){switch(a){case 0:return"gray";case 1:return"gray";case 2:return"green";case 3:return"blue";case 4:return"purple";default:return"gray"}}class UM{constructor(e,i,n){this.canvasManager=e,this.playerResources=i,this.blockDropDecisionMenu=n,this.MINI_BLOCK_SIZE=16,this.MINI_BLOCK_SPIN_SPEED=.5,this.BLOCK_CULLING_THRESHOLD=20,this.floatOffsets=[],this.FLOAT_SPEED=80,this.FLOAT_HEIGHT=10,this.xOffsets=[],this.X_OFFSET_SPEED=360,this.FANOUT_X_OFFSET=28,this.pulseTimers=[],this.PULSE_SPEED=4,this.PULSE_SCALE_AMPLITUDE=.06,this.PULSE_BRIGHTNESS_AMPLITUDE=.25;const r=ni("hull0");this.blockPreviewRenderer=new sl(r,this.MINI_BLOCK_SPIN_SPEED,this.MINI_BLOCK_SPIN_SPEED*1.5)}update(e){const i=this.playerResources.getBlockQueue();if(i.length===0){this.floatOffsets.length=0,this.pulseTimers.length=0,this.xOffsets.length=0;return}this.blockPreviewRenderer.update(e);const n=this.blockDropDecisionMenu.getHoveredButton();for(;this.floatOffsets.length<i.length;)this.floatOffsets.push(0);for(;this.floatOffsets.length>i.length;)this.floatOffsets.pop();for(;this.pulseTimers.length<i.length;)this.pulseTimers.push(0);for(;this.pulseTimers.length>i.length;)this.pulseTimers.pop();const r=new Set;if(n==="refine"||n==="autoplace")i.length>0&&r.add(0);else if(n==="roll")for(let u=0;u<3&&u<i.length;u++)r.add(u);for(let u=0;u<i.length;u++){const h=r.has(u)?this.FLOAT_HEIGHT:0,d=this.floatOffsets[u],g=h-d,m=this.FLOAT_SPEED*e,y=Math.sign(g)*Math.min(Math.abs(g),m);this.floatOffsets[u]+=y}for(let u=0;u<i.length;u++)this.pulseTimers[u]+=e*this.PULSE_SPEED;for(;this.xOffsets.length<i.length;)this.xOffsets.push(0);for(;this.xOffsets.length>i.length;)this.xOffsets.pop();const c=this.FANOUT_X_OFFSET*ae();for(let u=0;u<i.length;u++){let h=0;n==="roll"&&u>=0&&u<=2&&(h=c*u);const d=this.xOffsets[u],g=h-d,m=this.X_OFFSET_SPEED*e,y=Math.sign(g)*Math.min(Math.abs(g),m);this.xOffsets[u]+=y}}render(){var K,ne;const e=this.canvasManager.getContext("ui"),i=e.canvas,n=ae(),r=Math.floor(80*n),c=Math.floor(i.width/2),u=Math.floor(32*n),h=Math.floor(32*n),d=Math.floor(8*n),g=Math.floor(8*n),m=6,y=Math.floor(6*n),v=Math.floor(6*n),M=Math.floor(u*m+y*2+d*(m-1)),S=Math.floor(44*n),T=c-M/2,w=i.height-r,A=this.blockDropDecisionMenu.getHoveredButton(),R=this.playerResources.getBlockQueue(),I=R.length;let x=I>0?"#00ff00":"#003400",P=`Blocks: ${I}`,N=.5;if(A&&I>0)switch(A){case"refine":{P=`Refine "${((K=R[0])==null?void 0:K.name)??"Block"}"`,x="#ffcc00",N=.85;break}case"roll":{P="3-1 Reroll",x="#cc66ff",N=.85;break}case"autoplace":{P=`Attach "${((ne=R[0])==null?void 0:ne.name)??"Block"}"`,x="#00ccff",N=.85;break}case"autoPlaceAll":{P=`Attach ${I} Blocks`,x="#66ff66",N=.85;break}}Mt({ctx:e,x:T,y:w,width:M,height:S,options:{alpha:N,borderRadius:12,borderColor:x,backgroundColor:"#00000000"}}),Ve(e,T,w-14*n,P,{align:"left",color:x},n);const H=Math.floor(this.MINI_BLOCK_SIZE*n);let q=u+d;if(I>m){const Z=M-y*2;I*u+(I-1)*d>Z&&(q=(Z-u)/(I-1))}const ie=A==="roll",$=T+y;for(let Z=R.length-1;Z>=0;Z--){const te=R[Z],_=bi(te.id),X=FM(_),se=this.floatOffsets[Z]??0,oe=this.pulseTimers[Z]??0,k=this.xOffsets[Z]??0;let G=1,ee=0;if(se>.5){const Ki=(Math.sin(oe)+1)/2;G=1+Ki*this.PULSE_SCALE_AMPLITUDE,ee=Ki*this.PULSE_BRIGHTNESS_AMPLITUDE}const J=Math.floor(u*G),re=Math.floor(h*G),ve=Math.floor(H*G);let he;ie&&Z>=0&&Z<=2?he=$+k+(u-J)/2:he=T+y+Z*q+(u-J)/2;const ct=w+v-se+(h-re)/2;OM({ctx:e,x:he,y:ct,width:J,height:re,borderRadius:12,baseStyleId:X,alpha:1,scale:1,brighten:ee});const Fe=he+d,ui=ct+g,da=I>0?1:.3;Z<this.BLOCK_CULLING_THRESHOLD&&this.blockPreviewRenderer.render(e,Fe,ui,ve,ve,da,te)}}}class NM{constructor(e,i,n,r){this.canvasManager=e,this.ship=i,this.floatingTextManager=n,this.blockDropDecisionMenu=r,this.currency=0,this.previousCurrency=0,this.disposer=null,this.playerResources=Be.getInstance(),this.currency=this.playerResources.getCurrency(),this.previousCurrency=this.currency,this.disposer=this.playerResources.onCurrencyChange(c=>{if(c>this.currency){const u=this.canvasManager.getContext("ui"),h=c-this.currency,d=ae(),g=Math.floor(900*d)+Math.floor(80*d),y=u.canvas.height-Math.floor(24*d)-Math.floor(12*d);this.floatingTextManager.createScreenText(`+${h}`,g,y,12,"monospace",1,100,1,"#FFD700",{impactScale:1.5},"currency")}this.currency=c}),this.blockQueueDisplayManager=new UM(this.canvasManager,this.playerResources,this.blockDropDecisionMenu)}update(e){this.blockQueueDisplayManager.update(e)}render(e){var _;const i=ae(),n=this.canvasManager.getContext("ui"),r=n.canvas,{velocity:c}=this.ship.getTransform(),h=this.ship.getAllBlocks().reduce((X,[se,oe])=>X+oe.type.mass,0);Math.floor(this.ship.getCockpitHp()??0),Math.floor(((_=this.ship.getCockpit())==null?void 0:_.type.armor)??1);const d=Math.sqrt(c.x**2+c.y**2),g=this.ship.getEnergyComponent(),m=Math.floor((g==null?void 0:g.getCurrent())??0),y=Math.floor((g==null?void 0:g.getMax())??0),v=Math.floor(180*i),M=Math.floor(12*i),S=Math.floor(20*i),T=v*2+S,w=Math.floor((r.width-T)/2),A=r.height-Math.floor(24*i),R=this.ship.getAfterburnerComponent(),I=R?R.getCurrent():0,x=R?R.getMax():1;Pp(n,{x:w,y:A,width:v,height:M,value:I/x,label:`${Math.floor(I)} / ${x}`,style:{barColor:"#ffcc00",borderColor:"#ffee88",backgroundColor:"#221800",glow:!0,textColor:"#ffffaa",font:`${Math.floor(11*i)}px "Courier New", monospace`,scanlineIntensity:.3,chromaticAberration:!0,phosphorDecay:!0,cornerBevel:!0,warningThreshold:.25,criticalThreshold:.1,warningColor:"#ffaa00",criticalColor:"#ff0040",animated:!0}},performance.now()),Pp(n,{x:w+v+S,y:A,width:v,height:M,value:y>0?m/y:1,label:`${Math.round(m)} / ${y}`,style:{barColor:"#0af",borderColor:"#6cf",backgroundColor:"#003",glow:!0,textColor:"#9cf",font:`${Math.floor(11*i)}px "Courier New", monospace`,scanlineIntensity:.25,chromaticAberration:!0,phosphorDecay:!0,cornerBevel:!0,warningThreshold:.25,criticalThreshold:.1,warningColor:"#ffaa00",criticalColor:"#ff0040",animated:!0}},performance.now());const P=Math.floor(120*i),N=Math.floor(12*i),W=Math.floor(32*i),H=A-P+Math.floor(14*i);_M(n,{x:W,y:H,width:N,height:P,value:d,maxValue:2e3,style:{barColor:"#00ff41",backgroundColor:"#001100",borderColor:"#00aa33",glow:!0,textColor:"#00ff88",showLabel:!0,unit:"m/s"}});const q=Math.floor(120*i),ie=Math.floor(24*i),$=Math.floor(64*i),K=A-Math.floor(12*i);DM(n,{x:$,y:K,mode:this.ship.getFiringMode(),style:{width:q,height:ie,backgroundColor:"#000a00",borderColor:"#00ff41",activeColor:"#00ff41",inactiveColor:"#001a00",textColor:"#00ff41",glowColor:"#00ff41",font:`${Math.floor(10*i)}px "Courier New", monospace`,glow:!0,animated:!0,scanlineIntensity:.3,chromaticAberration:!1}},performance.now());const ne=Math.floor(900*i),Z=Math.floor(16*i);let te=K;Ve(n,ne,te,`Entropium: ${this.currency}`,{},i),te+=Z,Ve(n,ne,te,`Mass: ${h.toFixed(1)} kg`,{},i),this.blockQueueDisplayManager.render()}destroy(){var e;(e=this.disposer)==null||e.call(this)}}class HM{constructor(e,i){this.canvasManager=e,this.waveSpawner=i}render(){const e=this.canvasManager.getContext("ui"),i=e.canvas,n=this.waveSpawner.getCurrentWaveNumber(),r=this.waveSpawner.getTimeUntilNextWave(),c=this.waveSpawner.isBossWaveActive(),u=ae(),h=240*u;let d=i.height-36*u;const g=18*u;Ve(e,h,d,`Wave: ${n}`,{},u),d+=g,c?Ve(e,h,d,"Boss Encounter",{},u):Ve(e,h,d,`Next wave in: ${Math.ceil(r)}s`,{},u)}}class GM{constructor(e){this.canvasManager=e,this.messages=[],this.ctx=e.getContext("ui")}displayMessage(e,i){this.messages.push({text:e,duration:(i==null?void 0:i.duration)??3,elapsed:0,color:(i==null?void 0:i.color)??"#00ff00",font:(i==null?void 0:i.font)??"28px monospace",glow:(i==null?void 0:i.glow)??!0,yOffset:0})}update(e){for(const i of this.messages)i.elapsed+=e;this.messages=this.messages.filter(i=>i.elapsed<i.duration)}render(){const e=this.ctx.canvas.width/2,i=this.ctx.canvas.height*.35,n=36;performance.now()/1e3;for(let r=0;r<this.messages.length;r++){const c=this.messages[r],u=c.elapsed/c.duration,h=1-u,d=i-r*n-u*30;Ve(this.ctx,e,d,c.text,{font:c.font,align:"center",alpha:h,glow:c.glow,shadowBlur:0,color:c.color})}}}class WM{constructor(e,i){this.canvasManager=e,this.shipRegistry=i,this.smoothedFps=60}render(e){const i=this.canvasManager.getContext("ui"),n=i.canvas,r=1/e,c=.05;this.smoothedFps+=(r-this.smoothedFps)*c;const u=this.shipRegistry.count(),h=qi.getEnemyPower(),d=n.width-220;let g=12;const m=18;Ve(i,d,g,"DEBUG"),g+=m,Ve(i,d,g,`FPS: ${this.smoothedFps.toFixed(1)}`),g+=m,Ve(i,d,g,`Ships: ${u}`),g+=m,Ve(i,d,g,`Enemy Power: ${h}`)}}class zM{static createIcon(e,i){const n=document.createElement("canvas");n.width=i,n.height=i;const r=n.getContext("2d");switch(r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",e){case"caution":this.drawCautionIcon(r,i);break;case"greenCross":this.drawGreenCrossIcon(r,i);break;case"skullAndBones":this.drawSkullAndBonesIcon(r,i);break}return n}static drawCautionIcon(e,i){const n=i/2,r=i*.4,c=e.createRadialGradient(n,n,0,n,n,r);c.addColorStop(0,"#ffff00"),c.addColorStop(1,"#ff8800"),e.fillStyle=c,e.strokeStyle="#cc6600",e.lineWidth=i*.05,e.beginPath(),e.moveTo(n,n-r),e.lineTo(n-r*.87,n+r*.5),e.lineTo(n+r*.87,n+r*.5),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#000000",e.font=`bold ${i*.5}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("!",n,n-i*.05)}static drawGreenCrossIcon(e,i){const n=i/2,r=i*.45,c=e.createRadialGradient(n,n,0,n,n,r);c.addColorStop(0,"#00ff88"),c.addColorStop(1,"#00cc44"),e.fillStyle=c,e.strokeStyle="#008833",e.lineWidth=i*.05,e.beginPath(),e.arc(n,n,r,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#ffffff",e.strokeStyle="#ffffff",e.lineWidth=i*.08,e.lineCap="round";const u=i*.25;e.beginPath(),e.moveTo(n,n-u),e.lineTo(n,n+u),e.stroke(),e.beginPath(),e.moveTo(n-u,n),e.lineTo(n+u,n),e.stroke()}static drawSkullAndBonesIcon(e,i){const n=i/2;e.fillStyle="#ffffff",e.strokeStyle="#666666",e.lineWidth=i*.03;const r=i*.4,c=i*.45;e.beginPath(),e.ellipse(n,n-i*.1,r,c,0,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#000000";const u=i*.08,h=i*.12;e.beginPath(),e.arc(n-h,n-i*.15,u,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(n+h,n-i*.15,u,0,Math.PI*2),e.fill(),e.beginPath(),e.moveTo(n,n-i*.05),e.lineTo(n-i*.04,n+i*.05),e.lineTo(n+i*.04,n+i*.05),e.closePath(),e.fill(),e.strokeStyle="#000000",e.lineWidth=i*.02;const d=n+i*.1,g=i*.06;for(let v=-1;v<=1;v++)e.beginPath(),e.moveTo(n+v*g,d),e.lineTo(n+v*g,d+i*.08),e.stroke();e.fillStyle="#dddddd",e.strokeStyle="#999999",e.lineWidth=i*.02;const m=i*.7,y=i*.06;e.save(),e.translate(n,n),e.rotate(Math.PI/4),this.drawBone(e,m,y),e.restore(),e.save(),e.translate(n,n),e.rotate(-Math.PI/4),this.drawBone(e,m,y),e.restore()}static drawBone(e,i,n){const r=n*1.5;e.fillRect(-i/2,-n/2,i,n),e.strokeRect(-i/2,-n/2,i,n),e.beginPath(),e.arc(-i/2,0,r,0,Math.PI*2),e.fill(),e.stroke(),e.beginPath(),e.arc(i/2,0,r,0,Math.PI*2),e.fill(),e.stroke()}}const VM={MINIMAP_TRANSPARENCY:.3};class XM{constructor(e,i,n,r,c=1){this.canvasManager=e,this.player=i,this.aiOrchestrator=n,this.planetSystem=r,this.scale=c,this.baseWidth=220,this.baseHeight=220,this.baseMargin=14,this.animationTime=0,this.scanlineOffset=0,this.lastFrameTime=0,this.incidentMarkers=new Map,this.iconCache=new Map,this.staticCanvas=null,this.staticCtx=null,this.staticCacheValid=!1,this.handleIncidentMarkerAdd=u=>{this.incidentMarkers.set(u.id,u)},this.handleIncidentMarkerClear=({id:u})=>{this.incidentMarkers.delete(u)},this.unsubscribeResolution=Ae.getInstance().onResolutionChange(()=>{this.resize(ae())}),this.width=Math.floor(this.baseWidth*this.scale),this.height=Math.floor(this.baseHeight*this.scale),this.margin=Math.floor(this.baseMargin*this.scale),this.initializeStaticCache(),this.enemyMarkers={passive:this.createEnemyDot("#3399ff"),seeking:this.createEnemyDot("#ffbb33"),attacking:this.createEnemyDot("#ff0000"),hunter:this.createEnemyDot("#ff0000")},this.planetMarker=this.createPlanetDot("#00ffff"),this.playerMarker=this.createPlayerMarker(),pe.on("incident:minimap:marker",this.handleIncidentMarkerAdd),pe.on("incident:minimap:clear",this.handleIncidentMarkerClear)}initializeStaticCache(){this.staticCanvas=document.createElement("canvas"),this.staticCanvas.width=this.width+Math.floor(20*this.scale),this.staticCanvas.height=this.height+Math.floor(20*this.scale),this.staticCtx=this.staticCanvas.getContext("2d")}resize(e){this.scale=e,this.width=Math.floor(this.baseWidth*this.scale),this.height=Math.floor(this.baseHeight*this.scale),this.margin=Math.floor(this.baseMargin*this.scale),this.initializeStaticCache(),this.resetAllCaches()}resetAllCaches(){this.staticCacheValid=!1,this.enemyMarkers={passive:this.createEnemyDot("#3399ff"),seeking:this.createEnemyDot("#ffbb33"),attacking:this.createEnemyDot("#ff0000"),hunter:this.createEnemyDot("#ff0000")},this.planetMarker=this.createPlanetDot("#00ffff"),this.playerMarker=this.createPlayerMarker()}renderStaticElements(){if(!this.staticCtx||this.staticCacheValid)return;const e=this.staticCtx,i=Math.floor(10*this.scale),n=Math.floor(10*this.scale);e.clearRect(0,0,this.staticCanvas.width,this.staticCanvas.height),this.drawDiegeticFrame(e,i,n),this.drawCRTBackground(e,i,n),this.drawRadarGrid(e,i,n),this.staticCacheValid=!0}getOrCreateIncidentIcon(e){if(this.iconCache.has(e))return this.iconCache.get(e);const i=Math.floor(18*this.scale),r=["caution","greenCross","skullAndBones"].includes(e)?e:null;let c;if(r)c=zM.createIcon(r,i);else{c=document.createElement("canvas"),c.width=i,c.height=i;const u=c.getContext("2d");u.fillStyle="#ffffff",u.shadowColor="#ffffff",u.shadowBlur=6,u.beginPath(),u.arc(i/2,i/2,i/2.5,0,Math.PI*2),u.fill()}return this.iconCache.set(e,c),c}render(){const e=this.canvasManager.getContext("ui"),i=performance.now(),n=i-this.lastFrameTime;this.lastFrameTime=i,this.animationTime=i,this.scanlineOffset=(this.scanlineOffset+n*.03)%(4*this.scale);const r=e.canvas.width,c=e.canvas.height,u=r-this.width-this.margin,h=c-this.height-this.margin,d=VM.MINIMAP_TRANSPARENCY;e.save(),e.globalAlpha=d,this.renderStaticElements(),this.staticCanvas&&e.drawImage(this.staticCanvas,u-Math.floor(10*this.scale),h-Math.floor(10*this.scale));const g=(this.width-Math.floor(20*this.scale))/rn,m=(this.height-Math.floor(20*this.scale))/ha,y=v=>{const M=v.x-hl.x+rn/2,S=v.y-hl.y+ha/2;return{x:u+Math.floor(10*this.scale)+M*g,y:h+Math.floor(10*this.scale)+S*m}};this.drawPlanets(e,y),this.drawShips(e,y);for(const{x:v,y:M,icon:S}of this.incidentMarkers.values()){const T=y({x:v,y:M}),w=this.getOrCreateIncidentIcon(S),A=Math.floor(w.width/2);e.drawImage(w,T.x-A,T.y-A)}this.drawScanlines(e,u,h),this.drawStatusIndicator(e,u,h),e.restore()}drawDiegeticFrame(e,i,n){const r=Math.floor(2*this.scale),c=Math.floor(8*this.scale);e.strokeStyle="#00ff41",e.lineWidth=r,e.strokeRect(i-r,n-r,this.width+r*2,this.height+r*2),e.strokeStyle="#00ff41",e.lineWidth=Math.max(1,Math.floor(1*this.scale));const u=Math.floor(6*this.scale);e.beginPath(),e.moveTo(i-u,n+c),e.lineTo(i-u,n-u),e.lineTo(i+c,n-u),e.stroke(),e.beginPath(),e.moveTo(i+this.width-c,n-u),e.lineTo(i+this.width+u,n-u),e.lineTo(i+this.width+u,n+c),e.stroke(),e.beginPath(),e.moveTo(i+this.width+u,n+this.height-c),e.lineTo(i+this.width+u,n+this.height+u),e.lineTo(i+this.width-c,n+this.height+u),e.stroke(),e.beginPath(),e.moveTo(i+c,n+this.height+u),e.lineTo(i-u,n+this.height+u),e.lineTo(i-u,n+this.height-c),e.stroke()}drawCRTBackground(e,i,n){const r=e.createLinearGradient(i,n,i,n+this.height);r.addColorStop(0,"#001a00"),r.addColorStop(1,"#000a00"),e.fillStyle=r,e.fillRect(i,n,this.width,this.height)}drawRadarGrid(e,i,n){e.strokeStyle="#00ff4120",e.lineWidth=Math.max(1,Math.floor(1*this.scale));const r=i+this.width/2,c=n+this.height/2,u=Math.min(this.width,this.height)/2-Math.floor(10*this.scale);for(let h=1;h<=2;h++){const d=u*h/2;e.beginPath(),e.arc(r,c,d,0,Math.PI*2),e.stroke()}e.beginPath(),e.moveTo(r,n+Math.floor(10*this.scale)),e.lineTo(r,n+this.height-Math.floor(10*this.scale)),e.moveTo(i+Math.floor(10*this.scale),c),e.lineTo(i+this.width-Math.floor(10*this.scale),c),e.stroke()}drawPlanets(e,i){for(const n of this.planetSystem.getPlanets()){const r=n.getPosition(),c=i(r),u=Math.floor(8*this.scale);e.drawImage(this.planetMarker,c.x-u,c.y-u)}}drawShips(e,i){const n=i(this.player.getTransform().position),r=this.player.getTransform().rotation;for(const[u,h]of this.aiOrchestrator.getAllControllers()){const{position:d}=h.getTransform(),{x:g,y:m}=i(d),y=u.getCurrentStateString(),v=u.isHunter()?this.enemyMarkers.hunter:y==="AttackState"?this.enemyMarkers.attacking:y==="SeekTargetState"?this.enemyMarkers.seeking:this.enemyMarkers.passive,M=Math.floor(4*this.scale);e.drawImage(v,g-M,m-M)}e.save(),e.translate(n.x,n.y),e.rotate(r);const c=Math.floor(8*this.scale);e.drawImage(this.playerMarker,-c,-c),e.restore()}createPlanetDot(e){const i=Math.floor(16*this.scale),n=document.createElement("canvas");n.width=i,n.height=i;const r=n.getContext("2d");return r.fillStyle=e,r.shadowColor=e,r.shadowBlur=Math.floor(8*this.scale),r.beginPath(),r.arc(i/2,i/2,Math.floor(6*this.scale),0,Math.PI*2),r.fill(),n}drawScanlines(e,i,n){e.fillStyle="rgba(0, 255, 65, 0.06)";const r=Math.floor(8*this.scale);for(let c=-this.scanlineOffset;c<this.height;c+=r)n+c>=n&&n+c<n+this.height&&e.fillRect(i,n+c,this.width,Math.max(1,Math.floor(1*this.scale)))}drawStatusIndicator(e,i,n){e.fillStyle="#00ff41",e.shadowColor="#00ff41",e.shadowBlur=Math.floor(4*this.scale),e.beginPath();const r=Math.floor(3*this.scale),c=Math.floor(10*this.scale);e.arc(i+this.width-c,n+c,r,0,Math.PI*2),e.fill();const u=Math.floor(8*this.scale);e.font=`${u}px "Courier New", monospace`,e.fillStyle="#00ff4180",e.textAlign="right",e.textBaseline="bottom",e.shadowBlur=0;const h="1:"+Math.floor(rn/this.width),d=Math.floor(4*this.scale);e.fillText(h,i+this.width-d,n+this.height-d)}invalidateCache(){this.staticCacheValid=!1}createEnemyDot(e){const i=Math.floor(8*this.scale),n=document.createElement("canvas");n.width=i,n.height=i;const r=n.getContext("2d");return r.fillStyle=e,r.shadowColor=e,r.shadowBlur=Math.floor(4*this.scale),r.beginPath(),r.arc(i/2,i/2,Math.floor(2*this.scale),0,Math.PI*2),r.fill(),n}createPlayerMarker(){const e=Math.floor(16*this.scale),i=document.createElement("canvas");i.width=e,i.height=e;const n=i.getContext("2d");n.translate(e/2,e/2),n.rotate(0),n.fillStyle="#ffffff",n.shadowColor="#ffffff",n.shadowBlur=Math.floor(6*this.scale);const r=Math.floor(4*this.scale),c=Math.floor(4*this.scale);return n.beginPath(),n.moveTo(0,-r),n.lineTo(Math.floor(3*this.scale),0),n.lineTo(0,r),n.lineTo(-Math.floor(3*this.scale),0),n.closePath(),n.fill(),n.strokeStyle="#ffffff",n.lineWidth=Math.max(1,Math.floor(1*this.scale)),n.beginPath(),n.moveTo(0,-r),n.lineTo(0,-r-c),n.stroke(),i}destroy(){this.unsubscribeResolution(),pe.off("incident:minimap:marker",this.handleIncidentMarkerAdd),pe.off("incident:minimap:clear",this.handleIncidentMarkerClear),this.incidentMarkers.clear(),this.iconCache.clear()}}function Op(a,e,i){const n=a.createShader(e);if(!n)throw new Error("[shaderUtils] Failed to create shader");if(a.shaderSource(n,i),a.compileShader(n),!a.getShaderParameter(n,a.COMPILE_STATUS)){const c=a.getShaderInfoLog(n);throw a.deleteShader(n),new Error(`[shaderUtils] Shader compile error:
${c}

Source:
${i}`)}return n}function YM(a,e,i){const n=a.createProgram();if(!n)throw new Error("[shaderUtils] Failed to create program");if(a.attachShader(n,e),a.attachShader(n,i),a.linkProgram(n),!a.getProgramParameter(n,a.LINK_STATUS)){const c=a.getProgramInfoLog(n);throw a.deleteProgram(n),new Error(`[shaderUtils] Program link error:
${c}`)}return n}function St(a,e,i){const n=Op(a,a.VERTEX_SHADER,e),r=Op(a,a.FRAGMENT_SHADER,i);return YM(a,n,r)}function El(a){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]),i=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,i),a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW),i}const qM=`#version 300 es\r
precision mediump float;\r
\r
layout(location = 0) in vec2 aPosition;\r
uniform vec2 uOffset;\r
uniform vec2 uScale;\r
out vec2 vUV;\r
\r
void main() {\r
  vec2 pos = aPosition * uScale + uOffset;\r
  vUV = (aPosition + 1.0) / 2.0;\r
  gl_Position = vec4(pos, 0.0, 1.0);\r
}\r
`,jM=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
uniform sampler2D uTexture;\r
uniform float uAlpha;\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 texColor = texture(uTexture, vUV);\r
  fragColor = vec4(texColor.rgb, texColor.a * uAlpha);\r
}\r
`,Ss=2420,Fp=.1,KM=1;class ZM{constructor(e){this.texture=null,this.currentImageId=null,this.gl=e,this.program=St(e,qM,jM),this.quadBuffer=El(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.uOffset=e.getUniformLocation(this.program,"uOffset"),this.uScale=e.getUniformLocation(this.program,"uScale"),this.uTexture=e.getUniformLocation(this.program,"uTexture"),this.uAlpha=e.getUniformLocation(this.program,"uAlpha")}async loadImage(e){if(e!==this.currentImageId&&(this.currentImageId=e,this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null),!!e))try{const i=new Image;i.src=Mi(`/assets/backgrounds/${e}`),await i.decode();const n=document.createElement("canvas");n.width=i.width,n.height=i.height,n.getContext("2d").drawImage(i,0,0),this.texture=Rt(this.gl,n)}catch(i){console.warn(`[BackgroundPass] Failed to load background image '${e}'`,i)}}render(e){if(!this.texture)return;const i=this.gl,{width:n,height:r}=i.canvas,c=e.x*Fp,u=e.y*Fp,h=Math.ceil(n/Ss)+2,d=Math.ceil(r/Ss)+2,g=Math.floor(c/Ss)-1,m=Math.floor(u/Ss)-1,y=Ss/n,v=Ss/r;i.useProgram(this.program),i.bindVertexArray(this.vao),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.uTexture,0),i.uniform1f(this.uAlpha,KM);for(let M=0;M<d;M++)for(let S=0;S<h;S++){const T=(g+S)*Ss-c,w=(m+M)*Ss-u,A=T/n*2,R=-(w/r)*2;i.uniform2f(this.uOffset,A,R),i.uniform2f(this.uScale,y,v),i.drawArrays(i.TRIANGLE_STRIP,0,4)}i.bindVertexArray(null),i.useProgram(null)}destroy(){const e=this.gl;this.texture&&(e.deleteTexture(this.texture),this.texture=null),e.deleteBuffer(this.quadBuffer),e.deleteVertexArray(this.vao),e.deleteProgram(this.program)}}const QM=`#version 300 es\r
precision mediump float;\r
\r
layout(location = 0) in vec2 aPosition;\r
uniform vec2 uOffset;\r
uniform vec2 uScale;\r
out vec2 vUV;\r
\r
void main() {\r
  vec2 pos = aPosition * uScale + uOffset;\r
  vUV = vec2((aPosition.x + 1.0) / 2.0, 1.0 - (aPosition.y + 1.0) / 2.0);\r
  gl_Position = vec4(pos, 0.0, 1.0);\r
}\r
`,$M=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
uniform sampler2D uTexture;\r
uniform float uAlpha;\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 texColor = texture(uTexture, vUV);\r
  fragColor = vec4(texColor.rgb, texColor.a * uAlpha);\r
}\r
`,JM=1,Up=.2;class eT{constructor(e){this.camera=yt.getInstance(),this.planets=new Set,this.textureCache=new Map,this.imageSizeCache=new Map,this.gl=e,this.program=St(e,QM,$M),this.quadBuffer=El(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.uOffset=e.getUniformLocation(this.program,"uOffset"),this.uScale=e.getUniformLocation(this.program,"uScale"),this.uTexture=e.getUniformLocation(this.program,"uTexture"),this.uAlpha=e.getUniformLocation(this.program,"uAlpha")}addPlanet(e,i,n){this.planets.add({...e,scale:i,imagePath:n}),this.ensureTextureLoaded(n),console.log("[PlanetPass] Added planet:",e)}async ensureTextureLoaded(e){if(this.textureCache.has(e))return;console.log("[PlanetPass] Loading planet texture:",e);const i=Mi(e),n=new Image;n.src=i,await n.decode();const r=document.createElement("canvas");r.width=n.width,r.height=n.height,r.getContext("2d").drawImage(n,0,0);const c=Ib(this.gl,r);this.textureCache.set(e,c),this.imageSizeCache.set(e,{width:n.width,height:n.height})}renderAll(){const e=this.gl,{width:i,height:n}=e.canvas,r=this.camera.getPosition(),c=this.camera.getZoom();e.viewport(0,0,i,n),e.useProgram(this.program),e.bindVertexArray(this.vao),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);for(const u of this.planets){const h=this.textureCache.get(u.imagePath),d=this.imageSizeCache.get(u.imagePath);if(!h||!d)continue;const g=d.width*u.scale,m=d.height*u.scale;if(!this.isVisible(u.x,u.y,g,m))continue;const y=u.x-r.x,v=u.y-r.y,M=y*c,S=v*c,T=M/(i/2),w=-S/(n/2),A=g*c/i,R=m*c/n;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,h),e.uniform1i(this.uTexture,0),e.uniform1f(this.uAlpha,JM),e.uniform2f(this.uOffset,T,w),e.uniform2f(this.uScale,A,R),e.drawArrays(e.TRIANGLE_STRIP,0,4)}e.disable(e.BLEND),e.bindVertexArray(null),e.useProgram(null)}isVisible(e,i,n,r){const c=this.camera.getPosition(),u=this.camera.getZoom(),h=e-n/2,d=e+n/2,g=i-r/2,m=i+r/2,y=this.camera.getViewportWidth()/u,v=this.camera.getViewportHeight()/u,M=y*Up,S=v*Up,T=c.x-y/2-M,w=c.x+y/2+M,A=c.y-v/2-S,R=c.y+v/2+S;return!(d<T||h>w||m<A||g>R)}destroy(){const e=this.gl;for(const i of this.textureCache.values())e.deleteTexture(i);e.deleteBuffer(this.quadBuffer),e.deleteVertexArray(this.vao),e.deleteProgram(this.program)}}function Rl(a){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]),i=a.createBuffer();if(!i)throw new Error("[bufferUtils] Failed to create VBO");return a.bindBuffer(a.ARRAY_BUFFER,i),a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),i}const tT=`#version 300 es\r
precision mediump float;\r
\r
// Vertex attribute: quad corner position in local space (e.g., [-1,-1] to [1,1])\r
in vec2 a_position;\r
\r
// Output to fragment shader\r
out vec2 vScreenPos;\r
flat out int vInstanceID; // Pass instance index explicitly\r
\r
uniform vec2 uResolution;\r
\r
// Per-light data buffer\r
// Each light occupies 3 vec4s:\r
//   vec4[0] = [x, y, radius, unused]\r
//   vec4[1] = [r, g, b, intensity]\r
//   vec4[2] = [falloff, _, _, _]\r
layout(std140) uniform LightBlock {\r
  vec4 uLightData[30000];\r
};\r
\r
void main() {\r
  int idx = gl_InstanceID;\r
\r
  vec2 lightPos = uLightData[idx * 3 + 0].xy;\r
  float radius  = uLightData[idx * 3 + 0].z;\r
\r
  vec2 scaled   = a_position * radius;\r
  vec2 position = lightPos + scaled;\r
\r
  vec2 clip = (position / uResolution) * 2.0 - 1.0;\r
  clip.y = -clip.y; // Flip Y for screen-space\r
\r
  gl_Position = vec4(clip, 0.0, 1.0);\r
  vScreenPos = position;\r
  vInstanceID = idx;\r
}\r
`,iT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vScreenPos;\r
flat in int vInstanceID;\r
out vec4 fragColor;\r
\r
// Per-light data buffer\r
// Each light occupies 3 vec4s:\r
//   vec4[0] = [x, y, radius, unused]\r
//   vec4[1] = [r, g, b, intensity]\r
//   vec4[2] = [falloff, _, _, _]\r
layout(std140) uniform LightBlock {\r
  vec4 uLightData[30000]; // 5000 lights * 3 vec4s\r
};\r
\r
void main() {\r
  int idx = vInstanceID;\r
\r
  vec2  lightPos     = uLightData[idx * 3 + 0].xy;\r
  float radius       = uLightData[idx * 3 + 0].z;\r
\r
  vec3  color        = uLightData[idx * 3 + 1].rgb;\r
  float intensity    = uLightData[idx * 3 + 1].a;\r
\r
  float falloffParam = uLightData[idx * 3 + 2].x;\r
\r
  float dist     = distance(vScreenPos, lightPos);\r
  float normDist = clamp(dist / radius, 0.0, 1.0);\r
  float falloff  = pow(1.0 - normDist, 2.0) * falloffParam;\r
\r
  if (falloff < 0.001) discard;\r
\r
  fragColor = vec4(color * falloff * intensity, 0.0); // Alpha unused in additive blend\r
}\r
`,sT=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/lightingPassBeam.vert\r
\r
// Beam Vertex Shader - WebGL 2 version\r
in vec2 position;\r
out vec2 vPosition;\r
\r
void main() {\r
  vPosition = position * 0.5 + 0.5;\r
  gl_Position = vec4(position, 0.0, 1.0);\r
}`,nT=`#version 300 es\r
\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/lightingPassBeam.frag\r
\r
// Beam Fragment Shader - WebGL 2 version\r
in vec2 vPosition;\r
\r
uniform vec2 uStart;\r
uniform vec2 uEnd;\r
uniform float uWidth;\r
uniform vec4 uColor;\r
uniform float uIntensity;\r
uniform float uFalloff;\r
uniform vec2 uResolution;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // Convert UV coordinates to pixel coordinates\r
  vec2 fragPos = vPosition * uResolution;\r
  \r
  // Compute beam vector\r
  vec2 beamDir = uEnd - uStart;\r
  float beamLength = length(beamDir);\r
  \r
  // Handle degenerate case (zero-length beam)\r
  if (beamLength < 0.001) {\r
    fragColor = vec4(0.0);\r
    return;\r
  }\r
  \r
  vec2 normDir = beamDir / beamLength;\r
\r
  // Project fragment onto beam axis\r
  vec2 delta = fragPos - uStart;\r
  float t = clamp(dot(delta, normDir), 0.0, beamLength);\r
\r
  // Closest point on beam line segment\r
  vec2 closest = uStart + t * normDir;\r
  float dist = length(fragPos - closest);\r
\r
  // Gaussian falloff based on distance from beam centerline\r
  float falloff = exp(-pow(dist / max(uWidth, 0.1), 2.0)) * uFalloff;\r
\r
  vec4 finalColor = uColor * falloff * uIntensity;\r
  finalColor.a = falloff;\r
\r
  fragColor = finalColor;\r
}`,aT=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/lightingPassPost.vert\r
\r
// Post-processing Vertex Shader - WebGL 2 version\r
in vec2 position;\r
out vec2 vUV;\r
\r
void main() {\r
  vUV = position * 0.5 + 0.5;\r
  gl_Position = vec4(position, 0.0, 1.0);\r
}`,oT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
uniform sampler2D uTexture;\r
uniform float uMaxBrightness;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 color = texture(uTexture, vUV);\r
\r
  // Skip blending in pixels with no light contribution\r
  if (max(color.r, max(color.g, color.b)) < 0.001) {\r
    discard;\r
  }\r
\r
  // Brightness capping (ITU-R BT.709 luminance weighting)\r
  float brightness = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));\r
  if (brightness > uMaxBrightness) {\r
    color.rgb *= uMaxBrightness / brightness;\r
  }\r
\r
  fragColor = color;\r
}\r
`,Np=1e4,rh=12,Hp=2;class rT{constructor(e,i){this.ambientLight=[.2,.2,.25],this.framebufferWidth=0,this.framebufferHeight=0,this.framebufferDirty=!0,this.resolutionScale=.2,this.clearColor=[0,0,0,0],this.maxBrightness=1,this.gl=e,this.cameraUBO=i,this.lightProgram=St(e,tT,iT),this.beamProgram=St(e,sT,nT),this.postProgram=St(e,aT,oT),this.quadBuffer=Rl(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.lightUBO=e.createBuffer(),this.lightData=new Float32Array(Np*rh),e.bindBuffer(e.UNIFORM_BUFFER,this.lightUBO),e.bufferData(e.UNIFORM_BUFFER,this.lightData.byteLength,e.DYNAMIC_DRAW),e.bindBufferBase(e.UNIFORM_BUFFER,Hp,this.lightUBO);const n=e.getUniformBlockIndex(this.lightProgram,"LightBlock");n!==e.INVALID_INDEX&&e.uniformBlockBinding(this.lightProgram,n,Hp),this.colorTexture=e.createTexture(),this.framebuffer=e.createFramebuffer(),this.initializeFramebuffer(),this.compositeTexture=e.createTexture(),this.compositeFramebuffer=e.createFramebuffer(),this.initializeCompositeFramebuffer()}initializeFramebuffer(){const e=this.gl,i=Math.max(1,Math.floor(e.drawingBufferWidth*this.resolutionScale)),n=Math.max(1,Math.floor(e.drawingBufferHeight*this.resolutionScale));this.framebufferWidth=i,this.framebufferHeight=n,e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.colorTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}initializeCompositeFramebuffer(){const e=this.gl;e.bindTexture(e.TEXTURE_2D,this.compositeTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.framebufferWidth,this.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this.compositeFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.compositeTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}generateLightBuffer(e,i){const n=this.gl;this.framebufferDirty&&(this.initializeFramebuffer(),this.framebufferDirty=!1),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),n.viewport(0,0,this.framebufferWidth,this.framebufferHeight),n.clearColor(...this.clearColor),n.clear(n.COLOR_BUFFER_BIT),n.blendFunc(n.ONE,n.ONE),n.enable(n.BLEND),n.bindVertexArray(this.vao);let r=0;for(const c of e){if(c.type!=="point")continue;if(r>=Np)break;const u=i.worldToScreen(c.x,c.y),h=u.x*this.resolutionScale,d=u.y*this.resolutionScale,g=r*rh,[m,y,v,M]=this.hexToRgbaVec4(c.color);this.lightData[g+0]=h,this.lightData[g+1]=d,this.lightData[g+2]=c.radius*i.getZoom()*this.resolutionScale,this.lightData[g+3]=0,this.lightData[g+4]=m,this.lightData[g+5]=y,this.lightData[g+6]=v,this.lightData[g+7]=c.intensity,this.lightData[g+8]=c.animationPhase??1,this.lightData[g+9]=0,this.lightData[g+10]=0,this.lightData[g+11]=0,r++}n.bindBuffer(n.UNIFORM_BUFFER,this.lightUBO),n.bufferSubData(n.UNIFORM_BUFFER,0,this.lightData.subarray(0,r*rh)),n.useProgram(this.lightProgram),n.uniform2f(n.getUniformLocation(this.lightProgram,"uResolution"),this.framebufferWidth,this.framebufferHeight),n.drawArraysInstanced(n.TRIANGLE_STRIP,0,4,r);for(const c of e){if(c.type!=="beam")continue;n.useProgram(this.beamProgram),n.uniform2f(n.getUniformLocation(this.beamProgram,"uResolution"),this.framebufferWidth,this.framebufferHeight);const u=i.worldToScreen(c.start.x,c.start.y),h=i.worldToScreen(c.end.x,c.end.y),d=u.x*this.resolutionScale,g=this.framebufferHeight-u.y*this.resolutionScale,m=h.x*this.resolutionScale,y=this.framebufferHeight-h.y*this.resolutionScale;n.uniform2f(n.getUniformLocation(this.beamProgram,"uStart"),d,g),n.uniform2f(n.getUniformLocation(this.beamProgram,"uEnd"),m,y),n.uniform1f(n.getUniformLocation(this.beamProgram,"uWidth"),c.width*i.getZoom()*this.resolutionScale),n.uniform4fv(n.getUniformLocation(this.beamProgram,"uColor"),this.hexToRgbaVec4(c.color)),n.uniform1f(n.getUniformLocation(this.beamProgram,"uIntensity"),c.intensity),n.uniform1f(n.getUniformLocation(this.beamProgram,"uFalloff"),c.animationPhase??1),n.drawArrays(n.TRIANGLE_STRIP,0,4)}return n.disable(n.BLEND),n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),this.colorTexture}compositeLightingOverTarget(e){const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,e),i.viewport(0,0,i.drawingBufferWidth,i.drawingBufferHeight),i.useProgram(this.postProgram),i.bindVertexArray(this.vao),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.colorTexture),i.uniform1i(i.getUniformLocation(this.postProgram,"uTexture"),0),i.uniform1f(i.getUniformLocation(this.postProgram,"uMaxBrightness"),this.maxBrightness),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE),i.drawArrays(i.TRIANGLE_STRIP,0,4),i.disable(i.BLEND),i.bindFramebuffer(i.FRAMEBUFFER,null)}setAmbientLight(e){this.ambientLight=e}getAmbientLight(){return this.ambientLight}resize(){this.framebufferDirty=!0}destroy(){const e=this.gl;e.deleteProgram(this.lightProgram),e.deleteProgram(this.beamProgram),e.deleteProgram(this.postProgram),e.deleteBuffer(this.quadBuffer),e.deleteFramebuffer(this.framebuffer),e.deleteTexture(this.colorTexture),e.deleteVertexArray(this.vao),e.deleteBuffer(this.lightUBO),e.deleteFramebuffer(this.compositeFramebuffer),e.deleteTexture(this.compositeTexture)}hexToRgbaVec4(e){e.startsWith("#")&&(e=e.slice(1));const i=parseInt(e.slice(0,2),16)/255,n=parseInt(e.slice(2,4),16)/255,r=parseInt(e.slice(4,6),16)/255,c=e.length===8?parseInt(e.slice(6,8),16)/255:1;return[i,n,r,c]}}function lT(a){switch(a){case Qs.LIGHT:return To.FRACTURED;case Qs.MODERATE:case Qs.HEAVY:return To.CRUMBLING;case Qs.NONE:default:return To.NONE}}function cT(a,e){if(ni(a))return am(a,e);if(lm(a))return lS(a,lT(e));throw new Error(`Unrecognized block typeId: ${a}`)}let Gp=0,Jn=null;class $e{constructor(){this.lights=new Map,this.lightPool=[],this.cachedVisibleLights=[],this.lastCameraBounds=null,this.lightsDirty=!0}static getInstance(){return Jn||(Jn=new $e),Jn}static hasInstance(){return!!Jn}registerLight(e){e.id||(e.id=`light_${Gp++}`),this.lights.set(e.id,e),this.lightsDirty=!0}removeLight(e){const i=this.lights.get(e);i&&this.recycleLight(i),this.lights.delete(e),this.lightsDirty=!0}clear(){for(const e of this.lights.values())this.recycleLight(e);this.lights.clear(),this.lightsDirty=!0}update(e){for(const[i,n]of this.lights)if(n.life!==void 0&&n.maxLife!==void 0){if(n.life-=e,n.expires&&n.life<=0){this.recycleLight(n),this.lights.delete(i),this.lightsDirty=!0;continue}const r=Math.max(0,n.life/n.maxLife);n.fadeMode==="delayed"?n.animationPhase=r>=.1?1:r/.1:n.animationPhase=r}}collectVisibleLights(e){const i=e.getViewportBounds(),n=!this.lastCameraBounds||i.x!==this.lastCameraBounds.x||i.y!==this.lastCameraBounds.y||i.width!==this.lastCameraBounds.width||i.height!==this.lastCameraBounds.height;if(!this.lightsDirty&&!n)return this.cachedVisibleLights;const r=i.x,c=i.x+i.width,u=i.y,h=i.y+i.height;return this.cachedVisibleLights=Array.from(this.lights.values()).filter(d=>{switch(d.type){case"directional":return!0;case"point":case"spot":{const{x:g,y:m,radius:y}=d;return g+y>r&&g-y<c&&m+y>u&&m-y<h}default:return!0}}),this.lastCameraBounds=i,this.lightsDirty=!1,this.cachedVisibleLights}getLightCount(){return this.lights.size}getActiveLights(){return Array.from(this.lights.values())}getLightById(e){return this.lights.get(e)}getPooledLight(){return this.lightPool.pop()??{id:"",x:0,y:0,radius:32,color:"#ffffff",intensity:1,type:"point"}}updateLight(e,i){const n=this.lights.get(e);!n||n.type!=="point"||(Object.assign(n,i),this.lightsDirty=!0)}recycleLight(e){this.isPoolableLight(e)&&(e.id="",e.life=void 0,e.maxLife=void 0,e.animationPhase=void 0,this.lightPool.push(e))}isPoolableLight(e){return e.type==="point"}destroy(){Jn===this&&(this.clear(),this.lightPool.length=0,this.cachedVisibleLights.length=0,this.lastCameraBounds=null,Jn=null,Gp=0)}}class ws{constructor(){this.energy=100,this.maxEnergy=100,this.onEnergyChangeCallbacks=[],this.firingMode=Wt.Sequence}static getInstance(){return ws.instance||(ws.instance=new ws),ws.instance}initialize(e=100){this.energy=e,this.maxEnergy=e}getFiringMode(){return this.firingMode}setFiringMode(e){this.firingMode=e}getEnergy(){return this.energy}getMaxEnergy(){return this.maxEnergy}setEnergy(e){this.energy=Math.max(0,Math.min(this.maxEnergy,e)),this.notifyEnergyChange()}spendEnergy(e){return e>this.energy?!1:(this.energy-=e,this.notifyEnergyChange(),!0)}addEnergy(e){this.energy=Math.min(this.energy+e,this.maxEnergy),this.notifyEnergyChange()}onEnergyChange(e){this.onEnergyChangeCallbacks.push(e)}notifyEnergyChange(){for(const e of this.onEnergyChangeCallbacks)e(this.energy,this.maxEnergy)}reset(){this.energy=this.maxEnergy,this.notifyEnergyChange()}destroy(){this.energy=0,this.maxEnergy=0,this.onEnergyChangeCallbacks.length=0}}let uT=0;function hT(){return`point-light-${uT++}`}const Wp=.25;function si(a){a.intensity=a.intensity?a.intensity*Wp:Wp;const{x:e,y:i,radius:n=128,color:r="#ffffff",intensity:c=1,flicker:u=!1,life:h,expires:d=!1,id:g=hT(),fadeMode:m="linear"}=a;return{id:g,x:e,y:i,radius:n,color:r,intensity:c,flicker:u,life:h,maxLife:h,expires:d,type:"point",fadeMode:m}}const bo=new Map,zt={registerBlock(a,e){bo.set(a,e)},unregisterBlock(a){bo.delete(a)},getObject(a){return bo.get(a)},clear(){bo.clear()},size(){return bo.size}};function Um(a,e){const i=new Set,n=[e],r=u=>`${u.x},${u.y}`,c=u=>[{x:u.x+1,y:u.y},{x:u.x-1,y:u.y},{x:u.x,y:u.y+1},{x:u.x,y:u.y-1}];for(;n.length>0;){const u=n.pop(),h=r(u);if(!i.has(h)&&a.hasBlockAt(u)){i.add(h);for(const d of c(u)){const g=r(d);!i.has(g)&&a.hasBlockAt(d)&&n.push(d)}}}return i}function qe(a){return`${a.x},${a.y}`}function sn(a){const[e,i]=a.split(",").map(Number);return{x:e,y:i}}var ks=(a=>(a.Player="player",a.Enemy="enemy",a.Neutral="neutral",a))(ks||{});class Uh{constructor(e,i,n,r){if(this.blocks=new Map,this.blockToCoordMap=new Map,this.destroyed=!1,this.deathTimestamp=null,this.totalMass=null,this.immoveable=!1,this.collidingUntil=0,this.grid=e,this.id=this.generateId(),this.faction=r??ks.Neutral,this.transform={position:(n==null?void 0:n.position)??{x:0,y:0},velocity:(n==null?void 0:n.velocity)??{x:0,y:0},rotation:(n==null?void 0:n.rotation)??0,angularVelocity:(n==null?void 0:n.angularVelocity)??0},i)for(const[c,u]of i)this.blocks.set(qe(c),u),this.grid.addBlockToCell(u),this.blockToCoordMap.set(u,c),zt.registerBlock(u,this)}update(e){}onDestroyed(){}setFaction(e){this.faction=e}getFaction(){return this.faction}placeBlock(e,i){const n=qe(e);this.blocks.set(n,i),this.grid.addBlockToCell(i),this.blockToCoordMap.set(i,e),zt.registerBlock(i,this),this.invalidateMass()}getBlock(e){return this.blocks.get(qe(e))}hasBlockAt(e){return this.blocks.has(qe(e))}getBlockMap(){return this.blocks}getAllBlocks(){return Array.from(this.blocks.entries()).map(([e,i])=>[sn(e),i])}getBlockCount(){return this.blocks.size}getCenterBlock(){return this.blocks.get("0,0")}getBlockCoord(e){return this.blockToCoordMap.get(e)??null}getBlocksWithinGridDistance(e,i){const n=[];for(const[r,c]of this.getAllBlocks()){const u=this.getBlockCoord(c);if(!u)continue;const h=Math.abs(u.x-e.x),d=Math.abs(u.y-e.y);Math.max(h,d)<=i&&n.push(c)}return n}hideAllBlocks(){for(const e of this.blocks.values())e.hidden=!0}showAllBlocks(){for(const e of this.blocks.values())e.hidden=!1}findBlockCoord(e){for(const[i,n]of this.blocks.entries())if(n===e)return sn(i);return null}removeBlock(e){const i=qe(e),n=this.blocks.get(i);n&&(zt.unregisterBlock(n),this.grid.removeBlockFromCell(n),this.blocks.delete(i),this.blockToCoordMap.delete(n),this.invalidateMass())}removeBlocks(e,i){const n=i??[];if(i)for(const r of i){const c=this.blockToCoordMap.get(r);c&&this.blocks.delete(qe(c)),this.blockToCoordMap.delete(r)}else for(const r of e){const c=qe(r),u=this.blocks.get(c);u&&(n.push(u),this.blocks.delete(c),this.blockToCoordMap.delete(u))}for(const r of n)zt.unregisterBlock(r);this.grid.removeBlocksFromCells(n),this.invalidateMass()}getTransform(){return this.transform}setTransform(e){this.transform={...e},this.updateBlockPositions()}getGrid(){return this.grid}setImmoveable(e){this.immoveable=e}isImmoveable(){return this.immoveable}setColliding(e,i=100){e&&(this.collidingUntil=performance.now()+i)}isColliding(){return performance.now()<this.collidingUntil}getBlockWorldPosition(e){const i=this.getBlockCoord(e);return i?this.calculateBlockWorldPosition(i):{x:0,y:0}}calculateBlockWorldPosition(e){const{position:i,rotation:n}=this.transform,{x:r,y:c}=i,u=Math.cos(n),h=Math.sin(n),d=r+e.x*32*u-e.y*32*h,g=c+e.x*32*h+e.y*32*u;return{x:d,y:g}}updateBlockPositions(){for(const[e,i]of this.blocks.entries()){const n=sn(e);this.grid.removeBlockFromCell(i),i.position=this.calculateBlockWorldPosition(n),this.grid.addBlockToCell(i)}}getTotalMass(){if(this.totalMass==null){let e=0;for(const i of this.blocks.values())e+=i.type.mass;this.totalMass=e}return this.totalMass}invalidateMass(){this.totalMass=null}destroy(){if(!this.destroyed){this.destroyed=!0,this.deathTimestamp=performance.now();for(const e of this.blocks.values())this.grid.removeBlockFromCell(e);this.blocks.clear(),this.blockToCoordMap.clear(),this.onDestroyed()}}isDestroyed(){return this.destroyed}isVisuallyExpired(e=2e3){return!this.destroyed||this.deathTimestamp===null?!1:performance.now()-this.deathTimestamp>e}getTimeSinceDeath(){return!this.destroyed||this.deathTimestamp===null?0:performance.now()-this.deathTimestamp}isDeletionSafe(e){const i=qe(e);if(!this.blocks.has(i))return!0;const n=new Map(this.blocks);n.delete(i);const r=[...n.keys()][0];if(!r)return!0;const c=new Set,u=[r];for(;u.length>0;){const h=u.pop();if(c.has(h))continue;c.add(h);const{x:d,y:g}=sn(h),m=[{x:d+1,y:g},{x:d-1,y:g},{x:d,y:g+1},{x:d,y:g-1}];for(const y of m){const v=qe(y);n.has(v)&&!c.has(v)&&u.push(v)}}return c.size===n.size}loadFromJson(e){const{position:i,velocity:n,rotation:r,angularVelocity:c}=e.transform;this.transform.position=i,this.transform.velocity=n,this.transform.rotation=r,this.transform.angularVelocity=c,e.blocks.forEach(u=>{const h=ni(u.id);if(!h){console.warn(`Unknown block type during deserialization: ${u.id}`);return}const d=crypto.randomUUID(),g={ownerFaction:ks.Neutral,id:d,type:h,rotation:u.rotation??0,hp:h.armor,ownerShipId:this.id,position:{x:0,y:0}},m=qe(u.coord);this.blocks.set(m,g),this.blockToCoordMap.set(g,u.coord),this.grid.addBlockToCell(g)}),this.invalidateMass(),this.updateBlockPositions()}generateId(){return"entity-"+Math.random().toString(36).slice(2,10)}}class fT{constructor(e,i){this.timeSinceLastUse=0,this.rechargeDelay=.25,this.max=e,this.current=e,this.rechargePerSecond=i}update(e){this.timeSinceLastUse+=e,this.timeSinceLastUse>=this.rechargeDelay&&(this.current=Math.min(this.current+this.rechargePerSecond*e,this.max))}spend(e){return this.current<e?!1:(this.current-=e,this.timeSinceLastUse=0,!0)}add(e){this.current=Math.min(this.current+e,this.max)}reset(){this.current=this.max,this.timeSinceLastUse=0}getCurrent(){return this.current}getMax(){return this.max}setMax(e){this.max=e,this.current=Math.min(this.current,e)}setRechargeRate(e){this.rechargePerSecond=e}setMaxEnergy(e){this.max=e,this.current=Math.min(this.current,e)}}const Ms=class Ms{constructor(e,i){this.activeVisuals=[],this.shieldedBlocks=new Set,this.ctx=e.getContext("fx"),this.camera=i}static getInstance(){if(!Ms.instance)throw new Error("ShieldEffectsSystem not initialized. Call initialize(canvasManager, camera) first.");return Ms.instance}static initialize(e,i){Ms.instance||(Ms.instance=new Ms(e,i))}registerShield(e,i){this.activeVisuals.push({block:e,radius:i,age:0})}registerShieldedBlock(e){this.shieldedBlocks.add(e)}unregisterShieldedBlock(e){this.shieldedBlocks.delete(e)}clearShieldedBlocks(){this.shieldedBlocks.clear()}clearVisualsForShip(e){this.activeVisuals=this.activeVisuals.filter(i=>i.block.ownerShipId!==e);for(const i of Array.from(this.shieldedBlocks))i.ownerShipId===e&&this.shieldedBlocks.delete(i)}update(e){for(const i of this.activeVisuals)i.age+=e;this.activeVisuals=this.activeVisuals.filter(i=>{var n;return((n=i.block.type.behavior)==null?void 0:n.shieldRadius)!=null||i.block.isShielded})}render(){const e=this.ctx;e.save(),e.scale(this.camera.getZoom(),this.camera.getZoom());for(const i of this.activeVisuals){const n=i.block.position;if(!n)continue;const r=this.camera.worldToScreen(n.x,n.y),c=r.x/this.camera.getZoom(),u=r.y/this.camera.getZoom(),h=i.radius,d=.75+.1*Math.sin(i.age*3),g=Dm[i.block.type.id]??["#88ddff","#44bbff","#00aaff"],[m,y,v]=g,M=e.createRadialGradient(c,u,0,c,u,h);M.addColorStop(0,m+`${Math.floor(d*255).toString(16).padStart(2,"0")}`),M.addColorStop(1,v+"00"),e.globalAlpha=d,e.fillStyle=M,e.beginPath(),e.arc(c,u,h,0,Math.PI*2),e.fill()}for(const i of this.shieldedBlocks){const n=Tt.getInstance().getById(i.ownerShipId);if(!n)continue;const r=n.getBlockCoord(i);if(!r)continue;const c=n.getTransform(),u=r.x*z,h=r.y*z,d=Math.cos(c.rotation),g=Math.sin(c.rotation),m=u*d-h*g,y=u*g+h*d,v=c.position.x+m,M=c.position.y+y,S=this.camera.worldToScreen(v,M);e.save(),e.translate(S.x/this.camera.getZoom(),S.y/this.camera.getZoom()),e.rotate(c.rotation);const T=i.shieldHighlightColor??"rgba(255, 0, 0, 0.4)";xm(e,i.type.id,i.rotation,T),e.restore()}e.restore()}clear(){this.activeVisuals.length=0,this.shieldedBlocks.clear()}};Ms.instance=null;let Xi=Ms;class dT{constructor(e){this.active=!1,this.protectedBlocks=new Set,this.ownerShip=e}recalculateCoverage(){var r,c;for(const u of this.protectedBlocks)u.isShielded=!1,u.shieldEfficiency=void 0,u.shieldHighlightColor=void 0,u.shieldSourceId=void 0;this.protectedBlocks.clear();const e=this.ownerShip.getShieldBlocks(),i=Array.from(e),n=Xi.getInstance();if(n.clearVisualsForShip(this.ownerShip.id),i.length===0){this.deactivate();return}for(const u of i){const h=this.ownerShip.getBlockCoord(u);if(!h)continue;const d=((r=u.type.behavior)==null?void 0:r.shieldRadius)??0,g=((c=u.type.behavior)==null?void 0:c.shieldEfficiency)??0,m=U2[u.type.id]??"rgba(100, 255, 255, 0.4)",y=this.ownerShip.getBlocksWithinGridDistance(h,d);for(const v of y){this.protectedBlocks.add(v);const M=v.shieldEfficiency??0;g>=M&&(v.shieldEfficiency=g,v.shieldHighlightColor=m,v.shieldSourceId=u.type.id),this.active&&(v.isShielded=!0,n.registerShieldedBlock(v))}if(this.active){const v=d*z;n.registerShield(u,v)}}}activate(){var i;this.active=!0,this.recalculateCoverage();const e=Xi.getInstance();e.clearVisualsForShip(this.ownerShip.id);for(const n of this.protectedBlocks)n.isShielded=!0,e.registerShieldedBlock(n);for(const n of this.ownerShip.getShieldBlocks()){const c=(((i=n.type.behavior)==null?void 0:i.shieldRadius)??0)*z;e.registerShield(n,c)}}deactivate(){this.active=!1,Xi.getInstance().clearVisualsForShip(this.ownerShip.id);for(const i of this.protectedBlocks)i.isShielded=!1,i.shieldEfficiency=void 0,i.shieldHighlightColor=void 0,i.shieldSourceId=void 0}isActive(){return this.active}hasShieldBlocks(){for(const e of this.ownerShip.getShieldBlocks())return!0;return!1}}class gT{constructor(e,i=5,n=5){this.BASE_MAX_FUEL=100,this.RECHARGE_DURATION_SECONDS=8,this.speedMultiplier=1.5,this.accelerationMultiplier=2,this.pulseMultiplier=1.5,this.superPulseBonusMultiplier=.5,this.TRIGGER_COOLDOWN=1,this.triggerCooldownRemaining=0,this.PULSE_WINDOW=.4,this.PULSE_DURATION=6,this.PULSE_COOLDOWN=2,this.PULSE_PERFECT_WINDOW=.2,this.pulsePerfectTimingFuelRefundAmount=25,this.pulseDurationRemaining=0,this.pulseCooldownRemaining=0,this.superPulseDurationRemaining=0,this.afterburnerJustActivated=!1,this.pulseJustActivated=!1,this.superPulseJustActivated=!1,this.lastDeactivationTime=null,this.active=!1,this.max=e,this.current=e,this.rechargePerSecond=e/this.RECHARGE_DURATION_SECONDS,this.consumptionPerSecond=n}update(e){if(this.triggerCooldownRemaining>0&&(this.triggerCooldownRemaining-=e,this.triggerCooldownRemaining<0&&(this.triggerCooldownRemaining=0)),this.active){const i=this.consumptionPerSecond*e;this.current-=i,this.current<=0&&(this.current=0,this.active=!1,this.lastDeactivationTime=performance.now()/1e3,this.pulseDurationRemaining=0)}else this.rechargePerSecond>0&&(this.current=Math.min(this.current+this.rechargePerSecond*e,this.max));this.pulseDurationRemaining>0&&(this.pulseDurationRemaining-=e,this.pulseDurationRemaining<=0&&(this.pulseDurationRemaining=0)),this.superPulseDurationRemaining>0&&(this.superPulseDurationRemaining-=e,this.superPulseDurationRemaining<=0&&(this.superPulseDurationRemaining=0)),this.pulseCooldownRemaining>0&&(this.pulseCooldownRemaining-=e,this.pulseCooldownRemaining<0&&(this.pulseCooldownRemaining=0))}consume(e){return this.current<e?!1:(this.current-=e,!0)}refill(e){this.current=Math.min(this.current+e,this.max)}reset(){this.current=this.max,this.active=!1,this.lastDeactivationTime=null,this.pulseDurationRemaining=0,this.pulseCooldownRemaining=0,this.pulseJustActivated=!1,this.superPulseJustActivated=!1}setActive(e){const i=performance.now()/1e3;if(e){if(this.active)return!0;if(this.triggerCooldownRemaining>0)return!1;if(this.current>=10){const n=this.lastDeactivationTime!==null?i-this.lastDeactivationTime:1/0;return this.pulseCooldownRemaining<=0&&n<=this.PULSE_WINDOW&&(this.pulseDurationRemaining=this.PULSE_DURATION,this.pulseCooldownRemaining=this.PULSE_COOLDOWN,this.pulseJustActivated=!0,n>=this.PULSE_WINDOW-this.PULSE_PERFECT_WINDOW&&(this.current=Math.min(this.current+this.pulsePerfectTimingFuelRefundAmount,this.max),this.superPulseJustActivated=!0,this.superPulseDurationRemaining=this.PULSE_DURATION)),this.active=!0,this.triggerCooldownRemaining=this.TRIGGER_COOLDOWN,this.afterburnerJustActivated=!0,!0}return!1}else return this.active&&(this.lastDeactivationTime=i),this.active=!1,!1}isActive(){return this.active}isPulsing(){return this.pulseDurationRemaining>0}getCurrent(){return this.current}getMax(){return this.max}setMax(e){this.max=e+this.BASE_MAX_FUEL,this.current=Math.min(this.current,this.max),this.rechargePerSecond=this.max/this.RECHARGE_DURATION_SECONDS}getConsumptionRatePerSecond(){return this.consumptionPerSecond}setConsumptionRatePerSecond(e){this.consumptionPerSecond=e}getSpeedMultiplier(){const e=this.getPulseDecayFactor(),i=this.getSuperPulseDecayFactor();return this.speedMultiplier+this.pulseMultiplier*e+this.superPulseBonusMultiplier*i}getAccelerationMultiplier(){const e=this.getPulseDecayFactor(),i=this.getSuperPulseDecayFactor();return this.accelerationMultiplier+this.pulseMultiplier*e+this.superPulseBonusMultiplier*i}getPulseMultiplier(){return this.pulseMultiplier}getPulseDecayFactor(){return this.pulseDurationRemaining>0?this.pulseDurationRemaining/this.PULSE_DURATION:0}wasAfterburnerJustActivated(){const e=this.afterburnerJustActivated;return this.afterburnerJustActivated=!1,e}wasPulseJustActivated(){const e=this.pulseJustActivated;return this.pulseJustActivated=!1,e}wasSuperPulseJustActivated(){const e=this.superPulseJustActivated;return this.superPulseJustActivated=!1,e}getPulseCooldownRemaining(){return this.pulseCooldownRemaining}wouldTriggerPulseNow(){const e=performance.now()/1e3;return this.pulseCooldownRemaining<=0&&this.lastDeactivationTime!==null&&e-this.lastDeactivationTime<=this.PULSE_WINDOW}getPulseWindowRemaining(){if(this.lastDeactivationTime===null)return 0;const i=performance.now()/1e3-this.lastDeactivationTime;return Math.max(0,this.PULSE_WINDOW-i)}getSuperPulseWindowRemaining(){if(this.lastDeactivationTime===null)return 0;const i=performance.now()/1e3-this.lastDeactivationTime,n=this.PULSE_WINDOW-this.PULSE_PERFECT_WINDOW;return i<n||i>this.PULSE_WINDOW?0:Math.max(0,this.PULSE_WINDOW-i)}getSuperPulseDecayFactor(){return this.superPulseDurationRemaining>0?this.superPulseDurationRemaining/this.PULSE_DURATION:0}}class It extends Uh{constructor(e,i,n,r,c,u){super(e,i,n),this.afterburnerComponent=null,this.energyComponent=null,this.shieldBlocks=new Set,this.fuelTankBlocks=new Set,this.firingPlan=[],this.firingPlanIndex=new Map,this.turretSequenceState={},this.firingMode=Wt.Synced,this.harvesterBlocks=new Map,this.haloBladeBlocks=new Map,this.destroyedListeners=[],this.lightAuraId=null,this.thrusting=!0,this.strafingLeft=!1,this.strafingRight=!1,this.affixes={},this.shieldComponent=new dT(this),this.afterburnerComponent=new gT(100,5),this.validateFiringPlan(),this.isPlayerShip=r??!1,this.affixes=c??{},this.faction=u??ks.Enemy}generateId(){return"ship-"+Math.random().toString(36).slice(2,9)}getIsPlayerShip(){return this.isPlayerShip}setIsPlayerShip(e){this.isPlayerShip=e}getAffixes(){return this.affixes}setAffixes(e){this.affixes=e}getAfterburnerComponent(){return this.afterburnerComponent}triggerAfterburner(){this.afterburnerComponent&&this.afterburnerComponent.setActive(!0)}deactivateAfterburner(){this.afterburnerComponent&&this.afterburnerComponent.setActive(!1)}isAfterburnerActive(){var e;return((e=this.afterburnerComponent)==null?void 0:e.isActive())??!1}getAfterburnerSpeedMultiplier(){var e;return((e=this.afterburnerComponent)==null?void 0:e.getSpeedMultiplier())??1}getAfterburnerAccelMultiplier(){var e;return((e=this.afterburnerComponent)==null?void 0:e.getAccelerationMultiplier())??1}registerAuraLight(e="#ffffff",i=64,n=1.25){if(!$e.hasInstance())return;const r=$e.getInstance();this.lightAuraId=`aura-${this.id}`;const c=si({id:this.lightAuraId,x:this.getTransform().position.x,y:this.getTransform().position.y,radius:i,color:e,intensity:n});r.registerLight(c)}cleanupAuraLight(){this.lightAuraId&&($e.getInstance().removeLight(this.lightAuraId),this.lightAuraId=null)}getLightAuraId(){return this.lightAuraId}isThrusting(){return this.thrusting}isStrafingLeft(){return this.strafingLeft}isStrafingRight(){return this.strafingRight}setThrusting(e){this.thrusting=e}setStrafingLeft(e){this.strafingLeft=e}setStrafingRight(e){this.strafingRight=e}getCockpit(){return this.blocks.get(qe({x:0,y:0}))}getCockpitHp(){const e=this.getCockpit();return e?e.hp:(console.warn(`[Ship ${this.id}] Cockpit block missing.`),null)}getCockpitCoord(){if(this.getCockpit())return{x:0,y:0}}getFiringPlan(){return this.firingPlan}getFiringMode(){return this.firingMode}setFiringMode(e){this.firingMode=e,this.isPlayerShip&&ws.getInstance().setFiringMode(e)}validateFiringPlan(){const e=[],i=new Map;for(const n of this.firingPlan)if(this.blocks.has(qe(n.coord))&&this.blocks.get(qe(n.coord))===n.block){const c=e.length;e.push(n),i.set(n.block,c)}this.firingPlan=e,this.firingPlanIndex=i}addWeaponToPlanIfApplicable(e,i){var u,h,d;const n=(u=i.type.behavior)==null?void 0:u.fire;if(!n||!((d=(h=i.type)==null?void 0:h.behavior)!=null&&d.canFire))return;const r={coord:e,block:i,fireRate:n.fireRate||1,fireCooldown:1/(n.fireRate||1),timeSinceLastShot:0},c=this.firingPlan.length;this.firingPlan.push(r),this.firingPlanIndex.set(i,c)}removeWeaponFromPlanIfApplicable(e){const i=this.firingPlanIndex.get(e);if(i===void 0)return;const n=this.firingPlan.length-1,r=this.firingPlan[n];i!==n&&(this.firingPlan[i]=r,this.firingPlanIndex.set(r.block,i)),this.firingPlan.pop(),this.firingPlanIndex.delete(e)}removeWeaponsFromPlan(e){if(e.length===0)return;const i=new Set(e),n=[],r=new Map;for(const c of this.firingPlan)if(!i.has(c.block)){const u=n.length;n.push(c),r.set(c.block,u)}this.firingPlan=n,this.firingPlanIndex=r}resetTurretSequenceState(){this.turretSequenceState={}}getFuelTankBlocks(){return this.fuelTankBlocks}updateFuelCapacity(){let e=0;for(const i of this.fuelTankBlocks){const n=i.type.behavior;n!=null&&n.fuelCapacityIncrease&&(e+=n.fuelCapacityIncrease)}this.afterburnerComponent&&this.afterburnerComponent.setMax(e)}getEnergyComponent(){return this.energyComponent}getShieldComponent(){return this.shieldComponent}getShieldBlocks(){return this.shieldBlocks}updateEnergy(e){var i;(i=this.energyComponent)==null||i.update(e)}recomputeEnergyStats(){this.energyComponent||this.enableEnergyComponent();const e=this.getEnergyComponent();if(!e)return;const{max:i,regen:n}=this.computeEnergyStats();e.setMax(i),e.setRechargeRate(n)}enableEnergyComponent(){if(this.energyComponent)return;const{max:e,regen:i}=this.computeEnergyStats();e!==0&&(this.energyComponent=new fT(e,i))}computeEnergyStats(){let e=0,i=0;for(const[,n]of this.blocks.entries()){const r=n.type.behavior;r!=null&&r.energyMaxIncrease&&(e+=r.energyMaxIncrease),r!=null&&r.energyChargeRate&&(i+=r.energyChargeRate)}return{max:e,regen:i>0?i:10}}getHaloBladeBlocks(){return this.haloBladeBlocks}getTotalHarvestRate(){let e=0;for(const i of this.harvesterBlocks.values())e+=i;return e}rebuildHaloBladeIndex(){var e;this.haloBladeBlocks.clear();for(const[,i]of this.blocks.entries()){const n=(e=i.type.behavior)==null?void 0:e.haloBladeProperties;n&&this.haloBladeBlocks.set(i,n)}}placeBlockById(e,i,n){const r=ni(i);if(!r)throw new Error(`Unknown block type: ${i}`);const c=qe(e);if(this.blocks.has(c))return!1;const u=this.calculateBlockWorldPosition(e),h=crypto.randomUUID(),d={ownerFaction:this.faction,id:h,type:r,hp:r.armor,ownerShipId:this.id,position:u,...n!==void 0?{rotation:n}:{}};return this.placeBlock(e,d),!0}placeBlock(e,i){var u,h,d;const n=qe(e);this.blocks.set(n,i),this.grid.addBlockToCell(i),this.blockToCoordMap.set(i,e),zt.registerBlock(i,this),(u=i.type.behavior)!=null&&u.shieldRadius&&this.shieldBlocks.add(i);const r=(h=i.type.behavior)==null?void 0:h.harvestRate;r&&this.harvesterBlocks.set(i,r);const c=(d=i.type.behavior)==null?void 0:d.haloBladeProperties;c&&this.haloBladeBlocks.set(i,c),i.type.id.startsWith("fuelTank")&&this.fuelTankBlocks.add(i),this.updateFuelCapacity(),this.invalidateMass(),this.recomputeEnergyStats(),this.addWeaponToPlanIfApplicable(e,i),this.shieldComponent.recalculateCoverage()}removeBlock(e){const i=qe(e),n=this.blocks.get(i);n&&(this.grid.removeBlockFromCell(n),this.blockToCoordMap.delete(n),this.harvesterBlocks.delete(n),this.shieldBlocks.delete(n),this.haloBladeBlocks.delete(n),this.fuelTankBlocks.delete(n),this.removeWeaponFromPlanIfApplicable(n),zt.unregisterBlock(n)),this.blocks.delete(i),this.updateFuelCapacity(),this.invalidateMass(),this.recomputeEnergyStats(),this.shieldComponent.recalculateCoverage()}removeBlocks(e,i){if(e.length===0)return;const n=i??[];if(i)for(const r of i){const c=this.blockToCoordMap.get(r);if(c){const u=qe(c);this.blocks.delete(u)}this.blockToCoordMap.delete(r)}else for(const r of e){const c=qe(r),u=this.blocks.get(c);u&&(n.push(u),this.blocks.delete(c),this.blockToCoordMap.delete(u))}if(n.length!==0){this.grid.removeBlocksFromCells(n);for(const r of n)this.harvesterBlocks.delete(r),this.shieldBlocks.delete(r),this.haloBladeBlocks.delete(r),this.fuelTankBlocks.delete(r),zt.unregisterBlock(r);this.removeWeaponsFromPlan(n),this.updateFuelCapacity(),this.invalidateMass(),this.recomputeEnergyStats(),this.shieldComponent.recalculateCoverage()}}isDeletionSafe(e){var h;const i=qe(e);if(!this.blocks.has(i))return!0;const n=new Map(this.blocks);n.delete(i);const r=((h=[...n.entries()].find(([,d])=>d.type.id.startsWith("cockpit")))==null?void 0:h[0])??[...n.keys()][0];if(!r)return!0;const c=new Set,u=[r];for(;u.length>0;){const d=u.pop();if(c.has(d))continue;c.add(d);const{x:g,y:m}=sn(d),y=[{x:g+1,y:m},{x:g-1,y:m},{x:g,y:m+1},{x:g,y:m-1}];for(const v of y){const M=qe(v);n.has(M)&&!c.has(M)&&u.push(M)}}return c.size===n.size}loadFromJson(e){const i=this.getTransform();i.position=e.transform.position,i.rotation=e.transform.rotation,e.blocks.forEach(n=>{const{coord:r,id:c,rotation:u}=n;this.placeBlockById(r,c,u)}),this.updateFuelCapacity(),this.validateFiringPlan(),this.rebuildHaloBladeIndex()}destroyInstantly(){if(!this.destroyed){this.destroyed=!0,this.deathTimestamp=performance.now()-1e4;for(const e of this.blocks.values())this.grid.removeBlockFromCell(e);this.blocks.clear(),this.blockToCoordMap.clear(),this.cleanupAuraLight();for(const e of this.destroyedListeners)e(this);this.destroyedListeners.length=0}}onDestroyedCallback(e){if(this.destroyed){e(this);return}this.destroyedListeners.push(e)}onDestroyed(){this.cleanupAuraLight();for(const e of this.destroyedListeners)e(this);this.destroyedListeners.length=0}}const pT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 position;\r
\r
layout(std140) uniform CameraBlock {\r
  mat4 uProjectionMatrix;\r
  mat4 uViewMatrix;\r
};\r
\r
uniform mat4 uModelMatrix;\r
uniform vec2 uBlockPosition;\r
uniform float uBlockRotation;\r
uniform vec2 uBlockScale;\r
\r
out vec2 vUV;\r
out vec2 vScreenUV;\r
\r
void main() {\r
  vUV = vec2(position.x * 0.5 + 0.5, 1.0 - (position.y * 0.5 + 0.5));\r
\r
  vec2 scaledPosition = position * uBlockScale * 0.5;\r
  vec2 flippedPosition = vec2(scaledPosition.x, -scaledPosition.y);\r
\r
  float cos_rot = cos(uBlockRotation);\r
  float sin_rot = sin(uBlockRotation);\r
  vec2 rotatedPosition = vec2(\r
    flippedPosition.x * cos_rot - flippedPosition.y * sin_rot,\r
    flippedPosition.x * sin_rot + flippedPosition.y * cos_rot\r
  );\r
\r
  vec2 blockWorldPosition = rotatedPosition + uBlockPosition;\r
\r
  vec4 worldPos = uModelMatrix * vec4(blockWorldPosition, 0.0, 1.0);\r
  vec4 viewPos = uViewMatrix * worldPos;\r
  gl_Position = uProjectionMatrix * viewPos;\r
\r
  // derive screen UV from clip-space coordinates\r
  vScreenUV = gl_Position.xy / gl_Position.w * 0.5 + 0.5;\r
}\r
`,mT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
in vec2 vScreenUV; // passed from vertex shader\r
out vec4 outColor;\r
\r
uniform sampler2D uTexture;\r
uniform sampler2D uLightMap;\r
\r
uniform float uTime;\r
uniform float uGlowStrength;\r
uniform float uEnergyPulse;\r
uniform vec3 uChargeColor;\r
uniform float uSheenStrength;\r
uniform vec3 uCollisionColor;\r
uniform bool uUseCollisionColor;\r
uniform vec3 uAmbientLight;\r
\r
void main() {\r
  vec4 base = texture(uTexture, vUV);\r
  if (base.a < 0.01) discard;\r
\r
  // === Lightmap Sampling ===\r
  vec3 lightSample = texture(uLightMap, vScreenUV).rgb;\r
  vec3 effectiveLight = max(lightSample, uAmbientLight); // clamp floor\r
  \r
  // Darken base by ambient light floor\r
  vec3 ambiented = base.rgb * uAmbientLight;\r
\r
  // Modulate with light texture\r
  vec3 modulated = base.rgb * lightSample;\r
\r
  // Additive bloom-style wrap lighting\r
  vec3 additive = lightSample * 0.7;\r
\r
  // Final mix: ambient base + modulated + additive bloom\r
  base.rgb = ambiented + modulated * 0.6 + additive * 0.4;\r
\r
  // === Radial Charge Bloom ===\r
  vec2 centeredUV = vUV - 0.5;\r
  float dist = length(centeredUV);\r
\r
  float wavePhase = uTime * 3.0 - dist * 8.0;\r
  float pulse = sin(wavePhase) * 0.5 + 0.5;\r
  pulse = pow(pulse, 2.0);\r
\r
  float innerRadius = 0.1;\r
  float outerRadius = 0.4;\r
  float falloff = 1.0 - smoothstep(innerRadius, outerRadius, dist);\r
  falloff = pow(falloff, 1.5);\r
\r
  float energy = pulse * falloff * uEnergyPulse;\r
  base.rgb += uChargeColor * energy * 0.8;\r
\r
  // === Pulsating Glow ===\r
  float breathe = sin(uTime * 2.5) * 0.3 + 0.7;\r
  breathe = smoothstep(0.4, 1.0, breathe);\r
  base.rgb += base.rgb * uGlowStrength * breathe * 0.3;\r
\r
  // === Metallic Sheen ===\r
  if (uSheenStrength > 0.0) {\r
    vec2 centeredUV = vUV - 0.5;\r
    float dist = length(centeredUV);\r
\r
    float radialFalloff = 1.0 - smoothstep(0.0, 0.7, dist);\r
    radialFalloff = pow(radialFalloff, 0.8);\r
\r
    float noise = sin(vUV.x * 12.0) * sin(vUV.y * 8.0) * 0.1 + 0.9;\r
\r
    float metallic = radialFalloff * noise;\r
\r
    vec3 metallicColor = base.rgb * 1.2 + vec3(0.05, 0.05, 0.1);\r
    base.rgb = mix(base.rgb, metallicColor, uSheenStrength * metallic * 0.3);\r
\r
    base.rgb += uSheenStrength * metallic * 0.15;\r
  }\r
\r
  // === Collision Red Override ===\r
  if (uUseCollisionColor) {\r
    base.rgb = uCollisionColor;\r
  }\r
\r
  outColor = base;\r
}\r
`;function Nm(a,e,i,n){const r=e-a,c=n-i;return new Float32Array([2/r,0,0,0,0,2/c,0,0,0,0,-1,0,-(e+a)/r,-(n+i)/c,0,1])}function Nh(a,e){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,a,e,0,1])}function yT(a){const e=Math.cos(a),i=Math.sin(a);return new Float32Array([e,i,0,0,-i,e,0,0,0,0,1,0,0,0,0,1])}function vT(a,e){const i=new Float32Array(16);for(let n=0;n<4;n++)for(let r=0;r<4;r++)i[n*4+r]=a[n*4+0]*e[0*4+r]+a[n*4+1]*e[1*4+r]+a[n*4+2]*e[2*4+r]+a[n*4+3]*e[3*4+r];return i}function bT(a){return a==="battery1"||a==="reactor1"||a==="shield1"?[.2,.6,1]:a==="battery2"||a==="reactor2"||a==="shield3"?[.8,.5,1]:a==="shield2"?[.3,1,.4]:null}function ST(a){return a.startsWith("hull")||a.startsWith("fin")||a.startsWith("faceplate")||a.startsWith("engine")}class MT{constructor(e,i){this.inputManager=i,this.ambientLight=[.2,.2,.25],this.shipModelMatrix=new Float32Array(16),this.gl=e,this.program=St(e,pT,mT);const n=e.getUniformBlockIndex(this.program,"CameraBlock");n!==e.INVALID_INDEX&&e.uniformBlockBinding(this.program,n,0),this.quadBuffer=El(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.uniforms={uModelMatrix:e.getUniformLocation(this.program,"uModelMatrix"),uBlockPosition:e.getUniformLocation(this.program,"uBlockPosition"),uBlockRotation:e.getUniformLocation(this.program,"uBlockRotation"),uBlockScale:e.getUniformLocation(this.program,"uBlockScale"),uTexture:e.getUniformLocation(this.program,"uTexture"),uLightMap:e.getUniformLocation(this.program,"uLightMap"),uTime:e.getUniformLocation(this.program,"uTime"),uGlowStrength:e.getUniformLocation(this.program,"uGlowStrength"),uEnergyPulse:e.getUniformLocation(this.program,"uEnergyPulse"),uChargeColor:e.getUniformLocation(this.program,"uChargeColor"),uSheenStrength:e.getUniformLocation(this.program,"uSheenStrength"),uCollisionColor:e.getUniformLocation(this.program,"uCollisionColor"),uUseCollisionColor:e.getUniformLocation(this.program,"uUseCollisionColor"),uAmbientLight:e.getUniformLocation(this.program,"uAmbientLight")}}render(e,i,n){var h;const{gl:r}=this,c=performance.now()/1e3;r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.useProgram(this.program),r.bindVertexArray(this.vao),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.uniform1f(this.uniforms.uTime,c),r.uniform3f(this.uniforms.uAmbientLight,...this.ambientLight),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,i),r.uniform1i(this.uniforms.uLightMap,1);let u={x:0,y:0};if(this.inputManager){const d=this.inputManager.getMousePosition();u=n.screenToWorld(d.x,d.y)}for(const d of e){const{position:g,rotation:m}=d.getTransform();if(Ae.getInstance().isLightingEnabled()&&d instanceof It){const y=(h=d.getLightAuraId)==null?void 0:h.call(d);if(y)try{$e.getInstance().updateLight(y,g)}catch(v){console.warn(`[EntityPass] Light update failed for ship ${d.id}`,v)}}this.shipModelMatrix=vT(yT(m),Nh(g.x,g.y)),r.uniformMatrix4fv(this.uniforms.uModelMatrix,!1,this.shipModelMatrix),r.uniform1i(this.uniforms.uUseCollisionColor,0);for(const[y,v]of d.getAllBlocks()){if(v.hidden)continue;const M=v.type.armor??1,S=Vb(v.hp,M),T=cT(v.type.id,S),w=y.x*z,A=y.y*z,R=(v.rotation??0)*(Math.PI/180);r.uniform2f(this.uniforms.uBlockPosition,w,A),r.uniform1f(this.uniforms.uBlockRotation,R),r.uniform2f(this.uniforms.uBlockScale,z,z);const I=bT(v.type.id),x=I?Math.sin(c*6)*.5+.5:0,P=v.type.id.startsWith("cockpit")?1:0,N=ST(v.type.id)?1:0;if(r.uniform1f(this.uniforms.uEnergyPulse,x),r.uniform1f(this.uniforms.uGlowStrength,P),r.uniform1f(this.uniforms.uSheenStrength,N),r.uniform3f(this.uniforms.uChargeColor,...I??[0,0,0]),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,T.base),r.uniform1i(this.uniforms.uTexture,0),r.drawArrays(r.TRIANGLE_STRIP,0,4),T.overlay&&this.inputManager){const W=g.x+w*Math.cos(m)-A*Math.sin(m),H=g.y+w*Math.sin(m)+A*Math.cos(m),q=u.x-W,ie=u.y-H,K=Math.atan2(ie,q)-m+Math.PI/2;r.uniform1f(this.uniforms.uBlockRotation,K),r.uniform2f(this.uniforms.uBlockPosition,w,A),r.bindTexture(r.TEXTURE_2D,T.overlay),r.drawArrays(r.TRIANGLE_STRIP,0,4),r.uniform1f(this.uniforms.uBlockRotation,R)}}}r.disable(r.BLEND),r.bindVertexArray(null),r.useProgram(null)}setAmbientLight(e){this.ambientLight=e}destroy(){const{gl:e}=this;e.isProgram(this.program)&&e.deleteProgram(this.program),e.isBuffer(this.quadBuffer)&&e.deleteBuffer(this.quadBuffer),e.isVertexArray(this.vao)&&e.deleteVertexArray(this.vao)}}const TT=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/particlePass.vert\r
\r
layout(location = 0) in vec2 aPosition;\r
layout(location = 1) in vec2 aParticlePos;\r
layout(location = 2) in float aSize;\r
layout(location = 3) in float aLifeRatio;\r
layout(location = 4) in vec3 aColor;\r
\r
layout(std140) uniform CameraMatrices {\r
  mat4 uProjectionMatrix;\r
  mat4 uViewMatrix;\r
};\r
\r
out float vAlpha;\r
out vec3 vColor;\r
\r
void main() {\r
  vec2 scaled = aPosition * aSize;\r
  vec2 world = scaled + aParticlePos;\r
  gl_Position = uProjectionMatrix * uViewMatrix * vec4(world, 0.0, 1.0);\r
  vAlpha = aLifeRatio;\r
  vColor = aColor;\r
}\r
`,CT=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/particlePass.frag\r
\r
in float vAlpha;\r
in vec3 vColor;\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = vec4(vColor, vAlpha);\r
}\r
`;function wT(a){a.startsWith("#")&&(a=a.slice(1));const e=parseInt(a.slice(0,2),16)/255,i=parseInt(a.slice(2,4),16)/255,n=parseInt(a.slice(4,6),16)/255;return[e,i,n]}class AT{constructor(e,i){this.gl=e,this.program=St(e,TT,CT),this.quadBuffer=Rl(e),this.instanceBuffer=e.createBuffer(),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.vertexAttribDivisor(0,0),e.bindBuffer(e.ARRAY_BUFFER,this.instanceBuffer);const n=7*4;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,n,0),e.vertexAttribDivisor(1,1),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,1,e.FLOAT,!1,n,8),e.vertexAttribDivisor(2,1),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,n,12),e.vertexAttribDivisor(3,1),e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,n,16),e.vertexAttribDivisor(4,1),e.bindVertexArray(null);const r=e.getUniformBlockIndex(this.program,"CameraMatrices");r!==e.INVALID_INDEX&&e.uniformBlockBinding(this.program,r,0)}render(e,i){const n=this.gl;if(e.length===0)return;const r=7,c=new Float32Array(e.length*r);for(let u=0;u<e.length;u++){const h=e[u],d=u*r,[g,m,y]=wT(h.color);c.set([h.x,h.y,h.size,h.renderAlpha??1,g,m,y],d)}n.bindBuffer(n.ARRAY_BUFFER,this.instanceBuffer),n.bufferData(n.ARRAY_BUFFER,c,n.DYNAMIC_DRAW),n.useProgram(this.program),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE),n.bindVertexArray(this.vao),n.drawArraysInstanced(n.TRIANGLE_STRIP,0,4,e.length),n.bindVertexArray(null),n.disable(n.BLEND),n.useProgram(null)}destroy(){const e=this.gl;e.deleteProgram(this.program),e.deleteBuffer(this.quadBuffer),e.deleteBuffer(this.instanceBuffer),e.deleteVertexArray(this.vao)}}const kT=`#version 300 es\r
precision mediump float;\r
\r
// === Attribute Bindings ===\r
// Quad vertex position (static)\r
layout(location = 0) in vec2 aPosition;\r
\r
// Per-instance attributes\r
layout(location = 1) in vec2 aInstancePos;     // world-space center\r
layout(location = 2) in vec2 aInstanceSize;    // world-space size\r
layout(location = 3) in float aInstanceAlpha;  // transparency\r
layout(location = 4) in float aInstanceRotation; // rotation in radians\r
\r
// === Uniform block for camera ===\r
layout(std140) uniform CameraMatrices {\r
  mat4 uProjectionMatrix;\r
  mat4 uViewMatrix;\r
};\r
\r
out vec2 vUV;\r
out float vAlpha;\r
\r
void main() {\r
  // Apply rotation to the quad vertex position\r
  float cosR = cos(aInstanceRotation);\r
  float sinR = sin(aInstanceRotation);\r
  \r
  // Rotate the position around the origin\r
  vec2 rotatedPos = vec2(\r
    aPosition.x * cosR - aPosition.y * sinR,\r
    aPosition.x * sinR + aPosition.y * cosR\r
  );\r
  \r
  // Scale and translate to world position\r
  vec2 scaled = rotatedPos * aInstanceSize;\r
  vec2 world = scaled + aInstancePos;\r
\r
  gl_Position = uProjectionMatrix * uViewMatrix * vec4(world, 0.0, 1.0);\r
\r
  // UVs range from (0,0) bottom-left to (1,1) top-right\r
  vUV = vec2((aPosition.x + 1.0) * 0.5, 1.0 - (aPosition.y + 1.0) * 0.5);\r
  vAlpha = aInstanceAlpha;\r
}\r
`,ET=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
in float vAlpha;\r
\r
uniform sampler2D uTexture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 texColor = texture(uTexture, vUV);\r
  fragColor = vec4(texColor.rgb, texColor.a * vAlpha);\r
}\r
`,Ts=class Ts{constructor(e,i){this.gl=e,this.program=St(e,kT,ET),this.vao=e.createVertexArray(),this.quadBuffer=Rl(e),this.instanceBuffer=e.createBuffer(),this.instanceCapacity=256,this.instanceData=new Float32Array(this.instanceCapacity*Ts.INSTANCE_FLOATS),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.vertexAttribDivisor(0,0),e.bindBuffer(e.ARRAY_BUFFER,this.instanceBuffer);const n=Ts.INSTANCE_FLOATS*4;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,n,0),e.vertexAttribDivisor(1,1),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,n,8),e.vertexAttribDivisor(2,1),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,n,16),e.vertexAttribDivisor(3,1),e.enableVertexAttribArray(4),e.vertexAttribPointer(4,1,e.FLOAT,!1,n,20),e.vertexAttribDivisor(4,1),e.bindVertexArray(null);const r=e.getUniformBlockIndex(this.program,"CameraMatrices");r!==e.INVALID_INDEX&&e.uniformBlockBinding(this.program,r,0),this.uTexture=e.getUniformLocation(this.program,"uTexture")}renderBatch(e,i){if(i.length===0)return;const n=this.gl,c=1/ae();if(i.length>this.instanceCapacity){for(;this.instanceCapacity<i.length;)this.instanceCapacity*=2;this.instanceData=new Float32Array(this.instanceCapacity*Ts.INSTANCE_FLOATS)}for(let u=0;u<i.length;u++){const h=i[u],d=u*Ts.INSTANCE_FLOATS,g=h.widthPx*c,m=h.heightPx*c;this.instanceData[d+0]=h.worldX,this.instanceData[d+1]=h.worldY,this.instanceData[d+2]=g,this.instanceData[d+3]=m,this.instanceData[d+4]=h.alpha,this.instanceData[d+5]=h.rotation}n.bindBuffer(n.ARRAY_BUFFER,this.instanceBuffer),n.bufferData(n.ARRAY_BUFFER,this.instanceData.subarray(0,i.length*Ts.INSTANCE_FLOATS),n.DYNAMIC_DRAW),n.useProgram(this.program),n.bindVertexArray(this.vao),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.uTexture,0),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.drawArraysInstanced(n.TRIANGLE_STRIP,0,4,i.length),n.disable(n.BLEND),n.bindTexture(n.TEXTURE_2D,null),n.bindVertexArray(null),n.useProgram(null)}destroy(){const e=this.gl;e.deleteProgram(this.program),e.deleteBuffer(this.quadBuffer),e.deleteBuffer(this.instanceBuffer),e.deleteVertexArray(this.vao)}};Ts.INSTANCE_FLOATS=6;let vh=Ts;const ea=`#version 300 es\r
layout(location = 0) in vec2 aPosition;\r
out vec2 vUv;\r
\r
void main() {\r
  vUv = (aPosition + 1.0) * 0.5;\r
  gl_Position = vec4(aPosition, 0.0, 1.0);\r
}\r
`,RT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
\r
void main() {\r
  vec4 color = texture(uTexture, vUv);\r
  float avg = dot(color.rgb, vec3(0.333));\r
  fragColor = vec4(vec3(avg), color.a);\r
}\r
`,BT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
uniform vec2 uResolution;\r
uniform float uThreshold; // Brightness threshold (default: 0.7)\r
uniform float uIntensity; // Bloom intensity (default: 0.8)\r
uniform float uBlurSize; // Blur radius (default: 3.0)\r
\r
void main() {\r
    vec2 texelSize = 1.0 / uResolution;\r
    \r
    // Sample the original color\r
    vec4 originalColor = texture(uTexture, vUv);\r
    \r
    // Extract bright areas first\r
    float brightness = dot(originalColor.rgb, vec3(0.299, 0.587, 0.114));\r
    vec3 brightColor = originalColor.rgb;\r
    \r
    // Soft threshold with smooth falloff\r
    float bloomContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, brightness);\r
    brightColor *= bloomContribution;\r
    \r
    // Large radius blur using multiple rings\r
    vec3 bloomColor = vec3(0.0);\r
    float totalWeight = 0.0;\r
    \r
    // Ring 1: Inner samples (weight 4.0)\r
    for (int i = 0; i < 8; i++) {\r
        float angle = float(i) * 0.785398163; // 45 degrees in radians\r
        vec2 offset = vec2(cos(angle), sin(angle)) * texelSize * uBlurSize * 0.5;\r
        vec4 sampleColor = texture(uTexture, vUv + offset);\r
        float sampleBrightness = dot(sampleColor.rgb, vec3(0.299, 0.587, 0.114));\r
        float sampleContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, sampleBrightness);\r
        bloomColor += sampleColor.rgb * sampleContribution * 4.0;\r
        totalWeight += 4.0;\r
    }\r
    \r
    // Ring 2: Middle samples (weight 2.0)\r
    for (int i = 0; i < 16; i++) {\r
        float angle = float(i) * 0.392699082; // 22.5 degrees in radians\r
        vec2 offset = vec2(cos(angle), sin(angle)) * texelSize * uBlurSize * 1.0;\r
        vec4 sampleColor = texture(uTexture, vUv + offset);\r
        float sampleBrightness = dot(sampleColor.rgb, vec3(0.299, 0.587, 0.114));\r
        float sampleContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, sampleBrightness);\r
        bloomColor += sampleColor.rgb * sampleContribution * 2.0;\r
        totalWeight += 2.0;\r
    }\r
    \r
    // Ring 3: Outer samples (weight 1.0)\r
    for (int i = 0; i < 24; i++) {\r
        float angle = float(i) * 0.261799388; // 15 degrees in radians\r
        vec2 offset = vec2(cos(angle), sin(angle)) * texelSize * uBlurSize * 2.0;\r
        vec4 sampleColor = texture(uTexture, vUv + offset);\r
        float sampleBrightness = dot(sampleColor.rgb, vec3(0.299, 0.587, 0.114));\r
        float sampleContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, sampleBrightness);\r
        bloomColor += sampleColor.rgb * sampleContribution * 1.0;\r
        totalWeight += 1.0;\r
    }\r
    \r
    // Add center sample\r
    bloomColor += brightColor * 6.0;\r
    totalWeight += 6.0;\r
    \r
    // Normalize and apply intensity\r
    bloomColor = (bloomColor / totalWeight) * uIntensity;\r
    \r
    // Combine original with bloom using screen blend mode for more realistic glow\r
    vec3 finalColor = originalColor.rgb + bloomColor;\r
    finalColor = finalColor / (1.0 + bloomColor); // Tone mapping to prevent oversaturation\r
    \r
    fragColor = vec4(finalColor, originalColor.a);\r
}`,IT=`#version 300 es\r
precision mediump float;\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
// src/rendering/unified/shaders/postprocess/sepia.frag\r
\r
uniform sampler2D uTexture;\r
\r
void main() {\r
  vec4 color = texture(uTexture, vUv);\r
  float r = dot(color.rgb, vec3(0.393, 0.769, 0.189));\r
  float g = dot(color.rgb, vec3(0.349, 0.686, 0.168));\r
  float b = dot(color.rgb, vec3(0.272, 0.534, 0.131));\r
  fragColor = vec4(r, g, b, color.a);\r
}\r
`,xT=`#version 300 es\r
// src/rendering/unified/shaders/postprocess/passthrough.frag\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
\r
void main() {\r
  fragColor = texture(uTexture, vUv);\r
}\r
`,_T=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
uniform float uStrength; // Aberration strength (default: 0.003)\r
uniform float uFalloff; // Distance falloff (default: 2.0)\r
\r
void main() {\r
    // Calculate distance from center (0.0 to ~0.707)\r
    vec2 center = vec2(0.5, 0.5);\r
    vec2 offset = vUv - center;\r
    float distance = length(offset);\r
    \r
    // Create radial aberration that's stronger at edges\r
    float aberration = uStrength * pow(distance, uFalloff);\r
    \r
    // Direction from center to current pixel\r
    vec2 direction = normalize(offset);\r
    \r
    // Sample RGB channels at slightly different positions\r
    // Red channel - sample inward (closer to center)\r
    vec2 redUv = vUv - direction * aberration;\r
    float red = texture(uTexture, redUv).r;\r
    \r
    // Green channel - sample at original position\r
    float green = texture(uTexture, vUv).g;\r
    \r
    // Blue channel - sample outward (further from center)\r
    vec2 blueUv = vUv + direction * aberration;\r
    float blue = texture(uTexture, blueUv).b;\r
    \r
    // Get alpha from original position\r
    float alpha = texture(uTexture, vUv).a;\r
    \r
    fragColor = vec4(red, green, blue, alpha);\r
}\r
`,DT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
uniform vec2 uResolution;\r
uniform float uTime;\r
\r
uniform float uExposure;\r
uniform float uContrast;\r
uniform float uSaturation;\r
uniform float uTemperature;\r
uniform float uTint;\r
uniform float uVignetteStrength;\r
uniform float uFilmGrainStrength;\r
uniform float uShadowsLift;\r
uniform float uHighlightsGain;\r
\r
// NEW: Master intensity for cinematic grade\r
uniform float uCinematicIntensity;\r
\r
// === Utility Functions ===\r
\r
vec3 filmicToneMapping(vec3 color) {\r
    const float a = 2.51;\r
    const float b = 0.03;\r
    const float c = 2.43;\r
    const float d = 0.59;\r
    const float e = 0.14;\r
    color = (color * (a * color + b)) / (color * (c * color + d) + e);\r
    return clamp(color, 0.0, 1.0);\r
}\r
\r
vec3 adjustTemperature(vec3 color, float temperature, float tint) {\r
    float tempR = 1.0 + temperature * 0.2;\r
    float tempB = 1.0 - temperature * 0.2;\r
\r
    float tintG = 1.0 + tint * 0.15;\r
    float tintR = 1.0 - tint * 0.05;\r
    float tintB = 1.0 - tint * 0.05;\r
\r
    color.r *= tempR * tintR;\r
    color.g *= tintG;\r
    color.b *= tempB * tintB;\r
\r
    return color;\r
}\r
\r
vec3 liftGammaGain(vec3 color, float lift, float gamma, float gain) {\r
    color = color + lift;\r
    color = pow(max(color, 0.0), vec3(1.0 / gamma));\r
    color = color * gain;\r
    return color;\r
}\r
\r
vec3 cinematicGrade(vec3 color) {\r
    vec3 shadows = vec3(0.05, 0.1, 0.15);\r
    vec3 midtones = vec3(1.0, 0.95, 0.9);\r
    vec3 highlights = vec3(1.1, 1.05, 0.95);\r
\r
    float luma = dot(color, vec3(0.299, 0.587, 0.114));\r
\r
    float shadowWeight = 1.0 - smoothstep(0.0, 0.3, luma);\r
    float highlightWeight = smoothstep(0.6, 1.0, luma);\r
    float midtoneWeight = 1.0 - shadowWeight - highlightWeight;\r
\r
    vec3 graded = color * (\r
        shadows * shadowWeight +\r
        midtones * midtoneWeight +\r
        highlights * highlightWeight\r
    );\r
\r
    return mix(color, graded, uCinematicIntensity); // INTENSITY BLEND\r
}\r
\r
float vignette(vec2 uv, float strength) {\r
    vec2 center = uv - 0.5;\r
    float dist = length(center);\r
    float falloff = 1.0 - smoothstep(0.3, 0.8, dist);\r
    float v = mix(1.0, 1.0 - strength, 1.0 - falloff);\r
    return mix(1.0, v, uCinematicIntensity); // INTENSITY BLEND\r
}\r
\r
float filmGrain(vec2 uv, float time) {\r
    float noise = fract(sin(dot(uv + time * 0.1, vec2(12.9898, 78.233))) * 43758.5453);\r
    return noise;\r
}\r
\r
void main() {\r
    vec2 uv = vUv;\r
    vec4 originalColor = texture(uTexture, uv);\r
    vec3 color = originalColor.rgb;\r
\r
    // 1. Exposure\r
    color *= uExposure;\r
\r
    // 2. Shadows / Highlights\r
    color = liftGammaGain(color, uShadowsLift, 1.0, uHighlightsGain);\r
\r
    // 3. Temperature / Tint\r
    color = adjustTemperature(color, uTemperature, uTint);\r
\r
    // 4. Cinematic Color Grading\r
    color = cinematicGrade(color); // wrapped with intensity inside\r
\r
    // 5. Contrast\r
    color = (color - 0.5) * uContrast + 0.5;\r
\r
    // 6. Saturation\r
    float luminance = dot(color, vec3(0.299, 0.587, 0.114));\r
    color = mix(vec3(luminance), color, uSaturation);\r
\r
    // 7. Tone mapping\r
    color = filmicToneMapping(color);\r
\r
    // 8. Vignette\r
    float v = vignette(uv, uVignetteStrength);\r
    color *= v;\r
\r
    // 9. Film grain\r
    float grain = filmGrain(uv * uResolution, uTime);\r
    color += (grain - 0.5) * uFilmGrainStrength * uCinematicIntensity;\r
\r
    // 10. Clamp\r
    color = clamp(color, 0.0, 1.0);\r
\r
    fragColor = vec4(color, originalColor.a);\r
}\r
`;class PT{constructor(e,i,n){this.fbos=[],this.textures=[],this.startTime=Date.now(),this.gl=e,this.width=i,this.height=n,this.programs={passthrough:St(e,ea,xT),blackwhite:St(e,ea,RT),sepia:St(e,ea,IT),bloom:St(e,ea,BT),chromaticAberration:St(e,ea,_T),cinematicGrading:St(e,ea,DT)},this.quadBuffer=El(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null);for(let r=0;r<2;r++){const c=e.createFramebuffer(),u=e.createTexture();e.bindTexture(e.TEXTURE_2D,u),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.bindFramebuffer(e.FRAMEBUFFER,c),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,u,0),this.fbos.push(c),this.textures.push(u)}e.bindFramebuffer(e.FRAMEBUFFER,null)}run(e,i){const n=this.gl;let r=e,c=0;for(let h=0;h<i.length;h++){const{effect:d,params:g}=i[h],m=this.programs[d],y=this.fbos[c];if(n.bindFramebuffer(n.FRAMEBUFFER,y),n.viewport(0,0,this.width,this.height),n.clear(n.COLOR_BUFFER_BIT),n.useProgram(m),n.bindVertexArray(this.vao),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r),n.uniform1i(n.getUniformLocation(m,"uTexture"),0),d==="bloom")n.uniform2f(n.getUniformLocation(m,"uResolution"),this.width,this.height),n.uniform1f(n.getUniformLocation(m,"uThreshold"),.92),n.uniform1f(n.getUniformLocation(m,"uIntensity"),1.2),n.uniform1f(n.getUniformLocation(m,"uBlurSize"),8);else if(d==="chromaticAberration")n.uniform1f(n.getUniformLocation(m,"uStrength"),.003),n.uniform1f(n.getUniformLocation(m,"uFalloff"),1.8);else if(d==="cinematicGrading"){const v=g??{};n.uniform2f(n.getUniformLocation(m,"uResolution"),this.width,this.height),n.uniform1f(n.getUniformLocation(m,"uTime"),(Date.now()-this.startTime)/1e3),n.uniform1f(n.getUniformLocation(m,"uExposure"),v.exposure??1),n.uniform1f(n.getUniformLocation(m,"uContrast"),v.contrast??1.1),n.uniform1f(n.getUniformLocation(m,"uSaturation"),v.saturation??1.05),n.uniform1f(n.getUniformLocation(m,"uTemperature"),v.temperature??0),n.uniform1f(n.getUniformLocation(m,"uTint"),v.tint??0),n.uniform1f(n.getUniformLocation(m,"uVignetteStrength"),v.vignetteStrength??.3),n.uniform1f(n.getUniformLocation(m,"uFilmGrainStrength"),v.filmGrainStrength??.1),n.uniform1f(n.getUniformLocation(m,"uShadowsLift"),v.shadowsLift??0),n.uniform1f(n.getUniformLocation(m,"uHighlightsGain"),v.highlightsGain??1),n.uniform1f(n.getUniformLocation(m,"uCinematicIntensity"),v.cinematicIntensity??1)}n.drawArrays(n.TRIANGLE_STRIP,0,4),n.bindVertexArray(null),n.useProgram(null),r=this.textures[c],c=1-c}n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight);const u=this.programs.passthrough;n.useProgram(u),n.bindVertexArray(this.vao),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r),n.uniform1i(n.getUniformLocation(u,"uTexture"),0),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.bindVertexArray(null),n.useProgram(null)}destroy(){const e=this.gl;for(const i in this.programs){const n=this.programs[i];e.isProgram(n)&&e.deleteProgram(n)}for(const i of this.fbos)e.isFramebuffer(i)&&e.deleteFramebuffer(i);for(const i of this.textures)e.isTexture(i)&&e.deleteTexture(i);e.isBuffer(this.quadBuffer)&&e.deleteBuffer(this.quadBuffer),e.isVertexArray(this.vao)&&e.deleteVertexArray(this.vao)}}function LT(a){const e=a.createBuffer();return a.bindBuffer(a.UNIFORM_BUFFER,e),a.bufferData(a.UNIFORM_BUFFER,128,a.DYNAMIC_DRAW),e}function OT(a,e,i){const n=Nm(-i.getViewportWidth()/(2*i.getZoom()),i.getViewportWidth()/(2*i.getZoom()),i.getViewportHeight()/(2*i.getZoom()),-i.getViewportHeight()/(2*i.getZoom())),r=Nh(-i.getPosition().x,-i.getPosition().y),c=new Float32Array(32);c.set(n,0),c.set(r,16),a.bindBuffer(a.UNIFORM_BUFFER,e),a.bufferSubData(a.UNIFORM_BUFFER,0,c)}class FT{constructor(e,i){this.inputManager=i,this.spriteGroups=new Map,this.clearedTextures=[],this.postProcessEffects=new Map,this.backgroundImageId=null,this.onResolutionChanged=()=>{this.initializeSceneFramebuffer(),this.lightingPass.resize()},this.onPostProcessEffectsSet=r=>{Array.isArray(r.effectChain)?this.setPostProcessEffects(r.effectChain):console.warn("[Renderer] Ignoring malformed postprocess effectChain payload:",r)},this.onPostProcessEffectAdd=r=>{this.addPostProcessEffect(r.effect,r.params)},this.onPostProcessEffectRemove=r=>{this.removePostProcessEffect(r.effect)},this.onPostProcessEffectClear=()=>{this.clearPostProcessEffects()};const n=Ti.getInstance();this.gl=n.getWebGL2Context("unifiedgl2"),this.cameraUBO=LT(this.gl),this.gl.bindBufferBase(this.gl.UNIFORM_BUFFER,0,this.cameraUBO),this.backgroundPass=new ZM(this.gl),this.planetPass=new eT(this.gl),this.lightingPass=new rT(this.gl,this.cameraUBO),this.entityPass=new MT(this.gl,this.inputManager),this.spritePass=new vh(this.gl,this.cameraUBO),this.particlePass=new AT(this.gl,this.cameraUBO),this.postProcessPass=new PT(this.gl,this.gl.canvas.width,this.gl.canvas.height),this.sceneFramebuffer=this.gl.createFramebuffer(),this.sceneTexture=this.gl.createTexture(),this.initializeSceneFramebuffer(),pe.on("resolution:changed",this.onResolutionChanged),pe.on("postprocess:effect:set",this.onPostProcessEffectsSet),pe.on("postprocess:effect:add",this.onPostProcessEffectAdd),pe.on("postprocess:effect:remove",this.onPostProcessEffectRemove),pe.on("postprocess:effect:clear",this.onPostProcessEffectClear)}initializeSceneFramebuffer(){const e=this.gl,i=e.drawingBufferWidth,n=e.drawingBufferHeight;e.bindTexture(e.TEXTURE_2D,this.sceneTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this.sceneFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.sceneTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}render(e,i,n,r,c){const u=this.gl;OT(u,this.cameraUBO,e),u.bindFramebuffer(u.FRAMEBUFFER,this.sceneFramebuffer),u.viewport(0,0,u.drawingBufferWidth,u.drawingBufferHeight),u.clearColor(0,0,0,0),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),this.backgroundPass.render(e.getOffset()),this.planetPass.renderAll();const h=this.lightingPass.generateLightBuffer(n,e);u.bindFramebuffer(u.FRAMEBUFFER,this.sceneFramebuffer);const d=this.lightingPass.getAmbientLight();this.entityPass.setAmbientLight(d),this.entityPass.render(i,h,e);for(const m of this.spriteGroups.values())m.length=0;this.clearedTextures.length=0;for(const m of r){const y=m.texture;let v=this.spriteGroups.get(y);v||(v=[],this.spriteGroups.set(y,v)),v.push({worldX:m.worldX,worldY:m.worldY,widthPx:m.widthPx,heightPx:m.heightPx,alpha:m.alpha??1,rotation:m.rotation??0})}for(const[m,y]of this.spriteGroups)y.length>0&&this.spritePass.renderBatch(m,y);this.particlePass.render(c,e),this.lightingPass.compositeLightingOverTarget(this.sceneFramebuffer),u.bindFramebuffer(u.FRAMEBUFFER,null);const g=Array.from(this.postProcessEffects.entries()).map(([m,y])=>({effect:m,params:y}));this.postProcessPass.run(this.sceneTexture,g)}resize(){this.initializeSceneFramebuffer(),this.lightingPass.resize()}destroy(){const e=this.gl;e.deleteBuffer(this.cameraUBO),e.deleteFramebuffer(this.sceneFramebuffer),e.deleteTexture(this.sceneTexture),this.backgroundPass.destroy(),this.lightingPass.destroy(),this.entityPass.destroy(),this.spritePass.destroy(),this.particlePass.destroy(),this.postProcessPass.destroy(),pe.off("resolution:changed",this.onResolutionChanged),pe.off("postprocess:effect:set",this.onPostProcessEffectsSet),pe.off("postprocess:effect:add",this.onPostProcessEffectAdd),pe.off("postprocess:effect:remove",this.onPostProcessEffectRemove),pe.off("postprocess:effect:clear",this.onPostProcessEffectClear)}setPostProcessEffects(e){this.postProcessEffects.clear();for(const{effect:i,params:n}of e)this.postProcessEffects.set(i,n)}addPostProcessEffect(e,i){this.postProcessEffects.set(e,i)}removePostProcessEffect(e){this.postProcessEffects.delete(e)}clearPostProcessEffects(){this.postProcessEffects.clear()}setBackgroundImage(e){this.backgroundImageId=e,this.backgroundPass.loadImage(e??"")}addPlanet(e,i,n){console.log("[UnifiedSceneRendererGL] Adding planet:",e),this.planetPass.addPlanet(e,i,n)}setAmbientLight(e){this.lightingPass.setAmbientLight(e)}getLightingPass(){return this.lightingPass}getEntityPass(){return this.entityPass}getSpritePass(){return this.spritePass}getParticlePass(){return this.particlePass}getPostProcessPass(){return this.postProcessPass}}function UT(a,e,i,n,r=200,c="#00AAFF",u=20){n=Math.max(0,Math.min(1,n));const h=c,d=2,g=.35,m=.5;for(let y=0;y<d;y++){const v=y*g,M=Math.max(0,(n-v)/(1-v));if(M<=0)continue;const S=M*r,T=Math.pow(1-M,1.5)*(1-y*m);if(T<=.01)continue;const w=a.createRadialGradient(e,i,Math.max(0,S-u),e,i,S+u),[A,R,I]=zp(h);w.addColorStop(0,`rgba(${A}, ${R}, ${I}, 0)`),w.addColorStop(.5,`rgba(${A}, ${R}, ${I}, ${(T*.8).toFixed(3)})`),w.addColorStop(1,`rgba(${A}, ${R}, ${I}, 0)`),a.save(),a.globalCompositeOperation="screen",a.fillStyle=w,a.beginPath(),a.arc(e,i,S,0,Math.PI*2),a.fill(),a.restore()}if(n<.4){const v=(1-n/.4)*.4,M=a.createRadialGradient(e,i,0,e,i,40),[S,T,w]=zp(h);M.addColorStop(0,`rgba(255, 255, 255, ${v.toFixed(3)})`),M.addColorStop(.5,`rgba(${S}, ${T}, ${w}, ${(v*.6).toFixed(3)})`),M.addColorStop(1,`rgba(${S}, ${T}, ${w}, 0)`),a.save(),a.globalCompositeOperation="screen",a.fillStyle=M,a.beginPath(),a.arc(e,i,40,0,Math.PI*2),a.fill(),a.restore()}}function zp(a){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:[0,170,255]}function ti(a,e,{file:i,channel:n,maxSimultaneous:r=5,baseVolume:c=1,pitchRange:u=[.7,1],volumeJitter:h=.2}){let d=0,g=1;if(e&&a!==e){const A=a.getTransform().position,R=e.getTransform().position,I=A.x-R.x,x=A.y-R.y,P=Math.sqrt(I*I+x*x),N=2450,W=300,H=Math.max(0,1-(P-W)/(N-W));g=Math.min(1,H),d=Math.max(-.7,Math.min(.7,I/300))}if(c*(1-h)*g<.01)return;const[v,M]=u,S=v+Math.random()*(M-v),w=c*(1-h*Math.random())*g;Q.play(i,n,{pitch:S,volume:w,pan:d,maxSimultaneous:r})}class NT{constructor(e,i,n){this.activeShips=[],this.animationDuration=500,this.startBlockRevealInterval=200,this.decrementPerBlock=5,this.finalBlockRevealInterval=5,this.basePitch=.5,this.pitchIncrement=.03,this.maxPitch=2,this.playerShip=e,this.camera=i,this.ctx=n.getCanvas("fx").getContext("2d")}animateShipConstruction(e,i){const n=e.getAllBlocks();for(const[,r]of n)r.hidden=!0;this.activeShips.push({ship:e,queue:[...n],revealed:new Set,animationTimers:new Map,timeSinceLastReveal:0,blockRevealInterval:this.startBlockRevealInterval,totalBlockCount:n.length,blocksRevealed:0,phase:"building",shockwaveTimer:this.animationDuration,auraLightOptions:i})}update(e){const i=e*1e3;for(let n=this.activeShips.length-1;n>=0;n--){const r=this.activeShips[n];for(r.timeSinceLastReveal+=i;r.timeSinceLastReveal>=r.blockRevealInterval&&r.queue.length>0;){const[c,u]=r.queue.shift();u.hidden=!1;const h=qe(c);r.revealed.add(h),r.animationTimers.set(h,this.animationDuration),r.timeSinceLastReveal-=r.blockRevealInterval;const d=Math.min(this.basePitch+r.blocksRevealed*this.pitchIncrement,this.maxPitch);ti(r.ship,this.playerShip,{file:"assets/sounds/sfx/ship/gather_00.wav",channel:"sfx",baseVolume:1,pitchRange:[d,d],volumeJitter:.2,maxSimultaneous:5});const g=this.startBlockRevealInterval,m=this.decrementPerBlock,y=this.finalBlockRevealInterval;r.blockRevealInterval=Math.max(y,g-m*r.blocksRevealed),r.blocksRevealed++}for(const[c,u]of r.animationTimers.entries()){const h=u-i;h<=0?r.animationTimers.delete(c):r.animationTimers.set(c,h)}r.phase==="building"?r.revealed.size===r.ship.getBlockCount()&&(r.phase="shockwave",r.shockwaveTimer=this.animationDuration,ti(r.ship,this.playerShip,{file:"assets/sounds/sfx/ship/repair_00.wav",channel:"sfx",baseVolume:1,pitchRange:[.7,1.2],volumeJitter:.1,maxSimultaneous:3}),r.auraLightOptions&&r.ship.registerAuraLight(r.auraLightOptions.color,r.auraLightOptions.radius,r.auraLightOptions.intensity)):r.phase==="shockwave"&&(r.shockwaveTimer-=i,r.shockwaveTimer<=0&&this.activeShips.splice(n,1))}}render(e){var y;const i=this.playerShip.getTransform().position,n=this.playerShip.getGrid(),r=3e3,c=i.x-r,u=i.y-r,h=i.x+r,d=i.y+r,g=n.getBlocksInArea(c,u,h,d),m=new Set;for(const v of g){const M=zt.getObject(v);if(!M||!(M instanceof It))continue;const S=this.activeShips.find(te=>te.ship===M);if(!S)continue;const T=(y=[...S.ship.getBlockMap().entries()].find(([,te])=>te===v))==null?void 0:y[0];if(!T)continue;const w=T,A=S.animationTimers.get(w);if(!A)continue;if(!m.has(M)){if(m.add(M),S.phase!=="shockwave")continue;const te=M.getTransform(),_=this.camera.worldToScreen(te.position.x,te.position.y),X=1-S.shockwaveTimer/this.animationDuration,se=M.getBlockMap().size,oe=250,k=Math.sqrt(se)*20,G=(oe+k)*this.camera.getZoom(),ee=Math.max(8,Math.sqrt(se)*2)*this.camera.getZoom();UT(this.ctx,_.x,_.y,X,G,"#00AAFF",ee)}const R=M.getTransform(),I=sn(T),x=I.x*z,P=I.y*z,N=Math.cos(R.rotation),W=Math.sin(R.rotation),H=x*N-P*W,q=x*W+P*N,ie=R.position.x+H,$=R.position.y+q,K=this.camera.worldToScreen(ie,$),Z=(1-(1-A/this.animationDuration))*.6;this.ctx.save(),this.ctx.translate(K.x,K.y),this.ctx.scale(this.camera.getZoom(),this.camera.getZoom()),xm(this.ctx,v.type.id,v.rotation??0,`rgba(0,255,255,${Z.toFixed(3)})`),this.ctx.restore()}}}const HT=`
  precision mediump float;

  attribute vec2 aPosition;

  uniform mat4 uProjectionMatrix;
  uniform mat4 uViewMatrix;
  uniform vec2 uWorldPosition;  // world-space center position
  uniform vec2 uWorldSize;      // half extents in world units

  varying vec2 vUV;

  void main() {
    vec2 scaled = aPosition * uWorldSize; // convert [-1, 1] to world-size quad
    vec2 world = scaled + uWorldPosition;

    gl_Position = uProjectionMatrix * uViewMatrix * vec4(world, 0.0, 1.0);

    vUV = vec2((aPosition.x + 1.0) / 2.0, 1.0 - (aPosition.y + 1.0) / 2.0);
  }
`,GT=`
  precision mediump float;
  uniform sampler2D uTexture;
  uniform float uAlpha;
  varying vec2 vUV;

  void main() {
    vec4 texColor = texture2D(uTexture, vUV);
    gl_FragColor = vec4(texColor.rgb, texColor.a * uAlpha);
  }
`,yl=class yl{constructor(e){this.attribs={aPosition:0},this.gl=e,this.program=St(e,HT,GT),this.quadBuffer=Rl(e),this.uniforms={uProjectionMatrix:e.getUniformLocation(this.program,"uProjectionMatrix"),uViewMatrix:e.getUniformLocation(this.program,"uViewMatrix"),uWorldPosition:e.getUniformLocation(this.program,"uWorldPosition"),uWorldSize:e.getUniformLocation(this.program,"uWorldSize"),uTexture:e.getUniformLocation(this.program,"uTexture"),uAlpha:e.getUniformLocation(this.program,"uAlpha")}}static getInstance(e){return this.instance||(this.instance=new yl(e)),this.instance}static destroyInstance(){this.instance&&(this.instance.destroy(),this.instance=null)}renderTexture(e,i,n,r,c,u=1){const h=this.gl,d=yt.getInstance(),g=ae();h.useProgram(this.program),h.bindBuffer(h.ARRAY_BUFFER,this.quadBuffer),h.enableVertexAttribArray(this.attribs.aPosition),h.vertexAttribPointer(this.attribs.aPosition,2,h.FLOAT,!1,0,0);const m=Nm(-d.getViewportWidth()/(2*d.getZoom()),d.getViewportWidth()/(2*d.getZoom()),d.getViewportHeight()/(2*d.getZoom()),-d.getViewportHeight()/(2*d.getZoom())),y=d.getPosition(),v=Nh(-y.x,-y.y),M=1/g,S=r*M,T=c*M;h.uniformMatrix4fv(this.uniforms.uProjectionMatrix,!1,m),h.uniformMatrix4fv(this.uniforms.uViewMatrix,!1,v),h.uniform2f(this.uniforms.uWorldPosition,i,n),h.uniform2f(this.uniforms.uWorldSize,S,T),h.activeTexture(h.TEXTURE0),h.bindTexture(h.TEXTURE_2D,e),h.uniform1i(this.uniforms.uTexture,0),h.uniform1f(this.uniforms.uAlpha,u),h.enable(h.BLEND),h.blendFunc(h.SRC_ALPHA,h.ONE_MINUS_SRC_ALPHA),h.drawArrays(h.TRIANGLE_STRIP,0,4),h.disableVertexAttribArray(this.attribs.aPosition),h.bindTexture(h.TEXTURE_2D,null),h.bindBuffer(h.ARRAY_BUFFER,null),h.disable(h.BLEND),h.useProgram(null)}destroy(){const e=this.gl;e.deleteBuffer(this.quadBuffer),e.deleteProgram(this.program)}};yl.instance=null;let bh=yl;class WT{constructor(e,i,n,r,c,u,h,d,g){this.text=e,this.getPosition=i,this.fontSize=n,this.fontFamily=r,this.life=c,this.speed=u,this.alpha=h,this.color=d,this.behavior=g,this.elapsed=0,this.yOffset=0,this.originalFontSize=n}update(e){var i,n;if(this.elapsed+=e,this.yOffset-=this.speed*e,(i=this.behavior)!=null&&i.impactScale){const r=Math.min(this.elapsed/.15,1),c=1+(this.behavior.impactScale-1)*(1-r);this.fontSize=this.originalFontSize*c}if(((n=this.behavior)==null?void 0:n.fadeOut)!==!1){const r=Math.max(0,this.life-this.elapsed);this.alpha=Math.min(1,r/this.life)}}isExpired(){return this.elapsed>=this.life}render(e){const i=ae(),n=this.getPosition(),r=n.y+this.yOffset;e.save(),e.globalAlpha=this.alpha,e.fillStyle=this.color,e.font=`${Math.round(this.fontSize*i)}px ${this.fontFamily}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,n.x,r),e.restore()}}class zT{constructor(){this.floatingTexts=[],this.channelMap=new Map,this.MERGE_WINDOW_MS=250,this.canvasManager=Ti.getInstance(),this.ctx=this.canvasManager.getContext("ui")}update(e){for(const i of this.floatingTexts)i.update(e);this.floatingTexts=this.floatingTexts.filter(i=>!i.isExpired())}render(){for(const e of this.floatingTexts)e.render(this.ctx)}clear(){this.floatingTexts.length=0,this.channelMap.clear()}createScreenText(e,i,n,r=14,c="monospace",u=.6,h=30,d=1,g="#FFFFFF",m,y){const v=()=>({x:i,y:n});this.create(e,v,r,c,u,h,d,g,m,y)}createWorldText(e,i,n,r,c=14,u="monospace",h=.6,d=30,g=1,m="#FFFFFF",y,v){const M=()=>r.worldToScreen(i,n);this.create(e,M,c,u,h,d,g,m,y,v)}create(e,i,n,r,c,u,h,d,g,m){const y=performance.now();if(m){const M=this.channelMap.get(m);if(M&&y-M.lastUpdate<this.MERGE_WINDOW_MS){const S=parseFloat(M.entity.text),T=parseFloat(e);if(!isNaN(S)&&!isNaN(T)){const w=S+T;M.entity.text=`${Math.round(w)}`,M.entity.alpha=1,M.entity.life=c,M.lastUpdate=y;return}}}const v=new WT(e,i,n,r,c,u,h,d,g);this.floatingTexts.push(v),m&&this.channelMap.set(m,{entity:v,lastUpdate:y})}}class VT{constructor(e,i,n,r,c){this.grid=i,this.combatService=n,this.particleManager=r,this.playerShip=c,this.projectiles=[]}spawnProjectile(e,i,n,r,c=300,u=2,h=1,d,g,m,y){const v=i.x-e.x,M=i.y-e.y;if(Math.sqrt(v*v+M*M)===0)return;let T=Math.atan2(M,v);const w=(1-h)*Math.PI/8;h<1&&(T+=(Math.random()*2-1)*w);const A=Math.cos(T)*c,R=Math.sin(T)*c,I=this.particleManager.emitParticle(e,{colors:m??["#ffff88","#ffaa00","#ffcc33"],baseSpeed:0,sizeRange:[2.2,2.8],lifeRange:[u,u+.1],velocity:{x:A,y:R},light:!0,lightRadiusScalar:20,lightIntensity:.8,fadeMode:y});this.projectiles.push({position:{x:e.x,y:e.y},velocity:{x:A,y:R},type:n,damage:r,life:u,ownerShipId:d,ownerFaction:g,particle:I})}update(e){for(const i of this.projectiles)i.position.x+=i.velocity.x*e,i.position.y+=i.velocity.y*e,i.life-=e;this.projectiles=this.projectiles.filter(i=>i.life>0),this.checkCollisions()}checkCollisions(){for(const e of this.projectiles){const n=this.grid.getBlocksInArea(e.position.x-32,e.position.y-32,e.position.x+32,e.position.y+32,e.ownerFaction);for(const r of n){if(!this.checkCollision(e,r))continue;const c=zt.getObject(r);if(!c)continue;const u=c.getBlockCoord(r);if(!u)continue;const h=Tt.getInstance().getById(e.ownerShipId);if(h){this.combatService.applyDamageToBlock(c,h,r,u,e.damage,"projectile",this.playerShip),this.removeProjectile(e);return}}}}checkCollision(e,i){if(!i.position)return!1;const n=15,r=i.type.size||32,c=e.position.x-i.position.x,u=e.position.y-i.position.y;return Math.sqrt(c*c+u*u)<n+r/2}removeProjectile(e){this.projectiles=this.projectiles.filter(i=>i!==e),this.particleManager.removeParticle(e.particle)}}let XT=0;function YT(){return`beam-light-${XT++}`}function qT(a){const{start:e,end:i,width:n=16,color:r="#00ffff",intensity:c=1,life:u,expires:h=!1,id:d=YT()}=a;return{id:d,type:"beam",start:e,end:i,width:n,color:r,intensity:c,life:u,maxLife:u,expires:h}}function Hm(a){if(!a.length)throw new Error("randomFromArray: cannot select from an empty array");const e=Math.floor(Math.random()*a.length);return a[e]}class nn{constructor(){this.objects=new Set,this.idMap=new Map}static getInstance(){return nn.instance||(nn.instance=new nn),nn.instance}getById(e){return this.idMap.get(e)}add(e){this.objects.add(e),this.idMap.set(e.id,e)}remove(e){this.objects.delete(e),this.idMap.delete(e.id)}getAll(){return this.objects}getAllIds(){return Array.from(this.idMap.keys())}getFirst5Ids(){return Array.from(this.idMap.keys()).slice(0,5)}clear(){this.objects.clear(),this.idMap.clear()}count(){return this.objects.size}}function Hh(a){const i=Tt.getInstance().getById(a.ownerShipId);return i||nn.getInstance().getById(a.ownerShipId)||null}function Gm(a,e){return e.getBlockCoord(a)}function ta(a,e){const i=e.x*32,n=e.y*32,r=Math.cos(a.rotation),c=Math.sin(a.rotation);return{x:a.position.x+i*r-n*c,y:a.position.y+i*c+n*r}}function Vp(a,e,i){const n=Math.cos(i),r=Math.sin(i);return{x:a*n-e*r,y:a*r+e*n}}class jT{constructor(e,i,n,r,c,u){this.camera=i,this.grid=n,this.combatService=r,this.particleManager=c,this.playerShip=u,this.beamLength=2e3,this.activeBeams=[],this.intentMap=new Map,this.ctx=e.getContext("fx")}queueUpdate(e,i,n){this.intentMap.set(e,{intent:n,transform:i})}update(e){var i,n;for(const r of this.activeBeams)r.age+=e,r.intensity=.75+.25*Math.sin(r.age*10),r.glowPulse=.5+.5*Math.sin(r.age*4);this.activeBeams=[];for(const[r,{intent:c,transform:u}]of this.intentMap.entries()){if(!(c!=null&&c.fireSecondary))continue;const h=r.getAllBlocks().filter(([m,y])=>{var v,M;return y.type.id.startsWith("laser")&&((v=y.type.behavior)==null?void 0:v.canFire)&&((M=y.type.behavior.fire)==null?void 0:M.fireType)==="laser"});if(h.length===0)continue;let d=r.getEnergyComponent();if(d||(r.enableEnergyComponent(),d=r.getEnergyComponent()),!d)continue;let g=0;for(const[,m]of h){const y=((n=(i=m.type.behavior)==null?void 0:i.fire)==null?void 0:n.energyCost)??.25;g+=y}if(d.spend(g))for(const[m,y]of h){const v=y.type.behavior.fire,M=ta(u,m);if(!c.aimAt)continue;const T=(typeof y.rotation=="number"?y.rotation:0)*(Math.PI/180),w={x:0,y:-1},A=Vp(w.x,w.y,T),R=Vp(A.x,A.y,u.rotation),I=R.x,x=R.y,P=M.x+I*this.beamLength,N=M.y+x*this.beamLength;let W=P,H=N;const q=this.grid.getFirstBlockAlongRay(M,{x:P,y:N},r.getFaction());if(q){W=q.point.x,H=q.point.y;const X=Hh(q.block),se=X?Gm(q.block,X):null;X&&se&&this.combatService.applyDamageToBlock(X,r,q.block,se,v.fireDamage,"laser",this.playerShip)}const ie=128,$=W-M.x,K=H-M.y,ne=$*$+K*K;let Z=W,te=H,_=0;if(ne>1e-4&&(_=1/Math.sqrt(ne),Z+=$*_*ie,te+=K*_*ie),this.activeBeams.push({origin:{x:M.x,y:M.y},target:{x:Z,y:te},age:0,intensity:Math.random()*.5+.75,coreWidth:3+Math.random(),glowPulse:Math.random()*Math.PI*2,blockTypeId:y.type.id}),Math.random()<.1){const X=Ep[y.type.id],se=$e.getInstance();if(Ae.getInstance().isLightingEnabled()&&X){const oe=Hm(X),k=qT({start:{x:M.x,y:M.y},end:{x:Z,y:te},width:30+Math.random()*4,color:oe,intensity:.15+Math.random()*.4,life:.1+Math.random()*.15,expires:!0});se.registerLight(k);const G=si({x:M.x,y:M.y,radius:186+Math.random()*32,color:oe,intensity:.4+Math.random()*.3,life:.05+Math.random()*.1,expires:!0});se.registerLight(G)}}}}this.intentMap.clear()}render(){const e=this.ctx;e.save();for(const i of this.activeBeams){const n=this.camera.worldToScreen(i.origin.x,i.origin.y),r=this.camera.worldToScreen(i.target.x,i.target.y),c=Ep[i.blockTypeId]??["#FFFFFF","#00CCFF","#00FFFF"],[u,h,d]=c;e.globalAlpha=i.intensity,e.strokeStyle=u,e.lineWidth=i.coreWidth+Math.sin(i.age*20)*.5,e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.stroke(),e.globalAlpha=.2+.2*i.glowPulse,e.strokeStyle=h,e.lineWidth=7+Math.sin(i.age*4),e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.stroke(),e.globalAlpha=.1,e.strokeStyle=d,e.lineWidth=11+2*Math.sin(i.age*2),e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.stroke()}e.restore()}}function KT(a,e,i){if(e<=0)return;const n=a.getAllBlocks().filter(([,r])=>r.hp<r.type.armor);for(const[,r]of n){const c=r.type.armor-r.hp,u=Math.min(c,e);u>0&&(r.hp+=u,i.createRepairEffect(r.position))}}function Bl(a,e,i=300,n=1,r=.5,c="#ffffff"){const u=si({x:a,y:e,radius:i,intensity:n,life:r,color:c,expires:!0});$e.getInstance().registerLight(u)}const Xp=1,Yp=3.2,qp=16,ZT=48,QT=10,$T=2,JT={currency:1,block:1,repair:1},el=128,eC={colors:["#ffcc00","#ffaa00","#ff8800","#cc6600"]},dt=class dt{constructor(e,i,n,r,c,u,h){this.camera=e,this.pickups=[],this.blockPickups=[],this.resourcePickups=[],this.currencyPickupPitch=dt.BASE_PICKUP_PITCH,this.blockPickupPitch=dt.BASE_PICKUP_PITCH,this.timeSinceLastCurrencyPickup=0,this.timeSinceLastBlockPickup=0,this.playerResources=Be.getInstance(),this.playerShip=i,this.sparkManager=n,this.screenEffects=r,this.popupMessageSystem=c,this.shipBuilderEffects=u,this.blockDropDecisionMenu=h}spawnCurrencyPickup(e,i){const n=$e.getInstance(),r=si({x:e.x,y:e.y,radius:200,color:"#ffcc00",intensity:1,life:1e4,expires:!0});n.registerLight(r);const c={type:{id:"currency",name:"Gold Coin",currencyAmount:i,category:"currency",sprite:"currency",repairAmount:0},position:e,isPickedUp:!1,repairAmount:0,currencyAmount:i,rotation:0,lightId:r.id};this.pickups.push(c),this.resourcePickups.push(c)}spawnRepairPickup(e,i){const n=$e.getInstance(),r=si({x:e.x,y:e.y,radius:200,color:"#ff4444",intensity:1,life:1e4,expires:!0});n.registerLight(r);const c={type:{id:"repair",name:"Repair Nanobot Swarm",sprite:"repair",category:"repair",currencyAmount:0,repairAmount:i},position:e,isPickedUp:!1,currencyAmount:0,repairAmount:i,rotation:0,lightId:r.id};this.pickups.push(c),this.resourcePickups.push(c)}spawnBlockPickup(e,i){const n=$e.getInstance(),r=bi(i.id),c=Rp[r]??"#ffffff",u=si({x:e.x,y:e.y,radius:300,color:c,intensity:.75,life:1e4,expires:!0});n.registerLight(u);const h={type:{id:`unlock-${i.id}`,name:`${i.name} Blueprint`,sprite:i.sprite,currencyAmount:0,category:"block",blockTypeId:i.id,repairAmount:0},position:e,isPickedUp:!1,repairAmount:0,currencyAmount:0,rotation:0,lightId:u.id};this.pickups.push(h),this.blockPickups.push(h)}render(e){}update(e){var S;this.timeSinceLastCurrencyPickup+=e,this.timeSinceLastBlockPickup+=e,this.timeSinceLastCurrencyPickup>=dt.PITCH_RESET_DELAY&&(this.currencyPickupPitch=dt.BASE_PICKUP_PITCH),this.timeSinceLastBlockPickup>=dt.PITCH_RESET_DELAY&&(this.blockPickupPitch=dt.BASE_PICKUP_PITCH);const i=this.playerShip.getTransform().position,n=600,r=this.playerShip.getTotalHarvestRate()*ZT,c=n+r,u=c*c,h=qp*qp,d=Math.random()<.2,g=this.camera.getViewportBounds(),m=g.x-el,y=g.y-el,v=g.x+g.width+el,M=g.y+g.height+el;for(const T of this.pickups){if(T.isPickedUp)continue;const w=T.position.x,A=T.position.y;if(w<m||w>v||A<y||A>M)continue;if(T.rotation+=(JT[T.type.category]??0)*e,d){let K;switch(T.type.category){case"block":{const ne=T.type.blockTypeId;if(ne){console.log("[Pickup] Block type ID:",ne);const Z=bi(ne);K=O2[Z]??eC.colors}else K=["#00ffff"];break}case"repair":K=["#ff4444","#cc2222","#ff0000","#aa0000"];break;case"currency":default:K=["#ffcc00","#ffaa00","#ff8800","#cc6600"];break}console.log("Passing spark colors: ",K),this.sparkManager.emitParticle(T.position,{colors:K,baseSpeed:250,sizeRange:[1,2.5],lifeRange:[1,2],fadeOut:!0})}const R=i.x-T.position.x,I=i.y-T.position.y,x=R*R+I*I,P=(()=>{switch(T.type.category){case"currency":case"repair":try{return Qb(T.type.id).texture}catch(K){return console.error(`[PickupSystem] Missing GL sprite for pickup: ${T.type.id}`,K),null}case"block":try{const K=am(T.type.blockTypeId,Qs.NONE);return(K==null?void 0:K.base)??null}catch(K){return console.error(`[PickupSystem] Failed to load block sprite for pickup: ${T.type.blockTypeId}`,K),null}default:return console.warn(`[PickupSystem] Unhandled pickup category: ${T.type.category}`),null}})();if(P){let K=1,ne=z,Z=z;if(T.type.category==="currency"){const te=Xp+Math.log2(T.currencyAmount+1)/5;ne*=te,Z*=te}else if(T.type.category==="repair"){const te=Xp+Math.log2(T.repairAmount+1)/5;ne*=te,Z*=te}else T.type.category==="block"&&(ne*=Yp,Z*=Yp);Ph.add({texture:P,worldX:T.position.x,worldY:T.position.y,widthPx:ne,heightPx:Z,alpha:K,rotation:T.rotation})}if(x>u)continue;const N=x/u,W=Math.pow(1-N,$T),H=QT*W,q=Math.sqrt(x),ie=R/q,$=I/q;if(T.position.x+=ie*H,T.position.y+=$*H,T.lightId){const K=$e.getInstance(),ne=(S=K.getLightById)==null?void 0:S.call(K,T.lightId);ne&&ne.type==="point"&&(ne.x=T.position.x,ne.y=T.position.y)}x<h&&this.collectPickup(T)}}async collectPickup(e){e.isPickedUp=!0,e.lightId&&$e.getInstance().removeLight(e.lightId);const i=d=>{const g=d.indexOf(e);g!==-1&&d.splice(g,1)};i(this.pickups),e.type.category==="block"?i(this.blockPickups):i(this.resourcePickups);const n=this.playerShip.getTransform().position,r=$e.getInstance();let c=N2[e.type.category]??"#ffffff";if(e.type.category==="block"&&e.type.blockTypeId){const d=bi(e.type.blockTypeId);c=Rp[d]??c}const u=si({x:n.x,y:n.y,radius:320+Math.random()*100,color:c,intensity:1.2,life:.5,expires:!0});r.registerLight(u);let h=!1;if(e.type.category==="currency"){const d=e.currencyAmount;this.playerResources.addCurrency(d),Ce.addCurrency(d),h=await Q.play("assets/sounds/sfx/ship/gather_00.wav","sfx",{volume:1.25,pitch:this.currencyPickupPitch+.25,maxSimultaneous:8}),h&&(this.timeSinceLastCurrencyPickup=0,this.currencyPickupPitch=Math.min(this.currencyPickupPitch+dt.PICKUP_PITCH_INCREMENT,dt.MAX_PICKUP_PITCH))}else if(e.type.category==="block"&&e.type.blockTypeId){Ce.incrementBlockCollectedCount(),h=await Q.play("assets/sounds/sfx/ui/start_00.wav","sfx",{volume:.8,pitch:this.blockPickupPitch,maxSimultaneous:8}),h&&(this.timeSinceLastBlockPickup=0,this.blockPickupPitch=Math.min(this.blockPickupPitch+dt.PICKUP_PITCH_INCREMENT,dt.MAX_PICKUP_PITCH));const d=bi(e.type.blockTypeId),g=Pm[d]??["#fff"];Bl(n.x,n.y,360,1,.5,g);const m=ni(e.type.blockTypeId);this.blockDropDecisionMenu.enqueueBlock(Rb(m))}else if(e.type.category==="repair"){const d=e.repairAmount;KT(this.playerShip,d,this.shipBuilderEffects),Q.play("assets/sounds/sfx/ship/repair_00.wav","sfx",{maxSimultaneous:3})}else console.warn("Unhandled pickup category or malformed pickup:",e)}};dt.BASE_PICKUP_PITCH=.8,dt.PICKUP_PITCH_INCREMENT=.05,dt.MAX_PICKUP_PITCH=2.2,dt.PITCH_RESET_DELAY=3.2;let Sh=dt;function tl(a,e){return Math.random()*(e-a)+a}function tC(a,e){return Math.floor(Math.random()*(e-a+1))+a}function jp(){return Math.random()*2*Math.PI}const iC=3;class sC{constructor(e){this.lightingOrchestrator=e,this.activeParticles=[],this.particlePool=[],this.CULL_PADDING=128,this.emissionAccumulator=0}_createAndRegisterParticle(e,i){var g,m;const{colors:n=["#00f","#009","#00a9f4","#1e90ff"],sizeRange:r=[1,4],lifeRange:c=[1,2]}=i;let u,h;if(i.randomDirection){const y=jp(),v=((g=i.speedRange)==null?void 0:g[0])??0,M=((m=i.speedRange)==null?void 0:m[1])??i.baseSpeed??1,S=tl(v,M);u=Math.cos(y)*S,h=Math.sin(y)*S}else if(i.velocity)u=i.velocity.x,h=i.velocity.y;else{const y=jp(),v=tl(0,i.baseSpeed??1);u=Math.cos(y)*v,h=Math.sin(y)*v}const d=this.getParticle();if(d.x=e.x,d.y=e.y,d.vx=u,d.vy=h,d.size=tl(r[0],r[1])*iC,d.life=tl(c[0],c[1]),d.initialLife=d.life,d.fadeOut=i.fadeOut??!1,d.fadeMode=i.fadeMode??"linear",d.renderAlpha=1,d.color=n[tC(0,n.length-1)],this.lightingOrchestrator&&i.light){const y=si({x:d.x,y:d.y,radius:d.size*(i.lightRadiusScalar??3),color:d.color,intensity:i.lightIntensity??1,life:d.life,expires:!0,fadeMode:i.fadeMode??"linear"});this.lightingOrchestrator.registerLight(y),d.lightId=y.id}return this.activeParticles.push(d),d}emitBurst(e,i,n={}){for(let r=0;r<i;r++)this.spawnParticle(e,n)}emitContinuous(e,i,n,r={}){const c=Math.min(i,.05);this.emissionAccumulator+=n*c;const u=Math.floor(this.emissionAccumulator);this.emissionAccumulator-=u;for(let h=0;h<u;h++)this.spawnParticle(e,r)}emitParticle(e,i={}){return this._createAndRegisterParticle(e,i)}spawnParticle(e,i={}){this._createAndRegisterParticle(e,i)}update(e){if(Ae.getInstance().isParticlesEnabled()){for(const i of this.activeParticles){if(i.x+=i.vx*e,i.y+=i.vy*e,i.life-=e,i.lightId){const c=this.lightingOrchestrator.getLightById(i.lightId);c&&(c.type==="point"||c.type==="spot")&&(c.x=i.x,c.y=i.y)}const n=i.initialLife?i.life/i.initialLife:1,r=.1;switch(i.fadeMode){case"delayed":i.renderAlpha=n>=r?1:n/r;break;case"linear":default:i.renderAlpha=n;break}}this.activeParticles=this.activeParticles.filter(i=>{const n=i.life>0;return n||this.recycleParticle(i),n})}}getActiveParticles(){return this.activeParticles}getParticle(){return this.particlePool.pop()||{x:0,y:0,vx:0,vy:0,size:1,life:1,color:"#fff",speed:0}}removeParticle(e){const i=this.activeParticles.indexOf(e);i!==-1&&(this.activeParticles.splice(i,1),this.recycleParticle(e))}recycleParticle(e){e.lightId&&(this.lightingOrchestrator.removeLight(e.lightId),e.lightId=void 0),e.initialLife=void 0,e.fadeOut=void 0,e.fadeMode=void 0,e.renderAlpha=void 0,this.particlePool.push(e)}}const nC=["#fff","#f90","#ff0"],Kp=32,aC=16,Zp=100,oC=.1;class Wm{constructor(e){this.sparkManager=e,this.colorCache=new Map,this.playerSettings=Ae.getInstance(),this.lightingOrchestrator=$e.getInstance()}emit(e){if(!this.playerSettings.isParticlesEnabled())return;const{coord:i,blockRotation:n,shipRotation:r,shipPosition:c,block:u,afterBurner:h,afterBurnerJustActivated:d,pulseJustActivated:g,superPulseJustActivated:m}=e,y=(u==null?void 0:u.type.id)??"",v=this.colorCache.get(y)??F2[y]??nC;this.colorCache.set(y,v);const M=Math.cos(r),S=Math.sin(r),T=n*(Math.PI/180),w=i.x*Kp,A=i.y*Kp,R=c.x+(w*M-A*S),I=c.y+(w*S+A*M),x=Math.cos(T),P=Math.sin(T),N=-16*P,W=aC*x,H=R+(N*M-W*S),q=I+(N*S+W*M),ie=P*M-x*S,$=P*S+x*M,K=ie*Zp,ne=$*Zp,Z={x:K*(h?3:1),y:ne*(h?3:1)};if(this.sparkManager.emitBurst({x:H,y:q},2,{colors:v,velocity:Z,baseSpeed:1,sizeRange:h?[2,4]:[1,3],lifeRange:[.08,.18],fadeOut:!0}),d){const te={x:H,y:q};let _=220,X="#ffffff",se=["#ffffcc","#ffee88","#ffaa44"],oe=12;g&&(_=300,X="#ffcc00",se=["#ffcc00","#ffaa00","#ff8800"],oe=18),m&&(_=300,X="#00ffff",se=["#ccffff","#88ddff","#ffffff"],oe=24),Bl(te.x,te.y,_,1,.35,X),this.sparkManager.emitBurst(te,oe,{colors:se,randomDirection:!0,speedRange:[120,320],sizeRange:[1,3],lifeRange:[.25,.65],fadeOut:!0})}if(this.playerSettings.isLightingEnabled()&&Math.random()<oC){const te=si({x:H,y:q,radius:25+Math.random()*50,color:v[0],intensity:1+Math.random()*.5,life:.45+Math.random()*.15,expires:!0});this.lightingOrchestrator.registerLight(te)}}}class rC{constructor(e,i,n,r){this.camera=e,this.inputManager=i,this.cursorRenderer=n,this.playerShip=r,this.isEnginePlaying=!1,this.lastFiringModeSwitchTime=-1/0}getIntent(){const e=this.inputManager.isShiftPressed(),i=this.inputManager.getGamepadMovementVector(),n=Math.hypot(i.x,i.y),r=xt.getInstance().getLastUsed()==="gamepad",c=r&&!e&&n>.1,u=this.inputManager.isActionPressed("brake");let h=!1;u||(r?h=n>.1:h=this.inputManager.isActionPressed("thrustForward"));const d=this.inputManager.isActionPressed("afterburner"),g=h&&d,m={thrustForward:h,brake:u,rotateLeft:this.inputManager.isActionPressed("rotateLeft")&&!(r&&c),rotateRight:this.inputManager.isActionPressed("rotateRight")&&!(r&&c),strafeLeft:this.inputManager.isActionPressed("strafeLeft")||e&&n>.1,strafeRight:this.inputManager.isActionPressed("strafeRight")||e&&n>.1,turnToAngle:c?Math.atan2(i.y,i.x)+Math.PI/2:void 0,afterburner:g},y=this.inputManager.isActionPressed("firePrimary"),v=this.inputManager.isActionPressed("fireSecondary"),M=this.playerShip.getTransform().position,S=this.inputManager.getGamepadAimVector(),T=800,A=S.x!==0||S.y!==0?this.normalize(S.x,S.y):r?{x:Math.cos(this.playerShip.getTransform().rotation-Math.PI/2),y:Math.sin(this.playerShip.getTransform().rotation-Math.PI/2)}:null,R=A?{x:M.x+A.x*T,y:M.y+A.y*T}:this.camera.screenToWorld(this.inputManager.getMousePosition().x,this.inputManager.getMousePosition().y),I={firePrimary:y,fireSecondary:v,aimAt:R,firingMode:this.playerShip.getFiringMode()};y||v?this.cursorRenderer.setTargetCrosshairCursor():this.cursorRenderer.setDefaultCursor();const P={toggleShields:this.inputManager.wasActionJustPressed("fireTertiary")},N=performance.now();if(this.inputManager.wasActionJustPressed("switchFiringMode")&&N-this.lastFiringModeSwitchTime>=1e3){this.lastFiringModeSwitchTime=N;const H=this.playerShip.getFiringMode()===Wt.Synced?Wt.Sequence:Wt.Synced;this.playerShip.setFiringMode(H),Q.play("assets/sounds/sfx/ship/attach_00.wav","sfx");const q=H===Wt.Synced?"#00ffff":"#ff0000";Bl(M.x,M.y,520,1.2,.4,q)}return{movement:m,weapons:I,utility:P}}normalize(e,i){const n=Math.hypot(e,i);return n>1e-5?{x:e/n,y:i/n}:{x:0,y:0}}}class lC{constructor(e,i,n,r,c){this.inputManager=e,this.canvasManager=i,this.waveSpawner=n,this.playerShip=r,this.coachMarkManager=c,this.dialogueQueueManager=Eo.create(),this.scriptQueue=[]}initialize(){this.enqueueInitialDialogues(),this.tryStartNextScript()}enqueueInitialDialogues(){const e=qi.getMissionDialogue();e&&ln(e,this.getDialogueContext())&&this.scriptQueue.push(e)}getDialogueContext(){return{inputManager:this.inputManager,playerShip:this.playerShip,waveSpawner:this.waveSpawner,coachMarkManager:this.coachMarkManager}}tryStartNextScript(){if(this.dialogueQueueManager.isRunning()||this.scriptQueue.length===0)return;const e=this.scriptQueue.shift(),i=ln(e,this.getDialogueContext());i&&this.dialogueQueueManager.startScript(i)}update(e){this.dialogueQueueManager.update(e),this.dialogueQueueManager.isRunning()||this.tryStartNextScript()}render(){const e=this.canvasManager.getContext("dialogue");this.dialogueQueueManager.render(e)}destroy(){this.dialogueQueueManager.clear(),this.dialogueQueueManager.destroy();const e=this.canvasManager.getContext("dialogue");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}class ji{constructor(e,i){this.getPosition=e,this.behavior=i,this.elapsed=0}update(e){this.elapsed+=e}isExpired(){return this.elapsed>=(this.behavior.duration??2.5)}}class cC extends ji{constructor(e,i){super(e,i),this.behavior=i}render(e){const i=this.getPosition(),n=ae(),r=this.resolveArrowAngle(),c=(this.behavior.arrowLength??30)*n,u=i.x+c*Math.cos(r),h=i.y+c*Math.sin(r);e.save(),e.strokeStyle=this.behavior.arrowColor??"#ffffff",e.lineWidth=2*n,e.beginPath(),e.moveTo(u,h),e.lineTo(i.x*n,i.y*n),e.stroke(),e.restore()}resolveArrowAngle(){switch(this.behavior.arrowDirection){case"up":return-Math.PI/2;case"down":return Math.PI/2;case"left":return Math.PI;case"right":return 0;default:return 0}}}class uC extends ji{constructor(e,i){super(e,i),this.behavior=i}render(e){const i=this.getPosition(),n=ae(),r=this.behavior.boxWidth??100,c=this.behavior.boxHeight??40,u=r*n,h=c*n,d={x:i.x*n,y:i.y*n};e.save(),e.strokeStyle=this.behavior.boxStrokeColor??"#ffffff",e.lineWidth=this.behavior.boxLineWidth??2*ae(),e.strokeRect(d.x-u/2,d.y-h/2,u,h),e.restore()}}class hC extends ji{constructor(e,i){super(e,i),this.behavior=i,this.image=new Image,this.image.src=i.imageSrc}render(e){if(!this.image.complete)return;const i=this.getPosition(),n=ae(),r=(this.behavior.imageWidth??this.image.width)*n,c=(this.behavior.imageHeight??this.image.height)*n;e.drawImage(this.image,i.x-r/2,i.y-c/2,r,c)}}class fC extends ji{constructor(e,i,n){super(i,n),this.behavior=n,this.label=e}render(e){const i=this.getPosition(),n=ae(),r=(this.behavior.fontSize??14)*n,c=this.behavior.labelOffset??{x:0,y:-30};e.save(),e.font=`${Math.round(r)}px ${this.behavior.fontFamily??"monospace"}`,e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.behavior.textColor??"#FFFFFF",e.fillText(this.label,i.x+c.x,i.y+c.y),e.restore()}}class dC extends ji{constructor(e,i){super(e,i),this.floatTimer=0,this.behavior=i}update(e){super.update(e),this.floatTimer+=e}render(e){const i=this.getPosition(),n=ae(),r=Math.sin(this.floatTimer*2*Math.PI)*5,c=(this.behavior.width??36)*n,u=(this.behavior.height??36)*n,h=(this.behavior.fontSize??18)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.textColor??"#FFFFFF",y=this.behavior.keyLabel,v=i.x*n,M=(i.y+r)*n;e.save(),e.font=`${Math.round(h)}px monospace`;const S=e.measureText(y).width,T=12*n,A=Math.max(c,S+T*2);e.fillStyle=g,e.strokeStyle=d,e.lineWidth=2*n,e.beginPath(),e.roundRect(v-A/2,M-u/2,A,u,6),e.fill(),e.stroke(),e.fillStyle=m,e.textAlign="center",e.textBaseline="middle",e.fillText(y,v,M),e.restore()}}class gC extends ji{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),r=i.x*n,c=i.y*n,u=(this.behavior.width??50)*n,h=(this.behavior.height??80)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.highlightColor??"#00FFFF",y=this.behavior.interactionMode,v=.5+.5*Math.sin(this.animationTimer*Math.PI*2),M=y==="wiggle"?Math.sin(this.animationTimer*6)*6:0;e.save(),e.translate(r+M,c),e.lineWidth=2*n,e.beginPath(),e.strokeStyle=d,e.fillStyle=g,e.roundRect(-u/2,-h/2,u,h,12),e.fill(),e.stroke();const S=h*.25,T=u*.4,w=-u*.45,A=u*.05,R=-h/2+S/2+4;e.beginPath(),e.roundRect(w,R-S/2,T,S,4),e.fillStyle=y==="leftClick"?lh(m,v):g,e.fill(),e.strokeStyle=d,e.stroke(),e.beginPath(),e.roundRect(A,R-S/2,T,S,4),e.fillStyle=y==="rightClick"?lh(m,v):g,e.fill(),e.strokeStyle=d,e.stroke();const I=6*n,x=R+S/2+12;e.beginPath(),e.arc(0,x,I,0,Math.PI*2),e.fillStyle=y==="scroll"?lh(m,v):"#888888",e.fill(),e.strokeStyle=d,e.stroke(),e.restore()}}function lh(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),r=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16);return`rgba(${n}, ${r}, ${c}, ${i.toFixed(2)})`}class pC extends ji{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),r=i.x*n,c=i.y*n,u=(this.behavior.radius??60)*n,h=(this.behavior.fontSize??16)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.highlightColor??"#00FFFF",y=this.behavior.textColor??"#FFFFFF",v=.5+.5*Math.sin(this.animationTimer*Math.PI*2),M=R=>this.behavior.highlightButton===R?mC(m,v):g;e.save(),e.translate(r,c),e.lineWidth=2*n,e.beginPath(),e.fillStyle=g,e.strokeStyle=d,e.arc(0,0,u,0,Math.PI*2),e.fill(),e.stroke();const S=u*.25,T=u*.5,w={Y:[0,-T],A:[0,T],X:[-T,0],B:[T,0]},A=R=>{const[I,x]=w[R];e.beginPath(),e.fillStyle=M(R),e.strokeStyle=d,e.arc(I,x,S,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle=y,e.font=`${Math.round(h)}px monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(R,I,x)};A("A"),A("B"),A("X"),A("Y"),e.restore()}}function mC(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),r=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16);return`rgba(${n}, ${r}, ${c}, ${i.toFixed(2)})`}class yC extends ji{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),r=i.x*n,c=i.y*n,u=(this.behavior.width??120)*n,h=(this.behavior.height??60)*n,d=12*n,g=5*n,m=.5+.5*Math.sin(this.animationTimer*Math.PI*2),y=this.behavior.borderColor??"#FFFFFF",v=this.behavior.fillColor??"#222222",M=this.behavior.highlightColor??"#00FFFF",{highlightStick:S,wiggleStick:T}=this.behavior,w=S==="left"?m:0,A=S==="right"?m:0,R=T==="left"?Math.sin(this.animationTimer*4)*g:0,I=T==="right"?Math.sin(this.animationTimer*4)*g:0;e.save(),e.translate(r,c),e.lineWidth=2*n,e.beginPath(),e.strokeStyle=y,e.fillStyle=v,e.roundRect(-u/2,-h/2,u,h,12),e.fill(),e.stroke();const x=-u*.3+R,P=0;e.beginPath(),e.arc(x,P,d,0,Math.PI*2),e.fillStyle=this.behavior.highlightStick==="left"?Qp(M,w):"#444444",e.fill(),e.strokeStyle=y,e.stroke();const N=u*.3+I;e.beginPath(),e.arc(N,P,d,0,Math.PI*2),e.fillStyle=this.behavior.highlightStick==="right"?Qp(M,A):"#444444",e.fill(),e.strokeStyle=y,e.stroke(),e.restore()}}function Qp(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),r=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16);return`rgba(${n}, ${r}, ${c}, ${i.toFixed(2)})`}class vC extends ji{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),r=i.x*n,c=i.y*n,u=(this.behavior.width??160)*n,h=(this.behavior.height??80)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.highlightColor??"#00FFFF",y=.5+.5*Math.sin(this.animationTimer*Math.PI*2);e.save(),e.translate(r,c),e.lineWidth=2*n,e.beginPath(),e.strokeStyle=d,e.fillStyle=g,e.roundRect(-u/2,-h/2,u,h,12),e.fill(),e.stroke();const v=u*.25,M=h*.25,S=u*.2,T=h*.15;w(e,-u/2-v*.5,-h*.3,v,M,"leftTrigger",m,g,d,this.behavior.highlighted),w(e,u/2-v*.5,-h*.3,v,M,"rightTrigger",m,g,d,this.behavior.highlighted),w(e,-u/2+S*.5,-h/2-T*.5,S,T,"leftBumper",m,g,d,this.behavior.highlighted),w(e,u/2-S*1.5,-h/2-T*.5,S,T,"rightBumper",m,g,d,this.behavior.highlighted),e.restore();function w(A,R,I,x,P,N,W,H,q,ie){A.beginPath(),A.roundRect(R,I,x,P,4),A.fillStyle=ie.includes(N)?bC(W,y):H,A.fill(),A.strokeStyle=q,A.stroke()}}}function bC(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),r=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16);return`rgba(${n}, ${r}, ${c}, ${i.toFixed(2)})`}class SC{constructor(){this.coachMarks=[],this.canvasManager=Ti.getInstance(),this.ctx=this.canvasManager.getContext("ui")}update(e){for(const i of this.coachMarks)i.update(e);this.coachMarks=this.coachMarks.filter(i=>!i.isExpired())}render(){for(const e of this.coachMarks)e.render(this.ctx)}clear(){this.coachMarks.length=0}createScreenCoachMark(e,i,n,r){const c=()=>({x:i,y:n});this.create(e,c,r)}createWorldCoachMark(e,i,n,r,c){const u=()=>r.worldToScreen(i,n);this.create(e,u,c)}create(e,i,n){let r;switch(n.type){case"arrow":r=new cC(i,n);break;case"box":r=new uC(i,n);break;case"image":r=new hC(i,n);break;case"text":r=new fC(e,i,n);break;case"key":r=new dC(i,n);break;case"mouse":r=new gC(i,n);break;case"gamepadFaceButtons":r=new pC(i,n);break;case"gamepadSticks":r=new yC(i,n);break;case"gamepadShoulders":r=new vC(i,n);break;default:throw new Error(`Unhandled coach mark type: ${n.type}`)}this.coachMarks.push(r)}}const MC=a=>{const e=(a%360+360)%360;return e===0?"forward":e===90?"strafeRight":e===270?"strafeLeft":null},ch=500,$p=.4,TC=2,CC=12,wC=15,AC=.5,kC=3,Jp=2,EC=.94,RC=.6,BC=.6,IC=1,xC=1,uh=8,_C=.15,DC=1.6,PC=2.2,LC=1.4,OC=3.5,FC=1.5;class zm{constructor(e,i,n){this.ship=e,this.emitter=i,this.collisionSystem=n,this.fallbackThrustPower=10,this.baseThrust=5,this.externalImpulse={x:0,y:0},this.afterburnerCharge=0,this.wasAfterburnerActiveLastFrame=!1,this.currentIntent={thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1}}setIntent(e){this.currentIntent=e}applyExternalImpulse(e,i){this.externalImpulse.x+=e,this.externalImpulse.y+=i}getAfterburnerCharge(){return this.afterburnerCharge}rotateVector(e,i,n){const r=Math.cos(n),c=Math.sin(n);return{x:e*r-i*c,y:e*c+i*r}}getBlockThrustDirection(e){const i=e*(Math.PI/180),n=Math.sin(i),r=-Math.cos(i);return{x:n,y:r}}updateAfterburnerCharge(e){const i=this.ship.getAfterburnerComponent(),n=this.currentIntent.afterburner??!1;let r=!1;if(i){i.setActive(n),i.update(e);const c=i.isActive();r=c&&!this.wasAfterburnerActiveLastFrame,this.wasAfterburnerActiveLastFrame=c,c?this.afterburnerCharge=Math.min(1,this.afterburnerCharge+OC*e):this.afterburnerCharge=Math.max(0,this.afterburnerCharge-FC*e)}else this.afterburnerCharge=0,this.wasAfterburnerActiveLastFrame=!1;return r}getAfterburnerMultipliers(){const e=this.afterburnerCharge,i=this.ship.getAfterburnerSpeedMultiplier()||DC,n=this.ship.getAfterburnerAccelMultiplier()||PC;return{speed:1+(i-1)*e,accel:1+(n-1)*e,turning:1+(LC-1)*e}}update(e){const i=this.ship.getTransform(),{position:n,velocity:r}=i,{rotateLeft:c,rotateRight:u,thrustForward:h,brake:d,strafeLeft:g,strafeRight:m}=this.currentIntent,y=this.updateAfterburnerCharge(e),v=this.getAfterburnerMultipliers();this.ship.setThrusting(h),this.ship.setStrafingLeft(g),this.ship.setStrafingRight(m),r.x+=this.externalImpulse.x,r.y+=this.externalImpulse.y,this.externalImpulse.x=0,this.externalImpulse.y=0;const M=this.ship.getTotalMass(),S=Math.min(1,Math.pow(ch/Math.max(M,1),BC)),T={forward:[],strafeLeft:[],strafeRight:[]};let w=TC;for(const[W,H]of this.ship.getAllBlocks()){const q=H.type.behavior;if(q!=null&&q.canThrust){const ie=q.thrustPower??this.baseThrust,$=MC(H.rotation??0);$&&T[$].push({coord:W,power:ie,rotation:H.rotation??0})}H.type.id.startsWith("fin")&&(w+=(q==null?void 0:q.turnPower)??0)}const A=Math.min(CC,Math.pow(w,EC)),R=Math.min(A*S*RC*v.turning,wC);let I=0;if(this.currentIntent.turnToAngle!==void 0){const{rotation:W}=i;let q=this.currentIntent.turnToAngle-W;for(;q>Math.PI;)q-=2*Math.PI;for(;q<-Math.PI;)q+=2*Math.PI;I=q*Jp*v.turning,I=Math.max(-R,Math.min(I,R))}else c?I=-R:u&&(I=R);const x=I-i.angularVelocity;if(i.angularVelocity+=x*Jp*v.turning*e,i.angularVelocity=Math.max(-R,Math.min(i.angularVelocity,R)),h&&this.applyDirectionalThrust(e,"forward",T.forward,i,n,v,y),g&&this.applyDirectionalThrust(e,"strafeLeft",T.strafeLeft,i,n,v,y),m&&this.applyDirectionalThrust(e,"strafeRight",T.strafeRight,i,n,v,y),!h&&!g&&!m){const W=Math.pow(AC,e);r.x*=W,r.y*=W}if(d){const W=Math.hypot(r.x,r.y);if(W>0){const H=r.x/W,q=r.y/W,K=([...T.forward,...T.strafeLeft,...T.strafeRight].reduce((_,X)=>_+X.power,0)+this.fallbackThrustPower)*e*IC,ne=r.x-H*K,Z=r.y-q*K;ne*r.x+Z*r.y<0?(r.x=0,r.y=0):(r.x=ne,r.y=Z)}}if(this.ship.getIsPlayerShip()){this.collisionSystem.resolveCollisions(this.ship);const W=i.velocity;W.x=Math.round(W.x*1e3)/1e3,W.y=Math.round(W.y*1e3)/1e3}const{thrustPowerMulti:P=1,turnPowerMulti:N=1}=this.ship.getAffixes()??{};i.rotation+=i.angularVelocity*e*N,n.x+=r.x*e*P,n.y+=r.y*e*P,this.ship.updateBlockPositions()}applyDirectionalThrust(e,i,n,r,c,u,h){var te,_,X,se,oe;let d=0,g=0;const m=this.fallbackThrustPower,y=n.length+1,v=xC,S=n.reduce((k,G)=>k+G.power,0)+m,T=(()=>{if(y<=uh)return S*v;const k=S/y*uh,G=y-uh,ee=S/y,J=1/(1+_C*G),re=ee*G*J;return(k+re)*v})(),w=this.ship.getTotalMass(),A=Math.min(1,Math.pow(ch/Math.max(w,1),$p)),R=T*u.speed*A,I=(()=>{switch(i){case"forward":return this.rotateVector(0,-1,r.rotation);case"strafeLeft":return this.rotateVector(-1,0,r.rotation);case"strafeRight":return this.rotateVector(1,0,r.rotation)}})();d+=I.x*m,g+=I.y*m;const x=Tt.getInstance().getPlayerShip();let P=!1,N=!1,W=!1,H=!1,q=!1;if(x&&x!==this.ship){const k=yt.getInstance().getViewportBounds(),G=100,ee=k.x-G,J=k.y-G,re=k.x+k.width+G,ve=k.y+k.height+G,he=this.ship.getTransform().position;P=he.x>=ee&&he.x<=re&&he.y>=J&&he.y<=ve}else N=((te=this.ship.getAfterburnerComponent())==null?void 0:te.wasAfterburnerJustActivated())??!1,W=((_=this.ship.getAfterburnerComponent())==null?void 0:_.wasPulseJustActivated())??!1,H=((X=this.ship.getAfterburnerComponent())==null?void 0:X.isPulsing())??!1,q=((se=this.ship.getAfterburnerComponent())==null?void 0:se.wasSuperPulseJustActivated())??!1,P=!0;this.ship.getIsPlayerShip()&&((W||q||N)&&this.emitPulseSoundAndShake(this.ship.id,W,q),q&&Bl(this.ship.getTransform().position.x,this.ship.getTransform().position.y,300,1.5,.5,"#ffffff"));for(const{coord:k,power:G,rotation:ee}of n){const J=this.ship.getBlock(k);if(!J)continue;const re=this.getBlockThrustDirection(ee),ve=this.rotateVector(re.x,re.y,r.rotation);d+=ve.x*G,g+=ve.y*G,P&&this.emitter.emit({coord:k,block:J,blockRotation:ee,shipRotation:r.rotation,shipPosition:c,afterBurner:((oe=this.ship.getAfterburnerComponent())==null?void 0:oe.isActive())??!1,afterBurnerJustActivated:h,isPulsing:H,pulseJustActivated:W,superPulseJustActivated:q})}const ie=Math.min(1,Math.pow(ch/Math.max(w,1),$p)),$=d*e*ie*u.accel,K=g*e*ie*u.accel;r.velocity.x+=$,r.velocity.y+=K;const ne=Math.sqrt(r.velocity.x**2+r.velocity.y**2);if(ne>0){const k=r.velocity.x/ne,G=r.velocity.y/ne,ee=I.x-k,J=I.y-G,re=kC*u.turning;r.velocity.x+=ee*re*ne*e,r.velocity.y+=J*re*ne*e}const Z=r.velocity.x*I.x+r.velocity.y*I.y;if(Z>R){const G=1/(1+.5*(Z/R-1)),ee=Z-Z*G;r.velocity.x-=I.x*ee,r.velocity.y-=I.y*ee}}emitPulseSoundAndShake(e,i=!1,n=!1){const r=Tt.getInstance(),c=r.getPlayerShip(),u=r.getById(e);let h="assets/sounds/sfx/explosions/afterburner_00.wav";if(n?h="assets/sounds/sfx/ui/sub_00.wav":i&&(h="assets/sounds/sfx/explosions/afterburner_00.wav"),u&&(ti(u,c,{file:h,channel:"sfx",baseVolume:1,pitchRange:[1,1.3],volumeJitter:.15,maxSimultaneous:5}),n&&ti(u,c,{file:"assets/sounds/sfx/explosions/superpulse_00.wav",channel:"sfx",baseVolume:1,pitchRange:[1.1,1.4],volumeJitter:.1,maxSimultaneous:5})),u&&u===c){let d=4,g=.16;i&&(d=6,g=.18),n&&(d=9,g=.2),pe.emit("camera:shake",{strength:d,duration:g,frequency:10})}}}const Wh=class Wh{static register(e,i){this.registry.set(e.id,i)}static unregister(e){this.registry.delete(e.id)}static get(e){return this.registry.get(e.id)}static clear(){this.registry.clear()}};Wh.registry=new Map;let wo=Wh;function em(a){return typeof a.getAffixes=="function"?a.getAffixes()??{}:{}}const bt=class bt{constructor(e){this.combatService=e}resolveCollisions(e){if(!Ae.getInstance().isCollisionsEnabled())return;const i=this.getNearbyObjects(e);for(const n of i){if(!this.aabbOverlap(e,n))continue;e.setColliding(!0),n.setColliding(!0),this.applyCollisionDamage(e,n);const r=this.computeMinimumSeparationVector(e,n);r&&(this.resolvePenetration(e,n,r),this.resolveImpulse(e,n,r))}}getNearbyObjects(e){const i=this.computeAABB(e),n=e.getGrid().getBlocksInArea(i.x,i.y,i.x+i.width,i.y+i.height),r=new Set;for(const c of n){const u=zt.getObject(c);u&&u!==e&&r.add(u)}return Array.from(r)}aabbOverlap(e,i){const n=this.computeAABB(e),r=this.computeAABB(i);return!(n.x+n.width<r.x||n.x>r.x+r.width||n.y+n.height<r.y||n.y>r.y+r.height)}computeAABB(e){let i=1/0,n=-1/0,r=1/0,c=-1/0;for(const[u]of e.getAllBlocks()){const h=ta(e.getTransform(),u);i=Math.min(i,h.x),n=Math.max(n,h.x),r=Math.min(r,h.y),c=Math.max(c,h.y)}return{x:i,y:r,width:n-i+bt.BLOCK_SIZE,height:c-r+bt.BLOCK_SIZE}}computeMinimumSeparationVector(e,i){const n=[];for(const[v]of e.getAllBlocks()){const M=ta(e.getTransform(),v);for(const[S]of i.getAllBlocks()){const T=ta(i.getTransform(),S);this.blocksOverlap(M,T)&&n.push({a:M,b:T})}}if(n.length===0)return null;let r=0,c=0;for(const v of n)r+=v.a.x-v.b.x,c+=v.a.y-v.b.y;const u=n.length;r/=u,c/=u;const h=Math.sqrt(r*r+c*c);if(h===0)return null;const d=bt.BLOCK_SIZE/2,g=bt.PENETRATION_SLOP,m=bt.PENETRATION_CORRECTION_RATIO,y=Math.max(d-g,0)*m;return{x:r/h*y,y:c/h*y}}blocksOverlap(e,i){const n=bt.BLOCK_SIZE;return Math.abs(e.x-i.x)<n&&Math.abs(e.y-i.y)<n}resolvePenetration(e,i,n){var d,g;const r=((d=e.isImmoveable)==null?void 0:d.call(e))??!1,c=((g=i.isImmoveable)==null?void 0:g.call(i))??!1,u=e.getTransform(),h=i.getTransform();if(!(r&&c))if(r)h.position.x-=n.x,h.position.y-=n.y,i.updateBlockPositions();else if(c)u.position.x+=n.x,u.position.y+=n.y,e.updateBlockPositions();else{const m=e.getTotalMass(),y=i.getTotalMass(),v=m+y||1,M=y/v,S=m/v;u.position.x+=n.x*M,u.position.y+=n.y*M,h.position.x-=n.x*S,h.position.y-=n.y*S,e.updateBlockPositions(),i.updateBlockPositions()}}resolveImpulse(e,i,n){var N,W;const r=((N=e.isImmoveable)==null?void 0:N.call(e))??!1,c=((W=i.isImmoveable)==null?void 0:W.call(i))??!1,u=e.getTransform(),h=i.getTransform(),d=u.velocity,g=h.velocity,m=d.x-g.x,y=d.y-g.y,v=m*n.x+y*n.y;if(v>=0)return;const M=e.getTotalMass(),S=i.getTotalMass(),T=M+S||1,w=bt.RESTITUTION,A=Math.max(v,-200),R=-(1+w)*A/T;if(Math.abs(R)<bt.IMPULSE_EPSILON)return;const I=R*n.x,x=R*n.y,P=.95;r&&c||(r?(g.x+=I,g.y+=x,g.x*=P,g.y*=P):c?(d.x-=I,d.y-=x,d.x*=P,d.y*=P):(d.x-=I*S/T,d.y-=x*S/T,g.x+=I*M/T,g.y+=x*M/T,d.x*=P,d.y*=P,g.x*=P,g.y*=P))}applyCollisionDamage(e,i){const n=this.computeRelativeVelocity(e,i),r=Math.sqrt(n.x**2+n.y**2),c=70,u=1500,h=50;if(r<c)return;const g=(Math.min(r,u)-c)/(u-c),y=Math.pow(g,1.35)*h;for(const[v,M]of e.getAllBlocks()){const S=ta(e.getTransform(),v);for(const[T,w]of i.getAllBlocks()){const A=ta(i.getTransform(),T);if(!this.blocksOverlap(S,A))continue;const R=M.type.behavior??{},I=w.type.behavior??{},x=R.rammingDamageMultiplier??1,P=I.rammingDamageMultiplier??1,N=R.rammingArmor??0,W=I.rammingArmor??0,H=em(e)??{},q=em(i)??{},ie=H.rammingDamageInflictMultiplier??1,$=q.rammingDamageInflictMultiplier??1,K=H.rammingArmorMultiplier??1,ne=q.rammingArmorMultiplier??1,Z=N*K,te=W*ne,_=y*x*ie,X=Math.max(0,_-te);this.combatService.applyDamageToBlock(i,e,w,T,X,"collision",null);const se=y*P*$,oe=Math.max(0,se-Z);this.combatService.applyDamageToBlock(e,i,M,v,oe,"collision",null)}}}computeRelativeVelocity(e,i){const n=e.getTransform().velocity,r=i.getTransform().velocity;return{x:n.x-r.x,y:n.y-r.y}}};bt.BLOCK_SIZE=32,bt.PENETRATION_SLOP=4,bt.PENETRATION_CORRECTION_RATIO=.4,bt.RESTITUTION=.2,bt.IMPULSE_EPSILON=.05;let Mh=bt;class Vm{constructor(...e){this.currentIntent=null,this.backends=e}setIntent(e){this.currentIntent=e}update(e,i,n){for(const r of this.backends)r.update(e,i,n,this.currentIntent)}render(e){for(const i of this.backends)i.render&&i.render(e)}destroy(){for(const e of this.backends)e.destroy&&e.destroy()}}class Xm{constructor(...e){this.currentIntent=null,this.backends=e}setIntent(e){this.currentIntent=e}update(e,i,n){for(const r of this.backends)r.update(e,i,n,this.currentIntent)}}class UC{constructor(e){this.name=e}render(e,i,n,r){if(n&&!r){const c=ae(),u=i.getViewportWidth()/2,h=32*c;Bt(e,u,h,this.name,{font:`${c*24}px "Courier New", monospace`,align:"center",baseline:"top",glow:!0,chromaticAberration:!0}),Bt(e,u,h+32*c,"Open Communications: [C]",{font:`${c*16}px "Courier New", monospace`,align:"center",baseline:"top",glow:!0,chromaticAberration:!0})}}update(e){}}class Ym{constructor(e,i,n,r,c,u,h){this.x=e,this.y=i,this.playerShip=n,this.inputManager=r,this.camera=c,this.definition=u,this.waveSpawner=h,this.isInteracting=!1,this.renderer=new UC(u.name),this.dialogueQueueManager=Eo.create()}calculateRanges(){const e=this.playerShip.getTransform().position.x,i=this.playerShip.getTransform().position.y,n=this.x-e,r=this.y-i,c=n*n+r*r,u=this.definition.scale*1e3+1e3,h=u*u,d=(u*.5)**2,g=(u*.25)**2;return{inDrawingRange:c<=h,inTransmissionRange:c<=d,inInteractionRange:c<=g,dx:n,dy:r}}update(e){const{inTransmissionRange:i,inInteractionRange:n}=this.calculateRanges();if(this.renderer.update(e),n&&this.inputManager.wasKeyJustPressed("KeyC")&&!this.isInteracting){this.isInteracting=!0;const r=ln(this.definition.interactionDialogueId,{inputManager:this.inputManager,playerShip:this.playerShip,waveSpawner:this.waveSpawner});r&&this.dialogueQueueManager.startScript(r)}this.dialogueQueueManager.isRunning()?(this.dialogueQueueManager.update(e),this.inputManager.wasMouseClicked()&&this.dialogueQueueManager.skipOrAdvance()):this.isInteracting=!1}render(e,i,n){const{inDrawingRange:r,inTransmissionRange:c,inInteractionRange:u,dx:h,dy:d}=this.calculateRanges();r&&this.renderer.render(i,this.camera,u,this.isInteracting),this.dialogueQueueManager.render(n)}getPosition(){return{x:this.x,y:this.y}}}const NC={name:"Ferrust",imagePath:"assets/planets/17.png",scale:5,interactionDialogueId:"planet-generic"},HC={name:"Gilipe",imagePath:"assets/planets/5.png",scale:8,interactionDialogueId:"planet-generic"},GC={name:"Arsea",imagePath:"assets/planets/6.png",scale:10,interactionDialogueId:"planet-generic"},pl=new Map;function Gh(a){if(pl.has(a.name))throw new Error(`Duplicate planet registration: ${a.name}`);pl.set(a.name,a)}Gh(NC);Gh(HC);Gh(GC);const qm={getPlanetByName(a){const e=pl.get(a);if(!e)throw new Error(`Planet "${a}" not found in registry`);return e},getAll(){return Array.from(pl.values())}},WC={createPlanetByName(a,e,i,n,r,c,u){const h=qm.getPlanetByName(a);return new Ym(e,i,n,r,c,h,u)}};class zC{constructor(e,i,n,r,c,u){this.playerShip=e,this.inputManager=i,this.camera=n,this.canvasManager=r,this.waveSpawner=c,this.unifiedRenderer=u,this.planets=new Set,this.ctx=r.getContext("background"),this.overlayCtx=r.getContext("ui"),this.dialogueCtx=r.getContext("dialogue"),this.unifiedRenderer=u}registerPlanetsFromConfigs(e){for(const{name:i,x:n,y:r}of e)this.registerPlanetByName(i,n,r)}registerPlanet(e,i,n){const r=new Ym(i,n,this.playerShip,this.inputManager,this.camera,e,this.waveSpawner);this.planets.add(r),this.unifiedRenderer.addPlanet({name:e.name,x:i,y:n},e.scale??1,e.imagePath)}registerPlanetByName(e,i,n){const r=WC.createPlanetByName(e,i,n,this.playerShip,this.inputManager,this.camera,this.waveSpawner);this.planets.add(r);const c=qm.getPlanetByName(e);this.unifiedRenderer.addPlanet({name:e,x:i,y:n},c.scale??1,c.imagePath)}getPlanets(){return Array.from(this.planets)}clear(){this.planets.clear()}update(e){for(const i of this.planets)i.update(e)}render(e){for(const i of this.planets)i.render(this.ctx,this.overlayCtx,this.dialogueCtx)}}class VC{constructor(e){this.pickupSystem=e}spawnPickupOnBlockDestruction(e){var u,h,d,g;const i=e.type,n=i.dropRate??0,r=qi.getDropMultiplier(),c=Math.min(n*r,1);if(Math.random()<c){const m={x:((u=e.position)==null?void 0:u.x)??0,y:((h=e.position)==null?void 0:h.y)??0};this.pickupSystem.spawnBlockPickup(m,i);return}if(Math.random()<.2){const m={x:((d=e.position)==null?void 0:d.x)??0,y:((g=e.position)==null?void 0:g.y)??0};if(Math.random()<.07){const y=this.getRepairAmountForBlock(e);this.pickupSystem.spawnRepairPickup(m,y)}else{const y=this.getCurrencyAmountForBlock(e);this.pickupSystem.spawnCurrencyPickup(m,y)}}}getCurrencyAmountForBlock(e){const i=e.type.id,n=bi(i),c={0:5,1:10,2:15,3:25,4:35,5:40,6:45,7:50,8:60,9:75,10:80}[n]??0,u=Math.floor(Math.random()*1.5);return c+u}getRepairAmountForBlock(e){const i=e.type.id,n=bi(i),c={0:10,1:15,2:20,3:30,4:40,5:55,6:70,7:80,8:90,9:95,10:100}[n]??5,u=Math.floor(Math.random()*2);return c+u}}function XC(a,e){const i=a.getTransform(),n={position:i.position,rotation:i.rotation},r=a.getAllBlocks().map(([c,u])=>(e.addBlockToCell(u),{id:u.type.id,coord:c,rotation:u.rotation??0}));return{transform:n,blocks:r,behavior:{type:"default"}}}function YC(a,e){return fetch(Mi(`/assets/ships/${a}`)).then(i=>i.json()).then(i=>{var r;const n=new It(e);return n.loadFromJson(i),{ship:n,behaviorType:(r=i.behavior)==null?void 0:r.type}})}function qC(a,e,i){const n=XC(a,e),r=JSON.stringify(n,null,2);localStorage.setItem(i,r);const c=new Blob([r],{type:"application/json"}),u=document.createElement("a");u.href=URL.createObjectURL(c),u.download=i,u.click()}class jC{constructor(e,i,n,r,c){this.ship=e,this.menu=i,this.camera=n,this.shipBuilderEffects=r,this.inputManager=c,this.rotation=0,this.lastBlockId=null,this.hasSaved=!1,this.hoveredShipCoord=null}update(e){var h;this.inputManager.wasKeyJustPressed("Space")&&(this.rotation=(this.rotation+90)%360);const i=this.inputManager.getMousePosition();if(this.isCursorOverMenu(i))return;const n=fa(i,this.camera,e.position,e.rotation);if(this.menu.getActiveTool()===_e.REPAIR){const d=this.ship.getBlock(n);this.menu.setHoveredShipBlock(d),d&&this.inputManager.wasMouseClicked()&&(Q.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n));return}const r=this.menu.getSelectedBlockId();if(!r||(r!==this.lastBlockId&&(this.rotation=0,this.lastBlockId=r),!Yi(r)))return;const u=nm(r);if(u!==void 0){if(this.inputManager.wasRightClicked()){const d=this.ship.getBlock(n);if(!d)return;if(!d.type.id.startsWith("cockpit")){if(!this.ship.isDeletionSafe(n)){Q.play("assets/sounds/sfx/ui/error_00.wav","sfx",{maxSimultaneous:3});return}this.shipBuilderEffects.createSellEffect(d.position),this.ship.removeBlock(n),Q.play("assets/sounds/sfx/ui/click_00.wav","sfx",{maxSimultaneous:3});const m=Math.round(u/2);Be.getInstance().addCurrency(m)}}if(Be.getInstance().hasEnoughCurrency(u)&&this.inputManager.wasMouseClicked()&&!this.ship.hasBlockAt(n)&&Fh(this.ship,n)){this.ship.placeBlockById(n,r,this.rotation);const d=this.ship.getBlock(n);d!=null&&d.position&&this.shipBuilderEffects.createRepairEffect(d.position);const g=((h=ni(r))==null?void 0:h.placementSound)??"assets/sounds/sfx/ship/gather_00.wav";Q.play(g,"sfx",{maxSimultaneous:3}),Be.getInstance().spendCurrency(u),Ce.incrementBlockPlacedCount()}this.inputManager.isLPressed()&&!this.hasSaved&&(qC(this.ship,this.ship.getGrid(),"saved_player_ship.json"),this.hasSaved=!0),!this.inputManager.isLPressed()&&this.hasSaved&&(this.hasSaved=!1)}}render(e,i){const n=this.inputManager.getMousePosition();if(this.isCursorOverMenu(n))return;const r=fa(n,this.camera,i.position,i.rotation),c=r.x*z,u=r.y*z,h=Math.cos(i.rotation),d=Math.sin(i.rotation),g=c*h-u*d,m=c*d+u*h,y=i.position.x+g,v=i.position.y+m,M=this.camera.worldToScreen(y,v);e.save(),e.translate(M.x,M.y),e.scale(this.camera.getZoom(),this.camera.getZoom()),e.rotate(i.rotation);const S=this.menu.getActiveTool();if(S===_e.REPAIR)this.ship.getBlock(r)&&_m(e,"rgba(0,255,0,0.3)");else if(S===_e.PLACE){const T=this.menu.getSelectedBlockId();if(!T){e.restore();return}if(this.ship.getBlock(r)){const A=this.ship.isDeletionSafe(r);Oh(e,A)}else{const A=Yi(T);e.save(),e.rotate(this.rotation*Math.PI/180),e.globalAlpha=.6,e.drawImage(A.base,-32/2,-32/2,z,z),e.restore()}}e.restore()}isCursorOverMenu(e){return this.menu.isPointInBounds(e.x,e.y)}repairBlockAt(e){const i=this.ship.getBlock(e);if(!i||i.type.armor-i.hp<=0)return;const r=Si(i),c=Be.getInstance();c.hasEnoughCurrency(r)&&(c.spendCurrency(r),i.hp=i.type.armor,this.shipBuilderEffects.createRepairEffect(i.position))}repairAllBlocks(){const e=Be.getInstance(),i=this.ship.getAllBlocks().filter(([,n])=>n.hp<n.type.armor).map(([n,r])=>({coord:n,block:r})).sort((n,r)=>{const c=n.block.type.armor-n.block.hp,u=r.block.type.armor-r.block.hp;if(c!==u)return u-c;const h=Si(n.block),d=Si(r.block);return h-d});for(const{coord:n,block:r}of i){const c=Si(r);if(e.hasEnoughCurrency(c))Q.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n);else{console.log("Stopped repair: insufficient funds.");break}}}getHoveredShipBlock(){return this.hoveredShipCoord?this.ship.getBlock(this.hoveredShipCoord):void 0}}class KC{constructor(e,i,n,r){this.explosionSystem=e,this.pickupSpawner=i,this.shipRegistry=n,this.aiOrchestrator=r,this.destructionCallbacks=new Set}onEntityDestroyed(e){this.destructionCallbacks.add(e)}offEntityDestroyed(e){this.destructionCallbacks.delete(e)}destroyEntity(e,i="scripted"){var u,h,d;const n=e.getTransform(),r=e.getAllBlocks();e.getTotalMass();const c=e.id;if(this.destructionCallbacks.forEach(g=>{try{g(e,i)}catch(m){console.error("Error in destruction callback:",m)}}),e instanceof It&&(this.shipRegistry.remove(e),wo.unregister(e),(h=(u=this.aiOrchestrator).removeControllersForShip)==null||h.call(u,c)),e.destroy(),r.forEach(([g,m],y)=>{setTimeout(()=>{this.explosionSystem.createBlockExplosion(n.position,n.rotation,g,50+Math.random()*40,.5+Math.random()*.5,void 0,ia),this.pickupSpawner.spawnPickupOnBlockDestruction(m)},y*50)}),e instanceof It){if(Ae.getInstance().isLightingEnabled()){const v=$e.getInstance(),M="#ffffff",S=1.25,T=4*e.getTotalMass(),A=si({x:n.position.x,y:n.position.y,radius:T,color:M,intensity:S,life:.5,expires:!0});v.registerLight(A)}const g=(d=e.getCockpitCoord)==null?void 0:d.call(e);if(!g)return;const m=Um(e,g),y=v=>`${v.x},${v.y}`;for(const[v,M]of r)m.has(y(v))||setTimeout(()=>{this.explosionSystem.createBlockExplosion(n.position,n.rotation,v,60+Math.random()*20,.5+Math.random()*.3,void 0,ia),this.pickupSpawner.spawnPickupOnBlockDestruction(M)},50+Math.random()*100)}}}const il=5e3,vl=class vl{constructor(){this.playerShip=null,this.grid=null,this.controllerToShipMap=new Map,this.cachedRelevantBlocks=[],this.frameCounter=0,this.REEVALUATE_FRAMES=60,this.hunterControllers=new Set,vl.instance=this}registerPlayerShip(e){this.playerShip=e,this.grid=e.getGrid()}addController(e){const i=e.getShip();i&&(i.updateBlockPositions(),this.controllerToShipMap.set(e,i),e.isHunter()&&this.hunterControllers.add(e))}removeController(e){this.controllerToShipMap.delete(e),this.hunterControllers.delete(e)}getAllControllers(){return this.controllerToShipMap.entries()}removeControllersForShip(e){const i=[];for(const[n,r]of this.controllerToShipMap.entries())r.id===e&&i.push(n);for(const n of i)this.removeController(n)}getControllerCount(){return this.controllerToShipMap.size}getHunterControllerCount(){return this.hunterControllers.size}clear(){this.controllerToShipMap.clear()}update(e){if(!this.playerShip||!this.grid)return;if(this.frameCounter++%this.REEVALUATE_FRAMES===0){const c=this.playerShip.getTransform().position,u=c.x-il,h=c.x+il,d=c.y-il,g=c.y+il;this.cachedRelevantBlocks=this.grid.getBlocksInArea(u,d,h,g)}const i=new Map;for(const[c,u]of this.controllerToShipMap)i.set(u.id,c);const n=new Set;for(const c of this.hunterControllers)n.add(c);for(const c of this.cachedRelevantBlocks){const u=c.ownerShipId;if(!u){console.warn("Block in spatial query missing ownerShipId!",c);continue}const h=i.get(u);h&&n.add(h)}const r=[];for(const c of n)try{const u=c.getShip();if(!u||typeof u.getAllBlocks!="function"){r.push(c);continue}c.update(e)}catch(u){console.error("Error updating AI controller:",u),r.push(c)}for(const c of r)this.removeController(c)}render(e){for(const[i,n]of this.controllerToShipMap)try{typeof i.render=="function"&&i.render(e)}catch(r){console.error("Error rendering AI controller:",r)}}getHunterControllerStates(){return Array.from(this.hunterControllers).map(e=>e.getCurrentStateString())}};vl.instance=null;let Th=vl;class jm{constructor(e,i){this.projectileSystem=e,this.playerShip=i,this.fireSoundTimer=0,this.wasFiringLastFrame=!1}update(e,i,n,r){const c=i.getFiringPlan().filter(y=>y.block.type.id.startsWith("turret")||y.block.type.id.startsWith("cockpit"));if(c.length===0)return;const{fireRateMulti:u=1}=i.getAffixes(),h=r==null?void 0:r.aimAt,d=(r==null?void 0:r.firePrimary)??!1,g=(r==null?void 0:r.firingMode)??Wt.Synced;this.fireSoundTimer++;for(const y of c)y.timeSinceLastShot+=e;const m=d&&!this.wasFiringLastFrame;this.wasFiringLastFrame=d,!(!d||!h)&&(g===Wt.Synced?this.handleSyncedFiring(c,i,n,h,u,e):g===Wt.Sequence&&this.handleSequenceFiring(c,i,n,h,u,e,m))}handleSyncedFiring(e,i,n,r,c,u){for(let h=e.length-1;h>=0;h--){const d=e[h];i.getBlockCoord(d.block)&&(d.timeSinceLastShot<d.fireCooldown/c||(this.spawnTurretProjectile(i,n,d,r),d.timeSinceLastShot=0))}}handleSequenceFiring(e,i,n,r,c,u,h){const d=new Map;for(const m of e){const y=m.block.type.id;d.has(y)||d.set(y,[]),d.get(y).push(m)}const g=i.turretSequenceState;for(const[m,y]of d.entries()){if(y.length===0)continue;const M=y[0].fireCooldown/c,S=M/y.length;let T=g[m];if(T||(T=g[m]={nextIndex:0,lastFiredAt:S}),h){const w=y.find(A=>A.timeSinceLastShot>=M);if(w){const A=y.indexOf(w);this.spawnTurretProjectile(i,n,w,r),w.timeSinceLastShot=0,T.nextIndex=(A+1)%y.length,T.lastFiredAt=0;continue}}if(T.lastFiredAt+=u,T.lastFiredAt>=S){const w=y[T.nextIndex%y.length];if(!i.getBlockCoord(w.block))continue;w.timeSinceLastShot>=M&&(this.spawnTurretProjectile(i,n,w,r),w.timeSinceLastShot=0,T.nextIndex=(T.nextIndex+1)%y.length,T.lastFiredAt=0)}}}spawnTurretProjectile(e,i,n,r){const{coord:c,block:u}=n;n.timeSinceLastShot=0;const h=c.x*32,d=c.y*32,g=Math.cos(i.rotation),m=Math.sin(i.rotation),y=i.position.x+h*g-d*m,v=i.position.y+h*m+d*g,M=u.type.behavior.fire,S=u.type.id,T=kp[S]??kp.turret0;this.fireSoundTimer>5&&(ti(e,this.playerShip,{file:"assets/sounds/sfx/weapons/turret_00.wav",channel:"sfx",pitchRange:[.7,1.4],volumeJitter:.2,baseVolume:1,maxSimultaneous:7}),this.fireSoundTimer=0),this.projectileSystem.spawnProjectile({x:y,y:v},r,M.fireType,M.fireDamage,M.projectileSpeed??300,M.lifetime??2,M.accuracy??1,e.id,e.getFaction(),T,"delayed")}render(e){}}class Km{constructor(e){this.laserSystem=e,this.fireEligibility=new WeakMap}update(e,i,n,r){if(!(r!=null&&r.fireSecondary)){this.fireEligibility.set(i,!1);return}const c=i.getEnergyComponent();if(!c)return;if(!(this.fireEligibility.get(i)??!1))if(c.getCurrent()>=15)this.fireEligibility.set(i,!0);else return;i.getAllBlocks().filter(([d,g])=>{var m,y;return g.type.id.startsWith("laser")&&((m=g.type.behavior)==null?void 0:m.canFire)&&((y=g.type.behavior.fire)==null?void 0:y.fireType)==="laser"}).length!==0&&this.laserSystem.queueUpdate(i,n,r)}render(e){}}class Zm{constructor(e,i,n,r,c){this.combatService=e,this.particleManager=i,this.grid=n,this.explosionSystem=r,this.playerShip=c,this.activeLances=[]}update(e,i,n,r){const c=i.getFiringPlan().filter(d=>{var g,m;return((m=(g=d.block.type.behavior)==null?void 0:g.fire)==null?void 0:m.fireType)==="explosiveLance"});if(c.length===0)return;const u=r==null?void 0:r.aimAt,h=(r==null?void 0:r.firePrimary)??!1;for(let d=c.length-1;d>=0;d--){const g=c[d];if(!i.getBlockCoord(g.block)||(g.timeSinceLastShot+=e,!h||g.timeSinceLastShot<g.fireCooldown))continue;g.timeSinceLastShot=0;const m=g.block.type.behavior.fire,y=m.lifetime??1.5,v=g.coord,M=Math.cos(n.rotation),S=Math.sin(n.rotation),T=v.x*32,w=v.y*32,A=n.position.x+T*M-w*S,R=n.position.y+T*S+w*M,I=u.x-A,x=u.y-R;if(Math.sqrt(I*I+x*x)===0)continue;let N=Math.atan2(x,I);const W=(1-(m.accuracy??1))*Math.PI/8;N+=(Math.random()*2-1)*W;const H=Math.cos(N)*(m.projectileSpeed??300),q=Math.sin(N)*(m.projectileSpeed??300),ie=vo[g.block.type.id]??["#ccc","#aaa","#888"],$=this.particleManager.emitParticle({x:A,y:R},{colors:ie,baseSpeed:0,sizeRange:[4,4],lifeRange:[m.lifetime??1.5,(m.lifetime??1.5)+.1],velocity:{x:H,y:q}}),K=si({x:A,y:R,radius:600,color:ie[0],intensity:.9,life:y+.4,expires:!0});$e.getInstance().registerLight(K),ti(i,this.playerShip,{file:"assets/sounds/sfx/weapons/lance_00.wav",channel:"sfx",baseVolume:.8,pitchRange:[.8,1.2],volumeJitter:.1,maxSimultaneous:3}),this.activeLances.push({position:{x:A,y:R},velocity:{x:H,y:q},fireDamage:m.fireDamage??10,explosionDamage:m.explosionDamage??30,explosionRadius:m.explosionRadiusBlocks??2,detonationDelay:m.detonationDelayMs/1e3,elapsed:0,stuck:!1,targetBlock:null,targetShip:null,coord:null,ownerShipId:i.id,particle:$,ttl:y,age:0,emissionAccumulatorTrail:0,emissionAccumulatorStuck:0,firingBlockId:g.block.type.id,light:K})}this.updateLances(e,i)}updateLances(e,i){const n=new Set;for(const r of this.activeLances){r.age+=e;const c=vo[r.firingBlockId]??["#ccc","#aaa","#888"];r.emissionAccumulatorTrail+=e*20;const u=Math.floor(r.emissionAccumulatorTrail);r.emissionAccumulatorTrail-=u;for(let d=0;d<u;d++)this.particleManager.emitParticle(r.position,{colors:c,baseSpeed:20,sizeRange:[1,2],lifeRange:[.3,.5],fadeOut:!0});if(r.age>r.ttl&&!r.stuck){this.particleManager.removeParticle(r.particle),n.add(r);continue}if(r.stuck){if(r.targetShip&&r.anchorOffset){const m=r.targetShip.getTransform().position;r.position.x=m.x+r.anchorOffset.x,r.position.y=m.y+r.anchorOffset.y,r.particle.x=r.position.x,r.particle.y=r.position.y}r.emissionAccumulatorStuck+=e*20;const d=Math.floor(r.emissionAccumulatorStuck);r.emissionAccumulatorStuck-=d;const g=vo[r.firingBlockId]??["#ccc","#aaa","#888"];for(let m=0;m<d;m++)this.particleManager.emitParticle(r.position,{colors:g,baseSpeed:300,sizeRange:[1,3],lifeRange:[.4,.9],fadeOut:!0});r.elapsed+=e,r.elapsed>=r.detonationDelay&&(this.explodeLance(r,i),n.add(r));continue}r.position.x+=r.velocity.x*e,r.position.y+=r.velocity.y*e,r.light.x=r.position.x,r.light.y=r.position.y;const h=this.grid.getRelevantCells(r.position);for(const d of h){const g=this.grid.getBlocksInCellByCoords(d.x,d.y,i.getFaction());for(const m of g){if(m.ownerShipId===r.ownerShipId||!m.position)continue;const y=r.position.x-m.position.x,v=r.position.y-m.position.y;if(Math.sqrt(y*y+v*v)<32){const S=Hh(m),T=S?Gm(m,S):null;if(S&&T){r.stuck=!0,r.targetBlock=m,r.targetShip=S,r.coord=T;const w=S.getTransform().position;if(r.anchorOffset={x:r.position.x-w.x,y:r.position.y-w.y},r.velocity={x:0,y:0},r.particle.vx=0,r.particle.vy=0,r.particle.life=r.detonationDelay+.2,r.particle.size*=1.25,ti(this.playerShip,i,{file:"assets/sounds/sfx/weapons/lance_01.wav",channel:"sfx",baseVolume:.9,pitchRange:[.8,1.2],volumeJitter:.1,maxSimultaneous:5}),pe.emit("camera:shake",{strength:6,duration:.16,frequency:10}),this.combatService.applyDamageToBlock(S,i,m,T,r.fireDamage,"explosiveLance",this.playerShip)){this.explodeLance(r,i),n.add(r);continue}}break}}}}this.activeLances=this.activeLances.filter(r=>!n.has(r))}explodeLance(e,i){var r;if(!e.targetShip||!e.coord)return;$e.getInstance().removeLight(e.light.id);const n=e.targetShip.getBlocksWithinGridDistance(e.coord,e.explosionRadius);for(const c of n){const u=e.targetShip.getBlockCoord(c);u&&(this.explosionSystem.createBlockExplosion(e.targetShip.getTransform().position,e.targetShip.getTransform().rotation,u,e.explosionRadius*64,.7,(r=vo[e.firingBlockId])==null?void 0:r[0],vo[e.firingBlockId]),this.combatService.applyDamageToBlock(e.targetShip,i,c,u,e.explosionDamage,"explosiveLanceAoE",this.playerShip))}this.particleManager.removeParticle(e.particle)}render(e){}}class Qm{constructor(e,i,n,r){this.combatService=e,this.particleManager=i,this.grid=n,this.ship=r,this.orbiters=[],this.tierPhases=new Map,this.energyRingSprites=new Map,this.energyRingSprites=new Map([["energyRing0",fo("energyRing0")],["energyRing1",fo("energyRing1")],["energyRing2",fo("energyRing2")],["energyRing3",fo("energyRing3")],["energyRing4",fo("energyRing4")]])}render(e){}update(e,i,n,r){const c=this.ship.getHaloBladeBlocks(),u=Array.from(c.keys());this.orbiters=this.orbiters.filter(m=>c.has(m.block));for(const m of u)if(!this.orbiters.find(y=>y.block===m)){const y=c.get(m);this.orbiters.push({block:m,angle:0,radius:y.orbitingRadius,position:{x:0,y:0},sprite:this.energyRingSprites.get(y.sprite)})}const h=i.getTransform().position,d=new Map;for(const m of this.orbiters){const y=m.block.type.id;d.has(y)||d.set(y,[]),d.get(y).push(m)}for(const[m,y]of d.entries()){if(y.length===0)continue;const v=c.get(y[0].block);if(!v)continue;const M=i.getFiringMode()===Wt.Sequence,S=M?1:-1;let T=this.tierPhases.get(m)??Math.random()*Math.PI*2;T+=v.orbitingSpeed*e*S,this.tierPhases.set(m,T),y.sort((A,R)=>{const I=A.block.id,x=R.block.id;return I.localeCompare(x)});const w=y.length;for(let A=0;A<w;A++){const R=y[A],I=T+A/w*Math.PI*2;R.angle=I,R.radius=v.orbitingRadius;const x=M?R.radius:R.radius*.5;R.position.x=h.x+Math.cos(I)*x,R.position.y=h.y+Math.sin(I)*x,Ph.add({texture:R.sprite.texture,worldX:R.position.x,worldY:R.position.y,widthPx:64,heightPx:64,alpha:1}),this.particleManager.emitParticle(R.position,{colors:[v.color,"#fff"],baseSpeed:0,sizeRange:[.8,1.2],lifeRange:[.3,.8],fadeOut:!0,light:!0,lightRadiusScalar:32,lightIntensity:.7})}}const g=new Set(d.keys());for(const m of this.tierPhases.keys())g.has(m)||this.tierPhases.delete(m);for(const m of this.orbiters){const y=c.get(m.block);if(!y)continue;const v=m.position.x,M=m.position.y,S=this.grid.getRelevantCells({x:v,y:M});for(const T of S){const w=this.grid.getBlocksInCellByCoords(T.x,T.y,i.getFaction());for(const A of w){if(!A.position)continue;const R=v-A.position.x,I=M-A.position.y;if(Math.sqrt(R*R+I*I)<y.size/2+16){const P=Hh(A),N=P==null?void 0:P.getBlockCoord(A);P&&N&&this.combatService.applyDamageToBlock(P,i,A,N,y.damage,"haloBlade",this.ship)}}}}}}class $m{constructor(){this.wasPressedLastFrame=new WeakMap}update(e,i,n,r){var d;const c=!!(r!=null&&r.toggleShields),u=this.wasPressedLastFrame.get(i)??!1;if(this.wasPressedLastFrame.set(i,c),!c||u)return;const h=(d=i.getShieldComponent)==null?void 0:d.call(i);h&&h.hasShieldBlocks()&&(h.isActive()?(Q.play("assets/sounds/sfx/ship/energy-shield-reverse_00.wav","sfx",{maxSimultaneous:3}),h.deactivate()):(Q.play("assets/sounds/sfx/ship/energy-shield_00.wav","sfx",{maxSimultaneous:3}),h.activate()))}}class ZC{constructor(e,i,n,r,c){this.initialState=null,this.hunter=!1,this.ship=e,this.movementSystem=i,this.weaponSystem=n,this.utilitySystem=r,this.behaviorProfile=c,this.currentState=new Al(this,e)}update(e){if(!(!this.ship||!this.ship.getTransform))try{const i=this.currentState.update(e);this.movementSystem.setIntent(i.movement),this.weaponSystem.setIntent(i.weapons),this.movementSystem.update(e),this.utilitySystem.setIntent(i.utility),this.utilitySystem.update(e,this.ship,this.ship.getTransform()),this.weaponSystem.update(e,this.ship,this.ship.getTransform());const n=this.currentState.transitionIfNeeded();n&&(this.currentState=n)}catch(i){console.error("Error in AIControllerSystem update:",i)}}render(e){try{this.weaponSystem.render(e)}catch(i){console.error("Error in AIControllerSystem render:",i)}}getShip(){return this.ship}getBehaviorProfile(){return this.behaviorProfile}getCurrentState(){return this.currentState}getCurrentStateString(){return this.currentState.constructor.name}setHunter(e){this.hunter=e}isHunter(){return this.hunter}setInitialState(e){this.initialState=e,this.currentState=e}getInitialState(){return this.initialState}}const Jm={default:Sm,rammer:js,strafe:$S,spaceStation:Mm};function tm(a){return a in Jm}class QC{constructor(e,i,n,r,c,u,h,d,g,m,y){this.grid=e,this.registry=i,this.orchestrator=n,this.playerShip=r,this.particleManager=c,this.projectileSystem=u,this.laserSystem=h,this.combatService=d,this.explosionSystem=g,this.collisionSystem=m,this.shipConstructionAnimator=y}async createShip(e,i,n,r=!1,c,u={},h=ks.Enemy){const{ship:d,behaviorType:g}=await YC(`${e}.json`,this.grid);g&&!tm(g)&&console.warn(`[AI] Unknown behaviorType "${g}"  falling back to default.`),d.setAffixes(u),d.setFaction(h);const m=d.getTransform();m.position.x=i,m.position.y=n,this.registry.add(d);const y=new Wm(this.particleManager),v=new zm(d,y,this.collisionSystem),M=new Vm(new jm(this.projectileSystem,this.playerShip),new Km(this.laserSystem),new Zm(this.combatService,this.particleManager,this.grid,this.explosionSystem,this.playerShip),new Qm(this.combatService,this.particleManager,this.grid,d)),S=new Xm(new $m),T=c??(typeof g=="string"&&tm(g)?Jm[g]:void 0)??Sm,w=new ZC(d,v,M,S,T);if(T.initialStateFactory){const R=T.initialStateFactory(w);w.setInitialState(R)}w.setHunter(r),this.orchestrator.addController(w),d.hideAllBlocks(),d.updateBlockPositions();const A={color:"#ff0000",radius:96,intensity:.8};return this.shipConstructionAnimator.animateShipConstruction(d,A),{ship:d,controller:w}}}const im=0;class $C{constructor(e,i,n,r,c,u,h,d,g,m,y,v,M,S){this.waves=e,this.shipRegistry=i,this.aiOrchestrator=n,this.playerShip=r,this.projectileSystem=c,this.laserSystem=u,this.particleManager=h,this.grid=d,this.combatService=g,this.explosionSystem=m,this.collisionSystem=y,this.shipConstructionAnimator=v,this.incidentSystem=M,this.popupMessageSystem=S,this.currentWaveIndex=im,this.elapsedTime=0,this.timeSinceStart=0,this.isRunning=!1,this.isPaused=!1,this.hasSpawnedFirstWave=!1,this.initialDelay=10,this.defaultWaveInterval=120,this.interWaveDelay=10,this.interWaveCountdown=-1,this.waitingToSpawnNextWave=!1,this.activeWave=null,this.activeShips=new Set,this.activeControllers=new Map,this.onMissionComplete=null,this.missionCompleteTriggered=!1,this.shipFactory=new QC(this.grid,this.shipRegistry,this.aiOrchestrator,this.playerShip,this.particleManager,this.projectileSystem,this.laserSystem,this.combatService,this.explosionSystem,this.collisionSystem,this.shipConstructionAnimator)}setMissionCompleteHandler(e){this.onMissionComplete=e}start(){this.isRunning=!0,this.timeSinceStart=0}pause(){this.isPaused=!0}resume(){this.isPaused=!1}getIsRunning(){return this.isRunning}getIsPaused(){return this.isPaused}update(e){var i,n;if(!(!this.isRunning||this.isPaused)){if(!this.hasSpawnedFirstWave){if(this.timeSinceStart+=e,this.timeSinceStart<this.initialDelay)return;const r=this.waves[this.currentWaveIndex];this.spawnWave(r),this.currentWaveIndex++,this.elapsedTime=0,this.hasSpawnedFirstWave=!0;return}if(this.waitingToSpawnNextWave){if(this.interWaveCountdown-=e,this.interWaveCountdown<=0&&(this.waitingToSpawnNextWave=!1,this.currentWaveIndex<this.waves.length)){const r=this.waves[this.currentWaveIndex];this.spawnWave(r),this.currentWaveIndex++,this.elapsedTime=0}return}if(!(((i=this.activeWave)==null?void 0:i.type)==="boss"&&!this.activeWave.isComplete)){if(this.shouldCompleteMission()){this.missionCompleteTriggered||(this.missionCompleteTriggered=!0,console.log("Mission completed!"),(n=this.onMissionComplete)==null||n.call(this),this.onMissionComplete=null);return}if(this.elapsedTime+=e,this.currentWaveIndex<this.waves.length){const r=this.waves[this.currentWaveIndex],c=r.waveDurationSeconds??this.defaultWaveInterval;this.elapsedTime>=c&&(Ce.incrementWavesCleared(),this.spawnWave(r),this.currentWaveIndex++,this.elapsedTime=0)}}}}shouldCompleteMission(){const e=this.currentWaveIndex>=this.waves.length,i=this.activeShips.size===0,n=!this.waitingToSpawnNextWave;return e&&i&&n}clearCurrentWave(){for(const e of this.activeShips){this.shipRegistry.remove(e);const i=this.activeControllers.get(e);i&&(this.aiOrchestrator.removeController(i),this.activeControllers.delete(e)),e.destroy()}this.activeShips.clear(),this.activeWave&&this.incidentSystem.clear(this.activeWave.id)}async spawnWave(e){var n;this.activeWave={id:e.id,type:e.type,mods:e.mods,isComplete:!1},e.type==="boss"&&this.clearCurrentWave();const i=[];for(const r of e.ships)for(let c=0;c<r.count;c++){const u=e.type==="boss"?(Math.random()-.5)*200:Math.random()*rn-rn/2,h=e.type==="boss"?(Math.random()-.5)*200:Math.random()*ha-ha/2,{ship:d,controller:g}=await this.shipFactory.createShip(r.shipId,u,h,r.hunter??!1,r.behaviorProfile,r.affixes??{});this.applyModifiers(d,e.mods),this.activeShips.add(d),this.activeControllers.set(d,g),i.push(d)}for(const r of e.incidents??[])Math.random()<=r.spawnChance&&(console.log(`[WaveSpawner] Triggering incident '${r.script}' (wave ${e.id})`),this.incidentSystem.trigger(r.script,r.options??{},e.id));e.type==="boss"?(Q.playMusic(e.music??{file:"assets/sounds/music/track_03_boss.mp3"}),this.popupMessageSystem.displayMessage(" DANGER ",{color:"#ff5555",duration:4,glow:!0,font:"28px monospace"}),(n=e.lightingSettings)!=null&&n.clearColor,this.monitorBossWaveCompletion(i)):this.popupMessageSystem.displayMessage("Wave "+e.id,{color:"#00ff00",duration:3,glow:!0,font:"28px monospace"})}skipToNextWave(){var i;if(this.currentWaveIndex>=this.waves.length||(this.activeWave&&(this.activeWave.isComplete=!0),this.currentWaveIndex>=this.waves.length))return;const e=this.waves[this.currentWaveIndex];if(((i=this.activeWave)==null?void 0:i.type)==="boss"){this.waitingToSpawnNextWave=!0,this.interWaveCountdown=this.interWaveDelay,this.activeWave=null;return}this.spawnWave(e),this.currentWaveIndex++,this.elapsedTime=0,this.waitingToSpawnNextWave=!1}applyModifiers(e,i){for(const n of i)switch(n){case"shielded":break;case"extra-aggressive":break;default:console.warn(`Unknown wave modifier: ${n}`)}}monitorBossWaveCompletion(e){const i=new Set(e);for(const n of e)n.onDestroyedCallback(()=>{var r;i.has(n)&&(i.delete(n),i.size===0&&((r=this.activeWave)==null?void 0:r.type)==="boss"&&(this.activeWave.isComplete=!0,console.log(`Boss wave ${this.activeWave.id} defeated.`),this.currentWaveIndex>=this.waves.length||(this.waitingToSpawnNextWave=!0,this.interWaveCountdown=this.interWaveDelay)))})}getCurrentWaveNumber(){return this.currentWaveIndex}getTimeUntilNextWave(){var n;if(this.waitingToSpawnNextWave)return Math.ceil(this.interWaveCountdown);if(this.currentWaveIndex===0&&this.timeSinceStart<this.initialDelay)return Math.ceil(this.initialDelay-this.timeSinceStart);if(((n=this.activeWave)==null?void 0:n.type)==="boss"&&!this.activeWave.isComplete||this.shouldCompleteMission())return-1;const e=this.waves[this.currentWaveIndex],i=(e==null?void 0:e.waveDurationSeconds)??this.defaultWaveInterval;return Math.max(0,i-this.elapsedTime)}isBossWaveActive(){var e;return((e=this.activeWave)==null?void 0:e.type)==="boss"&&!this.activeWave.isComplete}isBossWaveComplete(){var e;return((e=this.activeWave)==null?void 0:e.type)==="boss"&&this.activeWave.isComplete}notifyShipDestruction(e){this.activeShips.has(e)&&Ce.incrementKillCount(),this.activeShips.delete(e),this.activeControllers.get(e)&&this.activeControllers.delete(e)}reset(){this.clearCurrentWave(),this.currentWaveIndex=im,this.isRunning=!1,this.hasSpawnedFirstWave=!1,this.elapsedTime=0,this.timeSinceStart=0,this.interWaveCountdown=-1,this.waitingToSpawnNextWave=!1,this.activeWave=null,this.activeShips.clear(),this.activeControllers.clear(),this.onMissionComplete=null,this.missionCompleteTriggered=!1}}function JC(a){pe.emit("incident:minimap:marker",a)}function sm(a){pe.emit("incident:minimap:clear",{id:a})}class ey{constructor(e,i,n,r){this.minimapRegistered=!1,this.id=e,this.options=i,this.waveId=n,this.context=r}getId(){return this.id}getWaveId(){return this.waveId}getMinimapIcon(){return null}onTrigger(){const e=this.getMinimapIcon(),{x:i,y:n}=this.options;e&&typeof i=="number"&&typeof n=="number"&&(JC({id:this.id,icon:e,x:i,y:n}),this.minimapRegistered=!0)}onComplete(){this.minimapRegistered&&(sm(this.id),this.minimapRegistered=!1),Ce.incrementIncidentsCompleted()}destroy(){this.minimapRegistered&&(sm(this.id),this.minimapRegistered=!1)}}class ew extends ey{constructor(e,i,n,r){super(e,i,n,r),this.elapsed=0,this.lifetime=5,this.nextLogTime=0}getMinimapIcon(){return"skullAndBones"}onTrigger(){super.onTrigger(),console.log(`[BlackHoleIncident] Triggered at (${this.options.x}, ${this.options.y})`),this.context.popupMessageSystem.displayMessage(" BLACK HOLE SPAWNED ",{color:"#ff5555",duration:3,glow:!0,font:"28px monospace"})}update(e){this.elapsed+=e,this.elapsed>=this.nextLogTime&&(console.log(`[BlackHoleIncident] ${this.elapsed.toFixed(1)}s elapsed (id=${this.getId()})`),this.nextLogTime=Math.ceil(this.elapsed))}isComplete(){return this.elapsed>=this.lifetime}onComplete(){console.log(`[BlackHoleIncident] Complete (total time: ${this.elapsed.toFixed(1)}s)`)}destroy(){console.log(`[BlackHoleIncident] Destroyed prematurely (elapsed: ${this.elapsed.toFixed(1)}s)`)}}class tw extends ey{constructor(e,i,n,r){super(e,i,n,r),this.elapsed=0,this.lifetime=6,this.nextLogTime=0}getMinimapIcon(){return"greenCross"}onTrigger(){console.log(`[HealingBeaconIncident] Deployed at (${this.options.x}, ${this.options.y})`),this.context.popupMessageSystem.displayMessage(" Healing Beacon Online ",{color:"#00ffaa",duration:3,font:"26px monospace",glow:!0})}update(e){this.elapsed+=e,this.elapsed>=this.nextLogTime&&(console.log(`[HealingBeaconIncident] Active for ${this.elapsed.toFixed(1)}s (id=${this.getId()})`),this.nextLogTime=Math.ceil(this.elapsed))}isComplete(){return this.elapsed>=this.lifetime}onComplete(){console.log(`[HealingBeaconIncident] Completed after ${this.elapsed.toFixed(1)}s`)}destroy(){console.log(`[HealingBeaconIncident] Destroyed early at ${this.elapsed.toFixed(1)}s`)}}class iw{constructor(){this.scriptConstructors=new Map,this.registerAll()}registerAll(){this.register("BlackHoleIncident",ew),this.register("HealingBeaconIncident",tw)}register(e,i){if(this.scriptConstructors.has(e)){console.warn(`[IncidentRegistry] Duplicate script ID: '${e}'`);return}this.scriptConstructors.set(e,i)}has(e){return this.scriptConstructors.has(e)}create(e,i,n,r){const c=this.scriptConstructors.get(e);return c?new c(e,i,n,r):(console.warn(`[IncidentRegistry] Unknown incident script ID: '${e}'`),null)}getRegisteredScriptIds(){return Array.from(this.scriptConstructors.keys())}}class sw{constructor(e){this.activeIncidents=new Map,this.registry=new iw,this.context=e}trigger(e,i={},n){const r=this.registry.create(e,i,n,this.context);if(!r){console.warn(`[IncidentOrchestrator] Unknown incident script: '${e}'`);return}const c=r.getId();if(this.activeIncidents.has(c)){console.warn(`[IncidentOrchestrator] Duplicate incident ID '${c}'  skipping trigger.`);return}this.activeIncidents.set(c,r),r.onTrigger()}update(e){var i,n;for(const[r,c]of this.activeIncidents)c.update(e),c.isComplete()&&((i=c.onComplete)==null||i.call(c),(n=c.destroy)==null||n.call(c),this.activeIncidents.delete(r))}render(e){var n;const i=this.context.canvasManager;for(const r of this.activeIncidents.values())(n=r.render)==null||n.call(r,i,e)}clear(e){var i;for(const[n,r]of this.activeIncidents)(e===void 0||r.getWaveId()===e)&&((i=r.destroy)==null||i.call(r),this.activeIncidents.delete(n))}destroy(){var e;for(const i of this.activeIncidents.values())(e=i.destroy)==null||e.call(i);this.activeIncidents.clear()}getActiveCount(){return this.activeIncidents.size}getActiveIncidentIds(){return Array.from(this.activeIncidents.keys())}}class nw extends Uh{constructor(e,i,n){super(e,i,n)}update(e){const i=this.transform;i.position.x+=i.velocity.x*e,i.position.y+=i.velocity.y*e,i.rotation+=i.angularVelocity*e,this.updateBlockPositions()}onDestroyed(){}}const hh=new Map;async function aw(a){if(hh.has(a))return hh.get(a);const e=Mi(`/assets/environment/asteroids/${a}`),i=await fetch(e).then(n=>n.json());return hh.set(a,i),i}async function ow(a,e){const i=await aw(a),n=new nw(e,[],{position:i.transform.position,rotation:i.transform.rotation,velocity:{x:0,y:0},angularVelocity:0});for(const r of i.blocks){const c=lm(r.id);if(!c)throw new Error(`Unknown block type: ${r.id}`);const u={id:crypto.randomUUID(),ownerFaction:ks.Neutral,type:c,hp:c.armor,ownerShipId:n.id,position:{x:0,y:0},rotation:r.rotation};n.placeBlock(r.coord,u)}return n}class rw{constructor(e,i){this.grid=e,this.registry=i}async createAsteroid(e,i,n={x:0,y:0},r=0){const c=await ow(e+".json",this.grid),u=c.getTransform();return u.position={...i},u.velocity={...n},u.angularVelocity=r,this.registry.add(c),c}}const lw={id:"asteroid-field-01",asteroids:[{asteroidId:"asteroid_0_00",count:100},{asteroidId:"asteroid_0_01",count:100}],velocityRange:{x:[-50,50],y:[-50,50]},angularVelocityRange:[-1,1]},cw={id:"asteroid-field-02",bounds:{x:-2e3,y:-1500,width:4e3,height:3e3},density:.8,velocityRange:{x:[-.2,.2],y:[-.1,.1]},angularVelocityRange:[-.1,.1],asteroids:[{asteroidId:"asteroid_0_00",count:30},{asteroidId:"asteroid_0_01",count:20},{asteroidId:"asteroid_0_02",count:15}]},uw=new Map([["asteroid-field-01",lw],["asteroid-field-02",cw]]);function hw(a){return uw.get(a)}class fw{constructor(e,i){this.factory=new rw(e,i)}spawnFieldById(e){const i=hw(e);if(!i){console.warn(`[AsteroidSpawningSystem] Unknown field id: ${e}`);return}this.spawnField(i)}spawnField(e){var n,r;const i=e.bounds??{x:hl.x-rn/2,y:hl.y-ha/2,width:rn,height:ha};for(const c of e.asteroids)for(let u=0;u<c.count;u++){const h=i.x+Math.random()*i.width,d=i.y+Math.random()*i.height,g=this.randomInRange(((n=e.velocityRange)==null?void 0:n.x)??[-.1,.1]),m=this.randomInRange(((r=e.velocityRange)==null?void 0:r.y)??[-.1,.1]),y=this.randomInRange(e.angularVelocityRange??[-.05,.05]);this.factory.createAsteroid(c.asteroidId,{x:h,y:d},{x:g,y:m},y)}}randomInRange([e,i]){return e+Math.random()*(i-e)}}class dw{constructor(e,i,n,r){this.explosionSystem=e,this.pickupSpawner=i,this.destructionService=n,this.floatingTextManager=r}applyDamageToBlock(e,i,n,r,c,u="scripted",h=null){var M,S,T,w,A,R;if(n.indestructible||i.getFaction()===e.getFaction())return!1;const d=qi.getEnemyPower();if(h!=null&&h.getIsPlayerShip()&&!(e instanceof It&&e.getIsPlayerShip())?c/=d:!(h!=null&&h.getIsPlayerShip())&&e instanceof It&&e.getIsPlayerShip()&&(c*=d),n.isShielded&&e instanceof It){const I=(M=e.getEnergyComponent)==null?void 0:M.call(e),x=n.shieldEfficiency??0;if(x>0){const P=Math.random()*5+5,N=Ae.getInstance().isLightingEnabled()&&u!=="collision"?{lightRadiusScalar:P,lightIntensity:1.2,lightLifeScalar:.5,lightColor:"#00ffff"}:void 0,W=Math.max(.001,x),H=c/W;if(I&&I.spend(H))return n.position&&(ti(e,h,{file:"assets/sounds/sfx/ship/energy-shield-hit_00.wav",channel:"sfx",baseVolume:.65,pitchRange:[2,2.5],volumeJitter:.1,maxSimultaneous:5}),this.explosionSystem.createShieldDeflection(n.position,n.shieldSourceId??"shield0",N)),!1}}n.hp-=c;const m=Ae.getInstance().isLightingEnabled()&&u!=="collision"?{lightRadiusScalar:12,lightIntensity:1,lightLifeScalar:.7,lightColor:u==="laser"?"#00ffff":void 0}:void 0;if(n.position){let I=!0;(u==="laser"||u==="collision")&&(I=Math.random()<.2),I&&this.explosionSystem.createExplosion(n.position,20,.3,void 0,ia,m);const x=e.getTransform().position.x+r.x,P=e.getTransform().position.y+r.y;(S=this.floatingTextManager)==null||S.createWorldText(`${Math.floor(c)}`,x,P,yt.getInstance(),10,"monospace",.8,140,1,"#FFFFFF",{impactScale:1.5},n.ownerShipId)}if(ti(e,h,{file:"assets/sounds/sfx/explosions/hit_00.wav",channel:"sfx",baseVolume:.25,pitchRange:[.2,.4],volumeJitter:.1,maxSimultaneous:3}),n.hp>0)return!1;if(r.x===0&&r.y===0)return this.destructionService.destroyEntity(e,u),!0;const v=n.type.id.startsWith("cockpit");if(this.explosionSystem.createBlockExplosion(e.getTransform().position,e.getTransform().rotation,r,70*(v?2:1),.7*(v?2:1),void 0,ia),ti(e,h,{file:"assets/sounds/sfx/explosions/explosion_00.wav",channel:"sfx",baseVolume:1,pitchRange:[.7,1],volumeJitter:.2,maxSimultaneous:3}),this.pickupSpawner.spawnPickupOnBlockDestruction(n),e.removeBlock(r),e instanceof It&&((T=e.getIsPlayerShip)!=null&&T.call(e))&&Ce.incrementBlocksLost(1),e instanceof It){if(v)return this.destructionService.destroyEntity(e,u),ti(e,h,{file:"assets/sounds/sfx/explosions/explosion_01.wav",channel:"sfx",baseVolume:.8,pitchRange:[.7,1],volumeJitter:.2}),!0;const I=(w=e.getCockpitCoord)==null?void 0:w.call(e);if(!I)return!0;const x=Um(e,I),P=e.getBlockMap(),N=[],W=[];for(const[q,ie]of P.entries()){if(x.has(q))continue;const $=sn(q);this.explosionSystem.createBlockExplosion(e.getTransform().position,e.getTransform().rotation,$,60+Math.random()*20,.5+Math.random()*.3,void 0,ia),this.pickupSpawner.spawnPickupOnBlockDestruction(ie),N.push($),W.push(ie)}N.length>0&&(e.removeBlocks(N,W),e instanceof It&&((A=e.getIsPlayerShip)!=null&&A.call(e))&&Ce.incrementBlocksLost(N.length));const H=Array.from(e.getBlockMap().values());if(H.length===1&&H[0].type.id.startsWith("cockpit")){const q=(R=e.getCockpitCoord)==null?void 0:R.call(e);if(q){const ie=H[0];this.explosionSystem.createBlockExplosion(e.getTransform().position,e.getTransform().rotation,q,140,1.2,void 0,ia),this.pickupSpawner.spawnPickupOnBlockDestruction(ie),e.removeBlock(q),this.destructionService.destroyEntity(e,u),ti(e,h,{file:"assets/sounds/sfx/explosions/explosion_01.wav",channel:"sfx",baseVolume:.8,pitchRange:[.7,1],volumeJitter:.2})}}}return!0}}class gw{constructor(e){this.shipRegistry=e}update(e){var i;for(const n of this.shipRegistry.getAll()){const r=n.getEnergyComponent(),c=n.getShieldComponent();if(r&&(r.update(e),c.isActive())){let u=0;for(const g of n.getShieldBlocks()){const m=((i=g.type.behavior)==null?void 0:i.shieldEnergyDrain)??0;u+=m}const h=u*e;r.spend(h)||c.deactivate()}}}}function pw(a,e){const i="assets/sounds/sfx/ship/engine_loop_00.wav";return a&&!e?(Q.startLoop(i,"sfx",{volume:1,pitch:1,pan:0}),!0):!a&&e?(Q.stopLoop(i),!1):e}function mw({inputManager:a,pause:e,resume:i,shipBuilderMenu:n,pauseMenu:r,settingsMenu:c,blockDropDecisionMenu:u,menuManager:h}){const d=a.wasActionJustPressed("openShipBuilder"),g=a.wasActionJustPressed("pause"),m=h.getTop();if(d){if(u.isOpen())return;if(!c.isOpen()&&!r.isOpen()&&!n.isOpen()&&!u.isOpen())if(console.log("Attempting to open blockDropDecisionMenu..."),u.hasBlocksInQueue()){console.log("Called openMenu on blockDropDecisionMenu"),u.openMenu();return}else console.log("No blocks in queue, not opening blockDropDecisionMenu"),Q.play("assets/sounds/sfx/ui/error_00.wav","sfx");console.log("Failed to open blockDropDecisionMenu");return}if(g){if(u.isOpen())return;m?(h.pop(),h.anyOpen()||i()):(e(),h.open(r))}}class yw{constructor(e,i){this.grid=e,this.camera=i}getVisibleShips(){return this.queryShipsInBounds(250)}getActiveAIShips(){return this.queryShipsInBounds(2e3)}queryShipsInBounds(e){const i=this.camera.getViewportBounds(),n=i.x-e,r=i.y-e,c=i.x+i.width+e,u=i.y+i.height+e,h=this.grid.getBlocksInArea(n,r,c,u),d=new Set;for(const g of h){const m=zt.getObject(g);m&&m instanceof It&&d.add(m)}return Array.from(d)}}class vw{constructor(e,i){this.grid=e,this.camera=i}getVisibleObjects(){const e=this.camera.getViewportBounds();return this.queryObjectsInBounds(e.x,e.y,e.x+e.width,e.y+e.height)}getNearbyObjects(){const e=this.camera.getViewportBounds(),i=2e3;return this.queryObjectsInBounds(e.x-i,e.y-i,e.x+e.width+i,e.y+e.height+i)}queryObjectsInBounds(e,i,n,r){const c=this.grid.getBlocksInArea(e,i,n,r),u=new Set;for(const h of c){const d=zt.getObject(h);d&&u.add(d)}return Array.from(u)}}class bw{constructor(e){this.registry=e}update(e){for(const i of this.registry.getAll())i.update(e)}}function Sw(a){const e=new It(a,void 0,void 0,!0,void 0,ks.Player);return e.setIsPlayerShip(!0),e.placeBlockById({x:0,y:-3},"hull1"),e.placeBlockById({x:0,y:0},"cockpit1"),e.placeBlockById({x:0,y:-1},"hull1"),e.placeBlockById({x:0,y:-2},"turret1"),e.placeBlockById({x:-1,y:-1},"fin1"),e.placeBlockById({x:1,y:-1},"fin1",90),e.placeBlockById({x:1,y:0},"hull1"),e.placeBlockById({x:-1,y:0},"hull1"),e.placeBlockById({x:2,y:0},"turret1",90),e.placeBlockById({x:-2,y:0},"turret1"),e.placeBlockById({x:0,y:1},"engine1"),e.placeBlockById({x:-1,y:1},"engine1"),e.placeBlockById({x:1,y:1},"engine1"),e.hideAllBlocks(),e.setFiringMode(Wt.Sequence),e}class Mw extends Uh{constructor(e,i,n){super(e,i,n),this.setImmoveable(!0)}update(e){}onDestroyed(){}placeBlockById(e,i,n){const r=ni(i);if(!r)throw new Error(`Unknown block type: ${i}`);const c=this.calculateBlockWorldPosition(e),u={ownerFaction:ks.Neutral,id:crypto.randomUUID(),type:r,hp:r.armor,ownerShipId:this.id,position:c,...n!==void 0?{rotation:n}:{}};this.placeBlock(e,u)}}function Tw(a){const e=new Mw(a);return e.placeBlockById({x:-1e4,y:1e4},"hull1"),e}class Cw{constructor(e=256){this.cells=new Map,this.factionCells=new Map,this.cellSize=e}getCellCoords(e,i){return[Math.floor(e/this.cellSize),Math.floor(i/this.cellSize)]}getOrCreateCell(e,i,n){let r=e.get(i);r||(r=new Map,e.set(i,r));let c=r.get(n);return c||(c=[],r.set(n,c)),c}getFactionMap(e){let i=this.factionCells.get(e);return i||(i=new Map,this.factionCells.set(e,i)),i}getCellSources(e){if(!e)return[this.cells];const i=[];for(const[n,r]of this.factionCells)n!==e&&i.push(r);return i}addBlockToCell(e){const{x:i,y:n}=e.position,[r,c]=this.getCellCoords(i,n),u=this.getOrCreateCell(this.cells,r,c);u.includes(e)||u.push(e);const h=this.getFactionMap(e.ownerFaction),d=this.getOrCreateCell(h,r,c);d.includes(e)||d.push(e)}removeBlockFromCell(e){const{x:i,y:n}=e.position,[r,c]=this.getCellCoords(i,n),u=this.cells.get(r),h=u==null?void 0:u.get(c);if(h){const m=h.indexOf(e);m!==-1&&h.splice(m,1)}const d=this.getFactionMap(e.ownerFaction).get(r),g=d==null?void 0:d.get(c);if(g){const m=g.indexOf(e);m!==-1&&g.splice(m,1)}}removeBlocksFromCells(e){for(const i of e)this.removeBlockFromCell(i)}getBlocksInCell(e,i,n){const[r,c]=this.getCellCoords(e,i);return this.getBlocksInCellByCoords(r,c,n)}getBlocksInCellByCoords(e,i,n){const r=this.getCellSources(n),c=[];for(const u of r){const h=u.get(e);if(!h)continue;const d=h.get(i);d&&c.push(...d)}return c}getRelevantCells(e){const i=Math.floor(e.x/this.cellSize),n=Math.floor(e.y/this.cellSize),r=[];for(let c=-1;c<=1;c++)for(let u=-1;u<=1;u++)r.push({x:i+c,y:n+u});return r}getAllBlocksInCells(e,i,n,r,c){const u=[],h=this.getCellSources(c);for(let d=e;d<=n;d++)for(let g=i;g<=r;g++)for(const m of h){const y=m.get(d);if(!y)continue;const v=y.get(g);v&&u.push(...v)}return u}getBlocksInArea(e,i,n,r,c){const u=Math.floor(e/this.cellSize),h=Math.floor(i/this.cellSize),d=Math.floor(n/this.cellSize),g=Math.floor(r/this.cellSize);return this.getAllBlocksInCells(u,h,d,g,c)}getBlocksAlongRay(e,i,n=0,r){const c=new Set,u=i.x-e.x,h=i.y-e.y,d=u>0?1:-1,g=h>0?1:-1,m=Math.abs(this.cellSize/u),y=Math.abs(this.cellSize/h);let v=Math.floor(e.x/this.cellSize),M=Math.floor(e.y/this.cellSize);const S=Math.floor(i.x/this.cellSize),T=Math.floor(i.y/this.cellSize),w=u>0?(v+1)*this.cellSize-e.x:e.x-v*this.cellSize,A=h>0?(M+1)*this.cellSize-e.y:e.y-M*this.cellSize;let R=Math.abs(w/u),I=Math.abs(A/h);const x=500;let P=[[0,0]];if(n>0){const N=n/2,W=Math.sqrt(u*u+h*h),H=u/W,ie=-(h/W),$=H,K=Math.ceil(N/this.cellSize),ne=new Set;P=[];for(let Z=-K;Z<=K;Z++){const te=Math.round(ie*Z),_=Math.round($*Z),X=te<<8^_;ne.has(X)||(ne.add(X),P.push([te,_]))}}for(let N=0;N<x;N++){for(const[W,H]of P){const q=v+W,ie=M+H,$=this.getBlocksInCellByCoords(q,ie,r);for(const K of $)c.add(K)}if(v===S&&M===T)break;R<I?(R+=m,v+=d):(I+=y,M+=g)}return Array.from(c)}getFirstBlockAlongRay(e,i,n){const r=i.x-e.x,c=i.y-e.y,u=Math.sqrt(r*r+c*c);if(u===0)return null;const h={x:r/u,y:c/u},d=this.getBlocksAlongRay(e,i,0,n);let g=null,m=1/0;for(const y of d){const v=y.position,M=this.cellSize/2,S={x:v.x-M,y:v.y-M},T={x:v.x+M,y:v.y+M},w=ww(e,h,S,T);w.hit&&w.tmin>=0&&w.tmin<m&&w.tmin<=u&&(m=w.tmin,g={block:y,point:{x:e.x+h.x*w.tmin,y:e.y+h.y*w.tmin}})}return g}clear(){this.cells.clear(),this.factionCells.clear()}}function ww(a,e,i,n){const r=1/e.x,c=1/e.y;let u=(i.x-a.x)*r,h=(n.x-a.x)*r,d=(i.y-a.y)*c,g=(n.y-a.y)*c;const m=Math.max(Math.min(u,h),Math.min(d,g));return{hit:Math.min(Math.max(u,h),Math.max(d,g))>=Math.max(0,m),tmin:m}}class Aw{constructor(e,i,n,r){this.camera=i,this.particleManager=n,this.lightingOrchestrator=r,this.explosions=[],this.ctx=e.getContext("fx")}createExplosion(e,i=60,n=.6,r,c,u){if(this.particleManager.emitBurst(e,10+Math.floor(i/10),{colors:c,baseSpeed:200,sizeRange:[1,3],lifeRange:[.4,1],fadeOut:!0}),this.lightingOrchestrator&&Ae.getInstance().isLightingEnabled()&&u){const h=zS(r),d=si({x:e.x,y:e.y,radius:i*(u.lightRadiusScalar??5),color:u.lightColor??h,intensity:u.lightIntensity??.3,life:n*(u.lightLifeScalar??1),expires:!0});this.lightingOrchestrator.registerLight(d)}this.explosions.push({position:{...e},size:1,maxSize:i,life:n,maxLife:n,color:r??this.getRandomExplosionColor()})}createBlockExplosion(e,i,n,r=70,c=.7,u,h,d){const m=n.x*32,y=n.y*32,v=Math.cos(i),M=Math.sin(i),S=m*v-y*M,T=m*M+y*v,w=e.x+S,A=e.y+T;this.createExplosion({x:w,y:A},r,c,u,h,d)}createShieldDeflection(e,i,n){const r=Dm[i],c=(r==null?void 0:r[0])??"rgba(100, 255, 255, 0.6)",u=r??["#ffff00","#ff9900","#ff6600"],h=n?{...n,lightColor:n.lightColor??Hm(r??["#00ffff"])}:void 0;this.createExplosion(e,34,.3,c,u,h)}update(e){for(const i of this.explosions){i.life-=e;const n=1-i.life/i.maxLife;n<.5?i.size=i.maxSize*(n*2):i.size=i.maxSize*(1-(n-.5)*2)}this.explosions=this.explosions.filter(i=>i.life>0)}render(){const e=this.ctx;e.save(),e.scale(this.camera.getZoom(),this.camera.getZoom());for(const i of this.explosions){const n=this.camera.worldToScreen(i.position.x,i.position.y),r=n.x/this.camera.getZoom(),c=n.y/this.camera.getZoom(),u=e.createRadialGradient(r,c,0,r,c,i.size),h=i.life/i.maxLife;u.addColorStop(0,`rgba(255, 255, 200, ${h})`),u.addColorStop(.2,`${i.color}`),u.addColorStop(1,"rgba(0, 0, 0, 0)"),e.globalAlpha=h,e.fillStyle=u,e.beginPath(),e.arc(r,c,i.size,0,Math.PI*2),e.fill()}e.restore()}getRandomExplosionColor(){const e=["rgba(255, 100, 0, 0.8)","rgba(255, 50, 0, 0.8)","rgba(255, 200, 0, 0.8)","rgba(200, 0, 0, 0.8)"];return e[Math.floor(Math.random()*e.length)]}}class kw{constructor(e,i){this.camera=i,this.runWhilePaused=!0,this.effects=[],this.ctx=e.getContext("fx")}createRepairEffect(e,i=48,n=.5){this.effects.push(this.createEffect(e,i,n,"repair"))}createSellEffect(e,i=48,n=.5){this.effects.push(this.createEffect(e,i,n,"sell"))}createEffect(e,i,n,r){const c=this.generateSparkles(e,8+Math.floor(i/8),r);return{kind:r,position:{...e},size:0,maxSize:i,life:n,maxLife:n,color:this.getRandomColor(r),sparkles:c}}generateSparkles(e,i,n){const r=n==="repair"?["#00ffff","#66ffcc","#66ccff","#33ffee","#ccffff"]:["#ff6666","#ff3333","#ff9999","#ff4444","#ff2200"],c=[];for(let u=0;u<i;u++){const h=Math.random()*Math.PI*2,d=20+Math.random()*40;c.push({x:e.x,y:e.y,vx:Math.cos(h)*d,vy:Math.sin(h)*d,size:1+Math.random()*2,life:.4+Math.random()*.4,color:r[Math.floor(Math.random()*r.length)]})}return c}update(e){for(const i of this.effects){i.life-=e;const n=1-i.life/i.maxLife;i.size=n<.5?i.maxSize*(n*2):i.maxSize*(1-(n-.5)*2);for(const r of i.sparkles)r.x+=r.vx*e,r.y+=r.vy*e,r.life-=e;i.sparkles=i.sparkles.filter(r=>r.life>0)}this.effects=this.effects.filter(i=>i.life>0)}render(){const e=this.ctx;e.save(),e.scale(this.camera.getZoom(),this.camera.getZoom());for(const i of this.effects){const n=this.camera.worldToScreen(i.position.x,i.position.y),r=n.x/this.camera.getZoom(),c=n.y/this.camera.getZoom(),u=i.life/i.maxLife,h=e.createRadialGradient(r,c,0,r,c,i.size);h.addColorStop(0,`rgba(255,255,255,${u})`),h.addColorStop(.3,i.color),h.addColorStop(1,"rgba(0,0,0,0)"),e.globalAlpha=u,e.fillStyle=h,e.beginPath(),e.arc(r,c,i.size,0,Math.PI*2),e.fill();for(const d of i.sparkles){const g=this.camera.worldToScreen(d.x,d.y);e.globalAlpha=d.life,e.fillStyle=d.color,e.beginPath(),e.arc(g.x/this.camera.getZoom(),g.y/this.camera.getZoom(),d.size,0,Math.PI*2),e.fill()}}e.restore()}getRandomColor(e){const n={repair:["rgba(100, 255, 255, 0.8)","rgba(100, 255, 200, 0.8)","rgba(150, 255, 240, 0.8)","rgba(120, 255, 220, 0.8)"],sell:["rgba(255, 100, 100, 0.8)","rgba(255, 80, 80, 0.8)","rgba(255, 120, 120, 0.8)","rgba(255, 60, 60, 0.8)"]}[e];return n[Math.floor(Math.random()*n.length)]}}class Ew{constructor(e){this.flashes=[];try{this.ctx=e.getContext("overlay"),this.width=e.getWidth(),this.height=e.getHeight()}catch(i){console.error("Failed to initialize ScreenEffectsSystem:",i);const n=document.createElement("canvas");this.ctx=n.getContext("2d"),this.width=1,this.height=1}}createFlash(e="white",i=.5,n=.3){this.flashes.push({color:e,intensity:Math.max(0,Math.min(1,i)),duration:n,currentTime:0})}createExplosionFlash(e=.3){this.createFlash("rgba(255, 255, 220, 1)",e,.2)}createDamageFlash(e=.2){this.createFlash("rgba(255, 0, 0, 1)",e,.15)}update(e){for(const i of this.flashes)i.currentTime+=e;this.flashes=this.flashes.filter(i=>i.currentTime<i.duration)}render(){if(!(!this.ctx||this.flashes.length===0))try{const e=this.ctx;e.clearRect(0,0,this.width,this.height);for(const i of this.flashes){const n=i.currentTime/i.duration,r=i.intensity*(1-n);e.fillStyle=this.getColorWithAlpha(i.color,r),e.fillRect(0,0,this.width,this.height)}}catch(e){console.error("Error rendering screen effects:",e)}}getColorWithAlpha(e,i){if(e.startsWith("rgba"))return e.replace(/[\d.]+\)$/,`${i})`);if(e.startsWith("rgb"))return e.replace("rgb","rgba").replace(")",`, ${i})`);const n=document.createElement("div");n.style.color=e,document.body.appendChild(n);const r=getComputedStyle(n).color;return document.body.removeChild(n),r.replace("rgb","rgba").replace(")",`, ${i})`)}}class Rw{constructor(){var h;this.boundUpdate=d=>this.update(d),this.boundRender=d=>this.render(d),this.menuManager=Cs.getInstance(),this.camera=null,this.shipRegistry=Tt.getInstance(),this.blockObjectRegistry=nn.getInstance(),this.grid=null,this.ship=null,this.spaceStation=null,this.engineSoundPlaying=!1,this.updatables=[],this.renderables=[],this.isPaused=!1,this.isDestroyed=!1,this.update=d=>{if(!this.isDestroyed){if(this.engineSoundPlaying=pw(this.inputManager.isKeyPressed("KeyW"),this.engineSoundPlaying),mw({inputManager:this.inputManager,pause:this.pause.bind(this),resume:this.resume.bind(this),shipBuilderMenu:this.shipBuilderMenu,pauseMenu:this.pauseMenu,settingsMenu:this.settingsMenu,blockDropDecisionMenu:this.blockDropDecisionMenu,menuManager:this.menuManager}),this.blockDropDecisionMenu.isOpen()&&(this.blockDropDecisionMenu.update(d),this.ship&&this.blockPlacementController.update(this.ship.getTransform())),this.pauseMenu.isOpen()&&this.pauseMenu.update(),this.settingsMenu.isOpen()&&this.settingsMenu.update(),this.shipBuilderMenu.isOpen()&&this.shipBuilderMenu.update(),this.spaceStationBuilderMenu.isOpen()&&this.spaceStationBuilderMenu.update(),this.inputManager.wasKeyJustPressed("Digit2")&&Re.unlockAllFlags(),this.inputManager.wasKeyJustPressed("KeyG")&&(So("bloom"),So("chromaticAberration")),this.inputManager.wasKeyJustPressed("Digit4")&&EM(),this.inputManager.wasKeyJustPressed("Digit5")&&RM(),this.inputManager.wasKeyJustPressed("Digit6")&&BM(),this.inputManager.wasKeyJustPressed("Digit7")&&IM(),this.inputManager.wasKeyJustPressed("KeyH")&&oh(),this.inputManager.wasKeyJustPressed("Digit1")){const g=["engine1","engine2","engine3","engine4"];this.blockDropDecisionMenu.enqueueBlock(ni(g[Math.floor(Math.random()*g.length)]))}this.inputManager.wasKeyJustPressed("KeyN")&&(this.waveSpawner.getIsPaused()?this.waveSpawner.resume():this.waveSpawner.pause()),this.inputManager.wasKeyJustPressed("Digit0")&&Be.getInstance().addCurrency(1e3),this.inputManager.wasKeyJustPressed("KeyO")&&(this.shipBuilderMenu.isOpen()?(this.shipBuilderMenu.closeMenu(),this.resume()):(this.pause(),this.shipBuilderMenu.openMenu())),this.inputManager.wasKeyJustPressed("KeyU")&&ii.getInstance().unlockAll(),this.inputManager.wasRightBracketPressed()&&this.waveSpawner.skipToNextWave(),this.inputManager.wasKeyJustPressed("KeyI")&&(this.spaceStationBuilderMenu.isOpen()?(this.resume(),console.log("Closing space station builder menu..."),this.spaceStationBuilderMenu.closeMenu()):(this.pause(),console.log("Opening space station builder menu..."),this.spaceStationBuilderMenu.openMenu()));try{if(!this.ship||typeof this.ship.getTransform!="function"||!this.camera)return;const g=this.ship.getTransform();this.camera.adjustZoom(this.inputManager.consumeZoomDelta()),this.camera.follow(g.position),this.camera.update(d),this.shipBuilderMenu.isOpen()&&this.shipBuilderController.update(g),this.spaceStationBuilderMenu.isOpen()&&this.spaceStation&&this.spaceStationBuilderController.update(this.spaceStation.getTransform())}catch(g){console.error("Error getting ship transform:",g)}this.isPaused||this.updatables.forEach(g=>g.update(d)),this.hud.update(d),this.shipBuilderEffects.update(d),this.inputManager.updateFrame(),this.missionDialogueManager.update(d),this.floatingTextManager.update(d),this.coachMarkManager.update(d)}},this.render=d=>{if(!this.ship||this.isDestroyed)return;const g=this.ship.getTransform();if(this.canvasManager.clearLayer("fx"),this.canvasManager.clearLayer("particles"),this.canvasManager.clearLayer("ui"),this.canvasManager.clearLayer("overlay"),this.canvasManager.clearLayer("dialogue"),this.renderables.forEach(m=>m.render(d)),this.camera){const m=this.shipCulling.getVisibleShips(),y=this.blockObjectCulling.getVisibleObjects(),v=[...m,...y],M=this.lightingOrchestrator.collectVisibleLights(this.camera),S=this.particleManager.getActiveParticles(),T=Ph.getAndClear();this.unifiedSceneRenderer.render(this.camera,v,M,T,S)}this.shipBuilderEffects.render(),this.shipBuilderMenu.isOpen()&&(this.shipBuilderController.render(this.canvasManager.getContext("entities"),g),this.shipBuilderMenu.render(this.canvasManager.getContext("ui"))),this.blockDropDecisionMenu.isOpen()&&(this.blockDropDecisionMenu.render(this.canvasManager.getContext("ui")),this.blockPlacementController.render(this.canvasManager.getContext("entities"),g)),this.spaceStationBuilderMenu.isOpen()&&this.spaceStation&&(this.spaceStationBuilderController.render(this.canvasManager.getContext("entities"),this.spaceStation.getTransform()),this.spaceStationBuilderMenu.render(this.canvasManager.getContext("ui"))),this.pauseMenu.isOpen()&&this.pauseMenu.render(this.canvasManager.getContext("ui")),this.settingsMenu.isOpen()&&this.settingsMenu.render(this.canvasManager.getContext("ui")),this.cursorRenderer.render()},this.canvasManager=Ti.getInstance(),this.inputManager=new gm(this.canvasManager.getCanvas("ui")),this.grid=new Cw,this.gameLoop=new pm,this.camera=yt.getInstance(ci(),vi()),dS(this.canvasManager.getWebGL2Context("unifiedgl2")),Wb(this.canvasManager.getWebGL2Context("unifiedgl2")),Kb(this.canvasManager.getWebGL2Context("unifiedgl2")),oS(this.canvasManager.getWebGL2Context("unifiedgl2")),gl(this.canvasManager,this.camera),this.popupMessageSystem=new GM(this.canvasManager),this.lightingOrchestrator=$e.getInstance(),this.particleManager=new sC(this.lightingOrchestrator),Xi.initialize(this.canvasManager,this.camera),this.mission=qi.getMission(),Ce.initialize(),Be.getInstance().initialize(0),ws.getInstance().initialize(),this.ship=Sw(this.grid),this.shipRegistry.add(this.ship),this.shipRegistry.setPlayerShip(this.ship),this.shipCulling=new yw(this.grid,this.camera),this.blockObjectCulling=new vw(this.grid,this.camera),this.explosionSystem=new Aw(this.canvasManager,this.camera,this.particleManager,this.lightingOrchestrator),this.screenEffects=new Ew(this.canvasManager),this.shipBuilderEffects=new kw(this.canvasManager,this.camera),this.cursorRenderer=new Dh(this.canvasManager,this.inputManager,this.ship),this.aiOrchestrator=new Th,this.aiOrchestrator.registerPlayerShip(this.ship),this.shipBuilderMenu=new E2(this.inputManager,this.cursorRenderer),this.settingsMenu=new AM(this.inputManager,this.menuManager,this.canvasManager,this.camera),this.pauseMenu=new xM(this.inputManager,this.handlePlayerFailure.bind(this),this.menuManager),this.menuManager.registerMenu("pauseMenu",this.pauseMenu),this.menuManager.registerMenu("settingsMenu",this.settingsMenu),this.menuManager.registerMenu("shipBuilderMenu",this.shipBuilderMenu),this.menuManager.registerPauseHandlers(this.pause.bind(this),this.resume.bind(this)),this.shipBuilderController=new jC(this.ship,this.shipBuilderMenu,this.camera,this.shipBuilderEffects,this.inputManager),this.shipBuilderMenu.setRepairAllHandler(()=>{this.shipBuilderController.repairAllBlocks()}),this.blockDropDecisionMenu=new pM(this.ship,this.inputManager,this.shipBuilderEffects,this.pause.bind(this),this.resume.bind(this)),this.blockPlacementController=new mM(this.ship,this.blockDropDecisionMenu,this.camera,this.shipBuilderEffects,this.inputManager),this.pickupSystem=new Sh(this.camera,this.ship,this.particleManager,this.screenEffects,this.popupMessageSystem,this.shipBuilderEffects,this.blockDropDecisionMenu);const n=new VC(this.pickupSystem),r=new KC(this.explosionSystem,n,this.shipRegistry,this.aiOrchestrator);this.floatingTextManager=new zT;const c=new dw(this.explosionSystem,n,r,this.floatingTextManager);this.collisionSystem=new Mh(c),this.projectileSystem=new VT(this.canvasManager,this.grid,c,this.particleManager,this.ship),this.laserSystem=new jT(this.canvasManager,this.camera,this.grid,c,this.particleManager,this.ship),this.energyRechargeSystem=new gw(this.shipRegistry),this.shipConstructionAnimator=new NT(this.ship,this.camera,this.canvasManager),this.unifiedSceneRenderer=new FT(this.camera,this.inputManager),this.unifiedSceneRenderer.setAmbientLight([.4,.4,.4]),this.unifiedSceneRenderer.setBackgroundImage(((h=this.mission.environmentSettings)==null?void 0:h.backgroundId)??null),this.blockObjectUpdate=new bw(this.blockObjectRegistry);const u=new Wm(this.particleManager);this.movement=new zm(this.ship,u,this.collisionSystem),wo.register(this.ship,this.movement),this.weaponSystem=new Vm(new jm(this.projectileSystem,this.ship),new Km(this.laserSystem),new Zm(c,this.particleManager,this.grid,this.explosionSystem,this.ship),new Qm(c,this.particleManager,this.grid,this.ship)),this.utilitySystem=new Xm(new $m),this.playerController=new rC(this.camera,this.inputManager,this.cursorRenderer,this.ship),this.spaceStationBuilderMenu=new P2(this.inputManager,this.cursorRenderer),this.spaceStation=Tw(this.grid),this.spaceStationBuilderController=new L2(this.spaceStation,this.spaceStationBuilderMenu,this.camera,this.shipBuilderEffects,this.inputManager),this.incidentOrchestrator=new sw({canvasManager:this.canvasManager,camera:this.camera,inputManager:this.inputManager,playerShip:this.ship,aiOrchestrator:this.aiOrchestrator,popupMessageSystem:this.popupMessageSystem}),this.waveSpawner=new $C(this.mission.waves,this.shipRegistry,this.aiOrchestrator,this.ship,this.projectileSystem,this.laserSystem,this.particleManager,this.grid,c,this.explosionSystem,this.collisionSystem,this.shipConstructionAnimator,this.incidentOrchestrator,this.popupMessageSystem),this.waveSpawner.setMissionCompleteHandler(()=>this.handlePlayerVictory()),r.onEntityDestroyed((d,g)=>{d instanceof It&&this.waveSpawner.notifyShipDestruction(d)}),this.planetSystem=new zC(this.ship,this.inputManager,this.camera,this.canvasManager,this.waveSpawner,this.unifiedSceneRenderer),this.planetSystem.registerPlanetsFromConfigs(qi.getPlanetSpawnConfigs()),this.asteroidSpawner=new fw(this.grid,this.blockObjectRegistry),this.coachMarkManager=new SC,this.missionDialogueManager=new lC(this.inputManager,this.canvasManager,this.waveSpawner,this.ship,this.coachMarkManager),this.wavesOverlay=new HM(this.canvasManager,this.waveSpawner),this.debugOverlay=new WM(this.canvasManager,this.shipRegistry),this.hud=new NM(this.canvasManager,this.ship,this.floatingTextManager,this.blockDropDecisionMenu),this.miniMap=new XM(this.canvasManager,this.ship,this.aiOrchestrator,this.planetSystem,ae()),this.updatables=[this.movement,this.projectileSystem,this.laserSystem,this.particleManager,this.aiOrchestrator,this.blockObjectUpdate,this.explosionSystem,Xi.getInstance(),this.screenEffects,this.pickupSystem,this.waveSpawner,this.energyRechargeSystem,{update:d=>{var m;if(!this.ship)return;const g=this.playerController.getIntent();this.movement.setIntent(g.movement),this.weaponSystem.setIntent(g.weapons),this.utilitySystem.setIntent(g.utility);try{this.weaponSystem.update(d,this.ship,this.ship.getTransform()),this.utilitySystem.update(d,this.ship,this.ship.getTransform()),(m=this.ship.getAfterburnerComponent())==null||m.update(d)}catch(y){console.error("Error updating system:",y)}}},this.popupMessageSystem,this.shipConstructionAnimator,this.planetSystem,this.lightingOrchestrator],this.renderables=[this.laserSystem,this.hud,this.miniMap,this.explosionSystem,Xi.getInstance(),this.screenEffects,this.wavesOverlay,this.debugOverlay,this.popupMessageSystem,this.missionDialogueManager,this.shipConstructionAnimator,this.planetSystem,this.aiOrchestrator,this.floatingTextManager,this.coachMarkManager],this.registerLoopHandlers()}registerLoopHandlers(){this.gameLoop.onUpdate(this.boundUpdate),this.gameLoop.onRender(this.boundRender)}pause(){this.isPaused=!0,this.waveSpawner.pause()}resume(){this.isPaused=!1,this.waveSpawner.resume()}async load(){await Promise.all([])}start(){this.gameLoop.start(),this.asteroidSpawner.spawnFieldById("asteroid-field-01"),this.inputManager.disableAllActions(),setTimeout(()=>{this.ship&&this.shipConstructionAnimator.animateShipConstruction(this.ship,{color:"#ADD8E6",radius:96,intensity:1.25})},1e3),setTimeout(()=>{this.inputManager.enableAllActions(),this.missionDialogueManager.initialize()},4200)}handlePlayerVictory(e=1e4){console.log("Player victorious  debriefing will begin in 10 seconds..."),setTimeout(()=>{oh(),So("sepia")},e-1),setTimeout(()=>{Ce.finalize("victory",this.gameLoop.getElapsedSeconds()),this.destroy(),mt.setScene("debriefing")},e)}handlePlayerFailure(){oh(),So("sepia"),console.log("Player defeated  transitioning to debriefing screen."),Ce.finalize("defeat",this.gameLoop.getElapsedSeconds()),this.destroy(),mt.setScene("debriefing")}destroy(){console.log("EngineRuntime: Performing cleanup before scene transition."),this.isDestroyed=!0,this.gameLoop.offUpdate(this.boundUpdate),this.gameLoop.offRender(this.boundRender),this.gameLoop.stop(),this.waveSpawner.reset(),this.shipRegistry.clear(),this.aiOrchestrator.clear(),Xi.getInstance().clear(),Be.getInstance().postMissionClear(),ws.getInstance().destroy(),wo.clear(),zt.clear(),yt.destroy(),Cs.getInstance().reset(),bh.destroyInstance(),this.cursorRenderer.destroy(),this.hud.destroy(),this.miniMap.destroy(),this.lightingOrchestrator.destroy(),this.missionDialogueManager.destroy(),this.blockDropDecisionMenu.destroy(),gS(this.canvasManager.getWebGL2Context("unifiedgl2")),Zb(this.canvasManager.getWebGL2Context("unifiedgl2")),rS(this.canvasManager.getWebGL2Context("unifiedgl2")),this.updatables.length=0,this.renderables.length=0,this.inputManager.destroy(),this.menuManager.reset(),this.ship=null,this.camera=null,this.grid=null,console.log("EngineRuntime: Cleanup complete.")}}let qs=null;function Bw(){const[a,e]=cl.useState(!1);return cl.useEffect(()=>{let i=!1;return(async()=>{qs=new Rw;try{await qs.load(),i||(qs.start(),e(!0))}catch(r){console.error("Failed to load runtime assets:",r)}})(),()=>{i=!0,qs==null||qs.destroy(),qs=null}},[]),Gt.jsx("div",{style:{position:"fixed",inset:0,backgroundColor:"black",transition:"opacity 1.5s ease-in-out",opacity:a?0:1,pointerEvents:"none",zIndex:9999}})}function ty(){try{const a=document.createElement("canvas");return a.getContext("webgl")||a.getContext("experimental-webgl")?{supported:!0}:{supported:!1,error:"WebGL context creation failed"}}catch(a){return{supported:!1,error:a instanceof Error?a.message:"An unknown error occurred"}}}const Iw=ty();console.log("WebGL Support Check:",Iw);function xw(){const[a,e]=cl.useState(mt.getScene());return cl.useEffect(()=>{kh()&&window.electronAPI.toggleFullscreen();const i=ty();i.supported||console.error("WebGL is not supported on this device or browser. Lighting will not work.",i.error);const n=rt.getFirstAvailableResolution(),r=Ae.getInstance();r.setViewportWidth(n.width),r.setViewportHeight(n.height);const c=Ti.getInstance();gl(c),r.onResolutionChange(()=>{gl(c)});const u=()=>{Q.unlock(),window.removeEventListener("pointerdown",u)};window.addEventListener("pointerdown",u,{once:!0});const h=mt.onSceneChange(e);return setTimeout(()=>{mt.setScene("title")},0),()=>h()},[]),Gt.jsxs("div",{id:"canvas-root",children:[Gt.jsx("canvas",{id:"background-canvas"}),Gt.jsx("canvas",{id:"entity-canvas"}),Gt.jsx("canvas",{id:"polygon-canvas"}),Gt.jsx("canvas",{id:"fx-canvas"}),Gt.jsx("canvas",{id:"particles-canvas"}),Gt.jsx("canvas",{id:"unifiedgl2-canvas"}),Gt.jsx("canvas",{id:"ui-canvas"}),Gt.jsx("canvas",{id:"overlay-canvas"}),Gt.jsx("canvas",{id:"dialogue-canvas"}),a==="mission"&&Gt.jsx(Bw,{})]})}Eb();fS();Gb();jb();aS();CS.createRoot(document.getElementById("root")).render(Gt.jsx(xw,{}));
