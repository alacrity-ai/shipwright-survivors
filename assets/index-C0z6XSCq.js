(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const h of l.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&n(h)}).observe(document,{childList:!0,subtree:!0});function i(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=i(o);fetch(o.href,l)}})();function zb(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var tu={exports:{}},To={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Qg;function Xb(){if(Qg)return To;Qg=1;var a=Symbol.for("react.transitional.element"),e=Symbol.for("react.fragment");function i(n,o,l){var h=null;if(l!==void 0&&(h=""+l),o.key!==void 0&&(h=""+o.key),"key"in o){l={};for(var u in o)u!=="key"&&(l[u]=o[u])}else l=o;return o=l.ref,{$$typeof:a,type:n,key:h,ref:o!==void 0?o:null,props:l}}return To.Fragment=e,To.jsx=i,To.jsxs=i,To}var $g;function Vb(){return $g||($g=1,tu.exports=Xb()),tu.exports}var Gt=Vb();function Yb(){window.addEventListener("contextmenu",a=>a.preventDefault()),window.addEventListener("dragover",a=>a.preventDefault()),window.addEventListener("drop",a=>a.preventDefault()),window.addEventListener("keydown",a=>{const e=a.target;if(!(e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable))switch(a.code){case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":case"Space":case"Tab":a.preventDefault();break}}),window.addEventListener("mousedown",a=>{a.button===1&&a.preventDefault()})}function Si(a){if(a.startsWith("cockpit"))return 10;const e=a.match(/(\d{1,2})$/);return e?parseInt(e[1],10):0}function qb(a){if(Si(a.id)===0){const i=a.id.replace(/\d+$/,"1");return oi(i)}return a}const X=32,Ou={cockpit0:{id:"cockpit0",name:"Cockpit",armor:20,cost:50,mass:50,behavior:{canFire:!0,isCockpit:!0,fire:{fireRate:.6,fireType:"bullet",fireDamage:4,projectileSpeed:600,lifetime:1.8,accuracy:.3}},sprite:"cockpit0",category:"system",subcategory:"system",dropRate:0},cockpit1:{id:"cockpit1",name:"Cockpit",armor:150,cost:50,mass:50,behavior:{canFire:!0,isCockpit:!0,fire:{fireRate:.8,fireType:"bullet",fireDamage:14,projectileSpeed:800,lifetime:1.8,accuracy:.75}},sprite:"cockpit1",category:"system",subcategory:"system",dropRate:0},hull0:{id:"hull0",name:"Hull Mk 0",armor:15,mass:50,cost:20,sprite:"hull0",category:"system",subcategory:"hull",dropRate:.07},hull1:{id:"hull1",name:"Hull Mk I",armor:50,mass:50,cost:20,sprite:"hull1",category:"hull",subcategory:"hull",dropRate:.05},hull2:{id:"hull2",name:"Hull Mk II",armor:75,mass:60,cost:40,sprite:"hull2",category:"hull",subcategory:"hull",dropRate:.05},hull3:{id:"hull3",name:"Hull Mk III",armor:100,mass:75,cost:80,sprite:"hull3",category:"hull",subcategory:"hull",dropRate:.04},hull4:{id:"hull4",name:"Hull Mk IV",armor:150,mass:90,cost:140,sprite:"hull4",category:"hull",subcategory:"hull",dropRate:.03},facetplate0:{id:"facetplate0",name:"Facetplate Mk 0",armor:20,mass:30,cost:30,sprite:"facetplate0",category:"system",subcategory:"system",behavior:{rammingDamageMultiplier:1.1,rammingArmor:7},dropRate:.05},facetplate1:{id:"facetplate1",name:"Facetplate Mk I",armor:75,mass:30,cost:30,sprite:"facetplate1",category:"hull",subcategory:"facetplate",dropRate:.05,behavior:{rammingDamageMultiplier:1.3,rammingArmor:7}},facetplate2:{id:"facetplate2",name:"Facetplate Mk II",armor:100,mass:40,cost:60,sprite:"facetplate2",category:"hull",subcategory:"facetplate",behavior:{rammingDamageMultiplier:1.5,rammingArmor:12},dropRate:.04},facetplate3:{id:"facetplate3",name:"Facetplate Mk III",armor:125,mass:50,cost:100,sprite:"facetplate3",category:"hull",subcategory:"facetplate",behavior:{rammingDamageMultiplier:1.7,rammingArmor:17},dropRate:.03},facetplate4:{id:"facetplate4",name:"Facetplate Mk IV",armor:175,mass:60,cost:120,sprite:"facetplate4",category:"hull",subcategory:"facetplate",behavior:{rammingDamageMultiplier:2,rammingArmor:22},dropRate:.02},turret0:{id:"turret0",name:"Turret Mk 0",armor:20,cost:40,mass:40,sprite:"turret0",behavior:{canFire:!0,fire:{fireRate:1,fireType:"bullet",fireDamage:2,projectileSpeed:700,lifetime:2.2,accuracy:.5}},category:"system",subcategory:"system",dropRate:.3,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret1:{id:"turret1",name:"Turret Mk I",armor:40,cost:40,mass:40,sprite:"turret1",behavior:{canFire:!0,fire:{fireRate:1,fireType:"bullet",fireDamage:10,projectileSpeed:800,lifetime:1.8,accuracy:.65}},category:"weapon",subcategory:"turret",dropRate:.3,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret2:{id:"turret2",name:"Turret Mk II",armor:50,cost:100,mass:50,sprite:"turret2",behavior:{canFire:!0,fire:{fireRate:2,fireType:"bullet",fireDamage:16,projectileSpeed:800,lifetime:2.2,accuracy:.75}},category:"weapon",subcategory:"turret",dropRate:.2,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret3:{id:"turret3",name:"Turret Mk III",armor:75,cost:200,mass:60,sprite:"turret3",behavior:{canFire:!0,fire:{fireRate:3,fireType:"bullet",fireDamage:20,projectileSpeed:900,lifetime:2.2,accuracy:.9}},category:"weapon",subcategory:"turret",dropRate:.15,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},turret4:{id:"turret4",name:"Turret Mk IV",armor:100,cost:400,mass:100,sprite:"turret4",behavior:{canFire:!0,fire:{fireRate:4,fireType:"bullet",fireDamage:30,projectileSpeed:1e3,lifetime:2.2,accuracy:.95}},category:"weapon",subcategory:"turret",dropRate:.12,placementSound:"assets/sounds/sfx/ship/attach_00.wav"},explosiveLance0:{id:"explosiveLance0",name:"Explosive Lance Mk 0",armor:60,cost:120,mass:80,sprite:"explosiveLance0",category:"system",subcategory:"system",behavior:{canFire:!0,fire:{fireRate:.5,fireType:"explosiveLance",fireDamage:1,explosionDamage:2,explosionRadiusBlocks:3,detonationDelayMs:1500,projectileSpeed:1e3,lifetime:.8,accuracy:.95}},dropRate:.2},explosiveLance1:{id:"explosiveLance1",name:"Explosive Lance Mk I",armor:60,cost:140,mass:80,sprite:"explosiveLance1",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.5,fireType:"explosiveLance",fireDamage:1,explosionDamage:20,explosionRadiusBlocks:3,detonationDelayMs:1500,projectileSpeed:1600,lifetime:.8,accuracy:.95}},dropRate:.15},explosiveLance2:{id:"explosiveLance2",name:"Explosive Lance Mk II",armor:80,cost:220,mass:90,sprite:"explosiveLance2",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.6,fireType:"explosiveLance",fireDamage:1,explosionDamage:25,explosionRadiusBlocks:4,detonationDelayMs:1500,projectileSpeed:1600,lifetime:.85,accuracy:.97}},dropRate:.14},explosiveLance3:{id:"explosiveLance3",name:"Explosive Lance Mk III",armor:90,cost:360,mass:110,sprite:"explosiveLance3",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.7,fireType:"explosiveLance",fireDamage:1,explosionDamage:30,explosionRadiusBlocks:5,detonationDelayMs:1500,projectileSpeed:1600,lifetime:.9,accuracy:.98}},dropRate:.13},explosiveLance4:{id:"explosiveLance4",name:"Explosive Lance Mk IV",armor:100,cost:600,mass:120,sprite:"explosiveLance4",category:"weapon",subcategory:"explosiveLance",behavior:{canFire:!0,fire:{fireRate:.8,fireType:"explosiveLance",fireDamage:1,explosionDamage:40,explosionRadiusBlocks:6,detonationDelayMs:1500,projectileSpeed:1600,lifetime:1,accuracy:.99}},dropRate:.1},laser0:{id:"laser0",name:"Laser Emitter Mk 0",armor:40,cost:500,mass:80,sprite:"laser0",category:"system",subcategory:"system",behavior:{canFire:!0,fire:{fireType:"laser",fireRate:0,energyCost:.15,fireDamage:1,projectileSpeed:0,lifetime:0,accuracy:1}},dropRate:.12},laser1:{id:"laser1",name:"Laser Emitter Mk I",armor:80,cost:500,mass:100,sprite:"laser1",category:"weapon",subcategory:"laser",behavior:{canFire:!0,energyMaxIncrease:60,fire:{fireType:"laser",fireDamage:2,energyCost:.15}},dropRate:.06},laser2:{id:"laser2",name:"Laser Emitter Mk II",armor:100,cost:1e3,mass:160,sprite:"laser2",category:"weapon",subcategory:"laser",behavior:{canFire:!0,energyMaxIncrease:80,fire:{fireType:"laser",fireDamage:3.5,energyCost:.2}},dropRate:.08},laser3:{id:"laser3",name:"Laser Emitter Mk III",armor:100,cost:1800,mass:160,sprite:"laser3",category:"weapon",subcategory:"laser",behavior:{canFire:!0,energyMaxIncrease:100,fire:{fireType:"laser",fireDamage:5,energyCost:.3}},dropRate:.06},reactor0:{id:"reactor0",name:"Reactor Mk 0",armor:25,cost:400,mass:60,behavior:{energyChargeRate:10},sprite:"reactor0",category:"system",subcategory:"system",dropRate:.08},reactor1:{id:"reactor1",name:"Reactor Mk I",armor:50,cost:400,mass:60,behavior:{energyChargeRate:10},sprite:"reactor1",category:"utility",subcategory:"energy",dropRate:.06},reactor2:{id:"reactor2",name:"Reactor Mk II",armor:75,cost:800,mass:80,behavior:{energyChargeRate:20},sprite:"reactor2",category:"utility",subcategory:"energy",dropRate:.03},battery0:{id:"battery0",name:"Battery Mk 0",armor:20,cost:200,mass:40,behavior:{energyMaxIncrease:100},sprite:"battery0",category:"system",subcategory:"system",dropRate:.08},battery1:{id:"battery1",name:"Battery Mk I",armor:30,cost:200,mass:50,behavior:{energyMaxIncrease:50},sprite:"battery1",category:"utility",subcategory:"energy",dropRate:.06},battery2:{id:"battery2",name:"Battery Mk II",armor:40,cost:400,mass:60,behavior:{energyMaxIncrease:100},sprite:"battery2",category:"utility",subcategory:"energy",dropRate:.03},shield0:{id:"shield0",name:"Shield Mk 0",armor:20,cost:200,mass:40,behavior:{shieldEfficiency:.5,shieldRadius:2,energyMaxIncrease:30,shieldEnergyDrain:1},sprite:"shield0",category:"system",subcategory:"system",dropRate:.08},shield1:{id:"shield1",name:"Shield Mk I",armor:60,cost:160,mass:50,behavior:{shieldEfficiency:.65,shieldRadius:2,energyMaxIncrease:30,shieldEnergyDrain:3},sprite:"shield1",category:"utility",subcategory:"shield",dropRate:.08},shield2:{id:"shield2",name:"Shield Mk II",armor:80,cost:300,mass:60,behavior:{shieldEfficiency:.8,shieldRadius:3,energyMaxIncrease:40,shieldEnergyDrain:5},sprite:"shield2",category:"utility",subcategory:"shield",dropRate:.03},shield3:{id:"shield3",name:"Shield Mk III",armor:100,cost:600,mass:70,behavior:{shieldEfficiency:1,shieldRadius:4,energyMaxIncrease:50,shieldEnergyDrain:7},sprite:"shield3",category:"utility",subcategory:"shield",dropRate:.02},engine0:{id:"engine0",name:"Engine Mk 0",armor:15,cost:35,mass:30,behavior:{canThrust:!0,thrustPower:50},sprite:"engine0",category:"system",subcategory:"system",dropRate:.08},engine1:{id:"engine1",name:"Engine Mk I",armor:40,cost:35,mass:30,behavior:{canThrust:!0,thrustPower:50},sprite:"engine1",category:"engine",subcategory:"engine",dropRate:.05},engine2:{id:"engine2",name:"Engine Mk II",armor:45,cost:60,mass:30,behavior:{canThrust:!0,thrustPower:75},sprite:"engine2",category:"engine",subcategory:"engine",dropRate:.08},engine3:{id:"engine3",name:"Engine Mk III",armor:50,cost:80,mass:30,behavior:{canThrust:!0,thrustPower:90},sprite:"engine3",category:"engine",subcategory:"engine",dropRate:.05},engine4:{id:"engine4",name:"Engine Mk IV",armor:55,mass:30,cost:160,behavior:{canThrust:!0,thrustPower:115},sprite:"engine4",category:"engine",subcategory:"engine",dropRate:.04},fin0:{id:"fin0",name:"Fin Mk 0",armor:10,mass:20,cost:30,behavior:{turnPower:.1},sprite:"fin0",category:"system",subcategory:"system",dropRate:.06},fin1:{id:"fin1",name:"Fin Mk I",armor:50,mass:10,cost:40,behavior:{turnPower:.5},sprite:"fin1",category:"hull",subcategory:"fin",dropRate:.06},fin2:{id:"fin2",name:"Fin Mk II",armor:75,mass:10,cost:80,behavior:{turnPower:1},sprite:"fin2",category:"hull",subcategory:"fin",dropRate:.06},fin3:{id:"fin3",name:"Fin Mk III",armor:90,mass:10,cost:120,behavior:{turnPower:1.5},sprite:"fin3",category:"hull",subcategory:"fin",dropRate:.05},fin4:{id:"fin4",name:"Fin Mk IV",armor:120,mass:10,cost:200,behavior:{turnPower:2},sprite:"fin4",category:"hull",subcategory:"fin",dropRate:.05},harvester0:{id:"harvester0",name:"Resource Harvester Mk 0",armor:50,mass:30,cost:120,behavior:{harvestRate:5},sprite:"harvester0",category:"system",subcategory:"system",dropRate:.1},harvester1:{id:"harvester1",name:"Resource Harvester Mk I",armor:50,mass:30,cost:120,behavior:{harvestRate:3},sprite:"harvester1",category:"utility",subcategory:"exploration",dropRate:.1},harvester2:{id:"harvester2",name:"Resource Harvester Mk II",armor:80,mass:40,cost:200,behavior:{harvestRate:5},sprite:"harvester2",category:"utility",subcategory:"exploration",dropRate:.1},haloBlade0:{id:"haloBlade0",name:"Halo Blade Mk 0",armor:100,mass:80,cost:400,behavior:{haloBladeProperties:{orbitingRadius:500,orbitingSpeed:1.2,size:64,damage:1,color:"#FFBF00",sprite:"energyRing0"}},sprite:"haloBlade0",category:"weapon",subcategory:"haloBlade",dropRate:.1},haloBlade1:{id:"haloBlade1",name:"Halo Blade Mk I",armor:120,mass:80,cost:400,behavior:{haloBladeProperties:{orbitingRadius:500,orbitingSpeed:2,size:64,damage:5,color:"#FFBF00",sprite:"energyRing1"}},sprite:"haloBlade1",category:"weapon",subcategory:"haloBlade",dropRate:.18},haloBlade2:{id:"haloBlade2",name:"Halo Blade Mk II",armor:140,mass:80,cost:600,behavior:{haloBladeProperties:{orbitingRadius:700,orbitingSpeed:2.4,size:64,damage:8,color:"#2CFF05",sprite:"energyRing2"}},sprite:"haloBlade2",category:"weapon",subcategory:"haloBlade",dropRate:.14},haloBlade3:{id:"haloBlade3",name:"Halo Blade Mk III",armor:160,mass:80,cost:900,behavior:{haloBladeProperties:{orbitingRadius:900,orbitingSpeed:2.8,size:64,damage:12,color:"#00FFFF",sprite:"energyRing3"}},sprite:"haloBlade3",category:"weapon",subcategory:"haloBlade",dropRate:.12},haloBlade4:{id:"haloBlade4",name:"Halo Blade Mk IV",armor:180,mass:80,cost:1200,behavior:{haloBladeProperties:{orbitingRadius:1100,orbitingSpeed:3.2,size:64,damage:15,color:"#7F00FF",sprite:"energyRing4"}},sprite:"haloBlade4",category:"weapon",subcategory:"haloBlade",dropRate:.1},fuelTank0:{id:"fuelTank0",name:"Fuel Tank Mk 0",armor:50,cost:50,mass:25,behavior:{fuelCapacityIncrease:20},sprite:"fuelTank0",category:"system",subcategory:"system",dropRate:.08},fuelTank1:{id:"fuelTank1",name:"Fuel Tank Mk I",armor:60,cost:50,mass:25,behavior:{fuelCapacityIncrease:25},sprite:"fuelTank1",category:"utility",subcategory:"fuel",dropRate:.08},fuelTank2:{id:"fuelTank2",name:"Fuel Tank Mk II",armor:70,cost:50,mass:30,behavior:{fuelCapacityIncrease:35},sprite:"fuelTank2",category:"utility",subcategory:"fuel",dropRate:.08},fuelTank3:{id:"fuelTank3",name:"Fuel Tank Mk III",armor:80,cost:50,mass:35,behavior:{fuelCapacityIncrease:50},sprite:"fuelTank3",category:"utility",subcategory:"fuel",dropRate:.08},fuelTank4:{id:"fuelTank4",name:"Fuel Tank Mk IV",armor:90,cost:50,mass:40,behavior:{fuelCapacityIncrease:75},sprite:"fuelTank4",category:"utility",subcategory:"fuel",dropRate:.07}};function Fo(){return Object.values(Ou)}function oi(a){return Ou[a]}function Tm(a){const e=oi(a);return e?e.cost:void 0}function jb(a){return Object.values(Ou).filter(e=>Si(e.id)===a)}function Jg(a){return Si(a.id)}function It(a,e){const i=a.createTexture();if(!i)throw new Error("Failed to create WebGL texture");return a.bindTexture(a.TEXTURE_2D,i),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),i}function Kb(a,e){const i=a.createTexture();if(!i)throw new Error("Failed to create WebGL texture");return a.bindTexture(a.TEXTURE_2D,i),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.bindTexture(a.TEXTURE_2D,null),i}function el(a,e,i){const n=a.createLinearGradient(0,0,0,e);n.addColorStop(0,i.body[0]),n.addColorStop(.3,i.body[1]),n.addColorStop(.7,i.body[2]),n.addColorStop(1,i.body[3]),a.fillStyle=n,a.fillRect(0,0,e,e),a.fillStyle=i.housing,a.fillRect(2,6,e-4,e-8),a.fillStyle=i.innerHousing,a.fillRect(3,7,e-6,e-10);const o=a.createLinearGradient(0,0,e,0);o.addColorStop(0,i.barrel[0]),o.addColorStop(.5,i.barrel[1]),o.addColorStop(1,i.barrel[2]),a.fillStyle=o,a.fillRect(e/2-3,2,6,e-4),a.fillStyle=i.barrelDetail,a.fillRect(e/2-1,1,2,e-2);const l=a.createRadialGradient(e/2,e-6,0,e/2,e-6,4);l.addColorStop(0,i.glow[0]),l.addColorStop(.7,i.glow[1]),l.addColorStop(1,i.glow[2]),a.fillStyle=l,a.beginPath(),a.arc(e/2,e-6,4,0,Math.PI*2),a.fill();const h=a.createRadialGradient(e/2,2,0,e/2,2,5);h.addColorStop(0,i.muzzleGlow[0]),h.addColorStop(.3,i.muzzleGlow[1]),h.addColorStop(.6,i.muzzleGlow[2]),h.addColorStop(1,i.muzzleGlow[3]),a.fillStyle=h,a.beginPath(),a.arc(e/2,2,5,0,Math.PI*2),a.fill(),a.fillStyle=i.muzzleCore,a.beginPath(),a.arc(e/2,2,1.5,0,Math.PI*2),a.fill()}function tl(a,e,i){const n=a.createLinearGradient(0,0,0,e);for(const[o,l]of i)n.addColorStop(o,l);a.fillStyle=n,a.fillRect(0,0,e,e)}function il(a,e,i){const n=a.createLinearGradient(0,e/2,0,e);for(const[o,l]of i)n.addColorStop(o,l);a.fillStyle=n,a.beginPath(),a.moveTo(e/2,e/2),a.lineTo(0,e),a.lineTo(e,e),a.closePath(),a.fill()}function sl(a,e,i,n){const o=i/2,l=i/2,h=i*.35,u=a.createRadialGradient(o,l,0,o,l,i/2);n.baseGradientColors.forEach((m,y,v)=>u.addColorStop(y/(v.length-1),m)),a.fillStyle=u,a.fillRect(0,0,i,i);const d=e.createRadialGradient(o,l,0,o,l,h);n.rotatingBaseColors.forEach((m,y,v)=>d.addColorStop(y/(v.length-1),m)),Zb(e,o,l,h,d),Qb(e,o,l,h);const g=e.createLinearGradient(o-n.barrelWidth/2,0,o+n.barrelWidth/2,0);n.barrelGradientStops.forEach(([m,y])=>g.addColorStop(m,y)),$b(e,o,n.barrelWidth,n.barrelLength,g),Jb(e,o)}function Zb(a,e,i,n,o){a.fillStyle=o,a.beginPath(),a.arc(e,i,n,0,Math.PI*2),a.fill()}function Qb(a,e,i,n){a.strokeStyle="#AAA",a.lineWidth=1,a.beginPath(),a.moveTo(e,i-n*.8),a.lineTo(e,i+n*.8),a.moveTo(e-n*.8,i),a.lineTo(e+n*.8,i),a.stroke()}function $b(a,e,i,n,o){a.fillStyle=o,a.fillRect(e-i/2,0,i,n)}function Jb(a,e){a.fillStyle="#ff6666",a.fillRect(e-2,0,4,4)}function ep(a,e,i){const n=e/2,o=e/2,l=a.createLinearGradient(0,0,0,e);i.chassisStops.forEach(([d,g])=>l.addColorStop(d,g)),a.fillStyle=l,a.fillRect(0,0,e,e);const h=a.createRadialGradient(n,o,i.coreRingInnerRadius,n,o,e/2);i.coreRingStops.forEach(([d,g])=>h.addColorStop(d,g)),a.fillStyle=h,a.beginPath(),a.arc(n,o,e/2,0,Math.PI*2),a.fill();const u=a.createRadialGradient(n,o,0,n,o,i.coreGlowRadius);i.coreGlowStops.forEach(([d,g])=>u.addColorStop(d,g)),a.fillStyle=u,a.beginPath(),a.arc(n,o,i.coreGlowRadius,0,Math.PI*2),a.fill(),a.strokeStyle=i.boltColor,a.lineWidth=1,a.beginPath(),a.moveTo(4,4),a.lineTo(e-4,4),a.moveTo(4,e-4),a.lineTo(e-4,e-4),a.moveTo(4,4),a.lineTo(4,e-4),a.moveTo(e-4,4),a.lineTo(e-4,e-4),a.stroke()}function nl(a,e,i){const n=a.createLinearGradient(0,0,0,e);i.bodyStops.forEach(([u,d])=>n.addColorStop(u,d)),a.fillStyle=n,a.fillRect(0,0,e,e);const o=i.thrustInsetX??6,l=i.thrustHeight??4,h=i.thrustInsetY??6;a.fillStyle=i.thrustColor,a.fillRect(o,e-h,e-o*2,l)}function al(a,e,i){const n=a.createLinearGradient(0,0,e,e);for(const[o,l]of i)n.addColorStop(o,l);a.fillStyle=n,a.beginPath(),a.moveTo(0,e),a.lineTo(e,e),a.lineTo(e,0),a.closePath(),a.fill()}function tp(a,e,i){const n=e/2,o=e/2,l=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.chassisStops)??[[0,"#222831"],[.5,"#393E46"],[1,"#1E1E2F"]]).forEach(([d,g])=>l.addColorStop(d,g)),a.fillStyle=l,a.fillRect(0,0,e,e);const h=a.createRadialGradient(n,o,0,n,o,(i==null?void 0:i.coreRadius)??e*.4);((i==null?void 0:i.cellGlowStops)??[[0,"#C8E6C9"],[.5,"#81C784"],[1,"rgba(129, 199, 132, 0)"]]).forEach(([d,g])=>h.addColorStop(d,g)),a.fillStyle=h,a.beginPath(),a.arc(n,o,(i==null?void 0:i.coreRadius)??e*.4,0,Math.PI*2),a.fill(),a.fillStyle=(i==null?void 0:i.terminalColor)??"#B0BEC5";const u=(i==null?void 0:i.terminalSize)??3;a.fillRect(n-u/2,2,u,6),a.fillRect(n-u/2,e-8,u,6),a.strokeStyle="#A5D6A7",a.lineWidth=1.2,a.beginPath(),a.arc(n,o,e*.25,0,Math.PI*2),a.stroke()}function iu(a,e,i){const n=e/2,o=e/2,l=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.chassisStops)??[[0,"#1A1A2E"],[.5,"#16213E"],[1,"#0F3460"]]).forEach(([u,d])=>l.addColorStop(u,d)),a.fillStyle=l,a.fillRect(0,0,e,e);const h=a.createRadialGradient(n,o,0,n,o,(i==null?void 0:i.emitterRadius)??e*.35);((i==null?void 0:i.emitterGlowStops)??[[0,"#BBDEFB"],[.5,"#42A5F5"],[1,"rgba(66, 165, 245, 0)"]]).forEach(([u,d])=>h.addColorStop(u,d)),a.fillStyle=h,a.beginPath(),a.arc(n,o,(i==null?void 0:i.emitterRadius)??e*.35,0,Math.PI*2),a.fill(),a.strokeStyle=(i==null?void 0:i.ringColor)??"#90CAF9",a.lineWidth=1.5,a.beginPath(),a.arc(n,o,e*.38,0,Math.PI*2),a.stroke(),a.fillStyle=(i==null?void 0:i.terminalColor)??"#E3F2FD",a.fillRect(n-1.5,2,3,5),a.fillRect(n-1.5,e-7,3,5),a.fillRect(2,o-1.5,5,3),a.fillRect(e-7,o-1.5,5,3)}function ip(a,e,i){const n=e/2,o=e/2,l=e*.45,h=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.casingStops)??[[0,"#3E3E3E"],[.5,"#555555"],[1,"#222222"]]).forEach(([d,g])=>h.addColorStop(d,g)),a.fillStyle=h,a.fillRect(0,0,e,e);const u=a.createRadialGradient(n,o,0,n,o,l*.8);u.addColorStop(0,(i==null?void 0:i.vortexColor)??"#66ccff"),u.addColorStop(1,"rgba(102, 204, 255, 0)"),a.fillStyle=u,a.beginPath(),a.arc(n,o,l*.8,0,Math.PI*2),a.fill(),a.fillStyle=(i==null?void 0:i.intakeColor)??"#00B8D4",a.beginPath(),a.arc(n,o,l*.3,0,Math.PI*2),a.fill(),a.strokeStyle=(i==null?void 0:i.ringColor)??"rgba(0, 200, 255, 0.4)",a.lineWidth=1.5;for(let d=1;d<=2;d++)a.beginPath(),a.arc(n,o,l*(.4+.15*d),0,Math.PI*2),a.stroke()}function ol(a,e,i,n){const o=i/2,l=i/2,h=i*.35,u=a.createRadialGradient(o,l,0,o,l,i/2);((n==null?void 0:n.baseGradientColors)??["#222","#444","#111"]).forEach((y,v,M)=>u.addColorStop(v/(M.length-1),y)),a.fillStyle=u,a.fillRect(0,0,i,i);const d=e.createRadialGradient(o,l,0,o,l,h);d.addColorStop(0,"#900"),d.addColorStop(1,"#500"),e.fillStyle=d,e.beginPath(),e.arc(o,l,h,0,Math.PI*2),e.fill(),e.strokeStyle="#f55",e.lineWidth=1,e.beginPath(),e.moveTo(o,l-h*.8),e.lineTo(o,l+h*.8),e.moveTo(o-h*.8,l),e.lineTo(o+h*.8,l),e.stroke();const g=(n==null?void 0:n.barrelLength)??i*.7,m=(n==null?void 0:n.barrelGradientStops)??[[0,"#ffcccb"],[.5,"#ff5555"],[1,"#aa0000"]];tS(e,o,g,m),iS(e,o,g,m),sS(e,o,m)}function sp(a,e,i){const n=a.replace("#",""),o=e.replace("#",""),l=parseInt(n.substr(0,2),16),h=parseInt(n.substr(2,2),16),u=parseInt(n.substr(4,2),16),d=parseInt(o.substr(0,2),16),g=parseInt(o.substr(2,2),16),m=parseInt(o.substr(4,2),16),y=Math.round(l+(d-l)*i),v=Math.round(h+(g-h)*i),M=Math.round(u+(m-u)*i);return`#${y.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`}function eS(a,e){const i=a.replace("#",""),n=Math.min(255,Math.round(parseInt(i.substr(0,2),16)*(1+e))),o=Math.min(255,Math.round(parseInt(i.substr(2,2),16)*(1+e))),l=Math.min(255,Math.round(parseInt(i.substr(4,2),16)*(1+e)));return`#${n.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`}function tS(a,e,i,n){var g,m,y;const l=i/4,h=((g=n[0])==null?void 0:g[1])||"#cccccc",u=((m=n[1])==null?void 0:m[1])||"#888888",d=((y=n[2])==null?void 0:y[1])||"#444444";for(let v=0;v<4;v++){const M=v*l,b=v/3,C=8-b*3,w=C-1;let A;b<=.5?A=sp(h,u,b*2):A=sp(u,d,(b-.5)*2),a.fillStyle=A,a.beginPath(),a.moveTo(e-C/2,M),a.lineTo(e+C/2,M),a.lineTo(e+w/2,M+l),a.lineTo(e-w/2,M+l),a.closePath(),a.fill(),v>0&&(a.strokeStyle=eS(d,.3),a.lineWidth=1,a.beginPath(),a.moveTo(e-C/2,M),a.lineTo(e+C/2,M),a.stroke())}}function iS(a,e,i,n){var u;const o=((u=n[1])==null?void 0:u[1])||"#ffaa00";a.fillStyle=o;const l=6,h=i/(l+1);for(let d=0;d<l;d++){const g=h*(d+1),m=2;a.fillRect(e-6,g-m/2,m,m),a.fillRect(e+4,g-m/2,m,m)}}function sS(a,e,i){var l,h;const n=((l=i[2])==null?void 0:l[1])||"#ff6600",o=((h=i[0])==null?void 0:h[1])||"#ffff00";a.fillStyle=n,a.beginPath(),a.moveTo(e-3,0),a.lineTo(e+3,0),a.lineTo(e,-4),a.closePath(),a.fill(),a.fillStyle=o,a.beginPath(),a.arc(e,-1,1.5,0,Math.PI*2),a.fill()}function rl(a,e,i){const n=e/2,o=e/2,l=e*.45,h=l*.2,u=4,d=a.createLinearGradient(0,0,0,e);for(const[m,y]of i.casingStops)d.addColorStop(m,y);a.fillStyle=d,a.fillRect(0,0,e,e);const g=a.createRadialGradient(n,o,0,n,o,l);g.addColorStop(0,i.glowColor),g.addColorStop(1,"rgba(0,0,0,0)"),a.fillStyle=g,a.beginPath(),a.arc(n,o,l,0,Math.PI*2),a.fill(),a.strokeStyle=i.ringColor,a.lineWidth=u,a.beginPath(),a.arc(n,o,l-u/2,0,Math.PI*2),a.stroke(),a.fillStyle=i.coreColor,a.beginPath(),a.arc(n,o,h,0,Math.PI*2),a.fill()}function ll(a,e,i){const n=e/2,o=e/2,l=a.createLinearGradient(0,0,0,e);((i==null?void 0:i.casingStops)??[[0,"#2B2B2B"],[.3,"#1F1F1F"],[.6,"#0F0F0F"],[1,"#000000"]]).forEach(([y,v])=>l.addColorStop(y,v)),a.fillStyle=l,a.fillRect(0,0,e,e);const h=e*.28,u=a.createRadialGradient(n,o,0,n,o,h);u.addColorStop(0,(i==null?void 0:i.coreColor)??"#FFD54F"),u.addColorStop(1,"rgba(255, 213, 79, 0)"),a.fillStyle=u,a.beginPath(),a.arc(n,o,h,0,Math.PI*2),a.fill(),a.strokeStyle=(i==null?void 0:i.stripeColor)??"#666",a.lineWidth=2;const d=4;for(let y=0;y<d;y++){const v=(y+1)/(d+1)*e;a.beginPath(),a.moveTo(v,4),a.lineTo(v,e-4),a.stroke()}a.fillStyle=(i==null?void 0:i.terminalHighlightColor)??"#FFECB3";const g=e*.2,m=4;a.fillRect(n-g/2,2,g,m),a.fillRect(n-g/2,e-m-2,g,m)}var an=(a=>(a.NONE="none",a.LIGHT="light",a.MODERATE="moderate",a.HEAVY="heavy",a))(an||{});const Fu=new Map,yl=new Map;function vl(){const a=document.createElement("canvas");return a.width=X,a.height=X,a}function na(a,e){if(e==="none")return a;const i=vl(),n=i.getContext("2d"),o=vl(),l=o.getContext("2d"),h={light:{opacity:.9,tint:"rgba(255,0,0,0.1)",cracks:!1},moderate:{opacity:.7,tint:"rgba(255,0,0,0.25)",cracks:!0},heavy:{opacity:.4,tint:"rgba(255,0,0,0.4)",cracks:!0}}[e];if(n.globalAlpha=h.opacity,n.drawImage(a,0,0),n.globalAlpha=1,l.clearRect(0,0,X,X),l.fillStyle=h.tint,l.fillRect(0,0,X,X),l.globalCompositeOperation="destination-in",l.drawImage(a,0,0),l.globalCompositeOperation="source-over",n.drawImage(o,0,0),h.cracks){l.clearRect(0,0,X,X),l.strokeStyle=e==="heavy"?"rgba(40,40,40,0.9)":"rgba(60,60,60,0.7)",l.lineWidth=e==="heavy"?2:1;const u=X/2;l.beginPath(),l.moveTo(u*.2,u*.4),l.lineTo(u*1.6,u*1.8),l.moveTo(u*.4,u*1.8),l.lineTo(u*1.8,u*.2),e==="heavy"&&(l.moveTo(0,u),l.lineTo(u*.8,u*1.2),l.moveTo(u*1.2,u*.8),l.lineTo(X,u)),l.stroke(),l.globalCompositeOperation="destination-in",l.drawImage(a,0,0),l.globalCompositeOperation="source-over",n.drawImage(o,0,0)}return i}function nS(a){return{none:a,light:{base:na(a.base,"light"),overlay:a.overlay?na(a.overlay,"light"):void 0},moderate:{base:na(a.base,"moderate"),overlay:a.overlay?na(a.overlay,"moderate"):void 0},heavy:{base:na(a.base,"heavy"),overlay:a.overlay?na(a.overlay,"heavy"):void 0}}}function aS(a){const e=vl(),i=e.getContext("2d"),n=vl(),o=n.getContext("2d");switch(a){case"cockpit0":i.fillStyle="#444",i.fillRect(0,0,X,X),i.fillStyle="#ff2222",i.beginPath(),i.arc(X/2,X/2,8,0,Math.PI*2),i.fill();break;case"cockpit1":i.fillStyle="#444",i.fillRect(0,0,X,X),i.fillStyle="#0ff",i.beginPath(),i.arc(X/2,X/2,8,0,Math.PI*2),i.fill();break;case"hull0":case"hull1":tl(i,X,[[0,"#C0C0C0"],[.3,"#A0A0A0"],[.7,"#808080"],[1,"#606060"]]);break;case"hull2":tl(i,X,[[0,"#66FF66"],[.2,"#4CAF50"],[.6,"#388E3C"],[1,"#1B5E20"]]);break;case"hull3":tl(i,X,[[0,"#64B5F6"],[.2,"#2196F3"],[.6,"#1976D2"],[1,"#0D47A1"]]);break;case"hull4":tl(i,X,[[0,"#E1BEE7"],[.15,"#BA68C8"],[.4,"#9C27B0"],[.7,"#7B1FA2"],[1,"#4A148C"]]);break;case"facetplate0":case"facetplate1":il(i,X,[[0,"#C0C0C0"],[.3,"#A0A0A0"],[.7,"#808080"],[1,"#606060"]]);break;case"facetplate2":il(i,X,[[0,"#66FF66"],[.2,"#4CAF50"],[.6,"#388E3C"],[1,"#1B5E20"]]);break;case"facetplate3":il(i,X,[[0,"#64B5F6"],[.2,"#2196F3"],[.6,"#1976D2"],[1,"#0D47A1"]]);break;case"facetplate4":il(i,X,[[0,"#E1BEE7"],[.15,"#BA68C8"],[.4,"#9C27B0"],[.7,"#7B1FA2"],[1,"#4A148C"]]);break;case"fuelTank0":case"fuelTank1":ll(i,X,{casingStops:[[0,"#C0C0C0"],[.3,"#A0A0A0"],[.6,"#808080"],[1,"#606060"]],coreColor:"#FFF176",stripeColor:"#999",terminalHighlightColor:"#F0F4C3"});break;case"fuelTank2":ll(i,X,{casingStops:[[0,"#66FF66"],[.2,"#4CAF50"],[.6,"#388E3C"],[1,"#1B5E20"]],coreColor:"#B2FF59",stripeColor:"#33691E",terminalHighlightColor:"#DCEDC8"});break;case"fuelTank3":ll(i,X,{casingStops:[[0,"#64B5F6"],[.2,"#2196F3"],[.6,"#1976D2"],[1,"#0D47A1"]],coreColor:"#81D4FA",stripeColor:"#1565C0",terminalHighlightColor:"#E3F2FD"});break;case"fuelTank4":ll(i,X,{casingStops:[[0,"#E1BEE7"],[.15,"#BA68C8"],[.4,"#9C27B0"],[.7,"#7B1FA2"],[1,"#4A148C"]],coreColor:"#CE93D8",stripeColor:"#8E24AA",terminalHighlightColor:"#F3E5F5"});break;case"turret0":case"turret1":sl(i,o,X,{baseGradientColors:["#777","#555","#333"],rotatingBaseColors:["#888","#666","#444"],barrelGradientStops:[[0,"#444"],[.3,"#f44"],[.7,"#c22"],[1,"#822"]],barrelWidth:6,barrelLength:X*.6});break;case"turret2":sl(i,o,X,{baseGradientColors:["#66BB6A","#4CAF50","#2E7D32"],rotatingBaseColors:["#81C784","#4CAF50","#1B5E20"],barrelGradientStops:[[0,"#1B5E20"],[.2,"#388E3C"],[.5,"#4CAF50"],[.8,"#66BB6A"],[1,"#2E7D32"]],barrelWidth:7,barrelLength:X*.65});break;case"turret3":sl(i,o,X,{baseGradientColors:["#64B5F6","#2196F3","#1565C0"],rotatingBaseColors:["#90CAF9","#42A5F5","#1976D2","#0D47A1"],barrelGradientStops:[[0,"#0D47A1"],[.15,"#1565C0"],[.4,"#1976D2"],[.6,"#2196F3"],[.85,"#64B5F6"],[1,"#1565C0"]],barrelWidth:8,barrelLength:X*.7});break;case"turret4":sl(i,o,X,{baseGradientColors:["#E1BEE7","#BA68C8","#9C27B0","#7B1FA2","#4A148C"],rotatingBaseColors:["#F3E5F5","#E1BEE7","#CE93D8","#AB47BC","#8E24AA"],barrelGradientStops:[[0,"#4A148C"],[.1,"#6A1B99"],[.25,"#7B1FA2"],[.4,"#8E24AA"],[.6,"#AB47BC"],[.75,"#CE93D8"],[.9,"#E1BEE7"],[1,"#7B1FA2"]],barrelWidth:10,barrelLength:X*.75});break;case"laser0":el(i,X,{body:["#3A3A3A","#2A2A2A","#1A1A1A","#101010"],housing:"#64B5F6",innerHousing:"#1565C0",barrel:["#81D4FA","#0288D1","#81D4FA"],barrelDetail:"#B3E5FC",glow:["#4FC3F7","#0288D1","rgba(2, 136, 209, 0)"],muzzleGlow:["#FFFFFF","#4FC3F7","#0288D1","rgba(2, 136, 209, 0)"],muzzleCore:"#FFFFFF"});break;case"laser1":el(i,X,{body:["#555D66","#3C444D","#2B3036","#1E2227"],housing:"#90A4AE",innerHousing:"#546E7A",barrel:["#B0BEC5","#78909C","#B0BEC5"],barrelDetail:"#CFD8DC",glow:["#4FC3F7","#0288D1","rgba(2, 136, 209, 0)"],muzzleGlow:["#E1F5FE","#81D4FA","#0288D1","rgba(2, 136, 209, 0)"],muzzleCore:"#E0F7FA"});break;case"laser2":el(i,X,{body:["#355E3B","#254D32","#1B3C29","#122D21"],housing:"#AED581",innerHousing:"#7CB342",barrel:["#C5E1A5","#8BC34A","#C5E1A5"],barrelDetail:"#DCEDC8",glow:["#76FF03","#64DD17","rgba(100, 221, 23, 0)"],muzzleGlow:["#CCFF90","#AEEA00","#64DD17","rgba(174, 234, 0, 0)"],muzzleCore:"#F0F4C3"});break;case"laser3":el(i,X,{body:["#2E003E","#1D002A","#14001F","#0A0014"],housing:"#9575CD",innerHousing:"#673AB7",barrel:["#B39DDB","#7E57C2","#B39DDB"],barrelDetail:"#D1C4E9",glow:["#D500F9","#AA00FF","rgba(170, 0, 255, 0)"],muzzleGlow:["#E1BEE7","#BA68C8","#8E24AA","rgba(142, 36, 170, 0)"],muzzleCore:"#F3E5F5"});break;case"reactor0":case"reactor1":ep(i,X,{chassisStops:[[0,"#2C2C2C"],[.5,"#1E1E1E"],[1,"#0F0F0F"]],coreRingStops:[[0,"#4FC3F7"],[.4,"#0288D1"],[1,"#00000000"]],coreRingInnerRadius:4,coreGlowStops:[[0,"#81D4FA"],[.4,"#4FC3F7"],[1,"rgba(129, 212, 250, 0)"]],coreGlowRadius:6,boltColor:"#64B5F6"});break;case"reactor2":ep(i,X,{chassisStops:[[0,"#1C0D2B"],[.5,"#2A1850"],[1,"#100820"]],coreRingStops:[[0,"#BA68C8"],[.4,"#8E24AA"],[1,"#00000000"]],coreRingInnerRadius:5,coreGlowStops:[[0,"#CE93D8"],[.5,"#AB47BC"],[1,"rgba(171, 71, 188, 0)"]],coreGlowRadius:7,boltColor:"#D1C4E9"});break;case"battery0":case"battery1":tp(i,X,{chassisStops:[[0,"#263238"],[.5,"#37474F"],[1,"#102027"]],cellGlowStops:[[0,"#B2EBF2"],[.5,"#4DD0E1"],[1,"rgba(77, 208, 225, 0)"]],coreRadius:7,terminalColor:"#B0BEC5",terminalSize:3});break;case"battery2":tp(i,X,{chassisStops:[[0,"#311B92"],[.5,"#512DA8"],[1,"#1A237E"]],cellGlowStops:[[0,"#D1C4E9"],[.5,"#9575CD"],[1,"rgba(149, 117, 205, 0)"]],coreRadius:8,terminalColor:"#EDE7F6",terminalSize:3});break;case"shield0":case"shield1":iu(i,X,{chassisStops:[[0,"#1A1A2E"],[.5,"#16213E"],[1,"#0F3460"]],emitterGlowStops:[[0,"#BBDEFB"],[.5,"#42A5F5"],[1,"rgba(66, 165, 245, 0)"]],emitterRadius:10,ringColor:"#90CAF9",terminalColor:"#E3F2FD"});break;case"shield2":iu(i,X,{chassisStops:[[0,"#003322"],[.5,"#005533"],[1,"#00261A"]],emitterGlowStops:[[0,"#66FFCC"],[.5,"#00CC88"],[1,"rgba(0, 204, 136, 0)"]],emitterRadius:11,ringColor:"#00E6A8",terminalColor:"#CCFFEE"});break;case"shield3":iu(i,X,{chassisStops:[[0,"#4A0033"],[.5,"#800080"],[1,"#2E003E"]],emitterGlowStops:[[0,"#FFB3E6"],[.5,"#E040FB"],[1,"rgba(224, 64, 251, 0)"]],emitterRadius:12,ringColor:"#FF80AB",terminalColor:"#FFD6F9"});break;case"engine0":case"engine1":nl(i,X,{bodyStops:[[0,"#C0C0C0"],[.5,"#A0A0A0"],[1,"#808080"]],thrustColor:"#09f"});break;case"engine2":nl(i,X,{bodyStops:[[0,"#66FF66"],[.5,"#4CAF50"],[1,"#388E3C"]],thrustColor:"#0f0"});break;case"engine3":nl(i,X,{bodyStops:[[0,"#64B5F6"],[.5,"#2196F3"],[1,"#1976D2"]],thrustColor:"#00f"});break;case"engine4":nl(i,X,{bodyStops:[[0,"#B39DDB"],[.5,"#7B1FA2"],[1,"#4A148C"]],thrustColor:"#f0f"});break;case"fin0":case"fin1":al(i,X,[[0,"#E0E0E0"],[.3,"#B0B0B0"],[.7,"#808080"],[1,"#404040"]]);break;case"fin2":al(i,X,[[0,"#81C784"],[.2,"#66BB6A"],[.5,"#4CAF50"],[.8,"#2E7D32"],[1,"#1B5E20"]]);break;case"fin3":al(i,X,[[0,"#90CAF9"],[.15,"#64B5F6"],[.4,"#42A5F5"],[.7,"#1E88E5"],[.9,"#1565C0"],[1,"#0D47A1"]]);break;case"fin4":al(i,X,[[0,"#F3E5F5"],[.1,"#E1BEE7"],[.25,"#CE93D8"],[.45,"#BA68C8"],[.65,"#AB47BC"],[.8,"#8E24AA"],[.95,"#6A1B99"],[1,"#4A148C"]]);break;case"harvester0":case"harvester1":ip(i,X,{intakeColor:"#00ACC1",vortexColor:"#4DD0E1",ringColor:"rgba(0, 200, 255, 0.35)",casingStops:[[0,"#263238"],[.5,"#37474F"],[1,"#212121"]]});break;case"harvester2":ip(i,X,{intakeColor:"#00BFA5",vortexColor:"#1DE9B6",ringColor:"rgba(106, 0, 255, 0.4)",casingStops:[[0,"#004D40"],[.5,"#00695C"],[1,"#00251A"]]});break;case"explosiveLance0":case"explosiveLance1":ol(i,o,X,{baseGradientColors:["#2e2e2e","#3c3c3c","#121212"],barrelGradientStops:[[0,"#cccccc"],[.5,"#888888"],[1,"#444444"]]});break;case"explosiveLance2":ol(i,o,X,{baseGradientColors:["#1b3d2f","#2c704f","#09251a"],barrelGradientStops:[[0,"#a8e6cf"],[.5,"#56c596"],[1,"#228b22"]]});break;case"explosiveLance3":ol(i,o,X,{baseGradientColors:["#0d47a1","#1976d2","#0a1a3f"],barrelGradientStops:[[0,"#82b1ff"],[.5,"#448aff"],[1,"#2962ff"]]});break;case"explosiveLance4":ol(i,o,X,{baseGradientColors:["#4a148c","#7b1fa2","#12002e"],barrelGradientStops:[[0,"#e1bee7"],[.5,"#ba68c8"],[1,"#8e24aa"]]});break;case"haloBlade0":case"haloBlade1":rl(i,X,{ringColor:"#FFBF00",coreColor:"#FFEB3B",glowColor:"rgba(255, 191, 0, 0.4)",casingStops:[[0,"#3A3A3A"],[.5,"#2A2A2A"],[1,"#101010"]]});break;case"haloBlade2":rl(i,X,{ringColor:"#2CFF05",coreColor:"#B2FF59",glowColor:"rgba(44, 255, 5, 0.35)",casingStops:[[0,"#1B3C29"],[.5,"#254D32"],[1,"#122D21"]]});break;case"haloBlade3":rl(i,X,{ringColor:"#00FFFF",coreColor:"#80DEEA",glowColor:"rgba(0, 255, 255, 0.35)",casingStops:[[0,"#263238"],[.5,"#37474F"],[1,"#212121"]]});break;case"haloBlade4":rl(i,X,{ringColor:"#7F00FF",coreColor:"#D1C4E9",glowColor:"rgba(127, 0, 255, 0.4)",casingStops:[[0,"#2E003E"],[.5,"#1D002A"],[1,"#0A0014"]]});break}const l={base:e,overlay:a.startsWith("turret")||a.startsWith("explosiveLance")?n:void 0},h=nS(l);Fu.set(a,h)}function oS(){for(const a of Fo())aS(a.id)}function rS(a){let e=0;for(const i of Fo()){const n=Fu.get(i.id);if(!n){console.warn(`[GL2Cache] No raster sprite found for block: ${i.id}`);continue}try{const o={none:{base:It(a,n.none.base),overlay:n.none.overlay?It(a,n.none.overlay):void 0},light:{base:It(a,n.light.base),overlay:n.light.overlay?It(a,n.light.overlay):void 0},moderate:{base:It(a,n.moderate.base),overlay:n.moderate.overlay?It(a,n.moderate.overlay):void 0},heavy:{base:It(a,n.heavy.base),overlay:n.heavy.overlay?It(a,n.heavy.overlay):void 0}};yl.set(i.id,o),e++}catch(o){console.error(`[GL2Cache] Failed to convert block sprite to GL2 texture: ${i.id}`,o)}}console.log(`[GL2Cache] Total GL2 textures initialized: ${e}`)}function lS(a){for(const[e,i]of yl.entries())for(const n of Object.values(an)){const o=i[n];o.base&&a.isTexture(o.base)&&a.deleteTexture(o.base),o.overlay&&a.isTexture(o.overlay)&&a.deleteTexture(o.overlay)}yl.clear()}function cS(a,e){const i=Math.max(0,a/e);return i>.75?"none":i>.5?"light":i>.25?"moderate":"heavy"}function Ki(a,e="none"){const i=Fu.get(a);if(!i)throw new Error(`Block sprite not cached: ${a}`);return i[e]}function wm(a,e="none"){const i=yl.get(a);if(!i)throw new Error(`GL2 block sprite not cached: ${a}`);return i[e]}const _o=32,Am=new Map,bl=new Map;function hS(){return["currency","repair"]}function uS(){const a=document.createElement("canvas");a.width=_o,a.height=_o;const e=a.getContext("2d",{alpha:!0});return{canvas:a,ctx:e}}function fS(a){const{canvas:e,ctx:i}=uS(),n=_o/2;i.clearRect(0,0,_o,_o);const o=i.createRadialGradient(n,n,0,n,n,n);switch(a){case"currency":o.addColorStop(0,"#ffcc00"),o.addColorStop(.6,"#ffaa00"),o.addColorStop(1,"#cc6600");break;case"repair":o.addColorStop(0,"#ff6666"),o.addColorStop(.7,"#cc2222"),o.addColorStop(1,"#880000");break;default:console.warn(`[PickupSpriteCache] Unknown pickup type: ${a}`);break}i.fillStyle=o,i.beginPath(),i.arc(n,n,n,0,Math.PI*2),i.fill(),Am.set(a,{canvas:e})}function dS(){for(const a of hS())fS(a)}function gS(a){let e=0;for(const[i,n]of Am.entries())try{const o=It(a,n.canvas);bl.set(i,{texture:o}),e++}catch(o){console.error(`[GLPickupSpriteCache] Failed to create texture for ${i}:`,o)}console.log(`[GLPickupSpriteCache] Initialized ${e} GL2 pickup textures.`)}function pS(a){for(const{texture:e}of bl.values())e&&a.isTexture(e)&&a.deleteTexture(e);bl.clear()}function mS(a){const e=bl.get(a);if(!e)throw new Error(`GL pickup sprite not cached: ${a}`);return e}const km={circleRock0:{id:"circleRock0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"circleRock0",category:"environment",subcategory:"asteroid",dropRate:0},rock0:{id:"rock0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"rock0",category:"environment",subcategory:"asteroid",dropRate:0},facetRock0:{id:"facetRock0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"facetRock0",category:"environment",subcategory:"asteroid",dropRate:0},facetRock1:{id:"facetRock1",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"facetRock1",category:"environment",subcategory:"asteroid",dropRate:0},facetRockSlim0:{id:"facetRockSlim0",name:"Basalt Chunk",armor:5,cost:0,mass:120,sprite:"facetRockSlim0",category:"environment",subcategory:"asteroid",dropRate:0}};function Rm(a){return km[a]}function Em(){return Object.values(km)}function yS(a){const e=X/2-2,i=X/2,n=X/2;a.save(),a.fillStyle="#444",a.beginPath(),a.moveTo(i,n-e+3),a.bezierCurveTo(i+12,n-e,i+e,n-10,i+e-2,n),a.bezierCurveTo(i+e,n+10,i+10,n+e-4,i,n+e),a.bezierCurveTo(i-10,n+e-6,i-e,n+10,i-e+2,n),a.bezierCurveTo(i-e,n-10,i-10,n-e,i,n-e+3),a.closePath(),a.fill(),a.fillStyle="rgba(255,255,255,0.05)";for(let o=0;o<10;o++){const l=Math.random()*X,h=Math.random()*X;a.beginPath(),a.arc(l,h,1+Math.random()*1.5,0,Math.PI*2),a.fill()}a.restore()}function vS(a){const e=X,i=X;a.save();const n=a.createRadialGradient(e*.3,i*.3,0,e*.5,i*.5,e*.8);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i),a.fillStyle="rgba(20, 20, 20, 0.3)";for(let h=0;h<5;h++){const u=Math.random()*e,d=Math.random()*i,g=8+Math.random()*12;a.beginPath();for(let m=0;m<8;m++){const y=m/8*Math.PI*2,v=g*(.7+Math.random()*.6),M=u+Math.cos(y)*v,b=d+Math.sin(y)*v;m===0?a.moveTo(M,b):a.lineTo(M,b)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.4)";for(let h=0;h<4;h++){const u=Math.random()*e,d=Math.random()*i,g=6+Math.random()*10;a.beginPath();for(let m=0;m<6;m++){const y=m/6*Math.PI*2,v=g*(.8+Math.random()*.4),M=u+Math.cos(y)*v,b=d+Math.sin(y)*v;m===0?a.moveTo(M,b):a.lineTo(M,b)}a.closePath(),a.fill()}const o=a.createLinearGradient(0,0,e*.3,i*.3);o.addColorStop(0,"rgba(255, 255, 255, 0.08)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=o,a.fillRect(0,0,e*.3,i*.3);const l=a.createLinearGradient(e*.7,i*.7,e,i);l.addColorStop(0,"rgba(0, 0, 0, 0)"),l.addColorStop(1,"rgba(0, 0, 0, 0.15)"),a.fillStyle=l,a.fillRect(e*.7,i*.7,e*.3,i*.3),a.fillStyle="rgba(255, 255, 255, 0.06)";for(let h=0;h<12;h++){const u=Math.random()*e,d=Math.random()*i,g=.5+Math.random()*1;a.beginPath(),a.arc(u,d,g,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.3)";for(let h=0;h<8;h++){const u=Math.random()*e,d=Math.random()*i,g=.3+Math.random()*.7;a.beginPath(),a.arc(u,d,g,0,Math.PI*2),a.fill()}a.restore()}function bS(a){const e=X,i=X;a.save(),a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.quadraticCurveTo(e*.55+(Math.random()-.5)*4,-2,0,i),a.closePath(),a.clip();const n=a.createRadialGradient(e*.4,i*.7,0,e*.5,i*.6,e*.9);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i);const o=a.createLinearGradient(e*.2,i*.2,e*.8,i*.8);o.addColorStop(0,"rgba(255, 255, 255, 0.12)"),o.addColorStop(.5,"rgba(255, 255, 255, 0.04)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=o,a.fillRect(0,0,e,i);const l=a.createLinearGradient(0,i*.8,0,i);l.addColorStop(0,"rgba(0, 0, 0, 0)"),l.addColorStop(1,"rgba(0, 0, 0, 0.2)"),a.fillStyle=l,a.fillRect(0,i*.8,e,i*.2),a.fillStyle="rgba(20, 20, 20, 0.25)";for(let h=0;h<4;h++){const u=Math.random()*e,d=i*.3+Math.random()*i*.6,g=6+Math.random()*8;a.beginPath();for(let m=0;m<6;m++){const y=m/6*Math.PI*2,v=g*(.7+Math.random()*.6),M=u+Math.cos(y)*v,b=d+Math.sin(y)*v;m===0?a.moveTo(M,b):a.lineTo(M,b)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.3)";for(let h=0;h<3;h++){const u=Math.random()*e,d=i*.4+Math.random()*i*.5,g=4+Math.random()*6;a.beginPath();for(let m=0;m<5;m++){const y=m/5*Math.PI*2,v=g*(.8+Math.random()*.4),M=u+Math.cos(y)*v,b=d+Math.sin(y)*v;m===0?a.moveTo(M,b):a.lineTo(M,b)}a.closePath(),a.fill()}a.fillStyle="rgba(255, 255, 255, 0.06)";for(let h=0;h<8;h++){const u=Math.random()*e,d=i*.2+Math.random()*i*.7,g=.5+Math.random()*1;a.beginPath(),a.arc(u,d,g,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.25)";for(let h=0;h<6;h++){const u=Math.random()*e,d=i*.3+Math.random()*i*.6,g=.3+Math.random()*.7;a.beginPath(),a.arc(u,d,g,0,Math.PI*2),a.fill()}a.restore(),a.strokeStyle="rgba(0, 0, 0, 0.1)",a.lineWidth=.5,a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.stroke(),a.restore()}function SS(a){const e=X,i=X;a.save(),a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.bezierCurveTo(e*.8,i*.3,e*.2,i*.1,0,i),a.closePath(),a.clip();const n=a.createRadialGradient(e*.3,i*.8,0,e*.5,i*.6,e*.9);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i);const o=a.createLinearGradient(e*.1,i*.1,e*.9,i*.6);o.addColorStop(0,"rgba(255, 255, 255, 0.15)"),o.addColorStop(.3,"rgba(255, 255, 255, 0.08)"),o.addColorStop(.7,"rgba(255, 255, 255, 0.02)"),o.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=o,a.fillRect(0,0,e,i);const l=a.createRadialGradient(e*.7,i*.2,0,e*.7,i*.2,e*.3);l.addColorStop(0,"rgba(255, 255, 255, 0.1)"),l.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=l,a.fillRect(e*.4,0,e*.6,i*.4);const h=a.createLinearGradient(0,i*.85,0,i);h.addColorStop(0,"rgba(0, 0, 0, 0)"),h.addColorStop(1,"rgba(0, 0, 0, 0.18)"),a.fillStyle=h,a.fillRect(0,i*.85,e,i*.15),a.fillStyle="rgba(20, 20, 20, 0.28)";for(let u=0;u<5;u++){const d=Math.random()*e,g=i*.25+Math.random()*i*.7,m=5+Math.random()*9;a.beginPath();for(let y=0;y<7;y++){const v=y/7*Math.PI*2,M=m*(.6+Math.random()*.8),b=d+Math.cos(v)*M,C=g+Math.sin(v)*M;y===0?a.moveTo(b,C):a.lineTo(b,C)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.35)";for(let u=0;u<4;u++){const d=Math.random()*e,g=i*.3+Math.random()*i*.6,m=3+Math.random()*7;a.beginPath();for(let y=0;y<6;y++){const v=y/6*Math.PI*2,M=m*(.7+Math.random()*.5),b=d+Math.cos(v)*M,C=g+Math.sin(v)*M;y===0?a.moveTo(b,C):a.lineTo(b,C)}a.closePath(),a.fill()}a.fillStyle="rgba(255, 255, 255, 0.065)";for(let u=0;u<10;u++){const d=Math.random()*e,g=i*.15+Math.random()*i*.8,m=.4+Math.random()*1.2;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.28)";for(let u=0;u<7;u++){const d=Math.random()*e,g=i*.2+Math.random()*i*.7,m=.2+Math.random()*.8;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(45, 45, 45, 0.4)";for(let u=0;u<3;u++){const d=Math.random()*e,g=i*.4+Math.random()*i*.5,m=2+Math.random()*3;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.restore(),a.strokeStyle="rgba(0, 0, 0, 0.08)",a.lineWidth=.5,a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.stroke(),a.restore()}function MS(a){const e=X,i=X;a.save(),a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.arc(e/2,i,e/2,0,Math.PI,!0),a.closePath(),a.clip();const n=a.createRadialGradient(e*.5,i*.9,0,e*.5,i*.7,e*.7);n.addColorStop(0,"#4a4a4a"),n.addColorStop(.6,"#383838"),n.addColorStop(1,"#2a2a2a"),a.fillStyle=n,a.fillRect(0,0,e,i);const o=a.createLinearGradient(0,i*.3,e,i*.7);o.addColorStop(0,"rgba(255, 255, 255, 0.1)"),o.addColorStop(.5,"rgba(255, 255, 255, 0.05)"),o.addColorStop(1,"rgba(255, 255, 255, 0.1)"),a.fillStyle=o,a.fillRect(0,0,e,i);const l=a.createRadialGradient(e*.5,i*.5,0,e*.5,i*.5,e*.4);l.addColorStop(0,"rgba(255, 255, 255, 0.08)"),l.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=l,a.fillRect(e*.2,i*.2,e*.6,i*.6);const h=a.createLinearGradient(0,i*.9,0,i);h.addColorStop(0,"rgba(0, 0, 0, 0)"),h.addColorStop(1,"rgba(0, 0, 0, 0.15)"),a.fillStyle=h,a.fillRect(0,i*.9,e,i*.1),a.fillStyle="rgba(20, 20, 20, 0.25)";for(let u=0;u<3;u++){const d=e*.2+Math.random()*e*.6,g=i*.4+Math.random()*i*.5,m=3+Math.random()*5;a.beginPath();for(let y=0;y<5;y++){const v=y/5*Math.PI*2,M=m*(.7+Math.random()*.6),b=d+Math.cos(v)*M,C=g+Math.sin(v)*M;y===0?a.moveTo(b,C):a.lineTo(b,C)}a.closePath(),a.fill()}a.fillStyle="rgba(70, 70, 70, 0.3)";for(let u=0;u<2;u++){const d=e*.3+Math.random()*e*.4,g=i*.5+Math.random()*i*.4,m=2+Math.random()*4;a.beginPath();for(let y=0;y<4;y++){const v=y/4*Math.PI*2,M=m*(.8+Math.random()*.4),b=d+Math.cos(v)*M,C=g+Math.sin(v)*M;y===0?a.moveTo(b,C):a.lineTo(b,C)}a.closePath(),a.fill()}a.fillStyle="rgba(255, 255, 255, 0.06)";for(let u=0;u<6;u++){const d=e*.1+Math.random()*e*.8,g=i*.3+Math.random()*i*.6,m=.3+Math.random()*.8;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(0, 0, 0, 0.25)";for(let u=0;u<4;u++){const d=e*.2+Math.random()*e*.6,g=i*.4+Math.random()*i*.5,m=.2+Math.random()*.5;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.fillStyle="rgba(45, 45, 45, 0.35)";for(let u=0;u<2;u++){const d=e*.3+Math.random()*e*.4,g=i*.5+Math.random()*i*.4,m=1+Math.random()*2;a.beginPath(),a.arc(d,g,m,0,Math.PI*2),a.fill()}a.restore(),a.strokeStyle="rgba(0, 0, 0, 0.06)",a.lineWidth=.3,a.beginPath(),a.moveTo(0,i),a.lineTo(e,i),a.stroke(),a.restore()}var Do=(a=>(a.NONE="none",a.FRACTURED="fractured",a.CRUMBLING="crumbling",a))(Do||{});const Bm=new Map,Sl=new Map;function wu(){const a=document.createElement("canvas");return a.width=X,a.height=X,a}function np(a,e){if(e==="none")return a;const i=wu(),n=i.getContext("2d"),o=wu(),l=o.getContext("2d"),h={fractured:{opacity:.8,tint:"rgba(100, 100, 100, 0.15)",cracks:!0,cracksColor:"rgba(80, 80, 80, 0.7)",lineWidth:1},crumbling:{opacity:.6,tint:"rgba(150, 75, 0, 0.3)",cracks:!0,cracksColor:"rgba(60, 30, 0, 0.85)",lineWidth:2}}[e];return n.globalAlpha=h.opacity,n.drawImage(a,0,0),n.globalAlpha=1,l.clearRect(0,0,X,X),l.fillStyle=h.tint,l.fillRect(0,0,X,X),l.globalCompositeOperation="destination-in",l.drawImage(a,0,0),l.globalCompositeOperation="source-over",n.drawImage(o,0,0),h.cracks&&(l.clearRect(0,0,X,X),l.strokeStyle=h.cracksColor,l.lineWidth=h.lineWidth,l.beginPath(),l.moveTo(4,4),l.lineTo(28,28),l.moveTo(10,22),l.lineTo(22,10),l.moveTo(0,16),l.lineTo(32,16),l.stroke(),l.globalCompositeOperation="destination-in",l.drawImage(a,0,0),l.globalCompositeOperation="source-over",n.drawImage(o,0,0)),i}function CS(a){return{none:a,fractured:{base:np(a.base,"fractured")},crumbling:{base:np(a.base,"crumbling")}}}function TS(a){const e=wu(),i=e.getContext("2d");switch(a){case"circleRock0":yS(i);break;case"rock0":vS(i);break;case"facetRock0":bS(i);break;case"facetRock1":SS(i);break;case"facetRockSlim0":MS(i);break;default:throw new Error(`Unknown asteroid block type: ${a}`)}const o=CS({base:e});Bm.set(a,o)}function wS(){for(const a of Em())TS(a.id)}function AS(a){let e=0;for(const i of Em()){const n=Bm.get(i.id);if(!n){console.warn(`[GL2Cache] No raster asteroid sprite for: ${i.id}`);continue}try{const o={none:{base:It(a,n.none.base)},fractured:{base:It(a,n.fractured.base)},crumbling:{base:It(a,n.crumbling.base)}};Sl.set(i.id,o),e++}catch(o){console.error(`[GL2Cache] Failed to create GL2 asteroid sprite: ${i.id}`,o)}}console.log(`[GL2Cache] Total GL2 asteroid textures initialized: ${e}`)}function kS(a){for(const e of Sl.values())for(const i of Object.values(Do)){const n=e[i];n.base&&a.isTexture(n.base)&&a.deleteTexture(n.base)}Sl.clear()}function RS(a,e="none"){const i=Sl.get(a);if(!i)throw new Error(`GL2 asteroid sprite not cached: ${a}`);return i[e]}function cl(a,e,i,n,o){a.save(),a.clearRect(0,0,a.canvas.width,a.canvas.height);const l=n*.35,h=n-l,u=a.createRadialGradient(e,i,h,e,i,n*1.5);u.addColorStop(0,hl(o,.3)),u.addColorStop(.7,hl(o,.1)),u.addColorStop(1,hl(o,0)),a.beginPath(),a.fillStyle=u,a.arc(e,i,n*1.5,0,Math.PI*2),a.fill(),a.beginPath(),a.arc(e,i,n,0,Math.PI*2),a.fillStyle=o,a.fill(),a.globalCompositeOperation="destination-out",a.beginPath(),a.arc(e,i,h,0,Math.PI*2),a.fill(),a.globalCompositeOperation="source-over",a.beginPath(),a.arc(e,i,n-l*.5,0,Math.PI*2),a.strokeStyle=hl("#FFFFFF",.2),a.lineWidth=1.5,a.stroke(),a.restore()}function hl(a,e){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);if(!i)return a;const n=parseInt(i[1],16),o=parseInt(i[2],16),l=parseInt(i[3],16);return`rgba(${n},${o},${l},${e})`}const Au=128,Im=new Map,Ml=new Map;function ES(){return["energyRing0","energyRing1","energyRing2","energyRing3","energyRing4"]}function BS(){const a=document.createElement("canvas");a.width=Au,a.height=Au;const e=a.getContext("2d",{alpha:!0});return{canvas:a,ctx:e}}function IS(a){const{canvas:e,ctx:i}=BS(),n=Au/2;switch(i.clearRect(0,0,e.width,e.height),a){case"energyRing0":case"energyRing1":cl(i,n,n,64,"#FFBF00");break;case"energyRing2":cl(i,n,n,64,"#2CFF05");break;case"energyRing3":cl(i,n,n,64,"#00FFFF");break;case"energyRing4":cl(i,n,n,64,"#7F00FF");break;default:console.warn(`[ProjectileSpriteCache] Unknown projectile type: ${a}`);break}Im.set(a,{canvas:e})}function xS(){for(const a of ES())IS(a)}function _S(a){let e=0;for(const[i,n]of Im.entries())try{const o=It(a,n.canvas);Ml.set(i,{texture:o}),e++}catch(o){console.error(`[GLProjectileSpriteCache] Failed to create texture for ${i}:`,o)}console.log(`[GLProjectileSpriteCache] Initialized ${e} GL2 projectile textures.`)}function DS(a){for(const{texture:e}of Ml.values())e&&a.isTexture(e)&&a.deleteTexture(e);Ml.clear()}function wo(a){const e=Ml.get(a);if(!e)throw new Error(`GL projectile sprite not cached: ${a}`);return e}var su={exports:{}},Ao={},nu={exports:{}},au={};/**
 * @license React
 * scheduler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ap;function PS(){return ap||(ap=1,function(a){function e(_,z){var se=_.length;_.push(z);e:for(;0<se;){var oe=se-1>>>1,k=_[oe];if(0<o(k,z))_[oe]=z,_[se]=k,se=oe;else break e}}function i(_){return _.length===0?null:_[0]}function n(_){if(_.length===0)return null;var z=_[0],se=_.pop();if(se!==z){_[0]=se;e:for(var oe=0,k=_.length,G=k>>>1;oe<G;){var te=2*(oe+1)-1,ie=_[te],re=te+1,ve=_[re];if(0>o(ie,se))re<k&&0>o(ve,ie)?(_[oe]=ve,_[re]=se,oe=re):(_[oe]=ie,_[te]=se,oe=te);else if(re<k&&0>o(ve,se))_[oe]=ve,_[re]=se,oe=re;else break e}}return z}function o(_,z){var se=_.sortIndex-z.sortIndex;return se!==0?se:_.id-z.id}if(a.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var l=performance;a.unstable_now=function(){return l.now()}}else{var h=Date,u=h.now();a.unstable_now=function(){return h.now()-u}}var d=[],g=[],m=1,y=null,v=3,M=!1,b=!1,C=!1,w=!1,A=typeof setTimeout=="function"?setTimeout:null,E=typeof clearTimeout=="function"?clearTimeout:null,x=typeof setImmediate<"u"?setImmediate:null;function I(_){for(var z=i(g);z!==null;){if(z.callback===null)n(g);else if(z.startTime<=_)n(g),z.sortIndex=z.expirationTime,e(d,z);else break;z=i(g)}}function D(_){if(C=!1,I(_),!b)if(i(d)!==null)b=!0,N||(N=!0,Y());else{var z=i(g);z!==null&&ee(D,z.startTime-_)}}var N=!1,H=-1,W=5,K=-1;function Z(){return w?!0:!(a.unstable_now()-K<W)}function Q(){if(w=!1,N){var _=a.unstable_now();K=_;var z=!0;try{e:{b=!1,C&&(C=!1,E(H),H=-1),M=!0;var se=v;try{t:{for(I(_),y=i(d);y!==null&&!(y.expirationTime>_&&Z());){var oe=y.callback;if(typeof oe=="function"){y.callback=null,v=y.priorityLevel;var k=oe(y.expirationTime<=_);if(_=a.unstable_now(),typeof k=="function"){y.callback=k,I(_),z=!0;break t}y===i(d)&&n(d),I(_)}else n(d);y=i(d)}if(y!==null)z=!0;else{var G=i(g);G!==null&&ee(D,G.startTime-_),z=!1}}break e}finally{y=null,v=se,M=!1}z=void 0}}finally{z?Y():N=!1}}}var Y;if(typeof x=="function")Y=function(){x(Q)};else if(typeof MessageChannel<"u"){var ne=new MessageChannel,J=ne.port2;ne.port1.onmessage=Q,Y=function(){J.postMessage(null)}}else Y=function(){A(Q,0)};function ee(_,z){H=A(function(){_(a.unstable_now())},z)}a.unstable_IdlePriority=5,a.unstable_ImmediatePriority=1,a.unstable_LowPriority=4,a.unstable_NormalPriority=3,a.unstable_Profiling=null,a.unstable_UserBlockingPriority=2,a.unstable_cancelCallback=function(_){_.callback=null},a.unstable_forceFrameRate=function(_){0>_||125<_?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):W=0<_?Math.floor(1e3/_):5},a.unstable_getCurrentPriorityLevel=function(){return v},a.unstable_next=function(_){switch(v){case 1:case 2:case 3:var z=3;break;default:z=v}var se=v;v=z;try{return _()}finally{v=se}},a.unstable_requestPaint=function(){w=!0},a.unstable_runWithPriority=function(_,z){switch(_){case 1:case 2:case 3:case 4:case 5:break;default:_=3}var se=v;v=_;try{return z()}finally{v=se}},a.unstable_scheduleCallback=function(_,z,se){var oe=a.unstable_now();switch(typeof se=="object"&&se!==null?(se=se.delay,se=typeof se=="number"&&0<se?oe+se:oe):se=oe,_){case 1:var k=-1;break;case 2:k=250;break;case 5:k=1073741823;break;case 4:k=1e4;break;default:k=5e3}return k=se+k,_={id:m++,callback:z,priorityLevel:_,startTime:se,expirationTime:k,sortIndex:-1},se>oe?(_.sortIndex=se,e(g,_),i(d)===null&&_===i(g)&&(C?(E(H),H=-1):C=!0,ee(D,se-oe))):(_.sortIndex=k,e(d,_),b||M||(b=!0,N||(N=!0,Y()))),_},a.unstable_shouldYield=Z,a.unstable_wrapCallback=function(_){var z=v;return function(){var se=v;v=z;try{return _.apply(this,arguments)}finally{v=se}}}}(au)),au}var op;function LS(){return op||(op=1,nu.exports=PS()),nu.exports}var ou={exports:{}},ye={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var rp;function OS(){if(rp)return ye;rp=1;var a=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),n=Symbol.for("react.strict_mode"),o=Symbol.for("react.profiler"),l=Symbol.for("react.consumer"),h=Symbol.for("react.context"),u=Symbol.for("react.forward_ref"),d=Symbol.for("react.suspense"),g=Symbol.for("react.memo"),m=Symbol.for("react.lazy"),y=Symbol.iterator;function v(k){return k===null||typeof k!="object"?null:(k=y&&k[y]||k["@@iterator"],typeof k=="function"?k:null)}var M={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},b=Object.assign,C={};function w(k,G,te){this.props=k,this.context=G,this.refs=C,this.updater=te||M}w.prototype.isReactComponent={},w.prototype.setState=function(k,G){if(typeof k!="object"&&typeof k!="function"&&k!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,k,G,"setState")},w.prototype.forceUpdate=function(k){this.updater.enqueueForceUpdate(this,k,"forceUpdate")};function A(){}A.prototype=w.prototype;function E(k,G,te){this.props=k,this.context=G,this.refs=C,this.updater=te||M}var x=E.prototype=new A;x.constructor=E,b(x,w.prototype),x.isPureReactComponent=!0;var I=Array.isArray,D={H:null,A:null,T:null,S:null,V:null},N=Object.prototype.hasOwnProperty;function H(k,G,te,ie,re,ve){return te=ve.ref,{$$typeof:a,type:k,key:G,ref:te!==void 0?te:null,props:ve}}function W(k,G){return H(k.type,G,void 0,void 0,void 0,k.props)}function K(k){return typeof k=="object"&&k!==null&&k.$$typeof===a}function Z(k){var G={"=":"=0",":":"=2"};return"$"+k.replace(/[=:]/g,function(te){return G[te]})}var Q=/\/+/g;function Y(k,G){return typeof k=="object"&&k!==null&&k.key!=null?Z(""+k.key):G.toString(36)}function ne(){}function J(k){switch(k.status){case"fulfilled":return k.value;case"rejected":throw k.reason;default:switch(typeof k.status=="string"?k.then(ne,ne):(k.status="pending",k.then(function(G){k.status==="pending"&&(k.status="fulfilled",k.value=G)},function(G){k.status==="pending"&&(k.status="rejected",k.reason=G)})),k.status){case"fulfilled":return k.value;case"rejected":throw k.reason}}throw k}function ee(k,G,te,ie,re){var ve=typeof k;(ve==="undefined"||ve==="boolean")&&(k=null);var ue=!1;if(k===null)ue=!0;else switch(ve){case"bigint":case"string":case"number":ue=!0;break;case"object":switch(k.$$typeof){case a:case e:ue=!0;break;case m:return ue=k._init,ee(ue(k._payload),G,te,ie,re)}}if(ue)return re=re(k),ue=ie===""?"."+Y(k,0):ie,I(re)?(te="",ue!=null&&(te=ue.replace(Q,"$&/")+"/"),ee(re,G,te,"",function(_t){return _t})):re!=null&&(K(re)&&(re=W(re,te+(re.key==null||k&&k.key===re.key?"":(""+re.key).replace(Q,"$&/")+"/")+ue)),G.push(re)),1;ue=0;var ft=ie===""?".":ie+":";if(I(k))for(var Oe=0;Oe<k.length;Oe++)ie=k[Oe],ve=ft+Y(ie,Oe),ue+=ee(ie,G,te,ve,re);else if(Oe=v(k),typeof Oe=="function")for(k=Oe.call(k),Oe=0;!(ie=k.next()).done;)ie=ie.value,ve=ft+Y(ie,Oe++),ue+=ee(ie,G,te,ve,re);else if(ve==="object"){if(typeof k.then=="function")return ee(J(k),G,te,ie,re);throw G=String(k),Error("Objects are not valid as a React child (found: "+(G==="[object Object]"?"object with keys {"+Object.keys(k).join(", ")+"}":G)+"). If you meant to render a collection of children, use an array instead.")}return ue}function _(k,G,te){if(k==null)return k;var ie=[],re=0;return ee(k,ie,"","",function(ve){return G.call(te,ve,re++)}),ie}function z(k){if(k._status===-1){var G=k._result;G=G(),G.then(function(te){(k._status===0||k._status===-1)&&(k._status=1,k._result=te)},function(te){(k._status===0||k._status===-1)&&(k._status=2,k._result=te)}),k._status===-1&&(k._status=0,k._result=G)}if(k._status===1)return k._result.default;throw k._result}var se=typeof reportError=="function"?reportError:function(k){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var G=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof k=="object"&&k!==null&&typeof k.message=="string"?String(k.message):String(k),error:k});if(!window.dispatchEvent(G))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",k);return}console.error(k)};function oe(){}return ye.Children={map:_,forEach:function(k,G,te){_(k,function(){G.apply(this,arguments)},te)},count:function(k){var G=0;return _(k,function(){G++}),G},toArray:function(k){return _(k,function(G){return G})||[]},only:function(k){if(!K(k))throw Error("React.Children.only expected to receive a single React element child.");return k}},ye.Component=w,ye.Fragment=i,ye.Profiler=o,ye.PureComponent=E,ye.StrictMode=n,ye.Suspense=d,ye.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=D,ye.__COMPILER_RUNTIME={__proto__:null,c:function(k){return D.H.useMemoCache(k)}},ye.cache=function(k){return function(){return k.apply(null,arguments)}},ye.cloneElement=function(k,G,te){if(k==null)throw Error("The argument must be a React element, but you passed "+k+".");var ie=b({},k.props),re=k.key,ve=void 0;if(G!=null)for(ue in G.ref!==void 0&&(ve=void 0),G.key!==void 0&&(re=""+G.key),G)!N.call(G,ue)||ue==="key"||ue==="__self"||ue==="__source"||ue==="ref"&&G.ref===void 0||(ie[ue]=G[ue]);var ue=arguments.length-2;if(ue===1)ie.children=te;else if(1<ue){for(var ft=Array(ue),Oe=0;Oe<ue;Oe++)ft[Oe]=arguments[Oe+2];ie.children=ft}return H(k.type,re,void 0,void 0,ve,ie)},ye.createContext=function(k){return k={$$typeof:h,_currentValue:k,_currentValue2:k,_threadCount:0,Provider:null,Consumer:null},k.Provider=k,k.Consumer={$$typeof:l,_context:k},k},ye.createElement=function(k,G,te){var ie,re={},ve=null;if(G!=null)for(ie in G.key!==void 0&&(ve=""+G.key),G)N.call(G,ie)&&ie!=="key"&&ie!=="__self"&&ie!=="__source"&&(re[ie]=G[ie]);var ue=arguments.length-2;if(ue===1)re.children=te;else if(1<ue){for(var ft=Array(ue),Oe=0;Oe<ue;Oe++)ft[Oe]=arguments[Oe+2];re.children=ft}if(k&&k.defaultProps)for(ie in ue=k.defaultProps,ue)re[ie]===void 0&&(re[ie]=ue[ie]);return H(k,ve,void 0,void 0,null,re)},ye.createRef=function(){return{current:null}},ye.forwardRef=function(k){return{$$typeof:u,render:k}},ye.isValidElement=K,ye.lazy=function(k){return{$$typeof:m,_payload:{_status:-1,_result:k},_init:z}},ye.memo=function(k,G){return{$$typeof:g,type:k,compare:G===void 0?null:G}},ye.startTransition=function(k){var G=D.T,te={};D.T=te;try{var ie=k(),re=D.S;re!==null&&re(te,ie),typeof ie=="object"&&ie!==null&&typeof ie.then=="function"&&ie.then(oe,se)}catch(ve){se(ve)}finally{D.T=G}},ye.unstable_useCacheRefresh=function(){return D.H.useCacheRefresh()},ye.use=function(k){return D.H.use(k)},ye.useActionState=function(k,G,te){return D.H.useActionState(k,G,te)},ye.useCallback=function(k,G){return D.H.useCallback(k,G)},ye.useContext=function(k){return D.H.useContext(k)},ye.useDebugValue=function(){},ye.useDeferredValue=function(k,G){return D.H.useDeferredValue(k,G)},ye.useEffect=function(k,G,te){var ie=D.H;if(typeof te=="function")throw Error("useEffect CRUD overload is not enabled in this build of React.");return ie.useEffect(k,G)},ye.useId=function(){return D.H.useId()},ye.useImperativeHandle=function(k,G,te){return D.H.useImperativeHandle(k,G,te)},ye.useInsertionEffect=function(k,G){return D.H.useInsertionEffect(k,G)},ye.useLayoutEffect=function(k,G){return D.H.useLayoutEffect(k,G)},ye.useMemo=function(k,G){return D.H.useMemo(k,G)},ye.useOptimistic=function(k,G){return D.H.useOptimistic(k,G)},ye.useReducer=function(k,G,te){return D.H.useReducer(k,G,te)},ye.useRef=function(k){return D.H.useRef(k)},ye.useState=function(k){return D.H.useState(k)},ye.useSyncExternalStore=function(k,G,te){return D.H.useSyncExternalStore(k,G,te)},ye.useTransition=function(){return D.H.useTransition()},ye.version="19.1.0",ye}var lp;function Uu(){return lp||(lp=1,ou.exports=OS()),ou.exports}var ru={exports:{}},pt={};/**
 * @license React
 * react-dom.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var cp;function FS(){if(cp)return pt;cp=1;var a=Uu();function e(d){var g="https://react.dev/errors/"+d;if(1<arguments.length){g+="?args[]="+encodeURIComponent(arguments[1]);for(var m=2;m<arguments.length;m++)g+="&args[]="+encodeURIComponent(arguments[m])}return"Minified React error #"+d+"; visit "+g+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function i(){}var n={d:{f:i,r:function(){throw Error(e(522))},D:i,C:i,L:i,m:i,X:i,S:i,M:i},p:0,findDOMNode:null},o=Symbol.for("react.portal");function l(d,g,m){var y=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:o,key:y==null?null:""+y,children:d,containerInfo:g,implementation:m}}var h=a.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function u(d,g){if(d==="font")return"";if(typeof g=="string")return g==="use-credentials"?g:""}return pt.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=n,pt.createPortal=function(d,g){var m=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!g||g.nodeType!==1&&g.nodeType!==9&&g.nodeType!==11)throw Error(e(299));return l(d,g,null,m)},pt.flushSync=function(d){var g=h.T,m=n.p;try{if(h.T=null,n.p=2,d)return d()}finally{h.T=g,n.p=m,n.d.f()}},pt.preconnect=function(d,g){typeof d=="string"&&(g?(g=g.crossOrigin,g=typeof g=="string"?g==="use-credentials"?g:"":void 0):g=null,n.d.C(d,g))},pt.prefetchDNS=function(d){typeof d=="string"&&n.d.D(d)},pt.preinit=function(d,g){if(typeof d=="string"&&g&&typeof g.as=="string"){var m=g.as,y=u(m,g.crossOrigin),v=typeof g.integrity=="string"?g.integrity:void 0,M=typeof g.fetchPriority=="string"?g.fetchPriority:void 0;m==="style"?n.d.S(d,typeof g.precedence=="string"?g.precedence:void 0,{crossOrigin:y,integrity:v,fetchPriority:M}):m==="script"&&n.d.X(d,{crossOrigin:y,integrity:v,fetchPriority:M,nonce:typeof g.nonce=="string"?g.nonce:void 0})}},pt.preinitModule=function(d,g){if(typeof d=="string")if(typeof g=="object"&&g!==null){if(g.as==null||g.as==="script"){var m=u(g.as,g.crossOrigin);n.d.M(d,{crossOrigin:m,integrity:typeof g.integrity=="string"?g.integrity:void 0,nonce:typeof g.nonce=="string"?g.nonce:void 0})}}else g==null&&n.d.M(d)},pt.preload=function(d,g){if(typeof d=="string"&&typeof g=="object"&&g!==null&&typeof g.as=="string"){var m=g.as,y=u(m,g.crossOrigin);n.d.L(d,m,{crossOrigin:y,integrity:typeof g.integrity=="string"?g.integrity:void 0,nonce:typeof g.nonce=="string"?g.nonce:void 0,type:typeof g.type=="string"?g.type:void 0,fetchPriority:typeof g.fetchPriority=="string"?g.fetchPriority:void 0,referrerPolicy:typeof g.referrerPolicy=="string"?g.referrerPolicy:void 0,imageSrcSet:typeof g.imageSrcSet=="string"?g.imageSrcSet:void 0,imageSizes:typeof g.imageSizes=="string"?g.imageSizes:void 0,media:typeof g.media=="string"?g.media:void 0})}},pt.preloadModule=function(d,g){if(typeof d=="string")if(g){var m=u(g.as,g.crossOrigin);n.d.m(d,{as:typeof g.as=="string"&&g.as!=="script"?g.as:void 0,crossOrigin:m,integrity:typeof g.integrity=="string"?g.integrity:void 0})}else n.d.m(d)},pt.requestFormReset=function(d){n.d.r(d)},pt.unstable_batchedUpdates=function(d,g){return d(g)},pt.useFormState=function(d,g,m){return h.H.useFormState(d,g,m)},pt.useFormStatus=function(){return h.H.useHostTransitionStatus()},pt.version="19.1.0",pt}var hp;function US(){if(hp)return ru.exports;hp=1;function a(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(a)}catch(e){console.error(e)}}return a(),ru.exports=FS(),ru.exports}/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var up;function NS(){if(up)return Ao;up=1;var a=LS(),e=Uu(),i=US();function n(t){var s="https://react.dev/errors/"+t;if(1<arguments.length){s+="?args[]="+encodeURIComponent(arguments[1]);for(var r=2;r<arguments.length;r++)s+="&args[]="+encodeURIComponent(arguments[r])}return"Minified React error #"+t+"; visit "+s+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function o(t){return!(!t||t.nodeType!==1&&t.nodeType!==9&&t.nodeType!==11)}function l(t){var s=t,r=t;if(t.alternate)for(;s.return;)s=s.return;else{t=s;do s=t,(s.flags&4098)!==0&&(r=s.return),t=s.return;while(t)}return s.tag===3?r:null}function h(t){if(t.tag===13){var s=t.memoizedState;if(s===null&&(t=t.alternate,t!==null&&(s=t.memoizedState)),s!==null)return s.dehydrated}return null}function u(t){if(l(t)!==t)throw Error(n(188))}function d(t){var s=t.alternate;if(!s){if(s=l(t),s===null)throw Error(n(188));return s!==t?null:t}for(var r=t,c=s;;){var f=r.return;if(f===null)break;var p=f.alternate;if(p===null){if(c=f.return,c!==null){r=c;continue}break}if(f.child===p.child){for(p=f.child;p;){if(p===r)return u(f),t;if(p===c)return u(f),s;p=p.sibling}throw Error(n(188))}if(r.return!==c.return)r=f,c=p;else{for(var S=!1,T=f.child;T;){if(T===r){S=!0,r=f,c=p;break}if(T===c){S=!0,c=f,r=p;break}T=T.sibling}if(!S){for(T=p.child;T;){if(T===r){S=!0,r=p,c=f;break}if(T===c){S=!0,c=p,r=f;break}T=T.sibling}if(!S)throw Error(n(189))}}if(r.alternate!==c)throw Error(n(190))}if(r.tag!==3)throw Error(n(188));return r.stateNode.current===r?t:s}function g(t){var s=t.tag;if(s===5||s===26||s===27||s===6)return t;for(t=t.child;t!==null;){if(s=g(t),s!==null)return s;t=t.sibling}return null}var m=Object.assign,y=Symbol.for("react.element"),v=Symbol.for("react.transitional.element"),M=Symbol.for("react.portal"),b=Symbol.for("react.fragment"),C=Symbol.for("react.strict_mode"),w=Symbol.for("react.profiler"),A=Symbol.for("react.provider"),E=Symbol.for("react.consumer"),x=Symbol.for("react.context"),I=Symbol.for("react.forward_ref"),D=Symbol.for("react.suspense"),N=Symbol.for("react.suspense_list"),H=Symbol.for("react.memo"),W=Symbol.for("react.lazy"),K=Symbol.for("react.activity"),Z=Symbol.for("react.memo_cache_sentinel"),Q=Symbol.iterator;function Y(t){return t===null||typeof t!="object"?null:(t=Q&&t[Q]||t["@@iterator"],typeof t=="function"?t:null)}var ne=Symbol.for("react.client.reference");function J(t){if(t==null)return null;if(typeof t=="function")return t.$$typeof===ne?null:t.displayName||t.name||null;if(typeof t=="string")return t;switch(t){case b:return"Fragment";case w:return"Profiler";case C:return"StrictMode";case D:return"Suspense";case N:return"SuspenseList";case K:return"Activity"}if(typeof t=="object")switch(t.$$typeof){case M:return"Portal";case x:return(t.displayName||"Context")+".Provider";case E:return(t._context.displayName||"Context")+".Consumer";case I:var s=t.render;return t=t.displayName,t||(t=s.displayName||s.name||"",t=t!==""?"ForwardRef("+t+")":"ForwardRef"),t;case H:return s=t.displayName||null,s!==null?s:J(t.type)||"Memo";case W:s=t._payload,t=t._init;try{return J(t(s))}catch{}}return null}var ee=Array.isArray,_=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,z=i.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,se={pending:!1,data:null,method:null,action:null},oe=[],k=-1;function G(t){return{current:t}}function te(t){0>k||(t.current=oe[k],oe[k]=null,k--)}function ie(t,s){k++,oe[k]=t.current,t.current=s}var re=G(null),ve=G(null),ue=G(null),ft=G(null);function Oe(t,s){switch(ie(ue,s),ie(ve,t),ie(re,null),s.nodeType){case 9:case 11:t=(t=s.documentElement)&&(t=t.namespaceURI)?Ag(t):0;break;default:if(t=s.tagName,s=s.namespaceURI)s=Ag(s),t=kg(s,t);else switch(t){case"svg":t=1;break;case"math":t=2;break;default:t=0}}te(re),ie(re,t)}function _t(){te(re),te(ve),te(ue)}function yn(t){t.memoizedState!==null&&ie(ft,t);var s=re.current,r=kg(s,t.type);s!==r&&(ie(ve,t),ie(re,r))}function vn(t){ve.current===t&&(te(re),te(ve)),ft.current===t&&(te(ft),vo._currentValue=se)}var Ta=Object.prototype.hasOwnProperty,wa=a.unstable_scheduleCallback,Ds=a.unstable_cancelCallback,My=a.unstable_shouldYield,Cy=a.unstable_requestPaint,fi=a.unstable_now,Ty=a.unstable_getCurrentPriorityLevel,af=a.unstable_ImmediatePriority,of=a.unstable_UserBlockingPriority,Ho=a.unstable_NormalPriority,wy=a.unstable_LowPriority,rf=a.unstable_IdlePriority,Ay=a.log,ky=a.unstable_setDisableYieldValue,Aa=null,Dt=null;function $i(t){if(typeof Ay=="function"&&ky(t),Dt&&typeof Dt.setStrictMode=="function")try{Dt.setStrictMode(Aa,t)}catch{}}var Pt=Math.clz32?Math.clz32:By,Ry=Math.log,Ey=Math.LN2;function By(t){return t>>>=0,t===0?32:31-(Ry(t)/Ey|0)|0}var Wo=256,Go=4194304;function Ps(t){var s=t&42;if(s!==0)return s;switch(t&-t){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t&4194048;case 4194304:case 8388608:case 16777216:case 33554432:return t&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return t}}function zo(t,s,r){var c=t.pendingLanes;if(c===0)return 0;var f=0,p=t.suspendedLanes,S=t.pingedLanes;t=t.warmLanes;var T=c&134217727;return T!==0?(c=T&~p,c!==0?f=Ps(c):(S&=T,S!==0?f=Ps(S):r||(r=T&~t,r!==0&&(f=Ps(r))))):(T=c&~p,T!==0?f=Ps(T):S!==0?f=Ps(S):r||(r=c&~t,r!==0&&(f=Ps(r)))),f===0?0:s!==0&&s!==f&&(s&p)===0&&(p=f&-f,r=s&-s,p>=r||p===32&&(r&4194048)!==0)?s:f}function ka(t,s){return(t.pendingLanes&~(t.suspendedLanes&~t.pingedLanes)&s)===0}function Iy(t,s){switch(t){case 1:case 2:case 4:case 8:case 64:return s+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return s+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function lf(){var t=Wo;return Wo<<=1,(Wo&4194048)===0&&(Wo=256),t}function cf(){var t=Go;return Go<<=1,(Go&62914560)===0&&(Go=4194304),t}function Xl(t){for(var s=[],r=0;31>r;r++)s.push(t);return s}function Ra(t,s){t.pendingLanes|=s,s!==268435456&&(t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0)}function xy(t,s,r,c,f,p){var S=t.pendingLanes;t.pendingLanes=r,t.suspendedLanes=0,t.pingedLanes=0,t.warmLanes=0,t.expiredLanes&=r,t.entangledLanes&=r,t.errorRecoveryDisabledLanes&=r,t.shellSuspendCounter=0;var T=t.entanglements,R=t.expirationTimes,O=t.hiddenUpdates;for(r=S&~r;0<r;){var V=31-Pt(r),j=1<<V;T[V]=0,R[V]=-1;var F=O[V];if(F!==null)for(O[V]=null,V=0;V<F.length;V++){var U=F[V];U!==null&&(U.lane&=-536870913)}r&=~j}c!==0&&hf(t,c,0),p!==0&&f===0&&t.tag!==0&&(t.suspendedLanes|=p&~(S&~s))}function hf(t,s,r){t.pendingLanes|=s,t.suspendedLanes&=~s;var c=31-Pt(s);t.entangledLanes|=s,t.entanglements[c]=t.entanglements[c]|1073741824|r&4194090}function uf(t,s){var r=t.entangledLanes|=s;for(t=t.entanglements;r;){var c=31-Pt(r),f=1<<c;f&s|t[c]&s&&(t[c]|=s),r&=~f}}function Vl(t){switch(t){case 2:t=1;break;case 8:t=4;break;case 32:t=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:t=128;break;case 268435456:t=134217728;break;default:t=0}return t}function Yl(t){return t&=-t,2<t?8<t?(t&134217727)!==0?32:268435456:8:2}function ff(){var t=z.p;return t!==0?t:(t=window.event,t===void 0?32:Vg(t.type))}function _y(t,s){var r=z.p;try{return z.p=t,s()}finally{z.p=r}}var Ji=Math.random().toString(36).slice(2),dt="__reactFiber$"+Ji,At="__reactProps$"+Ji,bn="__reactContainer$"+Ji,ql="__reactEvents$"+Ji,Dy="__reactListeners$"+Ji,Py="__reactHandles$"+Ji,df="__reactResources$"+Ji,Ea="__reactMarker$"+Ji;function jl(t){delete t[dt],delete t[At],delete t[ql],delete t[Dy],delete t[Py]}function Sn(t){var s=t[dt];if(s)return s;for(var r=t.parentNode;r;){if(s=r[bn]||r[dt]){if(r=s.alternate,s.child!==null||r!==null&&r.child!==null)for(t=Ig(t);t!==null;){if(r=t[dt])return r;t=Ig(t)}return s}t=r,r=t.parentNode}return null}function Mn(t){if(t=t[dt]||t[bn]){var s=t.tag;if(s===5||s===6||s===13||s===26||s===27||s===3)return t}return null}function Ba(t){var s=t.tag;if(s===5||s===26||s===27||s===6)return t.stateNode;throw Error(n(33))}function Cn(t){var s=t[df];return s||(s=t[df]={hoistableStyles:new Map,hoistableScripts:new Map}),s}function Je(t){t[Ea]=!0}var gf=new Set,pf={};function Ls(t,s){Tn(t,s),Tn(t+"Capture",s)}function Tn(t,s){for(pf[t]=s,t=0;t<s.length;t++)gf.add(s[t])}var Ly=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),mf={},yf={};function Oy(t){return Ta.call(yf,t)?!0:Ta.call(mf,t)?!1:Ly.test(t)?yf[t]=!0:(mf[t]=!0,!1)}function Xo(t,s,r){if(Oy(s))if(r===null)t.removeAttribute(s);else{switch(typeof r){case"undefined":case"function":case"symbol":t.removeAttribute(s);return;case"boolean":var c=s.toLowerCase().slice(0,5);if(c!=="data-"&&c!=="aria-"){t.removeAttribute(s);return}}t.setAttribute(s,""+r)}}function Vo(t,s,r){if(r===null)t.removeAttribute(s);else{switch(typeof r){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(s);return}t.setAttribute(s,""+r)}}function Ei(t,s,r,c){if(c===null)t.removeAttribute(r);else{switch(typeof c){case"undefined":case"function":case"symbol":case"boolean":t.removeAttribute(r);return}t.setAttributeNS(s,r,""+c)}}var Kl,vf;function wn(t){if(Kl===void 0)try{throw Error()}catch(r){var s=r.stack.trim().match(/\n( *(at )?)/);Kl=s&&s[1]||"",vf=-1<r.stack.indexOf(`
    at`)?" (<anonymous>)":-1<r.stack.indexOf("@")?"@unknown:0:0":""}return`
`+Kl+t+vf}var Zl=!1;function Ql(t,s){if(!t||Zl)return"";Zl=!0;var r=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var c={DetermineComponentFrameRoot:function(){try{if(s){var j=function(){throw Error()};if(Object.defineProperty(j.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(j,[])}catch(U){var F=U}Reflect.construct(t,[],j)}else{try{j.call()}catch(U){F=U}t.call(j.prototype)}}else{try{throw Error()}catch(U){F=U}(j=t())&&typeof j.catch=="function"&&j.catch(function(){})}}catch(U){if(U&&F&&typeof U.stack=="string")return[U.stack,F.stack]}return[null,null]}};c.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var f=Object.getOwnPropertyDescriptor(c.DetermineComponentFrameRoot,"name");f&&f.configurable&&Object.defineProperty(c.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var p=c.DetermineComponentFrameRoot(),S=p[0],T=p[1];if(S&&T){var R=S.split(`
`),O=T.split(`
`);for(f=c=0;c<R.length&&!R[c].includes("DetermineComponentFrameRoot");)c++;for(;f<O.length&&!O[f].includes("DetermineComponentFrameRoot");)f++;if(c===R.length||f===O.length)for(c=R.length-1,f=O.length-1;1<=c&&0<=f&&R[c]!==O[f];)f--;for(;1<=c&&0<=f;c--,f--)if(R[c]!==O[f]){if(c!==1||f!==1)do if(c--,f--,0>f||R[c]!==O[f]){var V=`
`+R[c].replace(" at new "," at ");return t.displayName&&V.includes("<anonymous>")&&(V=V.replace("<anonymous>",t.displayName)),V}while(1<=c&&0<=f);break}}}finally{Zl=!1,Error.prepareStackTrace=r}return(r=t?t.displayName||t.name:"")?wn(r):""}function Fy(t){switch(t.tag){case 26:case 27:case 5:return wn(t.type);case 16:return wn("Lazy");case 13:return wn("Suspense");case 19:return wn("SuspenseList");case 0:case 15:return Ql(t.type,!1);case 11:return Ql(t.type.render,!1);case 1:return Ql(t.type,!0);case 31:return wn("Activity");default:return""}}function bf(t){try{var s="";do s+=Fy(t),t=t.return;while(t);return s}catch(r){return`
Error generating stack: `+r.message+`
`+r.stack}}function Yt(t){switch(typeof t){case"bigint":case"boolean":case"number":case"string":case"undefined":return t;case"object":return t;default:return""}}function Sf(t){var s=t.type;return(t=t.nodeName)&&t.toLowerCase()==="input"&&(s==="checkbox"||s==="radio")}function Uy(t){var s=Sf(t)?"checked":"value",r=Object.getOwnPropertyDescriptor(t.constructor.prototype,s),c=""+t[s];if(!t.hasOwnProperty(s)&&typeof r<"u"&&typeof r.get=="function"&&typeof r.set=="function"){var f=r.get,p=r.set;return Object.defineProperty(t,s,{configurable:!0,get:function(){return f.call(this)},set:function(S){c=""+S,p.call(this,S)}}),Object.defineProperty(t,s,{enumerable:r.enumerable}),{getValue:function(){return c},setValue:function(S){c=""+S},stopTracking:function(){t._valueTracker=null,delete t[s]}}}}function Yo(t){t._valueTracker||(t._valueTracker=Uy(t))}function Mf(t){if(!t)return!1;var s=t._valueTracker;if(!s)return!0;var r=s.getValue(),c="";return t&&(c=Sf(t)?t.checked?"true":"false":t.value),t=c,t!==r?(s.setValue(t),!0):!1}function qo(t){if(t=t||(typeof document<"u"?document:void 0),typeof t>"u")return null;try{return t.activeElement||t.body}catch{return t.body}}var Ny=/[\n"\\]/g;function qt(t){return t.replace(Ny,function(s){return"\\"+s.charCodeAt(0).toString(16)+" "})}function $l(t,s,r,c,f,p,S,T){t.name="",S!=null&&typeof S!="function"&&typeof S!="symbol"&&typeof S!="boolean"?t.type=S:t.removeAttribute("type"),s!=null?S==="number"?(s===0&&t.value===""||t.value!=s)&&(t.value=""+Yt(s)):t.value!==""+Yt(s)&&(t.value=""+Yt(s)):S!=="submit"&&S!=="reset"||t.removeAttribute("value"),s!=null?Jl(t,S,Yt(s)):r!=null?Jl(t,S,Yt(r)):c!=null&&t.removeAttribute("value"),f==null&&p!=null&&(t.defaultChecked=!!p),f!=null&&(t.checked=f&&typeof f!="function"&&typeof f!="symbol"),T!=null&&typeof T!="function"&&typeof T!="symbol"&&typeof T!="boolean"?t.name=""+Yt(T):t.removeAttribute("name")}function Cf(t,s,r,c,f,p,S,T){if(p!=null&&typeof p!="function"&&typeof p!="symbol"&&typeof p!="boolean"&&(t.type=p),s!=null||r!=null){if(!(p!=="submit"&&p!=="reset"||s!=null))return;r=r!=null?""+Yt(r):"",s=s!=null?""+Yt(s):r,T||s===t.value||(t.value=s),t.defaultValue=s}c=c??f,c=typeof c!="function"&&typeof c!="symbol"&&!!c,t.checked=T?t.checked:!!c,t.defaultChecked=!!c,S!=null&&typeof S!="function"&&typeof S!="symbol"&&typeof S!="boolean"&&(t.name=S)}function Jl(t,s,r){s==="number"&&qo(t.ownerDocument)===t||t.defaultValue===""+r||(t.defaultValue=""+r)}function An(t,s,r,c){if(t=t.options,s){s={};for(var f=0;f<r.length;f++)s["$"+r[f]]=!0;for(r=0;r<t.length;r++)f=s.hasOwnProperty("$"+t[r].value),t[r].selected!==f&&(t[r].selected=f),f&&c&&(t[r].defaultSelected=!0)}else{for(r=""+Yt(r),s=null,f=0;f<t.length;f++){if(t[f].value===r){t[f].selected=!0,c&&(t[f].defaultSelected=!0);return}s!==null||t[f].disabled||(s=t[f])}s!==null&&(s.selected=!0)}}function Tf(t,s,r){if(s!=null&&(s=""+Yt(s),s!==t.value&&(t.value=s),r==null)){t.defaultValue!==s&&(t.defaultValue=s);return}t.defaultValue=r!=null?""+Yt(r):""}function wf(t,s,r,c){if(s==null){if(c!=null){if(r!=null)throw Error(n(92));if(ee(c)){if(1<c.length)throw Error(n(93));c=c[0]}r=c}r==null&&(r=""),s=r}r=Yt(s),t.defaultValue=r,c=t.textContent,c===r&&c!==""&&c!==null&&(t.value=c)}function kn(t,s){if(s){var r=t.firstChild;if(r&&r===t.lastChild&&r.nodeType===3){r.nodeValue=s;return}}t.textContent=s}var Hy=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Af(t,s,r){var c=s.indexOf("--")===0;r==null||typeof r=="boolean"||r===""?c?t.setProperty(s,""):s==="float"?t.cssFloat="":t[s]="":c?t.setProperty(s,r):typeof r!="number"||r===0||Hy.has(s)?s==="float"?t.cssFloat=r:t[s]=(""+r).trim():t[s]=r+"px"}function kf(t,s,r){if(s!=null&&typeof s!="object")throw Error(n(62));if(t=t.style,r!=null){for(var c in r)!r.hasOwnProperty(c)||s!=null&&s.hasOwnProperty(c)||(c.indexOf("--")===0?t.setProperty(c,""):c==="float"?t.cssFloat="":t[c]="");for(var f in s)c=s[f],s.hasOwnProperty(f)&&r[f]!==c&&Af(t,f,c)}else for(var p in s)s.hasOwnProperty(p)&&Af(t,p,s[p])}function ec(t){if(t.indexOf("-")===-1)return!1;switch(t){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Wy=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),Gy=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function jo(t){return Gy.test(""+t)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":t}var tc=null;function ic(t){return t=t.target||t.srcElement||window,t.correspondingUseElement&&(t=t.correspondingUseElement),t.nodeType===3?t.parentNode:t}var Rn=null,En=null;function Rf(t){var s=Mn(t);if(s&&(t=s.stateNode)){var r=t[At]||null;e:switch(t=s.stateNode,s.type){case"input":if($l(t,r.value,r.defaultValue,r.defaultValue,r.checked,r.defaultChecked,r.type,r.name),s=r.name,r.type==="radio"&&s!=null){for(r=t;r.parentNode;)r=r.parentNode;for(r=r.querySelectorAll('input[name="'+qt(""+s)+'"][type="radio"]'),s=0;s<r.length;s++){var c=r[s];if(c!==t&&c.form===t.form){var f=c[At]||null;if(!f)throw Error(n(90));$l(c,f.value,f.defaultValue,f.defaultValue,f.checked,f.defaultChecked,f.type,f.name)}}for(s=0;s<r.length;s++)c=r[s],c.form===t.form&&Mf(c)}break e;case"textarea":Tf(t,r.value,r.defaultValue);break e;case"select":s=r.value,s!=null&&An(t,!!r.multiple,s,!1)}}}var sc=!1;function Ef(t,s,r){if(sc)return t(s,r);sc=!0;try{var c=t(s);return c}finally{if(sc=!1,(Rn!==null||En!==null)&&(Dr(),Rn&&(s=Rn,t=En,En=Rn=null,Rf(s),t)))for(s=0;s<t.length;s++)Rf(t[s])}}function Ia(t,s){var r=t.stateNode;if(r===null)return null;var c=r[At]||null;if(c===null)return null;r=c[s];e:switch(s){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(c=!c.disabled)||(t=t.type,c=!(t==="button"||t==="input"||t==="select"||t==="textarea")),t=!c;break e;default:t=!1}if(t)return null;if(r&&typeof r!="function")throw Error(n(231,s,typeof r));return r}var Bi=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),nc=!1;if(Bi)try{var xa={};Object.defineProperty(xa,"passive",{get:function(){nc=!0}}),window.addEventListener("test",xa,xa),window.removeEventListener("test",xa,xa)}catch{nc=!1}var es=null,ac=null,Ko=null;function Bf(){if(Ko)return Ko;var t,s=ac,r=s.length,c,f="value"in es?es.value:es.textContent,p=f.length;for(t=0;t<r&&s[t]===f[t];t++);var S=r-t;for(c=1;c<=S&&s[r-c]===f[p-c];c++);return Ko=f.slice(t,1<c?1-c:void 0)}function Zo(t){var s=t.keyCode;return"charCode"in t?(t=t.charCode,t===0&&s===13&&(t=13)):t=s,t===10&&(t=13),32<=t||t===13?t:0}function Qo(){return!0}function If(){return!1}function kt(t){function s(r,c,f,p,S){this._reactName=r,this._targetInst=f,this.type=c,this.nativeEvent=p,this.target=S,this.currentTarget=null;for(var T in t)t.hasOwnProperty(T)&&(r=t[T],this[T]=r?r(p):p[T]);return this.isDefaultPrevented=(p.defaultPrevented!=null?p.defaultPrevented:p.returnValue===!1)?Qo:If,this.isPropagationStopped=If,this}return m(s.prototype,{preventDefault:function(){this.defaultPrevented=!0;var r=this.nativeEvent;r&&(r.preventDefault?r.preventDefault():typeof r.returnValue!="unknown"&&(r.returnValue=!1),this.isDefaultPrevented=Qo)},stopPropagation:function(){var r=this.nativeEvent;r&&(r.stopPropagation?r.stopPropagation():typeof r.cancelBubble!="unknown"&&(r.cancelBubble=!0),this.isPropagationStopped=Qo)},persist:function(){},isPersistent:Qo}),s}var Os={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(t){return t.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},$o=kt(Os),_a=m({},Os,{view:0,detail:0}),zy=kt(_a),oc,rc,Da,Jo=m({},_a,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:cc,button:0,buttons:0,relatedTarget:function(t){return t.relatedTarget===void 0?t.fromElement===t.srcElement?t.toElement:t.fromElement:t.relatedTarget},movementX:function(t){return"movementX"in t?t.movementX:(t!==Da&&(Da&&t.type==="mousemove"?(oc=t.screenX-Da.screenX,rc=t.screenY-Da.screenY):rc=oc=0,Da=t),oc)},movementY:function(t){return"movementY"in t?t.movementY:rc}}),xf=kt(Jo),Xy=m({},Jo,{dataTransfer:0}),Vy=kt(Xy),Yy=m({},_a,{relatedTarget:0}),lc=kt(Yy),qy=m({},Os,{animationName:0,elapsedTime:0,pseudoElement:0}),jy=kt(qy),Ky=m({},Os,{clipboardData:function(t){return"clipboardData"in t?t.clipboardData:window.clipboardData}}),Zy=kt(Ky),Qy=m({},Os,{data:0}),_f=kt(Qy),$y={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Jy={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},ev={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function tv(t){var s=this.nativeEvent;return s.getModifierState?s.getModifierState(t):(t=ev[t])?!!s[t]:!1}function cc(){return tv}var iv=m({},_a,{key:function(t){if(t.key){var s=$y[t.key]||t.key;if(s!=="Unidentified")return s}return t.type==="keypress"?(t=Zo(t),t===13?"Enter":String.fromCharCode(t)):t.type==="keydown"||t.type==="keyup"?Jy[t.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:cc,charCode:function(t){return t.type==="keypress"?Zo(t):0},keyCode:function(t){return t.type==="keydown"||t.type==="keyup"?t.keyCode:0},which:function(t){return t.type==="keypress"?Zo(t):t.type==="keydown"||t.type==="keyup"?t.keyCode:0}}),sv=kt(iv),nv=m({},Jo,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Df=kt(nv),av=m({},_a,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:cc}),ov=kt(av),rv=m({},Os,{propertyName:0,elapsedTime:0,pseudoElement:0}),lv=kt(rv),cv=m({},Jo,{deltaX:function(t){return"deltaX"in t?t.deltaX:"wheelDeltaX"in t?-t.wheelDeltaX:0},deltaY:function(t){return"deltaY"in t?t.deltaY:"wheelDeltaY"in t?-t.wheelDeltaY:"wheelDelta"in t?-t.wheelDelta:0},deltaZ:0,deltaMode:0}),hv=kt(cv),uv=m({},Os,{newState:0,oldState:0}),fv=kt(uv),dv=[9,13,27,32],hc=Bi&&"CompositionEvent"in window,Pa=null;Bi&&"documentMode"in document&&(Pa=document.documentMode);var gv=Bi&&"TextEvent"in window&&!Pa,Pf=Bi&&(!hc||Pa&&8<Pa&&11>=Pa),Lf=" ",Of=!1;function Ff(t,s){switch(t){case"keyup":return dv.indexOf(s.keyCode)!==-1;case"keydown":return s.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function Uf(t){return t=t.detail,typeof t=="object"&&"data"in t?t.data:null}var Bn=!1;function pv(t,s){switch(t){case"compositionend":return Uf(s);case"keypress":return s.which!==32?null:(Of=!0,Lf);case"textInput":return t=s.data,t===Lf&&Of?null:t;default:return null}}function mv(t,s){if(Bn)return t==="compositionend"||!hc&&Ff(t,s)?(t=Bf(),Ko=ac=es=null,Bn=!1,t):null;switch(t){case"paste":return null;case"keypress":if(!(s.ctrlKey||s.altKey||s.metaKey)||s.ctrlKey&&s.altKey){if(s.char&&1<s.char.length)return s.char;if(s.which)return String.fromCharCode(s.which)}return null;case"compositionend":return Pf&&s.locale!=="ko"?null:s.data;default:return null}}var yv={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Nf(t){var s=t&&t.nodeName&&t.nodeName.toLowerCase();return s==="input"?!!yv[t.type]:s==="textarea"}function Hf(t,s,r,c){Rn?En?En.push(c):En=[c]:Rn=c,s=Nr(s,"onChange"),0<s.length&&(r=new $o("onChange","change",null,r,c),t.push({event:r,listeners:s}))}var La=null,Oa=null;function vv(t){Sg(t,0)}function er(t){var s=Ba(t);if(Mf(s))return t}function Wf(t,s){if(t==="change")return s}var Gf=!1;if(Bi){var uc;if(Bi){var fc="oninput"in document;if(!fc){var zf=document.createElement("div");zf.setAttribute("oninput","return;"),fc=typeof zf.oninput=="function"}uc=fc}else uc=!1;Gf=uc&&(!document.documentMode||9<document.documentMode)}function Xf(){La&&(La.detachEvent("onpropertychange",Vf),Oa=La=null)}function Vf(t){if(t.propertyName==="value"&&er(Oa)){var s=[];Hf(s,Oa,t,ic(t)),Ef(vv,s)}}function bv(t,s,r){t==="focusin"?(Xf(),La=s,Oa=r,La.attachEvent("onpropertychange",Vf)):t==="focusout"&&Xf()}function Sv(t){if(t==="selectionchange"||t==="keyup"||t==="keydown")return er(Oa)}function Mv(t,s){if(t==="click")return er(s)}function Cv(t,s){if(t==="input"||t==="change")return er(s)}function Tv(t,s){return t===s&&(t!==0||1/t===1/s)||t!==t&&s!==s}var Lt=typeof Object.is=="function"?Object.is:Tv;function Fa(t,s){if(Lt(t,s))return!0;if(typeof t!="object"||t===null||typeof s!="object"||s===null)return!1;var r=Object.keys(t),c=Object.keys(s);if(r.length!==c.length)return!1;for(c=0;c<r.length;c++){var f=r[c];if(!Ta.call(s,f)||!Lt(t[f],s[f]))return!1}return!0}function Yf(t){for(;t&&t.firstChild;)t=t.firstChild;return t}function qf(t,s){var r=Yf(t);t=0;for(var c;r;){if(r.nodeType===3){if(c=t+r.textContent.length,t<=s&&c>=s)return{node:r,offset:s-t};t=c}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=Yf(r)}}function jf(t,s){return t&&s?t===s?!0:t&&t.nodeType===3?!1:s&&s.nodeType===3?jf(t,s.parentNode):"contains"in t?t.contains(s):t.compareDocumentPosition?!!(t.compareDocumentPosition(s)&16):!1:!1}function Kf(t){t=t!=null&&t.ownerDocument!=null&&t.ownerDocument.defaultView!=null?t.ownerDocument.defaultView:window;for(var s=qo(t.document);s instanceof t.HTMLIFrameElement;){try{var r=typeof s.contentWindow.location.href=="string"}catch{r=!1}if(r)t=s.contentWindow;else break;s=qo(t.document)}return s}function dc(t){var s=t&&t.nodeName&&t.nodeName.toLowerCase();return s&&(s==="input"&&(t.type==="text"||t.type==="search"||t.type==="tel"||t.type==="url"||t.type==="password")||s==="textarea"||t.contentEditable==="true")}var wv=Bi&&"documentMode"in document&&11>=document.documentMode,In=null,gc=null,Ua=null,pc=!1;function Zf(t,s,r){var c=r.window===r?r.document:r.nodeType===9?r:r.ownerDocument;pc||In==null||In!==qo(c)||(c=In,"selectionStart"in c&&dc(c)?c={start:c.selectionStart,end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset}),Ua&&Fa(Ua,c)||(Ua=c,c=Nr(gc,"onSelect"),0<c.length&&(s=new $o("onSelect","select",null,s,r),t.push({event:s,listeners:c}),s.target=In)))}function Fs(t,s){var r={};return r[t.toLowerCase()]=s.toLowerCase(),r["Webkit"+t]="webkit"+s,r["Moz"+t]="moz"+s,r}var xn={animationend:Fs("Animation","AnimationEnd"),animationiteration:Fs("Animation","AnimationIteration"),animationstart:Fs("Animation","AnimationStart"),transitionrun:Fs("Transition","TransitionRun"),transitionstart:Fs("Transition","TransitionStart"),transitioncancel:Fs("Transition","TransitionCancel"),transitionend:Fs("Transition","TransitionEnd")},mc={},Qf={};Bi&&(Qf=document.createElement("div").style,"AnimationEvent"in window||(delete xn.animationend.animation,delete xn.animationiteration.animation,delete xn.animationstart.animation),"TransitionEvent"in window||delete xn.transitionend.transition);function Us(t){if(mc[t])return mc[t];if(!xn[t])return t;var s=xn[t],r;for(r in s)if(s.hasOwnProperty(r)&&r in Qf)return mc[t]=s[r];return t}var $f=Us("animationend"),Jf=Us("animationiteration"),ed=Us("animationstart"),Av=Us("transitionrun"),kv=Us("transitionstart"),Rv=Us("transitioncancel"),td=Us("transitionend"),id=new Map,yc="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");yc.push("scrollEnd");function ri(t,s){id.set(t,s),Ls(s,[t])}var sd=new WeakMap;function jt(t,s){if(typeof t=="object"&&t!==null){var r=sd.get(t);return r!==void 0?r:(s={value:t,source:s,stack:bf(s)},sd.set(t,s),s)}return{value:t,source:s,stack:bf(s)}}var Kt=[],_n=0,vc=0;function tr(){for(var t=_n,s=vc=_n=0;s<t;){var r=Kt[s];Kt[s++]=null;var c=Kt[s];Kt[s++]=null;var f=Kt[s];Kt[s++]=null;var p=Kt[s];if(Kt[s++]=null,c!==null&&f!==null){var S=c.pending;S===null?f.next=f:(f.next=S.next,S.next=f),c.pending=f}p!==0&&nd(r,f,p)}}function ir(t,s,r,c){Kt[_n++]=t,Kt[_n++]=s,Kt[_n++]=r,Kt[_n++]=c,vc|=c,t.lanes|=c,t=t.alternate,t!==null&&(t.lanes|=c)}function bc(t,s,r,c){return ir(t,s,r,c),sr(t)}function Dn(t,s){return ir(t,null,null,s),sr(t)}function nd(t,s,r){t.lanes|=r;var c=t.alternate;c!==null&&(c.lanes|=r);for(var f=!1,p=t.return;p!==null;)p.childLanes|=r,c=p.alternate,c!==null&&(c.childLanes|=r),p.tag===22&&(t=p.stateNode,t===null||t._visibility&1||(f=!0)),t=p,p=p.return;return t.tag===3?(p=t.stateNode,f&&s!==null&&(f=31-Pt(r),t=p.hiddenUpdates,c=t[f],c===null?t[f]=[s]:c.push(s),s.lane=r|536870912),p):null}function sr(t){if(50<co)throw co=0,Ah=null,Error(n(185));for(var s=t.return;s!==null;)t=s,s=t.return;return t.tag===3?t.stateNode:null}var Pn={};function Ev(t,s,r,c){this.tag=t,this.key=r,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=s,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=c,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ot(t,s,r,c){return new Ev(t,s,r,c)}function Sc(t){return t=t.prototype,!(!t||!t.isReactComponent)}function Ii(t,s){var r=t.alternate;return r===null?(r=Ot(t.tag,s,t.key,t.mode),r.elementType=t.elementType,r.type=t.type,r.stateNode=t.stateNode,r.alternate=t,t.alternate=r):(r.pendingProps=s,r.type=t.type,r.flags=0,r.subtreeFlags=0,r.deletions=null),r.flags=t.flags&65011712,r.childLanes=t.childLanes,r.lanes=t.lanes,r.child=t.child,r.memoizedProps=t.memoizedProps,r.memoizedState=t.memoizedState,r.updateQueue=t.updateQueue,s=t.dependencies,r.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext},r.sibling=t.sibling,r.index=t.index,r.ref=t.ref,r.refCleanup=t.refCleanup,r}function ad(t,s){t.flags&=65011714;var r=t.alternate;return r===null?(t.childLanes=0,t.lanes=s,t.child=null,t.subtreeFlags=0,t.memoizedProps=null,t.memoizedState=null,t.updateQueue=null,t.dependencies=null,t.stateNode=null):(t.childLanes=r.childLanes,t.lanes=r.lanes,t.child=r.child,t.subtreeFlags=0,t.deletions=null,t.memoizedProps=r.memoizedProps,t.memoizedState=r.memoizedState,t.updateQueue=r.updateQueue,t.type=r.type,s=r.dependencies,t.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext}),t}function nr(t,s,r,c,f,p){var S=0;if(c=t,typeof t=="function")Sc(t)&&(S=1);else if(typeof t=="string")S=Ib(t,r,re.current)?26:t==="html"||t==="head"||t==="body"?27:5;else e:switch(t){case K:return t=Ot(31,r,s,f),t.elementType=K,t.lanes=p,t;case b:return Ns(r.children,f,p,s);case C:S=8,f|=24;break;case w:return t=Ot(12,r,s,f|2),t.elementType=w,t.lanes=p,t;case D:return t=Ot(13,r,s,f),t.elementType=D,t.lanes=p,t;case N:return t=Ot(19,r,s,f),t.elementType=N,t.lanes=p,t;default:if(typeof t=="object"&&t!==null)switch(t.$$typeof){case A:case x:S=10;break e;case E:S=9;break e;case I:S=11;break e;case H:S=14;break e;case W:S=16,c=null;break e}S=29,r=Error(n(130,t===null?"null":typeof t,"")),c=null}return s=Ot(S,r,s,f),s.elementType=t,s.type=c,s.lanes=p,s}function Ns(t,s,r,c){return t=Ot(7,t,c,s),t.lanes=r,t}function Mc(t,s,r){return t=Ot(6,t,null,s),t.lanes=r,t}function Cc(t,s,r){return s=Ot(4,t.children!==null?t.children:[],t.key,s),s.lanes=r,s.stateNode={containerInfo:t.containerInfo,pendingChildren:null,implementation:t.implementation},s}var Ln=[],On=0,ar=null,or=0,Zt=[],Qt=0,Hs=null,xi=1,_i="";function Ws(t,s){Ln[On++]=or,Ln[On++]=ar,ar=t,or=s}function od(t,s,r){Zt[Qt++]=xi,Zt[Qt++]=_i,Zt[Qt++]=Hs,Hs=t;var c=xi;t=_i;var f=32-Pt(c)-1;c&=~(1<<f),r+=1;var p=32-Pt(s)+f;if(30<p){var S=f-f%5;p=(c&(1<<S)-1).toString(32),c>>=S,f-=S,xi=1<<32-Pt(s)+f|r<<f|c,_i=p+t}else xi=1<<p|r<<f|c,_i=t}function Tc(t){t.return!==null&&(Ws(t,1),od(t,1,0))}function wc(t){for(;t===ar;)ar=Ln[--On],Ln[On]=null,or=Ln[--On],Ln[On]=null;for(;t===Hs;)Hs=Zt[--Qt],Zt[Qt]=null,_i=Zt[--Qt],Zt[Qt]=null,xi=Zt[--Qt],Zt[Qt]=null}var St=null,ze=null,Re=!1,Gs=null,di=!1,Ac=Error(n(519));function zs(t){var s=Error(n(418,""));throw Wa(jt(s,t)),Ac}function rd(t){var s=t.stateNode,r=t.type,c=t.memoizedProps;switch(s[dt]=t,s[At]=c,r){case"dialog":Ce("cancel",s),Ce("close",s);break;case"iframe":case"object":case"embed":Ce("load",s);break;case"video":case"audio":for(r=0;r<uo.length;r++)Ce(uo[r],s);break;case"source":Ce("error",s);break;case"img":case"image":case"link":Ce("error",s),Ce("load",s);break;case"details":Ce("toggle",s);break;case"input":Ce("invalid",s),Cf(s,c.value,c.defaultValue,c.checked,c.defaultChecked,c.type,c.name,!0),Yo(s);break;case"select":Ce("invalid",s);break;case"textarea":Ce("invalid",s),wf(s,c.value,c.defaultValue,c.children),Yo(s)}r=c.children,typeof r!="string"&&typeof r!="number"&&typeof r!="bigint"||s.textContent===""+r||c.suppressHydrationWarning===!0||wg(s.textContent,r)?(c.popover!=null&&(Ce("beforetoggle",s),Ce("toggle",s)),c.onScroll!=null&&Ce("scroll",s),c.onScrollEnd!=null&&Ce("scrollend",s),c.onClick!=null&&(s.onclick=Hr),s=!0):s=!1,s||zs(t)}function ld(t){for(St=t.return;St;)switch(St.tag){case 5:case 13:di=!1;return;case 27:case 3:di=!0;return;default:St=St.return}}function Na(t){if(t!==St)return!1;if(!Re)return ld(t),Re=!0,!1;var s=t.tag,r;if((r=s!==3&&s!==27)&&((r=s===5)&&(r=t.type,r=!(r!=="form"&&r!=="button")||Wh(t.type,t.memoizedProps)),r=!r),r&&ze&&zs(t),ld(t),s===13){if(t=t.memoizedState,t=t!==null?t.dehydrated:null,!t)throw Error(n(317));e:{for(t=t.nextSibling,s=0;t;){if(t.nodeType===8)if(r=t.data,r==="/$"){if(s===0){ze=ci(t.nextSibling);break e}s--}else r!=="$"&&r!=="$!"&&r!=="$?"||s++;t=t.nextSibling}ze=null}}else s===27?(s=ze,ms(t.type)?(t=Vh,Vh=null,ze=t):ze=s):ze=St?ci(t.stateNode.nextSibling):null;return!0}function Ha(){ze=St=null,Re=!1}function cd(){var t=Gs;return t!==null&&(Bt===null?Bt=t:Bt.push.apply(Bt,t),Gs=null),t}function Wa(t){Gs===null?Gs=[t]:Gs.push(t)}var kc=G(null),Xs=null,Di=null;function ts(t,s,r){ie(kc,s._currentValue),s._currentValue=r}function Pi(t){t._currentValue=kc.current,te(kc)}function Rc(t,s,r){for(;t!==null;){var c=t.alternate;if((t.childLanes&s)!==s?(t.childLanes|=s,c!==null&&(c.childLanes|=s)):c!==null&&(c.childLanes&s)!==s&&(c.childLanes|=s),t===r)break;t=t.return}}function Ec(t,s,r,c){var f=t.child;for(f!==null&&(f.return=t);f!==null;){var p=f.dependencies;if(p!==null){var S=f.child;p=p.firstContext;e:for(;p!==null;){var T=p;p=f;for(var R=0;R<s.length;R++)if(T.context===s[R]){p.lanes|=r,T=p.alternate,T!==null&&(T.lanes|=r),Rc(p.return,r,t),c||(S=null);break e}p=T.next}}else if(f.tag===18){if(S=f.return,S===null)throw Error(n(341));S.lanes|=r,p=S.alternate,p!==null&&(p.lanes|=r),Rc(S,r,t),S=null}else S=f.child;if(S!==null)S.return=f;else for(S=f;S!==null;){if(S===t){S=null;break}if(f=S.sibling,f!==null){f.return=S.return,S=f;break}S=S.return}f=S}}function Ga(t,s,r,c){t=null;for(var f=s,p=!1;f!==null;){if(!p){if((f.flags&524288)!==0)p=!0;else if((f.flags&262144)!==0)break}if(f.tag===10){var S=f.alternate;if(S===null)throw Error(n(387));if(S=S.memoizedProps,S!==null){var T=f.type;Lt(f.pendingProps.value,S.value)||(t!==null?t.push(T):t=[T])}}else if(f===ft.current){if(S=f.alternate,S===null)throw Error(n(387));S.memoizedState.memoizedState!==f.memoizedState.memoizedState&&(t!==null?t.push(vo):t=[vo])}f=f.return}t!==null&&Ec(s,t,r,c),s.flags|=262144}function rr(t){for(t=t.firstContext;t!==null;){if(!Lt(t.context._currentValue,t.memoizedValue))return!0;t=t.next}return!1}function Vs(t){Xs=t,Di=null,t=t.dependencies,t!==null&&(t.firstContext=null)}function gt(t){return hd(Xs,t)}function lr(t,s){return Xs===null&&Vs(t),hd(t,s)}function hd(t,s){var r=s._currentValue;if(s={context:s,memoizedValue:r,next:null},Di===null){if(t===null)throw Error(n(308));Di=s,t.dependencies={lanes:0,firstContext:s},t.flags|=524288}else Di=Di.next=s;return r}var Bv=typeof AbortController<"u"?AbortController:function(){var t=[],s=this.signal={aborted:!1,addEventListener:function(r,c){t.push(c)}};this.abort=function(){s.aborted=!0,t.forEach(function(r){return r()})}},Iv=a.unstable_scheduleCallback,xv=a.unstable_NormalPriority,Qe={$$typeof:x,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function Bc(){return{controller:new Bv,data:new Map,refCount:0}}function za(t){t.refCount--,t.refCount===0&&Iv(xv,function(){t.controller.abort()})}var Xa=null,Ic=0,Fn=0,Un=null;function _v(t,s){if(Xa===null){var r=Xa=[];Ic=0,Fn=_h(),Un={status:"pending",value:void 0,then:function(c){r.push(c)}}}return Ic++,s.then(ud,ud),s}function ud(){if(--Ic===0&&Xa!==null){Un!==null&&(Un.status="fulfilled");var t=Xa;Xa=null,Fn=0,Un=null;for(var s=0;s<t.length;s++)(0,t[s])()}}function Dv(t,s){var r=[],c={status:"pending",value:null,reason:null,then:function(f){r.push(f)}};return t.then(function(){c.status="fulfilled",c.value=s;for(var f=0;f<r.length;f++)(0,r[f])(s)},function(f){for(c.status="rejected",c.reason=f,f=0;f<r.length;f++)(0,r[f])(void 0)}),c}var fd=_.S;_.S=function(t,s){typeof s=="object"&&s!==null&&typeof s.then=="function"&&_v(t,s),fd!==null&&fd(t,s)};var Ys=G(null);function xc(){var t=Ys.current;return t!==null?t:Ue.pooledCache}function cr(t,s){s===null?ie(Ys,Ys.current):ie(Ys,s.pool)}function dd(){var t=xc();return t===null?null:{parent:Qe._currentValue,pool:t}}var Va=Error(n(460)),gd=Error(n(474)),hr=Error(n(542)),_c={then:function(){}};function pd(t){return t=t.status,t==="fulfilled"||t==="rejected"}function ur(){}function md(t,s,r){switch(r=t[r],r===void 0?t.push(s):r!==s&&(s.then(ur,ur),s=r),s.status){case"fulfilled":return s.value;case"rejected":throw t=s.reason,vd(t),t;default:if(typeof s.status=="string")s.then(ur,ur);else{if(t=Ue,t!==null&&100<t.shellSuspendCounter)throw Error(n(482));t=s,t.status="pending",t.then(function(c){if(s.status==="pending"){var f=s;f.status="fulfilled",f.value=c}},function(c){if(s.status==="pending"){var f=s;f.status="rejected",f.reason=c}})}switch(s.status){case"fulfilled":return s.value;case"rejected":throw t=s.reason,vd(t),t}throw Ya=s,Va}}var Ya=null;function yd(){if(Ya===null)throw Error(n(459));var t=Ya;return Ya=null,t}function vd(t){if(t===Va||t===hr)throw Error(n(483))}var is=!1;function Dc(t){t.updateQueue={baseState:t.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function Pc(t,s){t=t.updateQueue,s.updateQueue===t&&(s.updateQueue={baseState:t.baseState,firstBaseUpdate:t.firstBaseUpdate,lastBaseUpdate:t.lastBaseUpdate,shared:t.shared,callbacks:null})}function ss(t){return{lane:t,tag:0,payload:null,callback:null,next:null}}function ns(t,s,r){var c=t.updateQueue;if(c===null)return null;if(c=c.shared,(Ie&2)!==0){var f=c.pending;return f===null?s.next=s:(s.next=f.next,f.next=s),c.pending=s,s=sr(t),nd(t,null,r),s}return ir(t,c,s,r),sr(t)}function qa(t,s,r){if(s=s.updateQueue,s!==null&&(s=s.shared,(r&4194048)!==0)){var c=s.lanes;c&=t.pendingLanes,r|=c,s.lanes=r,uf(t,r)}}function Lc(t,s){var r=t.updateQueue,c=t.alternate;if(c!==null&&(c=c.updateQueue,r===c)){var f=null,p=null;if(r=r.firstBaseUpdate,r!==null){do{var S={lane:r.lane,tag:r.tag,payload:r.payload,callback:null,next:null};p===null?f=p=S:p=p.next=S,r=r.next}while(r!==null);p===null?f=p=s:p=p.next=s}else f=p=s;r={baseState:c.baseState,firstBaseUpdate:f,lastBaseUpdate:p,shared:c.shared,callbacks:c.callbacks},t.updateQueue=r;return}t=r.lastBaseUpdate,t===null?r.firstBaseUpdate=s:t.next=s,r.lastBaseUpdate=s}var Oc=!1;function ja(){if(Oc){var t=Un;if(t!==null)throw t}}function Ka(t,s,r,c){Oc=!1;var f=t.updateQueue;is=!1;var p=f.firstBaseUpdate,S=f.lastBaseUpdate,T=f.shared.pending;if(T!==null){f.shared.pending=null;var R=T,O=R.next;R.next=null,S===null?p=O:S.next=O,S=R;var V=t.alternate;V!==null&&(V=V.updateQueue,T=V.lastBaseUpdate,T!==S&&(T===null?V.firstBaseUpdate=O:T.next=O,V.lastBaseUpdate=R))}if(p!==null){var j=f.baseState;S=0,V=O=R=null,T=p;do{var F=T.lane&-536870913,U=F!==T.lane;if(U?(we&F)===F:(c&F)===F){F!==0&&F===Fn&&(Oc=!0),V!==null&&(V=V.next={lane:0,tag:T.tag,payload:T.payload,callback:null,next:null});e:{var ge=t,fe=T;F=s;var Le=r;switch(fe.tag){case 1:if(ge=fe.payload,typeof ge=="function"){j=ge.call(Le,j,F);break e}j=ge;break e;case 3:ge.flags=ge.flags&-65537|128;case 0:if(ge=fe.payload,F=typeof ge=="function"?ge.call(Le,j,F):ge,F==null)break e;j=m({},j,F);break e;case 2:is=!0}}F=T.callback,F!==null&&(t.flags|=64,U&&(t.flags|=8192),U=f.callbacks,U===null?f.callbacks=[F]:U.push(F))}else U={lane:F,tag:T.tag,payload:T.payload,callback:T.callback,next:null},V===null?(O=V=U,R=j):V=V.next=U,S|=F;if(T=T.next,T===null){if(T=f.shared.pending,T===null)break;U=T,T=U.next,U.next=null,f.lastBaseUpdate=U,f.shared.pending=null}}while(!0);V===null&&(R=j),f.baseState=R,f.firstBaseUpdate=O,f.lastBaseUpdate=V,p===null&&(f.shared.lanes=0),fs|=S,t.lanes=S,t.memoizedState=j}}function bd(t,s){if(typeof t!="function")throw Error(n(191,t));t.call(s)}function Sd(t,s){var r=t.callbacks;if(r!==null)for(t.callbacks=null,t=0;t<r.length;t++)bd(r[t],s)}var Nn=G(null),fr=G(0);function Md(t,s){t=Wi,ie(fr,t),ie(Nn,s),Wi=t|s.baseLanes}function Fc(){ie(fr,Wi),ie(Nn,Nn.current)}function Uc(){Wi=fr.current,te(Nn),te(fr)}var as=0,be=null,De=null,je=null,dr=!1,Hn=!1,qs=!1,gr=0,Za=0,Wn=null,Pv=0;function Ve(){throw Error(n(321))}function Nc(t,s){if(s===null)return!1;for(var r=0;r<s.length&&r<t.length;r++)if(!Lt(t[r],s[r]))return!1;return!0}function Hc(t,s,r,c,f,p){return as=p,be=s,s.memoizedState=null,s.updateQueue=null,s.lanes=0,_.H=t===null||t.memoizedState===null?n0:a0,qs=!1,p=r(c,f),qs=!1,Hn&&(p=Td(s,r,c,f)),Cd(t),p}function Cd(t){_.H=Sr;var s=De!==null&&De.next!==null;if(as=0,je=De=be=null,dr=!1,Za=0,Wn=null,s)throw Error(n(300));t===null||et||(t=t.dependencies,t!==null&&rr(t)&&(et=!0))}function Td(t,s,r,c){be=t;var f=0;do{if(Hn&&(Wn=null),Za=0,Hn=!1,25<=f)throw Error(n(301));if(f+=1,je=De=null,t.updateQueue!=null){var p=t.updateQueue;p.lastEffect=null,p.events=null,p.stores=null,p.memoCache!=null&&(p.memoCache.index=0)}_.H=Wv,p=s(r,c)}while(Hn);return p}function Lv(){var t=_.H,s=t.useState()[0];return s=typeof s.then=="function"?Qa(s):s,t=t.useState()[0],(De!==null?De.memoizedState:null)!==t&&(be.flags|=1024),s}function Wc(){var t=gr!==0;return gr=0,t}function Gc(t,s,r){s.updateQueue=t.updateQueue,s.flags&=-2053,t.lanes&=~r}function zc(t){if(dr){for(t=t.memoizedState;t!==null;){var s=t.queue;s!==null&&(s.pending=null),t=t.next}dr=!1}as=0,je=De=be=null,Hn=!1,Za=gr=0,Wn=null}function Rt(){var t={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return je===null?be.memoizedState=je=t:je=je.next=t,je}function Ke(){if(De===null){var t=be.alternate;t=t!==null?t.memoizedState:null}else t=De.next;var s=je===null?be.memoizedState:je.next;if(s!==null)je=s,De=t;else{if(t===null)throw be.alternate===null?Error(n(467)):Error(n(310));De=t,t={memoizedState:De.memoizedState,baseState:De.baseState,baseQueue:De.baseQueue,queue:De.queue,next:null},je===null?be.memoizedState=je=t:je=je.next=t}return je}function Xc(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Qa(t){var s=Za;return Za+=1,Wn===null&&(Wn=[]),t=md(Wn,t,s),s=be,(je===null?s.memoizedState:je.next)===null&&(s=s.alternate,_.H=s===null||s.memoizedState===null?n0:a0),t}function pr(t){if(t!==null&&typeof t=="object"){if(typeof t.then=="function")return Qa(t);if(t.$$typeof===x)return gt(t)}throw Error(n(438,String(t)))}function Vc(t){var s=null,r=be.updateQueue;if(r!==null&&(s=r.memoCache),s==null){var c=be.alternate;c!==null&&(c=c.updateQueue,c!==null&&(c=c.memoCache,c!=null&&(s={data:c.data.map(function(f){return f.slice()}),index:0})))}if(s==null&&(s={data:[],index:0}),r===null&&(r=Xc(),be.updateQueue=r),r.memoCache=s,r=s.data[s.index],r===void 0)for(r=s.data[s.index]=Array(t),c=0;c<t;c++)r[c]=Z;return s.index++,r}function Li(t,s){return typeof s=="function"?s(t):s}function mr(t){var s=Ke();return Yc(s,De,t)}function Yc(t,s,r){var c=t.queue;if(c===null)throw Error(n(311));c.lastRenderedReducer=r;var f=t.baseQueue,p=c.pending;if(p!==null){if(f!==null){var S=f.next;f.next=p.next,p.next=S}s.baseQueue=f=p,c.pending=null}if(p=t.baseState,f===null)t.memoizedState=p;else{s=f.next;var T=S=null,R=null,O=s,V=!1;do{var j=O.lane&-536870913;if(j!==O.lane?(we&j)===j:(as&j)===j){var F=O.revertLane;if(F===0)R!==null&&(R=R.next={lane:0,revertLane:0,action:O.action,hasEagerState:O.hasEagerState,eagerState:O.eagerState,next:null}),j===Fn&&(V=!0);else if((as&F)===F){O=O.next,F===Fn&&(V=!0);continue}else j={lane:0,revertLane:O.revertLane,action:O.action,hasEagerState:O.hasEagerState,eagerState:O.eagerState,next:null},R===null?(T=R=j,S=p):R=R.next=j,be.lanes|=F,fs|=F;j=O.action,qs&&r(p,j),p=O.hasEagerState?O.eagerState:r(p,j)}else F={lane:j,revertLane:O.revertLane,action:O.action,hasEagerState:O.hasEagerState,eagerState:O.eagerState,next:null},R===null?(T=R=F,S=p):R=R.next=F,be.lanes|=j,fs|=j;O=O.next}while(O!==null&&O!==s);if(R===null?S=p:R.next=T,!Lt(p,t.memoizedState)&&(et=!0,V&&(r=Un,r!==null)))throw r;t.memoizedState=p,t.baseState=S,t.baseQueue=R,c.lastRenderedState=p}return f===null&&(c.lanes=0),[t.memoizedState,c.dispatch]}function qc(t){var s=Ke(),r=s.queue;if(r===null)throw Error(n(311));r.lastRenderedReducer=t;var c=r.dispatch,f=r.pending,p=s.memoizedState;if(f!==null){r.pending=null;var S=f=f.next;do p=t(p,S.action),S=S.next;while(S!==f);Lt(p,s.memoizedState)||(et=!0),s.memoizedState=p,s.baseQueue===null&&(s.baseState=p),r.lastRenderedState=p}return[p,c]}function wd(t,s,r){var c=be,f=Ke(),p=Re;if(p){if(r===void 0)throw Error(n(407));r=r()}else r=s();var S=!Lt((De||f).memoizedState,r);S&&(f.memoizedState=r,et=!0),f=f.queue;var T=Rd.bind(null,c,f,t);if($a(2048,8,T,[t]),f.getSnapshot!==s||S||je!==null&&je.memoizedState.tag&1){if(c.flags|=2048,Gn(9,yr(),kd.bind(null,c,f,r,s),null),Ue===null)throw Error(n(349));p||(as&124)!==0||Ad(c,s,r)}return r}function Ad(t,s,r){t.flags|=16384,t={getSnapshot:s,value:r},s=be.updateQueue,s===null?(s=Xc(),be.updateQueue=s,s.stores=[t]):(r=s.stores,r===null?s.stores=[t]:r.push(t))}function kd(t,s,r,c){s.value=r,s.getSnapshot=c,Ed(s)&&Bd(t)}function Rd(t,s,r){return r(function(){Ed(s)&&Bd(t)})}function Ed(t){var s=t.getSnapshot;t=t.value;try{var r=s();return!Lt(t,r)}catch{return!0}}function Bd(t){var s=Dn(t,2);s!==null&&Wt(s,t,2)}function jc(t){var s=Rt();if(typeof t=="function"){var r=t;if(t=r(),qs){$i(!0);try{r()}finally{$i(!1)}}}return s.memoizedState=s.baseState=t,s.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Li,lastRenderedState:t},s}function Id(t,s,r,c){return t.baseState=r,Yc(t,De,typeof c=="function"?c:Li)}function Ov(t,s,r,c,f){if(br(t))throw Error(n(485));if(t=s.action,t!==null){var p={payload:f,action:t,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(S){p.listeners.push(S)}};_.T!==null?r(!0):p.isTransition=!1,c(p),r=s.pending,r===null?(p.next=s.pending=p,xd(s,p)):(p.next=r.next,s.pending=r.next=p)}}function xd(t,s){var r=s.action,c=s.payload,f=t.state;if(s.isTransition){var p=_.T,S={};_.T=S;try{var T=r(f,c),R=_.S;R!==null&&R(S,T),_d(t,s,T)}catch(O){Kc(t,s,O)}finally{_.T=p}}else try{p=r(f,c),_d(t,s,p)}catch(O){Kc(t,s,O)}}function _d(t,s,r){r!==null&&typeof r=="object"&&typeof r.then=="function"?r.then(function(c){Dd(t,s,c)},function(c){return Kc(t,s,c)}):Dd(t,s,r)}function Dd(t,s,r){s.status="fulfilled",s.value=r,Pd(s),t.state=r,s=t.pending,s!==null&&(r=s.next,r===s?t.pending=null:(r=r.next,s.next=r,xd(t,r)))}function Kc(t,s,r){var c=t.pending;if(t.pending=null,c!==null){c=c.next;do s.status="rejected",s.reason=r,Pd(s),s=s.next;while(s!==c)}t.action=null}function Pd(t){t=t.listeners;for(var s=0;s<t.length;s++)(0,t[s])()}function Ld(t,s){return s}function Od(t,s){if(Re){var r=Ue.formState;if(r!==null){e:{var c=be;if(Re){if(ze){t:{for(var f=ze,p=di;f.nodeType!==8;){if(!p){f=null;break t}if(f=ci(f.nextSibling),f===null){f=null;break t}}p=f.data,f=p==="F!"||p==="F"?f:null}if(f){ze=ci(f.nextSibling),c=f.data==="F!";break e}}zs(c)}c=!1}c&&(s=r[0])}}return r=Rt(),r.memoizedState=r.baseState=s,c={pending:null,lanes:0,dispatch:null,lastRenderedReducer:Ld,lastRenderedState:s},r.queue=c,r=t0.bind(null,be,c),c.dispatch=r,c=jc(!1),p=eh.bind(null,be,!1,c.queue),c=Rt(),f={state:s,dispatch:null,action:t,pending:null},c.queue=f,r=Ov.bind(null,be,f,p,r),f.dispatch=r,c.memoizedState=t,[s,r,!1]}function Fd(t){var s=Ke();return Ud(s,De,t)}function Ud(t,s,r){if(s=Yc(t,s,Ld)[0],t=mr(Li)[0],typeof s=="object"&&s!==null&&typeof s.then=="function")try{var c=Qa(s)}catch(S){throw S===Va?hr:S}else c=s;s=Ke();var f=s.queue,p=f.dispatch;return r!==s.memoizedState&&(be.flags|=2048,Gn(9,yr(),Fv.bind(null,f,r),null)),[c,p,t]}function Fv(t,s){t.action=s}function Nd(t){var s=Ke(),r=De;if(r!==null)return Ud(s,r,t);Ke(),s=s.memoizedState,r=Ke();var c=r.queue.dispatch;return r.memoizedState=t,[s,c,!1]}function Gn(t,s,r,c){return t={tag:t,create:r,deps:c,inst:s,next:null},s=be.updateQueue,s===null&&(s=Xc(),be.updateQueue=s),r=s.lastEffect,r===null?s.lastEffect=t.next=t:(c=r.next,r.next=t,t.next=c,s.lastEffect=t),t}function yr(){return{destroy:void 0,resource:void 0}}function Hd(){return Ke().memoizedState}function vr(t,s,r,c){var f=Rt();c=c===void 0?null:c,be.flags|=t,f.memoizedState=Gn(1|s,yr(),r,c)}function $a(t,s,r,c){var f=Ke();c=c===void 0?null:c;var p=f.memoizedState.inst;De!==null&&c!==null&&Nc(c,De.memoizedState.deps)?f.memoizedState=Gn(s,p,r,c):(be.flags|=t,f.memoizedState=Gn(1|s,p,r,c))}function Wd(t,s){vr(8390656,8,t,s)}function Gd(t,s){$a(2048,8,t,s)}function zd(t,s){return $a(4,2,t,s)}function Xd(t,s){return $a(4,4,t,s)}function Vd(t,s){if(typeof s=="function"){t=t();var r=s(t);return function(){typeof r=="function"?r():s(null)}}if(s!=null)return t=t(),s.current=t,function(){s.current=null}}function Yd(t,s,r){r=r!=null?r.concat([t]):null,$a(4,4,Vd.bind(null,s,t),r)}function Zc(){}function qd(t,s){var r=Ke();s=s===void 0?null:s;var c=r.memoizedState;return s!==null&&Nc(s,c[1])?c[0]:(r.memoizedState=[t,s],t)}function jd(t,s){var r=Ke();s=s===void 0?null:s;var c=r.memoizedState;if(s!==null&&Nc(s,c[1]))return c[0];if(c=t(),qs){$i(!0);try{t()}finally{$i(!1)}}return r.memoizedState=[c,s],c}function Qc(t,s,r){return r===void 0||(as&1073741824)!==0?t.memoizedState=s:(t.memoizedState=r,t=Q0(),be.lanes|=t,fs|=t,r)}function Kd(t,s,r,c){return Lt(r,s)?r:Nn.current!==null?(t=Qc(t,r,c),Lt(t,s)||(et=!0),t):(as&42)===0?(et=!0,t.memoizedState=r):(t=Q0(),be.lanes|=t,fs|=t,s)}function Zd(t,s,r,c,f){var p=z.p;z.p=p!==0&&8>p?p:8;var S=_.T,T={};_.T=T,eh(t,!1,s,r);try{var R=f(),O=_.S;if(O!==null&&O(T,R),R!==null&&typeof R=="object"&&typeof R.then=="function"){var V=Dv(R,c);Ja(t,s,V,Ht(t))}else Ja(t,s,c,Ht(t))}catch(j){Ja(t,s,{then:function(){},status:"rejected",reason:j},Ht())}finally{z.p=p,_.T=S}}function Uv(){}function $c(t,s,r,c){if(t.tag!==5)throw Error(n(476));var f=Qd(t).queue;Zd(t,f,s,se,r===null?Uv:function(){return $d(t),r(c)})}function Qd(t){var s=t.memoizedState;if(s!==null)return s;s={memoizedState:se,baseState:se,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Li,lastRenderedState:se},next:null};var r={};return s.next={memoizedState:r,baseState:r,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:Li,lastRenderedState:r},next:null},t.memoizedState=s,t=t.alternate,t!==null&&(t.memoizedState=s),s}function $d(t){var s=Qd(t).next.queue;Ja(t,s,{},Ht())}function Jc(){return gt(vo)}function Jd(){return Ke().memoizedState}function e0(){return Ke().memoizedState}function Nv(t){for(var s=t.return;s!==null;){switch(s.tag){case 24:case 3:var r=Ht();t=ss(r);var c=ns(s,t,r);c!==null&&(Wt(c,s,r),qa(c,s,r)),s={cache:Bc()},t.payload=s;return}s=s.return}}function Hv(t,s,r){var c=Ht();r={lane:c,revertLane:0,action:r,hasEagerState:!1,eagerState:null,next:null},br(t)?i0(s,r):(r=bc(t,s,r,c),r!==null&&(Wt(r,t,c),s0(r,s,c)))}function t0(t,s,r){var c=Ht();Ja(t,s,r,c)}function Ja(t,s,r,c){var f={lane:c,revertLane:0,action:r,hasEagerState:!1,eagerState:null,next:null};if(br(t))i0(s,f);else{var p=t.alternate;if(t.lanes===0&&(p===null||p.lanes===0)&&(p=s.lastRenderedReducer,p!==null))try{var S=s.lastRenderedState,T=p(S,r);if(f.hasEagerState=!0,f.eagerState=T,Lt(T,S))return ir(t,s,f,0),Ue===null&&tr(),!1}catch{}finally{}if(r=bc(t,s,f,c),r!==null)return Wt(r,t,c),s0(r,s,c),!0}return!1}function eh(t,s,r,c){if(c={lane:2,revertLane:_h(),action:c,hasEagerState:!1,eagerState:null,next:null},br(t)){if(s)throw Error(n(479))}else s=bc(t,r,c,2),s!==null&&Wt(s,t,2)}function br(t){var s=t.alternate;return t===be||s!==null&&s===be}function i0(t,s){Hn=dr=!0;var r=t.pending;r===null?s.next=s:(s.next=r.next,r.next=s),t.pending=s}function s0(t,s,r){if((r&4194048)!==0){var c=s.lanes;c&=t.pendingLanes,r|=c,s.lanes=r,uf(t,r)}}var Sr={readContext:gt,use:pr,useCallback:Ve,useContext:Ve,useEffect:Ve,useImperativeHandle:Ve,useLayoutEffect:Ve,useInsertionEffect:Ve,useMemo:Ve,useReducer:Ve,useRef:Ve,useState:Ve,useDebugValue:Ve,useDeferredValue:Ve,useTransition:Ve,useSyncExternalStore:Ve,useId:Ve,useHostTransitionStatus:Ve,useFormState:Ve,useActionState:Ve,useOptimistic:Ve,useMemoCache:Ve,useCacheRefresh:Ve},n0={readContext:gt,use:pr,useCallback:function(t,s){return Rt().memoizedState=[t,s===void 0?null:s],t},useContext:gt,useEffect:Wd,useImperativeHandle:function(t,s,r){r=r!=null?r.concat([t]):null,vr(4194308,4,Vd.bind(null,s,t),r)},useLayoutEffect:function(t,s){return vr(4194308,4,t,s)},useInsertionEffect:function(t,s){vr(4,2,t,s)},useMemo:function(t,s){var r=Rt();s=s===void 0?null:s;var c=t();if(qs){$i(!0);try{t()}finally{$i(!1)}}return r.memoizedState=[c,s],c},useReducer:function(t,s,r){var c=Rt();if(r!==void 0){var f=r(s);if(qs){$i(!0);try{r(s)}finally{$i(!1)}}}else f=s;return c.memoizedState=c.baseState=f,t={pending:null,lanes:0,dispatch:null,lastRenderedReducer:t,lastRenderedState:f},c.queue=t,t=t.dispatch=Hv.bind(null,be,t),[c.memoizedState,t]},useRef:function(t){var s=Rt();return t={current:t},s.memoizedState=t},useState:function(t){t=jc(t);var s=t.queue,r=t0.bind(null,be,s);return s.dispatch=r,[t.memoizedState,r]},useDebugValue:Zc,useDeferredValue:function(t,s){var r=Rt();return Qc(r,t,s)},useTransition:function(){var t=jc(!1);return t=Zd.bind(null,be,t.queue,!0,!1),Rt().memoizedState=t,[!1,t]},useSyncExternalStore:function(t,s,r){var c=be,f=Rt();if(Re){if(r===void 0)throw Error(n(407));r=r()}else{if(r=s(),Ue===null)throw Error(n(349));(we&124)!==0||Ad(c,s,r)}f.memoizedState=r;var p={value:r,getSnapshot:s};return f.queue=p,Wd(Rd.bind(null,c,p,t),[t]),c.flags|=2048,Gn(9,yr(),kd.bind(null,c,p,r,s),null),r},useId:function(){var t=Rt(),s=Ue.identifierPrefix;if(Re){var r=_i,c=xi;r=(c&~(1<<32-Pt(c)-1)).toString(32)+r,s=""+s+"R"+r,r=gr++,0<r&&(s+="H"+r.toString(32)),s+=""}else r=Pv++,s=""+s+"r"+r.toString(32)+"";return t.memoizedState=s},useHostTransitionStatus:Jc,useFormState:Od,useActionState:Od,useOptimistic:function(t){var s=Rt();s.memoizedState=s.baseState=t;var r={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return s.queue=r,s=eh.bind(null,be,!0,r),r.dispatch=s,[t,s]},useMemoCache:Vc,useCacheRefresh:function(){return Rt().memoizedState=Nv.bind(null,be)}},a0={readContext:gt,use:pr,useCallback:qd,useContext:gt,useEffect:Gd,useImperativeHandle:Yd,useInsertionEffect:zd,useLayoutEffect:Xd,useMemo:jd,useReducer:mr,useRef:Hd,useState:function(){return mr(Li)},useDebugValue:Zc,useDeferredValue:function(t,s){var r=Ke();return Kd(r,De.memoizedState,t,s)},useTransition:function(){var t=mr(Li)[0],s=Ke().memoizedState;return[typeof t=="boolean"?t:Qa(t),s]},useSyncExternalStore:wd,useId:Jd,useHostTransitionStatus:Jc,useFormState:Fd,useActionState:Fd,useOptimistic:function(t,s){var r=Ke();return Id(r,De,t,s)},useMemoCache:Vc,useCacheRefresh:e0},Wv={readContext:gt,use:pr,useCallback:qd,useContext:gt,useEffect:Gd,useImperativeHandle:Yd,useInsertionEffect:zd,useLayoutEffect:Xd,useMemo:jd,useReducer:qc,useRef:Hd,useState:function(){return qc(Li)},useDebugValue:Zc,useDeferredValue:function(t,s){var r=Ke();return De===null?Qc(r,t,s):Kd(r,De.memoizedState,t,s)},useTransition:function(){var t=qc(Li)[0],s=Ke().memoizedState;return[typeof t=="boolean"?t:Qa(t),s]},useSyncExternalStore:wd,useId:Jd,useHostTransitionStatus:Jc,useFormState:Nd,useActionState:Nd,useOptimistic:function(t,s){var r=Ke();return De!==null?Id(r,De,t,s):(r.baseState=t,[t,r.queue.dispatch])},useMemoCache:Vc,useCacheRefresh:e0},zn=null,eo=0;function Mr(t){var s=eo;return eo+=1,zn===null&&(zn=[]),md(zn,t,s)}function to(t,s){s=s.props.ref,t.ref=s!==void 0?s:null}function Cr(t,s){throw s.$$typeof===y?Error(n(525)):(t=Object.prototype.toString.call(s),Error(n(31,t==="[object Object]"?"object with keys {"+Object.keys(s).join(", ")+"}":t)))}function o0(t){var s=t._init;return s(t._payload)}function r0(t){function s(P,B){if(t){var L=P.deletions;L===null?(P.deletions=[B],P.flags|=16):L.push(B)}}function r(P,B){if(!t)return null;for(;B!==null;)s(P,B),B=B.sibling;return null}function c(P){for(var B=new Map;P!==null;)P.key!==null?B.set(P.key,P):B.set(P.index,P),P=P.sibling;return B}function f(P,B){return P=Ii(P,B),P.index=0,P.sibling=null,P}function p(P,B,L){return P.index=L,t?(L=P.alternate,L!==null?(L=L.index,L<B?(P.flags|=67108866,B):L):(P.flags|=67108866,B)):(P.flags|=1048576,B)}function S(P){return t&&P.alternate===null&&(P.flags|=67108866),P}function T(P,B,L,q){return B===null||B.tag!==6?(B=Mc(L,P.mode,q),B.return=P,B):(B=f(B,L),B.return=P,B)}function R(P,B,L,q){var le=L.type;return le===b?V(P,B,L.props.children,q,L.key):B!==null&&(B.elementType===le||typeof le=="object"&&le!==null&&le.$$typeof===W&&o0(le)===B.type)?(B=f(B,L.props),to(B,L),B.return=P,B):(B=nr(L.type,L.key,L.props,null,P.mode,q),to(B,L),B.return=P,B)}function O(P,B,L,q){return B===null||B.tag!==4||B.stateNode.containerInfo!==L.containerInfo||B.stateNode.implementation!==L.implementation?(B=Cc(L,P.mode,q),B.return=P,B):(B=f(B,L.children||[]),B.return=P,B)}function V(P,B,L,q,le){return B===null||B.tag!==7?(B=Ns(L,P.mode,q,le),B.return=P,B):(B=f(B,L),B.return=P,B)}function j(P,B,L){if(typeof B=="string"&&B!==""||typeof B=="number"||typeof B=="bigint")return B=Mc(""+B,P.mode,L),B.return=P,B;if(typeof B=="object"&&B!==null){switch(B.$$typeof){case v:return L=nr(B.type,B.key,B.props,null,P.mode,L),to(L,B),L.return=P,L;case M:return B=Cc(B,P.mode,L),B.return=P,B;case W:var q=B._init;return B=q(B._payload),j(P,B,L)}if(ee(B)||Y(B))return B=Ns(B,P.mode,L,null),B.return=P,B;if(typeof B.then=="function")return j(P,Mr(B),L);if(B.$$typeof===x)return j(P,lr(P,B),L);Cr(P,B)}return null}function F(P,B,L,q){var le=B!==null?B.key:null;if(typeof L=="string"&&L!==""||typeof L=="number"||typeof L=="bigint")return le!==null?null:T(P,B,""+L,q);if(typeof L=="object"&&L!==null){switch(L.$$typeof){case v:return L.key===le?R(P,B,L,q):null;case M:return L.key===le?O(P,B,L,q):null;case W:return le=L._init,L=le(L._payload),F(P,B,L,q)}if(ee(L)||Y(L))return le!==null?null:V(P,B,L,q,null);if(typeof L.then=="function")return F(P,B,Mr(L),q);if(L.$$typeof===x)return F(P,B,lr(P,L),q);Cr(P,L)}return null}function U(P,B,L,q,le){if(typeof q=="string"&&q!==""||typeof q=="number"||typeof q=="bigint")return P=P.get(L)||null,T(B,P,""+q,le);if(typeof q=="object"&&q!==null){switch(q.$$typeof){case v:return P=P.get(q.key===null?L:q.key)||null,R(B,P,q,le);case M:return P=P.get(q.key===null?L:q.key)||null,O(B,P,q,le);case W:var Se=q._init;return q=Se(q._payload),U(P,B,L,q,le)}if(ee(q)||Y(q))return P=P.get(L)||null,V(B,P,q,le,null);if(typeof q.then=="function")return U(P,B,L,Mr(q),le);if(q.$$typeof===x)return U(P,B,L,lr(B,q),le);Cr(B,q)}return null}function ge(P,B,L,q){for(var le=null,Se=null,ce=B,de=B=0,it=null;ce!==null&&de<L.length;de++){ce.index>de?(it=ce,ce=null):it=ce.sibling;var Ae=F(P,ce,L[de],q);if(Ae===null){ce===null&&(ce=it);break}t&&ce&&Ae.alternate===null&&s(P,ce),B=p(Ae,B,de),Se===null?le=Ae:Se.sibling=Ae,Se=Ae,ce=it}if(de===L.length)return r(P,ce),Re&&Ws(P,de),le;if(ce===null){for(;de<L.length;de++)ce=j(P,L[de],q),ce!==null&&(B=p(ce,B,de),Se===null?le=ce:Se.sibling=ce,Se=ce);return Re&&Ws(P,de),le}for(ce=c(ce);de<L.length;de++)it=U(ce,P,de,L[de],q),it!==null&&(t&&it.alternate!==null&&ce.delete(it.key===null?de:it.key),B=p(it,B,de),Se===null?le=it:Se.sibling=it,Se=it);return t&&ce.forEach(function(Ms){return s(P,Ms)}),Re&&Ws(P,de),le}function fe(P,B,L,q){if(L==null)throw Error(n(151));for(var le=null,Se=null,ce=B,de=B=0,it=null,Ae=L.next();ce!==null&&!Ae.done;de++,Ae=L.next()){ce.index>de?(it=ce,ce=null):it=ce.sibling;var Ms=F(P,ce,Ae.value,q);if(Ms===null){ce===null&&(ce=it);break}t&&ce&&Ms.alternate===null&&s(P,ce),B=p(Ms,B,de),Se===null?le=Ms:Se.sibling=Ms,Se=Ms,ce=it}if(Ae.done)return r(P,ce),Re&&Ws(P,de),le;if(ce===null){for(;!Ae.done;de++,Ae=L.next())Ae=j(P,Ae.value,q),Ae!==null&&(B=p(Ae,B,de),Se===null?le=Ae:Se.sibling=Ae,Se=Ae);return Re&&Ws(P,de),le}for(ce=c(ce);!Ae.done;de++,Ae=L.next())Ae=U(ce,P,de,Ae.value,q),Ae!==null&&(t&&Ae.alternate!==null&&ce.delete(Ae.key===null?de:Ae.key),B=p(Ae,B,de),Se===null?le=Ae:Se.sibling=Ae,Se=Ae);return t&&ce.forEach(function(Gb){return s(P,Gb)}),Re&&Ws(P,de),le}function Le(P,B,L,q){if(typeof L=="object"&&L!==null&&L.type===b&&L.key===null&&(L=L.props.children),typeof L=="object"&&L!==null){switch(L.$$typeof){case v:e:{for(var le=L.key;B!==null;){if(B.key===le){if(le=L.type,le===b){if(B.tag===7){r(P,B.sibling),q=f(B,L.props.children),q.return=P,P=q;break e}}else if(B.elementType===le||typeof le=="object"&&le!==null&&le.$$typeof===W&&o0(le)===B.type){r(P,B.sibling),q=f(B,L.props),to(q,L),q.return=P,P=q;break e}r(P,B);break}else s(P,B);B=B.sibling}L.type===b?(q=Ns(L.props.children,P.mode,q,L.key),q.return=P,P=q):(q=nr(L.type,L.key,L.props,null,P.mode,q),to(q,L),q.return=P,P=q)}return S(P);case M:e:{for(le=L.key;B!==null;){if(B.key===le)if(B.tag===4&&B.stateNode.containerInfo===L.containerInfo&&B.stateNode.implementation===L.implementation){r(P,B.sibling),q=f(B,L.children||[]),q.return=P,P=q;break e}else{r(P,B);break}else s(P,B);B=B.sibling}q=Cc(L,P.mode,q),q.return=P,P=q}return S(P);case W:return le=L._init,L=le(L._payload),Le(P,B,L,q)}if(ee(L))return ge(P,B,L,q);if(Y(L)){if(le=Y(L),typeof le!="function")throw Error(n(150));return L=le.call(L),fe(P,B,L,q)}if(typeof L.then=="function")return Le(P,B,Mr(L),q);if(L.$$typeof===x)return Le(P,B,lr(P,L),q);Cr(P,L)}return typeof L=="string"&&L!==""||typeof L=="number"||typeof L=="bigint"?(L=""+L,B!==null&&B.tag===6?(r(P,B.sibling),q=f(B,L),q.return=P,P=q):(r(P,B),q=Mc(L,P.mode,q),q.return=P,P=q),S(P)):r(P,B)}return function(P,B,L,q){try{eo=0;var le=Le(P,B,L,q);return zn=null,le}catch(ce){if(ce===Va||ce===hr)throw ce;var Se=Ot(29,ce,null,P.mode);return Se.lanes=q,Se.return=P,Se}finally{}}}var Xn=r0(!0),l0=r0(!1),$t=G(null),gi=null;function os(t){var s=t.alternate;ie($e,$e.current&1),ie($t,t),gi===null&&(s===null||Nn.current!==null||s.memoizedState!==null)&&(gi=t)}function c0(t){if(t.tag===22){if(ie($e,$e.current),ie($t,t),gi===null){var s=t.alternate;s!==null&&s.memoizedState!==null&&(gi=t)}}else rs()}function rs(){ie($e,$e.current),ie($t,$t.current)}function Oi(t){te($t),gi===t&&(gi=null),te($e)}var $e=G(0);function Tr(t){for(var s=t;s!==null;){if(s.tag===13){var r=s.memoizedState;if(r!==null&&(r=r.dehydrated,r===null||r.data==="$?"||Xh(r)))return s}else if(s.tag===19&&s.memoizedProps.revealOrder!==void 0){if((s.flags&128)!==0)return s}else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===t)break;for(;s.sibling===null;){if(s.return===null||s.return===t)return null;s=s.return}s.sibling.return=s.return,s=s.sibling}return null}function th(t,s,r,c){s=t.memoizedState,r=r(c,s),r=r==null?s:m({},s,r),t.memoizedState=r,t.lanes===0&&(t.updateQueue.baseState=r)}var ih={enqueueSetState:function(t,s,r){t=t._reactInternals;var c=Ht(),f=ss(c);f.payload=s,r!=null&&(f.callback=r),s=ns(t,f,c),s!==null&&(Wt(s,t,c),qa(s,t,c))},enqueueReplaceState:function(t,s,r){t=t._reactInternals;var c=Ht(),f=ss(c);f.tag=1,f.payload=s,r!=null&&(f.callback=r),s=ns(t,f,c),s!==null&&(Wt(s,t,c),qa(s,t,c))},enqueueForceUpdate:function(t,s){t=t._reactInternals;var r=Ht(),c=ss(r);c.tag=2,s!=null&&(c.callback=s),s=ns(t,c,r),s!==null&&(Wt(s,t,r),qa(s,t,r))}};function h0(t,s,r,c,f,p,S){return t=t.stateNode,typeof t.shouldComponentUpdate=="function"?t.shouldComponentUpdate(c,p,S):s.prototype&&s.prototype.isPureReactComponent?!Fa(r,c)||!Fa(f,p):!0}function u0(t,s,r,c){t=s.state,typeof s.componentWillReceiveProps=="function"&&s.componentWillReceiveProps(r,c),typeof s.UNSAFE_componentWillReceiveProps=="function"&&s.UNSAFE_componentWillReceiveProps(r,c),s.state!==t&&ih.enqueueReplaceState(s,s.state,null)}function js(t,s){var r=s;if("ref"in s){r={};for(var c in s)c!=="ref"&&(r[c]=s[c])}if(t=t.defaultProps){r===s&&(r=m({},r));for(var f in t)r[f]===void 0&&(r[f]=t[f])}return r}var wr=typeof reportError=="function"?reportError:function(t){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var s=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof t=="object"&&t!==null&&typeof t.message=="string"?String(t.message):String(t),error:t});if(!window.dispatchEvent(s))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",t);return}console.error(t)};function f0(t){wr(t)}function d0(t){console.error(t)}function g0(t){wr(t)}function Ar(t,s){try{var r=t.onUncaughtError;r(s.value,{componentStack:s.stack})}catch(c){setTimeout(function(){throw c})}}function p0(t,s,r){try{var c=t.onCaughtError;c(r.value,{componentStack:r.stack,errorBoundary:s.tag===1?s.stateNode:null})}catch(f){setTimeout(function(){throw f})}}function sh(t,s,r){return r=ss(r),r.tag=3,r.payload={element:null},r.callback=function(){Ar(t,s)},r}function m0(t){return t=ss(t),t.tag=3,t}function y0(t,s,r,c){var f=r.type.getDerivedStateFromError;if(typeof f=="function"){var p=c.value;t.payload=function(){return f(p)},t.callback=function(){p0(s,r,c)}}var S=r.stateNode;S!==null&&typeof S.componentDidCatch=="function"&&(t.callback=function(){p0(s,r,c),typeof f!="function"&&(ds===null?ds=new Set([this]):ds.add(this));var T=c.stack;this.componentDidCatch(c.value,{componentStack:T!==null?T:""})})}function Gv(t,s,r,c,f){if(r.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){if(s=r.alternate,s!==null&&Ga(s,r,f,!0),r=$t.current,r!==null){switch(r.tag){case 13:return gi===null?Rh():r.alternate===null&&Xe===0&&(Xe=3),r.flags&=-257,r.flags|=65536,r.lanes=f,c===_c?r.flags|=16384:(s=r.updateQueue,s===null?r.updateQueue=new Set([c]):s.add(c),Bh(t,c,f)),!1;case 22:return r.flags|=65536,c===_c?r.flags|=16384:(s=r.updateQueue,s===null?(s={transitions:null,markerInstances:null,retryQueue:new Set([c])},r.updateQueue=s):(r=s.retryQueue,r===null?s.retryQueue=new Set([c]):r.add(c)),Bh(t,c,f)),!1}throw Error(n(435,r.tag))}return Bh(t,c,f),Rh(),!1}if(Re)return s=$t.current,s!==null?((s.flags&65536)===0&&(s.flags|=256),s.flags|=65536,s.lanes=f,c!==Ac&&(t=Error(n(422),{cause:c}),Wa(jt(t,r)))):(c!==Ac&&(s=Error(n(423),{cause:c}),Wa(jt(s,r))),t=t.current.alternate,t.flags|=65536,f&=-f,t.lanes|=f,c=jt(c,r),f=sh(t.stateNode,c,f),Lc(t,f),Xe!==4&&(Xe=2)),!1;var p=Error(n(520),{cause:c});if(p=jt(p,r),lo===null?lo=[p]:lo.push(p),Xe!==4&&(Xe=2),s===null)return!0;c=jt(c,r),r=s;do{switch(r.tag){case 3:return r.flags|=65536,t=f&-f,r.lanes|=t,t=sh(r.stateNode,c,t),Lc(r,t),!1;case 1:if(s=r.type,p=r.stateNode,(r.flags&128)===0&&(typeof s.getDerivedStateFromError=="function"||p!==null&&typeof p.componentDidCatch=="function"&&(ds===null||!ds.has(p))))return r.flags|=65536,f&=-f,r.lanes|=f,f=m0(f),y0(f,t,r,c),Lc(r,f),!1}r=r.return}while(r!==null);return!1}var v0=Error(n(461)),et=!1;function st(t,s,r,c){s.child=t===null?l0(s,null,r,c):Xn(s,t.child,r,c)}function b0(t,s,r,c,f){r=r.render;var p=s.ref;if("ref"in c){var S={};for(var T in c)T!=="ref"&&(S[T]=c[T])}else S=c;return Vs(s),c=Hc(t,s,r,S,p,f),T=Wc(),t!==null&&!et?(Gc(t,s,f),Fi(t,s,f)):(Re&&T&&Tc(s),s.flags|=1,st(t,s,c,f),s.child)}function S0(t,s,r,c,f){if(t===null){var p=r.type;return typeof p=="function"&&!Sc(p)&&p.defaultProps===void 0&&r.compare===null?(s.tag=15,s.type=p,M0(t,s,p,c,f)):(t=nr(r.type,null,c,s,s.mode,f),t.ref=s.ref,t.return=s,s.child=t)}if(p=t.child,!uh(t,f)){var S=p.memoizedProps;if(r=r.compare,r=r!==null?r:Fa,r(S,c)&&t.ref===s.ref)return Fi(t,s,f)}return s.flags|=1,t=Ii(p,c),t.ref=s.ref,t.return=s,s.child=t}function M0(t,s,r,c,f){if(t!==null){var p=t.memoizedProps;if(Fa(p,c)&&t.ref===s.ref)if(et=!1,s.pendingProps=c=p,uh(t,f))(t.flags&131072)!==0&&(et=!0);else return s.lanes=t.lanes,Fi(t,s,f)}return nh(t,s,r,c,f)}function C0(t,s,r){var c=s.pendingProps,f=c.children,p=t!==null?t.memoizedState:null;if(c.mode==="hidden"){if((s.flags&128)!==0){if(c=p!==null?p.baseLanes|r:r,t!==null){for(f=s.child=t.child,p=0;f!==null;)p=p|f.lanes|f.childLanes,f=f.sibling;s.childLanes=p&~c}else s.childLanes=0,s.child=null;return T0(t,s,c,r)}if((r&536870912)!==0)s.memoizedState={baseLanes:0,cachePool:null},t!==null&&cr(s,p!==null?p.cachePool:null),p!==null?Md(s,p):Fc(),c0(s);else return s.lanes=s.childLanes=536870912,T0(t,s,p!==null?p.baseLanes|r:r,r)}else p!==null?(cr(s,p.cachePool),Md(s,p),rs(),s.memoizedState=null):(t!==null&&cr(s,null),Fc(),rs());return st(t,s,f,r),s.child}function T0(t,s,r,c){var f=xc();return f=f===null?null:{parent:Qe._currentValue,pool:f},s.memoizedState={baseLanes:r,cachePool:f},t!==null&&cr(s,null),Fc(),c0(s),t!==null&&Ga(t,s,c,!0),null}function kr(t,s){var r=s.ref;if(r===null)t!==null&&t.ref!==null&&(s.flags|=4194816);else{if(typeof r!="function"&&typeof r!="object")throw Error(n(284));(t===null||t.ref!==r)&&(s.flags|=4194816)}}function nh(t,s,r,c,f){return Vs(s),r=Hc(t,s,r,c,void 0,f),c=Wc(),t!==null&&!et?(Gc(t,s,f),Fi(t,s,f)):(Re&&c&&Tc(s),s.flags|=1,st(t,s,r,f),s.child)}function w0(t,s,r,c,f,p){return Vs(s),s.updateQueue=null,r=Td(s,c,r,f),Cd(t),c=Wc(),t!==null&&!et?(Gc(t,s,p),Fi(t,s,p)):(Re&&c&&Tc(s),s.flags|=1,st(t,s,r,p),s.child)}function A0(t,s,r,c,f){if(Vs(s),s.stateNode===null){var p=Pn,S=r.contextType;typeof S=="object"&&S!==null&&(p=gt(S)),p=new r(c,p),s.memoizedState=p.state!==null&&p.state!==void 0?p.state:null,p.updater=ih,s.stateNode=p,p._reactInternals=s,p=s.stateNode,p.props=c,p.state=s.memoizedState,p.refs={},Dc(s),S=r.contextType,p.context=typeof S=="object"&&S!==null?gt(S):Pn,p.state=s.memoizedState,S=r.getDerivedStateFromProps,typeof S=="function"&&(th(s,r,S,c),p.state=s.memoizedState),typeof r.getDerivedStateFromProps=="function"||typeof p.getSnapshotBeforeUpdate=="function"||typeof p.UNSAFE_componentWillMount!="function"&&typeof p.componentWillMount!="function"||(S=p.state,typeof p.componentWillMount=="function"&&p.componentWillMount(),typeof p.UNSAFE_componentWillMount=="function"&&p.UNSAFE_componentWillMount(),S!==p.state&&ih.enqueueReplaceState(p,p.state,null),Ka(s,c,p,f),ja(),p.state=s.memoizedState),typeof p.componentDidMount=="function"&&(s.flags|=4194308),c=!0}else if(t===null){p=s.stateNode;var T=s.memoizedProps,R=js(r,T);p.props=R;var O=p.context,V=r.contextType;S=Pn,typeof V=="object"&&V!==null&&(S=gt(V));var j=r.getDerivedStateFromProps;V=typeof j=="function"||typeof p.getSnapshotBeforeUpdate=="function",T=s.pendingProps!==T,V||typeof p.UNSAFE_componentWillReceiveProps!="function"&&typeof p.componentWillReceiveProps!="function"||(T||O!==S)&&u0(s,p,c,S),is=!1;var F=s.memoizedState;p.state=F,Ka(s,c,p,f),ja(),O=s.memoizedState,T||F!==O||is?(typeof j=="function"&&(th(s,r,j,c),O=s.memoizedState),(R=is||h0(s,r,R,c,F,O,S))?(V||typeof p.UNSAFE_componentWillMount!="function"&&typeof p.componentWillMount!="function"||(typeof p.componentWillMount=="function"&&p.componentWillMount(),typeof p.UNSAFE_componentWillMount=="function"&&p.UNSAFE_componentWillMount()),typeof p.componentDidMount=="function"&&(s.flags|=4194308)):(typeof p.componentDidMount=="function"&&(s.flags|=4194308),s.memoizedProps=c,s.memoizedState=O),p.props=c,p.state=O,p.context=S,c=R):(typeof p.componentDidMount=="function"&&(s.flags|=4194308),c=!1)}else{p=s.stateNode,Pc(t,s),S=s.memoizedProps,V=js(r,S),p.props=V,j=s.pendingProps,F=p.context,O=r.contextType,R=Pn,typeof O=="object"&&O!==null&&(R=gt(O)),T=r.getDerivedStateFromProps,(O=typeof T=="function"||typeof p.getSnapshotBeforeUpdate=="function")||typeof p.UNSAFE_componentWillReceiveProps!="function"&&typeof p.componentWillReceiveProps!="function"||(S!==j||F!==R)&&u0(s,p,c,R),is=!1,F=s.memoizedState,p.state=F,Ka(s,c,p,f),ja();var U=s.memoizedState;S!==j||F!==U||is||t!==null&&t.dependencies!==null&&rr(t.dependencies)?(typeof T=="function"&&(th(s,r,T,c),U=s.memoizedState),(V=is||h0(s,r,V,c,F,U,R)||t!==null&&t.dependencies!==null&&rr(t.dependencies))?(O||typeof p.UNSAFE_componentWillUpdate!="function"&&typeof p.componentWillUpdate!="function"||(typeof p.componentWillUpdate=="function"&&p.componentWillUpdate(c,U,R),typeof p.UNSAFE_componentWillUpdate=="function"&&p.UNSAFE_componentWillUpdate(c,U,R)),typeof p.componentDidUpdate=="function"&&(s.flags|=4),typeof p.getSnapshotBeforeUpdate=="function"&&(s.flags|=1024)):(typeof p.componentDidUpdate!="function"||S===t.memoizedProps&&F===t.memoizedState||(s.flags|=4),typeof p.getSnapshotBeforeUpdate!="function"||S===t.memoizedProps&&F===t.memoizedState||(s.flags|=1024),s.memoizedProps=c,s.memoizedState=U),p.props=c,p.state=U,p.context=R,c=V):(typeof p.componentDidUpdate!="function"||S===t.memoizedProps&&F===t.memoizedState||(s.flags|=4),typeof p.getSnapshotBeforeUpdate!="function"||S===t.memoizedProps&&F===t.memoizedState||(s.flags|=1024),c=!1)}return p=c,kr(t,s),c=(s.flags&128)!==0,p||c?(p=s.stateNode,r=c&&typeof r.getDerivedStateFromError!="function"?null:p.render(),s.flags|=1,t!==null&&c?(s.child=Xn(s,t.child,null,f),s.child=Xn(s,null,r,f)):st(t,s,r,f),s.memoizedState=p.state,t=s.child):t=Fi(t,s,f),t}function k0(t,s,r,c){return Ha(),s.flags|=256,st(t,s,r,c),s.child}var ah={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function oh(t){return{baseLanes:t,cachePool:dd()}}function rh(t,s,r){return t=t!==null?t.childLanes&~r:0,s&&(t|=Jt),t}function R0(t,s,r){var c=s.pendingProps,f=!1,p=(s.flags&128)!==0,S;if((S=p)||(S=t!==null&&t.memoizedState===null?!1:($e.current&2)!==0),S&&(f=!0,s.flags&=-129),S=(s.flags&32)!==0,s.flags&=-33,t===null){if(Re){if(f?os(s):rs(),Re){var T=ze,R;if(R=T){e:{for(R=T,T=di;R.nodeType!==8;){if(!T){T=null;break e}if(R=ci(R.nextSibling),R===null){T=null;break e}}T=R}T!==null?(s.memoizedState={dehydrated:T,treeContext:Hs!==null?{id:xi,overflow:_i}:null,retryLane:536870912,hydrationErrors:null},R=Ot(18,null,null,0),R.stateNode=T,R.return=s,s.child=R,St=s,ze=null,R=!0):R=!1}R||zs(s)}if(T=s.memoizedState,T!==null&&(T=T.dehydrated,T!==null))return Xh(T)?s.lanes=32:s.lanes=536870912,null;Oi(s)}return T=c.children,c=c.fallback,f?(rs(),f=s.mode,T=Rr({mode:"hidden",children:T},f),c=Ns(c,f,r,null),T.return=s,c.return=s,T.sibling=c,s.child=T,f=s.child,f.memoizedState=oh(r),f.childLanes=rh(t,S,r),s.memoizedState=ah,c):(os(s),lh(s,T))}if(R=t.memoizedState,R!==null&&(T=R.dehydrated,T!==null)){if(p)s.flags&256?(os(s),s.flags&=-257,s=ch(t,s,r)):s.memoizedState!==null?(rs(),s.child=t.child,s.flags|=128,s=null):(rs(),f=c.fallback,T=s.mode,c=Rr({mode:"visible",children:c.children},T),f=Ns(f,T,r,null),f.flags|=2,c.return=s,f.return=s,c.sibling=f,s.child=c,Xn(s,t.child,null,r),c=s.child,c.memoizedState=oh(r),c.childLanes=rh(t,S,r),s.memoizedState=ah,s=f);else if(os(s),Xh(T)){if(S=T.nextSibling&&T.nextSibling.dataset,S)var O=S.dgst;S=O,c=Error(n(419)),c.stack="",c.digest=S,Wa({value:c,source:null,stack:null}),s=ch(t,s,r)}else if(et||Ga(t,s,r,!1),S=(r&t.childLanes)!==0,et||S){if(S=Ue,S!==null&&(c=r&-r,c=(c&42)!==0?1:Vl(c),c=(c&(S.suspendedLanes|r))!==0?0:c,c!==0&&c!==R.retryLane))throw R.retryLane=c,Dn(t,c),Wt(S,t,c),v0;T.data==="$?"||Rh(),s=ch(t,s,r)}else T.data==="$?"?(s.flags|=192,s.child=t.child,s=null):(t=R.treeContext,ze=ci(T.nextSibling),St=s,Re=!0,Gs=null,di=!1,t!==null&&(Zt[Qt++]=xi,Zt[Qt++]=_i,Zt[Qt++]=Hs,xi=t.id,_i=t.overflow,Hs=s),s=lh(s,c.children),s.flags|=4096);return s}return f?(rs(),f=c.fallback,T=s.mode,R=t.child,O=R.sibling,c=Ii(R,{mode:"hidden",children:c.children}),c.subtreeFlags=R.subtreeFlags&65011712,O!==null?f=Ii(O,f):(f=Ns(f,T,r,null),f.flags|=2),f.return=s,c.return=s,c.sibling=f,s.child=c,c=f,f=s.child,T=t.child.memoizedState,T===null?T=oh(r):(R=T.cachePool,R!==null?(O=Qe._currentValue,R=R.parent!==O?{parent:O,pool:O}:R):R=dd(),T={baseLanes:T.baseLanes|r,cachePool:R}),f.memoizedState=T,f.childLanes=rh(t,S,r),s.memoizedState=ah,c):(os(s),r=t.child,t=r.sibling,r=Ii(r,{mode:"visible",children:c.children}),r.return=s,r.sibling=null,t!==null&&(S=s.deletions,S===null?(s.deletions=[t],s.flags|=16):S.push(t)),s.child=r,s.memoizedState=null,r)}function lh(t,s){return s=Rr({mode:"visible",children:s},t.mode),s.return=t,t.child=s}function Rr(t,s){return t=Ot(22,t,null,s),t.lanes=0,t.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null},t}function ch(t,s,r){return Xn(s,t.child,null,r),t=lh(s,s.pendingProps.children),t.flags|=2,s.memoizedState=null,t}function E0(t,s,r){t.lanes|=s;var c=t.alternate;c!==null&&(c.lanes|=s),Rc(t.return,s,r)}function hh(t,s,r,c,f){var p=t.memoizedState;p===null?t.memoizedState={isBackwards:s,rendering:null,renderingStartTime:0,last:c,tail:r,tailMode:f}:(p.isBackwards=s,p.rendering=null,p.renderingStartTime=0,p.last=c,p.tail=r,p.tailMode=f)}function B0(t,s,r){var c=s.pendingProps,f=c.revealOrder,p=c.tail;if(st(t,s,c.children,r),c=$e.current,(c&2)!==0)c=c&1|2,s.flags|=128;else{if(t!==null&&(t.flags&128)!==0)e:for(t=s.child;t!==null;){if(t.tag===13)t.memoizedState!==null&&E0(t,r,s);else if(t.tag===19)E0(t,r,s);else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===s)break e;for(;t.sibling===null;){if(t.return===null||t.return===s)break e;t=t.return}t.sibling.return=t.return,t=t.sibling}c&=1}switch(ie($e,c),f){case"forwards":for(r=s.child,f=null;r!==null;)t=r.alternate,t!==null&&Tr(t)===null&&(f=r),r=r.sibling;r=f,r===null?(f=s.child,s.child=null):(f=r.sibling,r.sibling=null),hh(s,!1,f,r,p);break;case"backwards":for(r=null,f=s.child,s.child=null;f!==null;){if(t=f.alternate,t!==null&&Tr(t)===null){s.child=f;break}t=f.sibling,f.sibling=r,r=f,f=t}hh(s,!0,r,null,p);break;case"together":hh(s,!1,null,null,void 0);break;default:s.memoizedState=null}return s.child}function Fi(t,s,r){if(t!==null&&(s.dependencies=t.dependencies),fs|=s.lanes,(r&s.childLanes)===0)if(t!==null){if(Ga(t,s,r,!1),(r&s.childLanes)===0)return null}else return null;if(t!==null&&s.child!==t.child)throw Error(n(153));if(s.child!==null){for(t=s.child,r=Ii(t,t.pendingProps),s.child=r,r.return=s;t.sibling!==null;)t=t.sibling,r=r.sibling=Ii(t,t.pendingProps),r.return=s;r.sibling=null}return s.child}function uh(t,s){return(t.lanes&s)!==0?!0:(t=t.dependencies,!!(t!==null&&rr(t)))}function zv(t,s,r){switch(s.tag){case 3:Oe(s,s.stateNode.containerInfo),ts(s,Qe,t.memoizedState.cache),Ha();break;case 27:case 5:yn(s);break;case 4:Oe(s,s.stateNode.containerInfo);break;case 10:ts(s,s.type,s.memoizedProps.value);break;case 13:var c=s.memoizedState;if(c!==null)return c.dehydrated!==null?(os(s),s.flags|=128,null):(r&s.child.childLanes)!==0?R0(t,s,r):(os(s),t=Fi(t,s,r),t!==null?t.sibling:null);os(s);break;case 19:var f=(t.flags&128)!==0;if(c=(r&s.childLanes)!==0,c||(Ga(t,s,r,!1),c=(r&s.childLanes)!==0),f){if(c)return B0(t,s,r);s.flags|=128}if(f=s.memoizedState,f!==null&&(f.rendering=null,f.tail=null,f.lastEffect=null),ie($e,$e.current),c)break;return null;case 22:case 23:return s.lanes=0,C0(t,s,r);case 24:ts(s,Qe,t.memoizedState.cache)}return Fi(t,s,r)}function I0(t,s,r){if(t!==null)if(t.memoizedProps!==s.pendingProps)et=!0;else{if(!uh(t,r)&&(s.flags&128)===0)return et=!1,zv(t,s,r);et=(t.flags&131072)!==0}else et=!1,Re&&(s.flags&1048576)!==0&&od(s,or,s.index);switch(s.lanes=0,s.tag){case 16:e:{t=s.pendingProps;var c=s.elementType,f=c._init;if(c=f(c._payload),s.type=c,typeof c=="function")Sc(c)?(t=js(c,t),s.tag=1,s=A0(null,s,c,t,r)):(s.tag=0,s=nh(null,s,c,t,r));else{if(c!=null){if(f=c.$$typeof,f===I){s.tag=11,s=b0(null,s,c,t,r);break e}else if(f===H){s.tag=14,s=S0(null,s,c,t,r);break e}}throw s=J(c)||c,Error(n(306,s,""))}}return s;case 0:return nh(t,s,s.type,s.pendingProps,r);case 1:return c=s.type,f=js(c,s.pendingProps),A0(t,s,c,f,r);case 3:e:{if(Oe(s,s.stateNode.containerInfo),t===null)throw Error(n(387));c=s.pendingProps;var p=s.memoizedState;f=p.element,Pc(t,s),Ka(s,c,null,r);var S=s.memoizedState;if(c=S.cache,ts(s,Qe,c),c!==p.cache&&Ec(s,[Qe],r,!0),ja(),c=S.element,p.isDehydrated)if(p={element:c,isDehydrated:!1,cache:S.cache},s.updateQueue.baseState=p,s.memoizedState=p,s.flags&256){s=k0(t,s,c,r);break e}else if(c!==f){f=jt(Error(n(424)),s),Wa(f),s=k0(t,s,c,r);break e}else{switch(t=s.stateNode.containerInfo,t.nodeType){case 9:t=t.body;break;default:t=t.nodeName==="HTML"?t.ownerDocument.body:t}for(ze=ci(t.firstChild),St=s,Re=!0,Gs=null,di=!0,r=l0(s,null,c,r),s.child=r;r;)r.flags=r.flags&-3|4096,r=r.sibling}else{if(Ha(),c===f){s=Fi(t,s,r);break e}st(t,s,c,r)}s=s.child}return s;case 26:return kr(t,s),t===null?(r=Pg(s.type,null,s.pendingProps,null))?s.memoizedState=r:Re||(r=s.type,t=s.pendingProps,c=Wr(ue.current).createElement(r),c[dt]=s,c[At]=t,at(c,r,t),Je(c),s.stateNode=c):s.memoizedState=Pg(s.type,t.memoizedProps,s.pendingProps,t.memoizedState),null;case 27:return yn(s),t===null&&Re&&(c=s.stateNode=xg(s.type,s.pendingProps,ue.current),St=s,di=!0,f=ze,ms(s.type)?(Vh=f,ze=ci(c.firstChild)):ze=f),st(t,s,s.pendingProps.children,r),kr(t,s),t===null&&(s.flags|=4194304),s.child;case 5:return t===null&&Re&&((f=c=ze)&&(c=yb(c,s.type,s.pendingProps,di),c!==null?(s.stateNode=c,St=s,ze=ci(c.firstChild),di=!1,f=!0):f=!1),f||zs(s)),yn(s),f=s.type,p=s.pendingProps,S=t!==null?t.memoizedProps:null,c=p.children,Wh(f,p)?c=null:S!==null&&Wh(f,S)&&(s.flags|=32),s.memoizedState!==null&&(f=Hc(t,s,Lv,null,null,r),vo._currentValue=f),kr(t,s),st(t,s,c,r),s.child;case 6:return t===null&&Re&&((t=r=ze)&&(r=vb(r,s.pendingProps,di),r!==null?(s.stateNode=r,St=s,ze=null,t=!0):t=!1),t||zs(s)),null;case 13:return R0(t,s,r);case 4:return Oe(s,s.stateNode.containerInfo),c=s.pendingProps,t===null?s.child=Xn(s,null,c,r):st(t,s,c,r),s.child;case 11:return b0(t,s,s.type,s.pendingProps,r);case 7:return st(t,s,s.pendingProps,r),s.child;case 8:return st(t,s,s.pendingProps.children,r),s.child;case 12:return st(t,s,s.pendingProps.children,r),s.child;case 10:return c=s.pendingProps,ts(s,s.type,c.value),st(t,s,c.children,r),s.child;case 9:return f=s.type._context,c=s.pendingProps.children,Vs(s),f=gt(f),c=c(f),s.flags|=1,st(t,s,c,r),s.child;case 14:return S0(t,s,s.type,s.pendingProps,r);case 15:return M0(t,s,s.type,s.pendingProps,r);case 19:return B0(t,s,r);case 31:return c=s.pendingProps,r=s.mode,c={mode:c.mode,children:c.children},t===null?(r=Rr(c,r),r.ref=s.ref,s.child=r,r.return=s,s=r):(r=Ii(t.child,c),r.ref=s.ref,s.child=r,r.return=s,s=r),s;case 22:return C0(t,s,r);case 24:return Vs(s),c=gt(Qe),t===null?(f=xc(),f===null&&(f=Ue,p=Bc(),f.pooledCache=p,p.refCount++,p!==null&&(f.pooledCacheLanes|=r),f=p),s.memoizedState={parent:c,cache:f},Dc(s),ts(s,Qe,f)):((t.lanes&r)!==0&&(Pc(t,s),Ka(s,null,null,r),ja()),f=t.memoizedState,p=s.memoizedState,f.parent!==c?(f={parent:c,cache:c},s.memoizedState=f,s.lanes===0&&(s.memoizedState=s.updateQueue.baseState=f),ts(s,Qe,c)):(c=p.cache,ts(s,Qe,c),c!==f.cache&&Ec(s,[Qe],r,!0))),st(t,s,s.pendingProps.children,r),s.child;case 29:throw s.pendingProps}throw Error(n(156,s.tag))}function Ui(t){t.flags|=4}function x0(t,s){if(s.type!=="stylesheet"||(s.state.loading&4)!==0)t.flags&=-16777217;else if(t.flags|=16777216,!Ng(s)){if(s=$t.current,s!==null&&((we&4194048)===we?gi!==null:(we&62914560)!==we&&(we&536870912)===0||s!==gi))throw Ya=_c,gd;t.flags|=8192}}function Er(t,s){s!==null&&(t.flags|=4),t.flags&16384&&(s=t.tag!==22?cf():536870912,t.lanes|=s,jn|=s)}function io(t,s){if(!Re)switch(t.tailMode){case"hidden":s=t.tail;for(var r=null;s!==null;)s.alternate!==null&&(r=s),s=s.sibling;r===null?t.tail=null:r.sibling=null;break;case"collapsed":r=t.tail;for(var c=null;r!==null;)r.alternate!==null&&(c=r),r=r.sibling;c===null?s||t.tail===null?t.tail=null:t.tail.sibling=null:c.sibling=null}}function Ge(t){var s=t.alternate!==null&&t.alternate.child===t.child,r=0,c=0;if(s)for(var f=t.child;f!==null;)r|=f.lanes|f.childLanes,c|=f.subtreeFlags&65011712,c|=f.flags&65011712,f.return=t,f=f.sibling;else for(f=t.child;f!==null;)r|=f.lanes|f.childLanes,c|=f.subtreeFlags,c|=f.flags,f.return=t,f=f.sibling;return t.subtreeFlags|=c,t.childLanes=r,s}function Xv(t,s,r){var c=s.pendingProps;switch(wc(s),s.tag){case 31:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Ge(s),null;case 1:return Ge(s),null;case 3:return r=s.stateNode,c=null,t!==null&&(c=t.memoizedState.cache),s.memoizedState.cache!==c&&(s.flags|=2048),Pi(Qe),_t(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),(t===null||t.child===null)&&(Na(s)?Ui(s):t===null||t.memoizedState.isDehydrated&&(s.flags&256)===0||(s.flags|=1024,cd())),Ge(s),null;case 26:return r=s.memoizedState,t===null?(Ui(s),r!==null?(Ge(s),x0(s,r)):(Ge(s),s.flags&=-16777217)):r?r!==t.memoizedState?(Ui(s),Ge(s),x0(s,r)):(Ge(s),s.flags&=-16777217):(t.memoizedProps!==c&&Ui(s),Ge(s),s.flags&=-16777217),null;case 27:vn(s),r=ue.current;var f=s.type;if(t!==null&&s.stateNode!=null)t.memoizedProps!==c&&Ui(s);else{if(!c){if(s.stateNode===null)throw Error(n(166));return Ge(s),null}t=re.current,Na(s)?rd(s):(t=xg(f,c,r),s.stateNode=t,Ui(s))}return Ge(s),null;case 5:if(vn(s),r=s.type,t!==null&&s.stateNode!=null)t.memoizedProps!==c&&Ui(s);else{if(!c){if(s.stateNode===null)throw Error(n(166));return Ge(s),null}if(t=re.current,Na(s))rd(s);else{switch(f=Wr(ue.current),t){case 1:t=f.createElementNS("http://www.w3.org/2000/svg",r);break;case 2:t=f.createElementNS("http://www.w3.org/1998/Math/MathML",r);break;default:switch(r){case"svg":t=f.createElementNS("http://www.w3.org/2000/svg",r);break;case"math":t=f.createElementNS("http://www.w3.org/1998/Math/MathML",r);break;case"script":t=f.createElement("div"),t.innerHTML="<script><\/script>",t=t.removeChild(t.firstChild);break;case"select":t=typeof c.is=="string"?f.createElement("select",{is:c.is}):f.createElement("select"),c.multiple?t.multiple=!0:c.size&&(t.size=c.size);break;default:t=typeof c.is=="string"?f.createElement(r,{is:c.is}):f.createElement(r)}}t[dt]=s,t[At]=c;e:for(f=s.child;f!==null;){if(f.tag===5||f.tag===6)t.appendChild(f.stateNode);else if(f.tag!==4&&f.tag!==27&&f.child!==null){f.child.return=f,f=f.child;continue}if(f===s)break e;for(;f.sibling===null;){if(f.return===null||f.return===s)break e;f=f.return}f.sibling.return=f.return,f=f.sibling}s.stateNode=t;e:switch(at(t,r,c),r){case"button":case"input":case"select":case"textarea":t=!!c.autoFocus;break e;case"img":t=!0;break e;default:t=!1}t&&Ui(s)}}return Ge(s),s.flags&=-16777217,null;case 6:if(t&&s.stateNode!=null)t.memoizedProps!==c&&Ui(s);else{if(typeof c!="string"&&s.stateNode===null)throw Error(n(166));if(t=ue.current,Na(s)){if(t=s.stateNode,r=s.memoizedProps,c=null,f=St,f!==null)switch(f.tag){case 27:case 5:c=f.memoizedProps}t[dt]=s,t=!!(t.nodeValue===r||c!==null&&c.suppressHydrationWarning===!0||wg(t.nodeValue,r)),t||zs(s)}else t=Wr(t).createTextNode(c),t[dt]=s,s.stateNode=t}return Ge(s),null;case 13:if(c=s.memoizedState,t===null||t.memoizedState!==null&&t.memoizedState.dehydrated!==null){if(f=Na(s),c!==null&&c.dehydrated!==null){if(t===null){if(!f)throw Error(n(318));if(f=s.memoizedState,f=f!==null?f.dehydrated:null,!f)throw Error(n(317));f[dt]=s}else Ha(),(s.flags&128)===0&&(s.memoizedState=null),s.flags|=4;Ge(s),f=!1}else f=cd(),t!==null&&t.memoizedState!==null&&(t.memoizedState.hydrationErrors=f),f=!0;if(!f)return s.flags&256?(Oi(s),s):(Oi(s),null)}if(Oi(s),(s.flags&128)!==0)return s.lanes=r,s;if(r=c!==null,t=t!==null&&t.memoizedState!==null,r){c=s.child,f=null,c.alternate!==null&&c.alternate.memoizedState!==null&&c.alternate.memoizedState.cachePool!==null&&(f=c.alternate.memoizedState.cachePool.pool);var p=null;c.memoizedState!==null&&c.memoizedState.cachePool!==null&&(p=c.memoizedState.cachePool.pool),p!==f&&(c.flags|=2048)}return r!==t&&r&&(s.child.flags|=8192),Er(s,s.updateQueue),Ge(s),null;case 4:return _t(),t===null&&Oh(s.stateNode.containerInfo),Ge(s),null;case 10:return Pi(s.type),Ge(s),null;case 19:if(te($e),f=s.memoizedState,f===null)return Ge(s),null;if(c=(s.flags&128)!==0,p=f.rendering,p===null)if(c)io(f,!1);else{if(Xe!==0||t!==null&&(t.flags&128)!==0)for(t=s.child;t!==null;){if(p=Tr(t),p!==null){for(s.flags|=128,io(f,!1),t=p.updateQueue,s.updateQueue=t,Er(s,t),s.subtreeFlags=0,t=r,r=s.child;r!==null;)ad(r,t),r=r.sibling;return ie($e,$e.current&1|2),s.child}t=t.sibling}f.tail!==null&&fi()>xr&&(s.flags|=128,c=!0,io(f,!1),s.lanes=4194304)}else{if(!c)if(t=Tr(p),t!==null){if(s.flags|=128,c=!0,t=t.updateQueue,s.updateQueue=t,Er(s,t),io(f,!0),f.tail===null&&f.tailMode==="hidden"&&!p.alternate&&!Re)return Ge(s),null}else 2*fi()-f.renderingStartTime>xr&&r!==536870912&&(s.flags|=128,c=!0,io(f,!1),s.lanes=4194304);f.isBackwards?(p.sibling=s.child,s.child=p):(t=f.last,t!==null?t.sibling=p:s.child=p,f.last=p)}return f.tail!==null?(s=f.tail,f.rendering=s,f.tail=s.sibling,f.renderingStartTime=fi(),s.sibling=null,t=$e.current,ie($e,c?t&1|2:t&1),s):(Ge(s),null);case 22:case 23:return Oi(s),Uc(),c=s.memoizedState!==null,t!==null?t.memoizedState!==null!==c&&(s.flags|=8192):c&&(s.flags|=8192),c?(r&536870912)!==0&&(s.flags&128)===0&&(Ge(s),s.subtreeFlags&6&&(s.flags|=8192)):Ge(s),r=s.updateQueue,r!==null&&Er(s,r.retryQueue),r=null,t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(r=t.memoizedState.cachePool.pool),c=null,s.memoizedState!==null&&s.memoizedState.cachePool!==null&&(c=s.memoizedState.cachePool.pool),c!==r&&(s.flags|=2048),t!==null&&te(Ys),null;case 24:return r=null,t!==null&&(r=t.memoizedState.cache),s.memoizedState.cache!==r&&(s.flags|=2048),Pi(Qe),Ge(s),null;case 25:return null;case 30:return null}throw Error(n(156,s.tag))}function Vv(t,s){switch(wc(s),s.tag){case 1:return t=s.flags,t&65536?(s.flags=t&-65537|128,s):null;case 3:return Pi(Qe),_t(),t=s.flags,(t&65536)!==0&&(t&128)===0?(s.flags=t&-65537|128,s):null;case 26:case 27:case 5:return vn(s),null;case 13:if(Oi(s),t=s.memoizedState,t!==null&&t.dehydrated!==null){if(s.alternate===null)throw Error(n(340));Ha()}return t=s.flags,t&65536?(s.flags=t&-65537|128,s):null;case 19:return te($e),null;case 4:return _t(),null;case 10:return Pi(s.type),null;case 22:case 23:return Oi(s),Uc(),t!==null&&te(Ys),t=s.flags,t&65536?(s.flags=t&-65537|128,s):null;case 24:return Pi(Qe),null;case 25:return null;default:return null}}function _0(t,s){switch(wc(s),s.tag){case 3:Pi(Qe),_t();break;case 26:case 27:case 5:vn(s);break;case 4:_t();break;case 13:Oi(s);break;case 19:te($e);break;case 10:Pi(s.type);break;case 22:case 23:Oi(s),Uc(),t!==null&&te(Ys);break;case 24:Pi(Qe)}}function so(t,s){try{var r=s.updateQueue,c=r!==null?r.lastEffect:null;if(c!==null){var f=c.next;r=f;do{if((r.tag&t)===t){c=void 0;var p=r.create,S=r.inst;c=p(),S.destroy=c}r=r.next}while(r!==f)}}catch(T){Fe(s,s.return,T)}}function ls(t,s,r){try{var c=s.updateQueue,f=c!==null?c.lastEffect:null;if(f!==null){var p=f.next;c=p;do{if((c.tag&t)===t){var S=c.inst,T=S.destroy;if(T!==void 0){S.destroy=void 0,f=s;var R=r,O=T;try{O()}catch(V){Fe(f,R,V)}}}c=c.next}while(c!==p)}}catch(V){Fe(s,s.return,V)}}function D0(t){var s=t.updateQueue;if(s!==null){var r=t.stateNode;try{Sd(s,r)}catch(c){Fe(t,t.return,c)}}}function P0(t,s,r){r.props=js(t.type,t.memoizedProps),r.state=t.memoizedState;try{r.componentWillUnmount()}catch(c){Fe(t,s,c)}}function no(t,s){try{var r=t.ref;if(r!==null){switch(t.tag){case 26:case 27:case 5:var c=t.stateNode;break;case 30:c=t.stateNode;break;default:c=t.stateNode}typeof r=="function"?t.refCleanup=r(c):r.current=c}}catch(f){Fe(t,s,f)}}function pi(t,s){var r=t.ref,c=t.refCleanup;if(r!==null)if(typeof c=="function")try{c()}catch(f){Fe(t,s,f)}finally{t.refCleanup=null,t=t.alternate,t!=null&&(t.refCleanup=null)}else if(typeof r=="function")try{r(null)}catch(f){Fe(t,s,f)}else r.current=null}function L0(t){var s=t.type,r=t.memoizedProps,c=t.stateNode;try{e:switch(s){case"button":case"input":case"select":case"textarea":r.autoFocus&&c.focus();break e;case"img":r.src?c.src=r.src:r.srcSet&&(c.srcset=r.srcSet)}}catch(f){Fe(t,t.return,f)}}function fh(t,s,r){try{var c=t.stateNode;fb(c,t.type,r,s),c[At]=s}catch(f){Fe(t,t.return,f)}}function O0(t){return t.tag===5||t.tag===3||t.tag===26||t.tag===27&&ms(t.type)||t.tag===4}function dh(t){e:for(;;){for(;t.sibling===null;){if(t.return===null||O0(t.return))return null;t=t.return}for(t.sibling.return=t.return,t=t.sibling;t.tag!==5&&t.tag!==6&&t.tag!==18;){if(t.tag===27&&ms(t.type)||t.flags&2||t.child===null||t.tag===4)continue e;t.child.return=t,t=t.child}if(!(t.flags&2))return t.stateNode}}function gh(t,s,r){var c=t.tag;if(c===5||c===6)t=t.stateNode,s?(r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r).insertBefore(t,s):(s=r.nodeType===9?r.body:r.nodeName==="HTML"?r.ownerDocument.body:r,s.appendChild(t),r=r._reactRootContainer,r!=null||s.onclick!==null||(s.onclick=Hr));else if(c!==4&&(c===27&&ms(t.type)&&(r=t.stateNode,s=null),t=t.child,t!==null))for(gh(t,s,r),t=t.sibling;t!==null;)gh(t,s,r),t=t.sibling}function Br(t,s,r){var c=t.tag;if(c===5||c===6)t=t.stateNode,s?r.insertBefore(t,s):r.appendChild(t);else if(c!==4&&(c===27&&ms(t.type)&&(r=t.stateNode),t=t.child,t!==null))for(Br(t,s,r),t=t.sibling;t!==null;)Br(t,s,r),t=t.sibling}function F0(t){var s=t.stateNode,r=t.memoizedProps;try{for(var c=t.type,f=s.attributes;f.length;)s.removeAttributeNode(f[0]);at(s,c,r),s[dt]=t,s[At]=r}catch(p){Fe(t,t.return,p)}}var Ni=!1,Ye=!1,ph=!1,U0=typeof WeakSet=="function"?WeakSet:Set,tt=null;function Yv(t,s){if(t=t.containerInfo,Nh=qr,t=Kf(t),dc(t)){if("selectionStart"in t)var r={start:t.selectionStart,end:t.selectionEnd};else e:{r=(r=t.ownerDocument)&&r.defaultView||window;var c=r.getSelection&&r.getSelection();if(c&&c.rangeCount!==0){r=c.anchorNode;var f=c.anchorOffset,p=c.focusNode;c=c.focusOffset;try{r.nodeType,p.nodeType}catch{r=null;break e}var S=0,T=-1,R=-1,O=0,V=0,j=t,F=null;t:for(;;){for(var U;j!==r||f!==0&&j.nodeType!==3||(T=S+f),j!==p||c!==0&&j.nodeType!==3||(R=S+c),j.nodeType===3&&(S+=j.nodeValue.length),(U=j.firstChild)!==null;)F=j,j=U;for(;;){if(j===t)break t;if(F===r&&++O===f&&(T=S),F===p&&++V===c&&(R=S),(U=j.nextSibling)!==null)break;j=F,F=j.parentNode}j=U}r=T===-1||R===-1?null:{start:T,end:R}}else r=null}r=r||{start:0,end:0}}else r=null;for(Hh={focusedElem:t,selectionRange:r},qr=!1,tt=s;tt!==null;)if(s=tt,t=s.child,(s.subtreeFlags&1024)!==0&&t!==null)t.return=s,tt=t;else for(;tt!==null;){switch(s=tt,p=s.alternate,t=s.flags,s.tag){case 0:break;case 11:case 15:break;case 1:if((t&1024)!==0&&p!==null){t=void 0,r=s,f=p.memoizedProps,p=p.memoizedState,c=r.stateNode;try{var ge=js(r.type,f,r.elementType===r.type);t=c.getSnapshotBeforeUpdate(ge,p),c.__reactInternalSnapshotBeforeUpdate=t}catch(fe){Fe(r,r.return,fe)}}break;case 3:if((t&1024)!==0){if(t=s.stateNode.containerInfo,r=t.nodeType,r===9)zh(t);else if(r===1)switch(t.nodeName){case"HEAD":case"HTML":case"BODY":zh(t);break;default:t.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((t&1024)!==0)throw Error(n(163))}if(t=s.sibling,t!==null){t.return=s.return,tt=t;break}tt=s.return}}function N0(t,s,r){var c=r.flags;switch(r.tag){case 0:case 11:case 15:cs(t,r),c&4&&so(5,r);break;case 1:if(cs(t,r),c&4)if(t=r.stateNode,s===null)try{t.componentDidMount()}catch(S){Fe(r,r.return,S)}else{var f=js(r.type,s.memoizedProps);s=s.memoizedState;try{t.componentDidUpdate(f,s,t.__reactInternalSnapshotBeforeUpdate)}catch(S){Fe(r,r.return,S)}}c&64&&D0(r),c&512&&no(r,r.return);break;case 3:if(cs(t,r),c&64&&(t=r.updateQueue,t!==null)){if(s=null,r.child!==null)switch(r.child.tag){case 27:case 5:s=r.child.stateNode;break;case 1:s=r.child.stateNode}try{Sd(t,s)}catch(S){Fe(r,r.return,S)}}break;case 27:s===null&&c&4&&F0(r);case 26:case 5:cs(t,r),s===null&&c&4&&L0(r),c&512&&no(r,r.return);break;case 12:cs(t,r);break;case 13:cs(t,r),c&4&&G0(t,r),c&64&&(t=r.memoizedState,t!==null&&(t=t.dehydrated,t!==null&&(r=tb.bind(null,r),bb(t,r))));break;case 22:if(c=r.memoizedState!==null||Ni,!c){s=s!==null&&s.memoizedState!==null||Ye,f=Ni;var p=Ye;Ni=c,(Ye=s)&&!p?hs(t,r,(r.subtreeFlags&8772)!==0):cs(t,r),Ni=f,Ye=p}break;case 30:break;default:cs(t,r)}}function H0(t){var s=t.alternate;s!==null&&(t.alternate=null,H0(s)),t.child=null,t.deletions=null,t.sibling=null,t.tag===5&&(s=t.stateNode,s!==null&&jl(s)),t.stateNode=null,t.return=null,t.dependencies=null,t.memoizedProps=null,t.memoizedState=null,t.pendingProps=null,t.stateNode=null,t.updateQueue=null}var We=null,Et=!1;function Hi(t,s,r){for(r=r.child;r!==null;)W0(t,s,r),r=r.sibling}function W0(t,s,r){if(Dt&&typeof Dt.onCommitFiberUnmount=="function")try{Dt.onCommitFiberUnmount(Aa,r)}catch{}switch(r.tag){case 26:Ye||pi(r,s),Hi(t,s,r),r.memoizedState?r.memoizedState.count--:r.stateNode&&(r=r.stateNode,r.parentNode.removeChild(r));break;case 27:Ye||pi(r,s);var c=We,f=Et;ms(r.type)&&(We=r.stateNode,Et=!1),Hi(t,s,r),go(r.stateNode),We=c,Et=f;break;case 5:Ye||pi(r,s);case 6:if(c=We,f=Et,We=null,Hi(t,s,r),We=c,Et=f,We!==null)if(Et)try{(We.nodeType===9?We.body:We.nodeName==="HTML"?We.ownerDocument.body:We).removeChild(r.stateNode)}catch(p){Fe(r,s,p)}else try{We.removeChild(r.stateNode)}catch(p){Fe(r,s,p)}break;case 18:We!==null&&(Et?(t=We,Bg(t.nodeType===9?t.body:t.nodeName==="HTML"?t.ownerDocument.body:t,r.stateNode),Co(t)):Bg(We,r.stateNode));break;case 4:c=We,f=Et,We=r.stateNode.containerInfo,Et=!0,Hi(t,s,r),We=c,Et=f;break;case 0:case 11:case 14:case 15:Ye||ls(2,r,s),Ye||ls(4,r,s),Hi(t,s,r);break;case 1:Ye||(pi(r,s),c=r.stateNode,typeof c.componentWillUnmount=="function"&&P0(r,s,c)),Hi(t,s,r);break;case 21:Hi(t,s,r);break;case 22:Ye=(c=Ye)||r.memoizedState!==null,Hi(t,s,r),Ye=c;break;default:Hi(t,s,r)}}function G0(t,s){if(s.memoizedState===null&&(t=s.alternate,t!==null&&(t=t.memoizedState,t!==null&&(t=t.dehydrated,t!==null))))try{Co(t)}catch(r){Fe(s,s.return,r)}}function qv(t){switch(t.tag){case 13:case 19:var s=t.stateNode;return s===null&&(s=t.stateNode=new U0),s;case 22:return t=t.stateNode,s=t._retryCache,s===null&&(s=t._retryCache=new U0),s;default:throw Error(n(435,t.tag))}}function mh(t,s){var r=qv(t);s.forEach(function(c){var f=ib.bind(null,t,c);r.has(c)||(r.add(c),c.then(f,f))})}function Ft(t,s){var r=s.deletions;if(r!==null)for(var c=0;c<r.length;c++){var f=r[c],p=t,S=s,T=S;e:for(;T!==null;){switch(T.tag){case 27:if(ms(T.type)){We=T.stateNode,Et=!1;break e}break;case 5:We=T.stateNode,Et=!1;break e;case 3:case 4:We=T.stateNode.containerInfo,Et=!0;break e}T=T.return}if(We===null)throw Error(n(160));W0(p,S,f),We=null,Et=!1,p=f.alternate,p!==null&&(p.return=null),f.return=null}if(s.subtreeFlags&13878)for(s=s.child;s!==null;)z0(s,t),s=s.sibling}var li=null;function z0(t,s){var r=t.alternate,c=t.flags;switch(t.tag){case 0:case 11:case 14:case 15:Ft(s,t),Ut(t),c&4&&(ls(3,t,t.return),so(3,t),ls(5,t,t.return));break;case 1:Ft(s,t),Ut(t),c&512&&(Ye||r===null||pi(r,r.return)),c&64&&Ni&&(t=t.updateQueue,t!==null&&(c=t.callbacks,c!==null&&(r=t.shared.hiddenCallbacks,t.shared.hiddenCallbacks=r===null?c:r.concat(c))));break;case 26:var f=li;if(Ft(s,t),Ut(t),c&512&&(Ye||r===null||pi(r,r.return)),c&4){var p=r!==null?r.memoizedState:null;if(c=t.memoizedState,r===null)if(c===null)if(t.stateNode===null){e:{c=t.type,r=t.memoizedProps,f=f.ownerDocument||f;t:switch(c){case"title":p=f.getElementsByTagName("title")[0],(!p||p[Ea]||p[dt]||p.namespaceURI==="http://www.w3.org/2000/svg"||p.hasAttribute("itemprop"))&&(p=f.createElement(c),f.head.insertBefore(p,f.querySelector("head > title"))),at(p,c,r),p[dt]=t,Je(p),c=p;break e;case"link":var S=Fg("link","href",f).get(c+(r.href||""));if(S){for(var T=0;T<S.length;T++)if(p=S[T],p.getAttribute("href")===(r.href==null||r.href===""?null:r.href)&&p.getAttribute("rel")===(r.rel==null?null:r.rel)&&p.getAttribute("title")===(r.title==null?null:r.title)&&p.getAttribute("crossorigin")===(r.crossOrigin==null?null:r.crossOrigin)){S.splice(T,1);break t}}p=f.createElement(c),at(p,c,r),f.head.appendChild(p);break;case"meta":if(S=Fg("meta","content",f).get(c+(r.content||""))){for(T=0;T<S.length;T++)if(p=S[T],p.getAttribute("content")===(r.content==null?null:""+r.content)&&p.getAttribute("name")===(r.name==null?null:r.name)&&p.getAttribute("property")===(r.property==null?null:r.property)&&p.getAttribute("http-equiv")===(r.httpEquiv==null?null:r.httpEquiv)&&p.getAttribute("charset")===(r.charSet==null?null:r.charSet)){S.splice(T,1);break t}}p=f.createElement(c),at(p,c,r),f.head.appendChild(p);break;default:throw Error(n(468,c))}p[dt]=t,Je(p),c=p}t.stateNode=c}else Ug(f,t.type,t.stateNode);else t.stateNode=Og(f,c,t.memoizedProps);else p!==c?(p===null?r.stateNode!==null&&(r=r.stateNode,r.parentNode.removeChild(r)):p.count--,c===null?Ug(f,t.type,t.stateNode):Og(f,c,t.memoizedProps)):c===null&&t.stateNode!==null&&fh(t,t.memoizedProps,r.memoizedProps)}break;case 27:Ft(s,t),Ut(t),c&512&&(Ye||r===null||pi(r,r.return)),r!==null&&c&4&&fh(t,t.memoizedProps,r.memoizedProps);break;case 5:if(Ft(s,t),Ut(t),c&512&&(Ye||r===null||pi(r,r.return)),t.flags&32){f=t.stateNode;try{kn(f,"")}catch(U){Fe(t,t.return,U)}}c&4&&t.stateNode!=null&&(f=t.memoizedProps,fh(t,f,r!==null?r.memoizedProps:f)),c&1024&&(ph=!0);break;case 6:if(Ft(s,t),Ut(t),c&4){if(t.stateNode===null)throw Error(n(162));c=t.memoizedProps,r=t.stateNode;try{r.nodeValue=c}catch(U){Fe(t,t.return,U)}}break;case 3:if(Xr=null,f=li,li=Gr(s.containerInfo),Ft(s,t),li=f,Ut(t),c&4&&r!==null&&r.memoizedState.isDehydrated)try{Co(s.containerInfo)}catch(U){Fe(t,t.return,U)}ph&&(ph=!1,X0(t));break;case 4:c=li,li=Gr(t.stateNode.containerInfo),Ft(s,t),Ut(t),li=c;break;case 12:Ft(s,t),Ut(t);break;case 13:Ft(s,t),Ut(t),t.child.flags&8192&&t.memoizedState!==null!=(r!==null&&r.memoizedState!==null)&&(Ch=fi()),c&4&&(c=t.updateQueue,c!==null&&(t.updateQueue=null,mh(t,c)));break;case 22:f=t.memoizedState!==null;var R=r!==null&&r.memoizedState!==null,O=Ni,V=Ye;if(Ni=O||f,Ye=V||R,Ft(s,t),Ye=V,Ni=O,Ut(t),c&8192)e:for(s=t.stateNode,s._visibility=f?s._visibility&-2:s._visibility|1,f&&(r===null||R||Ni||Ye||Ks(t)),r=null,s=t;;){if(s.tag===5||s.tag===26){if(r===null){R=r=s;try{if(p=R.stateNode,f)S=p.style,typeof S.setProperty=="function"?S.setProperty("display","none","important"):S.display="none";else{T=R.stateNode;var j=R.memoizedProps.style,F=j!=null&&j.hasOwnProperty("display")?j.display:null;T.style.display=F==null||typeof F=="boolean"?"":(""+F).trim()}}catch(U){Fe(R,R.return,U)}}}else if(s.tag===6){if(r===null){R=s;try{R.stateNode.nodeValue=f?"":R.memoizedProps}catch(U){Fe(R,R.return,U)}}}else if((s.tag!==22&&s.tag!==23||s.memoizedState===null||s===t)&&s.child!==null){s.child.return=s,s=s.child;continue}if(s===t)break e;for(;s.sibling===null;){if(s.return===null||s.return===t)break e;r===s&&(r=null),s=s.return}r===s&&(r=null),s.sibling.return=s.return,s=s.sibling}c&4&&(c=t.updateQueue,c!==null&&(r=c.retryQueue,r!==null&&(c.retryQueue=null,mh(t,r))));break;case 19:Ft(s,t),Ut(t),c&4&&(c=t.updateQueue,c!==null&&(t.updateQueue=null,mh(t,c)));break;case 30:break;case 21:break;default:Ft(s,t),Ut(t)}}function Ut(t){var s=t.flags;if(s&2){try{for(var r,c=t.return;c!==null;){if(O0(c)){r=c;break}c=c.return}if(r==null)throw Error(n(160));switch(r.tag){case 27:var f=r.stateNode,p=dh(t);Br(t,p,f);break;case 5:var S=r.stateNode;r.flags&32&&(kn(S,""),r.flags&=-33);var T=dh(t);Br(t,T,S);break;case 3:case 4:var R=r.stateNode.containerInfo,O=dh(t);gh(t,O,R);break;default:throw Error(n(161))}}catch(V){Fe(t,t.return,V)}t.flags&=-3}s&4096&&(t.flags&=-4097)}function X0(t){if(t.subtreeFlags&1024)for(t=t.child;t!==null;){var s=t;X0(s),s.tag===5&&s.flags&1024&&s.stateNode.reset(),t=t.sibling}}function cs(t,s){if(s.subtreeFlags&8772)for(s=s.child;s!==null;)N0(t,s.alternate,s),s=s.sibling}function Ks(t){for(t=t.child;t!==null;){var s=t;switch(s.tag){case 0:case 11:case 14:case 15:ls(4,s,s.return),Ks(s);break;case 1:pi(s,s.return);var r=s.stateNode;typeof r.componentWillUnmount=="function"&&P0(s,s.return,r),Ks(s);break;case 27:go(s.stateNode);case 26:case 5:pi(s,s.return),Ks(s);break;case 22:s.memoizedState===null&&Ks(s);break;case 30:Ks(s);break;default:Ks(s)}t=t.sibling}}function hs(t,s,r){for(r=r&&(s.subtreeFlags&8772)!==0,s=s.child;s!==null;){var c=s.alternate,f=t,p=s,S=p.flags;switch(p.tag){case 0:case 11:case 15:hs(f,p,r),so(4,p);break;case 1:if(hs(f,p,r),c=p,f=c.stateNode,typeof f.componentDidMount=="function")try{f.componentDidMount()}catch(O){Fe(c,c.return,O)}if(c=p,f=c.updateQueue,f!==null){var T=c.stateNode;try{var R=f.shared.hiddenCallbacks;if(R!==null)for(f.shared.hiddenCallbacks=null,f=0;f<R.length;f++)bd(R[f],T)}catch(O){Fe(c,c.return,O)}}r&&S&64&&D0(p),no(p,p.return);break;case 27:F0(p);case 26:case 5:hs(f,p,r),r&&c===null&&S&4&&L0(p),no(p,p.return);break;case 12:hs(f,p,r);break;case 13:hs(f,p,r),r&&S&4&&G0(f,p);break;case 22:p.memoizedState===null&&hs(f,p,r),no(p,p.return);break;case 30:break;default:hs(f,p,r)}s=s.sibling}}function yh(t,s){var r=null;t!==null&&t.memoizedState!==null&&t.memoizedState.cachePool!==null&&(r=t.memoizedState.cachePool.pool),t=null,s.memoizedState!==null&&s.memoizedState.cachePool!==null&&(t=s.memoizedState.cachePool.pool),t!==r&&(t!=null&&t.refCount++,r!=null&&za(r))}function vh(t,s){t=null,s.alternate!==null&&(t=s.alternate.memoizedState.cache),s=s.memoizedState.cache,s!==t&&(s.refCount++,t!=null&&za(t))}function mi(t,s,r,c){if(s.subtreeFlags&10256)for(s=s.child;s!==null;)V0(t,s,r,c),s=s.sibling}function V0(t,s,r,c){var f=s.flags;switch(s.tag){case 0:case 11:case 15:mi(t,s,r,c),f&2048&&so(9,s);break;case 1:mi(t,s,r,c);break;case 3:mi(t,s,r,c),f&2048&&(t=null,s.alternate!==null&&(t=s.alternate.memoizedState.cache),s=s.memoizedState.cache,s!==t&&(s.refCount++,t!=null&&za(t)));break;case 12:if(f&2048){mi(t,s,r,c),t=s.stateNode;try{var p=s.memoizedProps,S=p.id,T=p.onPostCommit;typeof T=="function"&&T(S,s.alternate===null?"mount":"update",t.passiveEffectDuration,-0)}catch(R){Fe(s,s.return,R)}}else mi(t,s,r,c);break;case 13:mi(t,s,r,c);break;case 23:break;case 22:p=s.stateNode,S=s.alternate,s.memoizedState!==null?p._visibility&2?mi(t,s,r,c):ao(t,s):p._visibility&2?mi(t,s,r,c):(p._visibility|=2,Vn(t,s,r,c,(s.subtreeFlags&10256)!==0)),f&2048&&yh(S,s);break;case 24:mi(t,s,r,c),f&2048&&vh(s.alternate,s);break;default:mi(t,s,r,c)}}function Vn(t,s,r,c,f){for(f=f&&(s.subtreeFlags&10256)!==0,s=s.child;s!==null;){var p=t,S=s,T=r,R=c,O=S.flags;switch(S.tag){case 0:case 11:case 15:Vn(p,S,T,R,f),so(8,S);break;case 23:break;case 22:var V=S.stateNode;S.memoizedState!==null?V._visibility&2?Vn(p,S,T,R,f):ao(p,S):(V._visibility|=2,Vn(p,S,T,R,f)),f&&O&2048&&yh(S.alternate,S);break;case 24:Vn(p,S,T,R,f),f&&O&2048&&vh(S.alternate,S);break;default:Vn(p,S,T,R,f)}s=s.sibling}}function ao(t,s){if(s.subtreeFlags&10256)for(s=s.child;s!==null;){var r=t,c=s,f=c.flags;switch(c.tag){case 22:ao(r,c),f&2048&&yh(c.alternate,c);break;case 24:ao(r,c),f&2048&&vh(c.alternate,c);break;default:ao(r,c)}s=s.sibling}}var oo=8192;function Yn(t){if(t.subtreeFlags&oo)for(t=t.child;t!==null;)Y0(t),t=t.sibling}function Y0(t){switch(t.tag){case 26:Yn(t),t.flags&oo&&t.memoizedState!==null&&_b(li,t.memoizedState,t.memoizedProps);break;case 5:Yn(t);break;case 3:case 4:var s=li;li=Gr(t.stateNode.containerInfo),Yn(t),li=s;break;case 22:t.memoizedState===null&&(s=t.alternate,s!==null&&s.memoizedState!==null?(s=oo,oo=16777216,Yn(t),oo=s):Yn(t));break;default:Yn(t)}}function q0(t){var s=t.alternate;if(s!==null&&(t=s.child,t!==null)){s.child=null;do s=t.sibling,t.sibling=null,t=s;while(t!==null)}}function ro(t){var s=t.deletions;if((t.flags&16)!==0){if(s!==null)for(var r=0;r<s.length;r++){var c=s[r];tt=c,K0(c,t)}q0(t)}if(t.subtreeFlags&10256)for(t=t.child;t!==null;)j0(t),t=t.sibling}function j0(t){switch(t.tag){case 0:case 11:case 15:ro(t),t.flags&2048&&ls(9,t,t.return);break;case 3:ro(t);break;case 12:ro(t);break;case 22:var s=t.stateNode;t.memoizedState!==null&&s._visibility&2&&(t.return===null||t.return.tag!==13)?(s._visibility&=-3,Ir(t)):ro(t);break;default:ro(t)}}function Ir(t){var s=t.deletions;if((t.flags&16)!==0){if(s!==null)for(var r=0;r<s.length;r++){var c=s[r];tt=c,K0(c,t)}q0(t)}for(t=t.child;t!==null;){switch(s=t,s.tag){case 0:case 11:case 15:ls(8,s,s.return),Ir(s);break;case 22:r=s.stateNode,r._visibility&2&&(r._visibility&=-3,Ir(s));break;default:Ir(s)}t=t.sibling}}function K0(t,s){for(;tt!==null;){var r=tt;switch(r.tag){case 0:case 11:case 15:ls(8,r,s);break;case 23:case 22:if(r.memoizedState!==null&&r.memoizedState.cachePool!==null){var c=r.memoizedState.cachePool.pool;c!=null&&c.refCount++}break;case 24:za(r.memoizedState.cache)}if(c=r.child,c!==null)c.return=r,tt=c;else e:for(r=t;tt!==null;){c=tt;var f=c.sibling,p=c.return;if(H0(c),c===r){tt=null;break e}if(f!==null){f.return=p,tt=f;break e}tt=p}}}var jv={getCacheForType:function(t){var s=gt(Qe),r=s.data.get(t);return r===void 0&&(r=t(),s.data.set(t,r)),r}},Kv=typeof WeakMap=="function"?WeakMap:Map,Ie=0,Ue=null,Me=null,we=0,xe=0,Nt=null,us=!1,qn=!1,bh=!1,Wi=0,Xe=0,fs=0,Zs=0,Sh=0,Jt=0,jn=0,lo=null,Bt=null,Mh=!1,Ch=0,xr=1/0,_r=null,ds=null,nt=0,gs=null,Kn=null,Zn=0,Th=0,wh=null,Z0=null,co=0,Ah=null;function Ht(){if((Ie&2)!==0&&we!==0)return we&-we;if(_.T!==null){var t=Fn;return t!==0?t:_h()}return ff()}function Q0(){Jt===0&&(Jt=(we&536870912)===0||Re?lf():536870912);var t=$t.current;return t!==null&&(t.flags|=32),Jt}function Wt(t,s,r){(t===Ue&&(xe===2||xe===9)||t.cancelPendingCommit!==null)&&(Qn(t,0),ps(t,we,Jt,!1)),Ra(t,r),((Ie&2)===0||t!==Ue)&&(t===Ue&&((Ie&2)===0&&(Zs|=r),Xe===4&&ps(t,we,Jt,!1)),yi(t))}function $0(t,s,r){if((Ie&6)!==0)throw Error(n(327));var c=!r&&(s&124)===0&&(s&t.expiredLanes)===0||ka(t,s),f=c?$v(t,s):Eh(t,s,!0),p=c;do{if(f===0){qn&&!c&&ps(t,s,0,!1);break}else{if(r=t.current.alternate,p&&!Zv(r)){f=Eh(t,s,!1),p=!1;continue}if(f===2){if(p=s,t.errorRecoveryDisabledLanes&p)var S=0;else S=t.pendingLanes&-536870913,S=S!==0?S:S&536870912?536870912:0;if(S!==0){s=S;e:{var T=t;f=lo;var R=T.current.memoizedState.isDehydrated;if(R&&(Qn(T,S).flags|=256),S=Eh(T,S,!1),S!==2){if(bh&&!R){T.errorRecoveryDisabledLanes|=p,Zs|=p,f=4;break e}p=Bt,Bt=f,p!==null&&(Bt===null?Bt=p:Bt.push.apply(Bt,p))}f=S}if(p=!1,f!==2)continue}}if(f===1){Qn(t,0),ps(t,s,0,!0);break}e:{switch(c=t,p=f,p){case 0:case 1:throw Error(n(345));case 4:if((s&4194048)!==s)break;case 6:ps(c,s,Jt,!us);break e;case 2:Bt=null;break;case 3:case 5:break;default:throw Error(n(329))}if((s&62914560)===s&&(f=Ch+300-fi(),10<f)){if(ps(c,s,Jt,!us),zo(c,0,!0)!==0)break e;c.timeoutHandle=Rg(J0.bind(null,c,r,Bt,_r,Mh,s,Jt,Zs,jn,us,p,2,-0,0),f);break e}J0(c,r,Bt,_r,Mh,s,Jt,Zs,jn,us,p,0,-0,0)}}break}while(!0);yi(t)}function J0(t,s,r,c,f,p,S,T,R,O,V,j,F,U){if(t.timeoutHandle=-1,j=s.subtreeFlags,(j&8192||(j&16785408)===16785408)&&(yo={stylesheets:null,count:0,unsuspend:xb},Y0(s),j=Db(),j!==null)){t.cancelPendingCommit=j(og.bind(null,t,s,p,r,c,f,S,T,R,V,1,F,U)),ps(t,p,S,!O);return}og(t,s,p,r,c,f,S,T,R)}function Zv(t){for(var s=t;;){var r=s.tag;if((r===0||r===11||r===15)&&s.flags&16384&&(r=s.updateQueue,r!==null&&(r=r.stores,r!==null)))for(var c=0;c<r.length;c++){var f=r[c],p=f.getSnapshot;f=f.value;try{if(!Lt(p(),f))return!1}catch{return!1}}if(r=s.child,s.subtreeFlags&16384&&r!==null)r.return=s,s=r;else{if(s===t)break;for(;s.sibling===null;){if(s.return===null||s.return===t)return!0;s=s.return}s.sibling.return=s.return,s=s.sibling}}return!0}function ps(t,s,r,c){s&=~Sh,s&=~Zs,t.suspendedLanes|=s,t.pingedLanes&=~s,c&&(t.warmLanes|=s),c=t.expirationTimes;for(var f=s;0<f;){var p=31-Pt(f),S=1<<p;c[p]=-1,f&=~S}r!==0&&hf(t,r,s)}function Dr(){return(Ie&6)===0?(ho(0),!1):!0}function kh(){if(Me!==null){if(xe===0)var t=Me.return;else t=Me,Di=Xs=null,zc(t),zn=null,eo=0,t=Me;for(;t!==null;)_0(t.alternate,t),t=t.return;Me=null}}function Qn(t,s){var r=t.timeoutHandle;r!==-1&&(t.timeoutHandle=-1,gb(r)),r=t.cancelPendingCommit,r!==null&&(t.cancelPendingCommit=null,r()),kh(),Ue=t,Me=r=Ii(t.current,null),we=s,xe=0,Nt=null,us=!1,qn=ka(t,s),bh=!1,jn=Jt=Sh=Zs=fs=Xe=0,Bt=lo=null,Mh=!1,(s&8)!==0&&(s|=s&32);var c=t.entangledLanes;if(c!==0)for(t=t.entanglements,c&=s;0<c;){var f=31-Pt(c),p=1<<f;s|=t[f],c&=~p}return Wi=s,tr(),r}function eg(t,s){be=null,_.H=Sr,s===Va||s===hr?(s=yd(),xe=3):s===gd?(s=yd(),xe=4):xe=s===v0?8:s!==null&&typeof s=="object"&&typeof s.then=="function"?6:1,Nt=s,Me===null&&(Xe=1,Ar(t,jt(s,t.current)))}function tg(){var t=_.H;return _.H=Sr,t===null?Sr:t}function ig(){var t=_.A;return _.A=jv,t}function Rh(){Xe=4,us||(we&4194048)!==we&&$t.current!==null||(qn=!0),(fs&134217727)===0&&(Zs&134217727)===0||Ue===null||ps(Ue,we,Jt,!1)}function Eh(t,s,r){var c=Ie;Ie|=2;var f=tg(),p=ig();(Ue!==t||we!==s)&&(_r=null,Qn(t,s)),s=!1;var S=Xe;e:do try{if(xe!==0&&Me!==null){var T=Me,R=Nt;switch(xe){case 8:kh(),S=6;break e;case 3:case 2:case 9:case 6:$t.current===null&&(s=!0);var O=xe;if(xe=0,Nt=null,$n(t,T,R,O),r&&qn){S=0;break e}break;default:O=xe,xe=0,Nt=null,$n(t,T,R,O)}}Qv(),S=Xe;break}catch(V){eg(t,V)}while(!0);return s&&t.shellSuspendCounter++,Di=Xs=null,Ie=c,_.H=f,_.A=p,Me===null&&(Ue=null,we=0,tr()),S}function Qv(){for(;Me!==null;)sg(Me)}function $v(t,s){var r=Ie;Ie|=2;var c=tg(),f=ig();Ue!==t||we!==s?(_r=null,xr=fi()+500,Qn(t,s)):qn=ka(t,s);e:do try{if(xe!==0&&Me!==null){s=Me;var p=Nt;t:switch(xe){case 1:xe=0,Nt=null,$n(t,s,p,1);break;case 2:case 9:if(pd(p)){xe=0,Nt=null,ng(s);break}s=function(){xe!==2&&xe!==9||Ue!==t||(xe=7),yi(t)},p.then(s,s);break e;case 3:xe=7;break e;case 4:xe=5;break e;case 7:pd(p)?(xe=0,Nt=null,ng(s)):(xe=0,Nt=null,$n(t,s,p,7));break;case 5:var S=null;switch(Me.tag){case 26:S=Me.memoizedState;case 5:case 27:var T=Me;if(!S||Ng(S)){xe=0,Nt=null;var R=T.sibling;if(R!==null)Me=R;else{var O=T.return;O!==null?(Me=O,Pr(O)):Me=null}break t}}xe=0,Nt=null,$n(t,s,p,5);break;case 6:xe=0,Nt=null,$n(t,s,p,6);break;case 8:kh(),Xe=6;break e;default:throw Error(n(462))}}Jv();break}catch(V){eg(t,V)}while(!0);return Di=Xs=null,_.H=c,_.A=f,Ie=r,Me!==null?0:(Ue=null,we=0,tr(),Xe)}function Jv(){for(;Me!==null&&!My();)sg(Me)}function sg(t){var s=I0(t.alternate,t,Wi);t.memoizedProps=t.pendingProps,s===null?Pr(t):Me=s}function ng(t){var s=t,r=s.alternate;switch(s.tag){case 15:case 0:s=w0(r,s,s.pendingProps,s.type,void 0,we);break;case 11:s=w0(r,s,s.pendingProps,s.type.render,s.ref,we);break;case 5:zc(s);default:_0(r,s),s=Me=ad(s,Wi),s=I0(r,s,Wi)}t.memoizedProps=t.pendingProps,s===null?Pr(t):Me=s}function $n(t,s,r,c){Di=Xs=null,zc(s),zn=null,eo=0;var f=s.return;try{if(Gv(t,f,s,r,we)){Xe=1,Ar(t,jt(r,t.current)),Me=null;return}}catch(p){if(f!==null)throw Me=f,p;Xe=1,Ar(t,jt(r,t.current)),Me=null;return}s.flags&32768?(Re||c===1?t=!0:qn||(we&536870912)!==0?t=!1:(us=t=!0,(c===2||c===9||c===3||c===6)&&(c=$t.current,c!==null&&c.tag===13&&(c.flags|=16384))),ag(s,t)):Pr(s)}function Pr(t){var s=t;do{if((s.flags&32768)!==0){ag(s,us);return}t=s.return;var r=Xv(s.alternate,s,Wi);if(r!==null){Me=r;return}if(s=s.sibling,s!==null){Me=s;return}Me=s=t}while(s!==null);Xe===0&&(Xe=5)}function ag(t,s){do{var r=Vv(t.alternate,t);if(r!==null){r.flags&=32767,Me=r;return}if(r=t.return,r!==null&&(r.flags|=32768,r.subtreeFlags=0,r.deletions=null),!s&&(t=t.sibling,t!==null)){Me=t;return}Me=t=r}while(t!==null);Xe=6,Me=null}function og(t,s,r,c,f,p,S,T,R){t.cancelPendingCommit=null;do Lr();while(nt!==0);if((Ie&6)!==0)throw Error(n(327));if(s!==null){if(s===t.current)throw Error(n(177));if(p=s.lanes|s.childLanes,p|=vc,xy(t,r,p,S,T,R),t===Ue&&(Me=Ue=null,we=0),Kn=s,gs=t,Zn=r,Th=p,wh=f,Z0=c,(s.subtreeFlags&10256)!==0||(s.flags&10256)!==0?(t.callbackNode=null,t.callbackPriority=0,sb(Ho,function(){return ug(),null})):(t.callbackNode=null,t.callbackPriority=0),c=(s.flags&13878)!==0,(s.subtreeFlags&13878)!==0||c){c=_.T,_.T=null,f=z.p,z.p=2,S=Ie,Ie|=4;try{Yv(t,s,r)}finally{Ie=S,z.p=f,_.T=c}}nt=1,rg(),lg(),cg()}}function rg(){if(nt===1){nt=0;var t=gs,s=Kn,r=(s.flags&13878)!==0;if((s.subtreeFlags&13878)!==0||r){r=_.T,_.T=null;var c=z.p;z.p=2;var f=Ie;Ie|=4;try{z0(s,t);var p=Hh,S=Kf(t.containerInfo),T=p.focusedElem,R=p.selectionRange;if(S!==T&&T&&T.ownerDocument&&jf(T.ownerDocument.documentElement,T)){if(R!==null&&dc(T)){var O=R.start,V=R.end;if(V===void 0&&(V=O),"selectionStart"in T)T.selectionStart=O,T.selectionEnd=Math.min(V,T.value.length);else{var j=T.ownerDocument||document,F=j&&j.defaultView||window;if(F.getSelection){var U=F.getSelection(),ge=T.textContent.length,fe=Math.min(R.start,ge),Le=R.end===void 0?fe:Math.min(R.end,ge);!U.extend&&fe>Le&&(S=Le,Le=fe,fe=S);var P=qf(T,fe),B=qf(T,Le);if(P&&B&&(U.rangeCount!==1||U.anchorNode!==P.node||U.anchorOffset!==P.offset||U.focusNode!==B.node||U.focusOffset!==B.offset)){var L=j.createRange();L.setStart(P.node,P.offset),U.removeAllRanges(),fe>Le?(U.addRange(L),U.extend(B.node,B.offset)):(L.setEnd(B.node,B.offset),U.addRange(L))}}}}for(j=[],U=T;U=U.parentNode;)U.nodeType===1&&j.push({element:U,left:U.scrollLeft,top:U.scrollTop});for(typeof T.focus=="function"&&T.focus(),T=0;T<j.length;T++){var q=j[T];q.element.scrollLeft=q.left,q.element.scrollTop=q.top}}qr=!!Nh,Hh=Nh=null}finally{Ie=f,z.p=c,_.T=r}}t.current=s,nt=2}}function lg(){if(nt===2){nt=0;var t=gs,s=Kn,r=(s.flags&8772)!==0;if((s.subtreeFlags&8772)!==0||r){r=_.T,_.T=null;var c=z.p;z.p=2;var f=Ie;Ie|=4;try{N0(t,s.alternate,s)}finally{Ie=f,z.p=c,_.T=r}}nt=3}}function cg(){if(nt===4||nt===3){nt=0,Cy();var t=gs,s=Kn,r=Zn,c=Z0;(s.subtreeFlags&10256)!==0||(s.flags&10256)!==0?nt=5:(nt=0,Kn=gs=null,hg(t,t.pendingLanes));var f=t.pendingLanes;if(f===0&&(ds=null),Yl(r),s=s.stateNode,Dt&&typeof Dt.onCommitFiberRoot=="function")try{Dt.onCommitFiberRoot(Aa,s,void 0,(s.current.flags&128)===128)}catch{}if(c!==null){s=_.T,f=z.p,z.p=2,_.T=null;try{for(var p=t.onRecoverableError,S=0;S<c.length;S++){var T=c[S];p(T.value,{componentStack:T.stack})}}finally{_.T=s,z.p=f}}(Zn&3)!==0&&Lr(),yi(t),f=t.pendingLanes,(r&4194090)!==0&&(f&42)!==0?t===Ah?co++:(co=0,Ah=t):co=0,ho(0)}}function hg(t,s){(t.pooledCacheLanes&=s)===0&&(s=t.pooledCache,s!=null&&(t.pooledCache=null,za(s)))}function Lr(t){return rg(),lg(),cg(),ug()}function ug(){if(nt!==5)return!1;var t=gs,s=Th;Th=0;var r=Yl(Zn),c=_.T,f=z.p;try{z.p=32>r?32:r,_.T=null,r=wh,wh=null;var p=gs,S=Zn;if(nt=0,Kn=gs=null,Zn=0,(Ie&6)!==0)throw Error(n(331));var T=Ie;if(Ie|=4,j0(p.current),V0(p,p.current,S,r),Ie=T,ho(0,!1),Dt&&typeof Dt.onPostCommitFiberRoot=="function")try{Dt.onPostCommitFiberRoot(Aa,p)}catch{}return!0}finally{z.p=f,_.T=c,hg(t,s)}}function fg(t,s,r){s=jt(r,s),s=sh(t.stateNode,s,2),t=ns(t,s,2),t!==null&&(Ra(t,2),yi(t))}function Fe(t,s,r){if(t.tag===3)fg(t,t,r);else for(;s!==null;){if(s.tag===3){fg(s,t,r);break}else if(s.tag===1){var c=s.stateNode;if(typeof s.type.getDerivedStateFromError=="function"||typeof c.componentDidCatch=="function"&&(ds===null||!ds.has(c))){t=jt(r,t),r=m0(2),c=ns(s,r,2),c!==null&&(y0(r,c,s,t),Ra(c,2),yi(c));break}}s=s.return}}function Bh(t,s,r){var c=t.pingCache;if(c===null){c=t.pingCache=new Kv;var f=new Set;c.set(s,f)}else f=c.get(s),f===void 0&&(f=new Set,c.set(s,f));f.has(r)||(bh=!0,f.add(r),t=eb.bind(null,t,s,r),s.then(t,t))}function eb(t,s,r){var c=t.pingCache;c!==null&&c.delete(s),t.pingedLanes|=t.suspendedLanes&r,t.warmLanes&=~r,Ue===t&&(we&r)===r&&(Xe===4||Xe===3&&(we&62914560)===we&&300>fi()-Ch?(Ie&2)===0&&Qn(t,0):Sh|=r,jn===we&&(jn=0)),yi(t)}function dg(t,s){s===0&&(s=cf()),t=Dn(t,s),t!==null&&(Ra(t,s),yi(t))}function tb(t){var s=t.memoizedState,r=0;s!==null&&(r=s.retryLane),dg(t,r)}function ib(t,s){var r=0;switch(t.tag){case 13:var c=t.stateNode,f=t.memoizedState;f!==null&&(r=f.retryLane);break;case 19:c=t.stateNode;break;case 22:c=t.stateNode._retryCache;break;default:throw Error(n(314))}c!==null&&c.delete(s),dg(t,r)}function sb(t,s){return wa(t,s)}var Or=null,Jn=null,Ih=!1,Fr=!1,xh=!1,Qs=0;function yi(t){t!==Jn&&t.next===null&&(Jn===null?Or=Jn=t:Jn=Jn.next=t),Fr=!0,Ih||(Ih=!0,ab())}function ho(t,s){if(!xh&&Fr){xh=!0;do for(var r=!1,c=Or;c!==null;){if(t!==0){var f=c.pendingLanes;if(f===0)var p=0;else{var S=c.suspendedLanes,T=c.pingedLanes;p=(1<<31-Pt(42|t)+1)-1,p&=f&~(S&~T),p=p&201326741?p&201326741|1:p?p|2:0}p!==0&&(r=!0,yg(c,p))}else p=we,p=zo(c,c===Ue?p:0,c.cancelPendingCommit!==null||c.timeoutHandle!==-1),(p&3)===0||ka(c,p)||(r=!0,yg(c,p));c=c.next}while(r);xh=!1}}function nb(){gg()}function gg(){Fr=Ih=!1;var t=0;Qs!==0&&(db()&&(t=Qs),Qs=0);for(var s=fi(),r=null,c=Or;c!==null;){var f=c.next,p=pg(c,s);p===0?(c.next=null,r===null?Or=f:r.next=f,f===null&&(Jn=r)):(r=c,(t!==0||(p&3)!==0)&&(Fr=!0)),c=f}ho(t)}function pg(t,s){for(var r=t.suspendedLanes,c=t.pingedLanes,f=t.expirationTimes,p=t.pendingLanes&-62914561;0<p;){var S=31-Pt(p),T=1<<S,R=f[S];R===-1?((T&r)===0||(T&c)!==0)&&(f[S]=Iy(T,s)):R<=s&&(t.expiredLanes|=T),p&=~T}if(s=Ue,r=we,r=zo(t,t===s?r:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),c=t.callbackNode,r===0||t===s&&(xe===2||xe===9)||t.cancelPendingCommit!==null)return c!==null&&c!==null&&Ds(c),t.callbackNode=null,t.callbackPriority=0;if((r&3)===0||ka(t,r)){if(s=r&-r,s===t.callbackPriority)return s;switch(c!==null&&Ds(c),Yl(r)){case 2:case 8:r=of;break;case 32:r=Ho;break;case 268435456:r=rf;break;default:r=Ho}return c=mg.bind(null,t),r=wa(r,c),t.callbackPriority=s,t.callbackNode=r,s}return c!==null&&c!==null&&Ds(c),t.callbackPriority=2,t.callbackNode=null,2}function mg(t,s){if(nt!==0&&nt!==5)return t.callbackNode=null,t.callbackPriority=0,null;var r=t.callbackNode;if(Lr()&&t.callbackNode!==r)return null;var c=we;return c=zo(t,t===Ue?c:0,t.cancelPendingCommit!==null||t.timeoutHandle!==-1),c===0?null:($0(t,c,s),pg(t,fi()),t.callbackNode!=null&&t.callbackNode===r?mg.bind(null,t):null)}function yg(t,s){if(Lr())return null;$0(t,s,!0)}function ab(){pb(function(){(Ie&6)!==0?wa(af,nb):gg()})}function _h(){return Qs===0&&(Qs=lf()),Qs}function vg(t){return t==null||typeof t=="symbol"||typeof t=="boolean"?null:typeof t=="function"?t:jo(""+t)}function bg(t,s){var r=s.ownerDocument.createElement("input");return r.name=s.name,r.value=s.value,t.id&&r.setAttribute("form",t.id),s.parentNode.insertBefore(r,s),t=new FormData(t),r.parentNode.removeChild(r),t}function ob(t,s,r,c,f){if(s==="submit"&&r&&r.stateNode===f){var p=vg((f[At]||null).action),S=c.submitter;S&&(s=(s=S[At]||null)?vg(s.formAction):S.getAttribute("formAction"),s!==null&&(p=s,S=null));var T=new $o("action","action",null,c,f);t.push({event:T,listeners:[{instance:null,listener:function(){if(c.defaultPrevented){if(Qs!==0){var R=S?bg(f,S):new FormData(f);$c(r,{pending:!0,data:R,method:f.method,action:p},null,R)}}else typeof p=="function"&&(T.preventDefault(),R=S?bg(f,S):new FormData(f),$c(r,{pending:!0,data:R,method:f.method,action:p},p,R))},currentTarget:f}]})}}for(var Dh=0;Dh<yc.length;Dh++){var Ph=yc[Dh],rb=Ph.toLowerCase(),lb=Ph[0].toUpperCase()+Ph.slice(1);ri(rb,"on"+lb)}ri($f,"onAnimationEnd"),ri(Jf,"onAnimationIteration"),ri(ed,"onAnimationStart"),ri("dblclick","onDoubleClick"),ri("focusin","onFocus"),ri("focusout","onBlur"),ri(Av,"onTransitionRun"),ri(kv,"onTransitionStart"),ri(Rv,"onTransitionCancel"),ri(td,"onTransitionEnd"),Tn("onMouseEnter",["mouseout","mouseover"]),Tn("onMouseLeave",["mouseout","mouseover"]),Tn("onPointerEnter",["pointerout","pointerover"]),Tn("onPointerLeave",["pointerout","pointerover"]),Ls("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),Ls("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),Ls("onBeforeInput",["compositionend","keypress","textInput","paste"]),Ls("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),Ls("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),Ls("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var uo="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),cb=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(uo));function Sg(t,s){s=(s&4)!==0;for(var r=0;r<t.length;r++){var c=t[r],f=c.event;c=c.listeners;e:{var p=void 0;if(s)for(var S=c.length-1;0<=S;S--){var T=c[S],R=T.instance,O=T.currentTarget;if(T=T.listener,R!==p&&f.isPropagationStopped())break e;p=T,f.currentTarget=O;try{p(f)}catch(V){wr(V)}f.currentTarget=null,p=R}else for(S=0;S<c.length;S++){if(T=c[S],R=T.instance,O=T.currentTarget,T=T.listener,R!==p&&f.isPropagationStopped())break e;p=T,f.currentTarget=O;try{p(f)}catch(V){wr(V)}f.currentTarget=null,p=R}}}}function Ce(t,s){var r=s[ql];r===void 0&&(r=s[ql]=new Set);var c=t+"__bubble";r.has(c)||(Mg(s,t,2,!1),r.add(c))}function Lh(t,s,r){var c=0;s&&(c|=4),Mg(r,t,c,s)}var Ur="_reactListening"+Math.random().toString(36).slice(2);function Oh(t){if(!t[Ur]){t[Ur]=!0,gf.forEach(function(r){r!=="selectionchange"&&(cb.has(r)||Lh(r,!1,t),Lh(r,!0,t))});var s=t.nodeType===9?t:t.ownerDocument;s===null||s[Ur]||(s[Ur]=!0,Lh("selectionchange",!1,s))}}function Mg(t,s,r,c){switch(Vg(s)){case 2:var f=Ob;break;case 8:f=Fb;break;default:f=Zh}r=f.bind(null,s,r,t),f=void 0,!nc||s!=="touchstart"&&s!=="touchmove"&&s!=="wheel"||(f=!0),c?f!==void 0?t.addEventListener(s,r,{capture:!0,passive:f}):t.addEventListener(s,r,!0):f!==void 0?t.addEventListener(s,r,{passive:f}):t.addEventListener(s,r,!1)}function Fh(t,s,r,c,f){var p=c;if((s&1)===0&&(s&2)===0&&c!==null)e:for(;;){if(c===null)return;var S=c.tag;if(S===3||S===4){var T=c.stateNode.containerInfo;if(T===f)break;if(S===4)for(S=c.return;S!==null;){var R=S.tag;if((R===3||R===4)&&S.stateNode.containerInfo===f)return;S=S.return}for(;T!==null;){if(S=Sn(T),S===null)return;if(R=S.tag,R===5||R===6||R===26||R===27){c=p=S;continue e}T=T.parentNode}}c=c.return}Ef(function(){var O=p,V=ic(r),j=[];e:{var F=id.get(t);if(F!==void 0){var U=$o,ge=t;switch(t){case"keypress":if(Zo(r)===0)break e;case"keydown":case"keyup":U=sv;break;case"focusin":ge="focus",U=lc;break;case"focusout":ge="blur",U=lc;break;case"beforeblur":case"afterblur":U=lc;break;case"click":if(r.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":U=xf;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":U=Vy;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":U=ov;break;case $f:case Jf:case ed:U=jy;break;case td:U=lv;break;case"scroll":case"scrollend":U=zy;break;case"wheel":U=hv;break;case"copy":case"cut":case"paste":U=Zy;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":U=Df;break;case"toggle":case"beforetoggle":U=fv}var fe=(s&4)!==0,Le=!fe&&(t==="scroll"||t==="scrollend"),P=fe?F!==null?F+"Capture":null:F;fe=[];for(var B=O,L;B!==null;){var q=B;if(L=q.stateNode,q=q.tag,q!==5&&q!==26&&q!==27||L===null||P===null||(q=Ia(B,P),q!=null&&fe.push(fo(B,q,L))),Le)break;B=B.return}0<fe.length&&(F=new U(F,ge,null,r,V),j.push({event:F,listeners:fe}))}}if((s&7)===0){e:{if(F=t==="mouseover"||t==="pointerover",U=t==="mouseout"||t==="pointerout",F&&r!==tc&&(ge=r.relatedTarget||r.fromElement)&&(Sn(ge)||ge[bn]))break e;if((U||F)&&(F=V.window===V?V:(F=V.ownerDocument)?F.defaultView||F.parentWindow:window,U?(ge=r.relatedTarget||r.toElement,U=O,ge=ge?Sn(ge):null,ge!==null&&(Le=l(ge),fe=ge.tag,ge!==Le||fe!==5&&fe!==27&&fe!==6)&&(ge=null)):(U=null,ge=O),U!==ge)){if(fe=xf,q="onMouseLeave",P="onMouseEnter",B="mouse",(t==="pointerout"||t==="pointerover")&&(fe=Df,q="onPointerLeave",P="onPointerEnter",B="pointer"),Le=U==null?F:Ba(U),L=ge==null?F:Ba(ge),F=new fe(q,B+"leave",U,r,V),F.target=Le,F.relatedTarget=L,q=null,Sn(V)===O&&(fe=new fe(P,B+"enter",ge,r,V),fe.target=L,fe.relatedTarget=Le,q=fe),Le=q,U&&ge)t:{for(fe=U,P=ge,B=0,L=fe;L;L=ea(L))B++;for(L=0,q=P;q;q=ea(q))L++;for(;0<B-L;)fe=ea(fe),B--;for(;0<L-B;)P=ea(P),L--;for(;B--;){if(fe===P||P!==null&&fe===P.alternate)break t;fe=ea(fe),P=ea(P)}fe=null}else fe=null;U!==null&&Cg(j,F,U,fe,!1),ge!==null&&Le!==null&&Cg(j,Le,ge,fe,!0)}}e:{if(F=O?Ba(O):window,U=F.nodeName&&F.nodeName.toLowerCase(),U==="select"||U==="input"&&F.type==="file")var le=Wf;else if(Nf(F))if(Gf)le=Cv;else{le=Sv;var Se=bv}else U=F.nodeName,!U||U.toLowerCase()!=="input"||F.type!=="checkbox"&&F.type!=="radio"?O&&ec(O.elementType)&&(le=Wf):le=Mv;if(le&&(le=le(t,O))){Hf(j,le,r,V);break e}Se&&Se(t,F,O),t==="focusout"&&O&&F.type==="number"&&O.memoizedProps.value!=null&&Jl(F,"number",F.value)}switch(Se=O?Ba(O):window,t){case"focusin":(Nf(Se)||Se.contentEditable==="true")&&(In=Se,gc=O,Ua=null);break;case"focusout":Ua=gc=In=null;break;case"mousedown":pc=!0;break;case"contextmenu":case"mouseup":case"dragend":pc=!1,Zf(j,r,V);break;case"selectionchange":if(wv)break;case"keydown":case"keyup":Zf(j,r,V)}var ce;if(hc)e:{switch(t){case"compositionstart":var de="onCompositionStart";break e;case"compositionend":de="onCompositionEnd";break e;case"compositionupdate":de="onCompositionUpdate";break e}de=void 0}else Bn?Ff(t,r)&&(de="onCompositionEnd"):t==="keydown"&&r.keyCode===229&&(de="onCompositionStart");de&&(Pf&&r.locale!=="ko"&&(Bn||de!=="onCompositionStart"?de==="onCompositionEnd"&&Bn&&(ce=Bf()):(es=V,ac="value"in es?es.value:es.textContent,Bn=!0)),Se=Nr(O,de),0<Se.length&&(de=new _f(de,t,null,r,V),j.push({event:de,listeners:Se}),ce?de.data=ce:(ce=Uf(r),ce!==null&&(de.data=ce)))),(ce=gv?pv(t,r):mv(t,r))&&(de=Nr(O,"onBeforeInput"),0<de.length&&(Se=new _f("onBeforeInput","beforeinput",null,r,V),j.push({event:Se,listeners:de}),Se.data=ce)),ob(j,t,O,r,V)}Sg(j,s)})}function fo(t,s,r){return{instance:t,listener:s,currentTarget:r}}function Nr(t,s){for(var r=s+"Capture",c=[];t!==null;){var f=t,p=f.stateNode;if(f=f.tag,f!==5&&f!==26&&f!==27||p===null||(f=Ia(t,r),f!=null&&c.unshift(fo(t,f,p)),f=Ia(t,s),f!=null&&c.push(fo(t,f,p))),t.tag===3)return c;t=t.return}return[]}function ea(t){if(t===null)return null;do t=t.return;while(t&&t.tag!==5&&t.tag!==27);return t||null}function Cg(t,s,r,c,f){for(var p=s._reactName,S=[];r!==null&&r!==c;){var T=r,R=T.alternate,O=T.stateNode;if(T=T.tag,R!==null&&R===c)break;T!==5&&T!==26&&T!==27||O===null||(R=O,f?(O=Ia(r,p),O!=null&&S.unshift(fo(r,O,R))):f||(O=Ia(r,p),O!=null&&S.push(fo(r,O,R)))),r=r.return}S.length!==0&&t.push({event:s,listeners:S})}var hb=/\r\n?/g,ub=/\u0000|\uFFFD/g;function Tg(t){return(typeof t=="string"?t:""+t).replace(hb,`
`).replace(ub,"")}function wg(t,s){return s=Tg(s),Tg(t)===s}function Hr(){}function Pe(t,s,r,c,f,p){switch(r){case"children":typeof c=="string"?s==="body"||s==="textarea"&&c===""||kn(t,c):(typeof c=="number"||typeof c=="bigint")&&s!=="body"&&kn(t,""+c);break;case"className":Vo(t,"class",c);break;case"tabIndex":Vo(t,"tabindex",c);break;case"dir":case"role":case"viewBox":case"width":case"height":Vo(t,r,c);break;case"style":kf(t,c,p);break;case"data":if(s!=="object"){Vo(t,"data",c);break}case"src":case"href":if(c===""&&(s!=="a"||r!=="href")){t.removeAttribute(r);break}if(c==null||typeof c=="function"||typeof c=="symbol"||typeof c=="boolean"){t.removeAttribute(r);break}c=jo(""+c),t.setAttribute(r,c);break;case"action":case"formAction":if(typeof c=="function"){t.setAttribute(r,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof p=="function"&&(r==="formAction"?(s!=="input"&&Pe(t,s,"name",f.name,f,null),Pe(t,s,"formEncType",f.formEncType,f,null),Pe(t,s,"formMethod",f.formMethod,f,null),Pe(t,s,"formTarget",f.formTarget,f,null)):(Pe(t,s,"encType",f.encType,f,null),Pe(t,s,"method",f.method,f,null),Pe(t,s,"target",f.target,f,null)));if(c==null||typeof c=="symbol"||typeof c=="boolean"){t.removeAttribute(r);break}c=jo(""+c),t.setAttribute(r,c);break;case"onClick":c!=null&&(t.onclick=Hr);break;case"onScroll":c!=null&&Ce("scroll",t);break;case"onScrollEnd":c!=null&&Ce("scrollend",t);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(n(61));if(r=c.__html,r!=null){if(f.children!=null)throw Error(n(60));t.innerHTML=r}}break;case"multiple":t.multiple=c&&typeof c!="function"&&typeof c!="symbol";break;case"muted":t.muted=c&&typeof c!="function"&&typeof c!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(c==null||typeof c=="function"||typeof c=="boolean"||typeof c=="symbol"){t.removeAttribute("xlink:href");break}r=jo(""+c),t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",r);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":c!=null&&typeof c!="function"&&typeof c!="symbol"?t.setAttribute(r,""+c):t.removeAttribute(r);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":c&&typeof c!="function"&&typeof c!="symbol"?t.setAttribute(r,""):t.removeAttribute(r);break;case"capture":case"download":c===!0?t.setAttribute(r,""):c!==!1&&c!=null&&typeof c!="function"&&typeof c!="symbol"?t.setAttribute(r,c):t.removeAttribute(r);break;case"cols":case"rows":case"size":case"span":c!=null&&typeof c!="function"&&typeof c!="symbol"&&!isNaN(c)&&1<=c?t.setAttribute(r,c):t.removeAttribute(r);break;case"rowSpan":case"start":c==null||typeof c=="function"||typeof c=="symbol"||isNaN(c)?t.removeAttribute(r):t.setAttribute(r,c);break;case"popover":Ce("beforetoggle",t),Ce("toggle",t),Xo(t,"popover",c);break;case"xlinkActuate":Ei(t,"http://www.w3.org/1999/xlink","xlink:actuate",c);break;case"xlinkArcrole":Ei(t,"http://www.w3.org/1999/xlink","xlink:arcrole",c);break;case"xlinkRole":Ei(t,"http://www.w3.org/1999/xlink","xlink:role",c);break;case"xlinkShow":Ei(t,"http://www.w3.org/1999/xlink","xlink:show",c);break;case"xlinkTitle":Ei(t,"http://www.w3.org/1999/xlink","xlink:title",c);break;case"xlinkType":Ei(t,"http://www.w3.org/1999/xlink","xlink:type",c);break;case"xmlBase":Ei(t,"http://www.w3.org/XML/1998/namespace","xml:base",c);break;case"xmlLang":Ei(t,"http://www.w3.org/XML/1998/namespace","xml:lang",c);break;case"xmlSpace":Ei(t,"http://www.w3.org/XML/1998/namespace","xml:space",c);break;case"is":Xo(t,"is",c);break;case"innerText":case"textContent":break;default:(!(2<r.length)||r[0]!=="o"&&r[0]!=="O"||r[1]!=="n"&&r[1]!=="N")&&(r=Wy.get(r)||r,Xo(t,r,c))}}function Uh(t,s,r,c,f,p){switch(r){case"style":kf(t,c,p);break;case"dangerouslySetInnerHTML":if(c!=null){if(typeof c!="object"||!("__html"in c))throw Error(n(61));if(r=c.__html,r!=null){if(f.children!=null)throw Error(n(60));t.innerHTML=r}}break;case"children":typeof c=="string"?kn(t,c):(typeof c=="number"||typeof c=="bigint")&&kn(t,""+c);break;case"onScroll":c!=null&&Ce("scroll",t);break;case"onScrollEnd":c!=null&&Ce("scrollend",t);break;case"onClick":c!=null&&(t.onclick=Hr);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!pf.hasOwnProperty(r))e:{if(r[0]==="o"&&r[1]==="n"&&(f=r.endsWith("Capture"),s=r.slice(2,f?r.length-7:void 0),p=t[At]||null,p=p!=null?p[r]:null,typeof p=="function"&&t.removeEventListener(s,p,f),typeof c=="function")){typeof p!="function"&&p!==null&&(r in t?t[r]=null:t.hasAttribute(r)&&t.removeAttribute(r)),t.addEventListener(s,c,f);break e}r in t?t[r]=c:c===!0?t.setAttribute(r,""):Xo(t,r,c)}}}function at(t,s,r){switch(s){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":Ce("error",t),Ce("load",t);var c=!1,f=!1,p;for(p in r)if(r.hasOwnProperty(p)){var S=r[p];if(S!=null)switch(p){case"src":c=!0;break;case"srcSet":f=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(n(137,s));default:Pe(t,s,p,S,r,null)}}f&&Pe(t,s,"srcSet",r.srcSet,r,null),c&&Pe(t,s,"src",r.src,r,null);return;case"input":Ce("invalid",t);var T=p=S=f=null,R=null,O=null;for(c in r)if(r.hasOwnProperty(c)){var V=r[c];if(V!=null)switch(c){case"name":f=V;break;case"type":S=V;break;case"checked":R=V;break;case"defaultChecked":O=V;break;case"value":p=V;break;case"defaultValue":T=V;break;case"children":case"dangerouslySetInnerHTML":if(V!=null)throw Error(n(137,s));break;default:Pe(t,s,c,V,r,null)}}Cf(t,p,T,R,O,S,f,!1),Yo(t);return;case"select":Ce("invalid",t),c=S=p=null;for(f in r)if(r.hasOwnProperty(f)&&(T=r[f],T!=null))switch(f){case"value":p=T;break;case"defaultValue":S=T;break;case"multiple":c=T;default:Pe(t,s,f,T,r,null)}s=p,r=S,t.multiple=!!c,s!=null?An(t,!!c,s,!1):r!=null&&An(t,!!c,r,!0);return;case"textarea":Ce("invalid",t),p=f=c=null;for(S in r)if(r.hasOwnProperty(S)&&(T=r[S],T!=null))switch(S){case"value":c=T;break;case"defaultValue":f=T;break;case"children":p=T;break;case"dangerouslySetInnerHTML":if(T!=null)throw Error(n(91));break;default:Pe(t,s,S,T,r,null)}wf(t,c,f,p),Yo(t);return;case"option":for(R in r)if(r.hasOwnProperty(R)&&(c=r[R],c!=null))switch(R){case"selected":t.selected=c&&typeof c!="function"&&typeof c!="symbol";break;default:Pe(t,s,R,c,r,null)}return;case"dialog":Ce("beforetoggle",t),Ce("toggle",t),Ce("cancel",t),Ce("close",t);break;case"iframe":case"object":Ce("load",t);break;case"video":case"audio":for(c=0;c<uo.length;c++)Ce(uo[c],t);break;case"image":Ce("error",t),Ce("load",t);break;case"details":Ce("toggle",t);break;case"embed":case"source":case"link":Ce("error",t),Ce("load",t);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(O in r)if(r.hasOwnProperty(O)&&(c=r[O],c!=null))switch(O){case"children":case"dangerouslySetInnerHTML":throw Error(n(137,s));default:Pe(t,s,O,c,r,null)}return;default:if(ec(s)){for(V in r)r.hasOwnProperty(V)&&(c=r[V],c!==void 0&&Uh(t,s,V,c,r,void 0));return}}for(T in r)r.hasOwnProperty(T)&&(c=r[T],c!=null&&Pe(t,s,T,c,r,null))}function fb(t,s,r,c){switch(s){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var f=null,p=null,S=null,T=null,R=null,O=null,V=null;for(U in r){var j=r[U];if(r.hasOwnProperty(U)&&j!=null)switch(U){case"checked":break;case"value":break;case"defaultValue":R=j;default:c.hasOwnProperty(U)||Pe(t,s,U,null,c,j)}}for(var F in c){var U=c[F];if(j=r[F],c.hasOwnProperty(F)&&(U!=null||j!=null))switch(F){case"type":p=U;break;case"name":f=U;break;case"checked":O=U;break;case"defaultChecked":V=U;break;case"value":S=U;break;case"defaultValue":T=U;break;case"children":case"dangerouslySetInnerHTML":if(U!=null)throw Error(n(137,s));break;default:U!==j&&Pe(t,s,F,U,c,j)}}$l(t,S,T,R,O,V,p,f);return;case"select":U=S=T=F=null;for(p in r)if(R=r[p],r.hasOwnProperty(p)&&R!=null)switch(p){case"value":break;case"multiple":U=R;default:c.hasOwnProperty(p)||Pe(t,s,p,null,c,R)}for(f in c)if(p=c[f],R=r[f],c.hasOwnProperty(f)&&(p!=null||R!=null))switch(f){case"value":F=p;break;case"defaultValue":T=p;break;case"multiple":S=p;default:p!==R&&Pe(t,s,f,p,c,R)}s=T,r=S,c=U,F!=null?An(t,!!r,F,!1):!!c!=!!r&&(s!=null?An(t,!!r,s,!0):An(t,!!r,r?[]:"",!1));return;case"textarea":U=F=null;for(T in r)if(f=r[T],r.hasOwnProperty(T)&&f!=null&&!c.hasOwnProperty(T))switch(T){case"value":break;case"children":break;default:Pe(t,s,T,null,c,f)}for(S in c)if(f=c[S],p=r[S],c.hasOwnProperty(S)&&(f!=null||p!=null))switch(S){case"value":F=f;break;case"defaultValue":U=f;break;case"children":break;case"dangerouslySetInnerHTML":if(f!=null)throw Error(n(91));break;default:f!==p&&Pe(t,s,S,f,c,p)}Tf(t,F,U);return;case"option":for(var ge in r)if(F=r[ge],r.hasOwnProperty(ge)&&F!=null&&!c.hasOwnProperty(ge))switch(ge){case"selected":t.selected=!1;break;default:Pe(t,s,ge,null,c,F)}for(R in c)if(F=c[R],U=r[R],c.hasOwnProperty(R)&&F!==U&&(F!=null||U!=null))switch(R){case"selected":t.selected=F&&typeof F!="function"&&typeof F!="symbol";break;default:Pe(t,s,R,F,c,U)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var fe in r)F=r[fe],r.hasOwnProperty(fe)&&F!=null&&!c.hasOwnProperty(fe)&&Pe(t,s,fe,null,c,F);for(O in c)if(F=c[O],U=r[O],c.hasOwnProperty(O)&&F!==U&&(F!=null||U!=null))switch(O){case"children":case"dangerouslySetInnerHTML":if(F!=null)throw Error(n(137,s));break;default:Pe(t,s,O,F,c,U)}return;default:if(ec(s)){for(var Le in r)F=r[Le],r.hasOwnProperty(Le)&&F!==void 0&&!c.hasOwnProperty(Le)&&Uh(t,s,Le,void 0,c,F);for(V in c)F=c[V],U=r[V],!c.hasOwnProperty(V)||F===U||F===void 0&&U===void 0||Uh(t,s,V,F,c,U);return}}for(var P in r)F=r[P],r.hasOwnProperty(P)&&F!=null&&!c.hasOwnProperty(P)&&Pe(t,s,P,null,c,F);for(j in c)F=c[j],U=r[j],!c.hasOwnProperty(j)||F===U||F==null&&U==null||Pe(t,s,j,F,c,U)}var Nh=null,Hh=null;function Wr(t){return t.nodeType===9?t:t.ownerDocument}function Ag(t){switch(t){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function kg(t,s){if(t===0)switch(s){case"svg":return 1;case"math":return 2;default:return 0}return t===1&&s==="foreignObject"?0:t}function Wh(t,s){return t==="textarea"||t==="noscript"||typeof s.children=="string"||typeof s.children=="number"||typeof s.children=="bigint"||typeof s.dangerouslySetInnerHTML=="object"&&s.dangerouslySetInnerHTML!==null&&s.dangerouslySetInnerHTML.__html!=null}var Gh=null;function db(){var t=window.event;return t&&t.type==="popstate"?t===Gh?!1:(Gh=t,!0):(Gh=null,!1)}var Rg=typeof setTimeout=="function"?setTimeout:void 0,gb=typeof clearTimeout=="function"?clearTimeout:void 0,Eg=typeof Promise=="function"?Promise:void 0,pb=typeof queueMicrotask=="function"?queueMicrotask:typeof Eg<"u"?function(t){return Eg.resolve(null).then(t).catch(mb)}:Rg;function mb(t){setTimeout(function(){throw t})}function ms(t){return t==="head"}function Bg(t,s){var r=s,c=0,f=0;do{var p=r.nextSibling;if(t.removeChild(r),p&&p.nodeType===8)if(r=p.data,r==="/$"){if(0<c&&8>c){r=c;var S=t.ownerDocument;if(r&1&&go(S.documentElement),r&2&&go(S.body),r&4)for(r=S.head,go(r),S=r.firstChild;S;){var T=S.nextSibling,R=S.nodeName;S[Ea]||R==="SCRIPT"||R==="STYLE"||R==="LINK"&&S.rel.toLowerCase()==="stylesheet"||r.removeChild(S),S=T}}if(f===0){t.removeChild(p),Co(s);return}f--}else r==="$"||r==="$?"||r==="$!"?f++:c=r.charCodeAt(0)-48;else c=0;r=p}while(r);Co(s)}function zh(t){var s=t.firstChild;for(s&&s.nodeType===10&&(s=s.nextSibling);s;){var r=s;switch(s=s.nextSibling,r.nodeName){case"HTML":case"HEAD":case"BODY":zh(r),jl(r);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(r.rel.toLowerCase()==="stylesheet")continue}t.removeChild(r)}}function yb(t,s,r,c){for(;t.nodeType===1;){var f=r;if(t.nodeName.toLowerCase()!==s.toLowerCase()){if(!c&&(t.nodeName!=="INPUT"||t.type!=="hidden"))break}else if(c){if(!t[Ea])switch(s){case"meta":if(!t.hasAttribute("itemprop"))break;return t;case"link":if(p=t.getAttribute("rel"),p==="stylesheet"&&t.hasAttribute("data-precedence"))break;if(p!==f.rel||t.getAttribute("href")!==(f.href==null||f.href===""?null:f.href)||t.getAttribute("crossorigin")!==(f.crossOrigin==null?null:f.crossOrigin)||t.getAttribute("title")!==(f.title==null?null:f.title))break;return t;case"style":if(t.hasAttribute("data-precedence"))break;return t;case"script":if(p=t.getAttribute("src"),(p!==(f.src==null?null:f.src)||t.getAttribute("type")!==(f.type==null?null:f.type)||t.getAttribute("crossorigin")!==(f.crossOrigin==null?null:f.crossOrigin))&&p&&t.hasAttribute("async")&&!t.hasAttribute("itemprop"))break;return t;default:return t}}else if(s==="input"&&t.type==="hidden"){var p=f.name==null?null:""+f.name;if(f.type==="hidden"&&t.getAttribute("name")===p)return t}else return t;if(t=ci(t.nextSibling),t===null)break}return null}function vb(t,s,r){if(s==="")return null;for(;t.nodeType!==3;)if((t.nodeType!==1||t.nodeName!=="INPUT"||t.type!=="hidden")&&!r||(t=ci(t.nextSibling),t===null))return null;return t}function Xh(t){return t.data==="$!"||t.data==="$?"&&t.ownerDocument.readyState==="complete"}function bb(t,s){var r=t.ownerDocument;if(t.data!=="$?"||r.readyState==="complete")s();else{var c=function(){s(),r.removeEventListener("DOMContentLoaded",c)};r.addEventListener("DOMContentLoaded",c),t._reactRetry=c}}function ci(t){for(;t!=null;t=t.nextSibling){var s=t.nodeType;if(s===1||s===3)break;if(s===8){if(s=t.data,s==="$"||s==="$!"||s==="$?"||s==="F!"||s==="F")break;if(s==="/$")return null}}return t}var Vh=null;function Ig(t){t=t.previousSibling;for(var s=0;t;){if(t.nodeType===8){var r=t.data;if(r==="$"||r==="$!"||r==="$?"){if(s===0)return t;s--}else r==="/$"&&s++}t=t.previousSibling}return null}function xg(t,s,r){switch(s=Wr(r),t){case"html":if(t=s.documentElement,!t)throw Error(n(452));return t;case"head":if(t=s.head,!t)throw Error(n(453));return t;case"body":if(t=s.body,!t)throw Error(n(454));return t;default:throw Error(n(451))}}function go(t){for(var s=t.attributes;s.length;)t.removeAttributeNode(s[0]);jl(t)}var ei=new Map,_g=new Set;function Gr(t){return typeof t.getRootNode=="function"?t.getRootNode():t.nodeType===9?t:t.ownerDocument}var Gi=z.d;z.d={f:Sb,r:Mb,D:Cb,C:Tb,L:wb,m:Ab,X:Rb,S:kb,M:Eb};function Sb(){var t=Gi.f(),s=Dr();return t||s}function Mb(t){var s=Mn(t);s!==null&&s.tag===5&&s.type==="form"?$d(s):Gi.r(t)}var ta=typeof document>"u"?null:document;function Dg(t,s,r){var c=ta;if(c&&typeof s=="string"&&s){var f=qt(s);f='link[rel="'+t+'"][href="'+f+'"]',typeof r=="string"&&(f+='[crossorigin="'+r+'"]'),_g.has(f)||(_g.add(f),t={rel:t,crossOrigin:r,href:s},c.querySelector(f)===null&&(s=c.createElement("link"),at(s,"link",t),Je(s),c.head.appendChild(s)))}}function Cb(t){Gi.D(t),Dg("dns-prefetch",t,null)}function Tb(t,s){Gi.C(t,s),Dg("preconnect",t,s)}function wb(t,s,r){Gi.L(t,s,r);var c=ta;if(c&&t&&s){var f='link[rel="preload"][as="'+qt(s)+'"]';s==="image"&&r&&r.imageSrcSet?(f+='[imagesrcset="'+qt(r.imageSrcSet)+'"]',typeof r.imageSizes=="string"&&(f+='[imagesizes="'+qt(r.imageSizes)+'"]')):f+='[href="'+qt(t)+'"]';var p=f;switch(s){case"style":p=ia(t);break;case"script":p=sa(t)}ei.has(p)||(t=m({rel:"preload",href:s==="image"&&r&&r.imageSrcSet?void 0:t,as:s},r),ei.set(p,t),c.querySelector(f)!==null||s==="style"&&c.querySelector(po(p))||s==="script"&&c.querySelector(mo(p))||(s=c.createElement("link"),at(s,"link",t),Je(s),c.head.appendChild(s)))}}function Ab(t,s){Gi.m(t,s);var r=ta;if(r&&t){var c=s&&typeof s.as=="string"?s.as:"script",f='link[rel="modulepreload"][as="'+qt(c)+'"][href="'+qt(t)+'"]',p=f;switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":p=sa(t)}if(!ei.has(p)&&(t=m({rel:"modulepreload",href:t},s),ei.set(p,t),r.querySelector(f)===null)){switch(c){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(r.querySelector(mo(p)))return}c=r.createElement("link"),at(c,"link",t),Je(c),r.head.appendChild(c)}}}function kb(t,s,r){Gi.S(t,s,r);var c=ta;if(c&&t){var f=Cn(c).hoistableStyles,p=ia(t);s=s||"default";var S=f.get(p);if(!S){var T={loading:0,preload:null};if(S=c.querySelector(po(p)))T.loading=5;else{t=m({rel:"stylesheet",href:t,"data-precedence":s},r),(r=ei.get(p))&&Yh(t,r);var R=S=c.createElement("link");Je(R),at(R,"link",t),R._p=new Promise(function(O,V){R.onload=O,R.onerror=V}),R.addEventListener("load",function(){T.loading|=1}),R.addEventListener("error",function(){T.loading|=2}),T.loading|=4,zr(S,s,c)}S={type:"stylesheet",instance:S,count:1,state:T},f.set(p,S)}}}function Rb(t,s){Gi.X(t,s);var r=ta;if(r&&t){var c=Cn(r).hoistableScripts,f=sa(t),p=c.get(f);p||(p=r.querySelector(mo(f)),p||(t=m({src:t,async:!0},s),(s=ei.get(f))&&qh(t,s),p=r.createElement("script"),Je(p),at(p,"link",t),r.head.appendChild(p)),p={type:"script",instance:p,count:1,state:null},c.set(f,p))}}function Eb(t,s){Gi.M(t,s);var r=ta;if(r&&t){var c=Cn(r).hoistableScripts,f=sa(t),p=c.get(f);p||(p=r.querySelector(mo(f)),p||(t=m({src:t,async:!0,type:"module"},s),(s=ei.get(f))&&qh(t,s),p=r.createElement("script"),Je(p),at(p,"link",t),r.head.appendChild(p)),p={type:"script",instance:p,count:1,state:null},c.set(f,p))}}function Pg(t,s,r,c){var f=(f=ue.current)?Gr(f):null;if(!f)throw Error(n(446));switch(t){case"meta":case"title":return null;case"style":return typeof r.precedence=="string"&&typeof r.href=="string"?(s=ia(r.href),r=Cn(f).hoistableStyles,c=r.get(s),c||(c={type:"style",instance:null,count:0,state:null},r.set(s,c)),c):{type:"void",instance:null,count:0,state:null};case"link":if(r.rel==="stylesheet"&&typeof r.href=="string"&&typeof r.precedence=="string"){t=ia(r.href);var p=Cn(f).hoistableStyles,S=p.get(t);if(S||(f=f.ownerDocument||f,S={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},p.set(t,S),(p=f.querySelector(po(t)))&&!p._p&&(S.instance=p,S.state.loading=5),ei.has(t)||(r={rel:"preload",as:"style",href:r.href,crossOrigin:r.crossOrigin,integrity:r.integrity,media:r.media,hrefLang:r.hrefLang,referrerPolicy:r.referrerPolicy},ei.set(t,r),p||Bb(f,t,r,S.state))),s&&c===null)throw Error(n(528,""));return S}if(s&&c!==null)throw Error(n(529,""));return null;case"script":return s=r.async,r=r.src,typeof r=="string"&&s&&typeof s!="function"&&typeof s!="symbol"?(s=sa(r),r=Cn(f).hoistableScripts,c=r.get(s),c||(c={type:"script",instance:null,count:0,state:null},r.set(s,c)),c):{type:"void",instance:null,count:0,state:null};default:throw Error(n(444,t))}}function ia(t){return'href="'+qt(t)+'"'}function po(t){return'link[rel="stylesheet"]['+t+"]"}function Lg(t){return m({},t,{"data-precedence":t.precedence,precedence:null})}function Bb(t,s,r,c){t.querySelector('link[rel="preload"][as="style"]['+s+"]")?c.loading=1:(s=t.createElement("link"),c.preload=s,s.addEventListener("load",function(){return c.loading|=1}),s.addEventListener("error",function(){return c.loading|=2}),at(s,"link",r),Je(s),t.head.appendChild(s))}function sa(t){return'[src="'+qt(t)+'"]'}function mo(t){return"script[async]"+t}function Og(t,s,r){if(s.count++,s.instance===null)switch(s.type){case"style":var c=t.querySelector('style[data-href~="'+qt(r.href)+'"]');if(c)return s.instance=c,Je(c),c;var f=m({},r,{"data-href":r.href,"data-precedence":r.precedence,href:null,precedence:null});return c=(t.ownerDocument||t).createElement("style"),Je(c),at(c,"style",f),zr(c,r.precedence,t),s.instance=c;case"stylesheet":f=ia(r.href);var p=t.querySelector(po(f));if(p)return s.state.loading|=4,s.instance=p,Je(p),p;c=Lg(r),(f=ei.get(f))&&Yh(c,f),p=(t.ownerDocument||t).createElement("link"),Je(p);var S=p;return S._p=new Promise(function(T,R){S.onload=T,S.onerror=R}),at(p,"link",c),s.state.loading|=4,zr(p,r.precedence,t),s.instance=p;case"script":return p=sa(r.src),(f=t.querySelector(mo(p)))?(s.instance=f,Je(f),f):(c=r,(f=ei.get(p))&&(c=m({},r),qh(c,f)),t=t.ownerDocument||t,f=t.createElement("script"),Je(f),at(f,"link",c),t.head.appendChild(f),s.instance=f);case"void":return null;default:throw Error(n(443,s.type))}else s.type==="stylesheet"&&(s.state.loading&4)===0&&(c=s.instance,s.state.loading|=4,zr(c,r.precedence,t));return s.instance}function zr(t,s,r){for(var c=r.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),f=c.length?c[c.length-1]:null,p=f,S=0;S<c.length;S++){var T=c[S];if(T.dataset.precedence===s)p=T;else if(p!==f)break}p?p.parentNode.insertBefore(t,p.nextSibling):(s=r.nodeType===9?r.head:r,s.insertBefore(t,s.firstChild))}function Yh(t,s){t.crossOrigin==null&&(t.crossOrigin=s.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=s.referrerPolicy),t.title==null&&(t.title=s.title)}function qh(t,s){t.crossOrigin==null&&(t.crossOrigin=s.crossOrigin),t.referrerPolicy==null&&(t.referrerPolicy=s.referrerPolicy),t.integrity==null&&(t.integrity=s.integrity)}var Xr=null;function Fg(t,s,r){if(Xr===null){var c=new Map,f=Xr=new Map;f.set(r,c)}else f=Xr,c=f.get(r),c||(c=new Map,f.set(r,c));if(c.has(t))return c;for(c.set(t,null),r=r.getElementsByTagName(t),f=0;f<r.length;f++){var p=r[f];if(!(p[Ea]||p[dt]||t==="link"&&p.getAttribute("rel")==="stylesheet")&&p.namespaceURI!=="http://www.w3.org/2000/svg"){var S=p.getAttribute(s)||"";S=t+S;var T=c.get(S);T?T.push(p):c.set(S,[p])}}return c}function Ug(t,s,r){t=t.ownerDocument||t,t.head.insertBefore(r,s==="title"?t.querySelector("head > title"):null)}function Ib(t,s,r){if(r===1||s.itemProp!=null)return!1;switch(t){case"meta":case"title":return!0;case"style":if(typeof s.precedence!="string"||typeof s.href!="string"||s.href==="")break;return!0;case"link":if(typeof s.rel!="string"||typeof s.href!="string"||s.href===""||s.onLoad||s.onError)break;switch(s.rel){case"stylesheet":return t=s.disabled,typeof s.precedence=="string"&&t==null;default:return!0}case"script":if(s.async&&typeof s.async!="function"&&typeof s.async!="symbol"&&!s.onLoad&&!s.onError&&s.src&&typeof s.src=="string")return!0}return!1}function Ng(t){return!(t.type==="stylesheet"&&(t.state.loading&3)===0)}var yo=null;function xb(){}function _b(t,s,r){if(yo===null)throw Error(n(475));var c=yo;if(s.type==="stylesheet"&&(typeof r.media!="string"||matchMedia(r.media).matches!==!1)&&(s.state.loading&4)===0){if(s.instance===null){var f=ia(r.href),p=t.querySelector(po(f));if(p){t=p._p,t!==null&&typeof t=="object"&&typeof t.then=="function"&&(c.count++,c=Vr.bind(c),t.then(c,c)),s.state.loading|=4,s.instance=p,Je(p);return}p=t.ownerDocument||t,r=Lg(r),(f=ei.get(f))&&Yh(r,f),p=p.createElement("link"),Je(p);var S=p;S._p=new Promise(function(T,R){S.onload=T,S.onerror=R}),at(p,"link",r),s.instance=p}c.stylesheets===null&&(c.stylesheets=new Map),c.stylesheets.set(s,t),(t=s.state.preload)&&(s.state.loading&3)===0&&(c.count++,s=Vr.bind(c),t.addEventListener("load",s),t.addEventListener("error",s))}}function Db(){if(yo===null)throw Error(n(475));var t=yo;return t.stylesheets&&t.count===0&&jh(t,t.stylesheets),0<t.count?function(s){var r=setTimeout(function(){if(t.stylesheets&&jh(t,t.stylesheets),t.unsuspend){var c=t.unsuspend;t.unsuspend=null,c()}},6e4);return t.unsuspend=s,function(){t.unsuspend=null,clearTimeout(r)}}:null}function Vr(){if(this.count--,this.count===0){if(this.stylesheets)jh(this,this.stylesheets);else if(this.unsuspend){var t=this.unsuspend;this.unsuspend=null,t()}}}var Yr=null;function jh(t,s){t.stylesheets=null,t.unsuspend!==null&&(t.count++,Yr=new Map,s.forEach(Pb,t),Yr=null,Vr.call(t))}function Pb(t,s){if(!(s.state.loading&4)){var r=Yr.get(t);if(r)var c=r.get(null);else{r=new Map,Yr.set(t,r);for(var f=t.querySelectorAll("link[data-precedence],style[data-precedence]"),p=0;p<f.length;p++){var S=f[p];(S.nodeName==="LINK"||S.getAttribute("media")!=="not all")&&(r.set(S.dataset.precedence,S),c=S)}c&&r.set(null,c)}f=s.instance,S=f.getAttribute("data-precedence"),p=r.get(S)||c,p===c&&r.set(null,f),r.set(S,f),this.count++,c=Vr.bind(this),f.addEventListener("load",c),f.addEventListener("error",c),p?p.parentNode.insertBefore(f,p.nextSibling):(t=t.nodeType===9?t.head:t,t.insertBefore(f,t.firstChild)),s.state.loading|=4}}var vo={$$typeof:x,Provider:null,Consumer:null,_currentValue:se,_currentValue2:se,_threadCount:0};function Lb(t,s,r,c,f,p,S,T){this.tag=1,this.containerInfo=t,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=Xl(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Xl(0),this.hiddenUpdates=Xl(null),this.identifierPrefix=c,this.onUncaughtError=f,this.onCaughtError=p,this.onRecoverableError=S,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=T,this.incompleteTransitions=new Map}function Hg(t,s,r,c,f,p,S,T,R,O,V,j){return t=new Lb(t,s,r,S,T,R,O,j),s=1,p===!0&&(s|=24),p=Ot(3,null,null,s),t.current=p,p.stateNode=t,s=Bc(),s.refCount++,t.pooledCache=s,s.refCount++,p.memoizedState={element:c,isDehydrated:r,cache:s},Dc(p),t}function Wg(t){return t?(t=Pn,t):Pn}function Gg(t,s,r,c,f,p){f=Wg(f),c.context===null?c.context=f:c.pendingContext=f,c=ss(s),c.payload={element:r},p=p===void 0?null:p,p!==null&&(c.callback=p),r=ns(t,c,s),r!==null&&(Wt(r,t,s),qa(r,t,s))}function zg(t,s){if(t=t.memoizedState,t!==null&&t.dehydrated!==null){var r=t.retryLane;t.retryLane=r!==0&&r<s?r:s}}function Kh(t,s){zg(t,s),(t=t.alternate)&&zg(t,s)}function Xg(t){if(t.tag===13){var s=Dn(t,67108864);s!==null&&Wt(s,t,67108864),Kh(t,67108864)}}var qr=!0;function Ob(t,s,r,c){var f=_.T;_.T=null;var p=z.p;try{z.p=2,Zh(t,s,r,c)}finally{z.p=p,_.T=f}}function Fb(t,s,r,c){var f=_.T;_.T=null;var p=z.p;try{z.p=8,Zh(t,s,r,c)}finally{z.p=p,_.T=f}}function Zh(t,s,r,c){if(qr){var f=Qh(c);if(f===null)Fh(t,s,c,jr,r),Yg(t,c);else if(Nb(f,t,s,r,c))c.stopPropagation();else if(Yg(t,c),s&4&&-1<Ub.indexOf(t)){for(;f!==null;){var p=Mn(f);if(p!==null)switch(p.tag){case 3:if(p=p.stateNode,p.current.memoizedState.isDehydrated){var S=Ps(p.pendingLanes);if(S!==0){var T=p;for(T.pendingLanes|=2,T.entangledLanes|=2;S;){var R=1<<31-Pt(S);T.entanglements[1]|=R,S&=~R}yi(p),(Ie&6)===0&&(xr=fi()+500,ho(0))}}break;case 13:T=Dn(p,2),T!==null&&Wt(T,p,2),Dr(),Kh(p,2)}if(p=Qh(c),p===null&&Fh(t,s,c,jr,r),p===f)break;f=p}f!==null&&c.stopPropagation()}else Fh(t,s,c,null,r)}}function Qh(t){return t=ic(t),$h(t)}var jr=null;function $h(t){if(jr=null,t=Sn(t),t!==null){var s=l(t);if(s===null)t=null;else{var r=s.tag;if(r===13){if(t=h(s),t!==null)return t;t=null}else if(r===3){if(s.stateNode.current.memoizedState.isDehydrated)return s.tag===3?s.stateNode.containerInfo:null;t=null}else s!==t&&(t=null)}}return jr=t,null}function Vg(t){switch(t){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(Ty()){case af:return 2;case of:return 8;case Ho:case wy:return 32;case rf:return 268435456;default:return 32}default:return 32}}var Jh=!1,ys=null,vs=null,bs=null,bo=new Map,So=new Map,Ss=[],Ub="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function Yg(t,s){switch(t){case"focusin":case"focusout":ys=null;break;case"dragenter":case"dragleave":vs=null;break;case"mouseover":case"mouseout":bs=null;break;case"pointerover":case"pointerout":bo.delete(s.pointerId);break;case"gotpointercapture":case"lostpointercapture":So.delete(s.pointerId)}}function Mo(t,s,r,c,f,p){return t===null||t.nativeEvent!==p?(t={blockedOn:s,domEventName:r,eventSystemFlags:c,nativeEvent:p,targetContainers:[f]},s!==null&&(s=Mn(s),s!==null&&Xg(s)),t):(t.eventSystemFlags|=c,s=t.targetContainers,f!==null&&s.indexOf(f)===-1&&s.push(f),t)}function Nb(t,s,r,c,f){switch(s){case"focusin":return ys=Mo(ys,t,s,r,c,f),!0;case"dragenter":return vs=Mo(vs,t,s,r,c,f),!0;case"mouseover":return bs=Mo(bs,t,s,r,c,f),!0;case"pointerover":var p=f.pointerId;return bo.set(p,Mo(bo.get(p)||null,t,s,r,c,f)),!0;case"gotpointercapture":return p=f.pointerId,So.set(p,Mo(So.get(p)||null,t,s,r,c,f)),!0}return!1}function qg(t){var s=Sn(t.target);if(s!==null){var r=l(s);if(r!==null){if(s=r.tag,s===13){if(s=h(r),s!==null){t.blockedOn=s,_y(t.priority,function(){if(r.tag===13){var c=Ht();c=Vl(c);var f=Dn(r,c);f!==null&&Wt(f,r,c),Kh(r,c)}});return}}else if(s===3&&r.stateNode.current.memoizedState.isDehydrated){t.blockedOn=r.tag===3?r.stateNode.containerInfo:null;return}}}t.blockedOn=null}function Kr(t){if(t.blockedOn!==null)return!1;for(var s=t.targetContainers;0<s.length;){var r=Qh(t.nativeEvent);if(r===null){r=t.nativeEvent;var c=new r.constructor(r.type,r);tc=c,r.target.dispatchEvent(c),tc=null}else return s=Mn(r),s!==null&&Xg(s),t.blockedOn=r,!1;s.shift()}return!0}function jg(t,s,r){Kr(t)&&r.delete(s)}function Hb(){Jh=!1,ys!==null&&Kr(ys)&&(ys=null),vs!==null&&Kr(vs)&&(vs=null),bs!==null&&Kr(bs)&&(bs=null),bo.forEach(jg),So.forEach(jg)}function Zr(t,s){t.blockedOn===s&&(t.blockedOn=null,Jh||(Jh=!0,a.unstable_scheduleCallback(a.unstable_NormalPriority,Hb)))}var Qr=null;function Kg(t){Qr!==t&&(Qr=t,a.unstable_scheduleCallback(a.unstable_NormalPriority,function(){Qr===t&&(Qr=null);for(var s=0;s<t.length;s+=3){var r=t[s],c=t[s+1],f=t[s+2];if(typeof c!="function"){if($h(c||r)===null)continue;break}var p=Mn(r);p!==null&&(t.splice(s,3),s-=3,$c(p,{pending:!0,data:f,method:r.method,action:c},c,f))}}))}function Co(t){function s(R){return Zr(R,t)}ys!==null&&Zr(ys,t),vs!==null&&Zr(vs,t),bs!==null&&Zr(bs,t),bo.forEach(s),So.forEach(s);for(var r=0;r<Ss.length;r++){var c=Ss[r];c.blockedOn===t&&(c.blockedOn=null)}for(;0<Ss.length&&(r=Ss[0],r.blockedOn===null);)qg(r),r.blockedOn===null&&Ss.shift();if(r=(t.ownerDocument||t).$$reactFormReplay,r!=null)for(c=0;c<r.length;c+=3){var f=r[c],p=r[c+1],S=f[At]||null;if(typeof p=="function")S||Kg(r);else if(S){var T=null;if(p&&p.hasAttribute("formAction")){if(f=p,S=p[At]||null)T=S.formAction;else if($h(f)!==null)continue}else T=S.action;typeof T=="function"?r[c+1]=T:(r.splice(c,3),c-=3),Kg(r)}}}function eu(t){this._internalRoot=t}$r.prototype.render=eu.prototype.render=function(t){var s=this._internalRoot;if(s===null)throw Error(n(409));var r=s.current,c=Ht();Gg(r,c,t,s,null,null)},$r.prototype.unmount=eu.prototype.unmount=function(){var t=this._internalRoot;if(t!==null){this._internalRoot=null;var s=t.containerInfo;Gg(t.current,2,null,t,null,null),Dr(),s[bn]=null}};function $r(t){this._internalRoot=t}$r.prototype.unstable_scheduleHydration=function(t){if(t){var s=ff();t={blockedOn:null,target:t,priority:s};for(var r=0;r<Ss.length&&s!==0&&s<Ss[r].priority;r++);Ss.splice(r,0,t),r===0&&qg(t)}};var Zg=e.version;if(Zg!=="19.1.0")throw Error(n(527,Zg,"19.1.0"));z.findDOMNode=function(t){var s=t._reactInternals;if(s===void 0)throw typeof t.render=="function"?Error(n(188)):(t=Object.keys(t).join(","),Error(n(268,t)));return t=d(s),t=t!==null?g(t):null,t=t===null?null:t.stateNode,t};var Wb={bundleType:0,version:"19.1.0",rendererPackageName:"react-dom",currentDispatcherRef:_,reconcilerVersion:"19.1.0"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var Jr=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!Jr.isDisabled&&Jr.supportsFiber)try{Aa=Jr.inject(Wb),Dt=Jr}catch{}}return Ao.createRoot=function(t,s){if(!o(t))throw Error(n(299));var r=!1,c="",f=f0,p=d0,S=g0,T=null;return s!=null&&(s.unstable_strictMode===!0&&(r=!0),s.identifierPrefix!==void 0&&(c=s.identifierPrefix),s.onUncaughtError!==void 0&&(f=s.onUncaughtError),s.onCaughtError!==void 0&&(p=s.onCaughtError),s.onRecoverableError!==void 0&&(S=s.onRecoverableError),s.unstable_transitionCallbacks!==void 0&&(T=s.unstable_transitionCallbacks)),s=Hg(t,1,!1,null,null,r,c,f,p,S,T,null),t[bn]=s.current,Oh(t),new eu(s)},Ao.hydrateRoot=function(t,s,r){if(!o(t))throw Error(n(299));var c=!1,f="",p=f0,S=d0,T=g0,R=null,O=null;return r!=null&&(r.unstable_strictMode===!0&&(c=!0),r.identifierPrefix!==void 0&&(f=r.identifierPrefix),r.onUncaughtError!==void 0&&(p=r.onUncaughtError),r.onCaughtError!==void 0&&(S=r.onCaughtError),r.onRecoverableError!==void 0&&(T=r.onRecoverableError),r.unstable_transitionCallbacks!==void 0&&(R=r.unstable_transitionCallbacks),r.formState!==void 0&&(O=r.formState)),s=Hg(t,1,!0,s,r??null,c,f,p,S,T,R,O),s.context=Wg(null),r=s.current,c=Ht(),c=Vl(c),f=ss(c),f.callback=null,ns(r,f,c),r=c,s.current.lanes=r,Ra(s,r),yi(s),t[bn]=s.current,Oh(t),new $r(s)},Ao.version="19.1.0",Ao}var fp;function HS(){if(fp)return su.exports;fp=1;function a(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(a)}catch(e){console.error(e)}}return a(),su.exports=NS(),su.exports}var WS=HS();const GS=zb(WS);var Cl=Uu();function wi(a){const e=a.replace(/^\/+/,""),i=window.location.pathname.startsWith("/shipwright-survivors");return i&&e.startsWith("shipwright-survivors/")?"/"+e:(i?"/shipwright-survivors/":"./")+e}const lu=.2;class zS{constructor(){this.bufferCache=new Map,this.currentlyPlaying=new Map,this.activeLoops=new Map,this.loopStartLocks=new Map,this.currentMusicSource=null,this.currentMusicFile=null,this.isMusicLooping=!1,this.context=new AudioContext,this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.channelGains={music:this.context.createGain(),sfx:this.context.createGain(),dialogue:this.context.createGain()};for(const e of Object.values(this.channelGains))e.connect(this.masterGain)}async play(e,i,n){const o=(n==null?void 0:n.maxSimultaneous)??1,l=Math.max(0,Math.min(1,(n==null?void 0:n.volume)??1)),h=Math.max(-1,Math.min(1,(n==null?void 0:n.pan)??0)),u=this.currentlyPlaying.get(e)??0;if(u>=o)return!1;let d=this.bufferCache.get(e);if(!d)try{const M=await(await fetch(wi(e))).arrayBuffer();d=await this.context.decodeAudioData(M),this.bufferCache.set(e,d)}catch(v){return console.warn(`Failed to load audio file: ${e}`,v),!1}const g=this.context.createBufferSource();g.buffer=d,g.playbackRate.value=(n==null?void 0:n.pitch)??1;const m=this.context.createGain();m.gain.value=l;const y=this.context.createStereoPanner();return y.pan.value=h,g.connect(m),m.connect(y),y.connect(this.channelGains[i]),this.currentlyPlaying.set(e,u+1),g.onended=()=>{const v=this.currentlyPlaying.get(e)??1,M=Math.max(0,v-1);M===0?this.currentlyPlaying.delete(e):this.currentlyPlaying.set(e,M)},g.start(0),!0}async startLoop(e,i,n){if(this.activeLoops.has(e)&&this.activeLoops.get(e).size>0)return;if(this.loopStartLocks.has(e)){await this.loopStartLocks.get(e);return}const o=this._startLoopInternal(e,i,n);this.loopStartLocks.set(e,o),await o,this.loopStartLocks.delete(e)}async _startLoopInternal(e,i,n){let o=this.bufferCache.get(e);if(!o)try{const b=await(await fetch(wi(e))).arrayBuffer();o=await this.context.decodeAudioData(b),this.bufferCache.set(e,o)}catch(M){console.warn(`[AudioManager] Failed to load audio file: ${e}`,M);return}const l=Math.max(0,Math.min(1,(n==null?void 0:n.volume)??1)),h=Math.max(-1,Math.min(1,(n==null?void 0:n.pan)??0)),u=(n==null?void 0:n.pitch)??1,d=this.context.createBufferSource();d.buffer=o,d.loop=!0,d.playbackRate.value=u;const g=this.context.createGain(),m=this.context.currentTime;g.gain.setValueAtTime(0,m),g.gain.linearRampToValueAtTime(l,m+lu);const y=this.context.createStereoPanner();y.pan.value=h,d.connect(g),g.connect(y),y.connect(this.channelGains[i]);const v={source:d,gain:g,pan:y};this.activeLoops.has(e)||this.activeLoops.set(e,new Set),this.activeLoops.get(e).add(v),d.start(0)}stopLoop(e){const i=this.activeLoops.get(e);if(!i||i.size===0)return;const n=this.context.currentTime;for(const{source:o,gain:l,pan:h}of i){try{l.gain.cancelScheduledValues(n),l.gain.setValueAtTime(l.gain.value,n),l.gain.linearRampToValueAtTime(0,n+lu)}catch(u){console.warn(`[AudioManager] Fade-out error for ${e}`,u)}setTimeout(()=>{try{o.stop()}catch(u){console.warn(`[AudioManager] Failed to stop source for ${e}`,u)}try{o.disconnect(),l.disconnect(),h.disconnect()}catch(u){console.warn(`[AudioManager] Failed to disconnect nodes for ${e}`,u)}},lu*1e3)}this.activeLoops.delete(e)}stopAllLoops(){for(const e of this.activeLoops.keys())this.stopLoop(e)}setChannelVolume(e,i){const n=Math.max(0,Math.min(1,i));this.channelGains[e].gain.value=n}getChannelVolume(e){return this.channelGains[e].gain.value}setMasterVolume(e){this.masterGain.gain.value=Math.max(0,Math.min(1,e))}getMasterVolume(){return this.masterGain.gain.value}unlock(){this.context.state==="suspended"&&this.context.resume()}clearCache(){this.bufferCache.clear()}async playMusic(e){const{file:i,loopStartMs:n=0}=e;if(this.currentMusicFile===i&&this.isMusicLooping)return;this.stopMusic();let o=this.bufferCache.get(i);if(!o)try{const h=await(await fetch(wi(i))).arrayBuffer();o=await this.context.decodeAudioData(h),this.bufferCache.set(i,o)}catch(l){console.warn(`Failed to load music file: ${i}`,l);return}if(n>0){const l=this.context.createBufferSource();l.buffer=o,l.loop=!1,l.connect(this.channelGains.music),l.start(0),this.currentMusicSource=l,this.currentMusicFile=i,this.isMusicLooping=!1,l.onended=()=>{if(this.currentMusicSource===l){const h=this.context.createBufferSource();h.buffer=o,h.loop=!0,h.loopStart=n/1e3,h.loopEnd=o.duration,h.connect(this.channelGains.music),h.start(0,n/1e3),this.currentMusicSource=h,this.currentMusicFile=i,this.isMusicLooping=!0}}}else{const l=this.context.createBufferSource();l.buffer=o,l.loop=!0,l.connect(this.channelGains.music),l.start(0),this.currentMusicSource=l,this.currentMusicFile=i,this.isMusicLooping=!0}}stopMusic(){this.currentMusicSource&&(this.currentMusicSource.stop(),this.currentMusicSource.disconnect(),this.currentMusicSource=null,this.currentMusicFile=null,this.isMusicLooping=!1)}}const $=new zS;class XS{constructor(){this.listeners=new Map}on(e,i){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(i)}off(e,i){var n;(n=this.listeners.get(e))==null||n.delete(i)}emit(e,i){var n;(n=this.listeners.get(e))==null||n.forEach(o=>o(i))}}const pe=new XS;function dp(a,e){pe.emit("resolution:changed",{width:a,height:e})}class ke{constructor(){this.masterVolume=1,this.musicVolume=1,this.sfxVolume=1,this.dialogueVolume=1,this.particlesEnabled=!0,this.lightingEnabled=!0,this.collisionsEnabled=!0,this.viewportWidth=1920,this.viewportHeight=1080,this.resolutionChangeCallbacks=[],this.interfaceScaleChangeCallbacks=[],this.interfaceScale=1}static getInstance(){return ke.instance||(ke.instance=new ke),ke.instance}onResolutionChange(e){return this.resolutionChangeCallbacks.push(e),()=>{this.resolutionChangeCallbacks=this.resolutionChangeCallbacks.filter(i=>i!==e)}}notifyResolutionChange(){for(const e of this.resolutionChangeCallbacks)e()}onInterfaceScaleChange(e){return this.interfaceScaleChangeCallbacks.push(e),()=>{this.interfaceScaleChangeCallbacks=this.interfaceScaleChangeCallbacks.filter(i=>i!==e)}}notifyInterfaceScaleChange(){for(const e of this.interfaceScaleChangeCallbacks)e()}setViewportWidth(e){this.viewportWidth=Math.max(640,e),this.notifyResolutionChange(),dp(this.viewportWidth,this.viewportHeight)}setViewportHeight(e){this.viewportHeight=Math.max(480,e),this.notifyResolutionChange(),dp(this.viewportWidth,this.viewportHeight)}getViewportWidth(){return this.viewportWidth}getViewportHeight(){return this.viewportHeight}setInterfaceScale(e){const i=Math.max(.5,Math.min(2,e));this.interfaceScale!==i&&(this.interfaceScale=i,this.notifyInterfaceScaleChange())}getInterfaceScale(){return 2}setMasterVolume(e){this.masterVolume=this.clampVolume(e),$.setMasterVolume(this.masterVolume)}setMusicVolume(e){this.musicVolume=this.clampVolume(e),$.setChannelVolume("music",this.musicVolume)}setSfxVolume(e){this.sfxVolume=this.clampVolume(e),$.setChannelVolume("sfx",this.sfxVolume)}setDialogueVolume(e){this.dialogueVolume=this.clampVolume(e),$.setChannelVolume("dialogue",this.dialogueVolume)}setParticlesEnabled(e){this.particlesEnabled=e}setLightingEnabled(e){this.lightingEnabled=e}setCollisionsEnabled(e){this.collisionsEnabled=e}getMasterVolume(){return this.masterVolume}getMusicVolume(){return this.musicVolume}getSfxVolume(){return this.sfxVolume}getDialogueVolume(){return this.dialogueVolume}isCollisionsEnabled(){return this.collisionsEnabled}isParticlesEnabled(){return this.particlesEnabled}isLightingEnabled(){return this.lightingEnabled}toJSON(){return JSON.stringify({masterVolume:this.masterVolume,musicVolume:this.musicVolume,sfxVolume:this.sfxVolume,dialogueVolume:this.dialogueVolume,particlesEnabled:this.particlesEnabled,lightingEnabled:this.lightingEnabled,viewportWidth:this.viewportWidth,viewportHeight:this.viewportHeight,interfaceScale:this.interfaceScale})}fromJSON(e){try{const i=JSON.parse(e);typeof i=="object"&&i!==null&&(this.setMasterVolume(i.masterVolume??this.masterVolume),this.setMusicVolume(i.musicVolume??this.musicVolume),this.setSfxVolume(i.sfxVolume??this.sfxVolume),this.setDialogueVolume(i.dialogueVolume??this.dialogueVolume),this.particlesEnabled=!!(i.particlesEnabled??this.particlesEnabled),this.lightingEnabled=!!(i.lightingEnabled??this.lightingEnabled),this.viewportWidth=Math.max(640,i.viewportWidth??this.viewportWidth),this.viewportHeight=Math.max(480,i.viewportHeight??this.viewportHeight),this.interfaceScale=Math.max(.5,Math.min(2,i.interfaceScale??this.interfaceScale)))}catch(i){console.warn("Failed to load player settings from JSON:",i)}}reset(){this.masterVolume=1,this.musicVolume=1,this.sfxVolume=1,this.dialogueVolume=1,this.particlesEnabled=!0,this.lightingEnabled=!0,this.interfaceScale=1}clampVolume(e){return Math.min(1,Math.max(0,e))}}const xm=1280,_m=720;function ku(a){return a*ui()/xm}function ma(a){return a*bi()/_m}function Tl(a){return{x:ku(a.x),y:ma(a.y),width:ku(a.width),height:ma(a.height)}}function ui(){return ke.getInstance().getViewportWidth()}function bi(){return ke.getInstance().getViewportHeight()}function VS(){return ui()/xm}function YS(){return bi()/_m}function ae(){return Math.min(VS(),YS())}function qS(){const a=ui(),e=bi();return a>=3840?1.8:a>=2560?1.2:e>=1200?1:.8}const gp={background:"background-canvas",entities:"entity-canvas",polygon:"polygon-canvas",fx:"fx-canvas",particles:"particles-canvas",ui:"ui-canvas",overlay:"overlay-canvas",dialogue:"dialogue-canvas",unifiedgl2:"unifiedgl2-canvas"},sn=class sn{constructor(){this.canvases={},this.contexts={},performance.mark("canvasManager-init-start"),this.initializeCanvases(),this.setFixedSize(),performance.mark("canvasManager-init-end"),performance.measure("CanvasManager Initialization","canvasManager-init-start","canvasManager-init-end")}static getInstance(){return sn._instance||(sn._instance=new sn),sn._instance}initializeCanvases(){for(const e of Object.keys(gp)){const i=gp[e],n=document.getElementById(i);if(!n||!(n instanceof HTMLCanvasElement))throw new Error(`CanvasManager error: element with ID "${i}" not found. Ensure canvases are in the DOM before sceneManager.setScene(...)`);if(!["polygon","unifiedgl2"].includes(e)){const o=n.getContext("2d",{willReadFrequently:!1});if(!o)throw new Error(`2D context not supported for "${i}"`);this.contexts[e]=o}n.style.zIndex=this.getZIndexForLayer(e).toString(),n.style.pointerEvents=e==="ui"?"auto":"none",n.style.position="absolute",this.canvases[e]=n}}setFixedSize(){const e=ui(),i=bi();for(const[n,o]of Object.entries(this.canvases))o.width=e,o.height=i,o.style.width=`${e}px`,o.style.height=`${i}px`}getZIndexForLayer(e){switch(e){case"background":return 1;case"polygon":return 3;case"entities":return 4;case"unifiedgl2":return 6;case"fx":return 7;case"particles":return 8;case"ui":return 9;case"overlay":return 10;case"dialogue":return 11}}getCanvas(e){return this.canvases[e]}getContext(e){return this.contexts[e]}getWebGLContext(e){const n=this.getCanvas(e).getContext("webgl");if(!n)throw new Error(`WebGL context not supported for "${e}"`);return n}getWebGL2Context(e){const n=this.getCanvas(e).getContext("webgl2");if(!n)throw new Error(`WebGL2 context not supported for layer "${e}"`);return n}clearLayer(e){e==="unifiedgl2"?this.clearWebGL2Layer(e):e==="polygon"?this.clearWebGLLayer(e):this.getContext(e).clearRect(0,0,ui(),bi())}clearWebGLLayer(e,i=[0,0,0,0]){const n=this.getCanvas(e),o=n.getContext("webgl");if(!o)throw new Error(`Cannot clear WebGL layer '${e}': no WebGL context available`);o.viewport(0,0,n.width,n.height),o.clearColor(...i),o.clear(o.COLOR_BUFFER_BIT)}clearWebGL2Layer(e,i=[0,0,0,0]){const n=this.getCanvas(e),o=n.getContext("webgl2");if(!o)throw new Error(`Cannot clear WebGL2 layer '${e}': no WebGL2 context available`);o.viewport(0,0,n.width,n.height),o.clearColor(...i),o.clear(o.COLOR_BUFFER_BIT)}clearAll(){for(const e of Object.keys(this.contexts))this.clearLayer(e)}getWidth(){return ui()}getHeight(){return bi()}getDimensions(){return{width:ui(),height:bi()}}resize(){performance.mark("canvasManager-resize-start");const e=ui(),i=bi();for(const[n,o]of Object.entries(this.canvases))o.width=e,o.height=i,o.style.width=`${e}px`,o.style.height=`${i}px`;performance.mark("canvasManager-resize-end"),performance.measure("CanvasManager Resize","canvasManager-resize-start","canvasManager-resize-end")}};sn._instance=null;let Ai=sn;function jS(){if(document.fullscreenElement)document.exitFullscreen?document.exitFullscreen().catch(a=>{console.warn("Failed to exit fullscreen:",a)}):document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen();else{const a=document.documentElement;a.requestFullscreen?a.requestFullscreen().catch(e=>{console.warn("Failed to enter fullscreen:",e)}):a.webkitRequestFullscreen?a.webkitRequestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():console.warn("Fullscreen API not supported in this browser")}}const nn=class nn{constructor(){this.lastUsed="keyboard",this.lastUsedTimestamp=performance.now()}static getInstance(){return nn._instance||(nn._instance=new nn),nn._instance}updateDevice(e){this.lastUsed!==e&&(this.lastUsed=e,this.lastUsedTimestamp=performance.now())}getLastUsed(){return this.lastUsed}getLastUsedTimestamp(){return this.lastUsedTimestamp}};nn._instance=null;let wt=nn;const cu=.2;class KS{constructor(){this.connected=!1,this.prevButtons=new Set,this.currentButtons=new Set,this.justPressed=new Set,this.justReleased=new Set,this.leftStick={x:0,y:0},this.rightStick={x:0,y:0}}updateFrame(){this.justPressed.clear(),this.justReleased.clear();const e=this.getPrimaryGamepad();if(!e){this.connected=!1,this.currentButtons.clear();return}this.connected=!0;const i={...this.leftStick},n={...this.rightStick};this.currentButtons.size,this.pollButtons(e),this.pollSticks(e);const o=this.justPressed.size>0||this.justReleased.size>0,l=Math.abs(i.x-this.leftStick.x)>.05||Math.abs(i.y-this.leftStick.y)>.05,h=Math.abs(n.x-this.rightStick.x)>.05||Math.abs(n.y-this.rightStick.y)>.05;(o||l||h)&&wt.getInstance().updateDevice("gamepad")}isActionPressed(e){return this.currentButtons.has(e)}wasActionJustPressed(e){return this.justPressed.has(e)}wasActionJustReleased(e){return this.justReleased.has(e)}getLeftStick(){return this.leftStick}getRightStick(){return this.rightStick}isConnected(){return this.connected}getPrimaryGamepad(){var i;const e=((i=navigator.getGamepads)==null?void 0:i.call(navigator))??[];for(const n of e)if(n&&n.connected&&n.mapping==="standard")return n;return null}pollButtons(e){const i=new Set,n=this.prevButtons;for(let o=0;o<e.buttons.length;o++)if(e.buttons[o].pressed){const h=this.mapButtonIndexToAlias(o);h&&i.add(h)}for(const o of i)n.has(o)||this.justPressed.add(o);for(const o of n)i.has(o)||this.justReleased.add(o);this.prevButtons=new Set(i),this.currentButtons=i}pollSticks(e){const i=e.axes[0]??0,n=e.axes[1]??0,o=Math.hypot(i,n);if(o<cu)this.leftStick={x:0,y:0};else{const d=i/o,g=n/o;this.leftStick={x:d,y:g}}const l=e.axes[2]??0,h=e.axes[3]??0,u=Math.hypot(l,h);if(u<cu)this.rightStick={x:0,y:0};else{const d=l/u,g=h/u;this.rightStick={x:d,y:g}}}applyDeadzone(e){return Math.abs(e)<cu?0:e}mapButtonIndexToAlias(e){switch(e){case 0:return"A";case 1:return"B";case 2:return"X";case 3:return"Y";case 4:return"leftBumper";case 5:return"rightBumper";case 6:return"leftTrigger";case 7:return"rightTrigger";case 8:return"start";case 9:return"select";case 10:return"leftStickButton";case 11:return"rightStickButton";case 12:return"dpadUp";case 13:return"dpadDown";case 14:return"dpadLeft";case 15:return"dpadRight";case 16:return"home";default:return null}}normalize(e,i){const n=Math.hypot(e,i);return n>1e-5?{x:e/n,y:i/n}:{x:0,y:0}}}const zi={thrustForward:{keys:["KeyW"],gamepadButtons:["leftTrigger"]},afterburner:{keys:["ShiftLeft"],gamepadButtons:["leftBumper"]},brake:{keys:["KeyS"],gamepadButtons:["B"]},powerSlide:{keys:[],gamepadButtons:[]},rotateLeft:{keys:["KeyA"],gamepadButtons:[]},rotateRight:{keys:["KeyD"],gamepadButtons:[]},strafeLeft:{keys:["KeyQ"],gamepadButtons:["dpadLeft"]},strafeRight:{keys:["KeyE"],gamepadButtons:["dpadRight"]},firePrimary:{keys:["MouseLeft"],gamepadButtons:["rightBumper"]},fireSecondary:{keys:["MouseRight"],gamepadButtons:["rightTrigger"]},fireTertiary:{keys:["Space"],gamepadButtons:["leftTrigger"]},fireQuaternary:{keys:["KeyC"],gamepadButtons:[]},switchFiringMode:{keys:["KeyX"],gamepadButtons:["X"]},openMenu:{keys:["Escape"],gamepadButtons:["start"]},openShipBuilder:{keys:["Tab"],gamepadButtons:["Y"]},select:{keys:["Enter"],gamepadButtons:["A"]},cancel:{keys:["Escape"],gamepadButtons:["B"]},pause:{keys:["Escape"],gamepadButtons:["start"]}};function Nu(){return typeof window<"u"&&typeof navigator=="object"&&navigator.userAgent.toLowerCase().includes("electron")}class ZS{constructor(){this.strength=0,this.duration=0,this.maxDuration=0,this.frequency=30,this.time=0,this.phaseX=0,this.phaseY=0,this.offsetX=0,this.offsetY=0}trigger(e,i,n=30){this.strength=e,this.duration=i,this.maxDuration=i,this.frequency=n,this.time=0,this.phaseX=Math.random()*Math.PI*2,this.phaseY=Math.random()*Math.PI*2}update(e){if(this.duration<=0){this.offsetX=0,this.offsetY=0;return}this.time+=e,this.duration-=e;const i=Math.max(0,this.duration/this.maxDuration),n=this.frequency*2*Math.PI,o=this.strength*i;this.offsetX=Math.sin(this.time*n+this.phaseX)*o,this.offsetY=Math.sin(this.time*n+this.phaseY)*o}getOffset(){return{x:this.offsetX,y:this.offsetY}}isActive(){return this.duration>0}stop(){this.duration=0,this.offsetX=0,this.offsetY=0}}const vi=class vi{constructor(e,i){this.screenShake=new ZS,this.x=0,this.y=0,this.zoom=.3,this.targetX=0,this.targetY=0,this.skipSmoothingThisFrame=!1,this.deadZoneRadius=12,this.zoomAnimationTarget=null,this.zoomAnimationSpeed=.025,this.handleShakeEvent=({strength:n,duration:o,frequency:l})=>{this.screenShake.trigger(n,o,l)},this.viewportWidth=e,this.viewportHeight=i,pe.on("camera:shake",this.handleShakeEvent)}static getInstance(e,i){if(!vi._instance){if(e==null||i==null)throw new Error("[Camera] Must supply viewport dimensions on first initialization");vi._instance=new vi(e,i)}return vi._instance}static destroy(){vi._instance&&(vi._instance.cleanup(),vi._instance=null)}update(e){this.screenShake.update(e);const i=this.targetX-this.x,n=this.targetY-this.y,o=i*i+n*n;if(this.skipSmoothingThisFrame)this.x=this.targetX,this.y=this.targetY;else if(o>this.deadZoneRadius*this.deadZoneRadius){const u=(d,g,m)=>d+(g-d)*m;this.x=u(this.x,this.targetX,1.05),this.y=u(this.y,this.targetY,1.05)}const l=this.screenShake.getOffset();if(this.x+=l.x/this.zoom,this.y+=l.y/this.zoom,this.zoomAnimationTarget!==null){const h=this.zoomAnimationTarget-this.zoom;if(Math.abs(h)>.001){const u=this.zoomAnimationSpeed*h,d=this.zoom+u,g=Math.log(d/this.zoom)/Math.log(1.08);this.adjustZoom(g)}else this.zoom=this.zoomAnimationTarget,this.zoomAnimationTarget=null}this.skipSmoothingThisFrame=!1}follow(e){this.targetX=e.x-this.viewportWidth/2/this.zoom,this.targetY=e.y-this.viewportHeight/2/this.zoom}worldToScreen(e,i){return{x:(e-this.x)*this.zoom,y:(i-this.y)*this.zoom}}screenToWorld(e,i){return{x:e/this.zoom+this.x,y:i/this.zoom+this.y}}getOffset(){return{x:this.x,y:this.y}}getPosition(){return{x:this.x+this.viewportWidth/2/this.zoom,y:this.y+this.viewportHeight/2/this.zoom}}adjustZoom(e){const n=Math.max(-1,Math.min(1,e)),o=this.screenToWorld(this.viewportWidth/2,this.viewportHeight/2),l=n>0?this.zoom*Math.pow(1.08,n):this.zoom/Math.pow(1.08,-n),h=ae(),u=.15*h,d=.5*h;this.zoom=Math.min(d,Math.max(u,l));const g=this.screenToWorld(this.viewportWidth/2,this.viewportHeight/2),m=o.x-g.x,y=o.y-g.y;this.x+=m,this.y+=y,this.targetX+=m,this.targetY+=y,this.skipSmoothingThisFrame=!0}animateZoomTo(e,i=.025){const n=ae(),o=.15*n,l=.5*n;this.zoomAnimationTarget=Math.min(l,Math.max(o,e)),this.zoomAnimationSpeed=i}getZoom(){return this.zoom}abortZoomAnimation(){this.zoomAnimationTarget=null}getViewportBounds(){const e=this.viewportWidth/this.zoom,i=this.viewportHeight/this.zoom;return{x:this.x,y:this.y,width:e,height:i}}getViewBounds(e){const i=e.getCanvas("unifiedgl2"),n=i.width/this.zoom,o=i.height/this.zoom;return{left:this.x,right:this.x+n,bottom:this.y+o,top:this.y}}getViewportWidth(){return this.viewportWidth}getViewportHeight(){return this.viewportHeight}resize(e,i){this.viewportWidth=e,this.viewportHeight=i}cleanup(){pe.off("camera:shake",this.handleShakeEvent),this.x=0,this.y=0,this.zoom=.3,this.targetX=0,this.targetY=0,this.skipSmoothingThisFrame=!1,this.viewportWidth=0,this.viewportHeight=0,this.screenShake.trigger(0,0)}};vi._instance=null;let ut=vi;class Dm{constructor(e){this.canvasElement=e,this.gamepadManager=new KS,this.keyState={},this.prevKeyState={},this.justPressedKeys=new Set,this.justReleasedKeys=new Set,this.disabledKeys=new Set,this.disabledGamepadButtons=new Set,this.inputDisabled=!1,this.leftStickDisabled=!1,this.rightStickDisabled=!1,this.mouseMoved=!1,this.mouseState={x:0,y:0,leftDown:!1,rightDown:!1},this.scrollUpDetected=!1,this.scrollDownDetected=!1,this.initialized=!1,this.mouseMoveHandler=i=>{const n=i.target,o=n.getBoundingClientRect(),l=n.width/o.width,h=n.height/o.height,u=(i.clientX-o.left)*l,d=(i.clientY-o.top)*h;(u!==this.mouseState.x||d!==this.mouseState.y)&&(this.mouseMoved=!0,wt.getInstance().updateDevice("mouse")),this.mouseState.x=u,this.mouseState.y=d},this.keyDownHandler=i=>{this.keyState[i.code]={pressed:!0},wt.getInstance().updateDevice("keyboard")},this.keyUpHandler=i=>{this.keyState[i.code]={pressed:!1}},this.mouseDownHandler=i=>{i.button===0&&(this.mouseState.leftDown=!0),i.button===2&&(this.mouseState.rightDown=!0),wt.getInstance().updateDevice("mouse")},this.mouseUpHandler=i=>{i.button===0&&(this.mouseState.leftDown=!1),i.button===2&&(this.mouseState.rightDown=!1)},this.wheelHandler=i=>{const n=Math.sign(i.deltaY);n<0?this.scrollUpDetected=!0:n>0&&(this.scrollDownDetected=!0)},this.contextMenuHandler=i=>{i.preventDefault()},this.initialize()}disableInput(){this.inputDisabled=!0}enableInput(){this.inputDisabled=!1}getMousePosition(){return{x:this.mouseState.x,y:this.mouseState.y}}initialize(){this.initialized||(this.initialized=!0,window.addEventListener("keydown",this.keyDownHandler),window.addEventListener("keyup",this.keyUpHandler),window.addEventListener("mousedown",this.mouseDownHandler),window.addEventListener("mouseup",this.mouseUpHandler),this.canvasElement.addEventListener("mousemove",this.mouseMoveHandler),window.addEventListener("wheel",this.wheelHandler),window.addEventListener("contextmenu",this.contextMenuHandler))}destroy(){this.initialized&&(this.initialized=!1,window.removeEventListener("keydown",this.keyDownHandler),window.removeEventListener("keyup",this.keyUpHandler),window.removeEventListener("mousedown",this.mouseDownHandler),window.removeEventListener("mouseup",this.mouseUpHandler),this.canvasElement.removeEventListener("mousemove",this.mouseMoveHandler),window.removeEventListener("wheel",this.wheelHandler),window.removeEventListener("contextmenu",this.contextMenuHandler))}updateFrame(){var e,i;this.gamepadManager.updateFrame(),this.mouseMoved=!1,this.justPressedKeys.clear(),this.justReleasedKeys.clear(),this.scrollUpDetected=!1,this.scrollDownDetected=!1,!this.prevKeyState.MouseLeft&&this.mouseState.leftDown&&this.justPressedKeys.add("MouseLeft"),this.prevKeyState.MouseLeft&&!this.mouseState.leftDown&&this.justReleasedKeys.add("MouseLeft"),!this.prevKeyState.MouseRight&&this.mouseState.rightDown&&this.justPressedKeys.add("MouseRight"),this.prevKeyState.MouseRight&&!this.mouseState.rightDown&&this.justReleasedKeys.add("MouseRight"),this.prevKeyState.MouseLeft=this.mouseState.leftDown,this.prevKeyState.MouseRight=this.mouseState.rightDown;for(const n in this.keyState){if(this.disabledKeys.has(n))continue;const o=((e=this.keyState[n])==null?void 0:e.pressed)??!1,l=this.prevKeyState[n]??!1;!l&&o&&this.justPressedKeys.add(n),l&&!o&&this.justReleasedKeys.add(n),this.prevKeyState[n]=o}this.wasKeyJustPressed("KeyY")&&(Nu()&&((i=window.electronAPI)!=null&&i.toggleFullscreen)?window.electronAPI.toggleFullscreen():jS())}disableKey(e){this.disabledKeys.add(e)}enableKey(e){this.disabledKeys.delete(e)}enableAllKeys(){this.disabledKeys.clear()}isKeyPressed(e){var i;return this.inputDisabled||this.disabledKeys.has(e)?!1:e==="MouseLeft"?this.mouseState.leftDown:e==="MouseRight"?this.mouseState.rightDown:((i=this.keyState[e])==null?void 0:i.pressed)??!1}wasKeyJustPressed(e){return this.inputDisabled||this.disabledKeys.has(e)?!1:this.justPressedKeys.has(e)}wasKeyJustReleased(e){return this.inputDisabled||this.disabledKeys.has(e)?!1:this.justReleasedKeys.has(e)}wasMouseClicked(){return this.inputDisabled?!1:this.wasKeyJustPressed("MouseLeft")}wasLeftClicked(){return this.inputDisabled?!1:this.wasKeyJustPressed("MouseLeft")}wasRightClicked(){return this.inputDisabled?!1:this.wasKeyJustPressed("MouseRight")}wasMouseMoved(){return this.inputDisabled?!1:this.mouseMoved}wasScrollWheelUp(){return this.inputDisabled?!1:this.scrollUpDetected}wasScrollWheelDown(){return this.inputDisabled?!1:this.scrollDownDetected}isShiftPressed(){return this.inputDisabled?!1:this.isKeyPressed("ShiftLeft")||this.isKeyPressed("ShiftRight")}consumeZoomDelta(){if(this.inputDisabled)return 0;const e=this.scrollUpDetected||this.isKeyPressed("KeyR"),i=this.scrollDownDetected||this.isKeyPressed("KeyT");return(e||i)&&ut.getInstance().abortZoomAnimation(),(e?10:0)+(i?-10:0)}isEscapePressed(){return this.isKeyPressed("Escape")}isMouseLeftPressed(){return this.isKeyPressed("MouseLeft")}isMouseRightPressed(){return this.isKeyPressed("MouseRight")}isTabPressed(){return this.isKeyPressed("Tab")}is0Pressed(){return this.isKeyPressed("Digit0")}isLPressed(){return this.isKeyPressed("KeyL")}wasLeftBracketPressed(){return this.wasKeyJustPressed("BracketLeft")}wasRightBracketPressed(){return this.wasKeyJustPressed("BracketRight")}isGamepadConnected(){return this.gamepadManager.isConnected()}getGamepadMovementVector(){return this.leftStickDisabled?{x:0,y:0}:this.gamepadManager.getLeftStick()}getGamepadAimVector(){return this.rightStickDisabled?{x:0,y:0}:this.gamepadManager.getRightStick()}disableGamepadButton(e){this.disabledGamepadButtons.add(e)}enableGamepadButton(e){this.disabledGamepadButtons.delete(e)}enableAllGamepadButtons(){this.disabledGamepadButtons.clear()}disableLeftStick(){this.leftStickDisabled=!0}enableLeftStick(){this.leftStickDisabled=!1}disableRightStick(){this.rightStickDisabled=!0}enableRightStick(){this.rightStickDisabled=!1}enableAllSticks(){this.leftStickDisabled=!1,this.rightStickDisabled=!1}isLeftStickMoved(){if(this.leftStickDisabled)return!1;const{x:e,y:i}=this.gamepadManager.getLeftStick();return Math.abs(e)>0||Math.abs(i)>0}isRightStickMoved(){if(this.rightStickDisabled)return!1;const{x:e,y:i}=this.gamepadManager.getRightStick();return Math.abs(e)>0||Math.abs(i)>0}isLeftTriggerPressed(){return!this.disabledGamepadButtons.has("leftTrigger")&&this.gamepadManager.isActionPressed("leftTrigger")}disableAllActions(){var e,i;for(const n in zi){const o=zi[n];(e=o.keys)==null||e.forEach(l=>this.disableKey(l)),(i=o.gamepadButtons)==null||i.forEach(l=>this.disableGamepadButton(l)),this.disableLeftStick(),this.disableRightStick()}}enableAllActions(){var e,i;for(const n in zi){const o=zi[n];(e=o.keys)==null||e.forEach(l=>this.enableKey(l)),(i=o.gamepadButtons)==null||i.forEach(l=>this.enableGamepadButton(l)),this.enableLeftStick(),this.enableRightStick()}}disableAction(e){var n,o;const i=zi[e];(n=i.keys)==null||n.forEach(l=>this.disableKey(l)),(o=i.gamepadButtons)==null||o.forEach(l=>this.disableGamepadButton(l))}enableAction(e){var n,o;const i=zi[e];(n=i.keys)==null||n.forEach(l=>this.enableKey(l)),(o=i.gamepadButtons)==null||o.forEach(l=>this.enableGamepadButton(l))}isActionPressed(e){var l,h;const i=zi[e],n=((l=i.keys)==null?void 0:l.some(u=>this.isKeyPressed(u)))??!1,o=((h=i.gamepadButtons)==null?void 0:h.some(u=>!this.disabledGamepadButtons.has(u)&&this.gamepadManager.isActionPressed(u)))??!1;return n||o}wasActionJustPressed(e){var l,h;const i=zi[e],n=((l=i.keys)==null?void 0:l.some(u=>this.wasKeyJustPressed(u)))??!1,o=((h=i.gamepadButtons)==null?void 0:h.some(u=>!this.disabledGamepadButtons.has(u)&&this.gamepadManager.wasActionJustPressed(u)))??!1;return n||o}wasActionJustReleased(e){var l,h;const i=zi[e],n=((l=i.keys)==null?void 0:l.some(u=>this.wasKeyJustReleased(u)))??!1,o=((h=i.gamepadButtons)==null?void 0:h.some(u=>!this.disabledGamepadButtons.has(u)&&this.gamepadManager.wasActionJustReleased(u)))??!1;return n||o}}class Pm{constructor(){this.lastFrameTime=performance.now(),this.startTime=this.lastFrameTime,this.isRunning=!1,this.updateCallbacks=[],this.renderCallbacks=[],this.frameRequestId=null,this.currentDeltaTime=0,this.tick=e=>{if(!this.isRunning)return;const i=(e-this.lastFrameTime)/1e3;this.lastFrameTime=e,this.currentDeltaTime=i,this.updateCallbacks.forEach(n=>n(i)),this.renderCallbacks.forEach(n=>n(i)),this.frameRequestId=requestAnimationFrame(this.tick)}}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),this.startTime=this.lastFrameTime,this.frameRequestId=requestAnimationFrame(this.tick))}stop(){this.isRunning=!1,this.frameRequestId!==null&&(cancelAnimationFrame(this.frameRequestId),this.frameRequestId=null)}getElapsedSeconds(){return(performance.now()-this.startTime)/1e3}getDeltaTime(){return this.currentDeltaTime}onUpdate(e){this.updateCallbacks.push(e)}offUpdate(e){this.updateCallbacks=this.updateCallbacks.filter(i=>i!==e)}onRender(e){this.renderCallbacks.push(e)}offRender(e){this.renderCallbacks=this.renderCallbacks.filter(i=>i!==e)}}const pp={"mission.mission_001.unlocked":{description:"Unlocks the first mission in the campaign."},"mission.mission_001.complete":{description:"Marks the first mission as completed."},"mission.mission_002.unlocked":{description:"Unlocks the second mission."},"mission.mission_002.complete":{description:"Marks the second mission as completed."},"mission.scrapper-revenant.unlocked":{description:"Unlocks the third mission."},"mission.mission_003_00.unlocked":{description:"Unlocks the third mission."},"mission.mission_003_00.complete":{description:"Marks the third mission as completed."},"mission.mission_004_00.unlocked":{description:"Unlocks the fourth mission."},"mission.mission_004_00.complete":{description:"Marks the fourth mission as completed."},"mission.mission_005_00.unlocked":{description:"Unlocks the fifth mission."},"mission.mission_005_00.complete":{description:"Marks the fifth mission as completed."},"mission.mission_006_00.unlocked":{description:"Unlocks the sixth mission."},"mission.mission_006_00.complete":{description:"Marks the sixth mission as completed."},"mission.intro-briefing.complete":{description:"Marks the intro briefing as completed."},"hub.mission-computer.unlocked":{description:"Unlocks the mission computer in the hub."},"hub.passive-terminal.unlocked":{description:"Unlocks the passive terminal in the hub."},"hub.breakroom.unlocked":{description:"Unlocks the breakroom in the hub."},"hub.introduction-1.complete":{description:"Marks the first introduction dialogue as completed."},"hub.introduction-2.complete":{description:"Marks the second introduction dialogue as completed."},"hub.introduction-3.complete":{description:"Marks the third introduction dialogue as completed."}};class QS{constructor(){this.flags=new Set}set(e){this.flags.add(e)}unset(e){this.flags.delete(e)}has(e){return this.flags.has(e)}clear(){this.flags.clear()}toJSON(){return JSON.stringify(Array.from(this.flags))}fromJSON(e){try{const i=JSON.parse(e);if(Array.isArray(i)){const n=i.filter(o=>o in pp);this.flags=new Set(n)}}catch(i){console.warn("Failed to load player flags from JSON:",i)}}getAll(){return Array.from(this.flags)}unlockAllFlags(){Object.keys(pp).forEach(e=>{this.flags.add(e)})}}const Ee=new QS;class $S{constructor(){this.result=null}initialize(){this.result={outcome:"victory",enemiesDestroyed:0,currencyGathered:0,blocksUnlocked:[],blockPlacedCount:0,passivePointsEarned:0,bonusObjectives:[],timeTakenSeconds:0,blocksLost:0,blockRefinedCount:0,blocksCollected:0,wavesCleared:0,incidentsCompleted:0,massAchieved:0}}finalize(e,i){this.ensureInitialized(),this.result.outcome=e,this.result.timeTakenSeconds=Math.round(i)}setOutcome(e){this.ensureInitialized(),this.result.outcome=e}addCurrency(e){this.ensureInitialized(),this.result.currencyGathered+=e}incrementKillCount(e=1){this.ensureInitialized(),pe.emit("camera:shake",{strength:10,duration:.2,frequency:10}),this.result.enemiesDestroyed+=e}incrementBlockCollectedCount(e=1){this.ensureInitialized(),this.result.blocksCollected+=e}incrementWavesCleared(e=1){this.ensureInitialized(),this.result.wavesCleared+=e}incrementIncidentsCompleted(e=1){this.ensureInitialized(),this.result.incidentsCompleted+=e}incrementMassAchieved(e){this.ensureInitialized(),e>this.result.massAchieved&&(this.result.massAchieved=e)}incrementBlockPlacedCount(e=1){this.ensureInitialized(),this.result.blockPlacedCount+=e}incrementBlockRefinedCount(e=1){this.ensureInitialized(),this.result.blockRefinedCount+=e}addBlockPickup(e){this.ensureInitialized();const i=this.result.blocksUnlocked;i.includes(e)||i.push(e)}incrementBlocksLost(e=1){this.ensureInitialized(),this.result.blocksLost+=e}getBlocksLost(){return this.ensureInitialized(),this.result.blocksLost}addBonusObjective(e){this.ensureInitialized(),this.result.bonusObjectives.push(e)}setPassivePoints(e){this.ensureInitialized(),this.result.passivePointsEarned=e}get(){return this.ensureInitialized(),this.result}clear(){this.result=null}hasResult(){return this.result!==null}ensureInitialized(){if(!this.result)throw new Error("MissionResultStore accessed before initialize()")}}const Te=new $S;class ni{constructor(){this.unlockedBlockIds=new Set}static getInstance(){return ni.instance||(ni.instance=new ni),ni.instance}unlock(e){this.unlockedBlockIds.add(e),Te.addBlockPickup(e)}unlockMany(e){e.forEach(i=>this.unlockedBlockIds.add(i))}unlockAll(){Fo().map(i=>i.id).forEach(i=>this.unlockedBlockIds.add(i))}isUnlocked(e){return this.unlockedBlockIds.has(e)}getUnlockedBlockIds(){return Array.from(this.unlockedBlockIds)}reset(){this.unlockedBlockIds.clear()}destroy(){this.unlockedBlockIds.clear()}toJSON(){return JSON.stringify(Array.from(this.unlockedBlockIds))}fromJSON(e){try{const i=JSON.parse(e);Array.isArray(i)&&(this.unlockedBlockIds=new Set(i))}catch(i){console.warn("Failed to load player technology from JSON:",i)}}}class yt{constructor(){this.metaCurrency=0}static getInstance(){return yt.instance||(yt.instance=new yt),yt.instance}getMetaCurrency(){return this.metaCurrency}setMetaCurrency(e){this.metaCurrency=Math.max(0,Math.floor(e))}addMetaCurrency(e){this.metaCurrency=Math.max(0,this.metaCurrency+Math.floor(e))}subtractMetaCurrency(e){const i=Math.floor(e);return this.metaCurrency<i?!1:(this.metaCurrency-=i,!0)}canAfford(e){return this.metaCurrency>=Math.floor(e)}toJSON(){return JSON.stringify({metaCurrency:this.metaCurrency})}fromJSON(e){try{const i=JSON.parse(e);typeof i=="object"&&i!==null&&typeof i.metaCurrency=="number"&&this.setMetaCurrency(i.metaCurrency)}catch(i){console.warn("Failed to parse PlayerMetaCurrencyManager data:",i)}}reset(){this.metaCurrency=0}}class vt{constructor(){this.passives=new Map,this.passivePoints=0}static getInstance(){return vt.instance||(vt.instance=new vt),vt.instance}addPassivePoints(e){yt.getInstance().addMetaCurrency(e)}getAvailablePoints(){return yt.getInstance().getMetaCurrency()}getUpgradeCost(e,i=null){const n=i??0,o=h=>{switch(h){case 1:return 5;case 2:return 10;case 3:return 15;default:return 0}};let l=0;for(let h=n+1;h<=e;h++)l+=o(h);return l}canAfford(e){return yt.getInstance().canAfford(e)}setPassiveTier(e,i){const n=this.passives.get(e)??null,o=this.getUpgradeCost(i,n);return o<0||!yt.getInstance().canAfford(o)?!1:(yt.getInstance().subtractMetaCurrency(o),this.passives.set(e,i),!0)}getPassiveTier(e){return this.passives.get(e)??null}hasPassive(e){return this.passives.has(e)}getAllPassives(){return new Map(this.passives)}getTotalPassivesSpent(){let e=0;for(const i of this.passives.values())e+=i;return e}hasAnyPassives(){return this.passives.size>0}refundAll(){let e=0;for(const i of this.passives.values())e+=i;yt.getInstance().addMetaCurrency(e),this.passives.clear()}clear(){this.passives.clear(),this.passivePoints=0}toJSON(){const e={passivePoints:this.passivePoints,passives:{}};for(const[i,n]of this.passives.entries())e.passives[i]=n;return JSON.stringify(e)}fromJSON(e){this.passives.clear(),this.passivePoints=0;try{const i=JSON.parse(e);if(typeof i.passivePoints=="number"&&(this.passivePoints=i.passivePoints),i.passives&&typeof i.passives=="object")for(const[n,o]of Object.entries(i.passives))this.isValidPassiveId(n)&&this.isValidTier(o)&&this.passives.set(n,o)}catch(i){console.warn("Failed to parse PlayerPassiveManager data:",i)}}isValidPassiveId(e){return["harvester-range","laser-damage","laser-energy-drain","laser-block-cost","explosive-lance-radius","explosive-lance-firing-rate","block-durability","fin-turn-power","engine-thrust","charger-rate","battery-capacity","turret-firing-rate","turret-damage","turret-accuracy","shield-energy-drain","shield-radius","shield-efficiency","facetplate-armor","hull-armor","hull-mass","cockpit-armor","block-repair-cost","entropium-pickup-bonus","block-drop-rate"].includes(e)}isValidTier(e){return e===1||e===2||e===3}}const mp="lastSaveSlot";class ct{constructor(e){this.saveSlot=e}static initialize(e=0){ct.instance||(ct.instance=new ct(e))}static getInstance(){if(!ct.instance)throw new Error("SaveGameManager not initialized. Call initialize(slot) first.");return ct.instance}getStorageKey(){return`save${this.saveSlot}`}loadData(){const e=localStorage.getItem(this.getStorageKey());if(!e)return{flags:[],unlockedBlockIds:[]};try{return JSON.parse(e)}catch(i){return console.warn(`Failed to parse save data from ${this.getStorageKey()}:`,i),{flags:[],unlockedBlockIds:[]}}}writeData(e){localStorage.setItem(this.getStorageKey(),JSON.stringify(e))}saveAll(){const e={flags:JSON.parse(Ee.toJSON()),unlockedBlockIds:JSON.parse(ni.getInstance().toJSON()),settings:ke.getInstance().toJSON(),passives:JSON.parse(vt.getInstance().toJSON()),metaCurrency:JSON.parse(yt.getInstance().toJSON()),version:1};this.writeData(e),localStorage.setItem(mp,String(this.saveSlot))}loadAll(){const e=this.loadData();Ee.fromJSON(JSON.stringify(e.flags??[])),ni.getInstance().fromJSON(JSON.stringify(e.unlockedBlockIds??[])),e.settings&&ke.getInstance().fromJSON(e.settings),e.passives&&vt.getInstance().fromJSON(JSON.stringify(e.passives)),e.metaCurrency&&yt.getInstance().fromJSON(JSON.stringify(e.metaCurrency))}changeSlot(e){this.saveSlot=e}static eraseSave(e){const i=`save${e}`;localStorage.removeItem(i),console.log(`Save slot ${e} erased.`)}static getFirstAvailableResolution(){const e={width:1920,height:1080},i=ct.getLastSaveSlot();if(i!==null){const n=`save${i}`,o=localStorage.getItem(n);if(o)try{const l=JSON.parse(o);if(l.settings){const h=JSON.parse(l.settings),u=parseInt(h.viewportWidth),d=parseInt(h.viewportHeight);if(Number.isFinite(u)&&u>0&&Number.isFinite(d)&&d>0)return{width:u,height:d}}}catch(l){console.warn(`Failed to parse save data from last slot ${i}:`,l)}}return e}static getLastSaveSlot(){const e=localStorage.getItem(mp),i=parseInt(e??"",10);return Number.isInteger(i)?i:null}saveFlags(){const e=this.loadData();e.flags=JSON.parse(Ee.toJSON()),this.writeData(e)}saveTechnology(){const e=this.loadData();e.unlockedBlockIds=JSON.parse(ni.getInstance().toJSON()),this.writeData(e)}saveSettings(){const e=this.loadData();e.settings=ke.getInstance().toJSON(),this.writeData(e)}savePassives(){const e=this.loadData();e.passives=JSON.parse(vt.getInstance().toJSON()),this.writeData(e)}saveMetaCurrency(){const e=this.loadData();e.metaCurrency=JSON.parse(yt.getInstance().toJSON()),this.writeData(e)}loadFlags(){const e=this.loadData();Ee.fromJSON(JSON.stringify(e.flags??[]))}loadTechnology(){const e=this.loadData();ni.getInstance().fromJSON(JSON.stringify(e.unlockedBlockIds??[]))}loadSettings(){const e=this.loadData();e.settings&&ke.getInstance().fromJSON(e.settings)}loadPassives(){const e=this.loadData();e.passives&&vt.getInstance().fromJSON(JSON.stringify(e.passives))}loadMetaCurrency(){const e=this.loadData();e.metaCurrency&&yt.getInstance().fromJSON(JSON.stringify(e.metaCurrency))}}function ya(a,e,i,n,o){const l=e.width*o,h=e.height*o;a.drawImage(e,i-l/2,n-h/2,l,h)}const _l=document.createElement("canvas");_l.width=24;_l.height=24;const He=_l.getContext("2d");He.clearRect(0,0,24,24);const ki=12;He.strokeStyle="black";He.lineWidth=5;He.beginPath();He.moveTo(ki,2);He.lineTo(ki,22);He.moveTo(2,ki);He.lineTo(22,ki);He.stroke();He.strokeStyle="#00ff00";He.lineWidth=2;He.shadowColor="#00ff00";He.shadowBlur=4;He.beginPath();He.moveTo(ki,2);He.lineTo(ki,22);He.moveTo(2,ki);He.lineTo(22,ki);He.stroke();He.shadowBlur=6;He.fillStyle="#00ff00";He.beginPath();He.arc(ki,ki,2.2,0,Math.PI*2);He.fill();He.shadowBlur=0;He.shadowColor="transparent";function fn(){return _l}const Dl=document.createElement("canvas");Dl.width=24;Dl.height=24;{const a=Dl.getContext("2d");a.clearRect(0,0,24,24);const e=12;a.strokeStyle="black",a.lineWidth=5,a.beginPath(),a.moveTo(e,2),a.lineTo(e,7),a.moveTo(e,17),a.lineTo(e,22),a.moveTo(2,e),a.lineTo(7,e),a.moveTo(17,e),a.lineTo(22,e),a.stroke(),a.strokeStyle="#00ff00",a.lineWidth=2,a.shadowColor="#00ff00",a.shadowBlur=4,a.beginPath(),a.moveTo(e,2),a.lineTo(e,7),a.moveTo(e,17),a.lineTo(e,22),a.moveTo(2,e),a.lineTo(7,e),a.moveTo(17,e),a.lineTo(22,e),a.stroke(),a.shadowBlur=6,a.fillStyle="#00ff00",a.beginPath(),a.arc(e,e,2.2,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function JS(){return Dl}const Pl=document.createElement("canvas");Pl.width=28;Pl.height=28;{const a=Pl.getContext("2d");a.clearRect(0,0,28,28);const e=14,i=14;a.strokeStyle="black",a.lineWidth=4,a.beginPath(),a.moveTo(e,i-10),a.lineTo(e+10,i),a.lineTo(e,i+10),a.lineTo(e-10,i),a.closePath(),a.stroke(),a.strokeStyle="#00ff00",a.lineWidth=2,a.shadowColor="#00ff00",a.shadowBlur=4,a.beginPath(),a.moveTo(e,i-10),a.lineTo(e+10,i),a.lineTo(e,i+10),a.lineTo(e-10,i),a.closePath(),a.stroke(),a.fillStyle="#00ff00",a.shadowBlur=6,a.beginPath(),a.arc(e,i,2.2,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function Hu(){return Pl}function Ll(a){const i=document.createElement("canvas");i.width=28,i.height=28;const n=i.getContext("2d");n.clearRect(0,0,28,28),n.lineJoin="round";const o=28/2,l=28/2,h=new Path2D;switch(h.moveTo(o,l-10),h.lineTo(o-6,l+6),h.lineTo(o,l+2),h.lineTo(o+6,l+6),h.closePath(),n.save(),n.translate(o,l),a){case"right":n.rotate(Math.PI/2);break;case"down":n.rotate(Math.PI);break;case"left":n.rotate(-Math.PI/2);break}return n.translate(-14,-14),n.strokeStyle="black",n.lineWidth=5,n.stroke(h),n.strokeStyle="#00ff00",n.lineWidth=2,n.shadowColor="#00ff00",n.shadowBlur=4,n.stroke(h),n.shadowBlur=6,n.fillStyle="#00ff00",n.beginPath(),n.arc(o,l,2.2,0,Math.PI*2),n.fill(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),i}const e1=Ll("up"),t1=Ll("right"),i1=Ll("down"),s1=Ll("left");function n1(a){switch(a){case"up":return e1;case"right":return t1;case"down":return i1;case"left":return s1}}const Ol=document.createElement("canvas");Ol.width=28;Ol.height=28;{const a=Ol.getContext("2d");a.clearRect(0,0,28,28);const e=14,i=14;a.lineJoin="round",a.lineCap="round";const n=new Path2D;n.moveTo(e,i+8),n.lineTo(e,i-4),n.moveTo(e-4,i-8),n.lineTo(e+4,i-8),n.lineTo(e+4,i-4),n.moveTo(e-4,i-4),n.lineTo(e-4,i-8),a.strokeStyle="black",a.lineWidth=5,a.stroke(n),a.strokeStyle="#00ff00",a.lineWidth=2,a.shadowColor="#00ff00",a.shadowBlur=4,a.stroke(n),a.shadowBlur=6,a.fillStyle="#00ff00",a.beginPath(),a.arc(e,i,1.5,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function a1(){return Ol}const Fl=document.createElement("canvas");Fl.width=18;Fl.height=18;{const a=Fl.getContext("2d");a.clearRect(0,0,18,18);const e=9;a.shadowBlur=4,a.fillStyle="#00ff00",a.beginPath(),a.arc(e,e,1.5,0,Math.PI*2),a.fill(),a.shadowBlur=0,a.shadowColor="transparent"}function o1(){return Fl}function r1(a,e,i,n=255){const o=m=>Math.max(0,Math.min(255,Math.round(m))),l=m=>o(m).toString(16).padStart(2,"0"),h=l(a),u=l(e),d=l(i),g=l(n);return n===255?`#${h}${u}${d}`:`#${h}${u}${d}${g}`}function l1(a){if(!a)return"#ffffff";if(a.startsWith("#"))return a;try{return c1(a)}catch{return console.warn("[ExplosionSystem] Invalid color format, defaulting to white:",a),"#ffffff"}}function c1(a){const e=a.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([.\d]+))?\)/i);if(!e)throw new Error(`Invalid rgba() color string: ${a}`);const i=parseInt(e[1],10),n=parseInt(e[2],10),o=parseInt(e[3],10),l=e[4]!==void 0?Math.round(parseFloat(e[4])*255):255;return r1(i,n,o,l)}function Mi(a,e){const i=u=>Math.max(0,Math.min(255,u)),n=parseInt(a.slice(1),16),o=i((n>>16)+255*e),l=i((n>>8&255)+255*e),h=i((n&255)+255*e);return`rgb(${o}, ${l}, ${h})`}function ii(a,e){if(/^#[0-9a-f]{3}$/i.test(a)){const[i,n,o]=a.slice(1);return`#${i}${i}${n}${n}${o}${o}${e}`}if(/^#[0-9a-f]{6}$/i.test(a))return`${a}${e}`;throw new Error(`Invalid hex color format: ${a}`)}function ht(a,e,i=1){const{x:n,y:o,width:l,height:h,label:u,isHovered:d,style:g={},disabled:m=!1}=e,{borderRadius:y=6,backgroundColor:v,borderColor:M="#666",textColor:b="#fff",textFont:C="13px monospace",alpha:w=1,backgroundGradient:A}=g,E=l*i,x=h*i,I=C.replace(/(\d+)(px)/,(K,Z,Q)=>`${Math.round(parseInt(Z)*i)}${Q}`),D=m?.4:w,N=m?"#444":M,H=m?"#888":b;a.save(),a.globalAlpha=D;let W;if(A){const{type:K,stops:Z,from:Q=[n,o],to:Y=[n+E,o+x],radius:ne=E/2}=A,J=K==="linear"?a.createLinearGradient(Q[0],Q[1],Y[0],Y[1]):a.createRadialGradient(Q[0],Q[1],0,Q[0],Q[1],ne),ee=Z.map(_=>({offset:_.offset,color:m?"#111":d?Mi(_.color,.1):_.color}));for(const _ of ee)J.addColorStop(_.offset,_.color);W=J}else W=m?"#111":d?"#333":v??"#222";a.fillStyle=W,a.strokeStyle=N,a.lineWidth=1*i,a.beginPath(),a.roundRect(n,o,E,x,y),a.fill(),a.stroke(),a.fillStyle=H,a.font=I,a.textAlign="center",a.textBaseline="middle",a.fillText(u,n+E/2,o+x/2),a.restore()}function Bs(a,e,i,n,o=1){if(a.disabled)return a.isHovered=!1,a.wasHovered=!1,!1;const l=a.width*o,h=a.height*o,u=e>=a.x&&e<=a.x+l&&i>=a.y&&i<=a.y+h,d=u&&!a.wasHovered,g=!u&&a.wasHovered;return a.isHovered=u,a.wasHovered=u,d&&(a.onHover?a.onHover():$.play("assets/sounds/sfx/ui/hover_00.wav","sfx",{maxSimultaneous:4}),pe.emit("cursor:change",{type:"hovered"})),g&&pe.emit("cursor:restore",void 0),u&&n?(a.onClick(),!0):!1}function Ct(a){const{ctx:e,x:i,y:n,width:o,height:l,title:h,tabs:u,mouse:d,clicked:g,options:m={},uiScale:y=1}=a,{borderRadius:v=8,backgroundColor:M="#111",borderColor:b="#555",alpha:C=1,activeTabColor:w=b,backgroundGradient:A}=m,E=o*y,x=l*y,I=v*y;e.save(),e.globalAlpha=C;let D=M;if(A){const{type:Q,stops:Y,from:ne=[i,n],to:J=[i+o,n+l],radius:ee=o/2}=A,_=[ne[0]*y,ne[1]*y],z=[J[0]*y,J[1]*y],se=Q==="linear"?e.createLinearGradient(_[0],_[1],z[0],z[1]):e.createRadialGradient(_[0],_[1],0,_[0],_[1],ee*y);for(const oe of Y)se.addColorStop(oe.offset,oe.color);D=se}e.fillStyle=D,e.strokeStyle=b,e.lineWidth=2*y,e.beginPath(),e.roundRect(i,n,E,x,I),e.fill(),e.stroke(),h&&(e.fillStyle="#fff",e.font=`bold ${Math.round(14*y)}px monospace`,e.textAlign="start",e.textBaseline="top",e.fillText(h,i+42*y,n+8*y));let N=!1;if(!(u!=null&&u.length))return e.restore(),!1;const H=ae(),W=24*y*H,K=8*y*H,Z=Math.floor((E-2*K)/u.length);for(let Q=0;Q<u.length;Q++){const Y=u[Q],ne=i+K+Q*Z,J=n-W,ee=Z-4*y,_=d&&d.x>=ne&&d.x<=ne+ee&&d.y>=J&&d.y<=J+W;g&&_&&(u.forEach(z=>z.isActive=!1),Y.isActive=!0,Y.onClick(),N=!0),e.fillStyle=Y.isActive?w:D,e.strokeStyle=b,e.beginPath(),e.roundRect(ne,J,ee,W,[I,I,0,0]),e.fill(),e.stroke(),e.font=`${Math.round(12*y*H)}px monospace`,e.fillStyle=Y.isActive?"#000":b,e.textAlign="center",e.textBaseline="middle",e.fillText(Y.label,ne+ee/2,J+W/2)}return e.textAlign="start",e.textBaseline="alphabetic",e.restore(),N}const hu=new Map;async function va(a){const e=wi(a);return hu.has(e)?hu.get(e):new Promise((i,n)=>{const o=new Image;o.src=e,o.onload=()=>{hu.set(e,o),i(o)},o.onerror=n})}function h1(a,e,i,n={},o={},l=1e3,h=1,u=!1,d=!1){const g=[{x:-l,y:-l},{x:+l,y:-l},{x:0,y:-2*l},{x:-l,y:+l},{x:+l,y:+l},{x:0,y:2*l}],m=i.map(y=>({shipId:y,affixes:o}));return{formationId:a,layout:g,leader:{shipId:e,hunter:d,affixes:n},followers:m,count:h,unCullable:u}}function u1(a,e,i,n={},o={},l=1e3,h=1,u=!1,d=!1){const g=[{x:-.866,y:.5},{x:.866,y:.5},{x:-1.732,y:1.5},{x:1.732,y:1.5}].map(y=>({x:y.x*l,y:y.y*l})),m=i.map(y=>({shipId:y,affixes:o}));return{formationId:a,layout:g,leader:{shipId:e,affixes:n,hunter:d},followers:m,count:h,unCullable:u}}function Wu(a,e,i,n={},o={},l=1e3,h=1,u=!1,d=!1){const g=[{x:-.866,y:.5},{x:.866,y:.5}].map(y=>({x:y.x*l,y:y.y*l})),m=i.map(y=>({shipId:y,affixes:o}));return{formationId:a,layout:g,leader:{shipId:e,affixes:n,hunter:d},followers:m,count:h,unCullable:u}}function f1(a,e,i,n={},o={},l=1e3,h=1,u=!1,d=!1){const g=[{x:-.866,y:.5},{x:.866,y:.5},{x:-1.732,y:1.5},{x:1.732,y:1.5},{x:-2.598,y:2.5},{x:2.598,y:2.5}].map(y=>({x:y.x*l,y:y.y*l})),m=i.map(y=>({shipId:y,affixes:o}));return{formationId:a,layout:g,leader:{shipId:e,affixes:n,hunter:d},followers:m,count:h,unCullable:u}}const Ru={thrustPowerMulti:2.4,turnPowerMulti:2.4},Zi={thrustPowerMulti:1.8,turnPowerMulti:1.8},d1=h1("hourglass","ship_0_03",["ship_0_02","ship_0_02","ship_0_02","ship_0_02","ship_0_02","ship_0_02"],Zi,Ru,600,2,!0,!0),yp=Wu("small-wedge","ship_0_02",["ship_0_02","ship_0_02"],Zi,Zi,800,5,!0),vp=u1("medium-wedge","ship_0_03",["ship_0_02","ship_0_02","ship_0_02","ship_0_02"],Zi,Zi,700,3,!0),g1=f1("large-wedge","ship_scrapper_4",["ship_scrapper_3","ship_scrapper_3","ship_0_02","ship_0_02","ship_0_02","ship_0_02"],Zi,Zi,600,2,!0),p1=Wu("kill-crew","ship_scrapper_6",["ship_scrapper_6","ship_scrapper_6"],Zi,Zi,700,2,!0,!0),m1=Wu("speed-hunters","ship_0_02",["ship_0_02","ship_0_02"],Ru,Ru,600,4,!0,!0),bp=[{id:1,type:"wave",mods:[],ships:[{shipId:"wave_0_00",count:32},{shipId:"wave_0_01",count:32},{shipId:"wave_0_02",count:28,hunter:!0},{shipId:"wave_0_03",count:22,hunter:!0},{shipId:"wave_0_04",count:12,hunter:!0}],formations:[yp,vp]},{id:2,type:"wave",mods:["extra-aggressive"],ships:[{shipId:"ship_0_00",count:20},{shipId:"ship_0_01",count:18},{shipId:"ship_0_02",count:12},{shipId:"ship_0_03",count:8,hunter:!0},{shipId:"ship_0_04",count:6,hunter:!0},{shipId:"ship_0_station",count:8}],formations:[d1,yp]},{id:3,type:"wave",mods:["shielded"],ships:[{shipId:"ship_scrapper_0",count:12,hunter:!0},{shipId:"ship_scrapper_1",count:10},{shipId:"ship_scrapper_2",count:8,hunter:!0},{shipId:"ship_scrapper_3",count:6},{shipId:"ship_scrapper_4",count:5,hunter:!0},{shipId:"ship_scrapper_5",count:4,hunter:!0},{shipId:"ship_scrapper_6",count:3,hunter:!0},{shipId:"ship_0_station",count:4}],formations:[g1,p1,vp,m1]},{id:4,type:"boss",mods:["shielded","extra-aggressive"],ships:[{shipId:"boss_0_00",count:1,hunter:!0}],music:{file:"assets/sounds/music/track_03_boss.mp3"},lightingSettings:{clearColor:[.25,0,0,0]}}];class Tt{constructor(){this.ships=new Set,this.shipIdMap=new Map,this.playerShip=null}static getInstance(){return Tt.instance||(Tt.instance=new Tt),Tt.instance}getById(e){return this.shipIdMap.get(e)}add(e){this.ships.add(e),this.shipIdMap.set(e.id,e)}remove(e){e.cleanupAuraLight(),e.destroy(),this.ships.delete(e),this.shipIdMap.delete(e.id),this.playerShip===e&&(this.playerShip=null)}getAll(){return this.ships}clear(){this.ships.clear(),this.shipIdMap.clear(),this.playerShip=null}count(){return this.ships.size}setPlayerShip(e){this.ships.has(e)||this.add(e),this.playerShip=e}getPlayerShip(){return this.playerShip}}function Gu(a,e){const i=e.x-a.x,n=e.y-a.y;return Math.sqrt(i*i+n*n)}function Po(a,e){return{x:a.x-e.x,y:a.y-e.y}}function on(a){const e=Math.sqrt(a.x*a.x+a.y*a.y);return e===0?{x:0,y:0}:{x:a.x/e,y:a.y/e}}function Eu(a){return Math.sqrt(a.x*a.x+a.y*a.y)}function dn(a,e){return a.x*e.x+a.y*e.y}function Lm(a,e){let i=(e-a+Math.PI)%(2*Math.PI);return i<0&&(i+=2*Math.PI),i-Math.PI}function y1(a,e,i){return{x:a.x+e.x*i,y:a.y+e.y*i}}class _s{constructor(e,i){this.controller=e,this.ship=i}onEnter(){}}function v1(a){const e=a*(Math.PI/180),i=Math.sin(e),n=Math.cos(e);return{x:i,y:-n}}function b1(a,e){const i=Math.cos(e),n=Math.sin(e);return{x:a.x*i-a.y*n,y:a.x*n+a.y*i}}function zu(a){var o;let e=0,i=0;const n=a.getTransform().rotation;for(const[l,h]of a.getAllBlocks()){if(!((o=h.type.behavior)!=null&&o.canThrust))continue;const u=h.type.behavior.thrustPower??5,d=v1(h.rotation??0),g=b1(d,n);e+=g.x*u,i+=g.y*u}return on({x:e,y:i})}function Is(a,e,i){return Gu(a,e)<=i}function S1(a,e){const i=a.getTransform().position,n=zu(a),o=Po(e,i),l=on(o),h=dn(n,l);return Math.acos(Math.max(-1,Math.min(1,h)))}function M1(a,e,i=.15){return S1(a,e)<=i}function Om(a,e){const i=a.getFaction(),n=a.getTransform().position;let o=null,l=1/0;const h=Tt.getInstance().getPlayerShip();if(!h)return null;for(const u of[h]){if(u===a||u.getFaction()===i)continue;const d=u.getTransform().position,g=Gu(n,d);g<=e&&g<l&&(o=u,l=g)}return o}function Xu(a,e){const i=Math.cos(a.rotation),n=Math.sin(a.rotation);return{x:a.position.x+e.x*i-e.y*n,y:a.position.y+e.x*n+e.y*i}}function Ca(a,e,i){const n=a.getTransform().position,o=Po(e,n),l=Eu(o),h=on(o),u=M1(a,e,.15),d=dn(i,h);let g=!1,m=!1;l<100?m=d>10:u&&(g=!0);const y=zu(a),v=Math.atan2(h.y,h.x),M=Math.atan2(y.y,y.x),b=Lm(M,v),C=b<-.05,w=b>.05;return{thrustForward:g,brake:m,rotateLeft:C,rotateRight:w,strafeLeft:!1,strafeRight:!1}}function Sp(a,e,i,n){const o=a.getTransform().position,l=Po(i,o),u=Eu(l)-n,d=on(l),g={x:-d.y,y:d.x},m=zu(a),y=Math.atan2(g.y,g.x),v=Math.atan2(m.y,m.x),M=Lm(v,y),b=.05,C=M<-.05,w=M>b;let A=!1,E=!1;const x=Eu(e),I=x>0?dn(on(e),g):0,D=I<.5;if(u>20)A=!0;else if(u<-40){const N=on(Po(o,i));(x>0?dn(on(e),N):0)<.6?A=!0:E=!1}else D?A=!0:I>.7&&u<0&&(E=!0);return{thrustForward:A,brake:E,rotateLeft:C,rotateRight:w,strafeLeft:!1,strafeRight:!1}}function Vu(a,e,i,n){const o=Po(e,a),l=dn(i,i)-n*n,h=2*dn(o,i),u=dn(o,o),d=h*h-4*l*u;if(d<0||Math.abs(l)<1e-5)return e;const g=Math.sqrt(d),m=(-h-g)/(2*l),y=(-h+g)/(2*l),v=Math.max(m,y);return y1(e,i,Math.max(v,0))}const gn=32e3,ba=32e3,wl={x:0,y:0};class Uo extends _s{constructor(e,i){super(e,i),this.dwellTime=0,this.dwellDuration=4,this.patrolRadius=6e3,this.wakeRadius=3400,this.patrolTarget=this.chooseNewPatrolTarget()}update(e){const i=this.ship.getTransform().position,n=this.ship.getTransform().velocity;return Is(i,this.patrolTarget,100)?(this.dwellTime+=e,this.dwellTime>=this.dwellDuration&&(this.patrolTarget=this.chooseNewPatrolTarget(),this.dwellTime=0),{movement:{thrustForward:!1,brake:!0,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.patrolTarget},utility:{toggleShields:!1}}):{movement:Ca(this.ship,this.patrolTarget,n),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.patrolTarget},utility:{toggleShields:!1}}}transitionIfNeeded(){if(this.controller.isHunter()){const l=Tt.getInstance().getPlayerShip();if(l)return this.controller.setInitialState(new pn(this.controller,this.ship,l)),new pn(this.controller,this.ship,l)}const e=Om(this.ship,this.wakeRadius);if(!e)return null;const i=e.getTransform().position,n=this.ship.getTransform().position;return Is(n,i,this.wakeRadius)?new pn(this.controller,this.ship,e):null}chooseNewPatrolTarget(){const e=this.ship.getTransform().position,i=Math.random()*2*Math.PI,n=Math.random()*this.patrolRadius,o=e.x+Math.cos(i)*n,l=e.y+Math.sin(i)*n,h=1e3,u=-16e3+h,d=16e3-h,g=-16e3+h,m=16e3-h;return{x:Math.max(u,Math.min(d,o)),y:Math.max(g,Math.min(m,l))}}}function Sa(a,e){const i=a.getFormationRegistry(),n=a.getFormationId();i&&n&&i.removeFormation(n),a.clearFormationContext();const o=new Uo(a,e);return a.setInitialState(o),o}class Fm extends _s{constructor(e,i,n){super(e,i),this.disengageRange=1800,this.projectileSpeed=400,this.target=n}onEnter(){this.controller.makeUncullable()}update(){const e=this.controller.getFormationRegistry(),i=this.controller.getFormationLeaderController(),n=this.controller.getFormationId();if(!e||!i||!n)return this.idleIntent();const o=i.getShip();if(o.isDestroyed())return this.idleIntent();const l=e.getOffsetForShip(this.ship.id);if(!l)return this.idleIntent();const h=o.getTransform(),u=Xu(h,l);return{movement:Ca(this.ship,u,this.ship.getTransform().velocity),weapons:{firePrimary:!0,fireSecondary:!1,aimAt:Vu(this.ship.getTransform().position,this.target.getTransform().position,this.target.getTransform().velocity,this.projectileSpeed)},utility:{toggleShields:!0}}}transitionIfNeeded(){const e=this.controller.getFormationRegistry(),i=this.controller.getFormationLeaderController(),n=this.controller.getFormationId();if(!e||!i||!n)return Sa(this.controller,this.ship);if(i.getShip().isDestroyed())return Sa(this.controller,this.ship);const l=this.ship.getTransform(),h=this.target.getTransform();return Is(l.position,h.position,this.disengageRange)?null:new Um(this.controller,this.ship,this.target)}getTarget(){return this.target}idleIntent(){return{movement:{thrustForward:!1,brake:!0,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.ship.getTransform().position},utility:{toggleShields:!1}}}}class Um extends _s{constructor(e,i,n){super(e,i),this.engagementRange=1200,this.target=n}onEnter(){this.controller.makeUncullable()}update(){const e=this.controller.getFormationRegistry(),i=this.controller.getFormationLeaderController(),n=this.controller.getFormationId();if(!e||!i||!n)return this.idleIntent();const o=i.getShip();if(o.isDestroyed())return this.idleIntent();const l=e.getOffsetForShip(this.ship.id);if(!l)return this.idleIntent();const h=o.getTransform(),u=Xu(h,l);return{movement:Ca(this.ship,u,this.ship.getTransform().velocity),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.target.getTransform().position},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.controller.getFormationRegistry(),i=this.controller.getFormationLeaderController(),n=this.controller.getFormationId();if(!e||!i||!n)return Sa(this.controller,this.ship);if(i.getShip().isDestroyed())return Sa(this.controller,this.ship);const l=this.ship.getTransform(),h=this.target.getTransform();return Is(l.position,h.position,this.engagementRange)?new Fm(this.controller,this.ship,this.target):null}getTarget(){return this.target}idleIntent(){return{movement:{thrustForward:!1,brake:!0,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.ship.getTransform().position},utility:{toggleShields:!1}}}}class Ul extends _s{constructor(e,i){super(e,i)}update(e){const i=this.controller.getFormationRegistry(),n=this.controller.getFormationLeaderController(),o=this.controller.getFormationId();if(!i||!n||!o)return this.idleIntent();const l=i.getOffsetForShip(this.ship.id);if(!l)return this.idleIntent();const h=n.getShip();if(h.isDestroyed())return this.idleIntent();const u=h.getTransform(),d=Xu(u,l);return{movement:Ca(this.ship,d,this.ship.getTransform().velocity),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:u.position},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.controller.getFormationRegistry(),i=this.controller.getFormationLeaderController(),n=this.controller.getFormationId();if(!e||!i||!n)return Sa(this.controller,this.ship);if(i.getShip().isDestroyed())return Sa(this.controller,this.ship);const l=i.getCurrentState();return l instanceof pn?new Um(this.controller,this.ship,l.getTarget()):l instanceof Nm?new Fm(this.controller,this.ship,l.getTarget()):null}idleIntent(){return{movement:{thrustForward:!1,brake:!0,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:this.ship.getTransform().position},utility:{toggleShields:!1}}}}class Nm extends _s{constructor(e,i,n){super(e,i),this.disengageRange=1400,this.orbitRadius=300,this.projectileSpeed=400,this.phase=0,this.phaseTimer=0,this.orbitDuration=10,this.target=n}onEnter(){this.controller.makeUncullable()}update(e){const i=this.controller.getBehaviorProfile().attack,n=this.ship.getTransform(),o=this.target.getTransform();if(i==="ram"){if(this.phase===0?this.ship.isColliding()&&(this.phase=1,this.phaseTimer=0):this.phase===1&&(this.phaseTimer+=e,this.phaseTimer>=this.orbitDuration&&(this.phase=0,this.phaseTimer=0)),this.phase===0)return{movement:Ca(this.ship,o.position,n.velocity),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:o.position},utility:{toggleShields:!0}};if(this.phase===1)return{movement:Sp(this.ship,n.velocity,o.position,this.orbitRadius),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:o.position},utility:{toggleShields:!1}}}return i==="orbit"?{movement:Sp(this.ship,n.velocity,o.position,this.orbitRadius),weapons:{firePrimary:!0,fireSecondary:!1,aimAt:Vu(n.position,o.position,o.velocity,this.projectileSpeed)},utility:{toggleShields:!1}}:{movement:{thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:o.position},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.ship.getTransform(),i=this.target.getTransform(),n=this.controller.getFormationId(),o=this.controller.getFormationRegistry(),l=this.controller.getFormationLeaderController();return n&&o&&(!l||l.getShip().isDestroyed())?o.getOffsetForShip(this.ship.id)?new Ul(this.controller,this.ship):new Uo(this.controller,this.ship):Is(e.position,i.position,this.disengageRange)?null:new pn(this.controller,this.ship,this.target)}getTarget(){return this.target}}class pn extends _s{constructor(e,i,n){super(e,i),this.engagementRange=1200,this.disengagementRange=5e3,this.target=n}onEnter(){this.controller.makeUncullable()}update(){const e=this.ship.getTransform(),i=this.target.getTransform();return{movement:Ca(this.ship,i.position,e.velocity),weapons:{firePrimary:!1,fireSecondary:!1,aimAt:i.position},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.ship.getTransform(),i=this.target.getTransform(),n=this.controller.getFormationId(),o=this.controller.getFormationRegistry(),l=this.controller.getFormationLeaderController();if(n&&o&&(!l||l.getShip().isDestroyed()))return o.getOffsetForShip(this.ship.id)?new Ul(this.controller,this.ship):new Uo(this.controller,this.ship);if(Is(e.position,i.position,this.engagementRange))return new Nm(this.controller,this.ship,this.target);if(!this.controller.isHunter()){const h=Tt.getInstance().getPlayerShip();if(h&&Gu(e.position,h.getTransform().position)>this.disengagementRange){const d=this.controller.getInitialState();if(d)return d}}return null}getTarget(){return this.target}}class C1 extends _s{constructor(e,i,n){super(e,i),this.attackRange=1600,this.projectileSpeed=400,this.target=n}update(e){const i=this.ship.getTransform(),n=this.target.getTransform();return{movement:{thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!0,fireSecondary:!1,aimAt:Vu(i.position,n.position,n.velocity,this.projectileSpeed)},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.ship.getTransform(),i=this.target.getTransform();return Is(e.position,i.position,this.attackRange)?null:new Nl(this.controller,this.ship)}}class Nl extends _s{constructor(){super(...arguments),this.wakeRadius=1600}update(){return{movement:{thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1},weapons:{firePrimary:!1,fireSecondary:!1,aimAt:{x:0,y:0}},utility:{toggleShields:!1}}}transitionIfNeeded(){const e=this.controller.getBehaviorProfile(),i=Om(this.ship,this.wakeRadius);if(!i){if(this.controller.isFormationFollower()){const h=this.controller.getFormationRegistry(),u=this.controller.getFormationLeaderController(),d=this.controller.getFormationId();if(h&&u&&d)return new Ul(this.controller,this.ship)}return null}const n=this.ship.getTransform().position,o=i.getTransform().position;return Is(n,o,this.wakeRadius)?e===Wm?new C1(this.controller,this.ship,i):new pn(this.controller,this.ship,i):null}}const Hm={attack:"orbit",seek:"direct",initialStateFactory:a=>new Uo(a,a.getShip())},tn={attack:"ram",seek:"direct",initialStateFactory:a=>{const e=Tt.getInstance().getPlayerShip();return e?new pn(a,a.getShip(),e):(console.warn("[AI] RammingBehaviorProfile: Player ship not found, defaulting to IdleState"),new Nl(a,a.getShip()))}},T1={attack:"strafe",seek:"flank",initialStateFactory:a=>new Uo(a,a.getShip())},Wm={attack:"orbit",seek:"direct",initialStateFactory:a=>new Nl(a,a.getShip())},ko={rammingDamageInflictMultiplier:2,thrustPowerMulti:2,turnPowerMulti:2},$s={thrustPowerMulti:3,turnPowerMulti:3},w1=[{id:1,type:"wave",mods:[],ships:[{shipId:"wave_0_00",count:24},{shipId:"wave_0_01",count:22},{shipId:"wave_0_02",count:16},{shipId:"wave_0_03",count:16},{shipId:"wave_0_04",count:18},{shipId:"wave_0_00",count:8,hunter:!0,affixes:$s},{shipId:"wave_0_01",count:6,hunter:!0,affixes:$s},{shipId:"wave_0_02",count:8,hunter:!0,affixes:$s},{shipId:"wave_0_03",count:4,hunter:!0,affixes:$s},{shipId:"wave_0_04",count:6,hunter:!0,affixes:$s},{shipId:"/earlygame/ship_turret_00",count:4},{shipId:"/earlygame/ship_miniturret_00",count:8},{shipId:"/earlygame/ship_rammerspear_00",count:4,hunter:!0,behaviorProfile:tn,affixes:ko}]},{id:2,type:"wave",mods:["extra-aggressive"],ships:[{shipId:"wave_0_02",count:16,affixes:$s},{shipId:"wave_0_03",count:16,affixes:$s},{shipId:"/earlygame/ship_turret_00",count:10},{shipId:"/earlygame/ship_miniturret_00",count:8},{shipId:"/earlygame/ship_rammerspear_00",count:6,hunter:!0,behaviorProfile:tn,affixes:ko},{shipId:"/earlygame/ship_rammerhead_00",count:2,hunter:!0,behaviorProfile:tn,affixes:ko},{shipId:"/earlygame/ship_dragonfly_00",count:8,hunter:!0},{shipId:"/earlygame/ship_minifly_00",count:12,hunter:!0},{shipId:"/earlygame/ship_lanceturret_00",count:10},{shipId:"/earlygame/ship_sentry_00",count:12},{shipId:"/earlygame/ship_stalker_00",count:4,hunter:!0}]},{id:3,type:"wave",mods:["shielded"],ships:[{shipId:"/earlygame/ship_turret_00",count:14},{shipId:"/earlygame/ship_miniturret_00",count:22},{shipId:"/earlygame/ship_rammerspear_00",count:10,hunter:!0,behaviorProfile:tn,affixes:ko},{shipId:"/earlygame/ship_rammerhead_00",count:4,hunter:!0,behaviorProfile:tn,affixes:ko},{shipId:"/earlygame/ship_dragonfly_00",count:10,hunter:!0},{shipId:"/earlygame/ship_minifly_00",count:12,hunter:!0}]},{id:4,type:"boss",mods:["shielded","extra-aggressive"],ships:[{shipId:"boss_0_00",count:1,hunter:!0}],music:{file:"assets/sounds/music/track_03_boss.mp3"},lightingSettings:{clearColor:[.25,0,0,0]}}],A1={rammingDamageInflictMultiplier:2,thrustPowerMulti:2,turnPowerMulti:2},aa={thrustPowerMulti:3,turnPowerMulti:3},uu=[{id:1,type:"wave",mods:[],ships:[{shipId:"wave_0_00",count:24},{shipId:"wave_0_01",count:22},{shipId:"wave_0_02",count:34},{shipId:"wave_0_03",count:22},{shipId:"wave_0_04",count:32},{shipId:"/earlygame/ship_rammerspear_00",count:4,hunter:!0,behaviorProfile:tn,affixes:A1},{shipId:"mission_03/haloblade_pod_00",count:12},{shipId:"mission_03/haloblade_pod_01",count:8},{shipId:"mission_03/haloblade_pod_mini_00",count:10},{shipId:"mission_03/haloblade_speeder_00",count:4},{shipId:"mission_03/haloblade_beatle_00",count:2},{shipId:"mission_03/haloblade_beatle_01",count:4},{shipId:"mission_03/lance_miner_00",count:8},{shipId:"mission_03/lance_miner_00",count:2,hunter:!0},{shipId:"mission_03/lance_miner_station_00",count:4}]},{id:2,type:"wave",mods:[],ships:[{shipId:"wave_0_02",count:16,affixes:aa},{shipId:"wave_0_03",count:16,affixes:aa},{shipId:"mission_03/haloblade_pod_00",count:12},{shipId:"mission_03/haloblade_pod_01",count:8},{shipId:"mission_03/haloblade_pod_mini_00",count:12},{shipId:"mission_03/haloblade_speeder_00",count:4,hunter:!0},{shipId:"mission_03/haloblade_beetle_00",count:4,hunter:!0},{shipId:"mission_03/lance_miner_00",count:2},{shipId:"mission_03/lance_miner_station_00",count:4},{shipId:"mission_03/lance_miner_station_01",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:2},{shipId:"mission_03/haloblade_minicruiser_00",count:2},{shipId:"mission_03/haloblade_minicruiser_00",count:6},{shipId:"mission_03/lance_miner_00",count:12}]},{id:3,type:"wave",mods:[],ships:[{shipId:"mission_03/haloblade_minicruiser_00",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:6},{shipId:"mission_03/horrorhunter_00",count:4,hunter:!0},{shipId:"mission_03/horror_station_00",count:2},{shipId:"mission_03/horrorhunter_01",count:2,hunter:!0},{shipId:"mission_03/horrorhunter_02",count:2,hunter:!0},{shipId:"mission_03/horrorhunter_00",count:6},{shipId:"mission_03/horrorhunter_01",count:6},{shipId:"mission_03/horrorhunter_02",count:6},{shipId:"mission_03/speedhunter_00",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:4}]},{id:4,type:"wave",mods:[],ships:[{shipId:"mission_03/haloblade_minicruiser_00",count:4},{shipId:"mission_03/haloblade_cruiser_00",count:6},{shipId:"mission_03/horrorhunter_00",count:10},{shipId:"mission_03/horror_station_00",count:2},{shipId:"mission_03/horrorhunter_01",count:4,hunter:!0},{shipId:"mission_03/horrorhunter_02",count:4,hunter:!0},{shipId:"mission_03/speedhunter_00",count:8},{shipId:"mission_03/haloblade_cruiser_00",count:4,hunter:!0}]},{id:5,type:"wave",mods:[],ships:[{shipId:"mission_03/haloblade_pod_00",count:6},{shipId:"mission_03/haloblade_pod_01",count:4},{shipId:"mission_03/haloblade_pod_mini_00",count:9,affixes:aa},{shipId:"mission_03/haloblade_speeder_00",count:10,hunter:!0,affixes:aa},{shipId:"mission_03/haloblade_beetle_00",count:12,hunter:!0,affixes:aa},{shipId:"mission_03/lance_miner_00",count:4,hunter:!0},{shipId:"mission_03/lance_miner_station_00",count:6},{shipId:"mission_03/lance_miner_station_01",count:6},{shipId:"mission_03/haloblade_cruiser_00",count:12,hunter:!0,affixes:aa},{shipId:"mission_03/haloblade_minicruiser_00",count:14,hunter:!0},{shipId:"mission_03/haloblade_minicruiser_00",count:16}]},{id:6,type:"boss",mods:["shielded","extra-aggressive"],ships:[{shipId:"mission_03/boss_03",count:1,hunter:!0}],music:{file:"assets/sounds/music/track_03_boss.mp3"},lightingSettings:{clearColor:[0,0,0,0]}}],Al={mission_001:{id:"mission_001",name:"Shipwright Second-Class",dialogue:"intro-briefing",waves:bp,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_4_00.png",gravity:0},music:{file:"assets/sounds/music/track_02_mission1.mp3"},enemyPower:.5,bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,requiredFlag:"mission.mission_001.unlocked",missionPortrait:null},mission_002:{id:"mission_002",name:"Starfield Gauntlet",dialogue:"mission-generic",waves:bp,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_4_00.png",gravity:0},music:{file:"assets/sounds/music/track_02_mission1.mp3"},enemyPower:1,bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,requiredFlag:"mission.mission_002.unlocked",missionPortrait:"assets/characters/bosses/character_boss_wildjoe.png"},mission_003_00:{id:"mission_003_00",name:"The Scrapyard Revenant",dialogue:"mission_003_00",waves:w1,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_9_00.png",gravity:0},planets:[{name:"Ferrust",x:-3e3,y:4e3},{name:"Gilipe",x:9e3,y:-4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_09_junkyard.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_003_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_crusher-mae.png"},mission_004_00:{id:"mission_004_00",name:"The Miner's Dillemma",dialogue:"mission-generic",waves:uu,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_10_00.png",gravity:0},planets:[{name:"Arsea",x:6e3,y:4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_05_mission3.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_004_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_executron-9b.png"},mission_005_00:{id:"mission_005_00",name:"WIP",dialogue:"mission-generic",waves:uu,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_10_00.png",gravity:0},planets:[{name:"Arsea",x:6e3,y:4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_05_mission3.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_005_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_jackpot-vera.png"},mission_006_00:{id:"mission_006_00",name:"WIP",dialogue:"mission-generic",waves:uu,dropMultiplier:1.5,environmentSettings:{backgroundId:"background_10_00.png",gravity:0},planets:[{name:"Arsea",x:6e3,y:4e3}],enemyPower:.25,music:{file:"assets/sounds/music/track_05_mission3.mp3"},bonusObjectives:["No damage taken","Destroy all enemies in under 5 minutes"],passiveReward:1,sceneLighting:[0,0,0,0],requiredFlag:"mission.mission_006_00.unlocked",missionPortrait:"assets/characters/bosses/character_boss_admiral-pith.png"}};class k1{constructor(){this.currentMission=null}setMission(e){this.currentMission=e,e.music&&$.playMusic(e.music)}getMission(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission}getDropMultiplier(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.dropMultiplier??1}getMissionById(e){return Al[e]??null}getMissionDialogue(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.dialogue??null}getEnemyPower(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.enemyPower??1}getPlanetSpawnConfigs(){if(!this.currentMission)throw new Error("No mission loaded");return this.currentMission.planets??[]}clear(){this.currentMission=null}}const Qi=new k1,R1="assets/title_screen.png";function E1(a){return!!localStorage.getItem(`save${a}`)}const Mp=300,B1=10,I1=16,x1=2,Cp=280,Tp=280,_1=320,D1=120;class P1{constructor(e,i,n){this.backgroundImage=null,this.buttons=[],this.saveSlotButtons=[],this.showingSaveSlots=!1,this.confirmingDeleteSlot=null,this.confirmationButtons=[],this.saveSlotYOffsets=[0,0,0],this.saveSlotAnimationPhase=null,this.isAnimatingSlots=!1,this.update=o=>{const l=ae(),h=B1*l,u=I1*l,d=x1*l,g=Mp*l;if(this.isAnimatingSlots){if(this.saveSlotAnimationPhase==="sliding-up"){for(let b=0;b<this.saveSlotYOffsets.length;b++)this.saveSlotYOffsets[b]-=h;this.saveSlotYOffsets[0]<=-u&&(this.saveSlotAnimationPhase="settling")}else if(this.saveSlotAnimationPhase==="settling"){for(let b=0;b<this.saveSlotYOffsets.length;b++)this.saveSlotYOffsets[b]+=d,this.saveSlotYOffsets[b]>0&&(this.saveSlotYOffsets[b]=0);this.saveSlotYOffsets.every(b=>b===0)&&(this.isAnimatingSlots=!1,this.saveSlotAnimationPhase=null)}else if(this.saveSlotAnimationPhase==="sliding-down"){for(let b=0;b<this.saveSlotYOffsets.length;b++)this.saveSlotYOffsets[b]+=h;this.saveSlotYOffsets[0]>=g&&(this.isAnimatingSlots=!1,this.saveSlotAnimationPhase=null,this.showingSaveSlots=!1,this.saveSlotButtons=[],this.buttons=this.createMainButtons(),this.saveSlotYOffsets=[0,0,0])}}this.inputManager.updateFrame();const{x:m,y}=this.inputManager.getMousePosition(),v=this.inputManager.wasMouseClicked(),M=this.confirmingDeleteSlot!==null?this.confirmationButtons:[...this.buttons,...this.saveSlotButtons];for(const b of M)Bs(b,m,y,v,l)},this.render=o=>{this.canvasManager.clearAll();const l=ae(),h=this.canvasManager.getContext("background"),u=this.canvasManager.getContext("ui");this.backgroundImage&&h.drawImage(this.backgroundImage,0,0,h.canvas.width,h.canvas.height);for(const m of this.buttons)ht(u,m,l);if(this.showingSaveSlots)for(const m of this.saveSlotButtons){const y=m.slotIndex,v=this.saveSlotYOffsets[y]??0,M=m.y;m.y+=v,ht(u,m,l),m.y=M}if(this.confirmingDeleteSlot!==null){Ct({ctx:u,x:Cp*l,y:Tp*l,width:_1,height:D1,title:"Confirm Deletion",mouse:this.inputManager.getMousePosition(),clicked:this.inputManager.wasMouseClicked(),uiScale:l,options:{borderColor:"#ff0000",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#200000"},{offset:1,color:"#100000"}]}}});const m=14*l;u.fillStyle="#ff4444",u.font=`${Math.round(m)}px monospace`,u.fillText("Erase this save file?",300*l,320*l);for(const y of this.confirmationButtons)ht(u,y,l)}const d=this.inputManager.getMousePosition(),g=fn();ya(u,g,d.x,d.y,l)},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.buttons=this.createMainButtons()}async start(){$.playMusic({file:"assets/sounds/music/track_08_debriefing.mp3"}),this.backgroundImage=await va(R1),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}createMainButtons(){const e=ae(),i=40,n=460*e,o=200,l=60,h=10,u={borderRadius:10,alpha:1,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}},d={borderRadius:10,alpha:1,borderColor:"#ffaa00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#221100"},{offset:1,color:"#150a00"}]}},g=[],m=l*e+h*e;return g.push({x:i,y:n+m*0,width:o,height:l,label:this.showingSaveSlots?"Back":"Play",isHovered:!1,onClick:()=>{if($.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),this.showingSaveSlots)this.saveSlotAnimationPhase="sliding-down",this.isAnimatingSlots=!0;else{const y=Mp*e;this.saveSlotYOffsets=[y,y,y],this.saveSlotAnimationPhase="sliding-up",this.isAnimatingSlots=!0,this.showingSaveSlots=!0,this.saveSlotButtons=this.createSaveSlotButtons(),this.buttons=this.createMainButtons()}},style:this.showingSaveSlots?d:u}),g.push({x:i,y:n+m*1,width:o,height:l,label:"Credits",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),console.log("Credits clicked (not implemented)")},style:u}),Nu()&&g.push({x:i,y:n+m*2,width:o,height:l,label:"Quit",isHovered:!1,onClick:()=>{var y;$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),(y=window==null?void 0:window.electronAPI)!=null&&y.closeGame?window.electronAPI.closeGame():console.warn("Quit button pressed, but electronAPI.closeGame is not available.")},style:u}),g}createSaveSlotButtons(){const e=ae(),i=260,n=460*e,o=260,l=60,h=10,u={borderRadius:10,alpha:1,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}},d=[];for(let g=0;g<3;g++){const m=E1(g),y=m?`Load Save ${g+1}`:"New Game",v=l*e+h*e,M=o*e+h*e,b=o*e;d.push({x:i*e,y:n+v*g,width:o,height:l,label:y,isHovered:!1,onClick:()=>{ct.initialize(g);const C=ct.getInstance();$.play("assets/sounds/sfx/ui/start_00.wav","sfx"),C.changeSlot(g),m?(C.loadAll(),this.stop(),bt.fadeToScene("hub")):(Qi.setMission(Al.mission_001),this.stop(),bt.fadeToScene("mission"))},style:u,slotIndex:g}),m&&d.push({x:i+M+.65*b,y:n+v*g,width:40,height:l,label:"X",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.confirmingDeleteSlot=g,this.createConfirmationButtons()},style:{...u,borderColor:"#ff0000",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#220000"},{offset:1,color:"#110000"}]}},slotIndex:g})}return d}createConfirmationButtons(){const e=ae(),i=Cp*e,n=Tp*e,o=i+40*e,l=n+60*e,h=100,u=40,g=h*e+20*e;this.confirmationButtons=[{x:o,y:l,width:h,height:u,label:"Yes",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),this.confirmingDeleteSlot!==null&&(ct.eraseSave(this.confirmingDeleteSlot),this.saveSlotButtons=this.createSaveSlotButtons()),this.confirmingDeleteSlot=null,this.confirmationButtons=[]},style:{borderRadius:6,borderColor:"#00ff00",textFont:"16px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#003300"},{offset:1,color:"#001900"}]}}},{x:o+g,y:l,width:h,height:u,label:"No",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),this.confirmingDeleteSlot=null,this.confirmationButtons=[]},style:{borderRadius:6,borderColor:"#ff0000",textFont:"16px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#330000"},{offset:1,color:"#190000"}]}}}]}}class Rs{constructor(){this.stack=[],this.registry={}}static getInstance(){return Rs.instance||(Rs.instance=new Rs),Rs.instance}reset(){this.clearAll();for(const e in this.registry)delete this.registry[e];this.pauseFn=void 0,this.resumeFn=void 0}registerPauseHandlers(e,i){this.pauseFn=e,this.resumeFn=i}pause(){var e;(e=this.pauseFn)==null||e.call(this)}resume(){var e;(e=this.resumeFn)==null||e.call(this)}open(e){this.getTop()!==e&&(this.stack.includes(e)||this.stack.push(e),e.openMenu())}close(e){const i=this.stack.indexOf(e);i!==-1&&(this.stack.splice(i,1),e.closeMenu())}transition(e){this.pop(),this.open(e)}pop(){const e=this.stack.pop();e==null||e.closeMenu()}getTop(){return this.stack.length>0?this.stack[this.stack.length-1]:null}anyOpen(){return this.stack.length>0}clearAll(){var e;for(;this.stack.length>0;)(e=this.stack.pop())==null||e.closeMenu()}registerMenu(e,i){this.registry[e]=i}getMenu(e){return this.registry[e]}}function Yu(a){const{mode:e,fontOverride:i,forceErgonomic:n=!0}=a,o=ae(),l=e==="inPerson";let h=a.side;n&&Rs.getInstance().anyOpen()&&(h="right");const u=h==="right",d=l?{x:320*o,y:120*o,width:520*o,height:140*o}:u?{x:590*o,y:20*o,width:500*o,height:120*o}:{x:180*o,y:20*o,width:500*o,height:120*o},g=l?{x:80*o,y:420*o}:u?{x:1130*o,y:20*o}:{x:20*o,y:20*o},y=i??`${Math.round((l?24:20)*o)}px monospace`;return{textBoxRect:d,position:g,font:y}}class L1{constructor(){this.profiles=new Map,this.portraitCache=new Map,this.loadDefaults()}loadDefaults(){this.register({id:"marla",portrait:this.loadImage("assets/characters/character_marla-thinx.png"),blipAudioFile:"assets/sounds/bleeps/girl_ah.wav",basePitch:1.2,textSpeed:.04,pitchVariance:.3,syllableDuration:120,portraitOffset:{x:-100,y:-200}}),this.register({id:"rexor",portrait:this.loadImage("assets/characters/character_rexor-the-intern.png"),blipAudioFile:"assets/sounds/bleeps/man_eh.wav",textSpeed:.04,basePitch:.85,pitchVariance:.15,portraitOffset:{x:-100,y:-200}}),this.register({id:"carl",portrait:this.loadImage("assets/characters/character_carl.png"),blipAudioFile:"assets/sounds/bleeps/man_ah.wav",textSpeed:.04,pitchVariance:.5,syllableDuration:100,basePitch:.95}),this.register({id:"hero",portrait:this.loadImage("assets/characters/character_hero.png"),blipAudioFile:"assets/sounds/bleeps/man_ee.wav",basePitch:1}),this.register({id:"the-board",portrait:this.loadImage("assets/characters/character_the-board.png"),blipAudioFile:"assets/sounds/bleeps/girl_oh.wav",basePitch:1.1}),this.register({id:"crazy-moe",portrait:this.loadImage("assets/characters/bosses/character_boss_wildjoe.png"),blipAudioFile:"assets/sounds/bleeps/man_eh.wav",basePitch:.8,textSpeed:.05,pitchVariance:.5}),this.register({id:"executron",portrait:this.loadImage("assets/characters/bosses/character_boss_executron-9b.png"),blipAudioFile:"assets/sounds/bleeps/man_ah.wav",basePitch:.9,textSpeed:.05,pitchVariance:.5})}loadImage(e){const i=wi(e);if(this.portraitCache.has(i))return this.portraitCache.get(i);const n=new Image;return n.src=i,this.portraitCache.set(i,n),n}register(e){this.profiles.set(e.id,e)}getProfile(e){return this.profiles.get(e)}getAll(){return this.profiles}}const qu=new L1;class O1{constructor(e,i,n=()=>!1){this.events=e,this.orchestrator=i,this.shouldInterrupt=n,this.index=0,this.isBlocked=!1,this.pauseTimerMs=null,this.pendingCommand=null,this.requestedVisualFocus=!1,this.hasVisualFocus=!1,this.forceRightSide=!1,this.onMenuOpened=({id:o})=>{o==="blockDropDecisionMenu"&&(this.forceRightSide=!0)},this.onMenuClosed=({id:o})=>{o==="blockDropDecisionMenu"&&(this.forceRightSide=!1)},pe.on("menu:opened",this.onMenuOpened),pe.on("menu:closed",this.onMenuClosed)}destroy(){pe.off("menu:opened",this.onMenuOpened),pe.off("menu:closed",this.onMenuClosed),this.orchestrator.destroy()}update(e){var n,o,l,h,u,d;if(this.shouldInterrupt()){this.clear();return}if(this.orchestrator.update(e),this.pauseTimerMs!==null){this.pauseTimerMs-=e*1e3,this.pauseTimerMs<=0&&(this.pauseTimerMs=null,this.isBlocked=!1);return}if(this.pendingCommand||this.isBlocked&&!this.orchestrator.isFinished()||this.index>=this.events.length)return;const i=this.events[this.index++];switch(i.type){case"line":{if(this.requestedVisualFocus=!0,!this.hasVisualFocus){this.index--;return}this.orchestrator.setVisualsVisible(!0),this.isBlocked=!0;const g=((n=i.options)==null?void 0:n.side)??"left",m=this.forceRightSide?"right":g,y=((o=i.options)==null?void 0:o.mode)??"transmission",v=(l=i.options)==null?void 0:l.font,{textBoxRect:M,position:b,font:C}=Yu({mode:y,side:m,fontOverride:v});this.orchestrator.startDialogue({speakerId:i.speakerId,text:i.text,textColor:(h=i.options)==null?void 0:h.textColor,font:C,textBoxRect:M,textBoxAlpha:((u=i.options)==null?void 0:u.textBoxAlpha)??.8,position:b,mode:y,side:m,textSpeed:(d=qu.getProfile(i.speakerId))==null?void 0:d.textSpeed});return}case"pause":{this.isBlocked=!0,this.pauseTimerMs=i.durationMs;return}case"command":{this.isBlocked=!0;const g=i.run();g instanceof Promise?this.pendingCommand=g.then(()=>{this.isBlocked=!1,this.pendingCommand=null}):this.isBlocked=!1;return}case"showUI":{this.orchestrator.setVisualsVisible(!0);return}case"hideUI":{this.orchestrator.setVisualsVisible(!1);return}case"endIf":{i.condition()&&this.clear();return}}}render(e){this.orchestrator.render(e)}isFinished(){return this.index>=this.events.length&&!this.isBlocked}wantsVisualFocus(){return this.requestedVisualFocus&&!this.hasVisualFocus}grantVisualFocus(){this.hasVisualFocus=!0}clear(){this.index=this.events.length,this.orchestrator.clear()}skipToEnd(){var e,i;(i=(e=this.orchestrator).skipToEnd)==null||i.call(e)}}class F1{constructor(e){this.orchestratorFactory=e,this.allRunners=new Set,this.renderQueue=[],this.currentRenderer=null,this.runnerMap=new Map}startAsync(e,i,n){if(n&&this.runnerMap.has(n))return;const o=new O1(e,this.orchestratorFactory(),i);this.allRunners.add(o),n&&this.runnerMap.set(n,o)}update(e){for(const i of this.allRunners)if(i.update(e),i.wantsVisualFocus()&&!this.renderQueue.includes(i)&&this.renderQueue.push(i),i.isFinished()){this.allRunners.delete(i),i===this.currentRenderer&&(this.currentRenderer=null);for(const[n,o]of this.runnerMap.entries())if(o===i){this.runnerMap.delete(n);break}i.destroy()}!this.currentRenderer&&this.renderQueue.length>0&&(this.currentRenderer=this.renderQueue.shift(),this.currentRenderer.grantVisualFocus())}render(e){var i;(i=this.currentRenderer)==null||i.render(e)}clearAll(){for(const e of this.allRunners)e.clear();this.allRunners.clear(),this.runnerMap.clear(),this.renderQueue.length=0,this.currentRenderer=null}destroy(){for(const e of this.allRunners)e.destroy();this.allRunners.clear(),this.runnerMap.clear(),this.renderQueue.length=0,this.currentRenderer=null}hasActiveRunners(){return this.allRunners.size>0}getActiveRunnerCount(){return this.allRunners.size}}class U1{constructor(){this.vowels=new Set("aeiouyAEIOUY")}segment(e){if(!e)return[];const i=[];let n="";for(let o=0;o<e.length;o++){const l=e[o],h=e[o+1];if(n+=l,this.vowels.has(l)&&(!h||!this.vowels.has(h))){let u=o+1;for(;u<e.length&&!this.vowels.has(e[u]);)u++;(u-o===2&&u<e.length||u-o>2||u===e.length)&&(i.push(n),n="")}}return n&&i.push(n),i.length>0?i:[e]}}const N1=new U1;function H1(a,e){const i=a.trim().split(/\s+/),n=[];let o=0;const l=e.syllableDuration??120,h=e.pitchVariance??0;for(const u of i){const d=N1.segment(u);for(const g of d){const m=e.basePitch+h*(Math.random()-.5);n.push({syllable:g,timestamp:o/1e3,duration:l/1e3,audioFile:e.blipAudioFile,pitch:m}),o+=l}o+=80}return n}class W1{constructor(e,i,n,o,l){this.portraitRenderer=e,this.textboxRenderer=i,this.textRenderer=n,this.audioSynchronizer=o,this.speakerRegistry=l,this.activeLine=null,this.blipTimeline=[],this.elapsed=0,this.finished=!1,this.visualsVisible=!0,this.forceRightSide=!1,this.onMenuOpened=({id:h})=>{h==="blockDropDecisionMenu"&&(this.forceRightSide=!0)},this.onMenuClosed=({id:h})=>{h==="blockDropDecisionMenu"&&(this.forceRightSide=!1)},pe.on("menu:opened",this.onMenuOpened),pe.on("menu:closed",this.onMenuClosed)}destroy(){pe.off("menu:opened",this.onMenuOpened),pe.off("menu:closed",this.onMenuClosed)}startDialogue(e){const i=this.speakerRegistry.getProfile(e.speakerId);if(!i){console.warn(`Unknown speaker ID: ${e.speakerId}`);return}this.activeLine=e,this.elapsed=0,this.finished=!1,this.textRenderer.start(e),this.blipTimeline=H1(e.text,i),this.audioSynchronizer.start(this.blipTimeline)}update(e){!this.activeLine||this.finished||(this.elapsed+=e,this.textRenderer.update(e),this.audioSynchronizer.update(this.elapsed),this.textRenderer.isFinished()&&(this.finished=!0))}render(e){if(!this.visualsVisible||!this.activeLine)return;const i=this.activeLine,n=this.speakerRegistry.getProfile(i.speakerId);if(!n)return;const o=Yu({mode:i.mode,side:this.forceRightSide?"right":i.side,fontOverride:i.font});this.portraitRenderer.render(e,o.position,i,n),this.textboxRenderer.render(e,o.textBoxRect,i,n),this.textRenderer.render(e,o.textBoxRect,o.font,i)}skipToEnd(){var e,i,n,o;!this.activeLine||this.finished||((i=(e=this.textRenderer).skipToEnd)==null||i.call(e),(o=(n=this.audioSynchronizer).skipToEnd)==null||o.call(n),this.finished=!0)}isFinished(){return this.finished}clear(){this.activeLine=null,this.elapsed=0,this.finished=!1,this.textRenderer.clear(),this.audioSynchronizer.clear()}setVisualsVisible(e){this.visualsVisible=e}getVisualsVisible(){return this.visualsVisible}}class G1{constructor(){this.baseLargePortraitSize={width:512,height:512},this.baseSmallPortraitSize={width:128,height:128}}render(e,i,n,o){const l=ae(),{portrait:h,portraitOffset:u}=o,{x:d,y:g}=i,m=n.mode==="transmission",y=((u==null?void 0:u.x)??0)*l,v=((u==null?void 0:u.y)??0)*l,M=d+y,b=g+v,C=m?this.baseSmallPortraitSize:this.baseLargePortraitSize,w=C.width*l,A=C.height*l;m&&this.drawTransmissionFrame(e,M,b,w,A,l),e.drawImage(h,M,b,w,A),m&&this.drawTransmissionOverlay(e,M,b,w,A,l)}drawTransmissionFrame(e,i,n,o,l,h){e.save(),e.strokeStyle="#00ff88",e.lineWidth=2*h;const u=4*h;e.strokeRect(i-u,n-u,o+2*u,l+2*u),e.restore()}drawTransmissionOverlay(e,i,n,o,l,h){e.save(),e.fillStyle="rgba(0, 255, 100, 0.05)",e.fillRect(i,n,o,l),e.strokeStyle="rgba(0, 255, 100, 0.12)",e.lineWidth=1*h;const u=4*h;for(let d=0;d<l;d+=u)e.beginPath(),e.moveTo(i,n+d),e.lineTo(i+o,n+d),e.stroke();e.restore()}}class z1{render(e,i,n,o){const{x:l,y:h,width:u,height:d}=i;n.mode==="transmission"||o.transmissionStyle?this.drawTransmissionBox(e,l,h,u,d):this.drawSpeechBubble(e,l,h,u,d,n.textBoxAlpha??.8)}drawSpeechBubble(e,i,n,o,l,h){e.save(),e.fillStyle="#000000",e.globalAlpha=h,e.beginPath(),e.moveTo(i+16,n),e.lineTo(i+o-16,n),e.quadraticCurveTo(i+o,n,i+o,n+16),e.lineTo(i+o,n+l-16),e.quadraticCurveTo(i+o,n+l,i+o-16,n+l),e.lineTo(i+16,n+l),e.quadraticCurveTo(i,n+l,i,n+l-16),e.lineTo(i,n+16),e.quadraticCurveTo(i,n,i+16,n),e.closePath(),e.fill(),e.beginPath(),e.moveTo(i+40,n+l),e.lineTo(i+32,n+l+12),e.lineTo(i+48,n+l),e.fill(),e.restore()}drawTransmissionBox(e,i,n,o,l){e.save(),e.fillStyle="rgba(0, 255, 100, 0.08)",e.fillRect(i,n,o,l),e.strokeStyle="#00ff88",e.lineWidth=2,e.strokeRect(i-1,n-1,o+2,l+2),e.strokeStyle="rgba(0, 255, 100, 0.07)";for(let h=2;h<l;h+=4)e.beginPath(),e.moveTo(i,n+h),e.lineTo(i+o,n+h),e.stroke();e.restore()}}class X1{constructor(){this.fullText="",this.lines=[],this.revealedCharCount=0,this.elapsed=0,this.charDelay=.075,this.paddingX=16,this.baseLineHeight=22}start(e){this.fullText=e.text,this.lines=this.wrapText(e),this.revealedCharCount=0,this.elapsed=0,this.charDelay=e.textSpeed??this.charDelay}update(e){this.elapsed+=e;const i=Math.floor(this.elapsed/this.charDelay);this.revealedCharCount=Math.min(i,this.fullText.length)}render(e,i,n,o){const l=ae(),{x:h,y:u,width:d,height:g}=i,m=o.textColor??(o.mode==="transmission"?"#00ff88":"#ffffff"),y=this.baseLineHeight*l,v=this.paddingX*l;e.save(),e.font=n,e.fillStyle=m,e.textAlign="left";const M=Math.floor(g/y)-1;let b=this.revealedCharCount,C=u+32*l;for(let w=0;w<this.lines.length&&w<M;w++){const A=this.lines[w];if(b<=0)break;const E=A.slice(0,b);e.fillText(E,h+v,C),C+=y,b-=A.length}this.lines.length>M&&b>0&&e.fillText("",h+d-v-8*l,C-y),e.restore()}isFinished(){return this.revealedCharCount>=this.fullText.length}clear(){this.fullText="",this.lines=[],this.revealedCharCount=0,this.elapsed=0}skipToEnd(){this.revealedCharCount=this.fullText.length,this.elapsed=this.fullText.length*this.charDelay}wrapText(e){const{width:i}=e.textBoxRect,n=e.text.split(/\s+/),o=document.createElement("canvas").getContext("2d");o.font=e.font??"24px monospace";const l=ae(),h=this.paddingX*l,u=[];let d="";for(const g of n){const m=d?`${d} ${g}`:g;o.measureText(m).width>i-2*h&&d?(u.push(d),d=g):d=m}return d&&u.push(d),u}}class V1{constructor(e){this.playSound=e,this.timeline=[],this.currentIndex=0}start(e){this.timeline=e,this.currentIndex=0}update(e){for(;this.currentIndex<this.timeline.length&&this.timeline[this.currentIndex].timestamp<=e;){const i=this.timeline[this.currentIndex];this.playSound(i.audioFile,{pitch:i.pitch}),this.currentIndex++}}skipToEnd(){for(;this.currentIndex<this.timeline.length;this.currentIndex++){const e=this.timeline[this.currentIndex];this.playSound(e.audioFile,{pitch:e.pitch})}}clear(){this.timeline=[],this.currentIndex=0}}class Gm{static create(){return new W1(new G1,new z1,new X1,new V1((e,i)=>$.play(e,"dialogue",i)),qu)}}const wp=800;class Y1{constructor(e){this.orchestrator=e,this.currentScript=null,this.currentIndex=0,this.isActive=!1,this.isBlocked=!1,this.pauseTimerMs=null,this.postLineDelay=0,this.pendingCommand=null,this.activeSpeakerId=null,this.activeSpeakerOptions={},this.asyncManager=new F1(()=>Gm.create())}startScript(e){this.currentScript=e,this.currentIndex=0,this.postLineDelay=0,this.isActive=!0,this.isBlocked=!1,this.pendingCommand=null,this.advance()}advance(){var i,n,o,l,h,u;if(!this.currentScript||this.currentIndex>=this.currentScript.events.length){this.clear();return}const e=this.currentScript.events[this.currentIndex];switch(this.currentIndex++,e.type){case"line":{this.orchestrator.setVisualsVisible(!0),this.isBlocked=!0;const d=this.currentScript.defaultMode??"inPerson",g=((i=e.options)==null?void 0:i.mode)??this.activeSpeakerOptions.mode??d,m=((n=e.options)==null?void 0:n.side)??this.activeSpeakerOptions.side??"left",y=e.speakerId??this.activeSpeakerId;if(!y){console.warn("No speaker defined for line event"),this.advance();return}const v=((o=e.options)==null?void 0:o.textColor)??this.activeSpeakerOptions.textColor,M=((l=e.options)==null?void 0:l.font)??this.activeSpeakerOptions.font,{textBoxRect:b,position:C,font:w}=Yu({mode:g,side:m,fontOverride:M});this.orchestrator.startDialogue({speakerId:y,text:e.text,textColor:v,font:w,textBoxRect:b,textBoxAlpha:((h=e.options)==null?void 0:h.textBoxAlpha)??.8,position:C,mode:g,side:m,textSpeed:(u=qu.getProfile(y))==null?void 0:u.textSpeed});return}case"pause":{this.isBlocked=!0,this.pauseTimerMs=e.durationMs;return}case"command":{this.isBlocked=!0;const d=e.run();d instanceof Promise?this.pendingCommand=d.then(()=>{this.isBlocked=!1,this.pendingCommand=null}):this.isBlocked=!1;return}case"async":{this.asyncManager.startAsync(e.dialogue,()=>!this.isRunning()),this.advance();return}case"hideUI":{this.orchestrator.setVisualsVisible(!1),this.advance();return}case"showUI":{this.orchestrator.setVisualsVisible(!0),this.advance();return}case"endIf":{e.condition()?this.clear():this.advance();return}case"changespeaker":{this.activeSpeakerId=e.speakerId,this.activeSpeakerOptions=e.options??{},this.advance();return}default:{console.warn(`Unknown dialogue event type: ${e.type}`),this.advance();return}}}update(e){if(this.isActive){if(this.asyncManager.update(e),this.orchestrator.update(e),this.pauseTimerMs!==null){this.pauseTimerMs-=e*1e3,this.pauseTimerMs<=0&&(this.pauseTimerMs=null,this.isBlocked=!1,this.postLineDelay=wp);return}if(this.postLineDelay>0){this.postLineDelay-=e*1e3;return}if(!this.pendingCommand){if(this.isBlocked){this.orchestrator.isFinished()&&(this.isBlocked=!1,this.postLineDelay=wp);return}this.advance()}}}render(e){this.isActive&&(this.orchestrator.render(e),this.asyncManager.render(e))}skipOrAdvance(){var e,i;this.isActive&&(this.orchestrator.isFinished()?!this.pendingCommand&&!this.isBlocked&&this.postLineDelay<=0&&this.advance():(i=(e=this.orchestrator).skipToEnd)==null||i.call(e))}isRunning(){return this.isActive}clear(){this.currentScript=null,this.currentIndex=0,this.postLineDelay=0,this.isActive=!1,this.isBlocked=!1,this.pendingCommand=null,this.orchestrator.clear(),this.asyncManager.clearAll()}destroy(){this.clear(),this.orchestrator.destroy(),this.asyncManager.destroy()}}class No{static create(){const e=Gm.create();return new Y1(e)}}function q1(a){return{id:"test-script",defaultMode:"inPerson",events:[{type:"line",speakerId:"marla",text:"Excuse me. You are not authorized to take a break right now Shipwright!"}]}}function lt(a,e=100){return new Promise(i=>{const n=()=>{a()?i():setTimeout(n,e)};n()})}function j1(a){const{inputManager:e}=a;if(!e)throw new Error("Input manager is required for hub arrival dialogue");return{id:"hub-introduction-1",defaultMode:"inPerson",events:[{type:"pause",durationMs:500},{type:"line",speakerId:"marla",text:"Welcome to HQ. Please do not mistake this for a place of safety. It is merely where the paperwork lives."},{type:"line",speakerId:"marla",text:"I'm Marla Thinx, Account Liaison. My role is to observe, log, and gently discourage noncompliance. Occasionally I blink."},{type:"line",speakerId:"marla",text:"Your continued operation has triggered a provisional classification of 'survivor'. Please do not interpret this as encouragement."},{type:"line",speakerId:"marla",text:"You've been assigned a docking alcove, a breakroom with two functioning chairs, and access to the Passive Allocation Terminal."},{type:"line",speakerId:"marla",text:"You are now eligible for one (1) certified enhancement. The intern will explain. He insisted."},{type:"pause",durationMs:500},{type:"line",speakerId:"rexor",text:"Hey! You're not soup! That's great news!"},{type:"line",speakerId:"rexor",text:"You got your first passive point. The terminal still thinks it's a coffee machine, but it'll work."},{type:"line",speakerId:"rexor",text:"Go poke it and pick something. Might even help you not die. Or at least die slightly slower."},{type:"command",run:()=>{Ee.set("hub.passive-terminal.unlocked"),Ee.set("hub.introduction-1.complete")}}]}}function K1(a){const{inputManager:e}=a;if(!e)throw new Error("Input manager is required for hub arrival dialogue");return{id:"hub-introduction-2",defaultMode:"inPerson",events:[{type:"command",run:()=>{e.disableInput()}},{type:"pause",durationMs:2e3},{type:"line",options:{textBoxAlpha:1},speakerId:"rexor",text:"Pick a categoryOffense, Defense, Utility. Then slap a point into whatever looks shiny."},{type:"line",options:{textBoxAlpha:1},speakerId:"rexor",text:"Each upgrade stacks up to three times. Click confirm to make it official and mildly irreversible."},{type:"command",run:()=>{vt.getInstance().getAvailablePoints()===0&&vt.getInstance().addPassivePoints(1)}},{type:"hideUI"},{type:"command",run:()=>{e.enableInput()}},{type:"command",run:()=>lt(()=>vt.getInstance().hasAnyPassives())},{type:"showUI"},{type:"line",speakerId:"rexor",text:"Nice! You're now technically enhanced. Should make it slightly easier to extract value from volatile assets."},{type:"command",run:()=>{Ee.set("hub.introduction-2.complete")}}]}}function Z1(a){const{inputManager:e}=a;if(!e)throw new Error("Input manager is required for hub arrival dialogue");return{id:"hub-introduction-3",defaultMode:"inPerson",events:[{type:"line",speakerId:"marla",text:"Now that you've invested in personal development, you're eligible for further hazard deployment."},{type:"line",speakerId:"marla",text:"We've identified an unsanctioned scrapper cluster operating in Entropium-positive territory under Deep Void jurisdiction."},{type:"line",speakerId:"marla",text:"They are not employees. Their ships are not assets. Their existence constitutes a yield inefficiency."},{type:"line",speakerId:"marla",text:"Your directive is to reclaim all viable matter. Structural integrity is optional. Entropium output is not."},{type:"line",speakerId:"marla",text:"Proceed to the mission terminal. Further delays will be logged."},{type:"command",run:()=>{Ee.set("hub.introduction-3.complete"),Ee.set("hub.mission-computer.unlocked"),Ee.set("hub.breakroom.unlocked"),Ee.set("mission.scrapper-revenant.unlocked")}}]}}class Be{constructor(){this.currency=0,this.blockQueue=[],this.onCurrencyChangeCallbacks=new Set}static getInstance(){return Be.instance||(Be.instance=new Be),Be.instance}initialize(e=0){this.currency=e}getCurrency(){return this.currency}hasEnoughCurrency(e){return this.currency>=e}addCurrency(e){return e<=0?this.currency:(this.currency+=e,this.notifyCurrencyChange(),this.currency)}spendCurrency(e){return e<=0?!0:this.currency<e?!1:(this.currency-=e,this.notifyCurrencyChange(),!0)}onCurrencyChange(e){return this.onCurrencyChangeCallbacks.add(e),()=>this.onCurrencyChangeCallbacks.delete(e)}notifyCurrencyChange(){for(const e of this.onCurrencyChangeCallbacks)e(this.currency)}enqueueBlock(e){this.blockQueue.push(e)}enqueueBlockToFront(e){this.blockQueue.unshift(e)}dequeueBlock(){return this.blockQueue.shift()??null}getBlockQueue(){return this.blockQueue}getBlockCount(){return this.blockQueue.length}hasBlocks(){return this.blockQueue.length>0}queueSize(){return this.blockQueue.length}getLastGatheredBlock(){return this.blockQueue.length>0?this.blockQueue[this.blockQueue.length-1]:null}reset(){this.currency=0,this.blockQueue=[],this.notifyCurrencyChange()}destroy(){this.currency=0,this.blockQueue=[],this.onCurrencyChangeCallbacks.clear()}postMissionClear(){this.blockQueue=[],this.onCurrencyChangeCallbacks.clear()}}function Q1(a,e,i){wt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadShoulders",highlighted:["leftBumper"],width:160,height:80,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"key",keyLabel:"Shift",width:60,height:60,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0})}function $1(a,e,i){wt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadFaceButtons",highlightButton:"Y",radius:50,fontSize:18,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",textColor:"#FFFFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"key",keyLabel:"Tab",width:50,height:50,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0})}function J1(a,e,i){wt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadFaceButtons",highlightButton:"X",radius:50,fontSize:18,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",textColor:"#FFFFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"key",keyLabel:"X",width:50,height:50,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0})}function e2(a,e,i){wt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadSticks",wiggleStick:"right",highlightStick:"right",width:120,height:60,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"mouse",interactionMode:"wiggle",width:60,height:90,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0})}function t2(a,e,i){wt.getInstance().getLastUsed()==="gamepad"?a.createScreenCoachMark("",e,i,{type:"gamepadShoulders",highlighted:["rightBumper"],width:160,height:80,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0}):a.createScreenCoachMark("",e,i,{type:"mouse",interactionMode:"leftClick",width:60,height:90,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0})}function i2(a,e,i){if(wt.getInstance().getLastUsed()==="gamepad")a.createScreenCoachMark("",e,i,{type:"gamepadSticks",wiggleStick:"left",highlightStick:"left",width:120,height:60,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0});else{const l={type:"key",width:50,height:50,fontSize:24,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0};a.createScreenCoachMark("",e,i-80,{...l,keyLabel:"W"}),a.createScreenCoachMark("",e-80,i,{...l,keyLabel:"A"}),a.createScreenCoachMark("",e,i,{...l,keyLabel:"S"}),a.createScreenCoachMark("",e+80,i,{...l,keyLabel:"D"})}}const Ap=Be.getInstance();function s2(a){const{inputManager:e,waveSpawner:i,playerShip:n,coachMarkManager:o}=a;if(!e)throw new Error("Input manager is required for intro briefing");if(!i)throw new Error("Wave spawner is required for intro briefing");if(!n)throw new Error("Player ship is required for intro briefing");if(!o)throw new Error("Coach mark manager is required for intro briefing");return{id:"intro-briefing",defaultMode:"transmission",events:[{type:"endIf",condition:()=>Ee.has("mission.intro-briefing.complete")},{type:"command",run:()=>{e.disableAllActions()}},{type:"pause",durationMs:1e3},{type:"line",speakerId:"carl",text:"Greetings, Shipwright Second Class. Assessing your consciousness status..."},{type:"pause",durationMs:500},{type:"line",speakerId:"carl",text:"Neural activity meets minimum viable contractor threshold. Initiating pre-flight checks."},{type:"line",speakerId:"carl",text:"Activating Engine Systems. Please do remain stationary until accidents are formally authorized."},{type:"command",run:()=>{$.play("assets/sounds/sfx/ship/computing_00.wav","sfx")}},{type:"pause",durationMs:500},{type:"line",speakerId:"carl",text:"Thruster interface enabled. W, A, S, D keys mappedpending your keyboard competency certification..."},{type:"command",run:()=>{e.enableAllActions(),e.disableAction("firePrimary"),e.disableAction("openShipBuilder"),e.disableAction("pause")}},{type:"command",run:()=>{i2(o,200,400)}},{type:"command",run:()=>new Promise(l=>{const h=()=>{e.isKeyPressed("KeyW")||e.isKeyPressed("KeyA")||e.isKeyPressed("KeyS")||e.isKeyPressed("KeyD")||e.isLeftStickMoved()?l():requestAnimationFrame(h)};h()})},{type:"line",speakerId:"carl",text:"Mobility nominal. Unexpectedly, your motor cortex appears to be functional."},{type:"command",run:()=>{o.clear()}},{type:"line",speakerId:"carl",text:"Now engage your Afterburner with Left Shift. Or Left Bumper, if you're using a thumb-calibrated stick."},{type:"command",run:()=>{Q1(o,200,400)}},{type:"command",run:()=>new Promise(l=>{const h=()=>{e.isActionPressed("afterburner")?(o.clear(),l()):requestAnimationFrame(h)};h()})},{type:"line",speakerId:"carl",text:"Acceleration spike detected. Try not to hit anything valuablelike me."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Firing vector locked. Wiggle the mouseyes, the rodent-shaped input relicto express hostility."},{type:"command",run:()=>(e2(o,200,400),new Promise(l=>{const h=()=>{e.wasMouseMoved()||e.isRightStickMoved()?(o.clear(),l()):requestAnimationFrame(h)};h()}))},{type:"command",run:()=>{o.clear()}},{type:"line",speakerId:"carl",text:"Please Left-click to discharge kinetic discouragement..."},{type:"command",run:()=>{e.enableAction("firePrimary"),e.enableAction("pause"),t2(o,200,400)}},{type:"command",run:()=>new Promise(l=>{const h=()=>{e.isActionPressed("firePrimary")?(o.clear(),l()):requestAnimationFrame(h)};h()})},{type:"command",run:()=>{o.clear()}},{type:"line",speakerId:"carl",text:"Weapon discharge successful. No signs of sabotage by operator. Unexpected."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Press X to toggle between firing modes. 'Synced' for sustained fire, 'Sequence' for burst fire."},{type:"command",run:()=>{e.enableKey("KeyX")}},{type:"command",run:()=>{J1(o,200,400)}},{type:"command",run:()=>new Promise(l=>{const h=()=>{e.isActionPressed("switchFiringMode")?l():requestAnimationFrame(h)};h()})},{type:"command",run:()=>{o.clear()}},{type:"pause",durationMs:200},{type:"line",speakerId:"carl",text:"Use the scroll wheel or R/T to zoom in and out. Don't break it."},{type:"command",run:()=>{o.createScreenCoachMark("",200,400,{type:"mouse",interactionMode:"scroll",width:60,height:90,borderColor:"#00FFFF",fillColor:"#001122",highlightColor:"#00FFFF",duration:1/0})}},{type:"command",run:()=>new Promise(l=>{const h=()=>{e.wasScrollWheelUp()||e.wasScrollWheelDown()||e.isKeyPressed("KeyR")||e.isKeyPressed("KeyT")||e.isLeftTriggerPressed()&&e.isRightStickMoved()?l():requestAnimationFrame(h)};h()})},{type:"command",run:()=>{o.clear()}},{type:"line",speakerId:"carl",text:"Zoom functionality confirmed. Your biomechanics are improving... Slightly."},{type:"command",run:()=>{i.start()}},{type:"command",run:()=>{$.play("assets/sounds/sfx/ship/computing_00.wav","sfx")}},{type:"line",speakerId:"carl",text:"Telemetry indicates unidentified salvage targets approaching. Classification: 'reclaimable liability clusters'."},{type:"line",speakerId:"carl",text:"Standard procedure: convert threats into revenue. Failure to do so may impact your survivability rating."},{type:"pause",durationMs:3e3},{type:"hideUI"},{type:"command",run:()=>lt(()=>Te.get().enemiesDestroyed>=1)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Enemy presence reduced. Efficiency confirmed. Continue extraction until Entropium reserves reach acceptable thresholds."},{type:"command",run:()=>lt(()=>Ap.getBlockCount()>=1)},{type:"line",speakerId:"carl",text:"Block acquisition confirmed. Your first salvage target has been neutralized."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Press Tab to access the shipbuilding module."},{type:"command",run:()=>{$1(o,200,400)}},{type:"command",run:()=>{e.enableAction("openShipBuilder")}},{type:"command",run:()=>new Promise(l=>{const h=()=>{e.wasActionJustPressed("openShipBuilder")?l():requestAnimationFrame(h)};h()})},{type:"command",run:()=>{o.clear()}},{type:"command",run:()=>{e.disableAction("openShipBuilder")}},{type:"line",speakerId:"carl",text:"Place the block on the ship by clicking on the ship. Alternatively, refine the block into Entropium by clicking on the refine button.",options:{side:"right"}},{type:"command",run:()=>lt(()=>Te.get().blockRefinedCount>=1||Te.get().blockPlacedCount>=1)},{type:"line",speakerId:"carl",text:"Block placement or refinement confirmed. Your ship's structural integrity has been bolstered.",options:{side:"right"}},{type:"command",run:()=>{e.enableAction("openShipBuilder"),e.enableAction("pause")}},{type:"line",speakerId:"carl",text:"While you have at least one block, press Tab to place more blocks.",options:{side:"right"}},{type:"line",speakerId:"carl",text:"TIP: Right-click on any block on your ship to sell. Press Spacebar to rotate a block before placing.",options:{side:"right"}},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Gather Entropium to meet your quota. Your current target is 300 units.",options:{side:"right"}},{type:"hideUI"},{type:"command",run:()=>lt(()=>Ap.getCurrency()>=300)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Entropium extraction threshold reached. Your contract remains marginally unbroken."},{type:"line",speakerId:"carl",text:"Entropium has many uses. For now, know that it is the lifeblood of Deep Void operations."},{type:"pause",durationMs:300},{type:"line",speakerId:"carl",text:"Survive incoming waves in order to receive permission to return to headquarters."},{type:"line",speakerId:"carl",text:"Remember: Always build toward revenue."},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>lt(()=>i.isBossWaveActive())},{type:"showUI"},{type:"line",speakerId:"carl",text:"Powerful hostile detected. Proceed to center coordinates."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"carl",text:"Survival probability: 0.0001%. But hey, you never know."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"crazy-moe",text:"WELL WHADDYA KNOW! A flyin' lunchbox full'a alloys!"},{type:"pause",durationMs:500},{type:"line",speakerId:"crazy-moe",text:"HehI'ma pop yer cockpit like a soda tab and sniff the coolant fumes!"},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>lt(()=>i.shouldCompleteMission())},{type:"command",run:()=>{console.log("Added passive point!"),vt.getInstance().addPassivePoints(1)}},{type:"command",run:()=>{Ee.set("mission.intro-briefing.complete"),Ee.set("mission.mission_002.unlocked"),Ee.set("mission.mission_003_00.unlocked")}},{type:"showUI"},{type:"line",speakerId:"crazy-moe",text:"Y'got me! Sweet entropy, I see the light*AND SHE'S MADE OF REBAR AND RADIATION!*"}]}}function n2(a){const{inputManager:e,waveSpawner:i,playerShip:n}=a;if(!e)throw new Error("Input manager is required for generic mission dialogue");if(!i)throw new Error("Wave spawner is required for generic mission dialogue");if(!n)throw new Error("Player ship is required for generic mission dialogue");return{id:"mission-generic",defaultMode:"transmission",events:[{type:"showUI"},{type:"command",run:()=>{i.start()}},{type:"line",speakerId:"carl",text:"Survive incoming waves in order to receive permission to return to headquarters."},{type:"line",speakerId:"carl",text:"Remember: Always build toward revenue."},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>lt(()=>i.isBossWaveActive())},{type:"showUI"},{type:"line",speakerId:"carl",text:"Powerful hostile detected. Proceed to center coordinates."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"carl",text:"Survival probability: 0.0001%. But hey, you never know."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"crazy-moe",text:"WELL WHADDYA KNOW! A flyin' lunchbox full'a alloys!"},{type:"pause",durationMs:1e3},{type:"line",speakerId:"crazy-moe",text:"HehI'ma pop yer cockpit like a soda tab and sniff the coolant fumes!"},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>lt(()=>i.shouldCompleteMission())},{type:"showUI"},{type:"line",speakerId:"crazy-moe",text:"Y'got me! Sweet entropy, I see the light*AND SHE'S MADE OF REBAR AND RADIATION!*"},{type:"pause",durationMs:2e3}]}}function a2(a){const{inputManager:e,waveSpawner:i,playerShip:n}=a;if(!e)throw new Error("Input manager is required for generic planet dialogue");if(!i)throw new Error("Wave spawner is required for generic planet dialogue");if(!n)throw new Error("Player ship is required for generic planet dialogue");return{id:"planet-generic",defaultMode:"transmission",events:[{type:"command",run:()=>{$.play("assets/sounds/sfx/ship/computing_00.wav","sfx")}},{type:"line",speakerId:"carl",text:"Nobody appears to be home."},{type:"pause",durationMs:1e3}]}}function o2(a){const{inputManager:e,waveSpawner:i,playerShip:n}=a;if(!e)throw new Error("Input manager is required for mission dialogue");if(!i)throw new Error("Wave spawner is required for mission dialogue");if(!n)throw new Error("Player ship is required for mission dialogue");return{id:"mission_003_00",defaultMode:"transmission",events:[{type:"showUI"},{type:"line",speakerId:"carl",text:"Deployment confirmed. SYSTEM: FERRUST. CONDITION: METALLURGICALLY HOSTILE."},{type:"command",run:()=>{i.start()}},{type:"pause",durationMs:400},{type:"line",speakerId:"carl",text:"OBJECTIVE: Convert hostile scrap into Entropium. Try not to diebut either outcome generates data."},{type:"pause",durationMs:400},{type:"line",speakerId:"carl",text:"Remember: Survival is admirable. Profitability is mandatory."},{type:"pause",durationMs:700},{type:"hideUI"},{type:"async",dialogue:[{type:"command",run:()=>lt(()=>Te.get().enemiesDestroyed>=5)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Five kills? I'll adjust your obituary."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>lt(()=>Te.get().blocksUnlocked.length>=1)},{type:"showUI"},{type:"line",speakerId:"carl",text:"BLOCK UNLOCKED! Please be aware that all new technology is the intellectual property of Deep Void."},{type:"pause",durationMs:200},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>lt(()=>Te.get().blocksLost>=1)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Please avoid asset loss. Repair damaged blocks in Ship Building Console before damage becomes permanent."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>lt(()=>Te.get().enemiesDestroyed>=20)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Twenty construct terminations logged. Exceeding expectations will not result in a raise."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>lt(()=>Te.get().enemiesDestroyed>=50)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Fifty? Very efficient. Disturbingly so. Filing a concern."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"async",dialogue:[{type:"command",run:()=>lt(()=>Be.getInstance().getCurrency()>=1e3)},{type:"showUI"},{type:"line",speakerId:"carl",text:"Reminder: All Entropium is property of Deep Void Salvage Co. Unauthorized enrichment is discouraged."},{type:"pause",durationMs:1e3},{type:"hideUI"}]},{type:"command",run:()=>lt(()=>i.isBossWaveActive())},{type:"showUI"},{type:"line",speakerId:"carl",text:"Detecting massive kinetic disturbance. Signature: industrial-grade excavation unit... with delusions of grandeur."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"executron",text:"I WAS BUILT TO DIG. THEN THEY GAVE ME LEGS. BIG MISTAKE."},{type:"pause",durationMs:1e3},{type:"line",speakerId:"executron",text:"YOUR SHIP LOOKS LIKE A LOW-YIELD ASTEROID. PREPARE FOR AUTOMATED EXTRACTION."},{type:"pause",durationMs:1e3},{type:"hideUI"},{type:"command",run:()=>lt(()=>i.shouldCompleteMission())},{type:"command",run:()=>{Ee.set("mission.mission_003_00.complete"),Ee.set("mission.mission_004_00.unlocked")}},{type:"showUI"},{type:"line",speakerId:"executron",text:"SYSTEM FAILURE. CORE MELTDOWN IMMINENT. I REGRET NOTHING... EXCEPT THE LEGS."},{type:"pause",durationMs:2e3}]}}const r2=new Map([["test-script",q1],["hub-introduction-1",j1],["hub-introduction-2",K1],["hub-introduction-3",Z1],["intro-briefing",s2],["mission-generic",n2],["planet-generic",a2],["mission_003_00",o2]]);function mn(a,e){const i=r2.get(a);return i?i(e):void 0}const l2="assets/hub/backgrounds/scene_main-room.png",Ro={terminal:{x:50,y:280,width:300,height:360},map:{x:440,y:160,width:490,height:380},breakroom:{x:970,y:230,width:230,height:300}},c2={terminal:"hub.passive-terminal.unlocked",map:"hub.mission-computer.unlocked",breakroom:"hub.breakroom.unlocked"};class h2{constructor(e,i,n){this.backgroundImage=null,this.dialogueQueueManager=null,this.isHoveringInteraction=!1,this.update=o=>{var d;this.inputManager.updateFrame(),this.inputManager.wasKeyJustPressed("KeyF")&&Ee.clear();const l=this.inputManager.getMousePosition(),h=this.inputManager.wasMouseClicked();if((d=this.dialogueQueueManager)!=null&&d.isRunning()){this.dialogueQueueManager.update(this.gameLoop.getDeltaTime()),h&&this.dialogueQueueManager.skipOrAdvance();return}const u=g=>{const m=Tl(g);return l.x>=m.x&&l.x<=m.x+m.width&&l.y>=m.y&&l.y<=m.y+m.height};if(this.isHoveringInteraction=Object.entries(Ro).some(([g,m])=>u(m)&&Ee.has(c2[g])),h){if($.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),u(Ro.terminal)&&Ee.has("hub.passive-terminal.unlocked")){this.stop(),bt.fadeToScene("passives");return}else if(u(Ro.map)&&Ee.has("hub.mission-computer.unlocked")){this.stop(),bt.fadeToScene("galaxy");return}else if(u(Ro.breakroom)&&Ee.has("hub.breakroom.unlocked")){this.stop(),bt.fadeToScene("breakroom");return}}Bs(this.quitButton,l.x,l.y,h,ae())},this.render=o=>{var g;this.canvasManager.clearAll();const l=this.canvasManager.getContext("background"),h=this.canvasManager.getContext("ui"),u=this.inputManager.getMousePosition();this.backgroundImage&&l.drawImage(this.backgroundImage,0,0,l.canvas.width,l.canvas.height),(g=this.dialogueQueueManager)!=null&&g.isRunning()||ht(h,this.quitButton,ae()),this.dialogueQueueManager&&this.dialogueQueueManager.render(h);const d=this.isHoveringInteraction?Hu():fn();ya(h,d,u.x,u.y,ae())},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.quitButton={x:20,y:20,width:120,height:50,label:" Quit",isHovered:!1,onClick:()=>{this.stop(),$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:1}),bt.fadeToScene("title")},style:{borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}}async start(){if(this.backgroundImage=await va(l2),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start(),ct.getInstance().saveAll(),$.playMusic({file:"assets/sounds/music/track_01_hub.mp3"}),this.dialogueQueueManager=No.create(),Ee.has("hub.introduction-1.complete")){if(Ee.has("hub.introduction-1.complete")&&Ee.has("hub.introduction-2.complete")&&!Ee.has("hub.introduction-3.complete")){const e=mn("hub-introduction-3",{inputManager:this.inputManager});e&&this.dialogueQueueManager.startScript(e)}}else{const e=mn("hub-introduction-1",{inputManager:this.inputManager});e&&this.dialogueQueueManager.startScript(e)}}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}drawInteractionZones(e){e.strokeStyle="#0f0",e.lineWidth=1;for(const i of Object.values(Ro)){const n=Tl(i);e.strokeRect(n.x,n.y,n.width,n.height)}}}function u2(a,e,i=1){const{x:n,y:o,width:l,height:h,style:u={}}=e,{backgroundColor:d="#0a0a0a",borderColor:g="#00ff41",glow:m=!0,scanlineIntensity:y=.3,cornerBevel:v=!0,chromaticAberration:M=!0}=u,b=l*i,C=h*i,w=Math.min(3,h*.2);a.save(),v&&(a.beginPath(),a.moveTo(n+w,o),a.lineTo(n+b-w,o),a.lineTo(n+b,o+w),a.lineTo(n+b,o+C-w),a.lineTo(n+b-w,o+C),a.lineTo(n+w,o+C),a.lineTo(n,o+C-w),a.lineTo(n,o+w),a.closePath(),a.clip());const A=a.createLinearGradient(n,o,n,o+C);if(A.addColorStop(0,ii(d,"ff")),A.addColorStop(.5,ii(d,"cc")),A.addColorStop(1,ii(d,"ff")),a.fillStyle=A,a.fillRect(n,o,b,C),y>0){a.fillStyle=`rgba(255,255,255,${y*.05})`;for(let E=0;E<C;E+=2*i)a.fillRect(n,o+E,b,i)}a.restore(),m&&(a.save(),a.shadowColor=g,a.shadowBlur=10*i,a.strokeStyle=g,a.lineWidth=2*i,v?(a.beginPath(),a.moveTo(n+w,o),a.lineTo(n+b-w,o),a.lineTo(n+b,o+w),a.lineTo(n+b,o+C-w),a.lineTo(n+b-w,o+C),a.lineTo(n+w,o+C),a.lineTo(n,o+C-w),a.lineTo(n,o+w),a.closePath(),a.stroke()):a.strokeRect(n,o,b,C),a.restore()),M&&(a.save(),a.globalAlpha=.2,a.lineWidth=1*i,a.strokeStyle="#ff0000",a.strokeRect(n-.5*i,o,b,C),a.strokeStyle="#0000ff",a.strokeRect(n+.5*i,o,b,C),a.restore()),a.save(),a.strokeStyle=`${g}40`,a.lineWidth=1,a.strokeRect(n+1*i,o+1*i,b-2*i,C-2*i),a.restore()}function Bu(a){const e=Qi.getMissionById(a);return e?Ee.has(e.requiredFlag):!1}function kp(a,e,i){const n=a.createShader(e);return n?(a.shaderSource(n,i),a.compileShader(n),a.getShaderParameter(n,a.COMPILE_STATUS)?n:(console.error("Shader compile error:",a.getShaderInfoLog(n)),a.deleteShader(n),null)):(console.error("Failed to create shader"),null)}function f2(a,e,i){const n=a.createProgram();return n?(a.attachShader(n,e),a.attachShader(n,i),a.linkProgram(n),a.getProgramParameter(n,a.LINK_STATUS)?n:(console.error("Program link error:",a.getProgramInfoLog(n)),a.deleteProgram(n),null)):(console.error("Failed to create program"),null)}const d2=`
    attribute vec3 position;
    attribute vec3 normal;
    
    uniform mat4 modelMatrix;
    uniform mat4 viewMatrix;
    uniform mat4 projectionMatrix;
    uniform mat3 normalMatrix;
    
    varying vec3 vNormal;
    varying vec3 vPosition;
    
    void main() {
        vec4 worldPosition = modelMatrix * vec4(position, 1.0);
        vPosition = worldPosition.xyz;
        vNormal = normalize(normalMatrix * normal);
        gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
`,g2=`
    precision mediump float;

    varying vec3 vNormal;
    varying vec3 vPosition;

    uniform vec3 color;
    uniform float alpha; // NEW
    uniform vec3 lightPosition;
    uniform vec3 lightColor;
    uniform vec3 ambientColor;

    void main() {
        vec3 lightDirection = normalize(lightPosition - vPosition);
        float lightIntensity = max(dot(vNormal, lightDirection), 0.0);

        vec3 ambient = ambientColor * color;
        vec3 diffuse = lightColor * color * lightIntensity;

        gl_FragColor = vec4(ambient + diffuse, alpha); // MODIFIED
    }
`;function Yi(){return new Float32Array(3)}function p2(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])}function ti(a,e,i){return new Float32Array([a,e,i])}function Rp(a,e){const i=e[0]-a[0],n=e[1]-a[1],o=e[2]-a[2];return Math.sqrt(i*i+n*n+o*o)}function zm(a,e,i){return a[0]=e[0]-i[0],a[1]=e[1]-i[1],a[2]=e[2]-i[2],a}function m2(a,e,i){return a[0]=e[0]+i[0],a[1]=e[1]+i[1],a[2]=e[2]+i[2],a}function y2(a,e,i){return a[0]=e[0]*i,a[1]=e[1]*i,a[2]=e[2]*i,a}function Xm(a,e){const i=p2(e);return i>0&&(a[0]=e[0]/i,a[1]=e[1]/i,a[2]=e[2]/i),a}function v2(a,e){const i=[],n=[],o=[];for(let l=0;l<=e;l++){const h=l*Math.PI/e,u=Math.sin(h),d=Math.cos(h);for(let g=0;g<=e;g++){const m=g*2*Math.PI/e,y=Math.sin(m),M=Math.cos(m)*u,b=d,C=y*u;i.push(a*M,a*b,a*C),n.push(M,b,C)}}for(let l=0;l<e;l++)for(let h=0;h<e;h++){const u=l*(e+1)+h,d=u+e+1;o.push(u,d,u+1),o.push(d,d+1,u+1)}return{vertices:new Float32Array(i),normals:new Float32Array(n),indices:new Uint16Array(o)}}function rn(){return new Float32Array(16)}function Vm(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}function Ym(a,e,i,n,o){const l=1/Math.tan(e/2),h=1/(n-o);return a[0]=l/i,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(o+n)*h,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*o*n*h,a[15]=0,a}function b2(a,e,i){const n=i[0],o=i[1],l=i[2];return a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[8]=e[8],a[9]=e[9],a[10]=e[10],a[11]=e[11],a[12]=e[0]*n+e[4]*o+e[8]*l+e[12],a[13]=e[1]*n+e[5]*o+e[9]*l+e[13],a[14]=e[2]*n+e[6]*o+e[10]*l+e[14],a[15]=e[3]*n+e[7]*o+e[11]*l+e[15],a}function S2(a,e,i){const n=Math.sin(i),o=Math.cos(i),l=e[0],h=e[1],u=e[2],d=e[3],g=e[8],m=e[9],y=e[10],v=e[11];return a[0]=l*o-g*n,a[1]=h*o-m*n,a[2]=u*o-y*n,a[3]=d*o-v*n,a[8]=l*n+g*o,a[9]=h*n+m*o,a[10]=u*n+y*o,a[11]=d*n+v*o,a[4]=e[4],a[5]=e[5],a[6]=e[6],a[7]=e[7],a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15],a}function M2(a,e,i){const n=i[0],o=i[1],l=i[2];return a[0]=e[0]*n,a[1]=e[1]*n,a[2]=e[2]*n,a[3]=e[3]*n,a[4]=e[4]*o,a[5]=e[5]*o,a[6]=e[6]*o,a[7]=e[7]*o,a[8]=e[8]*l,a[9]=e[9]*l,a[10]=e[10]*l,a[11]=e[11]*l,a[12]=e[12],a[13]=e[13],a[14]=e[14],a[15]=e[15],a}function C2(a,e){const i=e[0],n=e[1],o=e[2],l=e[4],h=e[5],u=e[6],d=e[8],g=e[9],m=e[10],y=m*h-u*g,v=-m*l+u*d,M=g*l-h*d;let b=i*y+n*v+o*M;return b?(b=1/b,a[0]=y*b,a[1]=(-m*n+o*g)*b,a[2]=(u*n-o*h)*b,a[3]=v*b,a[4]=(m*i-o*d)*b,a[5]=(-u*i+o*l)*b,a[6]=M*b,a[7]=(-g*i+n*d)*b,a[8]=(h*i-n*l)*b,a):null}function Ep(a,e){const i=e[0],n=e[1],o=e[2],l=e[3],h=e[4],u=e[5],d=e[6],g=e[7],m=e[8],y=e[9],v=e[10],M=e[11],b=e[12],C=e[13],w=e[14],A=e[15],E=i*u-n*h,x=i*d-o*h,I=i*g-l*h,D=n*d-o*u,N=n*g-l*u,H=o*g-l*d,W=m*C-y*b,K=m*w-v*b,Z=m*A-M*b,Q=y*w-v*C,Y=y*A-M*C,ne=v*A-M*w;let J=E*ne-x*Y+I*Q+D*Z-N*K+H*W;return J?(J=1/J,a[0]=(u*ne-d*Y+g*Q)*J,a[1]=(o*Y-n*ne-l*Q)*J,a[2]=(C*H-w*N+A*D)*J,a[3]=(v*N-y*H-M*D)*J,a[4]=(d*Z-h*ne-g*K)*J,a[5]=(i*ne-o*Z+l*K)*J,a[6]=(w*I-b*H-A*x)*J,a[7]=(m*H-v*I+M*x)*J,a[8]=(h*Y-u*Z+g*W)*J,a[9]=(n*Z-i*Y-l*W)*J,a[10]=(b*N-C*I+A*E)*J,a[11]=(y*I-m*N-M*E)*J,a[12]=(u*K-h*Q-d*W)*J,a[13]=(i*Q-n*K+o*W)*J,a[14]=(C*x-b*D-w*E)*J,a[15]=(m*D-y*x+v*E)*J,a):null}function qm(a,e,i,n){const o=e[0],l=e[1],h=e[2],u=i[0],d=i[1],g=i[2],m=n[0],y=n[1],v=n[2];if(Math.abs(o-u)<1e-6&&Math.abs(l-d)<1e-6&&Math.abs(h-g)<1e-6)return Vm(a);let M=o-u,b=l-d,C=h-g,w=1/Math.hypot(M,b,C);M*=w,b*=w,C*=w;let A=y*C-v*b,E=v*M-m*C,x=m*b-y*M;w=Math.hypot(A,E,x),w>0?(w=1/w,A*=w,E*=w,x*=w):A=E=x=0;let I=b*x-C*E,D=C*A-M*x,N=M*E-b*A;return w=Math.hypot(I,D,N),w>0?(w=1/w,I*=w,D*=w,N*=w):I=D=N=0,a[0]=A,a[1]=I,a[2]=M,a[3]=0,a[4]=E,a[5]=D,a[6]=b,a[7]=0,a[8]=x,a[9]=N,a[10]=C,a[11]=0,a[12]=-(A*o+E*l+x*h),a[13]=-(I*o+D*l+N*h),a[14]=-(M*o+b*l+C*h),a[15]=1,a}class T2{constructor(e,i){this.program=null,this.sphere=v2(1,24),this.positionBuffer=null,this.normalBuffer=null,this.indexBuffer=null,this.locations=null,this.time=0,this.gl=e,this.camera=i}initialize(){const e=this.gl,i=kp(e,e.VERTEX_SHADER,d2),n=kp(e,e.FRAGMENT_SHADER,g2);this.program=f2(e,i,n),this.locations={position:e.getAttribLocation(this.program,"position"),normal:e.getAttribLocation(this.program,"normal"),modelMatrix:e.getUniformLocation(this.program,"modelMatrix"),viewMatrix:e.getUniformLocation(this.program,"viewMatrix"),projectionMatrix:e.getUniformLocation(this.program,"projectionMatrix"),normalMatrix:e.getUniformLocation(this.program,"normalMatrix"),color:e.getUniformLocation(this.program,"color"),lightPosition:e.getUniformLocation(this.program,"lightPosition"),lightColor:e.getUniformLocation(this.program,"lightColor"),ambientColor:e.getUniformLocation(this.program,"ambientColor"),alpha:e.getUniformLocation(this.program,"alpha")},this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.sphere.vertices),e.STATIC_DRAW),this.normalBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.sphere.normals),e.STATIC_DRAW),this.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.sphere.indices),e.STATIC_DRAW)}render(e,i){if(!this.program||!this.locations)return;const n=this.gl;this.time+=.016;const o=n.canvas;n.viewport(0,0,o.width,o.height),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.DEPTH_TEST),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA);const l=rn(),h=rn(),u=rn(),d=new Float32Array(9);qm(h,this.camera.position,this.camera.target,new Float32Array([0,1,0])),Ym(u,Math.PI/4,o.width/o.height,.1,100),n.useProgram(this.program),n.uniform3f(this.locations.lightPosition,0,0,40),n.uniform3f(this.locations.lightColor,1,1,1),n.uniform3f(this.locations.ambientColor,.2,.2,.2),n.uniformMatrix4fv(this.locations.viewMatrix,!1,h),n.uniformMatrix4fv(this.locations.projectionMatrix,!1,u),n.bindBuffer(n.ARRAY_BUFFER,this.positionBuffer),n.enableVertexAttribArray(this.locations.position),n.vertexAttribPointer(this.locations.position,3,n.FLOAT,!1,0,0),n.bindBuffer(n.ARRAY_BUFFER,this.normalBuffer),n.enableVertexAttribArray(this.locations.normal),n.vertexAttribPointer(this.locations.normal,3,n.FLOAT,!1,0,0),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.indexBuffer);for(const g of e){Vm(l),b2(l,l,g.position),S2(l,l,this.time*g.rotationSpeed),M2(l,l,ti(g.scale,g.scale,g.scale)),C2(d,l);const m=Bu(g.missionId),y=m?g.color:ti(.25,.25,.25),v=Yi();for(let C=0;C<3;C++)v[C]=Math.min(1,y[C]*1.5);const M=g===i?v:y,b=m?1:.3;n.uniform1f(this.locations.alpha,b),n.uniformMatrix4fv(this.locations.modelMatrix,!1,l),n.uniformMatrix3fv(this.locations.normalMatrix,!1,d),n.uniform3f(this.locations.color,M[0],M[1],M[2]),n.drawElements(n.TRIANGLES,this.sphere.indices.length,n.UNSIGNED_SHORT,0)}}destroy(){const e=this.gl;this.positionBuffer&&e.deleteBuffer(this.positionBuffer),this.normalBuffer&&e.deleteBuffer(this.normalBuffer),this.indexBuffer&&e.deleteBuffer(this.indexBuffer),this.program&&e.deleteProgram(this.program),e.viewport(0,0,e.canvas.width,e.canvas.height),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT)}}function Bp(a,e,i){return a+(e-a)*i}class w2{constructor(){this.position=Yi(),this.target=Yi(),this.targetPosition=Yi(),this.targetTarget=Yi(),this.isMoving=!1,this.moveSpeed=.08,this.position[0]=0,this.position[1]=0,this.position[2]=60,this.target[0]=0,this.target[1]=0,this.target[2]=0,this.targetPosition.set(this.position),this.targetTarget.set(this.target)}update(){if(!this.isMoving)return;let e=!1;for(let i=0;i<3;i++){const n=this.position[i];this.position[i]=Bp(this.position[i],this.targetPosition[i],this.moveSpeed),this.target[i]=Bp(this.target[i],this.targetTarget[i],this.moveSpeed),Math.abs(this.position[i]-n)>.001&&(e=!0)}this.isMoving=e}focusOnLocation(e){const i=Yi();zm(i,this.position,e.position),Xm(i,i);const n=e.scale*3;y2(i,i,n);const o=Yi();m2(o,e.position,i),this.targetPosition.set(o),this.targetTarget.set(e.position),this.isMoving=!0}resetView(){this.targetPosition[0]=0,this.targetPosition[1]=0,this.targetPosition[2]=60,this.targetTarget[0]=0,this.targetTarget[1]=0,this.targetTarget[2]=0,this.isMoving=!0}destroy(){}}const A2=[{id:"casina",name:"Casina System",position:ti(-22,-10,0),scale:2,color:ti(.1,.4,.1),rotationSpeed:-.15,missionId:"mission_002"},{id:"naxos",name:"Naxos System",position:ti(32,2,-20),scale:4,color:ti(.4,0,0),rotationSpeed:-.3,missionId:"mission_003_00"},{id:"prexus",name:"Prexus System",position:ti(20,18,-40),scale:8,color:ti(.8,.3,.9),rotationSpeed:.3,missionId:"mission_004_00"},{id:"mitron",name:"Mitron System",position:ti(-30,5,-10),scale:7,color:ti(.2,.6,1),rotationSpeed:.2,missionId:"mission_005_00"},{id:"solarum",name:"Solarum System",position:ti(0,0,0),scale:9,color:ti(1,.8,.1),rotationSpeed:-.1,missionId:"mission_006_00"}],Bl=class Bl{constructor(){this.locationMap=new Map;for(const e of A2)this.locationMap.set(e.id.toLowerCase(),e)}static getInstance(){return this.instance||(this.instance=new Bl),this.instance}static destroy(){this.instance=null}getLocationById(e){return this.locationMap.get(e.toLowerCase())??null}getAllLocations(){return Array.from(this.locationMap.values())}};Bl.instance=null;let kl=Bl;function Ip(a,e,i,n){const o=Yi();zm(o,a,i);const l=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],h=2*(o[0]*e[0]+o[1]*e[1]+o[2]*e[2]),u=o[0]*o[0]+o[1]*o[1]+o[2]*o[2]-n*n,d=h*h-4*l*u;if(d<0)return!1;const g=(-h-Math.sqrt(d))/(2*l),m=(-h+Math.sqrt(d))/(2*l);return g>0||m>0}function k2(a,e,i,n){const o=2*a/i.width-1,l=1-2*e/i.height,h=i.width/i.height,u=rn(),d=rn(),g=rn(),m=rn();Ym(u,Math.PI/4,h,.1,100),qm(d,n.position,n.target,new Float32Array([0,1,0])),Ep(g,u),Ep(m,d);const y=[o,l,-1,1],v=[g[0]*y[0]+g[4]*y[1]+g[8]*y[2]+g[12]*y[3],g[1]*y[0]+g[5]*y[1]+g[9]*y[2]+g[13]*y[3],-1,0],M=new Float32Array([m[0]*v[0]+m[4]*v[1]+m[8]*v[2]+m[12]*v[3],m[1]*v[0]+m[5]*v[1]+m[9]*v[2]+m[13]*v[3],m[2]*v[0]+m[6]*v[1]+m[10]*v[2]+m[14]*v[3]]),b=Yi();return b[0]=M[0],b[1]=M[1],b[2]=M[2],Xm(b,b),{origin:new Float32Array([n.position[0],n.position[1],n.position[2]]),direction:b}}class R2{constructor(e,i){this.canvasManager=e,this.inputManager=i,this.locations=kl.getInstance().getAllLocations(),this.selectedLocation=null,this.hoveredLocation=null,this.locationHoverStates=new Map,this.HOVER_SCALE_MULTIPLIER=1.2,this.SCALE_LERP_SPEED=.15,this.gl=this.canvasManager.getWebGLContext("polygon"),this.camera=new w2,this.renderer=new T2(this.gl,this.camera),this.initializeHoverStates()}initializeHoverStates(){for(const e of this.locations)this.locationHoverStates.set(e.id||e.name,{location:e,currentScale:e.scale,targetScale:e.scale})}lerp(e,i,n){return e+(i-e)*n}updateHoverStates(){for(const e of this.locationHoverStates.values())Math.abs(e.currentScale-e.targetScale)>.001?e.currentScale=this.lerp(e.currentScale,e.targetScale,this.SCALE_LERP_SPEED):e.currentScale=e.targetScale}initialize(){this.renderer.initialize()}update(){const{x:e,y:i}=this.inputManager.getMousePosition(),{origin:n,direction:o}=k2(e,i,this.gl.canvas,this.camera);let l=null,h=1/0;for(const u of this.locations){const d=this.locationHoverStates.get(u.id||u.name),g=(d==null?void 0:d.currentScale)||u.scale;if(Ip(n,o,u.position,g)&&Bu(u.missionId)){const y=Rp(n,u.position);y<h&&(h=y,l=u)}}if(l!==this.hoveredLocation){if(this.hoveredLocation&&this.hoveredLocation!==this.selectedLocation){const u=this.locationHoverStates.get(this.hoveredLocation.id||this.hoveredLocation.name);u&&(u.targetScale=this.hoveredLocation.scale)}if(this.hoveredLocation=l,this.hoveredLocation&&!this.selectedLocation&&$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:2}),this.hoveredLocation&&this.hoveredLocation!==this.selectedLocation){const u=this.locationHoverStates.get(this.hoveredLocation.id||this.hoveredLocation.name);u&&(u.targetScale=this.hoveredLocation.scale*this.HOVER_SCALE_MULTIPLIER)}}if(this.selectedLocation){const u=this.locationHoverStates.get(this.selectedLocation.id||this.selectedLocation.name);u&&(u.targetScale=this.selectedLocation.scale,u.currentScale=this.selectedLocation.scale)}if(this.inputManager.wasLeftClicked()){let u=null,d=1/0;for(const g of this.locations){const m=this.locationHoverStates.get(g.id||g.name),y=(m==null?void 0:m.currentScale)||g.scale;if(Ip(n,o,g.position,y)){const M=Rp(n,g.position);M<d&&(d=M,u=g)}}u?Bu(u.missionId)&&(this.selectedLocation||(this.selectedLocation=u,this.camera.focusOnLocation(u),$.play("assets/sounds/sfx/ui/planetselect_01.wav","sfx",{maxSimultaneous:2}))):(this.selectedLocation&&$.play("assets/sounds/sfx/ui/planetselect_00.wav","sfx",{maxSimultaneous:2}),this.selectedLocation=null,this.camera.resetView())}this.updateHoverStates(),this.camera.update()}render(){const e=this.locations.map(i=>{const n=this.locationHoverStates.get(i.id||i.name),o=this.selectedLocation&&i.id===this.selectedLocation.id;return n&&!o&&n.currentScale!==i.scale?{...i,scale:n.currentScale}:i});this.renderer.render(e,this.selectedLocation)}destroy(){this.renderer.destroy(),this.camera.destroy(),this.locationHoverStates.clear(),kl.destroy()}getSelectedLocation(){return this.selectedLocation}getHoveredLocation(){return this.hoveredLocation}}const E2="assets/hub/backgrounds/scene_galaxy-map.png",xp={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};class B2{constructor(e,i,n){this.backgroundImage=null,this.missionPortraitCache=new Map,this.currentlyLoadingPortraitId=null,this.selectedLocationLaunchButton=null,this.update=()=>{this.inputManager.updateFrame();const o=ae(),{x:l,y:h}=this.inputManager.getMousePosition(),u=this.inputManager.wasMouseClicked();this.galaxyMapController.update();for(const g of this.buttons)g.isHovered=l>=g.x&&l<=g.x+g.width&&h>=g.y&&h<=g.y+g.height,Bs(g,l,h,u,o);const d=this.galaxyMapController.getSelectedLocation();if(d&&d.missionId){const g=Al[d.missionId];if(!g)return;this.selectedLocationLaunchButton={x:this.canvasManager.getContext("ui").canvas.width/2-180*o,y:this.canvasManager.getContext("ui").canvas.height/2+140*o,width:360,height:40,label:`Launch "${g.name}"`,isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/start_00.wav","sfx",{maxSimultaneous:4}),Qi.setMission(g),this.stop(),bt.fadeToScene("mission")},style:xp};const m=g.missionPortrait;m&&!this.missionPortraitCache.has(m)&&this.currentlyLoadingPortraitId!==m&&(this.currentlyLoadingPortraitId=m,va(wi(m)).then(y=>{this.missionPortraitCache.set(m,y),this.currentlyLoadingPortraitId=null}).catch(y=>{console.warn(`Failed to load mission portrait: ${m}`,y),this.currentlyLoadingPortraitId=null}))}else this.selectedLocationLaunchButton=null;if(this.selectedLocationLaunchButton){const g=this.selectedLocationLaunchButton;g.isHovered=l>=g.x&&l<=g.x+g.width&&h>=g.y&&h<=g.y+g.height,Bs(g,l,h,u,o)}},this.render=()=>{var M;this.canvasManager.clearAll();const o=ae(),l=this.canvasManager.getContext("background"),h=this.canvasManager.getContext("ui"),{x:u,y:d}=this.inputManager.getMousePosition();this.backgroundImage&&l.drawImage(this.backgroundImage,0,0,l.canvas.width,l.canvas.height),this.galaxyMapController.render();for(const b of this.buttons)ht(h,b,o);this.selectedLocationLaunchButton&&ht(h,this.selectedLocationLaunchButton,o);const g=this.galaxyMapController.getSelectedLocation();if(g&&g.missionId){const b=Al[g.missionId];if(b&&b.missionPortrait){const C=this.missionPortraitCache.get(b.missionPortrait);if(C){const w=h.canvas,A=256*o,E=4*o,x=A-E*2,I=w.width/2-x/2,D=180*o;u2(h,{x:I,y:D,width:A,height:A}),h.drawImage(C,I+E,D+E,x,x)}}}let m=fn();const y=this.galaxyMapController.getHoveredLocation(),v=this.galaxyMapController.getSelectedLocation();(y&&!v||(M=this.selectedLocationLaunchButton)!=null&&M.isHovered)&&(m=Hu()),ya(h,m,u,d,o)},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.galaxyMapController=new R2(e,n),this.buttons=[{x:20,y:20,width:120,height:50,label:" Back",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.stop(),bt.fadeToScene("hub")},style:xp}]}async start(){this.backgroundImage=await va(E2),this.galaxyMapController.initialize(),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start(),$.play("assets/sounds/sfx/ui/galaxymap_00.wav","sfx",{maxSimultaneous:1})}stop(){this.galaxyMapController.destroy(),this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}}class I2{constructor(e,i,n,o,l={}){this.x=e,this.y=i,this.width=n,this.height=o,this.options=l,this.scanlineOffset=0,this.lastTime=0}update(e){this.lastTime===0&&(this.lastTime=e);const i=e-this.lastTime;this.lastTime=e;const n=this.options.scanlineSpacing??6;this.scanlineOffset=(this.scanlineOffset+i*.03)%n}draw(e,i=1){const{borderRadius:n=10,backgroundColor:o="#000a00",borderColor:l="#00ff41",glowColor:h="#00ff41",alpha:u=1,scanlineSpacing:d=6,backgroundGradient:g}=this.options;e.save(),e.globalAlpha=u;let m=o;if(g){const{type:y,stops:v,from:M=[this.x,this.y],to:b=[this.x+this.width*i,this.y+this.height*i],radius:C=this.width*i/2}=g,w=y==="linear"?e.createLinearGradient(M[0],M[1],b[0],b[1]):e.createRadialGradient(M[0],M[1],0,M[0],M[1],C);for(const A of v)w.addColorStop(A.offset,A.color);m=w}e.fillStyle=m,e.strokeStyle=l,e.lineWidth=2,e.shadowColor=h,e.shadowBlur=12,e.beginPath(),e.roundRect(this.x,this.y,this.width*i,this.height*i,n),e.fill(),e.stroke(),e.shadowBlur=0,e.globalAlpha=.06,e.fillStyle=h;for(let y=-this.scanlineOffset;y<this.height*i;y+=d)e.fillRect(this.x,this.y+y,this.width*i,1);e.restore()}}function xt(a,e,i,n,o={},l=1){const{font:h='14px "Courier New", monospace',color:u="#00ff41",glow:d=!0,chromaticAberration:g=!0,align:m="left",baseline:y="top"}=o,v=h.replace(/(\d+)(px)/,(b,C,w)=>`${Math.round(parseInt(C)*l)}${w}`),M=.5*l;a.save(),a.font=v,a.textAlign=m,a.textBaseline=y,d&&(a.shadowColor=u,a.shadowBlur=4*l),g&&(a.save(),a.shadowBlur=0,a.globalAlpha=.25,a.fillStyle="#ff0000",a.fillText(n,e-M,i),a.fillStyle="#0000ff",a.fillText(n,e+M,i),a.restore()),a.globalAlpha=1,a.fillStyle=u,a.fillText(n,e,i),a.restore()}class fu{constructor(e,i,n=0){this.fullText=e,this.baseDelayMs=i,this.jitter=n,this.currentLength=0,this.startTime=0,this.isFinished=!1,this.schedule=[]}start(e){this.startTime=e,this.currentLength=0,this.isFinished=!1,this.schedule=[];let i=0;for(let n=0;n<this.fullText.length;n++){const o=this.baseDelayMs+(Math.random()*2-1)*this.jitter;i+=Math.max(0,o),this.schedule.push(i)}}update(e){if(this.isFinished)return;const i=e-this.startTime;for(;this.currentLength<this.schedule.length&&i>=this.schedule[this.currentLength];)this.currentLength++;this.currentLength>=this.fullText.length&&(this.currentLength=this.fullText.length,this.isFinished=!0)}getText(){return this.fullText.slice(0,this.currentLength)}done(){return this.isFinished}}function x2(a,e="monospace"){return`${Math.round(ma(a))}px ${e}`}class _2{constructor(){this.phase="loginPrompt",this.timer=0,this.lastTime=0,this.username=new fu("Shipwright SecondClass",30,40),this.password=new fu("************",60,20),this.bootText=new fu("VIEW_PASSIVES()    ",50,1),this.delayAfterPhaseComplete=600}update(e){const i=e-this.lastTime;switch(this.lastTime=e,this.timer+=i,this.phase){case"usernameInput":this.username.update(e),this.username.done()&&this.timer>this.delayAfterPhaseComplete&&this.advance("passwordPrompt");break;case"passwordInput":this.password.update(e),this.password.done()&&this.timer>this.delayAfterPhaseComplete&&this.advance("clear1");break;case"bootMessage":this.bootText.update(e),this.bootText.done()&&this.timer>this.delayAfterPhaseComplete&&this.advance("clear2");break}}draw(e){const i=ku(300);let n=ma(160);const o={font:x2(18),color:"#00ff41",glow:!0,chromaticAberration:!0};switch(e.save(),e.fillStyle="#000",e.restore(),this.phase){case"loginPrompt":xt(e,i,n,"login:",o),this.advance("usernameInput");break;case"usernameInput":xt(e,i,n,"login: "+this.username.getText(),o);break;case"passwordPrompt":xt(e,i,n,"login: Shipwright SecondClass",o),n+=ma(32),xt(e,i,n,"password:",o),this.advance("passwordInput");break;case"passwordInput":xt(e,i,n-ma(32),"login: Shipwright SecondClass",o),xt(e,i,n,"password: "+this.password.getText(),o);break;case"clear1":this.advance("bootMessage");break;case"bootMessage":xt(e,i,n,this.bootText.getText(),o);break;case"clear2":this.advance("done");break}}advance(e){this.phase=e,this.timer=0;const i=performance.now();e==="usernameInput"&&this.username.start(i),e==="passwordInput"&&this.password.start(i),e==="bootMessage"&&this.bootText.start(i)}isComplete(){return this.phase==="done"}}function du(a,e,i=1){const{x:n,y:o,width:l,height:h,label:u,isHovered:d,style:g={}}=e,{backgroundColor:m="#001100",borderColor:y="#00ff41",textColor:v="#00ff41",font:M='13px "Courier New", monospace',glow:b=!0,chromaticAberration:C=!0,alpha:w=1}=g,A=l*i,E=h*i,x=M.replace(/(\d+)(px)/,(K,Z,Q)=>`${Math.round(parseInt(Z)*i)}${Q}`),I=.8,D=d?Mi(y,I):y,N=d?Mi(v,I):v;a.save(),a.globalAlpha=w,a.fillStyle=m,a.fillRect(n,o,A,E),b&&(a.shadowColor=D,a.shadowBlur=8*i),a.strokeStyle=D,a.lineWidth=2*i,a.strokeRect(n,o,A,E),a.restore();const H=n+A/2,W=o+E/2;a.save(),a.font=x,a.textAlign="center",a.textBaseline="middle",b&&(a.shadowColor=N,a.shadowBlur=4*i),C&&(a.save(),a.globalAlpha=.25,a.shadowBlur=0,a.fillStyle="#ff0000",a.fillText(u,H-.5*i,W),a.fillStyle="#0000ff",a.fillText(u,H+.5*i,W),a.restore()),a.globalAlpha=1,a.fillStyle=N,a.fillText(u,H,W),a.restore()}const _p={offense:"Offense",defense:"Defense",utility:"Utility"},D2={"harvester-range":{label:"Harvester Range",category:"utility",tiers:{1:20,2:40,3:60},unit:"%"},"laser-damage":{label:"Laser Damage",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"laser-energy-drain":{label:"Laser Energy Drain",category:"offense",tiers:{1:-10,2:-20,3:-30},unit:"%"},"laser-block-cost":{label:"Laser Block Cost",category:"offense",tiers:{1:-10,2:-20,3:-30},unit:"%"},"explosive-lance-radius":{label:"Explosive Lance Radius",category:"offense",tiers:{1:1,2:2,3:3}},"explosive-lance-firing-rate":{label:"Explosive Lance Firing Rate",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"block-durability":{label:"Block Durability",category:"defense",tiers:{1:5,2:10,3:15},unit:"%"},"fin-turn-power":{label:"Fin Turn Power",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"engine-thrust":{label:"Engine Thrust",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"charger-rate":{label:"Charger Rate",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"battery-capacity":{label:"Battery Capacity",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"},"turret-firing-rate":{label:"Turret Firing Rate",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"turret-damage":{label:"Turret Damage",category:"offense",tiers:{1:5,2:10,3:15},unit:"%"},"turret-accuracy":{label:"Turret Accuracy",category:"offense",tiers:{1:10,2:20,3:30},unit:"%"},"shield-energy-drain":{label:"Shield Energy Drain",category:"defense",tiers:{1:-10,2:-20,3:-30},unit:"%"},"shield-radius":{label:"Shield Radius",category:"defense",tiers:{1:1,2:2,3:3}},"shield-efficiency":{label:"Shield Efficiency",category:"defense",tiers:{1:10,2:20,3:30},unit:"%"},"facetplate-armor":{label:"Facetplate Armor",category:"defense",tiers:{1:10,2:20,3:30},unit:"%"},"hull-armor":{label:"Hull Armor",category:"defense",tiers:{1:10,2:20,3:30},unit:"%"},"hull-mass":{label:"Hull Mass",category:"utility",tiers:{1:-10,2:-20,3:-30},unit:"%"},"cockpit-armor":{label:"Cockpit Armor",category:"defense",tiers:{1:30,2:60,3:100}},"block-repair-cost":{label:"Block Repair Cost",category:"utility",tiers:{1:-10,2:-20,3:-30},unit:"%"},"entropium-pickup-bonus":{label:"Entropium Pickup Bonus",category:"utility",tiers:{1:5,2:10,3:15},unit:"%"},"block-drop-rate":{label:"Block Drop Rate",category:"utility",tiers:{1:10,2:20,3:30},unit:"%"}};class P2{constructor(e,i,n){this.inputManager=e,this.passiveManager=i,this.bounds=n,this.scrollOffset=0,this.baseScrollSpeed=40,this.isDraggingThumb=!1,this.thumbDragOffsetY=0,this.contentHeight=0,this.activeButtons=[]}update(){const e=ae(),i=Math.floor(this.baseScrollSpeed*e),n=Math.floor(28*e),o=Math.floor(24*e),l=this.bounds.x+this.bounds.width-n,h=Math.max(0,this.contentHeight-this.bounds.height);(this.inputManager.wasScrollWheelDown()||this.inputManager.isKeyPressed("KeyS"))&&(this.scrollOffset=Math.min(this.scrollOffset+i,h)),(this.inputManager.wasScrollWheelUp()||this.inputManager.isKeyPressed("KeyW"))&&(this.scrollOffset=Math.max(0,this.scrollOffset-i));const{x:u,y:d}=this.inputManager.getMousePosition(),g=this.inputManager.wasMouseClicked(),m=this.inputManager.isKeyPressed("MouseLeft"),y=this.inputManager.wasKeyJustReleased("MouseLeft"),v=this.inputManager.wasKeyJustPressed("MouseLeft"),M=this.bounds.y+o,b=this.bounds.height-o*2,C=this.bounds.height/Math.max(this.contentHeight,1),w=Math.max(Math.floor(30*e),C*b),A=l+Math.floor(2*e),E=M+this.scrollOffset/h*(b-w),x=u>=A&&u<=A+(n-Math.floor(4*e))&&d>=E&&d<=E+w;if(v&&x&&(this.isDraggingThumb=!0,this.thumbDragOffsetY=d-E),this.isDraggingThumb&&m){const I=d-this.bounds.y-o-this.thumbDragOffsetY,D=b-w;if(D>0){const N=Math.floor(32*e),H=Math.max(0,this.contentHeight-this.bounds.height),W=Math.round(H/N)*N,Q=Math.max(0,Math.min(D,I))/D*W,Y=Math.round(Q/N)*N;this.scrollOffset=Math.min(Y,W)}else this.scrollOffset=0}y&&(this.isDraggingThumb=!1);for(const I of this.activeButtons)if(I.isHovered=u>=I.x&&u<=I.x+I.width&&d>=I.y&&d<=I.y+I.height,I.isHovered&&g){I.onClick();break}}render(e){const i=ae(),{x:n,y:o,width:l,height:h}=this.bounds;e.save(),e.beginPath(),e.rect(n,o,l,h),e.clip();let u=o-this.scrollOffset;const d=Math.floor(32*i),g=Math.floor(28*i),m=Math.floor(70*i),y=n+Math.floor(320*i),v=Math.floor(28*i),M=Math.floor(24*i),b=n+l-v;this.activeButtons=[];let C=0;for(const K of Object.keys(_p)){const Z=_p[K];xt(e,n+d,u,Z.toUpperCase(),{font:`${Math.floor(18*i)}px monospace`,color:"#00ff00"}),u+=g;for(const[Q,Y]of Object.entries(D2)){if(Y.category!==K)continue;const ne=this.passiveManager.getPassiveTier(Q);xt(e,n+d,u,Y.label,{font:`${Math.floor(15*i)}px monospace`,color:"#ffffff"});let J=0;for(const k of[1,2,3]){const te=`${Y.tiers[k]}${Y.unit??""}`,ie=y+J*m;xt(e,ie,u,te,{font:`${Math.floor(15*i)}px monospace`,color:ne!==null&&k<=ne?"#00ff41":"#666666"}),J++}const ee=(ne??0)+1;ee<=3&&this.passiveManager.canAfford(ee);let _=y+3*m+Math.floor(10*i);const z=ee<=3,se=z?this.passiveManager.getUpgradeCost(ee,ne):0,oe=z&&this.passiveManager.canAfford(ee);if(z){const k={x:_,y:u-Math.floor(2*i),width:Math.floor(30*i),height:Math.floor(20*i),label:"+",onClick:oe?()=>{this.passiveManager.setPassiveTier(Q,ee)}:()=>{},style:{font:`${Math.floor(14*i)}px monospace`,backgroundColor:"#111111",borderColor:oe?"#00ff00":"#444444",textColor:oe?"#00ff00":"#666666",alpha:.8,glow:oe,chromaticAberration:oe}};this.activeButtons.push(k),du(e,k),xt(e,k.x+k.width+Math.floor(8*i),u,`Cost: ${se}`,{font:`${Math.floor(13*i)}px monospace`,color:oe?"#00ff00":"#666666"}),_=k.x+k.width+Math.floor(80*i)}if(C===0){const k=this.passiveManager.getAvailablePoints();xt(e,_,u,`Passive Licenses: ${k}`,{font:`${Math.floor(14*i)}px monospace`,color:"#00ff00"})}C++,u+=g}u+=Math.floor(6*i)}this.contentHeight=u-o;const w=Math.max(0,this.contentHeight-h);this.scrollOffset=Math.min(this.scrollOffset,w),e.restore(),e.save();const A=Math.floor(this.baseScrollSpeed*i),E={x:b,y:o+Math.floor(32*i),width:v,height:M,label:"",onClick:()=>{this.scrollOffset=Math.max(0,this.scrollOffset-A)},style:{font:`${Math.floor(13*i)}px monospace`,backgroundColor:"#001100",borderColor:"#00ff00",textColor:"#00ff00",alpha:1,glow:!0,chromaticAberration:!0}},x={x:b,y:o+h-M-Math.floor(32*i),width:v,height:M,label:"",onClick:()=>{this.scrollOffset=Math.min(this.scrollOffset+A,w)},style:E.style};this.activeButtons.push(E,x),du(e,E),du(e,x);const I=o+M+Math.floor(32*i),D=h-M*2-Math.floor(64*i),N=h/Math.max(this.contentHeight,1),H=Math.max(Math.floor(30*i),N*D),W=I+this.scrollOffset/w*(D-H);e.fillStyle="#00ff00",e.globalAlpha=.3,e.fillRect(b+Math.floor(2*i),W,v-Math.floor(4*i),H),e.restore()}}const L2="assets/hub/backgrounds/scene_passives-menu.png";class O2{constructor(e,i,n){this.backgroundImage=null,this.dialogueQueueManager=null,this.loopSoundStopped=!1,this.update=()=>{var y;const u=performance.now();this.inputManager.updateFrame(),this.crtMonitor.update(u),this.introAnimationController.update(u);const{x:d,y:g}=this.inputManager.getMousePosition(),m=this.inputManager.wasMouseClicked();if(this.introAnimationController.isComplete()){if(this.dialogueQueueManager&&!this.dialogueQueueManager.isRunning()&&!Ee.has("hub.introduction-2.complete")){const v=mn("hub-introduction-2",{inputManager:this.inputManager});v&&this.dialogueQueueManager.startScript(v)}(y=this.dialogueQueueManager)!=null&&y.isRunning()&&(this.dialogueQueueManager.update(this.gameLoop.getDeltaTime()),m&&this.dialogueQueueManager.skipOrAdvance());for(const v of this.buttons)Bs(v,d,g,m,ae());this.inputManager.wasKeyJustPressed("KeyP")&&vt.getInstance().addPassivePoints(1),this.inputManager.wasKeyJustPressed("KeyR")&&vt.getInstance().refundAll(),this.passiveMenuManager.update()}},this.render=()=>{var M;this.canvasManager.clearAll();const u=this.canvasManager.getContext("background"),d=this.canvasManager.getContext("ui"),g=this.canvasManager.getContext("overlay"),{x:m,y}=this.inputManager.getMousePosition();if(this.backgroundImage&&u.drawImage(this.backgroundImage,0,0,u.canvas.width,u.canvas.height),this.crtMonitor.draw(d),!this.introAnimationController.isComplete())this.introAnimationController.draw(g);else{if(this.loopSoundStopped||($.stopLoop("assets/sounds/sfx/ui/typing_00.wav"),this.loopSoundStopped=!0),!((M=this.dialogueQueueManager)!=null&&M.isRunning()))for(const b of this.buttons)ht(d,b,ae());this.dialogueQueueManager&&this.dialogueQueueManager.render(g),this.passiveMenuManager.render(d)}const v=fn();ya(d,v,m,y,ae())},this.canvasManager=e,this.gameLoop=i,this.inputManager=n;const o={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};this.buttons=[{x:20,y:20,width:120,height:50,label:" Back",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.stop(),bt.fadeToScene("hub")},style:o}];const l=Tl({x:275,y:98,width:885,height:542});this.crtMonitor=new I2(l.x,l.y,l.width,l.height,{alpha:.95,borderRadius:60,borderColor:"#00ff33",glowColor:"#00ff33",scanlineSpacing:6,backgroundGradient:{type:"linear",stops:[{offset:0,color:"#000900"},{offset:1,color:"#000000"}]}});const h=Tl({x:285,y:108,width:865,height:522});this.passiveMenuManager=new P2(this.inputManager,vt.getInstance(),h),this.introAnimationController=new _2}async start(){$.startLoop("assets/sounds/sfx/ui/typing_00.wav","sfx",{volume:1,pitch:1,pan:0}),this.backgroundImage=await va(L2),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start(),this.dialogueQueueManager=No.create()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render)}}const Dp=800;class ju{constructor(e,i,n){this.inputManager=i,this.playerShip=n,this.cursorWorldPos={x:0,y:0},this.hasInitializedCursor=!1,this.cursorChangeHandler=o=>this.setCursorFromType(o.type),this.cursorRestoreHandler=()=>this.setDefaultCursor(),this.camera=n?ut.getInstance():null,this.cursorSprite=fn(),this.ctx=e.getContext("overlay"),pe.on("cursor:change",this.cursorChangeHandler),pe.on("cursor:restore",this.cursorRestoreHandler)}render(){if(!this.cursorSprite)return;const e=ae(),i=wt.getInstance().getLastUsed();if(i==="keyboard"||i==="mouse"){const n=this.inputManager.getMousePosition();ya(this.ctx,this.cursorSprite,n.x,n.y,e);return}if(i==="gamepad"){if(!this.playerShip)return;const n=this.inputManager.getGamepadAimVector(),o=n.x!==0||n.y!==0,l=this.playerShip.getTransform(),h=l.position,u=o?n:{x:Math.cos(l.rotation-Math.PI/2),y:Math.sin(l.rotation-Math.PI/2)},d=h.x+u.x*Dp,g=h.y+u.y*Dp;if(this.hasInitializedCursor?(this.cursorWorldPos.x+=(d-this.cursorWorldPos.x)*.25,this.cursorWorldPos.y+=(g-this.cursorWorldPos.y)*.25):(this.cursorWorldPos.x=d,this.cursorWorldPos.y=g,this.hasInitializedCursor=!0),!this.camera)return;const m=this.camera.worldToScreen(this.cursorWorldPos.x,this.cursorWorldPos.y);ya(this.ctx,this.cursorSprite,m.x,m.y,e)}}setCursorFromType(e){switch(e){case"crosshair":this.setCrosshairCursor();break;case"target":this.setTargetCrosshairCursor();break;case"hovered":this.setHoveredCursor();break;case"wrench":this.setWrenchCursor();break;case"up":this.setUpCursor();break;case"right":this.setRightCursor();break;case"down":this.setDownCursor();break;case"left":this.setLeftCursor();break;case"small-circle":this.setSmallCircleCursor();break}}setCursorSprite(e){this.cursorSprite=e}setDefaultCursor(){this.setCursorSprite(fn())}setCrosshairCursor(){this.setCursorSprite(fn())}setTargetCrosshairCursor(){this.setCursorSprite(JS())}setHoveredCursor(){this.setCursorSprite(Hu())}setWrenchCursor(){this.setCursorSprite(a1())}setArrowCursor(e){this.setCursorSprite(n1(e))}setUpCursor(){this.setArrowCursor("up")}setRightCursor(){this.setArrowCursor("right")}setDownCursor(){this.setArrowCursor("down")}setLeftCursor(){this.setArrowCursor("left")}setSmallCircleCursor(){this.setCursorSprite(o1())}destroy(){pe.off("cursor:change",this.cursorChangeHandler),pe.off("cursor:restore",this.cursorRestoreHandler)}}const F2="assets/hub/backgrounds/scene_break-room.png";class U2{constructor(e,i,n){this.backgroundImage=null,this.dialogueQueueManager=null,this.update=()=>{var d;this.inputManager.updateFrame();const{x:l,y:h}=this.inputManager.getMousePosition(),u=this.inputManager.wasMouseClicked();if((d=this.dialogueQueueManager)!=null&&d.isRunning()){this.dialogueQueueManager.update(this.gameLoop.getDeltaTime()),u&&this.dialogueQueueManager.skipOrAdvance();return}Bs(this.buttons[0],l,h,u,ae())},this.render=()=>{var d;this.canvasManager.clearAll();const l=this.canvasManager.getContext("background"),h=this.canvasManager.getContext("ui"),u=this.canvasManager.getContext("overlay");if(this.backgroundImage&&l.drawImage(this.backgroundImage,0,0,l.canvas.width,l.canvas.height),!((d=this.dialogueQueueManager)!=null&&d.isRunning()))for(const g of this.buttons)ht(h,g,ae());this.dialogueQueueManager&&this.dialogueQueueManager.render(u),this.cursorRenderer.render()},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.cursorRenderer=new ju(e,n,null);const o={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:"18px monospace",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};this.buttons=[{x:20,y:20,width:120,height:50,label:" Back",isHovered:!1,onClick:()=>{$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.stop(),bt.fadeToScene("hub")},style:o}]}async start(){this.backgroundImage=await va(F2),this.dialogueQueueManager=No.create();const e=mn("test-script",{});e&&this.dialogueQueueManager.startScript(e),this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render),this.cursorRenderer.destroy()}}function Ne(a,e,i,n,o,l=1){const{font:h="12px monospace",align:u="left",alpha:d=1,shadowBlur:g=0,shadowColor:m="",glow:y=!1,color:v="#00ff00"}=o??{},M=h.replace(/(\d+)(px)/,(b,C,w)=>`${Math.round(parseInt(C)*l)}${w}`);if(a.save(),a.globalAlpha=d,a.font=M,a.textAlign=u,a.textBaseline="top",y?(a.shadowBlur=6*l,a.shadowColor="#00ff00"):g>0&&m&&(a.shadowBlur=g*l,a.shadowColor=m),typeof n=="string")a.fillStyle=v,a.fillText(n,e,i);else{let b=e;for(const C of n)a.fillStyle=C.color??v,a.fillText(C.text,b,i),b+=a.measureText(C.text).width}a.restore()}class Pp{constructor(e,i,n,o,l=.8){this.timer=0,this.triggered=!1,this.text=e,this.x=i,this.y=n,this.options=o,this.duration=l}trigger(){this.timer=0,this.triggered=!0}update(e){this.triggered&&(this.timer+=e)}render(e,i){if(!this.triggered)return;const n=Math.min(this.timer/this.duration,1),o=n*n*(3-2*n),l=o,h=1+(1-o)*.4;e.save(),e.translate(this.x,this.y),e.scale(h,h),Ne(e,0,0,this.text,{...this.options,align:"center",alpha:l},i),e.restore()}hasCompleted(){return this.triggered&&this.timer>=this.duration}}function N2(){const a=Te.get();return{fromWaves:a.wavesCleared*3,fromKills:Math.floor(a.enemiesDestroyed/25),fromBlocks:Math.floor(a.blocksCollected/100),fromCurrency:Math.floor(a.currencyGathered/1e3),fromMass:Math.floor(a.massAchieved/2e3),fromIncidents:a.incidentsCompleted,fromVictory:a.outcome==="victory"?5:0}}let oa=null,he=null;function H2(a,e,i,n,o=1){if(!oa){oa=document.createElement("canvas"),oa.width=64,oa.height=64,he=oa.getContext("2d"),he.clearRect(0,0,64,64),he.save();const l=32,h=32,u=28,d=he.createRadialGradient(l,h,u*.7,l,h,u);d.addColorStop(0,"#00ffff"),d.addColorStop(.8,"#0088ff"),d.addColorStop(1,"#0044aa"),he.strokeStyle=d,he.lineWidth=3,he.shadowColor="#00ffff",he.shadowBlur=8,he.beginPath(),he.arc(l,h,u,0,Math.PI*2),he.stroke();const g=he.createRadialGradient(l,h,0,l,h,u*.6);g.addColorStop(0,"#ffffff"),g.addColorStop(.3,"#00ffff"),g.addColorStop(.7,"#0088ff"),g.addColorStop(1,"#003366"),he.fillStyle=g,he.shadowBlur=12,he.beginPath(),he.arc(l,h,u*.6,0,Math.PI*2),he.fill(),he.strokeStyle="#ffffff",he.lineWidth=1.5,he.shadowBlur=4;for(let M=0;M<6;M++){const b=M*Math.PI/3,C=l+Math.cos(b)*u*.3,w=h+Math.sin(b)*u*.3,A=l+Math.cos(b)*u*.5,E=h+Math.sin(b)*u*.5;he.beginPath(),he.moveTo(C,w),he.lineTo(A,E),he.stroke()}const m=he.createRadialGradient(l,h,0,l,h,6);m.addColorStop(0,"#ffffff"),m.addColorStop(.5,"#00ffff"),m.addColorStop(1,"#0088ff"),he.fillStyle=m,he.shadowColor="#ffffff",he.shadowBlur=6,he.beginPath(),he.arc(l,h,4,0,Math.PI*2),he.fill(),he.strokeStyle="#00ffff",he.lineWidth=2,he.shadowBlur=4;const y=8,v=6;he.beginPath(),he.moveTo(v,v+y),he.lineTo(v,v),he.lineTo(v+y,v),he.stroke(),he.beginPath(),he.moveTo(64-v-y,v),he.lineTo(64-v,v),he.lineTo(64-v,v+y),he.stroke(),he.beginPath(),he.moveTo(64-v,64-v-y),he.lineTo(64-v,64-v),he.lineTo(64-v-y,64-v),he.stroke(),he.beginPath(),he.moveTo(v+y,64-v),he.lineTo(v,64-v),he.lineTo(v,64-v-y),he.stroke(),he.restore()}a.save(),a.globalAlpha=o,a.drawImage(oa,e,i,n,n),a.restore()}class W2{constructor(e,i,n,o,l){this.phase="hidden",this.settleTimer=0,this.cores=[],this.isFloating=!1,this.floatTimer=0,this.settleDuration=.2,this.overshoot=20,this.pulseTimer=0,this.PULSE_DURATION=.5,this.targetX=e,this.y=i,this.width=n,this.height=o,this.x=e+200,this.slideSpeed=l??1200}trigger(){this.phase==="hidden"&&(this.phase="sliding-in")}setFloatingState(){this.isFloating=!0,this.floatTimer=0}update(e){switch(this.phase){case"sliding-in":{const i=this.targetX+this.overshoot,n=Math.sign(i-this.x);this.x+=n*this.slideSpeed*e,(n>0&&this.x>=i||n<0&&this.x<=i)&&(this.x=i,this.phase="settling",this.settleTimer=this.settleDuration);break}case"settling":{this.settleTimer-=e;const i=1-Math.max(0,this.settleTimer/this.settleDuration);this.x=this.targetX+this.overshoot*(1-i),this.settleTimer<=0&&(this.x=this.targetX,this.phase="appeared");break}}this.pulseTimer>0&&(this.pulseTimer-=e,this.pulseTimer<0&&(this.pulseTimer=0)),this.isFloating&&(this.floatTimer+=e)}render(e){if(this.phase==="hidden")return;const i=ae(),n=this.x,o=this.y,l=this.width*i,h=this.height*i;e.save(),e.lineWidth=2*i,e.strokeStyle="#00ff00",e.shadowBlur=6*i,e.shadowColor="#00ff00",e.globalAlpha=1,e.strokeRect(n,o,l,h);const u=`Cores Generated: ${this.cores.length}`,d=this.pulseTimer>0?this.pulseTimer/this.PULSE_DURATION:0,g=this.isFloating?.5+.5*Math.sin(this.floatTimer*3):0,m=6*i*(1+d*2+g);e.font=`${Math.round(18*i*(1+.1*d))}px monospace`,e.fillStyle="#00ff00",e.textAlign="center",e.textBaseline="bottom",e.shadowColor="#00ff00",e.shadowBlur=m;const y=n+l/2,v=o-8*i;e.fillText(u,y,v);const M=16*i,b=12*i,C=32*i,w=4*i,A=l-2*M,E=this.cores.length;if(E>0){let x=C+w;E*C+(E-1)*w>A&&(x=(A-C)/(E-1));const D=C+(E-1)*x,N=n+M+(A-D)/2,H=o+b;for(let W=0;W<E;W++){const K=N+W*x,Z=this.isFloating?4*i*Math.sin(this.floatTimer*2+W*.6):0;H2(e,K,H+Z,C,1)}}e.restore()}addCore(){this.cores.push(this.cores.length),this.pulseTimer=this.PULSE_DURATION}isAppeared(){return this.phase==="appeared"}forceCoreCount(e){this.cores=[];for(let i=0;i<e;i++)this.cores.push(i);this.pulseTimer=0}}class G2{constructor(e,i,n,o){var u;this.phase="hidden",this.settleTimer=0,this.settleDuration=.2,this.overshoot=20,this.isActive=!1,this.originalText=e,this.targetX=i,this.y=n,this.slideSpeed=o??1200;const l=ae();this.x=i-200*l;const h=e.split(":");this.labelPrefix=h[0].trim(),this.displayedValue=parseInt(((u=h[1])==null?void 0:u.trim())??"0")}trigger(){this.phase==="hidden"&&(this.phase="sliding-in")}setActive(e){this.isActive=e}update(e){switch(this.phase){case"sliding-in":{const i=this.targetX+this.overshoot,n=Math.sign(i-this.x);this.x+=n*this.slideSpeed*e,(n>0&&this.x>=i||n<0&&this.x<=i)&&(this.x=i,this.phase="settling",this.settleTimer=this.settleDuration);break}case"settling":{this.settleTimer-=e;const i=1-Math.max(0,this.settleTimer/this.settleDuration);this.x=this.targetX+this.overshoot*(1-i),this.settleTimer<=0&&(this.x=this.targetX,this.phase="appeared");break}}}render(e){if(this.phase==="hidden")return;const i=ae();Ne(e,this.x*i,this.y*i,this.getRenderedText(),{font:`${Math.round(18*i)}px monospace`,color:this.isActive?"#ffffff":"#00ff00",glow:!0,align:"left"})}getRenderedText(){return`${this.labelPrefix}: ${this.displayedValue}`}decrementDynamic(e){return this.displayedValue<=0?!1:(this.displayedValue=Math.max(0,this.displayedValue-e),!0)}isAppeared(){return this.phase==="appeared"}}const Lp=200,Op=50,z2=300,X2=160,V2=28,Fp=520,Y2=60;Te.initialize();Te.get().outcome="victory";Te.incrementBlockCollectedCount(220);Te.incrementWavesCleared(3);Te.incrementKillCount(100);Te.addCurrency(4542);Te.incrementMassAchieved(4040);Te.incrementIncidentsCompleted(2);class q2{constructor(e,i,n){var x;this.state="reveal",this.flyInLabels=[],this.labelRevealTimer=1,this.nextLabelIndex=0,this.summaryBox=null,this.boxTriggered=!1,this.coresToAdd=[],this.tallyIndex=0,this.tallyTimer=0,this.tallyPitchAdd=0,this.totalCores=0,this.coresAdded=0,this.currentDecrement=1,this.decrementAcceleration=1.2,this.missionResult=null,this.initialBlackoutTimer=1.2,this.introDelayTimer=1.2,this.update=()=>{var K;const I=this.gameLoop.getDeltaTime();if(this.initialBlackoutTimer>0){this.initialBlackoutTimer-=I;return}if(this.introDelayTimer>0){this.introDelayTimer-=I,this.introDelayTimer<=0&&(this.headerLabel.trigger(),this.subtitleLabel.trigger());return}const D=ae();this.inputManager.updateFrame();const{x:N,y:H}=this.inputManager.getMousePosition(),W=this.inputManager.wasMouseClicked();Bs(this.buttons[0],N,H,W,D),this.state==="reveal"?this.updateReveal(I):this.state==="tally"&&this.updateTally(I),this.headerLabel.update(I),this.subtitleLabel.update(I);for(const Z of this.flyInLabels)Z.update(I);(K=this.summaryBox)==null||K.update(I)},this.render=()=>{var N;if(this.initialBlackoutTimer>0)return;this.canvasManager.clearAll();const I=this.canvasManager.getContext("ui"),D=ae();if(this.headerLabel.render(I,D),this.subtitleLabel.render(I,D),!!this.hasHeaderFinished()){for(const H of this.flyInLabels)H.render(I);(N=this.summaryBox)==null||N.render(I);for(const H of this.buttons)ht(I,H);this.cursorRenderer.render()}},this.canvasManager=e,this.gameLoop=i,this.inputManager=n,this.cursorRenderer=new ju(e,n,null),this.missionResult=Te.get().outcome;const o=N2(),l=Object.values(o).reduce((I,D)=>I+D,0);yt.getInstance().addMetaCurrency(l),this.missionResult==="victory"?($.play("assets/sounds/sfx/debriefing/debriefing_succeeded_00.wav","sfx"),$.playMusic({file:"assets/sounds/music/track_06_mission4.mp3"})):($.play("assets/sounds/sfx/debriefing/debriefing_failed_00.wav","sfx"),$.playMusic({file:"assets/sounds/music/track_06_mission4.mp3"}));const h=ae(),u=ui(),d=bi(),g={borderRadius:10,alpha:.85,borderColor:"#00ff00",textFont:`${Math.round(18*h)}px monospace`,backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}};this.buttons=[{x:u/2-Lp*h/2,y:d-80*h-Op*h/2,width:Lp*h,height:Op*h,label:"Return to Base",isHovered:!1,onClick:()=>{if($.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:4}),this.state!=="done"){this.skipToDone();return}lS(this.canvasManager.getWebGL2Context("unifiedgl2")),Ai.getInstance().clearWebGL2Layer("unifiedgl2"),this.stop(),bt.fadeToScene("hub")},style:g}];const m="Mission Debriefing",y=((x=this.missionResult)==null?void 0:x.toUpperCase())??"ERROR";this.headerLabel=new Pp(m,u/2,40*h,{align:"center",font:`${Math.round(36)}px monospace`,color:"#00ff00",glow:!0}),this.subtitleLabel=new Pp(y,u/2,80*h,{align:"center",font:`${Math.round(24)}px monospace`,color:this.missionResult==="victory"?"#00ff00":"#ff0000",glow:!0});const v=X2,M=V2,b=z2,C=Te.get(),w=[[`Waves Cleared: ${C.wavesCleared}`,o.fromWaves],[`Enemies Destroyed: ${C.enemiesDestroyed}`,o.fromKills],[`Blocks Collected: ${C.blocksCollected}`,o.fromBlocks],[`Entropium Gathered: ${C.currencyGathered}`,o.fromCurrency],[`Mass Achieved: ${C.massAchieved}`,o.fromMass],[`Incidents Completed: ${C.incidentsCompleted}`,o.fromIncidents]];this.missionResult==="victory"&&w.push(["Victory Bonus: 1000",o.fromVictory]),this.flyInLabels=w.map(([I],D)=>new G2(I,b,v+D*M)),this.coresToAdd=w.map(([I,D])=>D);const A=u/2-Fp*h/2,E=d-220*h;this.summaryBox=new W2(A,E,Fp,Y2)}start(){this.gameLoop.onUpdate(this.update),this.gameLoop.onRender(this.render),this.gameLoop.start()}stop(){this.gameLoop.offUpdate(this.update),this.gameLoop.offRender(this.render),this.cursorRenderer.destroy()}updateReveal(e){var i,n;this.labelRevealTimer-=e,this.labelRevealTimer<=0&&this.nextLabelIndex<this.flyInLabels.length&&($.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:5}),$.play("assets/sounds/sfx/debriefing/debriefing_whoosh_00.wav","sfx",{maxSimultaneous:5}),$.play("assets/sounds/sfx/debriefing/debriefing_whoosh_01.wav","sfx",{maxSimultaneous:5}),this.flyInLabels[this.nextLabelIndex].trigger(),this.nextLabelIndex++,this.labelRevealTimer=1),!this.boxTriggered&&this.nextLabelIndex===this.flyInLabels.length&&this.labelRevealTimer<=0&&((i=this.summaryBox)==null||i.trigger(),this.boxTriggered=!0),this.boxTriggered&&((n=this.summaryBox)!=null&&n.isAppeared())&&(this.beginTally(),this.state="tally")}beginTally(){var e;$.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:10}),this.totalCores=this.coresToAdd.reduce((i,n)=>i+n,0),this.tallyIndex=0,this.tallyTimer=.5,this.currentDecrement=1,this.flyInLabels.forEach(i=>i.setActive(!1)),(e=this.flyInLabels[0])==null||e.setActive(!0)}updateTally(e){var l,h;if(this.tallyIndex>=this.coresToAdd.length){this.state="done",(l=this.summaryBox)==null||l.setFloatingState(),$.play("assets/sounds/sfx/debriefing/debriefing_end_00.wav","sfx",{maxSimultaneous:2});return}if(this.tallyTimer-=e,this.tallyTimer>0)return;const i=this.coresToAdd[this.tallyIndex],n=this.flyInLabels[this.tallyIndex];n==null||n.setActive(!0),(n==null?void 0:n.decrementDynamic(Math.floor(this.currentDecrement)))??!1?($.play("assets/sounds/sfx/debriefing/debriefing_tally_01.wav","sfx",{maxSimultaneous:25,pitch:1+this.tallyPitchAdd}),this.currentDecrement*=this.decrementAcceleration,this.tallyTimer=.05,this.tallyPitchAdd-=.005):i>0?($.play("assets/sounds/sfx/debriefing/debriefing_addcores_00.wav","sfx",{maxSimultaneous:25}),(h=this.summaryBox)==null||h.addCore(),this.coresAdded++,this.coresToAdd[this.tallyIndex]--,this.tallyTimer=.15,this.currentDecrement=1):($.play("assets/sounds/sfx/ui/sub_00.wav","sfx",{maxSimultaneous:10}),n==null||n.setActive(!1),this.tallyIndex++,this.tallyPitchAdd=0,this.tallyIndex<this.flyInLabels.length&&this.flyInLabels[this.tallyIndex].setActive(!0),this.tallyTimer=.5,this.currentDecrement=1)}hasHeaderFinished(){return this.headerLabel.hasCompleted()&&this.subtitleLabel.hasCompleted()}skipToDone(){var i,n;for(const o of this.flyInLabels)o.trigger(),o.setActive(!1);this.summaryBox&&!this.boxTriggered&&(this.summaryBox.trigger(),this.boxTriggered=!0);const e=this.coresToAdd.reduce((o,l)=>o+l,0);(i=this.summaryBox)==null||i.forceCoreCount(e),this.coresAdded=e,this.coresToAdd=this.coresToAdd.map(()=>0),this.state="done",(n=this.summaryBox)==null||n.setFloatingState(),$.play("assets/sounds/sfx/debriefing/debriefing_end_00.wav","sfx",{maxSimultaneous:2})}}class ln{constructor(){this.fadeAlpha=0,this.isFading=!1,this.fadeDuration=500,this.fadeStartTime=0,this.onComplete=null}static getInstance(){return ln.instance||(ln.instance=new ln),ln.instance}startFade(e,i=500){this.isFading||(this.isFading=!0,this.fadeDuration=i,this.fadeAlpha=0,this.fadeStartTime=performance.now(),this.onComplete=e)}update(){if(!this.isFading)return;const i=performance.now()-this.fadeStartTime,n=Math.min(i/this.fadeDuration,1);this.fadeAlpha=n,n>=1&&(this.isFading=!1,this.fadeAlpha=0,this.onComplete&&(this.onComplete(),this.onComplete=null))}render(){if(!this.isFading||this.fadeAlpha<=0)return;const e=Ai.getInstance().getContext("overlay");e&&(e.clearRect(0,0,e.canvas.width,e.canvas.height),e.fillStyle=`rgba(0, 0, 0, ${this.fadeAlpha})`,e.fillRect(0,0,e.canvas.width,e.canvas.height))}isFadeInProgress(){return this.isFading}}class j2{constructor(){this.currentScene=null,this.listeners=new Set,this.canvasManager=null,this.inputManager=null,this.gameLoop=new Pm,this.activeSceneManager=null;const e=ln.getInstance();this.gameLoop.onRender(()=>e.render()),this.gameLoop.onUpdate(()=>e.update())}ensureCanvasManager(){return this.canvasManager||(this.canvasManager=Ai.getInstance()),this.canvasManager}ensureInputManager(){return this.inputManager||(this.canvasManager||(this.canvasManager=this.ensureCanvasManager()),this.inputManager=new Dm(this.canvasManager.getCanvas("ui"))),this.inputManager}destroyTransientManagers(){this.inputManager&&(this.inputManager.destroy(),this.inputManager=null),this.canvasManager=null}setScene(e){if($.stopAllLoops(),this.currentScene!==e){switch(this.currentScene=e,this.activeSceneManager&&(this.activeSceneManager.stop(),this.activeSceneManager=null),e){case"title":{const i=new P1(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"hub":{const i=new h2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"galaxy":{const i=new B2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"passives":{const i=new O2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"breakroom":{const i=new U2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"debriefing":{const i=new q2(this.ensureCanvasManager(),this.gameLoop,this.ensureInputManager());i.start(),this.activeSceneManager=i;break}case"mission":{this.destroyTransientManagers();break}}this.listeners.forEach(i=>i(e))}}getScene(){return this.currentScene??"title"}onSceneChange(e){return this.listeners.add(e),()=>this.listeners.delete(e)}getCanvasManager(){return this.canvasManager}getInputManager(){return this.inputManager}fadeToScene(e){const i=ln.getInstance();i.isFadeInProgress()||i.startFade(()=>this.setScene(e))}}const bt=new j2;function Rl(a=null,e=null,i){const n=ke.getInstance(),o=n.getViewportWidth(),l=n.getViewportHeight(),h=["background-canvas","entity-canvas","fx-canvas","particles-canvas","ui-canvas","overlay-canvas","dialogue-canvas"];for(const d of h){const g=document.getElementById(d);g&&(g.width=o,g.height=l,g.style.width=`${o}px`,g.style.height=`${l}px`)}a&&a.resize(),e&&e.resize(o,l);const u=document.getElementById("canvas-root");if(u){const d=window.innerWidth,g=window.innerHeight,m=d/o,y=g/l,v=Math.min(m,y);u.style.zoom=v.toString(),u.style.width=`${o}px`,u.style.height=`${l}px`,u.style.overflow="hidden"}}class K2{constructor(){this.requests=[]}add(e){this.requests.push(e)}addMany(e){this.requests.push(...e)}getAndClear(){const e=this.requests;return this.requests=[],e}clear(){this.requests=[]}}const Ku=new K2;function jm(a,e,i=1){const{x:n,y:o,size:l,sprite:h,overlaySprite:u,isHovered:d,isSelected:g,isLocked:m}=e,y=4*i,v=l-y;a.fillStyle=g?"#4f4":d?"#888":"#333",a.fillRect(n,o,v,v);const M=32*i*ae(),b=n+(l-M)/2,C=o+(l-M)/2;a.drawImage(h,b,C,M,M),u&&a.drawImage(u,b,C,M,M),m&&(a.fillStyle="rgba(0, 0, 0, 0.6)",a.fillRect(n,o,v,v),a.fillStyle="#ccc",a.font=`bold ${Math.round(12*i)}px sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText("",n+v/2,o+v/2)),g&&(a.strokeStyle="#0f0",a.lineWidth=2*i,a.strokeRect(n+1*i,o+1*i,v-2*i,v-2*i))}function Km(a,e,i=1){const{x:n,y:o,width:l,height:h,label:u,isHovered:d,isActive:g,style:m={}}=e,{borderRadius:y=0,backgroundColor:v,borderColor:M,alpha:b=1,activeColor:C,backgroundGradient:w}=m,A=l*i,E=h*i,x=y;a.save(),a.globalAlpha=b;let I;if(g&&C)I=C;else if(!g&&w){const{type:N,stops:H,from:W=[n,o],to:K=[n+l,o+h],radius:Z=l/2}=w,Q=N==="linear"?a.createLinearGradient(W[0],W[1],K[0],K[1]):a.createRadialGradient(W[0],W[1],0,W[0],W[1],Z*i);for(const Y of H)Q.addColorStop(Y.offset,d?Mi(Y.color,.1):Y.color);I=Q}else I=v??(g?"#4f4":d?"#444":"#222");const D=M??(g?"#0f0":"#888");a.fillStyle=I,a.strokeStyle=D,a.lineWidth=1*i,x>0?(a.beginPath(),a.roundRect(n,o,A,E,x),a.fill(),a.stroke()):(a.fillRect(n,o,A,E),a.strokeRect(n,o,A,E)),a.fillStyle="#fff",a.font=`${Math.round(12*i*ae())}px sans-serif`,a.textAlign="center",a.textBaseline="middle",a.fillText(u,n+A/2,o+E/2),a.restore()}function Zm(a){var i,n;const e=new Map;for(const o of a){const l=((i=o.subcategory)==null?void 0:i.toLowerCase())??((n=o.id.match(/^[a-z]+/))==null?void 0:n[0])??"default";e.has(l)||e.set(l,[]),e.get(l).push(o)}return e}var _e=(a=>(a.PLACE="PLACE",a.REPAIR="REPAIR",a.REPAIR_ALL="REPAIR_ALL",a.SAVE="SAVE",a.LOAD="LOAD",a))(_e||{});function Ci(a){const{type:e,hp:i}=a,n=Math.max(0,e.armor-i);if(n===0)return 0;const o=e.cost/e.armor;return Math.ceil(o*n)}function me(a,e,i,n,o,l="#888",h,u=1){const g=`${Math.round(14*u)}px monospace`,m=16*u;a.font=g;const v=`${n}: ${o}`.split(" "),M=[];let b="";for(const C of v){const w=b?`${b} ${C}`:C;a.measureText(w).width>h&&b?(M.push(b),b=C):b=w}b&&M.push(b);for(const C of M){const w=C.indexOf(":"),A=w!==-1,E=A?C.slice(0,w+1):"",x=A?C.slice(w+1).trim():C;Ne(a,e,i,[...A?[{text:E+" ",color:l}]:[],{text:x,color:"#fff"}],{font:g,align:"left"}),i+=m}return i}function ul(){return ke.getInstance().getInterfaceScale()||2}function gu(a){const e=ui(),i=1920,n=.75,l=n+(Math.min(e,3840)-i)*(1.25-n)/(3840-i);return a*l}const Z2=new Set(["canThrust","canFire"]),Q2=["hull","engine","weapon","utility"];class $2{constructor(e,i){this.repairAllHandler=null,this.activeTab="hull",this.selectedBlockId="hull1",this.activeTool=_e.PLACE,this.hoveredShipBlock=void 0,this.hoveredUtilityTool=null,this.open=!1,this.originalZoom=0,this.PADDING=0,this.TILE_SIZE=0,this.GRID_COLS=6,this.GRID_ROWS=6,this.WINDOW_HEADER_HEIGHT=0,this.BLOCK_INFO_OFFSET=0,this.INFO_WINDOW_HEIGHT=0,this.WINDOW_X=0,this.WINDOW_Y=0,this.WINDOW_WIDTH=0,this.WINDOW_HEIGHT=0,this.BLOCKINFO_WINDOW_WIDTH=0,this.UTILITY_WINDOW_WIDTH=0,this.UTILITY_BUTTON_VERTICAL_MARGIN=0,this.UTILITY_BUTTON_SPACING=0,this.UTILITY_BUTTON_HEIGHT=0,this.TOTAL_MENU_WIDTH=0,this.SLIDE_SPEED=0,this.OVERSHOOT_DISTANCE=0,this.SETTLE_SPEED=0,this.slideX=0,this.isAnimating=!1,this.animationPhase=null,this.targetX=0,this.resize(),this.inputManager=e,this.cursorRenderer=i,this.slideX=-(this.TOTAL_MENU_WIDTH+50)}resize(){const e=Math.max(1,ul()*qS());this.PADDING=16*e,this.TILE_SIZE=40*e,this.WINDOW_HEADER_HEIGHT=28*e,this.BLOCK_INFO_OFFSET=12*e,this.INFO_WINDOW_HEIGHT=200*e,this.WINDOW_X=20*e,this.WINDOW_Y=40*e,this.WINDOW_WIDTH=this.TILE_SIZE*this.GRID_COLS+this.PADDING*2,this.WINDOW_HEIGHT=this.TILE_SIZE*this.GRID_ROWS+60*e,this.BLOCKINFO_WINDOW_WIDTH=this.TILE_SIZE*(this.GRID_COLS-2)+this.PADDING*2,this.UTILITY_WINDOW_WIDTH=this.TILE_SIZE+this.PADDING*2,this.UTILITY_BUTTON_VERTICAL_MARGIN=14*e,this.UTILITY_BUTTON_SPACING=8*e,this.UTILITY_BUTTON_HEIGHT=32*e,this.TOTAL_MENU_WIDTH=this.WINDOW_WIDTH+this.BLOCKINFO_WINDOW_WIDTH+this.UTILITY_WINDOW_WIDTH+this.PADDING,this.SLIDE_SPEED=6*e,this.OVERSHOOT_DISTANCE=30*e,this.SETTLE_SPEED=2*e}render(e){const i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked(),o=this.buildCategoryTabs(),l=Ct({ctx:e,x:this.WINDOW_X+this.slideX,y:this.WINDOW_Y,width:this.WINDOW_WIDTH,height:this.WINDOW_HEIGHT,title:"",tabs:o,mouse:i,clicked:n,options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",activeTabColor:"#66ff66",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),h=Fo(),u=h.filter(v=>v.category===this.activeTab),d=h.find(v=>v.id===this.selectedBlockId)??null,g=this.renderBlockGrid(e,u,i,n,this.WINDOW_X+this.PADDING+this.slideX,this.WINDOW_Y+this.WINDOW_HEADER_HEIGHT,l),m=this.WINDOW_X+this.slideX,y=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET;if(this.hoveredUtilityTool)this.renderToolInfo(e,this.hoveredUtilityTool,m,y,this.BLOCKINFO_WINDOW_WIDTH),this.cursorRenderer.setHoveredCursor();else if(this.activeTool===_e.REPAIR)this.renderRepairInfoForBlock(e,this.hoveredShipBlock,m,y,this.BLOCKINFO_WINDOW_WIDTH),this.cursorRenderer.setWrenchCursor();else{const v=g??d??null;this.renderBlockInfo(e,v,m,y,this.BLOCKINFO_WINDOW_WIDTH),g?this.cursorRenderer.setHoveredCursor():this.activeTool===_e.PLACE&&!this.isPointInBounds(i.x,i.y)?this.cursorRenderer.setSmallCircleCursor():this.cursorRenderer.setDefaultCursor()}this.renderUtilityWindow(e,this.WINDOW_X+this.BLOCKINFO_WINDOW_WIDTH+.5*this.PADDING+this.slideX,this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET,this.UTILITY_WINDOW_WIDTH,this.INFO_WINDOW_HEIGHT,i,n)}buildCategoryTabs(){return Q2.map(e=>({label:e.toUpperCase(),isActive:this.activeTab===e,onClick:()=>{this.activeTab!==e&&(this.activeTab=e)}}))}renderBlockGrid(e,i,n,o,l,h,u){const d=ni.getInstance(),g=Zm(i),m=this.TILE_SIZE;let y=0,v=null;for(const[,M]of g){for(let b=0;b<M.length;b++){const C=M[b],w=b%this.GRID_COLS,A=y,E=l+w*this.TILE_SIZE,x=h+A*m,I=n.x>=E&&n.x<=E+this.TILE_SIZE&&n.y>=x&&n.y<=x+this.TILE_SIZE,D=this.selectedBlockId===C.id,N=d.isUnlocked(C.id),H=Ki(C.id);jm(e,{x:E,y:x,size:this.TILE_SIZE,sprite:H.base,overlaySprite:H.overlay,isHovered:I,isSelected:D,isLocked:!N}),I&&(v=C),I&&o&&!u&&N&&($.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.selectedBlockId=C.id,this.setActiveTool(_e.PLACE),this.setHoveredShipBlock(void 0))}y++}return v}renderBlockInfo(e,i,n,o,l){Ct({ctx:e,x:n,y:o,width:l,height:this.INFO_WINDOW_HEIGHT,title:"Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const h=n+this.PADDING;let u=o+32;const d=l,g=v=>v.charAt(0).toUpperCase()+v.slice(1),m=v=>v===void 0?"":typeof v=="boolean"?v?"Yes":"No":typeof v=="number"||typeof v=="string"?v:String(v);if(!i)return;const y=Math.max(.75,gu(ul()));u=me(e,h,u,"Name",i.name,"#6cf",d,y),u=me(e,h,u,"Armor",m(i.armor),"#09f",d,y),u=me(e,h,u,"Mass",m(i.mass),"#999",d,y),u=me(e,h,u,"Cost",m(i.cost),"#6f6",d,y),i.behavior&&Object.entries(i.behavior).forEach(([v,M])=>{Z2.has(v)||(M&&typeof M=="object"&&!Array.isArray(M)?(u=me(e,h,u,g(v),"","#fc6",d,y),Object.entries(M).forEach(([b,C])=>{const w=` ${g(b)}`;u=me(e,h,u,w,m(C),"#999",d,y)})):u=me(e,h,u,g(v),m(M),"#fc6",d,y))})}renderRepairInfoForBlock(e,i,n,o,l){Ct({ctx:e,x:n,y:o,width:l,height:this.INFO_WINDOW_HEIGHT,title:"Repair Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const h=n+this.PADDING;let u=o+32;const d=l,g=Math.max(.75,gu(ul()));if(!i){u=me(e,h,u,"Hover block","to inspect","#888",d,g),u=me(e,h,u,"Repair","Left-click","#888",d,g);return}const{type:m,hp:y}=i,v=m.armor-y;u=me(e,h,u,"Name",m.name,"#6cf",d,g),u=me(e,h,u,"Armor",`${y} / ${m.armor}`,"#09f",d,g),u=me(e,h,u,"Damage",v>0?v:"None","#f66",d,g),u=me(e,h,u,"Repair Cost",v>0?Ci(i):"","#6f6",d,g)}renderUtilityWindow(e,i,n,o,l,h,u){Ct({ctx:e,x:i,y:n,width:o,height:l,title:"",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const d=this.UTILITY_BUTTON_SPACING,g=this.UTILITY_BUTTON_HEIGHT,m=o-this.PADDING*2,y=i+this.PADDING;let v=n+this.WINDOW_HEADER_HEIGHT+d-this.UTILITY_BUTTON_VERTICAL_MARGIN;this.hoveredUtilityTool=null;const M=[{label:"",tool:_e.REPAIR,action:()=>{$.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.setActiveTool(_e.REPAIR),this.setSelectedBlockId(null)}},{label:"",tool:_e.REPAIR_ALL,action:()=>{var b;$.play("assets/sounds/sfx/ui/click_00.wav","sfx"),(b=this.repairAllHandler)==null||b.call(this)}},{label:"",tool:_e.SAVE,action:()=>{$.play("assets/sounds/sfx/ui/click_00.wav","sfx")}},{label:"",tool:_e.LOAD,action:()=>{$.play("assets/sounds/sfx/ui/click_00.wav","sfx")}}];for(const{label:b,tool:C,action:w}of M){const A=h.x>=y&&h.x<=y+m&&h.y>=v&&h.y<=v+g,E=C!=null&&this.getActiveTool()===C;A&&C&&(this.hoveredUtilityTool=C),Km(e,{x:y,y:v,width:m,height:g,label:b,isHovered:A,isActive:E,style:{alpha:.6,borderRadius:8,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),A&&u&&w(),v+=g+d}}renderToolInfo(e,i,n,o,l){Ct({ctx:e,x:n,y:o,width:l,height:this.INFO_WINDOW_HEIGHT,title:"Tool Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const h=n+this.PADDING;let u=o+32;const d=l-this.PADDING,g=Math.max(.75,gu(ul()));i===_e.REPAIR&&(u=me(e,h,u,"Repair Mode","Individual block repair","#888",d,g),u=me(e,h,u,"Cost","Based on damage","#888",d,g)),i===_e.REPAIR_ALL&&(u=me(e,h,u,"Repair All","Repairs all damaged blocks","#888",d,g),u=me(e,h,u,"Cost","As much as you can afford","#888",d,g),u=me(e,h,u,"Order","Repairs most damaged blocks first","#888",d,g))}update(){ut.getInstance(),this.isAnimating&&(this.animationPhase==="sliding-in"?(this.slideX+=this.SLIDE_SPEED,this.slideX>=this.targetX+this.OVERSHOOT_DISTANCE&&(this.animationPhase="settling")):this.animationPhase==="settling"?(this.slideX-=this.SETTLE_SPEED,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.isAnimating=!1,this.animationPhase=null)):this.animationPhase==="sliding-out"&&(this.slideX-=this.SLIDE_SPEED,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.animationPhase=null,this.isAnimating=!1,this.open=!1,this.cursorRenderer.setDefaultCursor())))}isBlocking(){return!0}getSelectedBlockId(){return this.selectedBlockId}setSelectedBlockId(e){this.selectedBlockId=e}setHoveredShipBlock(e){this.hoveredShipBlock=e}isOpen(){return this.open}openMenu(){this.resize(),$.play("assets/sounds/sfx/ui/activate_01.wav","sfx"),this.open=!0;const e=ut.getInstance();this.originalZoom=e.getZoom(),e.animateZoomTo(this.getMenuTargetZoom()),this.slideX=-(this.TOTAL_MENU_WIDTH+50),this.targetX=0,this.isAnimating=!0,this.animationPhase="sliding-in"}closeMenu(){this.targetX=-(this.TOTAL_MENU_WIDTH+50),this.animationPhase="sliding-out",this.isAnimating=!0,ut.getInstance().animateZoomTo(this.originalZoom)}setActiveTool(e){this.activeTool=e}getActiveTool(){return this.activeTool}isPointInBounds(e,i){const n=this.WINDOW_X+this.WINDOW_WIDTH+this.slideX,o=this.WINDOW_Y+this.WINDOW_HEIGHT,l=this.WINDOW_X+this.BLOCKINFO_WINDOW_WIDTH+this.slideX,h=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET+this.INFO_WINDOW_HEIGHT,u=this.WINDOW_X+this.BLOCKINFO_WINDOW_WIDTH+this.PADDING+this.slideX,d=u+this.UTILITY_WINDOW_WIDTH,g=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET,m=g+this.INFO_WINDOW_HEIGHT,v=e>=this.WINDOW_X+this.slideX&&e<=n&&i>=this.WINDOW_Y-30*ae()&&i<=o,M=e>=this.WINDOW_X+this.slideX&&e<=l&&i>=this.WINDOW_Y+this.WINDOW_HEIGHT+this.BLOCK_INFO_OFFSET&&i<=h,b=e>=u&&e<=d&&i>=g&&i<=m;return v||M||b}setRepairAllHandler(e){this.repairAllHandler=e}getCursorRenderer(){return this.cursorRenderer}getMenuTargetZoom(){return .5*ae()}}const hi=16,qi=40,Zu=6,J2=6,Up=28,Eo=12,ra=200,Xi=20,Vi=40,Np=qi*Zu+hi*2,Js=qi*J2+60,la=qi*(Zu-2)+hi*3,Hp=qi+hi,eM=14,Wp=10,tM=30,iM=4,sM=new Set(["canThrust","canFire"]),nM=["hull","engine","weapon","utility"];class aM{constructor(e,i){this.repairAllHandler=null,this.activeTab="hull",this.selectedBlockId="hull1",this.activeTool=_e.PLACE,this.hoveredShipBlock=void 0,this.hoveredUtilityTool=null,this.open=!1,this.slideX=0,this.isAnimating=!1,this.animationPhase=null,this.targetX=0,this.inputManager=e,this.cursorRenderer=i,this.slideX=-602}render(e){const i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked(),o=this.buildCategoryTabs(),l=Ct({ctx:e,x:Xi+this.slideX,y:Vi,width:Np,height:Js,title:"",tabs:o,mouse:i,clicked:n,options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",activeTabColor:"#66ff66",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),h=Fo(),u=h.filter(v=>v.category===this.activeTab),d=h.find(v=>v.id===this.selectedBlockId)??null,g=this.renderBlockGrid(e,u,i,n,Xi+hi+this.slideX,Vi+Up,l),m=Xi+this.slideX,y=Vi+Js+Eo;if(this.hoveredUtilityTool)this.renderToolInfo(e,this.hoveredUtilityTool,m,y,la),this.cursorRenderer.setHoveredCursor();else if(this.activeTool===_e.REPAIR)this.renderRepairInfoForBlock(e,this.hoveredShipBlock,m,y,la),this.cursorRenderer.setWrenchCursor();else{const v=g??d??null;this.renderBlockInfo(e,v,m,y,la),g?this.cursorRenderer.setHoveredCursor():this.activeTool===_e.PLACE&&!this.isPointInBounds(i.x,i.y)?this.cursorRenderer.setSmallCircleCursor():this.cursorRenderer.setDefaultCursor()}this.renderUtilityWindow(e,Xi+la+hi+this.slideX,Vi+Js+Eo,Hp,ra,i,n)}buildCategoryTabs(){return nM.map(e=>({label:e.toUpperCase(),isActive:this.activeTab===e,onClick:()=>{this.activeTab!==e&&(this.activeTab=e)}}))}renderBlockGrid(e,i,n,o,l,h,u){const d=ni.getInstance(),g=Zm(i),m=qi;let y=0,v=null;for(const[,M]of g){for(let b=0;b<M.length;b++){const C=M[b],w=b%Zu,A=y,E=l+w*qi,x=h+A*m,I=n.x>=E&&n.x<=E+qi&&n.y>=x&&n.y<=x+qi,D=this.selectedBlockId===C.id,N=d.isUnlocked(C.id),H=Ki(C.id);jm(e,{x:E,y:x,size:qi,sprite:H.base,overlaySprite:H.overlay,isHovered:I,isSelected:D,isLocked:!N}),I&&(v=C),I&&o&&!u&&N&&($.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.selectedBlockId=C.id,this.setActiveTool(_e.PLACE),this.setHoveredShipBlock(void 0))}y++}return v}renderBlockInfo(e,i,n,o,l){Ct({ctx:e,x:n,y:o,width:l,height:ra,title:"Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const h=n+hi;let u=o+32;const d=l+10,g=y=>y.charAt(0).toUpperCase()+y.slice(1),m=y=>y===void 0?"":typeof y=="boolean"?y?"Yes":"No":typeof y=="number"||typeof y=="string"?y:String(y);i&&(u=me(e,h,u,"Name",i.name,"#6cf",d),u=me(e,h,u,"Armor",m(i.armor),"#09f",d),u=me(e,h,u,"Mass",m(i.mass),"#999",d),u=me(e,h,u,"Cost",m(i.cost),"#6f6",d),i.behavior&&Object.entries(i.behavior).forEach(([y,v])=>{sM.has(y)||(v&&typeof v=="object"&&!Array.isArray(v)?(u=me(e,h,u,g(y),"","#fc6",d),Object.entries(v).forEach(([M,b])=>{const C=` ${g(M)}`;u=me(e,h,u,C,m(b),"#999",d)})):u=me(e,h,u,g(y),m(v),"#fc6",d))}))}renderRepairInfoForBlock(e,i,n,o,l){Ct({ctx:e,x:n,y:o,width:l,height:ra,title:"Repair Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const h=n+hi;let u=o+32;const d=l+10;if(!i){u=me(e,h,u,"Hover block","to inspect","#888",d),u=me(e,h,u,"Repair","Left-click","#888",d);return}const{type:g,hp:m}=i,y=g.armor-m;u=me(e,h,u,"Name",g.name,"#6cf",d),u=me(e,h,u,"Armor",`${m} / ${g.armor}`,"#09f",d),u=me(e,h,u,"Damage",y>0?y:"None","#f66",d),u=me(e,h,u,"Repair Cost",y>0?Ci(i):"","#6f6",d)}renderUtilityWindow(e,i,n,o,l,h,u){Ct({ctx:e,x:i,y:n,width:o,height:l,title:"",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const d=32,g=8,m=o-hi*2,y=i+hi;let v=n+Up+g-eM;this.hoveredUtilityTool=null;const M=[{label:"",tool:_e.REPAIR,action:()=>{$.play("assets/sounds/sfx/ui/click_00.wav","sfx"),this.setActiveTool(_e.REPAIR),this.setSelectedBlockId(null)}},{label:"",tool:_e.REPAIR_ALL,action:()=>{var b;$.play("assets/sounds/sfx/ui/click_00.wav","sfx"),(b=this.repairAllHandler)==null||b.call(this)}},{label:"",tool:_e.SAVE,action:()=>{$.play("assets/sounds/sfx/ui/click_00.wav","sfx")}},{label:"",tool:_e.LOAD,action:()=>{$.play("assets/sounds/sfx/ui/click_00.wav","sfx")}}];for(const{label:b,tool:C,action:w}of M){const A=h.x>=y&&h.x<=y+m&&h.y>=v&&h.y<=v+d,E=C!=null&&this.getActiveTool()===C;A&&C&&(this.hoveredUtilityTool=C),Km(e,{x:y,y:v,width:m,height:d,label:b,isHovered:A,isActive:E,style:{alpha:.6,borderRadius:8,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),A&&u&&w(),v+=d+g}}renderToolInfo(e,i,n,o,l){Ct({ctx:e,x:n,y:o,width:l,height:ra,title:"Tool Info",options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const h=n+hi;let u=o+32;const d=l+10;i===_e.REPAIR&&(u=me(e,h,u,"Repair Mode","Individual block repair","#888",d),u=me(e,h,u,"Cost","Based on damage","#888",d)),i===_e.REPAIR_ALL&&(u=me(e,h,u,"Repair All","Repairs all damaged blocks","#888",d),u=me(e,h,u,"Cost","As much as you can afford","#888",d),u=me(e,h,u,"Order","Repairs most damaged blocks first","#888",d))}update(){this.isAnimating&&(this.animationPhase==="sliding-in"?(this.slideX+=Wp,this.slideX>=this.targetX+tM&&(this.animationPhase="settling")):this.animationPhase==="settling"?(this.slideX-=iM,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.isAnimating=!1,this.animationPhase=null)):this.animationPhase==="sliding-out"&&(this.slideX-=Wp,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.animationPhase=null,this.isAnimating=!1,this.open=!1,this.cursorRenderer.setDefaultCursor())))}isBlocking(){return!0}getSelectedBlockId(){return this.selectedBlockId}setSelectedBlockId(e){this.selectedBlockId=e}setHoveredShipBlock(e){this.hoveredShipBlock=e}isOpen(){return this.open}openMenu(){$.play("assets/sounds/sfx/ui/activate_01.wav","sfx"),this.open=!0,this.slideX=-602,this.targetX=0,this.isAnimating=!0,this.animationPhase="sliding-in"}closeMenu(){this.targetX=-602,this.animationPhase="sliding-out",this.isAnimating=!0}setActiveTool(e){this.activeTool=e}getActiveTool(){return this.activeTool}isPointInBounds(e,i){const n=Xi+Np+this.slideX,o=Vi+Js,l=Xi+la+this.slideX,h=Vi+Js+Eo+ra,u=Xi+la+hi+this.slideX,d=u+Hp,g=Vi+Js+Eo,m=g+ra,v=e>=Xi+this.slideX&&e<=n&&i>=Vi-30&&i<=o,M=e>=Xi+this.slideX&&e<=l&&i>=Vi+Js+Eo&&i<=h,b=e>=u&&e<=d&&i>=g&&i<=m;return v||M||b}setRepairAllHandler(e){this.repairAllHandler=e}getCursorRenderer(){return this.cursorRenderer}}const Gp=new Map;function Qm(a,e,i=0,n="rgba(100, 255, 255, 0.4)"){const o=`${e}_${i}_${n}`;let l=Gp.get(o);if(!l){const u=Ki(e).base;if(!u)return;const d=document.createElement("canvas");d.width=X,d.height=X;const g=d.getContext("2d");g.fillStyle=n,g.fillRect(0,0,X,X),g.save(),g.translate(X/2,X/2),g.rotate(i*Math.PI/180),g.translate(-32/2,-32/2),g.globalCompositeOperation="destination-in",g.drawImage(u,0,0),g.restore(),g.globalCompositeOperation="source-over",l=d,Gp.set(o,l)}a.drawImage(l,-32/2,-32/2)}function $m(a,e="rgba(0,255,0,0.3)"){a.save(),a.fillStyle=e,a.fillRect(-32/2,-32/2,X,X),a.restore()}function Qu(a,e){a.save(),a.fillStyle=e?"rgba(0,255,0,0.3)":"rgba(255,0,0,0.3)",a.fillRect(-32/2,-32/2,X,X),a.restore()}function Ma(a,e,i,n){const o=e.screenToWorld(a.x,a.y),l=o.x-i.x,h=o.y-i.y,u=Math.cos(-n),d=Math.sin(-n),g=l*u-h*d,m=l*d+h*u;return{x:Math.round(g/X),y:Math.round(m/X)}}function $u(a,e){return[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].some(n=>a.hasBlockAt(n))}class oM{constructor(e,i,n,o,l){this.spaceStation=e,this.menu=i,this.camera=n,this.shipBuilderEffects=o,this.inputManager=l,this.rotation=0,this.lastBlockId=null,this.hasSaved=!1,this.hoveredShipCoord=null}update(e){this.inputManager.wasKeyJustPressed("Space")&&(this.rotation=(this.rotation+90)%360);const i=this.inputManager.getMousePosition();if(this.isCursorOverMenu(i))return;const n=Ma(i,this.camera,e.position,e.rotation);if(this.menu.getActiveTool()===_e.REPAIR){const u=this.spaceStation.getBlock(n);this.menu.setHoveredShipBlock(u),u&&this.inputManager.wasMouseClicked()&&($.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n));return}const o=this.menu.getSelectedBlockId();if(!o||(o!==this.lastBlockId&&(this.rotation=0,this.lastBlockId=o),!Ki(o)))return;const h=Tm(o);if(h!==void 0){if(this.inputManager.wasRightClicked()){const u=this.spaceStation.getBlock(n);if(!u)return;if(!u.type.id.startsWith("cockpit")){this.spaceStation.removeBlock(n),$.play("assets/sounds/sfx/ui/click_00.wav","sfx",{maxSimultaneous:3});const d=Math.round(h/2);Be.getInstance().addCurrency(d)}}this.inputManager.wasMouseClicked()&&(this.spaceStation.placeBlockById(n,o,this.rotation),$.play("assets/sounds/sfx/ship/attach_00.wav","sfx",{maxSimultaneous:3}),Be.getInstance().spendCurrency(h),Te.incrementBlockPlacedCount()),this.inputManager.isLPressed()&&!this.hasSaved&&(this.hasSaved=!0),!this.inputManager.isLPressed()&&this.hasSaved&&(this.hasSaved=!1)}}render(e,i){const n=this.inputManager.getMousePosition();if(this.isCursorOverMenu(n))return;const o=Ma(n,this.camera,i.position,i.rotation),l=o.x*X,h=o.y*X,u=Math.cos(i.rotation),d=Math.sin(i.rotation),g=l*u-h*d,m=l*d+h*u,y=i.position.x+g,v=i.position.y+m,M=this.camera.worldToScreen(y,v);e.save(),e.translate(M.x,M.y),e.scale(this.camera.getZoom(),this.camera.getZoom()),e.rotate(i.rotation);const b=this.menu.getActiveTool();if(b===_e.REPAIR)this.spaceStation.getBlock(o)&&$m(e,"rgba(0,255,0,0.3)");else if(b===_e.PLACE){const C=this.menu.getSelectedBlockId();if(!C){e.restore();return}if(this.spaceStation.getBlock(o)){const A=this.spaceStation.isDeletionSafe(o);Qu(e,A)}else{const A=Ki(C);e.save(),e.rotate(this.rotation*Math.PI/180),e.globalAlpha=.6,e.drawImage(A.base,-32/2,-32/2,X,X),e.restore()}}e.restore()}isCursorOverMenu(e){return this.menu.isPointInBounds(e.x,e.y)}repairBlockAt(e){const i=this.spaceStation.getBlock(e);if(!i||i.type.armor-i.hp<=0)return;const o=Ci(i),l=Be.getInstance();l.hasEnoughCurrency(o)&&(l.spendCurrency(o),i.hp=i.type.armor,this.shipBuilderEffects.createRepairEffect(i.position))}repairAllBlocks(){const e=Be.getInstance(),i=this.spaceStation.getAllBlocks().filter(([,n])=>n.hp<n.type.armor).map(([n,o])=>({coord:n,block:o})).sort((n,o)=>{const l=n.block.type.armor-n.block.hp,h=o.block.type.armor-o.block.hp;if(l!==h)return h-l;const u=Ci(n.block),d=Ci(o.block);return u-d});for(const{coord:n,block:o}of i){const l=Ci(o);if(e.hasEnoughCurrency(l))$.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n);else{console.log("Stopped repair: insufficient funds.");break}}}getHoveredShipBlock(){return this.hoveredShipCoord?this.spaceStation.getBlock(this.hoveredShipCoord):void 0}}class Ri{constructor(e,i){this.getPosition=e,this.behavior=i,this.elapsed=0}update(e){this.elapsed+=e}isExpired(){return this.elapsed>=(this.behavior.duration??2.5)}}class rM extends Ri{constructor(e,i){super(e,i),this.behavior=i}render(e){const i=this.getPosition(),n=ae(),o=this.resolveArrowAngle(),l=(this.behavior.arrowLength??30)*n,h=i.x+l*Math.cos(o),u=i.y+l*Math.sin(o);e.save(),e.strokeStyle=this.behavior.arrowColor??"#ffffff",e.lineWidth=2*n,e.beginPath(),e.moveTo(h,u),e.lineTo(i.x*n,i.y*n),e.stroke(),e.restore()}resolveArrowAngle(){switch(this.behavior.arrowDirection){case"up":return-Math.PI/2;case"down":return Math.PI/2;case"left":return Math.PI;case"right":return 0;default:return 0}}}class lM extends Ri{constructor(e,i){super(e,i),this.behavior=i}render(e){const i=this.getPosition(),n=ae(),o=this.behavior.boxWidth??100,l=this.behavior.boxHeight??40,h=o*n,u=l*n,d={x:i.x*n,y:i.y*n};e.save(),e.strokeStyle=this.behavior.boxStrokeColor??"#ffffff",e.lineWidth=this.behavior.boxLineWidth??2*ae(),e.strokeRect(d.x-h/2,d.y-u/2,h,u),e.restore()}}class cM extends Ri{constructor(e,i){super(e,i),this.behavior=i,this.image=new Image,this.image.src=i.imageSrc}render(e){if(!this.image.complete)return;const i=this.getPosition(),n=ae(),o=(this.behavior.imageWidth??this.image.width)*n,l=(this.behavior.imageHeight??this.image.height)*n;e.drawImage(this.image,i.x-o/2,i.y-l/2,o,l)}}class hM extends Ri{constructor(e,i,n){super(i,n),this.behavior=n,this.label=e}render(e){const i=this.getPosition(),n=ae(),o=(this.behavior.fontSize??14)*n,l=this.behavior.labelOffset??{x:0,y:-30};e.save(),e.font=`${Math.round(o)}px ${this.behavior.fontFamily??"monospace"}`,e.textAlign="center",e.textBaseline="middle",e.fillStyle=this.behavior.textColor??"#FFFFFF",e.fillText(this.label,i.x+l.x,i.y+l.y),e.restore()}}class uM extends Ri{constructor(e,i){super(e,i),this.floatTimer=0,this.behavior=i}update(e){super.update(e),this.floatTimer+=e}render(e){const i=this.getPosition(),n=ae(),o=Math.sin(this.floatTimer*2*Math.PI)*5,l=(this.behavior.width??36)*n,h=(this.behavior.height??36)*n,u=(this.behavior.fontSize??18)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.textColor??"#FFFFFF",y=this.behavior.keyLabel,v=i.x*n,M=(i.y+o)*n;e.save(),e.font=`${Math.round(u)}px monospace`;const b=e.measureText(y).width,C=12*n,A=Math.max(l,b+C*2);e.fillStyle=g,e.strokeStyle=d,e.lineWidth=2*n,e.beginPath(),e.roundRect(v-A/2,M-h/2,A,h,6),e.fill(),e.stroke(),e.fillStyle=m,e.textAlign="center",e.textBaseline="middle",e.fillText(y,v,M),e.restore()}}class fM extends Ri{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),o=i.x*n,l=i.y*n,h=(this.behavior.width??50)*n,u=(this.behavior.height??80)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.highlightColor??"#00FFFF",y=this.behavior.interactionMode,v=.5+.5*Math.sin(this.animationTimer*Math.PI*2),M=y==="wiggle"?Math.sin(this.animationTimer*6)*6:0;e.save(),e.translate(o+M,l),e.lineWidth=2*n,e.beginPath(),e.strokeStyle=d,e.fillStyle=g,e.roundRect(-h/2,-u/2,h,u,12),e.fill(),e.stroke();const b=u*.25,C=h*.4,w=-h*.45,A=h*.05,E=-u/2+b/2+4;e.beginPath(),e.roundRect(w,E-b/2,C,b,4),e.fillStyle=y==="leftClick"?pu(m,v):g,e.fill(),e.strokeStyle=d,e.stroke(),e.beginPath(),e.roundRect(A,E-b/2,C,b,4),e.fillStyle=y==="rightClick"?pu(m,v):g,e.fill(),e.strokeStyle=d,e.stroke();const x=6*n,I=E+b/2+12;e.beginPath(),e.arc(0,I,x,0,Math.PI*2),e.fillStyle=y==="scroll"?pu(m,v):"#888888",e.fill(),e.strokeStyle=d,e.stroke(),e.restore()}}function pu(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),o=parseInt(a.slice(3,5),16),l=parseInt(a.slice(5,7),16);return`rgba(${n}, ${o}, ${l}, ${i.toFixed(2)})`}class dM extends Ri{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),o=i.x*n,l=i.y*n,h=(this.behavior.radius??60)*n,u=(this.behavior.fontSize??16)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.highlightColor??"#00FFFF",y=this.behavior.textColor??"#FFFFFF",v=.5+.5*Math.sin(this.animationTimer*Math.PI*2),M=E=>this.behavior.highlightButton===E?gM(m,v):g;e.save(),e.translate(o,l),e.lineWidth=2*n,e.beginPath(),e.fillStyle=g,e.strokeStyle=d,e.arc(0,0,h,0,Math.PI*2),e.fill(),e.stroke();const b=h*.25,C=h*.5,w={Y:[0,-C],A:[0,C],X:[-C,0],B:[C,0]},A=E=>{const[x,I]=w[E];e.beginPath(),e.fillStyle=M(E),e.strokeStyle=d,e.arc(x,I,b,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle=y,e.font=`${Math.round(u)}px monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(E,x,I)};A("A"),A("B"),A("X"),A("Y"),e.restore()}}function gM(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),o=parseInt(a.slice(3,5),16),l=parseInt(a.slice(5,7),16);return`rgba(${n}, ${o}, ${l}, ${i.toFixed(2)})`}class pM extends Ri{constructor(e,i){super(e,i),this.animationTimer=0,this.pulseMinAlpha=.3,this.pulseMaxAlpha=.7,this.pulseFrequencyHz=.5,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),o=i.x*n,l=i.y*n,h=(this.behavior.radius??50)*n,u=(this.behavior.fontSize??18)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.highlightColor??"#00FFFF",m=this.behavior.textColor??"#FFFFFF",v=.5+.5*Math.sin(this.animationTimer*this.pulseFrequencyHz*Math.PI*2),M=this.pulseMinAlpha+v*(this.pulseMaxAlpha-this.pulseMinAlpha),b=mM(g,M);e.save(),e.translate(o,l),e.lineWidth=2*n,e.beginPath(),e.fillStyle=b,e.strokeStyle=d,e.arc(0,0,h,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle=m,e.font=`${Math.round(u)}px monospace`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.behavior.label,0,0),e.restore()}}function mM(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),o=parseInt(a.slice(3,5),16),l=parseInt(a.slice(5,7),16);return`rgba(${n}, ${o}, ${l}, ${i.toFixed(2)})`}class yM extends Ri{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),o=i.x*n,l=i.y*n,h=(this.behavior.width??120)*n,u=(this.behavior.height??60)*n,d=12*n,g=5*n,m=.5+.5*Math.sin(this.animationTimer*Math.PI*2),y=this.behavior.borderColor??"#FFFFFF",v=this.behavior.fillColor??"#222222",M=this.behavior.highlightColor??"#00FFFF",{highlightStick:b,wiggleStick:C}=this.behavior,w=b==="left"?m:0,A=b==="right"?m:0,E=C==="left"?Math.sin(this.animationTimer*4)*g:0,x=C==="right"?Math.sin(this.animationTimer*4)*g:0;e.save(),e.translate(o,l),e.lineWidth=2*n,e.beginPath(),e.strokeStyle=y,e.fillStyle=v,e.roundRect(-h/2,-u/2,h,u,12),e.fill(),e.stroke();const I=-h*.3+E,D=0;e.beginPath(),e.arc(I,D,d,0,Math.PI*2),e.fillStyle=this.behavior.highlightStick==="left"?zp(M,w):"#444444",e.fill(),e.strokeStyle=y,e.stroke();const N=h*.3+x;e.beginPath(),e.arc(N,D,d,0,Math.PI*2),e.fillStyle=this.behavior.highlightStick==="right"?zp(M,A):"#444444",e.fill(),e.strokeStyle=y,e.stroke(),e.restore()}}function zp(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),o=parseInt(a.slice(3,5),16),l=parseInt(a.slice(5,7),16);return`rgba(${n}, ${o}, ${l}, ${i.toFixed(2)})`}class vM extends Ri{constructor(e,i){super(e,i),this.animationTimer=0,this.behavior=i}update(e){super.update(e),this.animationTimer+=e}render(e){const i=this.getPosition(),n=ae(),o=i.x*n,l=i.y*n,h=(this.behavior.width??160)*n,u=(this.behavior.height??80)*n,d=this.behavior.borderColor??"#FFFFFF",g=this.behavior.fillColor??"#222222",m=this.behavior.highlightColor??"#00FFFF",y=.5+.5*Math.sin(this.animationTimer*Math.PI*2);e.save(),e.translate(o,l),e.lineWidth=2*n,e.beginPath(),e.strokeStyle=d,e.fillStyle=g,e.roundRect(-h/2,-u/2,h,u,12),e.fill(),e.stroke();const v=h*.25,M=u*.25,b=h*.2,C=u*.15;w(e,-h/2-v*.5,-u*.3,v,M,"leftTrigger",m,g,d,this.behavior.highlighted),w(e,h/2-v*.5,-u*.3,v,M,"rightTrigger",m,g,d,this.behavior.highlighted),w(e,-h/2+b*.5,-u/2-C*.5,b,C,"leftBumper",m,g,d,this.behavior.highlighted),w(e,h/2-b*1.5,-u/2-C*.5,b,C,"rightBumper",m,g,d,this.behavior.highlighted),e.restore();function w(A,E,x,I,D,N,H,W,K,Z){A.beginPath(),A.roundRect(E,x,I,D,4),A.fillStyle=Z.includes(N)?bM(H,y):W,A.fill(),A.strokeStyle=K,A.stroke()}}}function bM(a,e){const i=Math.max(0,Math.min(1,e)),n=parseInt(a.slice(1,3),16),o=parseInt(a.slice(3,5),16),l=parseInt(a.slice(5,7),16);return`rgba(${n}, ${o}, ${l}, ${i.toFixed(2)})`}class Ti{constructor(){this.coachMarks=[],this.canvasManager=Ai.getInstance(),this.ctx=this.canvasManager.getContext("overlay")}static getInstance(){return Ti.instance||(Ti.instance=new Ti),Ti.instance}update(e){for(const i of this.coachMarks)i.update(e);this.coachMarks=this.coachMarks.filter(i=>!i.isExpired())}render(){for(const e of this.coachMarks)e.render(this.ctx)}clear(){this.coachMarks.length=0}createScreenCoachMark(e,i,n,o){const l=()=>({x:i,y:n});this.create(e,l,o)}createWorldCoachMark(e,i,n,o,l){const h=()=>o.worldToScreen(i,n);this.create(e,h,l)}create(e,i,n){let o;switch(n.type){case"arrow":o=new rM(i,n);break;case"box":o=new lM(i,n);break;case"image":o=new cM(i,n);break;case"text":o=new hM(e,i,n);break;case"key":o=new uM(i,n);break;case"mouse":o=new fM(i,n);break;case"gamepadFaceButtons":o=new dM(i,n);break;case"gamepadFaceButton":o=new pM(i,n);break;case"gamepadSticks":o=new yM(i,n);break;case"gamepadShoulders":o=new vM(i,n);break;default:throw new Error(`Unhandled coach mark type: ${n.type}`)}this.coachMarks.push(o)}}const SM=12,MM=12,CM=20,TM=20,wM=12,Cs=76,Ts=24;function AM(a,e=200,i=300){if(wt.getInstance().getLastUsed()==="gamepad"){const o={Y:{fillColor:"#f9d600",borderColor:"#a58d00",highlightColor:"#ffff66"},B:{fillColor:"#ff3c28",borderColor:"#99231b",highlightColor:"#ff7a6f"},X:{fillColor:"#3c7fff",borderColor:"#104fa9",highlightColor:"#81aaff"},A:{fillColor:"#00cc00",borderColor:"#006600",highlightColor:"#66ff66"}},l={type:"gamepadFaceButton",radius:SM,fontSize:MM,textColor:"#FFFFFF",duration:1/0};a.createScreenCoachMark("",e-Cs,i-Ts,{...l,label:"Y",...o.Y}),a.createScreenCoachMark("",e+Cs,i-Ts,{...l,label:"B",...o.B}),a.createScreenCoachMark("",e-Cs,i+Ts,{...l,label:"X",...o.X}),a.createScreenCoachMark("",e+Cs,i+Ts,{...l,label:"A",...o.A})}else{const o={type:"key",width:CM,height:TM,fontSize:wM,borderColor:"#00FFFF",fillColor:"#001122",textColor:"#00FFFF",duration:1/0};a.createScreenCoachMark("",e-Cs,i-Ts,{...o,keyLabel:"W"}),a.createScreenCoachMark("",e+Cs,i-Ts,{...o,keyLabel:"D"}),a.createScreenCoachMark("",e-Cs,i+Ts,{...o,keyLabel:"A"}),a.createScreenCoachMark("",e+Cs,i+Ts,{...o,keyLabel:"S"})}}const kM=[["#ffffff","#ffffff","#dddddd"],["#ffffff","#ffffff","#dddddd"],["#66ff66","#33cc33","#99ff99"],["#66ccff","#3399ff","#99ddff"],["#cc88ff","#9933ff","#ddaaff"]],fa=["#ffdd00","#ffaa00","#ff6600","#ff2200","#ffffff"],RM={engine0:["#ffeeb0","#ffc04d","#ffd966"],engine1:["#ffeeb0","#ffc04d","#ffd966"],engine2:["#66ff66","#33cc33","#99ff99"],engine3:["#66ccff","#3399ff","#99ddff"],engine4:["#cc88ff","#9933ff","#ddaaff"]},Xp={turret0:["#ffff88","#ffaa00","#ffcc33"],turret1:["#ff8888","#ff3333","#ffaaaa"],turret2:["#88ff88","#33dd33","#aaffaa"],turret3:["#88ccff","#3399ff","#66ddff"],turret4:["#cc88ff","#9933ff","#ddaaff"]},Vp={laser0:["#00CCFF","#00FFFF","#00faff"],laser1:["#00CCFF","#00FFFF","#00faff"],laser2:["#E6FFED","#76FF03","#33691E"],laser3:["#F3E5F5","#D500F9","#4A148C"]},Jm={shield0:["#88ddff","#44bbff","#00aaff"],shield1:["#88ddff","#44bbff","#00aaff"],shield2:["#aaffaa","#66dd66","#22bb22"],shield3:["#ffbbff","#dd66dd","#cc33cc"]},EM={shield0:"rgba(100, 255, 255, 0.4)",shield1:"rgba(100, 255, 255, 0.4)",shield2:"rgba(91, 255, 91, 0.4)",shield3:"rgba(255, 86, 255, 0.4)"},Bo={explosiveLance0:["#ffcc00","#ff6600","#cc2200"],explosiveLance1:["#ffcc00","#ff6600","#cc2200"],explosiveLance2:["#aaffaa","#66dd66","#228822"],explosiveLance3:["#ccccff","#9999ff","#4444aa"],explosiveLance4:["#ff66cc","#ff3399","#990066"]},Yp={0:"#ffffff",1:"#ffffff",2:"#00aa33",3:"#0033cc",4:"#6600cc",5:"#ffcc00",10:"#ff3366"},ey={0:"#A9A9A9",1:"#A9A9A9",2:"#00aa33",3:"#0033cc",4:"#6600cc",5:"#ffcc00",10:"#ff3366"},BM={currency:"#FFD700",repair:"#FF4444",block:"#CC66FF"};function IM(a){pe.emit("menu:opened",{id:a})}function qp(a){pe.emit("menu:closed",{id:a})}const xM={id:"fighter",name:"Fighter",description:"Sleek fighter with forward hull and symmetric wings",primaryAxis:"vertical",symmetryAxis:"x",shapeScoreMap:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;let o=0;return n<=0&&(o+=20+Math.abs(n)*5),n>0&&n<=3&&(o+=15-n*2),Math.abs(i)>=2&&Math.abs(i)<=5&&n>=-1&&n<=2&&(o+=25),Math.abs(i)>1&&Math.abs(n)<=1&&(o-=15),o},featureZones:{leftWing:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i<=-2&&n>=-1&&n<=3},rightWing:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i>=2&&n>=-1&&n<=3},hull:(a,e)=>{const i=a.x-e.x;return Math.abs(i)<=1},nose:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&n<=-1},engineBay:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&n>=1&&n<=3}},blockBiases:{engine:{preferredZones:["engineBay","hull"],bonusInZone:30,penaltyOutsideZone:20},weapon:{preferredZones:["nose","leftWing","rightWing"],bonusInZone:25,penaltyOutsideZone:15},fin:{preferredZones:["leftWing","rightWing"],bonusInZone:35,penaltyOutsideZone:25,avoidZones:["hull"]},facetplate:{preferredZones:["leftWing","rightWing","nose"],bonusInZone:20,penaltyOutsideZone:10},hull:{preferredZones:["hull"],bonusInZone:15},system:{preferredZones:["hull"],bonusInZone:20,penaltyOutsideZone:15},utility:{preferredZones:["hull"],bonusInZone:15}},minimumStructureRules:[{zone:"leftWing",minCount:3,description:"Left wing needs structure"},{zone:"rightWing",minCount:3,description:"Right wing needs structure"},{zone:"engineBay",minCount:1,description:"Need rear propulsion"}],weights:{shapeScore:1,symmetryScore:.8,zoneAffinityScore:1.2,structuralGoalScore:1.5}},_M={id:"carrier",name:"Carrier",description:"Broad carrier with wide deck and central command",primaryAxis:"horizontal",symmetryAxis:"y",shapeScoreMap:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;let o=0;return Math.abs(i)<=6&&(o+=25-Math.abs(i)*2),Math.abs(n)<=2&&(o+=30),Math.abs(n)>3&&(o-=Math.abs(n)*8),o},featureZones:{centralHull:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=2&&Math.abs(n)<=1},deck:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=6&&Math.abs(n)<=2},leftFlank:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i<=-3&&Math.abs(n)<=2},rightFlank:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return i>=3&&Math.abs(n)<=2},superstructure:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&n<=-1}},blockBiases:{weapon:{preferredZones:["deck","leftFlank","rightFlank","superstructure"],bonusInZone:25,penaltyOutsideZone:10},engine:{preferredZones:["centralHull"],bonusInZone:30,penaltyOutsideZone:25},system:{preferredZones:["centralHull","superstructure"],bonusInZone:20,penaltyOutsideZone:15},utility:{preferredZones:["centralHull","deck"],bonusInZone:15},hull:{preferredZones:["deck"],bonusInZone:10},facetplate:{preferredZones:["leftFlank","rightFlank"],bonusInZone:20}},minimumStructureRules:[{zone:"deck",minCount:8,description:"Need substantial deck area"},{zone:"centralHull",minCount:4,description:"Need central structure"}],weights:{shapeScore:1.2,symmetryScore:1,zoneAffinityScore:1.1,structuralGoalScore:1.3}},DM={id:"interceptor",name:"Interceptor",description:"Compact, fast interceptor with minimal profile",primaryAxis:"vertical",symmetryAxis:"x",shapeScoreMap:(a,e)=>{const i=a.x-e.x,n=a.y-e.y,o=Math.sqrt(i*i+n*n);let l=0;return o<=3?l+=35-o*8:l-=o*15,n<=0&&(l+=5),Math.abs(i)<=1&&(l+=15),l},featureZones:{core:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)<=1&&Math.abs(n)<=2},wingtips:(a,e)=>{const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)===2&&Math.abs(n)<=1}},blockBiases:{engine:{preferredZones:["core"],bonusInZone:35,penaltyOutsideZone:30},weapon:{preferredZones:["core","wingtips"],bonusInZone:25,penaltyOutsideZone:20},fin:{preferredZones:["wingtips"],bonusInZone:30,penaltyOutsideZone:25}},minimumStructureRules:[{zone:"core",minCount:5,maxCount:12,description:"Compact core design"}],weights:{shapeScore:1.5,symmetryScore:.6,zoneAffinityScore:1.3,structuralGoalScore:1.4}},PM={fighter:xM,carrier:_M,interceptor:DM};function jp(a){return PM[a]||null}function Kp(a,e,i,n){return i.some(o=>{const l=n.featureZones[o];return l&&l(a,e)})}function LM(a,e,i){const n=[];for(const[o,l]of Object.entries(i.featureZones))l(a,e)&&n.push(o);return n}function OM(a,e,i,n){if(!i||i==="none")return 0;let o=0;if(i==="x"||i==="both"){const l={x:e.x-(a.x-e.x),y:a.y};n.hasBlockAt(l)?o+=15:o-=5}if(i==="y"||i==="both"){const l={x:a.x,y:e.y-(a.y-e.y)};n.hasBlockAt(l)?o+=15:o-=5}return o}function FM(a,e,i,n){return a.name.toLowerCase().includes("facetplate")?iy(e,i,n):a.name.toLowerCase().includes("fin")?ty(e,i,n):!0}function UM(a,e){const i=[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}];let n=!1;for(const o of i){const l={x:a.x+o.x,y:a.y+o.y},h=e.getBlock(l);if(h){const u=h.type.name.toLowerCase();if(!u.includes("fin")&&!u.includes("facetplate")){n=!0;break}}}return n}function ty(a,e,i){let n;switch(e){case 0:n=[{x:a.x+1,y:a.y},{x:a.x,y:a.y+1}];break;case 90:n=[{x:a.x-1,y:a.y},{x:a.x,y:a.y+1}];break;case 180:n=[{x:a.x-1,y:a.y},{x:a.x,y:a.y-1}];break;case 270:n=[{x:a.x+1,y:a.y},{x:a.x,y:a.y-1}];break;default:return!1}for(const o of n){const l=i.getBlock(o);if(l){const h=l.type.name.toLowerCase();if(!h.includes("facetplate")&&!h.includes("fin"))return!0}}return!1}function iy(a,e,i){let n;switch(e){case 0:n={x:a.x,y:a.y+1};break;case 90:n={x:a.x-1,y:a.y};break;case 180:n={x:a.x,y:a.y-1};break;case 270:n={x:a.x+1,y:a.y};break;default:return!1}const o=i.getBlock(n);if(!o)return!1;const l=o.type.name.toLowerCase();return!l.includes("facetplate")&&!l.includes("fin")}function NM(a,e,i){return a.name.toLowerCase().includes("fin")?e.x<i.x?0:90:a.name.toLowerCase().includes("facetplate")?HM(e,i):(a.category==="weapon"||a.category==="engine",0)}function HM(a,e){const i=a.x-e.x,n=a.y-e.y;return Math.abs(i)>=Math.abs(n)?i>0?90:i<0?270:0:n>0?180:0}function WM(a,e,i){const n=a.y-e.y;return n>0?30+n*5:n===0?10:-20}function GM(a,e,i){const n=a.y-e.y,o=Math.abs(a.x-e.x);return n<0?25:n===0&&o>0?20:n>0?5:0}function zM(a,e,i){return Hl(a,i)*8}function XM(a,e,i){return Math.abs(a.x-e.x)+Math.abs(a.y-e.y)===1?15:5}function VM(a,e,i){const n=a.x<e.x,o=a.x>e.x;let l=10;if(n){const h={x:a.x-1,y:a.y};i.hasBlockAt(h)||(l+=25)}else if(o){const h={x:a.x+1,y:a.y};i.hasBlockAt(h)||(l+=25)}return l}function YM(a,e,i){const n=a.x<e.x,o=a.x>e.x;return n&&i===0||o&&i===90?20:n&&i===90||o&&i===0?-5:0}function qM(a,e,i,n){let o=5;const l=Hl(a,i);l===1?o+=50:l===2?o+=25:l===3?o-=15:o-=30;const h=jM(a,e,n);o+=h;const d=[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].filter(m=>{const y={x:a.x+m.x,y:a.y+m.y};return!i.hasBlockAt(y)}).length;return o+=d*15,Math.abs(a.x-e.x)+Math.abs(a.y-e.y)>=2&&(o+=20),o}function jM(a,e,i){const n=a.x-e.x,o=a.y-e.y;let l;return Math.abs(n)>=Math.abs(o)?l=n>0?90:n<0?270:0:l=o>0?180:0,i===l?30:-10}function KM(a,e){return Hl(a,e)*5}function Hl(a,e){return[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].reduce((n,o)=>{const l={x:a.x+o.x,y:a.y+o.y};return e.hasBlockAt(l)?n+1:n},0)}function ZM(a,e,i){const n=QM(a,e,i);return n>3?-10*(n-3):Hl(a,i)>=2?10:0}function QM(a,e,i){const n=[{coord:e,distance:0}],o=new Set;o.add(`${e.x},${e.y}`);const l=[{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}];for(;n.length>0;){const h=n.shift();if(h.coord.x===a.x&&h.coord.y===a.y)return h.distance;for(const u of l){const d={x:h.coord.x+u.x,y:h.coord.y+u.y},g=`${d.x},${d.y}`;!o.has(g)&&(i.hasBlockAt(d)||d.x===a.x&&d.y===a.y)&&(o.add(g),n.push({coord:d,distance:h.distance+1}))}}return 999}function mu(a,e,i,n,o=0,l){let h=0;const u=Math.sqrt(Math.pow(e.x-i.x,2)+Math.pow(e.y-i.y,2)),d=l?.5:1;switch(h+=Math.max(0,50-u*3)*d,a.category){case"engine":h+=WM(e,i);break;case"weapon":h+=GM(e,i);break;case"hull":h+=zM(e,i,n);break;case"system":case"utility":h+=XM(e,i);break}if(a.name.toLowerCase().includes("fin")&&(h+=VM(e,i,n),h+=YM(e,i,o)),a.name.toLowerCase().includes("facetplate")&&(h+=qM(e,i,n,o)),h+=KM(e,n),h+=ZM(e,i,n),l){const g=l.weights||{},m=l.shapeScoreMap(e,i);h+=m*(g.shapeScore??1);const y=OM(e,i,l.symmetryAxis,n);h+=y*(g.symmetryScore??1);const v=$M(a,e,i,l);h+=v*(g.zoneAffinityScore??1);const M=JM(e,i,n,l);h+=M*(g.structuralGoalScore??1)}return h}function $M(a,e,i,n){const o=n.blockBiases;if(!o)return 0;let l=o[a.name.toLowerCase()];if(!l&&a.category&&(l=o[a.category.toLowerCase()]),l||(a.name.toLowerCase().includes("fin")?l=o.fin:a.name.toLowerCase().includes("facetplate")&&(l=o.facetplate)),!l)return 0;let h=0;return l.preferredZones&&l.preferredZones.length>0&&(Kp(e,i,l.preferredZones,n)?h+=l.bonusInZone??20:h-=l.penaltyOutsideZone??10),l.avoidZones&&l.avoidZones.length>0&&Kp(e,i,l.avoidZones,n)&&(h-=25),h}function JM(a,e,i,n){if(!n.minimumStructureRules)return 0;let o=0;for(const l of n.minimumStructureRules){const h=n.featureZones[l.zone];if(!h)continue;let u=0;const d=i.getAllBlocks();for(const[g,m]of d)h(g,e)&&u++;if(h(a,e))if(u<l.minCount){const g=l.minCount-u;o+=30+g*10}else l.maxCount&&u>=l.maxCount&&(o-=20)}return o}function eC(a,e,i){const n=a.getCockpitCoord();if(!n)return null;const o=[],l=20;for(let h=-20;h<=l;h++)for(let u=-20;u<=l;u++){const d={x:h,y:u};if(!a.hasBlockAt(d)&&$u(a,d)&&UM(d,a))if(e.name.toLowerCase().includes("facetplate"))for(const g of[0,90,180,270]){if(!iy(d,g,a))continue;const m=mu(e,d,n,a,g,i);o.push({coord:d,rotation:g,score:m})}else if(e.name.toLowerCase().includes("fin"))for(const g of[0,90,180,270]){if(!ty(d,g,a))continue;const m=mu(e,d,n,a,g,i);o.push({coord:d,rotation:g,score:m})}else{const g=i?tC(e,d,n,i):NM(e,d,n);if(!FM(e,d,g,a))continue;const m=mu(e,d,n,a,g,i);o.push({coord:d,rotation:g,score:m})}}return o.length>0?o.reduce((h,u)=>u.score>h.score?u:h):null}function tC(a,e,i,n){return a.category==="weapon"||a.category==="engine"||LM(e,i,n),0}function Zp(a,e,i,n){if(!e)return!1;const o=eC(a,e,n);if(!o||!a.placeBlockById(o.coord,e.id,o.rotation))return!1;const h=a.getBlock(o.coord);h!=null&&h.position&&i.createRepairEffect(h.position);const u=e.placementSound??"assets/sounds/sfx/ship/gather_00.wav";return $.play(u,"sfx",{maxSimultaneous:3}),!0}class ml{constructor(e,i=1,n=2){this.blockType=e,this.baseSpinSpeed=i,this.overlaySpinSpeed=n,this.baseAngle=0,this.overlayAngle=0,this.size=X}update(e){this.baseAngle+=this.baseSpinSpeed*e,this.overlayAngle+=this.overlaySpinSpeed*e,this.baseAngle>Math.PI*2&&(this.baseAngle-=Math.PI*2),this.overlayAngle>Math.PI*2&&(this.overlayAngle-=Math.PI*2)}render(e,i,n,o,l,h=1,u=null){const d=u??this.blockType,g=Ki(d.id),m=i+o/2,y=n+l/2;e.save(),e.translate(m,y),e.globalAlpha*=h,e.rotate(this.baseAngle),e.drawImage(g.base,-o/2,-l/2,o,l),e.restore(),g.overlay&&(e.save(),e.translate(m,y),e.globalAlpha*=h,e.rotate(this.overlayAngle),e.drawImage(g.overlay,-o/2,-l/2,o,l),e.restore())}}const iC=new Set(["type","icon","sprite","id","size","canFire","canThrust"]),sC=new Set(["fire.fireType","fire.detonationDelayMs","fire.lifetime","fire.projectileSpeed","haloBladeProperties.color","haloBladeProperties.size","haloBladeProperties.sprite"]);function Qp(a){return sC.has(a)}function nC(a,e,i,n,o,l){if(!e)return n;const h=g=>g.charAt(0).toUpperCase()+g.slice(1),u=g=>g===void 0?"":typeof g=="boolean"?g?"Yes":"No":typeof g=="number"||typeof g=="string"?g:String(g);let d=n;if(d=me(a,i,d,"Armor",u(e.armor),"#09f",o,l),d=me(a,i,d,"Mass",u(e.mass),"#999",o,l),d=me(a,i,d,"Cost",u(e.cost),"#6f6",o,l),e.behavior){for(const[g,m]of Object.entries(e.behavior))if(!iC.has(g))if(m&&typeof m=="object"&&!Array.isArray(m)){let y=!1;for(const[v,M]of Object.entries(m)){const b=`${g}.${v}`;if(Qp(b))continue;y||(d=me(a,i,d,h(g),"","#fc6",o,l),y=!0);const C=` ${h(v)}`;d=me(a,i,d,C,u(M),"#999",o,l)}}else{if(Qp(g))continue;d=me(a,i,d,h(g),u(m),"#fc6",o,l)}}return d}class aC{constructor(e,i,n,o,l){this.ship=e,this.inputManager=i,this.open=!1,this.queue=[],this.currentBlockType=null,this.blockPreviewRenderer=null,this.nextBlockPreviewRenderer=null,this.isAutoPlacingAll=!1,this.animationPhase=null,this.slideX=-800,this.targetX=0,this.isAnimating=!1,this.originalZoom=0,this.hoveredButton=null,this.clickedButton=null,this.didAdvance=!1,this.SLIDE_SPEED=1280,this.SETTLE_SPEED=320,this.OVERSHOOT_DISTANCE=40,this.preOpenTimer=0,this.PRE_OPEN_DURATION=300,this.LABEL_FONT_SIZE=14,this.BASE_WINDOW_X=20,this.BASE_WINDOW_Y=20,this.BASE_WINDOW_WIDTH=330,this.BASE_WINDOW_HEIGHT=500,this.BASE_BUTTON_WIDTH=120,this.BASE_BUTTON_HEIGHT=40,this.BASE_BUTTON_VERTICAL_GAP=10,this.BASE_BLOCK_PREVIEW_HEIGHT=82,this.BASE_BLOCK_PREVIEW_WIDTH=82,this.BASE_BLOCK_SPIN_SPEED=1,this.BASE_MINI_PREVIEW_HEIGHT=32,this.BASE_MINI_PREVIEW_WIDTH=32,this.coachMarksVisible=!1,this.COACHMARK_BASE_X=122,this.COACHMARK_BASE_Y=452,this.refineButton={},this.autoplaceButton={},this.randomRollButton={},this.autoPlaceAllButton={},this.shipBuilderEffects=n,this.pause=o,this.resume=l,this.initialize()}initialize(){const e=ae(),i=32*e,n=this.BASE_BUTTON_WIDTH*2+i,o=this.BASE_WINDOW_X+(this.BASE_WINDOW_WIDTH-n)/2,l=this.BASE_WINDOW_Y+this.BASE_WINDOW_HEIGHT-(this.BASE_BUTTON_HEIGHT+32)*e;this.refineButton={x:o+this.slideX*e,y:l,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Refine",onClick:()=>this.handleRefine(),style:{borderRadius:8,alpha:.9,borderColor:"#ffcc00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#332800"},{offset:1,color:"#1f1800"}]},textColor:"#ffffaa"}},this.randomRollButton={x:o+this.slideX*e,y:l-this.BASE_BUTTON_VERTICAL_GAP*e,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Reroll",onClick:()=>this.handleRoll(),style:{borderRadius:8,alpha:.95,borderColor:"#cc66ff",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#330033"},{offset:1,color:"#1a0022"}]},textColor:"#ffccff"}},this.autoplaceButton={x:o+this.BASE_BUTTON_WIDTH+i+this.slideX*e,y:l,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Attach",onClick:()=>this.handleAutoplace(),style:{borderRadius:8,alpha:.95,borderColor:"#00ccff",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#003344"},{offset:1,color:"#001a22"}]},textColor:"#aaffff"}},this.autoPlaceAllButton={x:o+this.BASE_BUTTON_WIDTH+i+this.slideX*e,y:l-this.BASE_BUTTON_VERTICAL_GAP*e,width:this.BASE_BUTTON_WIDTH,height:this.BASE_BUTTON_HEIGHT,label:"Attach All",onClick:()=>this.autoPlaceAll(),style:{borderRadius:8,alpha:.95,borderColor:"#66ff66",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#003300"},{offset:1,color:"#001a00"}]},textColor:"#ccffcc"}}}openMenu(){if(!this.queue.length){$.play("assets/sounds/sfx/ui/error_00.wav","sfx");return}this.open||this.animationPhase!==null||($.play("assets/sounds/sfx/ui/activate_01.wav","sfx"),this.slideX=-this.BASE_WINDOW_WIDTH-320,this.animationPhase="pre-open",this.preOpenTimer=this.PRE_OPEN_DURATION,this.open=!0,IM("blockDropDecisionMenu"))}enqueueBlock(e){this.queue.push({blockType:e}),Be.getInstance().enqueueBlock(e),this.updateNextBlockPreview()}updateNextBlockPreview(){var i;const e=this.queue.length>0?(i=this.queue[0])==null?void 0:i.blockType:null;this.nextBlockPreviewRenderer=e?new ml(e,0,0):null}update(e){var d,g;if(!this.open)return;const i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked(),o=ae();if((d=this.blockPreviewRenderer)==null||d.update(e),(g=this.nextBlockPreviewRenderer)==null||g.update(e),this.animationPhase==="pre-open"){this.preOpenTimer-=e*1e3,this.preOpenTimer<=0&&this.beginSlideIn();return}if(this.isAnimating){if(this.animationPhase==="sliding-in")this.pause(),ut.getInstance().animateZoomTo(this.getMenuTargetZoom()),this.slideX+=this.SLIDE_SPEED*e,this.slideX>=this.targetX+this.OVERSHOOT_DISTANCE&&(this.animationPhase="settling",this.slideX=this.targetX+this.OVERSHOOT_DISTANCE);else if(this.animationPhase==="settling")this.slideX-=this.SETTLE_SPEED*e,this.slideX<=this.targetX&&(this.slideX=this.targetX,this.animationPhase="open",this.isAnimating=!1,AM(Ti.getInstance(),this.COACHMARK_BASE_X,this.COACHMARK_BASE_Y),this.coachMarksVisible=!0);else if(this.animationPhase==="sliding-out"&&(this.slideX-=this.SLIDE_SPEED*e,this.slideX<=-this.BASE_WINDOW_WIDTH-200)){const D=this.ship.getTotalMass();Te.incrementMassAchieved(D),this.slideX=-this.BASE_WINDOW_WIDTH-320,this.animationPhase=null,this.isAnimating=!1,this.open=!1,this.currentBlockType=null,this.blockPreviewRenderer=null,this.nextBlockPreviewRenderer=null,this.hoveredButton=null,this.clickedButton=null,this.didAdvance=!1,this.resume()}const m=this.slideX*o,y=this.BASE_WINDOW_X*o,v=this.BASE_WINDOW_Y*o,M=this.BASE_WINDOW_WIDTH*o,b=this.BASE_WINDOW_HEIGHT*o,C=this.BASE_BUTTON_WIDTH*o,w=this.BASE_BUTTON_HEIGHT*o,A=32*o,E=C*2+A,x=y+m+(M-E)/2,I=v+b-(w+32);this.refineButton.x=x,this.refineButton.y=I,this.autoplaceButton.x=x+C+A,this.autoplaceButton.y=I,this.autoPlaceAllButton.x=x+C+A,this.autoPlaceAllButton.y=I-w-this.BASE_BUTTON_VERTICAL_GAP*o,this.randomRollButton.x=x,this.randomRollButton.y=I-w-this.BASE_BUTTON_VERTICAL_GAP*o;return}if(!i)return;const{x:l,y:h}=i;if(this.isAutoPlacingAll)return;this.hoveredButton=null,this.clickedButton=null,this.didAdvance=!1;const u=[[this.refineButton,"refine",()=>{this.clickedButton="refine"}],[this.autoplaceButton,"autoplace",()=>{this.clickedButton="autoplace"}],[this.randomRollButton,"roll",()=>{this.clickedButton="roll"}],[this.autoPlaceAllButton,"autoPlaceAll",()=>{this.clickedButton="autoPlaceAll"}]];for(const[m,y,v]of u){const M=Bs(m,l,h,n,o);m.isHovered&&(this.hoveredButton=y),M&&v()}(this.inputManager.wasActionJustPressed("switchFiringMode")||this.inputManager.wasKeyJustPressed("KeyA"))&&(this.refineButton.onClick(),this.clickedButton="refine"),(this.inputManager.wasActionJustPressed("select")||this.inputManager.wasKeyJustPressed("KeyS"))&&(this.autoplaceButton.onClick(),this.clickedButton="autoplace"),(this.inputManager.wasActionJustPressed("openShipBuilder")||this.inputManager.wasKeyJustPressed("KeyW"))&&(this.randomRollButton.onClick(),this.clickedButton="roll"),(this.inputManager.wasActionJustPressed("cancel")||this.inputManager.wasKeyJustPressed("KeyD"))&&(this.autoPlaceAllButton.onClick(),this.clickedButton="autoPlaceAll")}beginSlideIn(){var i;this.initialize(),this.open=!0,this.targetX=0,this.isAnimating=!0,this.animationPhase="sliding-in";const e=ut.getInstance();this.originalZoom=e.getZoom(),this.currentBlockType=((i=this.queue.shift())==null?void 0:i.blockType)??null,this.blockPreviewRenderer=this.currentBlockType?new ml(this.currentBlockType):null,this.updateNextBlockPreview()}disableButton(e){e.disabled=!0}restoreButtons(){this.isAutoPlacingAll=!1,this.refineButton.disabled=!1,this.autoplaceButton.disabled=!1,this.randomRollButton.disabled=!1,this.autoPlaceAllButton.disabled=!1,this.refineButton.onClick=()=>this.handleRefine(),this.autoplaceButton.onClick=()=>this.handleAutoplace(),this.randomRollButton.onClick=()=>this.handleRoll(),this.autoPlaceAllButton.onClick=()=>this.autoPlaceAll()}handleRefine(){var e;Be.getInstance().addCurrency(((e=this.currentBlockType)==null?void 0:e.cost)??0),Be.getInstance().dequeueBlock(),$.play("assets/sounds/sfx/ui/coin_00.wav","sfx",{maxSimultaneous:4}),Te.incrementBlockRefinedCount(),this.advanceQueueOrClose(),this.clickedButton="refine"}handleAutoplace(){if(!this.currentBlockType)return;const e=jp("interceptor");if(!Zp(this.ship,this.currentBlockType,this.shipBuilderEffects,e??void 0)){$.play("assets/sounds/sfx/ui/error_00.wav","sfx");return}Be.getInstance().dequeueBlock(),Te.incrementBlockPlacedCount(),this.advanceQueueOrClose(),this.clickedButton="autoplace"}async autoPlaceAll(){if(this.isAutoPlacingAll)return;this.isAutoPlacingAll=!0,this.refineButton.onClick=()=>{},this.autoplaceButton.onClick=()=>{},this.randomRollButton.onClick=()=>{},this.autoPlaceAllButton.onClick=()=>{},this.disableButton(this.refineButton),this.disableButton(this.autoplaceButton),this.disableButton(this.randomRollButton),this.disableButton(this.autoPlaceAllButton);const e=jp("interceptor"),i=300,n=10,o=.9;let l=i;for(;this.currentBlockType&&this.queue.length>=0;){if(!Zp(this.ship,this.currentBlockType,this.shipBuilderEffects,e??void 0)){$.play("assets/sounds/sfx/ui/error_00.wav","sfx"),this.restoreButtons();return}if(Be.getInstance().dequeueBlock(),Te.incrementBlockPlacedCount(),this.advanceQueueOrClose(),!this.currentBlockType)break;await new Promise(u=>setTimeout(u,l)),l=Math.max(l*o,n)}this.currentBlockType&&this.restoreButtons(),this.clickedButton="autoPlaceAll"}handleRoll(){if(this.queue.length+1<3||!this.currentBlockType){$.play("assets/sounds/sfx/ui/error_00.wav","sfx");return}const e=[this.currentBlockType,...this.queue.slice(0,2).map(m=>m.blockType)],i=Math.floor(e.reduce((m,y)=>m+Jg(y),0)/e.length);let n=i;const o=Math.random();o<.02?n=Math.min(i+2,4):o<.15&&(n=Math.min(i+1,4));const l=n-i,h=jb(n);if(!h.length){console.warn(`[handleRoll] No blocks found for tier ${n}`);return}const u=h[Math.floor(Math.random()*h.length)];Be.getInstance().dequeueBlock();for(let m=0;m<2;m++)this.queue.length>0&&(this.queue.shift(),Be.getInstance().dequeueBlock());this.queue.unshift({blockType:u}),Be.getInstance().enqueueBlockToFront(u);const d={0:"assets/sounds/sfx/ui/gamblewin_00.wav",1:"assets/sounds/sfx/ui/gamblewin_01.wav",2:"assets/sounds/sfx/ui/gamblewin_02.wav"},g=d[l]??d[0];$.play(g,"sfx",{maxSimultaneous:5}),this.advanceQueueOrClose(),this.clickedButton="roll"}advanceQueueOrClose(){var e;this.currentBlockType=((e=this.queue.shift())==null?void 0:e.blockType)??null,this.blockPreviewRenderer=this.currentBlockType?new ml(this.currentBlockType,this.BASE_BLOCK_SPIN_SPEED,this.BASE_BLOCK_SPIN_SPEED*2):null,this.updateNextBlockPreview(),this.currentBlockType?this.didAdvance=!0:(this.coachMarksVisible=!1,Ti.getInstance().clear(),this.isAnimating=!0,this.animationPhase="sliding-out",ut.getInstance().animateZoomTo(this.originalZoom),this.isAutoPlacingAll=!1,qp("blockDropDecisionMenu"))}render(e){var C;if(this.animationPhase===null&&!this.open)return;const i=ae(),n=this.slideX*i,o=this.BASE_WINDOW_X*i,l=this.BASE_WINDOW_Y*i,h=this.BASE_WINDOW_WIDTH*i,u=this.BASE_WINDOW_HEIGHT*i,d=this.BASE_BLOCK_PREVIEW_HEIGHT*i,g=this.BASE_BLOCK_PREVIEW_WIDTH*i,m=Math.floor(this.LABEL_FONT_SIZE*i),y=this.BASE_MINI_PREVIEW_HEIGHT*i,v=this.BASE_MINI_PREVIEW_WIDTH*i;Ct({ctx:e,x:o+n,y:l,width:h,height:u,options:{borderRadius:12,alpha:.6,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}});const M=this.currentBlockType?Jg(this.currentBlockType):1,b=ey[M]??"#ffffff";if(Ne(e,o+n+h/2,l+42*i,((C=this.currentBlockType)==null?void 0:C.name)??"",{font:`${m}px monospace`,align:"center",color:Mi(b,.5)}),this.blockPreviewRenderer){const w=o+n+h/2-g/2,A=l+128*i;this.blockPreviewRenderer.render(e,w,A,g,d)}if(this.queue.length>0&&Ne(e,o+n+16*i,l+16*i,`+${this.queue.length} more`,{font:`${m}px monospace`,align:"left",glow:!1}),this.queue.length>0&&this.nextBlockPreviewRenderer){const w="Next:",A=o+n+h-16*i-v-8*i,E=l+16*i;Ne(e,A,E,w,{font:`${m}px monospace`,align:"right",glow:!1});const x=o+n+h-16*i-v,I=l+8*i;this.nextBlockPreviewRenderer.render(e,x,I,v,y)}if(this.currentBlockType){const w=o+n+32*i,A=l+128*i+d+32*i,E=h-64*i;nC(e,this.currentBlockType,w,A,E,i)}(this.animationPhase==="open"||this.currentBlockType)&&(ht(e,this.refineButton,i),ht(e,this.autoplaceButton,i),ht(e,this.randomRollButton,i),ht(e,this.autoPlaceAllButton,i))}getCurrentBlockType(){return this.currentBlockType}isOpen(){return this.open}closeMenu(){this.coachMarksVisible=!1,Ti.getInstance().clear(),this.open=!1,this.queue.length=0,this.currentBlockType=null,this.nextBlockPreviewRenderer=null,qp("blockDropDecisionMenu")}isBlocking(){return this.open}isPointInBounds(e,i){const n=ae(),o=this.BASE_WINDOW_X+this.slideX*n,l=o+this.BASE_WINDOW_WIDTH*n,h=this.BASE_WINDOW_Y+this.BASE_WINDOW_HEIGHT*n;return e>=o&&e<=l&&i>=this.BASE_WINDOW_Y&&i<=h}hasBlocksInQueue(){return this.queue.length>0}getMenuTargetZoom(){return .5*ae()}getHoveredButton(){return this.hoveredButton}getClickedButton(){return this.clickedButton}didAdvanceQueue(){return this.didAdvance}destroy(){this.pause=()=>{},this.resume=()=>{},this.nextBlockPreviewRenderer=null}}class oC{constructor(e,i,n,o,l){this.ship=e,this.menu=i,this.camera=n,this.shipBuilderEffects=o,this.inputManager=l,this.rotation=0,this.lastBlockId=null,this.hoveredShipCoord=null}update(e){var h,u;this.inputManager.wasKeyJustPressed("Space")&&(this.rotation=(this.rotation+90)%360);const i=this.inputManager.getMousePosition();if(this.isCursorOverMenu(i))return;const n=Ma(i,this.camera,e.position,e.rotation);this.hoveredShipCoord=n;const o=this.menu.getCurrentBlockType(),l=(o==null?void 0:o.id)??null;if(!(!l||!o)){if(this.inputManager.wasRightClicked()&&this.hoveredShipCoord){const d=this.ship.getBlock(this.hoveredShipCoord);if(!d)return;if(!d.type.id.startsWith("cockpit")){if(!this.ship.isDeletionSafe(this.hoveredShipCoord)){$.play("assets/sounds/sfx/ui/error_00.wav","sfx",{maxSimultaneous:3});return}const m=((h=oi(d.type.id))==null?void 0:h.cost)??0,y=Math.round(m/2);this.shipBuilderEffects.createSellEffect(d.position),this.ship.removeBlock(this.hoveredShipCoord),$.play("assets/sounds/sfx/ui/click_00.wav","sfx",{maxSimultaneous:3}),Be.getInstance().addCurrency(y)}}if(l!==this.lastBlockId&&(this.rotation=0,this.lastBlockId=l),this.inputManager.wasMouseClicked()&&!this.ship.hasBlockAt(n)&&$u(this.ship,n)){this.ship.placeBlockById(n,l,this.rotation);const d=this.ship.getBlock(n);d!=null&&d.position&&this.shipBuilderEffects.createRepairEffect(d.position);const g=((u=oi(l))==null?void 0:u.placementSound)??"assets/sounds/sfx/ship/gather_00.wav";$.play(g,"sfx",{maxSimultaneous:3}),Te.incrementBlockPlacedCount(),Be.getInstance().dequeueBlock(),this.menu.advanceQueueOrClose()}}}render(e,i){const n=this.inputManager.getMousePosition();if(this.isCursorOverMenu(n))return;const o=Ma(n,this.camera,i.position,i.rotation),l=o.x*X,h=o.y*X,u=Math.cos(i.rotation),d=Math.sin(i.rotation),g=l*u-h*d,m=l*d+h*u,y=i.position.x+g,v=i.position.y+m,M=this.camera.worldToScreen(y,v);e.save(),e.translate(M.x,M.y),e.scale(this.camera.getZoom(),this.camera.getZoom()),e.rotate(i.rotation);const b=this.menu.getCurrentBlockType(),C=(b==null?void 0:b.id)??null;if(!C){e.restore();return}if(this.ship.getBlock(o)){const A=this.ship.isDeletionSafe(o);Qu(e,A)}else{const A=Ki(C);e.save(),e.rotate(this.rotation*Math.PI/180),e.globalAlpha=.6,e.drawImage(A.base,-32/2,-32/2,X,X),e.restore()}e.restore()}isCursorOverMenu(e){return this.menu.isPointInBounds(e.x,e.y)}getHoveredShipBlock(){return this.hoveredShipCoord?this.ship.getBlock(this.hoveredShipCoord):void 0}}const rC={boxColor:"#222",checkColor:"#0f0",hoverColor:"#444",labelColor:"#ccc",borderColor:"#0f0",font:"12px monospace"};function yu(a,e,i=1){const{x:n,y:o,size:l,label:h,checked:u,isHovered:d,style:g={}}=e,{boxColor:m,checkColor:y,hoverColor:v,labelColor:M,borderColor:b,font:C}={...rC,...g},w=l*i,A=C.replace(/(\d+)(px)/,(E,x,I)=>`${Math.round(parseInt(x)*i)}${I}`);a.fillStyle=d?v:m,a.fillRect(n,o,w,w),a.strokeStyle=b,a.lineWidth=1*i,a.strokeRect(n,o,w,w),u&&(a.strokeStyle=y,a.lineWidth=2*i,a.beginPath(),a.moveTo(n+3*i,o+w/2),a.lineTo(n+w/2,o+w-3*i),a.lineTo(n+w-3*i,o+3*i),a.stroke()),h&&(a.font=A,a.fillStyle=M,a.textAlign="left",a.textBaseline="middle",a.fillText(h,n+w+8*i,o+w/2))}function cn(a,e,i,n){const o=i.x,l=i.y,h=i.width*n,u=i.height*n;return a>=o&&a<=o+h&&e>=l&&e<=l+u}function lC(a,e,i){const{x:n,y:o,width:l,height:h,isOpen:u,items:d}=a,g={x:n,y:o,width:l,height:h},m=cn(e.x,e.y,g,i);if(!u)return{isHovered:m};const y=h*i;for(let v=0;v<d.length;v++){const M=o+h*i+v*y,b={x:n,y:M,width:l,height:h};if(cn(e.x,e.y,b,i))return{isHovered:m,hoverIndex:v}}return{isHovered:m}}const cC={barColor:"#0f0",knobColor:"#6f6",backgroundColor:"#111",borderColor:"#0f0",labelColor:"#ccc"};function hC(a,e,i=1,n,o=!0){const{x:l,y:h,width:u,height:d,value:g,style:m={},isHovered:y}=e,{barColor:v,knobColor:M,backgroundColor:b,borderColor:C,labelColor:w}={...cC,...m},A=u*i,E=d*i,x=`${Math.round(12*i)}px monospace`,I=h+E/2;a.fillStyle=b,a.fillRect(l,h,A,E);const D=Math.round(g*A);a.fillStyle=v,a.fillRect(l,h,D,E);const N=l+D,H=E/2;a.beginPath(),a.arc(N,I,H,0,Math.PI*2),a.fillStyle=y?"#fff":M,a.fill(),a.strokeStyle=C,a.lineWidth=1*i,a.strokeRect(l,h,A,E);let W=l+A;if(a.font=x,a.fillStyle=w,a.textAlign="left",a.textBaseline="middle",o){const K=8*i;W+=K;const Z=`${Math.round(g*100)}%`;a.fillText(Z,W,I);const Q=a.measureText(Z);W+=Q.width}if(n){const K=12*i;W+=K,a.fillText(n,W,I)}}function uC(a,e,i=1,n){const{x:o,y:l,width:h,height:u,items:d,selectedIndex:g,isOpen:m,hoverIndex:y,isHovered:v,style:M={}}=e,{backgroundColor:b="#001100",borderColor:C="#00ff41",textColor:w="#00ff41",font:A='13px "Courier New", monospace',glow:E=!0,chromaticAberration:x=!0,alpha:I=1}=M,D=h*i,N=u*i,H=A.replace(/(\d+)(px)/,(J,ee,_)=>`${Math.round(parseInt(ee)*i)}${_}`),W=.5*i,K=v?Mi(C,.8):C,Z=v?Mi(w,.8):w;a.save(),a.globalAlpha=I,a.fillStyle=b,a.fillRect(o,l,D,N),E&&(a.shadowColor=K,a.shadowBlur=8*i),a.strokeStyle=K,a.lineWidth=2*i,a.strokeRect(o,l,D,N),a.restore();const Q=o+6*i,Y=l+N/2,ne=d[g];if(a.save(),a.font=H,a.textAlign="left",a.textBaseline="middle",E&&(a.shadowColor=Z,a.shadowBlur=4*i),x&&(a.save(),a.globalAlpha=.25,a.shadowBlur=0,a.fillStyle="#ff0000",a.fillText(ne.label,Q-W,Y),a.fillStyle="#0000ff",a.fillText(ne.label,Q+W,Y),a.restore()),a.globalAlpha=1,a.fillStyle=Z,a.fillText(ne.label,Q,Y),a.restore(),Ne(a,o+D+12,l+N/2,n,{font:H,color:"#ccc",align:"left"}),m){const J=N;d.forEach((ee,_)=>{const z=l+N+_*J,se=y===_,oe=se?Mi(b,.2):b,k=se?Mi(w,.8):w;a.save(),a.globalAlpha=I,a.fillStyle=oe,a.fillRect(o,z,D,J),E&&(a.shadowColor=C,a.shadowBlur=6*i),a.strokeStyle=C,a.lineWidth=1*i,a.strokeRect(o,z,D,J),a.font=H,a.textAlign="left",a.textBaseline="middle";const G=z+J/2;x&&(a.save(),a.globalAlpha=.25,a.shadowBlur=0,a.fillStyle="#ff0000",a.fillText(ee.label,Q-W,G),a.fillStyle="#0000ff",a.fillText(ee.label,Q+W,G),a.restore()),a.globalAlpha=1,a.fillStyle=k,a.fillText(ee.label,Q,G),a.restore()})}}const fC=[{kind:"master"},{kind:"channel",channel:"music"},{kind:"channel",channel:"sfx"},{kind:"channel",channel:"dialogue"}],dC={master:()=>ke.getInstance().getMasterVolume(),music:()=>ke.getInstance().getMusicVolume(),sfx:()=>ke.getInstance().getSfxVolume(),dialogue:()=>ke.getInstance().getDialogueVolume()},gC={master:a=>ke.getInstance().setMasterVolume(a),music:a=>ke.getInstance().setMusicVolume(a),sfx:a=>ke.getInstance().setSfxVolume(a),dialogue:a=>ke.getInstance().setDialogueVolume(a)};class pC{constructor(e,i,n,o){this.activeTab="display",this.open=!1,this.volumeLabels=["Master Volume","Music Volume","Sound Effects","Dialogue Volume"],this.closeButton=null,this.volumeSliders=[],this.particleCheckbox=null,this.lightingCheckbox=null,this.collisionsCheckbox=null,this.resolutionDropdown=null,this.windowX=120,this.windowY=80,this.windowHeight=460,this.windowWidth=440,this.headerStartY=20,this.headerStartX=80,this.headerHeight=40,this.headerItemWidth=80,this.headerHorizontalPadding=12,this.headerVerticalPadding=6,this.buttonWidth=120,this.buttonHeight=40,this.sliderWidth=120,this.sliderHeight=12,this.dropdownWidth=120,this.dropdownHeight=28,this.checkboxSize=14,this.itemVerticalSpacing=40,this.margin=20,this.inputManager=e,this.menuManager=i,this.canvasManager=n,this.camera=o,this.initialize()}initialize(){const e=ke.getInstance(),i=ae(),n=this.margin*i,o=this.headerHeight*i,l=this.itemVerticalSpacing*i,h=this.windowHeight*i,u=this.windowWidth*i,d=this.buttonWidth*i,g=this.buttonHeight*i,m=160,y=this.windowY+n+o;this.closeButton={x:this.windowX+u-d-n,y:this.windowY+h-g-n,width:this.buttonWidth,height:this.buttonHeight,label:"Close",onClick:()=>{const b=this.menuManager.getMenu("pauseMenu");b&&this.menuManager.transition(b)},style:{borderRadius:10,alpha:.8,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}},this.volumeSliders=fC.map((b,C)=>{const w=b.kind==="master"?"master":b.channel;return{x:m,y:y+C*l,width:this.sliderWidth,height:this.sliderHeight,value:dC[w](),onChange:A=>{gC[w](A),ct.getInstance().saveSettings()}}}),this.particleCheckbox={x:m,y,size:this.checkboxSize,label:"Particles Enabled",checked:e.isParticlesEnabled(),onToggle:b=>{this.particleCheckbox.checked=b,e.setParticlesEnabled(b),ct.getInstance().saveSettings()}},this.lightingCheckbox={x:m,y:y+l,size:this.checkboxSize,label:"Lighting Enabled",checked:e.isLightingEnabled(),onToggle:b=>{this.lightingCheckbox.checked=b,e.setLightingEnabled(b),ct.getInstance().saveSettings()}},this.collisionsCheckbox={x:m,y:y+l*2,size:this.checkboxSize,label:"Collisions Enabled",checked:e.isCollisionsEnabled(),onToggle:b=>{this.collisionsCheckbox.checked=b,e.setCollisionsEnabled(b),ct.getInstance().saveSettings()}};const v=`${e.getViewportWidth()}x${e.getViewportHeight()}`,M=[{label:"1920x1080",value:"1920x1080"},{label:"1920x1200",value:"1920x1200"},{label:"2560x1440",value:"2560x1440"},{label:"3840x2160",value:"3840x2160"}];this.resolutionDropdown={x:m,y:y+l*3,width:this.dropdownWidth,height:this.dropdownHeight,items:M,selectedIndex:M.findIndex(b=>b.value===v)||0,isOpen:!1,onSelect:b=>{const[C,w]=b.value.split("x");e.setViewportWidth(parseInt(C,10)),e.setViewportHeight(parseInt(w,10)),Rl(this.canvasManager,this.camera),ct.getInstance().saveSettings(),this.initialize()},style:{backgroundColor:"#001100",borderColor:"#00ff41",textColor:"#00ff41",glow:!0,chromaticAberration:!0,alpha:1}}}update(){var g,m,y,v,M;const e=this.inputManager.getMousePosition(),i=(m=(g=this.inputManager).wasLeftClicked)==null?void 0:m.call(g),n=(v=(y=this.inputManager).isMouseLeftPressed)==null?void 0:v.call(y),o=ae(),l=this.headerItemWidth*o,h=this.headerHorizontalPadding*o;if(i){const b=this.headerStartX+this.windowX,C=this.headerStartY+this.windowY,w=[{tab:"display",label:"General"},{tab:"volume",label:"Volume"},{tab:"controls",label:"Controls"},{tab:"keybinds",label:"Keybinds"}];for(let A=0;A<w.length;A++){const E=b+A*(l+h);if(cn(e.x,e.y,{x:E,y:C+this.headerVerticalPadding*o,width:this.headerItemWidth,height:this.headerHeight},o)){this.activeTab=w[A].tab;break}}}if(this.activeTab==="display")for(const b of[this.particleCheckbox,this.lightingCheckbox,this.collisionsCheckbox]){if(!b)continue;const C={x:b.x,y:b.y,width:b.size,height:b.size};b.isHovered=cn(e.x,e.y,C,o),i&&b.isHovered&&b.onToggle(!b.checked)}if(this.activeTab==="volume")for(const b of this.volumeSliders){const C={x:b.x,y:b.y,width:b.width,height:b.height};if(b.isHovered=cn(e.x,e.y,C,o),n&&b.isHovered){const w=e.x-b.x,A=Math.min(1,Math.max(0,w/(b.width*o)));b.value=A,b.onChange(A),b.isDragging=!0}else n||(b.isDragging=!1)}const u=this.resolutionDropdown;if(u){const{isHovered:b,hoverIndex:C}=lC(u,e,o);u.isHovered=b,u.hoverIndex=C,i&&b&&C===void 0&&(u.isOpen=!u.isOpen),u.isOpen&&typeof C=="number"&&i&&(u.selectedIndex=C,u.isOpen=!1,(M=u.onSelect)==null||M.call(u,u.items[C]))}const d=this.closeButton;if(d){const b={x:d.x,y:d.y,width:d.width,height:d.height};d.isHovered=cn(e.x,e.y,b,o),i&&d.isHovered&&d.onClick()}}render(e){const i=ae(),n=this.headerItemWidth*i,o=this.headerHorizontalPadding*i;if(Ct({ctx:e,x:this.windowX,y:this.windowY,width:this.windowWidth,height:this.windowHeight,uiScale:i,options:{alpha:.6,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),[{tab:"display",label:"General"},{tab:"volume",label:"Volume"},{tab:"controls",label:"Controls"},{tab:"keybinds",label:"Keybinds"}].forEach((h,u)=>{Ne(e,this.headerStartX+this.windowX+u*(n+o),this.headerStartY+this.windowY+this.headerVerticalPadding*i,h.label,{font:"16px monospace",align:"left",color:this.activeTab===h.tab?"#6f6":"#888"},i)}),this.activeTab==="display")yu(e,this.particleCheckbox,i),yu(e,this.lightingCheckbox,i),yu(e,this.collisionsCheckbox,i),uC(e,this.resolutionDropdown,i,"Resolution");else if(this.activeTab==="volume")for(let h=0;h<this.volumeSliders.length;h++){const u=this.volumeSliders[h],d=this.volumeLabels[h];hC(e,u,i,d)}else this.activeTab==="controls"?Ne(e,this.windowX+this.margin*i,this.windowY+100*i,"Controls tab coming soon...",{font:"14px monospace",align:"left",color:"#ccc"},i):this.activeTab==="keybinds"&&Ne(e,this.windowX+this.margin*i,this.windowY+100*i,"Keybinds tab coming soon...",{font:"14px monospace",align:"left",color:"#ccc"},i);ht(e,this.closeButton,i)}isOpen(){return this.open}openMenu(){this.open=!0}closeMenu(){this.open=!1}isBlocking(){return!0}}function xo(a,e){pe.emit("postprocess:effect:add",{effect:a,params:e})}function mC(a){pe.emit("postprocess:effect:remove",{effect:a})}function vu(){pe.emit("postprocess:effect:clear",void 0)}function $p(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"chromaticAberration"},{effect:"cinematicGrading",params:{exposure:2,contrast:1,saturation:1.4,temperature:.85,tint:-.05,vignetteStrength:1.45,filmGrainStrength:.08,shadowsLift:.01,highlightsGain:.4,cinematicIntensity:.002}}]})}function yC(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:.95,contrast:1,saturation:.9,temperature:-.2,tint:.1,vignetteStrength:.4,filmGrainStrength:.12,shadowsLift:-.05,highlightsGain:1.1,cinematicIntensity:.8}}]})}function vC(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:.5,contrast:1,saturation:1.2,temperature:.25,tint:-.1,vignetteStrength:.5,filmGrainStrength:.2,shadowsLift:.1,highlightsGain:.9,cinematicIntensity:.7}}]})}function bC(){pe.emit("postprocess:effect:set",{effectChain:[{effect:"cinematicGrading",params:{exposure:1.02,contrast:1.08,saturation:1.03,temperature:.05,tint:0,vignetteStrength:.15,filmGrainStrength:.04,shadowsLift:.01,highlightsGain:1.01,cinematicIntensity:.5}}]})}class SC{constructor(e,i,n){this.inputManager=e,this.onAbandon=i,this.menuManager=n,this.open=!1,this.windowX=120,this.windowY=100,this.windowWidth=220,this.windowHeight=240,this.buttonWidth=140,this.buttonHeight=40,this.sharedStyle={borderRadius:10,alpha:.9,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}},this.disabledStyle={borderRadius:10,alpha:.5,borderColor:"#445544",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#111911"},{offset:1,color:"#0a120a"}]}},this.settingsButton={},this.abandonButton={},this.resumeButton={},this.initialize()}initialize(){const e=ae(),i=this.buttonHeight*e,n=i*.5,o=this.windowWidth*e,l=this.windowHeight*e,h=.2*o+this.windowX,u=.2*l+this.windowY;this.settingsButton={x:h,y:u,width:this.buttonWidth,height:this.buttonHeight,label:"Settings",onClick:()=>{const d=this.menuManager.getMenu("settingsMenu");d&&this.menuManager.transition(d)},style:this.sharedStyle},this.abandonButton={x:h,y:u+n*1+i*1,width:this.buttonWidth,height:this.buttonHeight,label:"Abandon Mission",onClick:Ee.has("mission.intro-briefing.complete")?this.onAbandon:()=>{},style:Ee.has("mission.intro-briefing.complete")?this.sharedStyle:this.disabledStyle},this.resumeButton={x:h,y:u+n*2+i*2,width:this.buttonWidth,height:this.buttonHeight,label:"Resume",onClick:()=>{this.menuManager.close(this),this.menuManager.resume()},style:this.sharedStyle}}update(){const e=ae(),i=this.inputManager.getMousePosition(),n=this.inputManager.wasMouseClicked();if(!i)return;const{x:o,y:l}=i,h=[this.settingsButton,this.abandonButton,this.resumeButton];for(const u of h){const d={x:u.x,y:u.y,width:u.width,height:u.height};u.isHovered=cn(o,l,d,e)}n&&(this.settingsButton.isHovered?this.settingsButton.onClick():this.abandonButton.isHovered?this.abandonButton.onClick():this.resumeButton.isHovered&&this.resumeButton.onClick())}render(e){const i=ae();Ct({ctx:e,x:this.windowX,y:this.windowY,width:this.windowWidth,height:this.windowHeight,uiScale:i,options:{alpha:.5,borderRadius:12,borderColor:"#00ff00",backgroundGradient:{type:"linear",stops:[{offset:0,color:"#002200"},{offset:1,color:"#001500"}]}}}),Ne(e,this.windowX+this.windowWidth*i/2,this.windowY+10*i,"Game Paused",{font:"16px monospace",align:"center",glow:!0},i),ht(e,this.settingsButton,i),ht(e,this.abandonButton,i),ht(e,this.resumeButton,i)}isOpen(){return this.open}openMenu(){this.initialize(),this.open=!0,xo("blackwhite")}closeMenu(){this.open=!1,mC("blackwhite")}isBlocking(){return!0}}const Iu={barColor:"#00ff41",backgroundColor:"#0a0a0a",borderColor:"#00ff41",textColor:"#00ff41",glow:!0,font:'11px "Courier New", monospace',scanlineIntensity:.3,chromaticAberration:!0,phosphorDecay:!0,cornerBevel:!0,warningThreshold:.3,criticalThreshold:.15,warningColor:"#ffaa00",criticalColor:"#ff0040",animated:!0};class da{constructor(){this.cache=new Map,this.maxCacheSize=50,this.maxAge=3e4}static getInstance(){return da.instance||(da.instance=new da),da.instance}generateCacheKey(e,i){const{width:n,height:o,style:l={}}=e,h={...Iu,...l},u=Math.max(0,Math.min(1,e.value));let d=h.borderColor;switch(u<=h.criticalThreshold?d=h.criticalColor:u<=h.warningThreshold&&(d=h.warningColor),i){case"background":return`bg_${n}_${o}_${h.backgroundColor}_${h.cornerBevel}`;case"border":return`border_${n}_${o}_${d}_${h.cornerBevel}`;case"scanlines":return`scan_${n}_${o}_${h.scanlineIntensity}`;default:return""}}getOrCreate(e,i){const n=this.generateCacheKey(e,i),o=this.cache.get(n);if(o&&Date.now()-o.timestamp<this.maxAge)return o;this.cleanup();const l=document.createElement("canvas");l.width=e.width+20,l.height=e.height+20;const h=l.getContext("2d"),u={canvas:l,ctx:h,cacheKey:n,timestamp:Date.now()};return this.renderStaticElement(e,i,h),this.cache.set(n,u),u}renderStaticElement(e,i,n){const{width:o,height:l,style:h={}}=e,u={...Iu,...h},d=10,g=10;switch(i){case"background":this.renderBackground(n,d,g,o,l,u);break;case"border":const m=Math.max(0,Math.min(1,e.value));let y=u.borderColor;m<=u.criticalThreshold?y=u.criticalColor:m<=u.warningThreshold&&(y=u.warningColor),this.renderBorder(n,d,g,o,l,{...u,borderColor:y});break;case"scanlines":this.renderScanlines(n,d,g,o,l,u);break}}renderBackground(e,i,n,o,l,h){if(e.save(),h.cornerBevel){const d=Math.min(3,l*.2);e.beginPath(),e.moveTo(i+d,n),e.lineTo(i+o-d,n),e.lineTo(i+o,n+d),e.lineTo(i+o,n+l-d),e.lineTo(i+o-d,n+l),e.lineTo(i+d,n+l),e.lineTo(i,n+l-d),e.lineTo(i,n+d),e.closePath(),e.clip()}const u=e.createLinearGradient(i,n,i,n+l);u.addColorStop(0,ii(h.backgroundColor,"ff")),u.addColorStop(.5,ii(h.backgroundColor,"cc")),u.addColorStop(1,ii(h.backgroundColor,"ff")),e.fillStyle=u,e.fillRect(i,n,o,l),e.restore()}renderBorder(e,i,n,o,l,h){if(e.save(),e.strokeStyle=h.borderColor,e.lineWidth=2,h.cornerBevel){const d=Math.min(3,l*.2);e.beginPath(),e.moveTo(i+d,n),e.lineTo(i+o-d,n),e.lineTo(i+o,n+d),e.lineTo(i+o,n+l-d),e.lineTo(i+o-d,n+l),e.lineTo(i+d,n+l),e.lineTo(i,n+l-d),e.lineTo(i,n+d),e.closePath(),e.stroke()}else e.strokeRect(i,n,o,l);e.strokeStyle=`${h.borderColor}40`,e.lineWidth=1,e.strokeRect(i+1,n+1,o-2,l-2),e.strokeStyle=h.borderColor,e.lineWidth=2,e.globalAlpha=.7;const u=Math.min(8,l*.4);e.beginPath(),e.moveTo(i-4,n+u),e.lineTo(i-4,n-4),e.lineTo(i+u,n-4),e.stroke(),e.beginPath(),e.moveTo(i+o-u,n-4),e.lineTo(i+o+4,n-4),e.lineTo(i+o+4,n+u),e.stroke(),e.beginPath(),e.moveTo(i+o+4,n+l-u),e.lineTo(i+o+4,n+l+4),e.lineTo(i+o-u,n+l+4),e.stroke(),e.beginPath(),e.moveTo(i+u,n+l+4),e.lineTo(i-4,n+l+4),e.lineTo(i-4,n+l-u),e.stroke(),e.restore()}renderScanlines(e,i,n,o,l,h){if(h.scanlineIntensity<=0)return;e.save();const u=2,d=1;e.fillStyle=`rgba(255, 255, 255, ${h.scanlineIntensity*.08})`;for(let g=0;g<l+u;g+=u)n+g>=n&&n+g<n+l&&e.fillRect(i,n+g,o,d);e.restore()}cleanup(){if(this.cache.size<=this.maxCacheSize)return;const e=Date.now(),i=Array.from(this.cache.entries());i.forEach(([n,o])=>{e-o.timestamp>this.maxAge&&this.cache.delete(n)}),this.cache.size>this.maxCacheSize&&i.sort((o,l)=>o[1].timestamp-l[1].timestamp).slice(0,this.cache.size-this.maxCacheSize).forEach(([o])=>this.cache.delete(o))}clear(){this.cache.clear()}}class ga{constructor(){this.cache=new Map}static getInstance(){return ga.instance||(ga.instance=new ga),ga.instance}getBarGradient(e,i,n,o,l,h,u){const d=`bar_${o}_${l}_${h}_${u}`;if(!this.cache.has(d)){const g=e.createLinearGradient(i,n,i,n+l),m=Math.floor(u*255).toString(16).padStart(2,"0"),y=Math.floor(u*180).toString(16).padStart(2,"0");g.addColorStop(0,ii(h,m)),g.addColorStop(.5,ii(h,y)),g.addColorStop(1,ii(h,m)),this.cache.set(d,g)}return this.cache.get(d)}getPhosphorGradient(e,i,n,o,l){const h=`phosphor_${n}_${o}_${l}`;if(!this.cache.has(h)){const u=e.createLinearGradient(i,0,i+n,0);u.addColorStop(0,ii(o,"08")),u.addColorStop(.7,ii(o,"15")),u.addColorStop(1,ii(o,Math.floor(l*255).toString(16).padStart(2,"0"))),this.cache.set(h,u)}return this.cache.get(h)}clear(){this.cache.clear()}}function Jp(a,e,i=Date.now()){const{x:n,y:o,width:l,height:h,value:u,label:d,style:g={}}=e,m={...Iu,...g},{barColor:y,glow:v,textColor:M,font:b,scanlineIntensity:C,chromaticAberration:w,phosphorDecay:A,warningThreshold:E,criticalThreshold:x,warningColor:I,criticalColor:D,animated:N}=m,H=Math.max(0,Math.min(1,u)),W=H*l;let K=y;H<=x?K=D:H<=E&&(K=I);let Z=1,Q=0;N&&(H<=x&&(Z=.7+.3*Math.sin(i*.008)),Q=i*.02%4);const Y=da.getInstance(),ne=ga.getInstance(),J=Y.getOrCreate(e,"background");if(J&&a.drawImage(J.canvas,n-10,o-10),A&&W>0){const _=ne.getPhosphorGradient(a,n,W,K,Z);a.fillStyle=_,a.fillRect(n,o,W,h)}if(W>0){const _=ne.getBarGradient(a,n,o,l,h,K,Z);a.fillStyle=_,a.fillRect(n,o,W,h)}if(v&&W>0&&(a.save(),a.shadowColor=K,a.shadowBlur=12,a.shadowOffsetX=0,a.shadowOffsetY=0,a.globalAlpha=.4*Z,a.fillStyle=K,a.fillRect(n-1,o-1,W+2,h+2),a.shadowBlur=6,a.globalAlpha=.6*Z,a.fillRect(n,o,W,h),a.restore()),w&&W>0&&(a.save(),a.globalAlpha=.15,a.fillStyle="#ff0000",a.fillRect(n-.5,o,W,h),a.fillStyle="#0000ff",a.fillRect(n+.5,o,W,h),a.restore()),C>0){const _=Y.getOrCreate(e,"scanlines");if(_){if(a.save(),a.globalAlpha=1,a.drawImage(_.canvas,n-10,o-10-Q),N&&Math.sin(i*.003)>.95){a.fillStyle=`rgba(255, 255, 255, ${C*.2})`;const z=o+(Math.sin(i*.007)*.5+.5)*h;a.fillRect(n,z,l,1)}a.restore()}}const ee=Y.getOrCreate(e,"border");ee&&(a.save(),a.globalAlpha=Z,a.drawImage(ee.canvas,n-10,o-10),a.restore()),d&&(a.save(),a.font=b,a.fillStyle=M,a.textAlign="center",a.textBaseline="middle",a.globalAlpha=Z,v&&(a.shadowColor=M,a.shadowBlur=4,a.shadowOffsetX=0,a.shadowOffsetY=0),w&&(a.save(),a.globalAlpha=.3,a.fillStyle="#ff000040",a.fillText(d,n+l/2-.5,o+h/2),a.fillStyle="#0000ff40",a.fillText(d,n+l/2+.5,o+h/2),a.restore()),a.fillText(d,n+l/2,o+h/2),a.restore()),H<=x&&(a.save(),a.fillStyle=D,a.globalAlpha=(Math.sin(i*.015)+1)*.3,a.fillRect(n-2,o-2,4,4),a.fillRect(n+l-2,o-2,4,4),a.restore())}const sy={barColor:"#0af",backgroundColor:"#111",borderColor:"#0ff",glow:!0,textColor:"#fff",showLabel:!0,unit:""};class pa{constructor(){this.cache=new Map,this.maxAge=3e4}static getInstance(){return pa.instance||(pa.instance=new pa),pa.instance}getOrCreate(e,i){const{width:n,height:o,style:l={}}=e,h={...sy,...l},u=Math.round(n*i),d=Math.round(o*i),g=`vbar_${u}_${d}_${h.backgroundColor}_${h.borderColor}`,m=this.cache.get(g);if(m&&Date.now()-m.timestamp<this.maxAge)return m;const y=document.createElement("canvas");y.width=u+4,y.height=d+4;const v=y.getContext("2d");v.save(),v.fillStyle=h.backgroundColor,v.fillRect(2,2,u,d),v.strokeStyle=h.borderColor,v.lineWidth=1,v.strokeRect(1.5,1.5,u+1,d+1),v.fillStyle="rgba(255,255,255,0.05)";for(let b=0;b<d;b+=2)v.fillRect(2,2+b,u,1);v.restore();const M={canvas:y,ctx:v,cacheKey:g,timestamp:Date.now()};return this.cache.set(g,M),M}clear(){this.cache.clear()}}function MC(a,e,i=1){const{x:n,y:o,width:l,height:h,value:u,maxValue:d,style:g={}}=e,{barColor:m,glow:y,textColor:v,showLabel:M,unit:b}={...sy,...g},C=l*i,w=h*i,E=Math.max(0,Math.min(u,d))/d*w,x=o+w-E,I=pa.getInstance().getOrCreate(e,i);if(a.drawImage(I.canvas,n-2,o-2),a.fillStyle=m,a.fillRect(n,x,C,E),y&&(a.save(),a.shadowColor=m,a.shadowBlur=8*i,a.shadowOffsetX=0,a.shadowOffsetY=0,a.fillStyle=m,a.fillRect(n,x,C,E),a.restore()),M){a.save(),a.font=`${Math.round(11*ae())}px monospace`,a.fillStyle=v,a.textAlign="center",a.textBaseline="bottom";const D=`${Math.round(u)}${b?` ${b}`:""}`;a.fillText(D,n+C/2,o-4*ae()),a.restore()}}var Xt=(a=>(a.Synced="synced",a.Sequence="sequence",a))(Xt||{});function CC(a,e,i=performance.now()){const{x:n,y:o,mode:l,style:h={}}=e,{width:u=120,height:d=24,backgroundColor:g="#001122",borderColor:m="#0066cc",activeColor:y="#00aaff",inactiveColor:v="#003366",textColor:M="#00ccff",glowColor:b="#00aaff",font:C='10px "Courier New", monospace',glow:w=!0,animated:A=!0,scanlineIntensity:E=.2,chromaticAberration:x=!0}=h,I=l===Xt.Synced,D=4,N=u*.45,H=d-6,W=o+3,K=I?n+3:n+u-N-3,Q=A?Math.sin(i*.008)*.5:0,Y=K+Q;a.save(),w&&(a.shadowColor=b,a.shadowBlur=8,a.shadowOffsetX=0,a.shadowOffsetY=0),a.fillStyle=g,a.strokeStyle=m,a.lineWidth=1,a.beginPath(),a.roundRect(n,o,u,d,D),a.fill(),a.stroke(),a.shadowBlur=0,a.fillStyle=M,a.font=C,a.textAlign="center",a.textBaseline="middle";const ne=I?1:.4;a.save(),a.globalAlpha=ne,a.fillText("SYNC",n+u*.25,o+d*.5),a.restore();const J=I?.4:1;a.save(),a.globalAlpha=J,a.fillText("SEQ",n+u*.75,o+d*.5),a.restore();const ee=I?y:"#ff6600";w&&(a.save(),a.shadowColor=ee,a.shadowBlur=6,a.fillStyle=ee,a.globalAlpha=.3,a.beginPath(),a.roundRect(Y-2,W-2,N+4,H+4,D),a.fill(),a.restore()),a.fillStyle=ee,a.strokeStyle=ee,a.lineWidth=1,a.beginPath(),a.roundRect(Y,W,N,H,D-1),a.fill();const _=a.createLinearGradient(Y,W,Y,W+H);if(_.addColorStop(0,"rgba(255, 255, 255, 0.3)"),_.addColorStop(.5,"rgba(255, 255, 255, 0.1)"),_.addColorStop(1,"rgba(0, 0, 0, 0.2)"),a.fillStyle=_,a.beginPath(),a.roundRect(Y,W,N,H*.6,D-1),a.fill(),E>0){a.save(),a.globalAlpha=E,a.strokeStyle="#00ffff",a.lineWidth=.5;for(let oe=0;oe<d;oe+=3)a.beginPath(),a.moveTo(n,o+oe),a.lineTo(n+u,o+oe),a.stroke();a.restore()}if(x&&A){const oe=Math.sin(i*.003)*.5;a.save(),a.globalAlpha=.1,a.globalCompositeOperation="screen",a.fillStyle="#ff0000",a.beginPath(),a.roundRect(n+oe,o,u,d,D),a.fill(),a.fillStyle="#0000ff",a.beginPath(),a.roundRect(n-oe,o,u,d,D),a.fill(),a.restore()}const z=2,se=o+d+8;a.fillStyle=I?y:v,a.beginPath(),a.arc(n+u*.25,se,z,0,Math.PI*2),a.fill(),a.fillStyle=I?v:"#ff6600",a.beginPath(),a.arc(n+u*.75,se,z,0,Math.PI*2),a.fill(),a.restore()}function TC(a){pe.emit("cursor:change",{type:a})}function wC(){pe.emit("cursor:restore",void 0)}const em=new Map,AC={gray:{backgroundColor:"#444444",borderColor:"#888888"},green:{backgroundColor:"#003300",borderColor:"#00ff00"},blue:{backgroundColor:"#002244",borderColor:"#00ccff"},purple:{backgroundColor:"#220033",borderColor:"#cc66ff"}};function kC(a,e){const i=u=>Math.max(0,Math.min(255,u)),n=parseInt(a.slice(1),16),o=i((n>>16&255)+e*255),l=i((n>>8&255)+e*255),h=i((n&255)+e*255);return`rgb(${o},${l},${h})`}function RC(a){const{ctx:e,x:i,y:n,width:o,height:l,borderRadius:h,baseStyleId:u,alpha:d=1,scale:g=1,brighten:m=0}=a,y=AC[u];if(!y){console.warn(`[drawBlockCard] Unknown style: ${u}`);return}const v=u;let M=em.get(v);if(!M){M=document.createElement("canvas"),M.width=o,M.height=l;const w=M.getContext("2d");w.fillStyle=y.backgroundColor,w.strokeStyle=y.borderColor,w.lineWidth=2,w.beginPath(),w.roundRect(0,0,o,l,h),w.fill(),w.stroke(),em.set(v,M)}e.save(),e.globalAlpha*=d;const b=i+o/2,C=n+l/2;e.translate(b,C),e.scale(g,g),e.translate(-o/2,-l/2),m>.01?(e.drawImage(M,0,0,o,l),e.fillStyle=kC(y.backgroundColor,m),e.globalAlpha*=.2,e.fillRect(0,0,o,l)):e.drawImage(M,0,0,o,l),e.restore()}function EC(a){switch(a){case 0:return"gray";case 1:return"gray";case 2:return"green";case 3:return"blue";case 4:return"purple";default:return"gray"}}class BC{constructor(e,i,n,o){this.canvasManager=e,this.playerResources=i,this.blockDropDecisionMenu=n,this.inputManager=o,this.MINI_BLOCK_SIZE=16,this.MINI_BLOCK_SPIN_SPEED=.5,this.BLOCK_CULLING_THRESHOLD=20,this.floatOffsets=[],this.xOffsets=[],this.pulseTimers=[],this.FLOAT_SPEED=120,this.FLOAT_HEIGHT=10,this.MOUSE_HOVER_HEIGHT=72,this.MOUSE_HOVER_SPEED=320,this.X_OFFSET_SPEED=360,this.FANOUT_X_OFFSET=28,this.PULSE_SPEED=4,this.PULSE_SCALE_AMPLITUDE=.06,this.PULSE_BRIGHTNESS_AMPLITUDE=.25,this.cardWidth=0,this.cardHeight=0,this.cardMarginX=0,this.cardColumns=6,this.windowMarginX=0,this.windowMarginY=0,this.windowWidth=0,this.windowX=0,this.windowY=0,this.cardSpacing=0,this.fanBaseX=0,this.scale=1;const l=oi("hull0");this.blockPreviewRenderer=new ml(l,this.MINI_BLOCK_SPIN_SPEED,this.MINI_BLOCK_SPIN_SPEED*1.5),this.resize()}resize(){this.scale=ae();const e=this.canvasManager.getContext("ui").canvas;this.cardWidth=Math.floor(32*this.scale),this.cardHeight=Math.floor(32*this.scale),this.cardMarginX=Math.floor(8*this.scale),this.windowMarginX=Math.floor(6*this.scale),this.windowMarginY=Math.floor(6*this.scale);const i=Math.floor(80*this.scale);this.windowWidth=Math.floor(this.cardWidth*this.cardColumns+this.windowMarginX*2+this.cardMarginX*(this.cardColumns-1)),this.windowX=Math.floor(e.width/2)-this.windowWidth/2,this.windowY=e.height-i,this.cardSpacing=this.cardWidth+this.cardMarginX,this.fanBaseX=this.windowX+this.windowMarginX}update(e){const i=this.playerResources.getBlockQueue();if(i.length===0){this.floatOffsets.length=0,this.pulseTimers.length=0,this.xOffsets.length=0;return}this.blockPreviewRenderer.update(e);const n=this.blockDropDecisionMenu.getHoveredButton();for(;this.floatOffsets.length<i.length;)this.floatOffsets.push(0);for(;this.floatOffsets.length>i.length;)this.floatOffsets.pop();for(;this.pulseTimers.length<i.length;)this.pulseTimers.push(0);for(;this.pulseTimers.length>i.length;)this.pulseTimers.pop();for(;this.xOffsets.length<i.length;)this.xOffsets.push(0);for(;this.xOffsets.length>i.length;)this.xOffsets.pop();const{x:o,y:l}=this.inputManager.getMousePosition(),h=n==="roll";if(i.length>this.cardColumns){const y=this.windowWidth-this.windowMarginX*2;this.cardSpacing=(y-this.cardWidth)/(i.length-1)}else this.cardSpacing=this.cardWidth+this.cardMarginX;let u=null;for(let y=i.length-1;y>=0;y--){let v;if(h&&y<=2){const b=this.xOffsets[y]??0;v=this.fanBaseX+b}else v=this.windowX+this.windowMarginX+y*this.cardSpacing;const M=this.windowY+this.windowMarginY;if(o>=v&&o<=v+this.cardWidth&&l>=M&&l<=M+this.cardHeight){u=y;break}}const d=new Set;if(n==="refine"||n==="autoplace")i.length>0&&d.add(0);else if(n==="roll")for(let y=0;y<3&&y<i.length;y++)d.add(y);for(let y=0;y<i.length;y++){let v=0,M=this.FLOAT_SPEED*e;y===u?(v=this.MOUSE_HOVER_HEIGHT,M=this.MOUSE_HOVER_SPEED*e):d.has(y)&&(v=this.FLOAT_HEIGHT);const b=this.floatOffsets[y],C=v-b,w=Math.sign(C)*Math.min(Math.abs(C),M);this.floatOffsets[y]+=w}for(let y=0;y<i.length;y++)this.pulseTimers[y]+=e*this.PULSE_SPEED;const g=this.FANOUT_X_OFFSET*this.scale,m=Array.from(d).sort((y,v)=>y-v);for(let y=0;y<i.length;y++){let v=0;if(n==="roll"&&y<=2)v=g*y;else if(d.has(y)&&d.size<=3&&n!=="roll"){const A=m.indexOf(y);if(A!==-1){const E=Math.floor(m.length/2);v=g*(A-E)}}const M=this.xOffsets[y],b=v-M,C=this.X_OFFSET_SPEED*e,w=Math.sign(b)*Math.min(Math.abs(b),C);this.xOffsets[y]+=w}}render(){var ee,_;const e=this.canvasManager.getContext("ui"),i=e.canvas,n=ae(),o=Math.floor(80*n),l=Math.floor(i.width/2),h=Math.floor(32*n),u=Math.floor(32*n),d=Math.floor(8*n),g=Math.floor(8*n),m=6,y=Math.floor(6*n),v=Math.floor(6*n),M=Math.floor(h*m+y*2+d*(m-1)),b=Math.floor(44*n),C=l-M/2,w=i.height-o,{x:A,y:E}=this.inputManager.getMousePosition(),x=A>=C&&A<=C+M&&E>=w&&E<=w+b,I=this.blockDropDecisionMenu.getHoveredButton(),D=this.playerResources.getBlockQueue(),N=D.length;let H=N>0?"#00ff00":"#003400",W=`Blocks: ${N}`,K=.5;if(I&&N>0)switch(I){case"refine":{W=`Refine "${((ee=D[0])==null?void 0:ee.name)??"Block"}"`,H="#ffcc00",K=.85;break}case"roll":{W="3-1 Reroll",H="#cc66ff",K=.85;break}case"autoplace":{W=`Attach "${((_=D[0])==null?void 0:_.name)??"Block"}"`,H="#00ccff",K=.85;break}case"autoPlaceAll":{W=`Attach ${N} Blocks`,H="#66ff66",K=.85;break}}x?(K=Math.min(1,K+.3),H=Mi(H,.2),TC("hovered")):wC(),Ct({ctx:e,x:C,y:w,width:M,height:b,options:{alpha:K,borderRadius:12,borderColor:H,backgroundColor:"#00000000"}}),Ne(e,C,w-14*n,W,{align:"left",color:H},n);const Q=Math.floor(this.MINI_BLOCK_SIZE*n);let Y=h+d;if(N>m){const z=M-y*2;N*h+(N-1)*d>z&&(Y=(z-h)/(N-1))}const ne=I==="roll",J=C+y;for(let z=D.length-1;z>=0;z--){const se=D[z],oe=Si(se.id),k=EC(oe),G=this.floatOffsets[z]??0,te=this.pulseTimers[z]??0,ie=this.xOffsets[z]??0;let re=1,ve=0;if(G>.5){const Ds=(Math.sin(te)+1)/2;re=1+Ds*this.PULSE_SCALE_AMPLITUDE,ve=Ds*this.PULSE_BRIGHTNESS_AMPLITUDE}const ue=Math.floor(h*re),ft=Math.floor(u*re),Oe=Math.floor(Q*re);let _t;ne&&z>=0&&z<=2?_t=J+ie+(h-ue)/2:_t=C+y+z*Y+(h-ue)/2;const yn=w+v-G+(u-ft)/2;RC({ctx:e,x:_t,y:yn,width:ue,height:ft,borderRadius:12,baseStyleId:k,alpha:1,scale:1,brighten:ve});const vn=_t+d,Ta=yn+g,wa=N>0?1:.3;z<this.BLOCK_CULLING_THRESHOLD&&this.blockPreviewRenderer.render(e,vn,Ta,Oe,Oe,wa,se)}}}class IC{constructor(e,i,n,o,l){this.canvasManager=e,this.ship=i,this.floatingTextManager=n,this.blockDropDecisionMenu=o,this.inputManager=l,this.currency=0,this.previousCurrency=0,this.disposer=null,this.inputManager=l,this.playerResources=Be.getInstance(),this.currency=this.playerResources.getCurrency(),this.previousCurrency=this.currency,this.disposer=this.playerResources.onCurrencyChange(h=>{if(h>this.currency){const u=this.canvasManager.getContext("ui"),d=h-this.currency,g=ae(),m=Math.floor(900*g)+Math.floor(80*g),v=u.canvas.height-Math.floor(24*g)-Math.floor(12*g);this.floatingTextManager.createScreenText(`+${d}`,m,v,12,"monospace",1,100,1,"#FFD700",{impactScale:1.5},"currency")}this.currency=h}),this.blockQueueDisplayManager=new BC(this.canvasManager,this.playerResources,this.blockDropDecisionMenu,this.inputManager)}update(e){this.blockQueueDisplayManager.update(e)}render(e){var _;const i=ae(),n=this.canvasManager.getContext("ui"),o=n.canvas,{velocity:l}=this.ship.getTransform(),u=this.ship.getAllBlocks().reduce((z,[se,oe])=>z+oe.type.mass,0);Math.floor(this.ship.getCockpitHp()??0),Math.floor(((_=this.ship.getCockpit())==null?void 0:_.type.armor)??1);const d=Math.sqrt(l.x**2+l.y**2),g=this.ship.getEnergyComponent(),m=Math.floor((g==null?void 0:g.getCurrent())??0),y=Math.floor((g==null?void 0:g.getMax())??0),v=Math.floor(180*i),M=Math.floor(12*i),b=Math.floor(20*i),C=v*2+b,w=Math.floor((o.width-C)/2),A=o.height-Math.floor(24*i),E=this.ship.getAfterburnerComponent(),x=E?E.getCurrent():0,I=E?E.getMax():1;Jp(n,{x:w,y:A,width:v,height:M,value:x/I,label:`${Math.floor(x)} / ${I}`,style:{barColor:"#ffcc00",borderColor:"#ffee88",backgroundColor:"#221800",glow:!0,textColor:"#ffffaa",font:`${Math.floor(11*i)}px "Courier New", monospace`,scanlineIntensity:.3,chromaticAberration:!0,phosphorDecay:!0,cornerBevel:!0,warningThreshold:.25,criticalThreshold:.1,warningColor:"#ffaa00",criticalColor:"#ff0040",animated:!0}},performance.now()),Jp(n,{x:w+v+b,y:A,width:v,height:M,value:y>0?m/y:1,label:`${Math.round(m)} / ${y}`,style:{barColor:"#0af",borderColor:"#6cf",backgroundColor:"#003",glow:!0,textColor:"#9cf",font:`${Math.floor(11*i)}px "Courier New", monospace`,scanlineIntensity:.25,chromaticAberration:!0,phosphorDecay:!0,cornerBevel:!0,warningThreshold:.25,criticalThreshold:.1,warningColor:"#ffaa00",criticalColor:"#ff0040",animated:!0}},performance.now());const D=Math.floor(120*i),N=Math.floor(12*i),H=Math.floor(32*i),W=A-D+Math.floor(14*i);MC(n,{x:H,y:W,width:N,height:D,value:d,maxValue:2e3,style:{barColor:"#00ff41",backgroundColor:"#001100",borderColor:"#00aa33",glow:!0,textColor:"#00ff88",showLabel:!0,unit:"m/s"}});const K=Math.floor(120*i),Z=Math.floor(24*i),Q=Math.floor(64*i),Y=A-Math.floor(12*i);CC(n,{x:Q,y:Y,mode:this.ship.getFiringMode(),style:{width:K,height:Z,backgroundColor:"#000a00",borderColor:"#00ff41",activeColor:"#00ff41",inactiveColor:"#001a00",textColor:"#00ff41",glowColor:"#00ff41",font:`${Math.floor(10*i)}px "Courier New", monospace`,glow:!0,animated:!0,scanlineIntensity:.3,chromaticAberration:!1}},performance.now());const ne=Math.floor(900*i),J=Math.floor(16*i);let ee=Y;Ne(n,ne,ee,`Entropium: ${this.currency}`,{},i),ee+=J,Ne(n,ne,ee,`Mass: ${u.toFixed(1)} kg`,{},i),this.blockQueueDisplayManager.render()}destroy(){var e;(e=this.disposer)==null||e.call(this)}}class xC{constructor(e,i){this.canvasManager=e,this.waveSpawner=i}render(){const e=this.canvasManager.getContext("ui"),i=e.canvas,n=this.waveSpawner.getCurrentWaveNumber(),o=this.waveSpawner.getTimeUntilNextWave(),l=this.waveSpawner.isBossWaveActive(),h=ae(),u=240*h;let d=i.height-36*h;const g=18*h;Ne(e,u,d,`Wave: ${n}`,{},h),d+=g,l?Ne(e,u,d,"Boss Encounter",{},h):Ne(e,u,d,`Next wave in: ${Math.ceil(o)}s`,{},h)}}class _C{constructor(e){this.canvasManager=e,this.messages=[],this.ctx=e.getContext("ui")}displayMessage(e,i){this.messages.push({text:e,duration:(i==null?void 0:i.duration)??3,elapsed:0,color:(i==null?void 0:i.color)??"#00ff00",font:(i==null?void 0:i.font)??"28px monospace",glow:(i==null?void 0:i.glow)??!0,yOffset:0})}update(e){for(const i of this.messages)i.elapsed+=e;this.messages=this.messages.filter(i=>i.elapsed<i.duration)}render(){const e=this.ctx.canvas.width/2,i=this.ctx.canvas.height*.35,n=36;performance.now()/1e3;for(let o=0;o<this.messages.length;o++){const l=this.messages[o],h=l.elapsed/l.duration,u=1-h,d=i-o*n-h*30;Ne(this.ctx,e,d,l.text,{font:l.font,align:"center",alpha:u,glow:l.glow,shadowBlur:0,color:l.color})}}}let tm=0,ca=null;class Ze{constructor(){this.lights=new Map,this.lightPool=[],this.cachedVisibleLights=[],this.lastCameraBounds=null,this.lightsDirty=!0}static getInstance(){return ca||(ca=new Ze),ca}static hasInstance(){return!!ca}registerLight(e){e.id||(e.id=`light_${tm++}`),this.lights.set(e.id,e),this.lightsDirty=!0}removeLight(e){const i=this.lights.get(e);i&&this.recycleLight(i),this.lights.delete(e),this.lightsDirty=!0}clear(){for(const e of this.lights.values())this.recycleLight(e);this.lights.clear(),this.lightsDirty=!0}update(e){for(const[i,n]of this.lights)if(n.life!==void 0&&n.maxLife!==void 0){if(n.life-=e,n.expires&&n.life<=0){this.recycleLight(n),this.lights.delete(i),this.lightsDirty=!0;continue}const o=Math.max(0,n.life/n.maxLife);n.fadeMode==="delayed"?n.animationPhase=o>=.1?1:o/.1:n.animationPhase=o}}collectVisibleLights(e){const i=e.getViewportBounds(),n=!this.lastCameraBounds||i.x!==this.lastCameraBounds.x||i.y!==this.lastCameraBounds.y||i.width!==this.lastCameraBounds.width||i.height!==this.lastCameraBounds.height;if(!this.lightsDirty&&!n)return this.cachedVisibleLights;const o=i.x,l=i.x+i.width,h=i.y,u=i.y+i.height;return this.cachedVisibleLights=Array.from(this.lights.values()).filter(d=>{switch(d.type){case"directional":return!0;case"point":case"spot":{const{x:g,y:m,radius:y}=d;return g+y>o&&g-y<l&&m+y>h&&m-y<u}default:return!0}}),this.lastCameraBounds=i,this.lightsDirty=!1,this.cachedVisibleLights}getLightCount(){return this.lights.size}getActiveLights(){return Array.from(this.lights.values())}getActiveLightEntries(){return Array.from(this.lights.entries())}getLightById(e){return this.lights.get(e)}getPooledLight(){return this.lightPool.pop()??{id:"",x:0,y:0,radius:32,color:"#ffffff",intensity:1,type:"point"}}updateLight(e,i){const n=this.lights.get(e);!n||n.type!=="point"||(Object.assign(n,i),this.lightsDirty=!0)}recycleLight(e){this.isPoolableLight(e)&&(e.id="",e.life=void 0,e.maxLife=void 0,e.animationPhase=void 0,this.lightPool.push(e))}isPoolableLight(e){return e.type==="point"}destroy(){ca===this&&(this.clear(),this.lightPool.length=0,this.cachedVisibleLights.length=0,this.lastCameraBounds=null,ca=null,tm=0)}}class DC{constructor(e,i,n){this.canvasManager=e,this.shipRegistry=i,this.aiOrchestrator=n,this.smoothedFps=60}render(e){var D,N;const i=this.canvasManager.getContext("ui"),n=i.canvas,o=1/e,l=.05;this.smoothedFps+=(o-this.smoothedFps)*l;const h=n.width-300;let u=12;const d=18;Ne(i,h,u,"DEBUG"),u+=d,Ne(i,h,u,`FPS: ${this.smoothedFps.toFixed(1)}`),u+=d;const g=Ze.getInstance(),m=g.getActiveLights(),y=g.collectVisibleLights(ut.getInstance()),v=PC(g,this.shipRegistry,!1),M=m.filter(H=>{var W;return(W=H.id)==null?void 0:W.startsWith("aura-")}).length,b=y.filter(H=>{var W;return(W=H.id)==null?void 0:W.startsWith("aura-")}).length,C=this.shipRegistry.count(),w=Qi.getEnemyPower(),A=Array.from(this.aiOrchestrator.getAllControllers()),E=A.filter(([H])=>H.isFormationLeader()).length,x=A.filter(([H])=>H.isFormationFollower()).length,I=A.filter(([H])=>H.isInFormation()).length;for(const[H]of A)(N=(D=H.getCurrentState())==null?void 0:D.constructor)==null||N.name;Ne(i,h,u,`Ships: ${C}`),u+=d,Ne(i,h,u,`Enemy Power: ${w}`),u+=d,Ne(i,h,u,`Formation: ${I} (Leaders: ${E}, Followers: ${x})`),u+=d,Ne(i,h,u,`Aura Lights: ${M}`),u+=d,Ne(i,h,u,`Visible Aura Lights: ${b}`),u+=d,Ne(i,h,u,`Orphaned Aura Lights: ${v.length}`),u+=d}}function PC(a,e,i=!1){const n=[];for(const[o,l]of a.getActiveLightEntries()){if(!o.startsWith("aura-"))continue;const h=o.substring(5);e.getById(h)!==void 0||(n.push(o),i&&(a.removeLight(o),console.log(`[LightingOrchestrator] Removed orphaned aura light: ${o}`)))}return n}class LC{static createIcon(e,i){const n=document.createElement("canvas");n.width=i,n.height=i;const o=n.getContext("2d");switch(o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",e){case"caution":this.drawCautionIcon(o,i);break;case"greenCross":this.drawGreenCrossIcon(o,i);break;case"skullAndBones":this.drawSkullAndBonesIcon(o,i);break}return n}static drawCautionIcon(e,i){const n=i/2,o=i*.4,l=e.createRadialGradient(n,n,0,n,n,o);l.addColorStop(0,"#ffff00"),l.addColorStop(1,"#ff8800"),e.fillStyle=l,e.strokeStyle="#cc6600",e.lineWidth=i*.05,e.beginPath(),e.moveTo(n,n-o),e.lineTo(n-o*.87,n+o*.5),e.lineTo(n+o*.87,n+o*.5),e.closePath(),e.fill(),e.stroke(),e.fillStyle="#000000",e.font=`bold ${i*.5}px Arial`,e.textAlign="center",e.textBaseline="middle",e.fillText("!",n,n-i*.05)}static drawGreenCrossIcon(e,i){const n=i/2,o=i*.45,l=e.createRadialGradient(n,n,0,n,n,o);l.addColorStop(0,"#00ff88"),l.addColorStop(1,"#00cc44"),e.fillStyle=l,e.strokeStyle="#008833",e.lineWidth=i*.05,e.beginPath(),e.arc(n,n,o,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#ffffff",e.strokeStyle="#ffffff",e.lineWidth=i*.08,e.lineCap="round";const h=i*.25;e.beginPath(),e.moveTo(n,n-h),e.lineTo(n,n+h),e.stroke(),e.beginPath(),e.moveTo(n-h,n),e.lineTo(n+h,n),e.stroke()}static drawSkullAndBonesIcon(e,i){const n=i/2;e.fillStyle="#ffffff",e.strokeStyle="#666666",e.lineWidth=i*.03;const o=i*.4,l=i*.45;e.beginPath(),e.ellipse(n,n-i*.1,o,l,0,0,Math.PI*2),e.fill(),e.stroke(),e.fillStyle="#000000";const h=i*.08,u=i*.12;e.beginPath(),e.arc(n-u,n-i*.15,h,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(n+u,n-i*.15,h,0,Math.PI*2),e.fill(),e.beginPath(),e.moveTo(n,n-i*.05),e.lineTo(n-i*.04,n+i*.05),e.lineTo(n+i*.04,n+i*.05),e.closePath(),e.fill(),e.strokeStyle="#000000",e.lineWidth=i*.02;const d=n+i*.1,g=i*.06;for(let v=-1;v<=1;v++)e.beginPath(),e.moveTo(n+v*g,d),e.lineTo(n+v*g,d+i*.08),e.stroke();e.fillStyle="#dddddd",e.strokeStyle="#999999",e.lineWidth=i*.02;const m=i*.7,y=i*.06;e.save(),e.translate(n,n),e.rotate(Math.PI/4),this.drawBone(e,m,y),e.restore(),e.save(),e.translate(n,n),e.rotate(-Math.PI/4),this.drawBone(e,m,y),e.restore()}static drawBone(e,i,n){const o=n*1.5;e.fillRect(-i/2,-n/2,i,n),e.strokeRect(-i/2,-n/2,i,n),e.beginPath(),e.arc(-i/2,0,o,0,Math.PI*2),e.fill(),e.stroke(),e.beginPath(),e.arc(i/2,0,o,0,Math.PI*2),e.fill(),e.stroke()}}const OC={MINIMAP_TRANSPARENCY:.3};class FC{constructor(e,i,n,o,l=1){this.canvasManager=e,this.player=i,this.aiOrchestrator=n,this.planetSystem=o,this.scale=l,this.baseWidth=220,this.baseHeight=220,this.baseMargin=14,this.animationTime=0,this.scanlineOffset=0,this.lastFrameTime=0,this.incidentMarkers=new Map,this.iconCache=new Map,this.staticCanvas=null,this.staticCtx=null,this.staticCacheValid=!1,this.handleIncidentMarkerAdd=h=>{this.incidentMarkers.set(h.id,h)},this.handleIncidentMarkerClear=({id:h})=>{this.incidentMarkers.delete(h)},this.unsubscribeResolution=ke.getInstance().onResolutionChange(()=>{this.resize(ae())}),this.width=Math.floor(this.baseWidth*this.scale),this.height=Math.floor(this.baseHeight*this.scale),this.margin=Math.floor(this.baseMargin*this.scale),this.initializeStaticCache(),this.enemyMarkers={passive:this.createEnemyDot("#3399ff"),seeking:this.createEnemyDot("#ffbb33"),attacking:this.createEnemyDot("#ff0000"),hunter:this.createEnemyDot("#ff0000")},this.planetMarker=this.createPlanetDot("#00ffff"),this.playerMarker=this.createPlayerMarker(),pe.on("incident:minimap:marker",this.handleIncidentMarkerAdd),pe.on("incident:minimap:clear",this.handleIncidentMarkerClear)}initializeStaticCache(){this.staticCanvas=document.createElement("canvas"),this.staticCanvas.width=this.width+Math.floor(20*this.scale),this.staticCanvas.height=this.height+Math.floor(20*this.scale),this.staticCtx=this.staticCanvas.getContext("2d")}resize(e){this.scale=e,this.width=Math.floor(this.baseWidth*this.scale),this.height=Math.floor(this.baseHeight*this.scale),this.margin=Math.floor(this.baseMargin*this.scale),this.initializeStaticCache(),this.resetAllCaches()}resetAllCaches(){this.staticCacheValid=!1,this.enemyMarkers={passive:this.createEnemyDot("#3399ff"),seeking:this.createEnemyDot("#ffbb33"),attacking:this.createEnemyDot("#ff0000"),hunter:this.createEnemyDot("#ff0000")},this.planetMarker=this.createPlanetDot("#00ffff"),this.playerMarker=this.createPlayerMarker()}renderStaticElements(){if(!this.staticCtx||this.staticCacheValid)return;const e=this.staticCtx,i=Math.floor(10*this.scale),n=Math.floor(10*this.scale);e.clearRect(0,0,this.staticCanvas.width,this.staticCanvas.height),this.drawDiegeticFrame(e,i,n),this.drawCRTBackground(e,i,n),this.drawRadarGrid(e,i,n),this.staticCacheValid=!0}getOrCreateIncidentIcon(e){if(this.iconCache.has(e))return this.iconCache.get(e);const i=Math.floor(18*this.scale),o=["caution","greenCross","skullAndBones"].includes(e)?e:null;let l;if(o)l=LC.createIcon(o,i);else{l=document.createElement("canvas"),l.width=i,l.height=i;const h=l.getContext("2d");h.fillStyle="#ffffff",h.shadowColor="#ffffff",h.shadowBlur=6,h.beginPath(),h.arc(i/2,i/2,i/2.5,0,Math.PI*2),h.fill()}return this.iconCache.set(e,l),l}render(){const e=this.canvasManager.getContext("ui"),i=performance.now(),n=i-this.lastFrameTime;this.lastFrameTime=i,this.animationTime=i,this.scanlineOffset=(this.scanlineOffset+n*.03)%(4*this.scale);const o=e.canvas.width,l=e.canvas.height,h=o-this.width-this.margin,u=l-this.height-this.margin,d=OC.MINIMAP_TRANSPARENCY;e.save(),e.globalAlpha=d,this.renderStaticElements(),this.staticCanvas&&e.drawImage(this.staticCanvas,h-Math.floor(10*this.scale),u-Math.floor(10*this.scale));const g=(this.width-Math.floor(20*this.scale))/gn,m=(this.height-Math.floor(20*this.scale))/ba,y=v=>{const M=v.x-wl.x+gn/2,b=v.y-wl.y+ba/2;return{x:h+Math.floor(10*this.scale)+M*g,y:u+Math.floor(10*this.scale)+b*m}};this.drawPlanets(e,y),this.drawShips(e,y);for(const{x:v,y:M,icon:b}of this.incidentMarkers.values()){const C=y({x:v,y:M}),w=this.getOrCreateIncidentIcon(b),A=Math.floor(w.width/2);e.drawImage(w,C.x-A,C.y-A)}this.drawScanlines(e,h,u),this.drawStatusIndicator(e,h,u),e.restore()}drawDiegeticFrame(e,i,n){const o=Math.floor(2*this.scale),l=Math.floor(8*this.scale);e.strokeStyle="#00ff41",e.lineWidth=o,e.strokeRect(i-o,n-o,this.width+o*2,this.height+o*2),e.strokeStyle="#00ff41",e.lineWidth=Math.max(1,Math.floor(1*this.scale));const h=Math.floor(6*this.scale);e.beginPath(),e.moveTo(i-h,n+l),e.lineTo(i-h,n-h),e.lineTo(i+l,n-h),e.stroke(),e.beginPath(),e.moveTo(i+this.width-l,n-h),e.lineTo(i+this.width+h,n-h),e.lineTo(i+this.width+h,n+l),e.stroke(),e.beginPath(),e.moveTo(i+this.width+h,n+this.height-l),e.lineTo(i+this.width+h,n+this.height+h),e.lineTo(i+this.width-l,n+this.height+h),e.stroke(),e.beginPath(),e.moveTo(i+l,n+this.height+h),e.lineTo(i-h,n+this.height+h),e.lineTo(i-h,n+this.height-l),e.stroke()}drawCRTBackground(e,i,n){const o=e.createLinearGradient(i,n,i,n+this.height);o.addColorStop(0,"#001a00"),o.addColorStop(1,"#000a00"),e.fillStyle=o,e.fillRect(i,n,this.width,this.height)}drawRadarGrid(e,i,n){e.strokeStyle="#00ff4120",e.lineWidth=Math.max(1,Math.floor(1*this.scale));const o=i+this.width/2,l=n+this.height/2,h=Math.min(this.width,this.height)/2-Math.floor(10*this.scale);for(let u=1;u<=2;u++){const d=h*u/2;e.beginPath(),e.arc(o,l,d,0,Math.PI*2),e.stroke()}e.beginPath(),e.moveTo(o,n+Math.floor(10*this.scale)),e.lineTo(o,n+this.height-Math.floor(10*this.scale)),e.moveTo(i+Math.floor(10*this.scale),l),e.lineTo(i+this.width-Math.floor(10*this.scale),l),e.stroke()}drawPlanets(e,i){for(const n of this.planetSystem.getPlanets()){const o=n.getPosition(),l=i(o),h=Math.floor(8*this.scale);e.drawImage(this.planetMarker,l.x-h,l.y-h)}}drawShips(e,i){const n=i(this.player.getTransform().position),o=this.player.getTransform().rotation;for(const[h,u]of this.aiOrchestrator.getAllControllers()){const{position:d}=u.getTransform(),{x:g,y:m}=i(d),y=h.getCurrentStateString(),v=h.isHunter()?this.enemyMarkers.hunter:y==="AttackState"?this.enemyMarkers.attacking:y==="SeekTargetState"?this.enemyMarkers.seeking:this.enemyMarkers.passive,M=Math.floor(4*this.scale);e.drawImage(v,g-M,m-M)}e.save(),e.translate(n.x,n.y),e.rotate(o);const l=Math.floor(8*this.scale);e.drawImage(this.playerMarker,-l,-l),e.restore()}createPlanetDot(e){const i=Math.floor(16*this.scale),n=document.createElement("canvas");n.width=i,n.height=i;const o=n.getContext("2d");return o.fillStyle=e,o.shadowColor=e,o.shadowBlur=Math.floor(8*this.scale),o.beginPath(),o.arc(i/2,i/2,Math.floor(6*this.scale),0,Math.PI*2),o.fill(),n}drawScanlines(e,i,n){e.fillStyle="rgba(0, 255, 65, 0.06)";const o=Math.floor(8*this.scale);for(let l=-this.scanlineOffset;l<this.height;l+=o)n+l>=n&&n+l<n+this.height&&e.fillRect(i,n+l,this.width,Math.max(1,Math.floor(1*this.scale)))}drawStatusIndicator(e,i,n){e.fillStyle="#00ff41",e.shadowColor="#00ff41",e.shadowBlur=Math.floor(4*this.scale),e.beginPath();const o=Math.floor(3*this.scale),l=Math.floor(10*this.scale);e.arc(i+this.width-l,n+l,o,0,Math.PI*2),e.fill();const h=Math.floor(8*this.scale);e.font=`${h}px "Courier New", monospace`,e.fillStyle="#00ff4180",e.textAlign="right",e.textBaseline="bottom",e.shadowBlur=0;const u="1:"+Math.floor(gn/this.width),d=Math.floor(4*this.scale);e.fillText(u,i+this.width-d,n+this.height-d)}invalidateCache(){this.staticCacheValid=!1}createEnemyDot(e){const i=Math.floor(8*this.scale),n=document.createElement("canvas");n.width=i,n.height=i;const o=n.getContext("2d");return o.fillStyle=e,o.shadowColor=e,o.shadowBlur=Math.floor(4*this.scale),o.beginPath(),o.arc(i/2,i/2,Math.floor(2*this.scale),0,Math.PI*2),o.fill(),n}createPlayerMarker(){const e=Math.floor(16*this.scale),i=document.createElement("canvas");i.width=e,i.height=e;const n=i.getContext("2d");n.translate(e/2,e/2),n.rotate(0),n.fillStyle="#ffffff",n.shadowColor="#ffffff",n.shadowBlur=Math.floor(6*this.scale);const o=Math.floor(4*this.scale),l=Math.floor(4*this.scale);return n.beginPath(),n.moveTo(0,-o),n.lineTo(Math.floor(3*this.scale),0),n.lineTo(0,o),n.lineTo(-Math.floor(3*this.scale),0),n.closePath(),n.fill(),n.strokeStyle="#ffffff",n.lineWidth=Math.max(1,Math.floor(1*this.scale)),n.beginPath(),n.moveTo(0,-o),n.lineTo(0,-o-l),n.stroke(),i}destroy(){this.unsubscribeResolution(),pe.off("incident:minimap:marker",this.handleIncidentMarkerAdd),pe.off("incident:minimap:clear",this.handleIncidentMarkerClear),this.incidentMarkers.clear(),this.iconCache.clear()}}function im(a,e,i){const n=a.createShader(e);if(!n)throw new Error("[shaderUtils] Failed to create shader");if(a.shaderSource(n,i),a.compileShader(n),!a.getShaderParameter(n,a.COMPILE_STATUS)){const l=a.getShaderInfoLog(n);throw a.deleteShader(n),new Error(`[shaderUtils] Shader compile error:
${l}

Source:
${i}`)}return n}function UC(a,e,i){const n=a.createProgram();if(!n)throw new Error("[shaderUtils] Failed to create program");if(a.attachShader(n,e),a.attachShader(n,i),a.linkProgram(n),!a.getProgramParameter(n,a.LINK_STATUS)){const l=a.getProgramInfoLog(n);throw a.deleteProgram(n),new Error(`[shaderUtils] Program link error:
${l}`)}return n}function Mt(a,e,i){const n=im(a,a.VERTEX_SHADER,e),o=im(a,a.FRAGMENT_SHADER,i);return UC(a,n,o)}function Wl(a){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]),i=a.createBuffer();return a.bindBuffer(a.ARRAY_BUFFER,i),a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW),i}const NC=`#version 300 es\r
precision mediump float;\r
\r
layout(location = 0) in vec2 aPosition;\r
uniform vec2 uOffset;\r
uniform vec2 uScale;\r
out vec2 vUV;\r
\r
void main() {\r
  vec2 pos = aPosition * uScale + uOffset;\r
  vUV = (aPosition + 1.0) / 2.0;\r
  gl_Position = vec4(pos, 0.0, 1.0);\r
}\r
`,HC=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
uniform sampler2D uTexture;\r
uniform float uAlpha;\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 texColor = texture(uTexture, vUV);\r
  fragColor = vec4(texColor.rgb, texColor.a * uAlpha);\r
}\r
`,ws=2420,sm=.1,WC=1;class GC{constructor(e){this.texture=null,this.currentImageId=null,this.gl=e,this.program=Mt(e,NC,HC),this.quadBuffer=Wl(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.uOffset=e.getUniformLocation(this.program,"uOffset"),this.uScale=e.getUniformLocation(this.program,"uScale"),this.uTexture=e.getUniformLocation(this.program,"uTexture"),this.uAlpha=e.getUniformLocation(this.program,"uAlpha")}async loadImage(e){if(e!==this.currentImageId&&(this.currentImageId=e,this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null),!!e))try{const i=new Image;i.src=wi(`/assets/backgrounds/${e}`),await i.decode();const n=document.createElement("canvas");n.width=i.width,n.height=i.height,n.getContext("2d").drawImage(i,0,0),this.texture=It(this.gl,n)}catch(i){console.warn(`[BackgroundPass] Failed to load background image '${e}'`,i)}}render(e){if(!this.texture)return;const i=this.gl,{width:n,height:o}=i.canvas,l=e.x*sm,h=e.y*sm,u=Math.ceil(n/ws)+2,d=Math.ceil(o/ws)+2,g=Math.floor(l/ws)-1,m=Math.floor(h/ws)-1,y=ws/n,v=ws/o;i.useProgram(this.program),i.bindVertexArray(this.vao),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.uniform1i(this.uTexture,0),i.uniform1f(this.uAlpha,WC);for(let M=0;M<d;M++)for(let b=0;b<u;b++){const C=(g+b)*ws-l,w=(m+M)*ws-h,A=C/n*2,E=-(w/o)*2;i.uniform2f(this.uOffset,A,E),i.uniform2f(this.uScale,y,v),i.drawArrays(i.TRIANGLE_STRIP,0,4)}i.bindVertexArray(null),i.useProgram(null)}destroy(){const e=this.gl;this.texture&&(e.deleteTexture(this.texture),this.texture=null),e.deleteBuffer(this.quadBuffer),e.deleteVertexArray(this.vao),e.deleteProgram(this.program)}}const zC=`#version 300 es\r
precision mediump float;\r
\r
layout(location = 0) in vec2 aPosition;\r
uniform vec2 uOffset;\r
uniform vec2 uScale;\r
out vec2 vUV;\r
\r
void main() {\r
  vec2 pos = aPosition * uScale + uOffset;\r
  vUV = vec2((aPosition.x + 1.0) / 2.0, 1.0 - (aPosition.y + 1.0) / 2.0);\r
  gl_Position = vec4(pos, 0.0, 1.0);\r
}\r
`,XC=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
uniform sampler2D uTexture;\r
uniform float uAlpha;\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 texColor = texture(uTexture, vUV);\r
  fragColor = vec4(texColor.rgb, texColor.a * uAlpha);\r
}\r
`,VC=1,nm=.2;class YC{constructor(e){this.camera=ut.getInstance(),this.planets=new Set,this.textureCache=new Map,this.imageSizeCache=new Map,this.gl=e,this.program=Mt(e,zC,XC),this.quadBuffer=Wl(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.uOffset=e.getUniformLocation(this.program,"uOffset"),this.uScale=e.getUniformLocation(this.program,"uScale"),this.uTexture=e.getUniformLocation(this.program,"uTexture"),this.uAlpha=e.getUniformLocation(this.program,"uAlpha")}addPlanet(e,i,n){this.planets.add({...e,scale:i,imagePath:n}),this.ensureTextureLoaded(n)}async ensureTextureLoaded(e){if(this.textureCache.has(e))return;const i=wi(e),n=new Image;n.src=i,await n.decode();const o=document.createElement("canvas");o.width=n.width,o.height=n.height,o.getContext("2d").drawImage(n,0,0);const l=Kb(this.gl,o);this.textureCache.set(e,l),this.imageSizeCache.set(e,{width:n.width,height:n.height})}renderAll(){const e=this.gl,{width:i,height:n}=e.canvas,o=this.camera.getPosition(),l=this.camera.getZoom();e.viewport(0,0,i,n),e.useProgram(this.program),e.bindVertexArray(this.vao),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);for(const h of this.planets){const u=this.textureCache.get(h.imagePath),d=this.imageSizeCache.get(h.imagePath);if(!u||!d)continue;const g=d.width*h.scale,m=d.height*h.scale;if(!this.isVisible(h.x,h.y,g,m))continue;const y=h.x-o.x,v=h.y-o.y,M=y*l,b=v*l,C=M/(i/2),w=-b/(n/2),A=g*l/i,E=m*l/n;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u),e.uniform1i(this.uTexture,0),e.uniform1f(this.uAlpha,VC),e.uniform2f(this.uOffset,C,w),e.uniform2f(this.uScale,A,E),e.drawArrays(e.TRIANGLE_STRIP,0,4)}e.disable(e.BLEND),e.bindVertexArray(null),e.useProgram(null)}isVisible(e,i,n,o){const l=this.camera.getPosition(),h=this.camera.getZoom(),u=e-n/2,d=e+n/2,g=i-o/2,m=i+o/2,y=this.camera.getViewportWidth()/h,v=this.camera.getViewportHeight()/h,M=y*nm,b=v*nm,C=l.x-y/2-M,w=l.x+y/2+M,A=l.y-v/2-b,E=l.y+v/2+b;return!(d<C||u>w||m<A||g>E)}destroy(){const e=this.gl;for(const i of this.textureCache.values())e.deleteTexture(i);e.deleteBuffer(this.quadBuffer),e.deleteVertexArray(this.vao),e.deleteProgram(this.program)}}function Gl(a){const e=new Float32Array([-1,-1,1,-1,-1,1,1,1]),i=a.createBuffer();if(!i)throw new Error("[bufferUtils] Failed to create VBO");return a.bindBuffer(a.ARRAY_BUFFER,i),a.bufferData(a.ARRAY_BUFFER,e,a.STATIC_DRAW),a.bindBuffer(a.ARRAY_BUFFER,null),i}const qC=`#version 300 es\r
precision mediump float;\r
\r
// Vertex attribute: quad corner position in local space (e.g., [-1,-1] to [1,1])\r
in vec2 a_position;\r
\r
// Output to fragment shader\r
out vec2 vScreenPos;\r
flat out int vInstanceID; // Pass instance index explicitly\r
\r
uniform vec2 uResolution;\r
\r
// Per-light data buffer\r
// Each light occupies 3 vec4s:\r
//   vec4[0] = [x, y, radius, unused]\r
//   vec4[1] = [r, g, b, intensity]\r
//   vec4[2] = [falloff, _, _, _]\r
layout(std140) uniform LightBlock {\r
  vec4 uLightData[30000];\r
};\r
\r
void main() {\r
  int idx = gl_InstanceID;\r
\r
  vec2 lightPos = uLightData[idx * 3 + 0].xy;\r
  float radius  = uLightData[idx * 3 + 0].z;\r
\r
  vec2 scaled   = a_position * radius;\r
  vec2 position = lightPos + scaled;\r
\r
  vec2 clip = (position / uResolution) * 2.0 - 1.0;\r
  clip.y = -clip.y; // Flip Y for screen-space\r
\r
  gl_Position = vec4(clip, 0.0, 1.0);\r
  vScreenPos = position;\r
  vInstanceID = idx;\r
}\r
`,jC=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vScreenPos;\r
flat in int vInstanceID;\r
out vec4 fragColor;\r
\r
// Per-light data buffer\r
// Each light occupies 3 vec4s:\r
//   vec4[0] = [x, y, radius, unused]\r
//   vec4[1] = [r, g, b, intensity]\r
//   vec4[2] = [falloff, _, _, _]\r
layout(std140) uniform LightBlock {\r
  vec4 uLightData[30000]; // 5000 lights * 3 vec4s\r
};\r
\r
void main() {\r
  int idx = vInstanceID;\r
\r
  vec2  lightPos     = uLightData[idx * 3 + 0].xy;\r
  float radius       = uLightData[idx * 3 + 0].z;\r
\r
  vec3  color        = uLightData[idx * 3 + 1].rgb;\r
  float intensity    = uLightData[idx * 3 + 1].a;\r
\r
  float falloffParam = uLightData[idx * 3 + 2].x;\r
\r
  float dist     = distance(vScreenPos, lightPos);\r
  float normDist = clamp(dist / radius, 0.0, 1.0);\r
  float falloff  = pow(1.0 - normDist, 2.0) * falloffParam;\r
\r
  if (falloff < 0.001) discard;\r
\r
  fragColor = vec4(color * falloff * intensity, 0.0); // Alpha unused in additive blend\r
}\r
`,KC=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/lightingPassBeam.vert\r
\r
// Beam Vertex Shader - WebGL 2 version\r
in vec2 position;\r
out vec2 vPosition;\r
\r
void main() {\r
  vPosition = position * 0.5 + 0.5;\r
  gl_Position = vec4(position, 0.0, 1.0);\r
}`,ZC=`#version 300 es\r
\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/lightingPassBeam.frag\r
\r
// Beam Fragment Shader - WebGL 2 version\r
in vec2 vPosition;\r
\r
uniform vec2 uStart;\r
uniform vec2 uEnd;\r
uniform float uWidth;\r
uniform vec4 uColor;\r
uniform float uIntensity;\r
uniform float uFalloff;\r
uniform vec2 uResolution;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // Convert UV coordinates to pixel coordinates\r
  vec2 fragPos = vPosition * uResolution;\r
  \r
  // Compute beam vector\r
  vec2 beamDir = uEnd - uStart;\r
  float beamLength = length(beamDir);\r
  \r
  // Handle degenerate case (zero-length beam)\r
  if (beamLength < 0.001) {\r
    fragColor = vec4(0.0);\r
    return;\r
  }\r
  \r
  vec2 normDir = beamDir / beamLength;\r
\r
  // Project fragment onto beam axis\r
  vec2 delta = fragPos - uStart;\r
  float t = clamp(dot(delta, normDir), 0.0, beamLength);\r
\r
  // Closest point on beam line segment\r
  vec2 closest = uStart + t * normDir;\r
  float dist = length(fragPos - closest);\r
\r
  // Gaussian falloff based on distance from beam centerline\r
  float falloff = exp(-pow(dist / max(uWidth, 0.1), 2.0)) * uFalloff;\r
\r
  vec4 finalColor = uColor * falloff * uIntensity;\r
  finalColor.a = falloff;\r
\r
  fragColor = finalColor;\r
}`,QC=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/lightingPassPost.vert\r
\r
// Post-processing Vertex Shader - WebGL 2 version\r
in vec2 position;\r
out vec2 vUV;\r
\r
void main() {\r
  vUV = position * 0.5 + 0.5;\r
  gl_Position = vec4(position, 0.0, 1.0);\r
}`,$C=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
uniform sampler2D uTexture;\r
uniform float uMaxBrightness;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 color = texture(uTexture, vUV);\r
\r
  // Skip blending in pixels with no light contribution\r
  if (max(color.r, max(color.g, color.b)) < 0.001) {\r
    discard;\r
  }\r
\r
  // Brightness capping (ITU-R BT.709 luminance weighting)\r
  float brightness = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));\r
  if (brightness > uMaxBrightness) {\r
    color.rgb *= uMaxBrightness / brightness;\r
  }\r
\r
  fragColor = color;\r
}\r
`,am=1e4,bu=12,om=2;class JC{constructor(e,i){this.ambientLight=[.2,.2,.25],this.framebufferWidth=0,this.framebufferHeight=0,this.framebufferDirty=!0,this.resolutionScale=.2,this.clearColor=[0,0,0,0],this.maxBrightness=1,this.gl=e,this.cameraUBO=i,this.lightProgram=Mt(e,qC,jC),this.beamProgram=Mt(e,KC,ZC),this.postProgram=Mt(e,QC,$C),this.quadBuffer=Gl(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.lightUBO=e.createBuffer(),this.lightData=new Float32Array(am*bu),e.bindBuffer(e.UNIFORM_BUFFER,this.lightUBO),e.bufferData(e.UNIFORM_BUFFER,this.lightData.byteLength,e.DYNAMIC_DRAW),e.bindBufferBase(e.UNIFORM_BUFFER,om,this.lightUBO);const n=e.getUniformBlockIndex(this.lightProgram,"LightBlock");n!==e.INVALID_INDEX&&e.uniformBlockBinding(this.lightProgram,n,om),this.colorTexture=e.createTexture(),this.framebuffer=e.createFramebuffer(),this.initializeFramebuffer(),this.compositeTexture=e.createTexture(),this.compositeFramebuffer=e.createFramebuffer(),this.initializeCompositeFramebuffer()}initializeFramebuffer(){const e=this.gl,i=Math.max(1,Math.floor(e.drawingBufferWidth*this.resolutionScale)),n=Math.max(1,Math.floor(e.drawingBufferHeight*this.resolutionScale));this.framebufferWidth=i,this.framebufferHeight=n,e.bindTexture(e.TEXTURE_2D,this.colorTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.colorTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindTexture(e.TEXTURE_2D,null)}initializeCompositeFramebuffer(){const e=this.gl;e.bindTexture(e.TEXTURE_2D,this.compositeTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.framebufferWidth,this.framebufferHeight,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this.compositeFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.compositeTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}generateLightBuffer(e,i){const n=this.gl;this.framebufferDirty&&(this.initializeFramebuffer(),this.framebufferDirty=!1),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),n.viewport(0,0,this.framebufferWidth,this.framebufferHeight),n.clearColor(...this.clearColor),n.clear(n.COLOR_BUFFER_BIT),n.blendFunc(n.ONE,n.ONE),n.enable(n.BLEND),n.bindVertexArray(this.vao);let o=0;for(const l of e){if(l.type!=="point")continue;if(o>=am)break;const h=i.worldToScreen(l.x,l.y),u=h.x*this.resolutionScale,d=h.y*this.resolutionScale,g=o*bu,[m,y,v,M]=this.hexToRgbaVec4(l.color);this.lightData[g+0]=u,this.lightData[g+1]=d,this.lightData[g+2]=l.radius*i.getZoom()*this.resolutionScale,this.lightData[g+3]=0,this.lightData[g+4]=m,this.lightData[g+5]=y,this.lightData[g+6]=v,this.lightData[g+7]=l.intensity,this.lightData[g+8]=l.animationPhase??1,this.lightData[g+9]=0,this.lightData[g+10]=0,this.lightData[g+11]=0,o++}n.bindBuffer(n.UNIFORM_BUFFER,this.lightUBO),n.bufferSubData(n.UNIFORM_BUFFER,0,this.lightData.subarray(0,o*bu)),n.useProgram(this.lightProgram),n.uniform2f(n.getUniformLocation(this.lightProgram,"uResolution"),this.framebufferWidth,this.framebufferHeight),n.drawArraysInstanced(n.TRIANGLE_STRIP,0,4,o);for(const l of e){if(l.type!=="beam")continue;n.useProgram(this.beamProgram),n.uniform2f(n.getUniformLocation(this.beamProgram,"uResolution"),this.framebufferWidth,this.framebufferHeight);const h=i.worldToScreen(l.start.x,l.start.y),u=i.worldToScreen(l.end.x,l.end.y),d=h.x*this.resolutionScale,g=this.framebufferHeight-h.y*this.resolutionScale,m=u.x*this.resolutionScale,y=this.framebufferHeight-u.y*this.resolutionScale;n.uniform2f(n.getUniformLocation(this.beamProgram,"uStart"),d,g),n.uniform2f(n.getUniformLocation(this.beamProgram,"uEnd"),m,y),n.uniform1f(n.getUniformLocation(this.beamProgram,"uWidth"),l.width*i.getZoom()*this.resolutionScale),n.uniform4fv(n.getUniformLocation(this.beamProgram,"uColor"),this.hexToRgbaVec4(l.color)),n.uniform1f(n.getUniformLocation(this.beamProgram,"uIntensity"),l.intensity),n.uniform1f(n.getUniformLocation(this.beamProgram,"uFalloff"),l.animationPhase??1),n.drawArrays(n.TRIANGLE_STRIP,0,4)}return n.disable(n.BLEND),n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),this.colorTexture}compositeLightingOverTarget(e){const i=this.gl;i.bindFramebuffer(i.FRAMEBUFFER,e),i.viewport(0,0,i.drawingBufferWidth,i.drawingBufferHeight),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE),i.useProgram(this.postProgram),i.bindVertexArray(this.vao),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.colorTexture),i.uniform1i(i.getUniformLocation(this.postProgram,"uTexture"),0),i.uniform1f(i.getUniformLocation(this.postProgram,"uMaxBrightness"),this.maxBrightness),i.drawArrays(i.TRIANGLE_STRIP,0,4),i.disable(i.BLEND),i.bindFramebuffer(i.FRAMEBUFFER,null)}setAmbientLight(e){this.ambientLight=e}getAmbientLight(){return this.ambientLight}resize(){this.framebufferDirty=!0}destroy(){const e=this.gl;e.deleteProgram(this.lightProgram),e.deleteProgram(this.beamProgram),e.deleteProgram(this.postProgram),e.deleteBuffer(this.quadBuffer),e.deleteFramebuffer(this.framebuffer),e.deleteTexture(this.colorTexture),e.deleteVertexArray(this.vao),e.deleteBuffer(this.lightUBO),e.deleteFramebuffer(this.compositeFramebuffer),e.deleteTexture(this.compositeTexture)}hexToRgbaVec4(e){e.startsWith("#")&&(e=e.slice(1));const i=parseInt(e.slice(0,2),16)/255,n=parseInt(e.slice(2,4),16)/255,o=parseInt(e.slice(4,6),16)/255,l=e.length===8?parseInt(e.slice(6,8),16)/255:1;return[i,n,o,l]}}function eT(a){switch(a){case an.LIGHT:return Do.FRACTURED;case an.MODERATE:case an.HEAVY:return Do.CRUMBLING;case an.NONE:default:return Do.NONE}}function tT(a,e){if(oi(a))return wm(a,e);if(Rm(a))return RS(a,eT(e));throw new Error(`Unrecognized block typeId: ${a}`)}const iT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 position;\r
\r
layout(std140) uniform CameraBlock {\r
  mat4 uProjectionMatrix;\r
  mat4 uViewMatrix;\r
};\r
\r
uniform mat4 uModelMatrix;\r
uniform vec2 uBlockPosition;\r
uniform float uBlockRotation;\r
uniform vec2 uBlockScale;\r
\r
out vec2 vUV;\r
out vec2 vScreenUV;\r
\r
void main() {\r
  vUV = vec2(position.x * 0.5 + 0.5, 1.0 - (position.y * 0.5 + 0.5));\r
\r
  vec2 scaledPosition = position * uBlockScale * 0.5;\r
  vec2 flippedPosition = vec2(scaledPosition.x, -scaledPosition.y);\r
\r
  float cos_rot = cos(uBlockRotation);\r
  float sin_rot = sin(uBlockRotation);\r
  vec2 rotatedPosition = vec2(\r
    flippedPosition.x * cos_rot - flippedPosition.y * sin_rot,\r
    flippedPosition.x * sin_rot + flippedPosition.y * cos_rot\r
  );\r
\r
  vec2 blockWorldPosition = rotatedPosition + uBlockPosition;\r
\r
  vec4 worldPos = uModelMatrix * vec4(blockWorldPosition, 0.0, 1.0);\r
  vec4 viewPos = uViewMatrix * worldPos;\r
  gl_Position = uProjectionMatrix * viewPos;\r
\r
  // derive screen UV from clip-space coordinates\r
  vScreenUV = gl_Position.xy / gl_Position.w * 0.5 + 0.5;\r
}\r
`,sT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
in vec2 vScreenUV; // passed from vertex shader\r
out vec4 outColor;\r
\r
uniform sampler2D uTexture;\r
uniform sampler2D uLightMap;\r
\r
uniform float uTime;\r
uniform float uGlowStrength;\r
uniform float uEnergyPulse;\r
uniform vec3 uChargeColor;\r
uniform float uSheenStrength;\r
uniform vec3 uCollisionColor;\r
uniform bool uUseCollisionColor;\r
uniform vec3 uAmbientLight;\r
\r
void main() {\r
  vec4 base = texture(uTexture, vUV);\r
  if (base.a < 0.01) discard;\r
\r
  // === Lightmap Sampling ===\r
  vec3 lightSample = texture(uLightMap, vScreenUV).rgb;\r
  vec3 effectiveLight = max(lightSample, uAmbientLight); // clamp floor\r
  \r
  // Darken base by ambient light floor\r
  vec3 ambiented = base.rgb * uAmbientLight;\r
\r
  // Modulate with light texture\r
  vec3 modulated = base.rgb * lightSample;\r
\r
  // Additive bloom-style wrap lighting\r
  vec3 additive = lightSample * 0.7;\r
\r
  // Final mix: ambient base + modulated + additive bloom\r
  base.rgb = ambiented + modulated * 0.6 + additive * 0.4;\r
\r
  // === Radial Charge Bloom ===\r
  vec2 centeredUV = vUV - 0.5;\r
  float dist = length(centeredUV);\r
\r
  float wavePhase = uTime * 3.0 - dist * 8.0;\r
  float pulse = sin(wavePhase) * 0.5 + 0.5;\r
  pulse = pow(pulse, 2.0);\r
\r
  float innerRadius = 0.1;\r
  float outerRadius = 0.4;\r
  float falloff = 1.0 - smoothstep(innerRadius, outerRadius, dist);\r
  falloff = pow(falloff, 1.5);\r
\r
  float energy = pulse * falloff * uEnergyPulse;\r
  base.rgb += uChargeColor * energy * 0.8;\r
\r
  // === Pulsating Glow ===\r
  float breathe = sin(uTime * 2.5) * 0.3 + 0.7;\r
  breathe = smoothstep(0.4, 1.0, breathe);\r
  base.rgb += base.rgb * uGlowStrength * breathe * 0.3;\r
\r
  // === Metallic Sheen ===\r
  if (uSheenStrength > 0.0) {\r
    vec2 centeredUV = vUV - 0.5;\r
    float dist = length(centeredUV);\r
\r
    float radialFalloff = 1.0 - smoothstep(0.0, 0.7, dist);\r
    radialFalloff = pow(radialFalloff, 0.8);\r
\r
    float noise = sin(vUV.x * 12.0) * sin(vUV.y * 8.0) * 0.1 + 0.9;\r
\r
    float metallic = radialFalloff * noise;\r
\r
    vec3 metallicColor = base.rgb * 1.2 + vec3(0.05, 0.05, 0.1);\r
    base.rgb = mix(base.rgb, metallicColor, uSheenStrength * metallic * 0.3);\r
\r
    base.rgb += uSheenStrength * metallic * 0.15;\r
  }\r
\r
  // === Collision Red Override ===\r
  if (uUseCollisionColor) {\r
    base.rgb = uCollisionColor;\r
  }\r
\r
  outColor = base;\r
}\r
`;function ny(a,e,i,n){const o=e-a,l=n-i;return new Float32Array([2/o,0,0,0,0,2/l,0,0,0,0,-1,0,-(e+a)/o,-(n+i)/l,0,1])}function Ju(a,e){return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,a,e,0,1])}function nT(a){const e=Math.cos(a),i=Math.sin(a);return new Float32Array([e,i,0,0,-i,e,0,0,0,0,1,0,0,0,0,1])}function aT(a,e){const i=new Float32Array(16);for(let n=0;n<4;n++)for(let o=0;o<4;o++)i[n*4+o]=a[n*4+0]*e[0*4+o]+a[n*4+1]*e[1*4+o]+a[n*4+2]*e[2*4+o]+a[n*4+3]*e[3*4+o];return i}function oT(a){return a==="battery1"||a==="reactor1"||a==="shield1"?[.2,.6,1]:a==="battery2"||a==="reactor2"||a==="shield3"?[.8,.5,1]:a==="shield2"?[.3,1,.4]:null}function rT(a){return a.startsWith("hull")||a.startsWith("fin")||a.startsWith("faceplate")||a.startsWith("engine")}class lT{constructor(e,i){this.inputManager=i,this.ambientLight=[.2,.2,.25],this.shipModelMatrix=new Float32Array(16),this.gl=e,this.program=Mt(e,iT,sT);const n=e.getUniformBlockIndex(this.program,"CameraBlock");n!==e.INVALID_INDEX&&e.uniformBlockBinding(this.program,n,0),this.quadBuffer=Wl(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null),this.uniforms={uModelMatrix:e.getUniformLocation(this.program,"uModelMatrix"),uBlockPosition:e.getUniformLocation(this.program,"uBlockPosition"),uBlockRotation:e.getUniformLocation(this.program,"uBlockRotation"),uBlockScale:e.getUniformLocation(this.program,"uBlockScale"),uTexture:e.getUniformLocation(this.program,"uTexture"),uLightMap:e.getUniformLocation(this.program,"uLightMap"),uTime:e.getUniformLocation(this.program,"uTime"),uGlowStrength:e.getUniformLocation(this.program,"uGlowStrength"),uEnergyPulse:e.getUniformLocation(this.program,"uEnergyPulse"),uChargeColor:e.getUniformLocation(this.program,"uChargeColor"),uSheenStrength:e.getUniformLocation(this.program,"uSheenStrength"),uCollisionColor:e.getUniformLocation(this.program,"uCollisionColor"),uUseCollisionColor:e.getUniformLocation(this.program,"uUseCollisionColor"),uAmbientLight:e.getUniformLocation(this.program,"uAmbientLight")}}render(e,i,n){const{gl:o}=this,l=performance.now()/1e3;o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.useProgram(this.program),o.bindVertexArray(this.vao),o.enable(o.BLEND),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.uniform1f(this.uniforms.uTime,l),o.uniform3f(this.uniforms.uAmbientLight,...this.ambientLight),o.activeTexture(o.TEXTURE1),o.bindTexture(o.TEXTURE_2D,i),o.uniform1i(this.uniforms.uLightMap,1);let h={x:0,y:0};if(this.inputManager){const u=this.inputManager.getMousePosition();h=n.screenToWorld(u.x,u.y)}for(const u of e){const{position:d,rotation:g}=u.getTransform();this.shipModelMatrix=aT(nT(g),Ju(d.x,d.y)),o.uniformMatrix4fv(this.uniforms.uModelMatrix,!1,this.shipModelMatrix),o.uniform1i(this.uniforms.uUseCollisionColor,0);for(const[m,y]of u.getAllBlocks()){if(y.hidden)continue;const v=y.type.armor??1,M=cS(y.hp,v),b=tT(y.type.id,M),C=m.x*X,w=m.y*X,A=(y.rotation??0)*(Math.PI/180);o.uniform2f(this.uniforms.uBlockPosition,C,w),o.uniform1f(this.uniforms.uBlockRotation,A),o.uniform2f(this.uniforms.uBlockScale,X,X);const E=oT(y.type.id),x=E?Math.sin(l*6)*.5+.5:0,I=y.type.id.startsWith("cockpit")?1:0,D=rT(y.type.id)?1:0;if(o.uniform1f(this.uniforms.uEnergyPulse,x),o.uniform1f(this.uniforms.uGlowStrength,I),o.uniform1f(this.uniforms.uSheenStrength,D),o.uniform3f(this.uniforms.uChargeColor,...E??[0,0,0]),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,b.base),o.uniform1i(this.uniforms.uTexture,0),o.drawArrays(o.TRIANGLE_STRIP,0,4),b.overlay&&this.inputManager){const N=d.x+C*Math.cos(g)-w*Math.sin(g),H=d.y+C*Math.sin(g)+w*Math.cos(g),W=h.x-N,K=h.y-H,Q=Math.atan2(K,W)-g+Math.PI/2;o.uniform1f(this.uniforms.uBlockRotation,Q),o.uniform2f(this.uniforms.uBlockPosition,C,w),o.bindTexture(o.TEXTURE_2D,b.overlay),o.drawArrays(o.TRIANGLE_STRIP,0,4),o.uniform1f(this.uniforms.uBlockRotation,A)}}}o.disable(o.BLEND),o.bindVertexArray(null),o.useProgram(null)}setAmbientLight(e){this.ambientLight=e}destroy(){const{gl:e}=this;e.isProgram(this.program)&&e.deleteProgram(this.program),e.isBuffer(this.quadBuffer)&&e.deleteBuffer(this.quadBuffer),e.isVertexArray(this.vao)&&e.deleteVertexArray(this.vao)}}const cT=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/particlePass.vert\r
\r
layout(location = 0) in vec2 aPosition;\r
layout(location = 1) in vec2 aParticlePos;\r
layout(location = 2) in float aSize;\r
layout(location = 3) in float aLifeRatio;\r
layout(location = 4) in vec3 aColor;\r
\r
layout(std140) uniform CameraMatrices {\r
  mat4 uProjectionMatrix;\r
  mat4 uViewMatrix;\r
};\r
\r
out float vAlpha;\r
out vec3 vColor;\r
\r
void main() {\r
  vec2 scaled = aPosition * aSize;\r
  vec2 world = scaled + aParticlePos;\r
  gl_Position = uProjectionMatrix * uViewMatrix * vec4(world, 0.0, 1.0);\r
  vAlpha = aLifeRatio;\r
  vColor = aColor;\r
}\r
`,hT=`#version 300 es\r
precision mediump float;\r
\r
// src/rendering/unified/shaders/particlePass.frag\r
\r
in float vAlpha;\r
in vec3 vColor;\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = vec4(vColor, vAlpha);\r
}\r
`;function uT(a){a.startsWith("#")&&(a=a.slice(1));const e=parseInt(a.slice(0,2),16)/255,i=parseInt(a.slice(2,4),16)/255,n=parseInt(a.slice(4,6),16)/255;return[e,i,n]}class fT{constructor(e,i){this.gl=e,this.program=Mt(e,cT,hT),this.quadBuffer=Gl(e),this.instanceBuffer=e.createBuffer(),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.vertexAttribDivisor(0,0),e.bindBuffer(e.ARRAY_BUFFER,this.instanceBuffer);const n=7*4;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,n,0),e.vertexAttribDivisor(1,1),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,1,e.FLOAT,!1,n,8),e.vertexAttribDivisor(2,1),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,n,12),e.vertexAttribDivisor(3,1),e.enableVertexAttribArray(4),e.vertexAttribPointer(4,3,e.FLOAT,!1,n,16),e.vertexAttribDivisor(4,1),e.bindVertexArray(null);const o=e.getUniformBlockIndex(this.program,"CameraMatrices");o!==e.INVALID_INDEX&&e.uniformBlockBinding(this.program,o,0)}render(e,i){const n=this.gl;if(e.length===0)return;const o=7,l=new Float32Array(e.length*o);for(let h=0;h<e.length;h++){const u=e[h],d=h*o,[g,m,y]=uT(u.color);l.set([u.x,u.y,u.size,u.renderAlpha??1,g,m,y],d)}n.bindBuffer(n.ARRAY_BUFFER,this.instanceBuffer),n.bufferData(n.ARRAY_BUFFER,l,n.DYNAMIC_DRAW),n.useProgram(this.program),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE),n.bindVertexArray(this.vao),n.drawArraysInstanced(n.TRIANGLE_STRIP,0,4,e.length),n.bindVertexArray(null),n.disable(n.BLEND),n.useProgram(null)}destroy(){const e=this.gl;e.deleteProgram(this.program),e.deleteBuffer(this.quadBuffer),e.deleteBuffer(this.instanceBuffer),e.deleteVertexArray(this.vao)}}const dT=`#version 300 es\r
precision mediump float;\r
\r
// === Attribute Bindings ===\r
// Quad vertex position (static)\r
layout(location = 0) in vec2 aPosition;\r
\r
// Per-instance attributes\r
layout(location = 1) in vec2 aInstancePos;     // world-space center\r
layout(location = 2) in vec2 aInstanceSize;    // world-space size\r
layout(location = 3) in float aInstanceAlpha;  // transparency\r
layout(location = 4) in float aInstanceRotation; // rotation in radians\r
\r
// === Uniform block for camera ===\r
layout(std140) uniform CameraMatrices {\r
  mat4 uProjectionMatrix;\r
  mat4 uViewMatrix;\r
};\r
\r
out vec2 vUV;\r
out float vAlpha;\r
\r
void main() {\r
  // Apply rotation to the quad vertex position\r
  float cosR = cos(aInstanceRotation);\r
  float sinR = sin(aInstanceRotation);\r
  \r
  // Rotate the position around the origin\r
  vec2 rotatedPos = vec2(\r
    aPosition.x * cosR - aPosition.y * sinR,\r
    aPosition.x * sinR + aPosition.y * cosR\r
  );\r
  \r
  // Scale and translate to world position\r
  vec2 scaled = rotatedPos * aInstanceSize;\r
  vec2 world = scaled + aInstancePos;\r
\r
  gl_Position = uProjectionMatrix * uViewMatrix * vec4(world, 0.0, 1.0);\r
\r
  // UVs range from (0,0) bottom-left to (1,1) top-right\r
  vUV = vec2((aPosition.x + 1.0) * 0.5, 1.0 - (aPosition.y + 1.0) * 0.5);\r
  vAlpha = aInstanceAlpha;\r
}\r
`,gT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUV;\r
in float vAlpha;\r
\r
uniform sampler2D uTexture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 texColor = texture(uTexture, vUV);\r
  fragColor = vec4(texColor.rgb, texColor.a * vAlpha);\r
}\r
`,As=class As{constructor(e,i){this.gl=e,this.program=Mt(e,dT,gT),this.vao=e.createVertexArray(),this.quadBuffer=Gl(e),this.instanceBuffer=e.createBuffer(),this.instanceCapacity=256,this.instanceData=new Float32Array(this.instanceCapacity*As.INSTANCE_FLOATS),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.vertexAttribDivisor(0,0),e.bindBuffer(e.ARRAY_BUFFER,this.instanceBuffer);const n=As.INSTANCE_FLOATS*4;e.enableVertexAttribArray(1),e.vertexAttribPointer(1,2,e.FLOAT,!1,n,0),e.vertexAttribDivisor(1,1),e.enableVertexAttribArray(2),e.vertexAttribPointer(2,2,e.FLOAT,!1,n,8),e.vertexAttribDivisor(2,1),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,1,e.FLOAT,!1,n,16),e.vertexAttribDivisor(3,1),e.enableVertexAttribArray(4),e.vertexAttribPointer(4,1,e.FLOAT,!1,n,20),e.vertexAttribDivisor(4,1),e.bindVertexArray(null);const o=e.getUniformBlockIndex(this.program,"CameraMatrices");o!==e.INVALID_INDEX&&e.uniformBlockBinding(this.program,o,0),this.uTexture=e.getUniformLocation(this.program,"uTexture")}renderBatch(e,i){if(i.length===0)return;const n=this.gl,l=1/ae();if(i.length>this.instanceCapacity){for(;this.instanceCapacity<i.length;)this.instanceCapacity*=2;this.instanceData=new Float32Array(this.instanceCapacity*As.INSTANCE_FLOATS)}for(let h=0;h<i.length;h++){const u=i[h],d=h*As.INSTANCE_FLOATS,g=u.widthPx*l,m=u.heightPx*l;this.instanceData[d+0]=u.worldX,this.instanceData[d+1]=u.worldY,this.instanceData[d+2]=g,this.instanceData[d+3]=m,this.instanceData[d+4]=u.alpha,this.instanceData[d+5]=u.rotation}n.bindBuffer(n.ARRAY_BUFFER,this.instanceBuffer),n.bufferData(n.ARRAY_BUFFER,this.instanceData.subarray(0,i.length*As.INSTANCE_FLOATS),n.DYNAMIC_DRAW),n.useProgram(this.program),n.bindVertexArray(this.vao),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.uTexture,0),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.drawArraysInstanced(n.TRIANGLE_STRIP,0,4,i.length),n.disable(n.BLEND),n.bindTexture(n.TEXTURE_2D,null),n.bindVertexArray(null),n.useProgram(null)}destroy(){const e=this.gl;e.deleteProgram(this.program),e.deleteBuffer(this.quadBuffer),e.deleteBuffer(this.instanceBuffer),e.deleteVertexArray(this.vao)}};As.INSTANCE_FLOATS=6;let xu=As;const ha=`#version 300 es\r
layout(location = 0) in vec2 aPosition;\r
out vec2 vUv;\r
\r
void main() {\r
  vUv = (aPosition + 1.0) * 0.5;\r
  gl_Position = vec4(aPosition, 0.0, 1.0);\r
}\r
`,pT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
\r
void main() {\r
  vec4 color = texture(uTexture, vUv);\r
  float avg = dot(color.rgb, vec3(0.333));\r
  fragColor = vec4(vec3(avg), color.a);\r
}\r
`,mT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
uniform vec2 uResolution;\r
uniform float uThreshold; // Brightness threshold (default: 0.7)\r
uniform float uIntensity; // Bloom intensity (default: 0.8)\r
uniform float uBlurSize; // Blur radius (default: 3.0)\r
\r
void main() {\r
    vec2 texelSize = 1.0 / uResolution;\r
    \r
    // Sample the original color\r
    vec4 originalColor = texture(uTexture, vUv);\r
    \r
    // Extract bright areas first\r
    float brightness = dot(originalColor.rgb, vec3(0.299, 0.587, 0.114));\r
    vec3 brightColor = originalColor.rgb;\r
    \r
    // Soft threshold with smooth falloff\r
    float bloomContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, brightness);\r
    brightColor *= bloomContribution;\r
    \r
    // Large radius blur using multiple rings\r
    vec3 bloomColor = vec3(0.0);\r
    float totalWeight = 0.0;\r
    \r
    // Ring 1: Inner samples (weight 4.0)\r
    for (int i = 0; i < 8; i++) {\r
        float angle = float(i) * 0.785398163; // 45 degrees in radians\r
        vec2 offset = vec2(cos(angle), sin(angle)) * texelSize * uBlurSize * 0.5;\r
        vec4 sampleColor = texture(uTexture, vUv + offset);\r
        float sampleBrightness = dot(sampleColor.rgb, vec3(0.299, 0.587, 0.114));\r
        float sampleContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, sampleBrightness);\r
        bloomColor += sampleColor.rgb * sampleContribution * 4.0;\r
        totalWeight += 4.0;\r
    }\r
    \r
    // Ring 2: Middle samples (weight 2.0)\r
    for (int i = 0; i < 16; i++) {\r
        float angle = float(i) * 0.392699082; // 22.5 degrees in radians\r
        vec2 offset = vec2(cos(angle), sin(angle)) * texelSize * uBlurSize * 1.0;\r
        vec4 sampleColor = texture(uTexture, vUv + offset);\r
        float sampleBrightness = dot(sampleColor.rgb, vec3(0.299, 0.587, 0.114));\r
        float sampleContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, sampleBrightness);\r
        bloomColor += sampleColor.rgb * sampleContribution * 2.0;\r
        totalWeight += 2.0;\r
    }\r
    \r
    // Ring 3: Outer samples (weight 1.0)\r
    for (int i = 0; i < 24; i++) {\r
        float angle = float(i) * 0.261799388; // 15 degrees in radians\r
        vec2 offset = vec2(cos(angle), sin(angle)) * texelSize * uBlurSize * 2.0;\r
        vec4 sampleColor = texture(uTexture, vUv + offset);\r
        float sampleBrightness = dot(sampleColor.rgb, vec3(0.299, 0.587, 0.114));\r
        float sampleContribution = smoothstep(uThreshold - 0.1, uThreshold + 0.1, sampleBrightness);\r
        bloomColor += sampleColor.rgb * sampleContribution * 1.0;\r
        totalWeight += 1.0;\r
    }\r
    \r
    // Add center sample\r
    bloomColor += brightColor * 6.0;\r
    totalWeight += 6.0;\r
    \r
    // Normalize and apply intensity\r
    bloomColor = (bloomColor / totalWeight) * uIntensity;\r
    \r
    // Combine original with bloom using screen blend mode for more realistic glow\r
    vec3 finalColor = originalColor.rgb + bloomColor;\r
    finalColor = finalColor / (1.0 + bloomColor); // Tone mapping to prevent oversaturation\r
    \r
    fragColor = vec4(finalColor, originalColor.a);\r
}`,yT=`#version 300 es\r
precision mediump float;\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
// src/rendering/unified/shaders/postprocess/sepia.frag\r
\r
uniform sampler2D uTexture;\r
\r
void main() {\r
  vec4 color = texture(uTexture, vUv);\r
  float r = dot(color.rgb, vec3(0.393, 0.769, 0.189));\r
  float g = dot(color.rgb, vec3(0.349, 0.686, 0.168));\r
  float b = dot(color.rgb, vec3(0.272, 0.534, 0.131));\r
  fragColor = vec4(r, g, b, color.a);\r
}\r
`,vT=`#version 300 es\r
// src/rendering/unified/shaders/postprocess/passthrough.frag\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
\r
void main() {\r
  fragColor = texture(uTexture, vUv);\r
}\r
`,bT=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
uniform float uStrength; // Aberration strength (default: 0.003)\r
uniform float uFalloff; // Distance falloff (default: 2.0)\r
\r
void main() {\r
    // Calculate distance from center (0.0 to ~0.707)\r
    vec2 center = vec2(0.5, 0.5);\r
    vec2 offset = vUv - center;\r
    float distance = length(offset);\r
    \r
    // Create radial aberration that's stronger at edges\r
    float aberration = uStrength * pow(distance, uFalloff);\r
    \r
    // Direction from center to current pixel\r
    vec2 direction = normalize(offset);\r
    \r
    // Sample RGB channels at slightly different positions\r
    // Red channel - sample inward (closer to center)\r
    vec2 redUv = vUv - direction * aberration;\r
    float red = texture(uTexture, redUv).r;\r
    \r
    // Green channel - sample at original position\r
    float green = texture(uTexture, vUv).g;\r
    \r
    // Blue channel - sample outward (further from center)\r
    vec2 blueUv = vUv + direction * aberration;\r
    float blue = texture(uTexture, blueUv).b;\r
    \r
    // Get alpha from original position\r
    float alpha = texture(uTexture, vUv).a;\r
    \r
    fragColor = vec4(red, green, blue, alpha);\r
}\r
`,ST=`#version 300 es\r
precision mediump float;\r
\r
in vec2 vUv;\r
out vec4 fragColor;\r
\r
uniform sampler2D uTexture;\r
uniform vec2 uResolution;\r
uniform float uTime;\r
\r
uniform float uExposure;\r
uniform float uContrast;\r
uniform float uSaturation;\r
uniform float uTemperature;\r
uniform float uTint;\r
uniform float uVignetteStrength;\r
uniform float uFilmGrainStrength;\r
uniform float uShadowsLift;\r
uniform float uHighlightsGain;\r
\r
// NEW: Master intensity for cinematic grade\r
uniform float uCinematicIntensity;\r
\r
// === Utility Functions ===\r
\r
vec3 filmicToneMapping(vec3 color) {\r
    const float a = 2.51;\r
    const float b = 0.03;\r
    const float c = 2.43;\r
    const float d = 0.59;\r
    const float e = 0.14;\r
    color = (color * (a * color + b)) / (color * (c * color + d) + e);\r
    return clamp(color, 0.0, 1.0);\r
}\r
\r
vec3 adjustTemperature(vec3 color, float temperature, float tint) {\r
    float tempR = 1.0 + temperature * 0.2;\r
    float tempB = 1.0 - temperature * 0.2;\r
\r
    float tintG = 1.0 + tint * 0.15;\r
    float tintR = 1.0 - tint * 0.05;\r
    float tintB = 1.0 - tint * 0.05;\r
\r
    color.r *= tempR * tintR;\r
    color.g *= tintG;\r
    color.b *= tempB * tintB;\r
\r
    return color;\r
}\r
\r
vec3 liftGammaGain(vec3 color, float lift, float gamma, float gain) {\r
    color = color + lift;\r
    color = pow(max(color, 0.0), vec3(1.0 / gamma));\r
    color = color * gain;\r
    return color;\r
}\r
\r
vec3 cinematicGrade(vec3 color) {\r
    vec3 shadows = vec3(0.05, 0.1, 0.15);\r
    vec3 midtones = vec3(1.0, 0.95, 0.9);\r
    vec3 highlights = vec3(1.1, 1.05, 0.95);\r
\r
    float luma = dot(color, vec3(0.299, 0.587, 0.114));\r
\r
    float shadowWeight = 1.0 - smoothstep(0.0, 0.3, luma);\r
    float highlightWeight = smoothstep(0.6, 1.0, luma);\r
    float midtoneWeight = 1.0 - shadowWeight - highlightWeight;\r
\r
    vec3 graded = color * (\r
        shadows * shadowWeight +\r
        midtones * midtoneWeight +\r
        highlights * highlightWeight\r
    );\r
\r
    return mix(color, graded, uCinematicIntensity); // INTENSITY BLEND\r
}\r
\r
float vignette(vec2 uv, float strength) {\r
    vec2 center = uv - 0.5;\r
    float dist = length(center);\r
    float falloff = 1.0 - smoothstep(0.3, 0.8, dist);\r
    float v = mix(1.0, 1.0 - strength, 1.0 - falloff);\r
    return mix(1.0, v, uCinematicIntensity); // INTENSITY BLEND\r
}\r
\r
float filmGrain(vec2 uv, float time) {\r
    float noise = fract(sin(dot(uv + time * 0.1, vec2(12.9898, 78.233))) * 43758.5453);\r
    return noise;\r
}\r
\r
void main() {\r
    vec2 uv = vUv;\r
    vec4 originalColor = texture(uTexture, uv);\r
    vec3 color = originalColor.rgb;\r
\r
    // 1. Exposure\r
    color *= uExposure;\r
\r
    // 2. Shadows / Highlights\r
    color = liftGammaGain(color, uShadowsLift, 1.0, uHighlightsGain);\r
\r
    // 3. Temperature / Tint\r
    color = adjustTemperature(color, uTemperature, uTint);\r
\r
    // 4. Cinematic Color Grading\r
    color = cinematicGrade(color); // wrapped with intensity inside\r
\r
    // 5. Contrast\r
    color = (color - 0.5) * uContrast + 0.5;\r
\r
    // 6. Saturation\r
    float luminance = dot(color, vec3(0.299, 0.587, 0.114));\r
    color = mix(vec3(luminance), color, uSaturation);\r
\r
    // 7. Tone mapping\r
    color = filmicToneMapping(color);\r
\r
    // 8. Vignette\r
    float v = vignette(uv, uVignetteStrength);\r
    color *= v;\r
\r
    // 9. Film grain\r
    float grain = filmGrain(uv * uResolution, uTime);\r
    color += (grain - 0.5) * uFilmGrainStrength * uCinematicIntensity;\r
\r
    // 10. Clamp\r
    color = clamp(color, 0.0, 1.0);\r
\r
    fragColor = vec4(color, originalColor.a);\r
}\r
`;class MT{constructor(e,i,n){this.fbos=[],this.textures=[],this.startTime=Date.now(),this.gl=e,this.width=i,this.height=n,this.programs={passthrough:Mt(e,ha,vT),blackwhite:Mt(e,ha,pT),sepia:Mt(e,ha,yT),bloom:Mt(e,ha,mT),chromaticAberration:Mt(e,ha,bT),cinematicGrading:Mt(e,ha,ST)},this.quadBuffer=Wl(e),this.vao=e.createVertexArray(),e.bindVertexArray(this.vao),e.bindBuffer(e.ARRAY_BUFFER,this.quadBuffer),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,e.FLOAT,!1,0,0),e.bindVertexArray(null);for(let o=0;o<2;o++){const l=e.createFramebuffer(),h=e.createTexture();e.bindTexture(e.TEXTURE_2D,h),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.bindFramebuffer(e.FRAMEBUFFER,l),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,h,0),this.fbos.push(l),this.textures.push(h)}e.bindFramebuffer(e.FRAMEBUFFER,null)}run(e,i){const n=this.gl;let o=e,l=0;for(let u=0;u<i.length;u++){const{effect:d,params:g}=i[u],m=this.programs[d],y=this.fbos[l];if(n.bindFramebuffer(n.FRAMEBUFFER,y),n.viewport(0,0,this.width,this.height),n.clear(n.COLOR_BUFFER_BIT),n.useProgram(m),n.bindVertexArray(this.vao),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,o),n.uniform1i(n.getUniformLocation(m,"uTexture"),0),d==="bloom")n.uniform2f(n.getUniformLocation(m,"uResolution"),this.width,this.height),n.uniform1f(n.getUniformLocation(m,"uThreshold"),.92),n.uniform1f(n.getUniformLocation(m,"uIntensity"),1.2),n.uniform1f(n.getUniformLocation(m,"uBlurSize"),8);else if(d==="chromaticAberration")n.uniform1f(n.getUniformLocation(m,"uStrength"),.003),n.uniform1f(n.getUniformLocation(m,"uFalloff"),1.8);else if(d==="cinematicGrading"){const v=g??{};n.uniform2f(n.getUniformLocation(m,"uResolution"),this.width,this.height),n.uniform1f(n.getUniformLocation(m,"uTime"),(Date.now()-this.startTime)/1e3),n.uniform1f(n.getUniformLocation(m,"uExposure"),v.exposure??1),n.uniform1f(n.getUniformLocation(m,"uContrast"),v.contrast??1.1),n.uniform1f(n.getUniformLocation(m,"uSaturation"),v.saturation??1.05),n.uniform1f(n.getUniformLocation(m,"uTemperature"),v.temperature??0),n.uniform1f(n.getUniformLocation(m,"uTint"),v.tint??0),n.uniform1f(n.getUniformLocation(m,"uVignetteStrength"),v.vignetteStrength??.3),n.uniform1f(n.getUniformLocation(m,"uFilmGrainStrength"),v.filmGrainStrength??.1),n.uniform1f(n.getUniformLocation(m,"uShadowsLift"),v.shadowsLift??0),n.uniform1f(n.getUniformLocation(m,"uHighlightsGain"),v.highlightsGain??1),n.uniform1f(n.getUniformLocation(m,"uCinematicIntensity"),v.cinematicIntensity??1)}n.drawArrays(n.TRIANGLE_STRIP,0,4),n.bindVertexArray(null),n.useProgram(null),o=this.textures[l],l=1-l}n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight);const h=this.programs.passthrough;n.useProgram(h),n.bindVertexArray(this.vao),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,o),n.uniform1i(n.getUniformLocation(h,"uTexture"),0),n.drawArrays(n.TRIANGLE_STRIP,0,4),n.bindVertexArray(null),n.useProgram(null)}destroy(){const e=this.gl;for(const i in this.programs){const n=this.programs[i];e.isProgram(n)&&e.deleteProgram(n)}for(const i of this.fbos)e.isFramebuffer(i)&&e.deleteFramebuffer(i);for(const i of this.textures)e.isTexture(i)&&e.deleteTexture(i);e.isBuffer(this.quadBuffer)&&e.deleteBuffer(this.quadBuffer),e.isVertexArray(this.vao)&&e.deleteVertexArray(this.vao)}}function CT(a){const e=a.createBuffer();return a.bindBuffer(a.UNIFORM_BUFFER,e),a.bufferData(a.UNIFORM_BUFFER,128,a.DYNAMIC_DRAW),e}function TT(a,e,i){const n=ny(-i.getViewportWidth()/(2*i.getZoom()),i.getViewportWidth()/(2*i.getZoom()),i.getViewportHeight()/(2*i.getZoom()),-i.getViewportHeight()/(2*i.getZoom())),o=Ju(-i.getPosition().x,-i.getPosition().y),l=new Float32Array(32);l.set(n,0),l.set(o,16),a.bindBuffer(a.UNIFORM_BUFFER,e),a.bufferSubData(a.UNIFORM_BUFFER,0,l)}class wT{constructor(e,i){this.inputManager=i,this.spriteGroups=new Map,this.clearedTextures=[],this.postProcessEffects=new Map,this.backgroundImageId=null,this.onResolutionChanged=()=>{this.initializeSceneFramebuffer(),this.lightingPass.resize()},this.onPostProcessEffectsSet=o=>{Array.isArray(o.effectChain)?this.setPostProcessEffects(o.effectChain):console.warn("[Renderer] Ignoring malformed postprocess effectChain payload:",o)},this.onPostProcessEffectAdd=o=>{this.addPostProcessEffect(o.effect,o.params)},this.onPostProcessEffectRemove=o=>{this.removePostProcessEffect(o.effect)},this.onPostProcessEffectClear=()=>{this.clearPostProcessEffects()};const n=Ai.getInstance();this.gl=n.getWebGL2Context("unifiedgl2"),this.cameraUBO=CT(this.gl),this.gl.bindBufferBase(this.gl.UNIFORM_BUFFER,0,this.cameraUBO),this.backgroundPass=new GC(this.gl),this.planetPass=new YC(this.gl),this.lightingPass=new JC(this.gl,this.cameraUBO),this.entityPass=new lT(this.gl,this.inputManager),this.spritePass=new xu(this.gl,this.cameraUBO),this.particlePass=new fT(this.gl,this.cameraUBO),this.postProcessPass=new MT(this.gl,this.gl.canvas.width,this.gl.canvas.height),this.sceneFramebuffer=this.gl.createFramebuffer(),this.sceneTexture=this.gl.createTexture(),this.initializeSceneFramebuffer(),pe.on("resolution:changed",this.onResolutionChanged),pe.on("postprocess:effect:set",this.onPostProcessEffectsSet),pe.on("postprocess:effect:add",this.onPostProcessEffectAdd),pe.on("postprocess:effect:remove",this.onPostProcessEffectRemove),pe.on("postprocess:effect:clear",this.onPostProcessEffectClear)}initializeSceneFramebuffer(){const e=this.gl,i=e.drawingBufferWidth,n=e.drawingBufferHeight;e.bindTexture(e.TEXTURE_2D,this.sceneTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,n,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindFramebuffer(e.FRAMEBUFFER,this.sceneFramebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.sceneTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}render(e,i,n,o,l){const h=this.gl;TT(h,this.cameraUBO,e),h.bindFramebuffer(h.FRAMEBUFFER,this.sceneFramebuffer),h.viewport(0,0,h.drawingBufferWidth,h.drawingBufferHeight),h.clearColor(0,0,0,0),h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT),this.backgroundPass.render(e.getOffset()),this.planetPass.renderAll();const u=this.lightingPass.generateLightBuffer(n,e);h.bindFramebuffer(h.FRAMEBUFFER,this.sceneFramebuffer);const d=this.lightingPass.getAmbientLight();this.entityPass.setAmbientLight(d),this.entityPass.render(i,u,e);for(const m of this.spriteGroups.values())m.length=0;this.clearedTextures.length=0;for(const m of o){const y=m.texture;let v=this.spriteGroups.get(y);v||(v=[],this.spriteGroups.set(y,v)),v.push({worldX:m.worldX,worldY:m.worldY,widthPx:m.widthPx,heightPx:m.heightPx,alpha:m.alpha??1,rotation:m.rotation??0})}for(const[m,y]of this.spriteGroups)y.length>0&&this.spritePass.renderBatch(m,y);this.particlePass.render(l,e),h.bindFramebuffer(h.FRAMEBUFFER,null);const g=Array.from(this.postProcessEffects.entries()).map(([m,y])=>({effect:m,params:y}));this.postProcessPass.run(this.sceneTexture,g),this.lightingPass.compositeLightingOverTarget(null)}resize(){this.initializeSceneFramebuffer(),this.lightingPass.resize()}destroy(){const e=this.gl;e.deleteBuffer(this.cameraUBO),e.deleteFramebuffer(this.sceneFramebuffer),e.deleteTexture(this.sceneTexture),this.backgroundPass.destroy(),this.lightingPass.destroy(),this.entityPass.destroy(),this.spritePass.destroy(),this.particlePass.destroy(),this.postProcessPass.destroy(),pe.off("resolution:changed",this.onResolutionChanged),pe.off("postprocess:effect:set",this.onPostProcessEffectsSet),pe.off("postprocess:effect:add",this.onPostProcessEffectAdd),pe.off("postprocess:effect:remove",this.onPostProcessEffectRemove),pe.off("postprocess:effect:clear",this.onPostProcessEffectClear)}setPostProcessEffects(e){this.postProcessEffects.clear();for(const{effect:i,params:n}of e)this.postProcessEffects.set(i,n)}addPostProcessEffect(e,i){this.postProcessEffects.set(e,i)}removePostProcessEffect(e){this.postProcessEffects.delete(e)}clearPostProcessEffects(){this.postProcessEffects.clear()}setBackgroundImage(e){this.backgroundImageId=e,this.backgroundPass.loadImage(e??"")}addPlanet(e,i,n){console.log("[UnifiedSceneRendererGL] Adding planet:",e),this.planetPass.addPlanet(e,i,n)}setAmbientLight(e){this.lightingPass.setAmbientLight(e)}getLightingPass(){return this.lightingPass}getEntityPass(){return this.entityPass}getSpritePass(){return this.spritePass}getParticlePass(){return this.particlePass}getPostProcessPass(){return this.postProcessPass}}class Es{constructor(){this.energy=100,this.maxEnergy=100,this.onEnergyChangeCallbacks=[],this.firingMode=Xt.Sequence}static getInstance(){return Es.instance||(Es.instance=new Es),Es.instance}initialize(e=100){this.energy=e,this.maxEnergy=e}getFiringMode(){return this.firingMode}setFiringMode(e){this.firingMode=e}getEnergy(){return this.energy}getMaxEnergy(){return this.maxEnergy}setEnergy(e){this.energy=Math.max(0,Math.min(this.maxEnergy,e)),this.notifyEnergyChange()}spendEnergy(e){return e>this.energy?!1:(this.energy-=e,this.notifyEnergyChange(),!0)}addEnergy(e){this.energy=Math.min(this.energy+e,this.maxEnergy),this.notifyEnergyChange()}onEnergyChange(e){this.onEnergyChangeCallbacks.push(e)}notifyEnergyChange(){for(const e of this.onEnergyChangeCallbacks)e(this.energy,this.maxEnergy)}reset(){this.energy=this.maxEnergy,this.notifyEnergyChange()}destroy(){this.energy=0,this.maxEnergy=0,this.onEnergyChangeCallbacks.length=0}}let AT=0;function kT(){return`point-light-${AT++}`}const rm=.25;function ai(a){a.intensity=a.intensity?a.intensity*rm:rm;const{x:e,y:i,radius:n=128,color:o="#ffffff",intensity:l=1,flicker:h=!1,life:u,expires:d=!1,id:g=kT(),fadeMode:m="linear"}=a;return{id:g,x:e,y:i,radius:n,color:o,intensity:l,flicker:h,life:u,maxLife:u,expires:d,type:"point",fadeMode:m}}const Io=new Map,Vt={registerBlock(a,e){Io.set(a,e)},unregisterBlock(a){Io.delete(a)},getObject(a){return Io.get(a)},clear(){Io.clear()},size(){return Io.size}};function ay(a,e){const i=new Set,n=[e],o=h=>`${h.x},${h.y}`,l=h=>[{x:h.x+1,y:h.y},{x:h.x-1,y:h.y},{x:h.x,y:h.y+1},{x:h.x,y:h.y-1}];for(;n.length>0;){const h=n.pop(),u=o(h);if(!i.has(u)&&a.hasBlockAt(h)){i.add(u);for(const d of l(h)){const g=o(d);!i.has(g)&&a.hasBlockAt(d)&&n.push(d)}}}return i}function qe(a){return`${a.x},${a.y}`}function hn(a){const[e,i]=a.split(",").map(Number);return{x:e,y:i}}var xs=(a=>(a.Player="player",a.Enemy="enemy",a.Neutral="neutral",a))(xs||{});class ef{constructor(e,i,n,o){if(this.blocks=new Map,this.blockToCoordMap=new Map,this.destroyed=!1,this.deathTimestamp=null,this.totalMass=null,this.immoveable=!1,this.collidingUntil=0,this.grid=e,this.id=this.generateId(),this.faction=o??xs.Neutral,this.transform={position:(n==null?void 0:n.position)??{x:0,y:0},velocity:(n==null?void 0:n.velocity)??{x:0,y:0},rotation:(n==null?void 0:n.rotation)??0,angularVelocity:(n==null?void 0:n.angularVelocity)??0},i)for(const[l,h]of i)this.blocks.set(qe(l),h),this.grid.addBlockToCell(h),this.blockToCoordMap.set(h,l),Vt.registerBlock(h,this)}update(e){}onDestroyed(){}setFaction(e){this.faction=e}getFaction(){return this.faction}placeBlock(e,i){const n=qe(e);this.blocks.set(n,i),this.grid.addBlockToCell(i),this.blockToCoordMap.set(i,e),Vt.registerBlock(i,this),this.invalidateMass()}getBlock(e){return this.blocks.get(qe(e))}hasBlockAt(e){return this.blocks.has(qe(e))}getBlockMap(){return this.blocks}getAllBlocks(){return Array.from(this.blocks.entries()).map(([e,i])=>[hn(e),i])}getBlockCount(){return this.blocks.size}getCenterBlock(){return this.blocks.get("0,0")}getBlockCoord(e){return this.blockToCoordMap.get(e)??null}getBlocksWithinGridDistance(e,i){const n=[];for(const[o,l]of this.getAllBlocks()){const h=this.getBlockCoord(l);if(!h)continue;const u=Math.abs(h.x-e.x),d=Math.abs(h.y-e.y);Math.max(u,d)<=i&&n.push(l)}return n}hideAllBlocks(){for(const e of this.blocks.values())e.hidden=!0}showAllBlocks(){for(const e of this.blocks.values())e.hidden=!1}findBlockCoord(e){for(const[i,n]of this.blocks.entries())if(n===e)return hn(i);return null}removeBlock(e){const i=qe(e),n=this.blocks.get(i);n&&(Vt.unregisterBlock(n),this.grid.removeBlockFromCell(n),this.blocks.delete(i),this.blockToCoordMap.delete(n),this.invalidateMass())}removeBlocks(e,i){const n=i??[];if(i)for(const o of i){const l=this.blockToCoordMap.get(o);l&&this.blocks.delete(qe(l)),this.blockToCoordMap.delete(o)}else for(const o of e){const l=qe(o),h=this.blocks.get(l);h&&(n.push(h),this.blocks.delete(l),this.blockToCoordMap.delete(h))}for(const o of n)Vt.unregisterBlock(o);this.grid.removeBlocksFromCells(n),this.invalidateMass()}getTransform(){return this.transform}setTransform(e){this.transform={...e},this.updateBlockPositions()}getGrid(){return this.grid}setImmoveable(e){this.immoveable=e}isImmoveable(){return this.immoveable}setColliding(e,i=100){e&&(this.collidingUntil=performance.now()+i)}isColliding(){return performance.now()<this.collidingUntil}getBlockWorldPosition(e){const i=this.getBlockCoord(e);return i?this.calculateBlockWorldPosition(i):{x:0,y:0}}calculateBlockWorldPosition(e){const{position:i,rotation:n}=this.transform,{x:o,y:l}=i,h=Math.cos(n),u=Math.sin(n),d=o+e.x*32*h-e.y*32*u,g=l+e.x*32*u+e.y*32*h;return{x:d,y:g}}updateBlockPositions(){for(const[e,i]of this.blocks.entries()){const n=hn(e);this.grid.removeBlockFromCell(i),i.position=this.calculateBlockWorldPosition(n),this.grid.addBlockToCell(i)}}getTotalMass(){if(this.totalMass==null){let e=0;for(const i of this.blocks.values())e+=i.type.mass;this.totalMass=e}return this.totalMass}invalidateMass(){this.totalMass=null}destroy(){if(!this.destroyed){this.destroyed=!0,this.deathTimestamp=performance.now();for(const e of this.blocks.values())this.grid.removeBlockFromCell(e);this.blocks.clear(),this.blockToCoordMap.clear(),this.onDestroyed()}}isDestroyed(){return this.destroyed}isVisuallyExpired(e=2e3){return!this.destroyed||this.deathTimestamp===null?!1:performance.now()-this.deathTimestamp>e}getTimeSinceDeath(){return!this.destroyed||this.deathTimestamp===null?0:performance.now()-this.deathTimestamp}isDeletionSafe(e){const i=qe(e);if(!this.blocks.has(i))return!0;const n=new Map(this.blocks);n.delete(i);const o=[...n.keys()][0];if(!o)return!0;const l=new Set,h=[o];for(;h.length>0;){const u=h.pop();if(l.has(u))continue;l.add(u);const{x:d,y:g}=hn(u),m=[{x:d+1,y:g},{x:d-1,y:g},{x:d,y:g+1},{x:d,y:g-1}];for(const y of m){const v=qe(y);n.has(v)&&!l.has(v)&&h.push(v)}}return l.size===n.size}loadFromJson(e){const{position:i,velocity:n,rotation:o,angularVelocity:l}=e.transform;this.transform.position=i,this.transform.velocity=n,this.transform.rotation=o,this.transform.angularVelocity=l,e.blocks.forEach(h=>{const u=oi(h.id);if(!u){console.warn(`Unknown block type during deserialization: ${h.id}`);return}const d=crypto.randomUUID(),g={ownerFaction:xs.Neutral,id:d,type:u,rotation:h.rotation??0,hp:u.armor,ownerShipId:this.id,position:{x:0,y:0}},m=qe(h.coord);this.blocks.set(m,g),this.blockToCoordMap.set(g,h.coord),this.grid.addBlockToCell(g)}),this.invalidateMass(),this.updateBlockPositions()}generateId(){return"entity-"+Math.random().toString(36).slice(2,10)}}class RT{constructor(e,i){this.timeSinceLastUse=0,this.rechargeDelay=.25,this.max=e,this.current=e,this.rechargePerSecond=i}update(e){this.timeSinceLastUse+=e,this.timeSinceLastUse>=this.rechargeDelay&&(this.current=Math.min(this.current+this.rechargePerSecond*e,this.max))}spend(e){return this.current<e?!1:(this.current-=e,this.timeSinceLastUse=0,!0)}add(e){this.current=Math.min(this.current+e,this.max)}reset(){this.current=this.max,this.timeSinceLastUse=0}getCurrent(){return this.current}getMax(){return this.max}setMax(e){this.max=e,this.current=Math.min(this.current,e)}setRechargeRate(e){this.rechargePerSecond=e}setMaxEnergy(e){this.max=e,this.current=Math.min(this.current,e)}}const ks=class ks{constructor(e,i){this.activeVisuals=[],this.shieldedBlocks=new Set,this.ctx=e.getContext("fx"),this.camera=i}static getInstance(){if(!ks.instance)throw new Error("ShieldEffectsSystem not initialized. Call initialize(canvasManager, camera) first.");return ks.instance}static initialize(e,i){ks.instance||(ks.instance=new ks(e,i))}registerShield(e,i){this.activeVisuals.push({block:e,radius:i,age:0})}registerShieldedBlock(e){this.shieldedBlocks.add(e)}unregisterShieldedBlock(e){this.shieldedBlocks.delete(e)}clearShieldedBlocks(){this.shieldedBlocks.clear()}clearVisualsForShip(e){this.activeVisuals=this.activeVisuals.filter(i=>i.block.ownerShipId!==e);for(const i of Array.from(this.shieldedBlocks))i.ownerShipId===e&&this.shieldedBlocks.delete(i)}update(e){for(const i of this.activeVisuals)i.age+=e;this.activeVisuals=this.activeVisuals.filter(i=>{var n;return((n=i.block.type.behavior)==null?void 0:n.shieldRadius)!=null||i.block.isShielded})}render(){const e=this.ctx;e.save(),e.scale(this.camera.getZoom(),this.camera.getZoom());for(const i of this.activeVisuals){const n=i.block.position;if(!n)continue;const o=this.camera.worldToScreen(n.x,n.y),l=o.x/this.camera.getZoom(),h=o.y/this.camera.getZoom(),u=i.radius,d=.75+.1*Math.sin(i.age*3),g=Jm[i.block.type.id]??["#88ddff","#44bbff","#00aaff"],[m,y,v]=g,M=e.createRadialGradient(l,h,0,l,h,u);M.addColorStop(0,m+`${Math.floor(d*255).toString(16).padStart(2,"0")}`),M.addColorStop(1,v+"00"),e.globalAlpha=d,e.fillStyle=M,e.beginPath(),e.arc(l,h,u,0,Math.PI*2),e.fill()}for(const i of this.shieldedBlocks){const n=Tt.getInstance().getById(i.ownerShipId);if(!n)continue;const o=n.getBlockCoord(i);if(!o)continue;const l=n.getTransform(),h=o.x*X,u=o.y*X,d=Math.cos(l.rotation),g=Math.sin(l.rotation),m=h*d-u*g,y=h*g+u*d,v=l.position.x+m,M=l.position.y+y,b=this.camera.worldToScreen(v,M);e.save(),e.translate(b.x/this.camera.getZoom(),b.y/this.camera.getZoom()),e.rotate(l.rotation);const C=i.shieldHighlightColor??"rgba(255, 0, 0, 0.4)";Qm(e,i.type.id,i.rotation,C),e.restore()}e.restore()}clear(){this.activeVisuals.length=0,this.shieldedBlocks.clear()}};ks.instance=null;let ji=ks;class ET{constructor(e){this.active=!1,this.protectedBlocks=new Set,this.ownerShip=e}recalculateCoverage(){var o,l;for(const h of this.protectedBlocks)h.isShielded=!1,h.shieldEfficiency=void 0,h.shieldHighlightColor=void 0,h.shieldSourceId=void 0;this.protectedBlocks.clear();const e=this.ownerShip.getShieldBlocks(),i=Array.from(e),n=ji.getInstance();if(n.clearVisualsForShip(this.ownerShip.id),i.length===0){this.deactivate();return}for(const h of i){const u=this.ownerShip.getBlockCoord(h);if(!u)continue;const d=((o=h.type.behavior)==null?void 0:o.shieldRadius)??0,g=((l=h.type.behavior)==null?void 0:l.shieldEfficiency)??0,m=EM[h.type.id]??"rgba(100, 255, 255, 0.4)",y=this.ownerShip.getBlocksWithinGridDistance(u,d);for(const v of y){this.protectedBlocks.add(v);const M=v.shieldEfficiency??0;g>=M&&(v.shieldEfficiency=g,v.shieldHighlightColor=m,v.shieldSourceId=h.type.id),this.active&&(v.isShielded=!0,n.registerShieldedBlock(v))}if(this.active){const v=d*X;n.registerShield(h,v)}}}activate(){var i;this.active=!0,this.recalculateCoverage();const e=ji.getInstance();e.clearVisualsForShip(this.ownerShip.id);for(const n of this.protectedBlocks)n.isShielded=!0,e.registerShieldedBlock(n);for(const n of this.ownerShip.getShieldBlocks()){const l=(((i=n.type.behavior)==null?void 0:i.shieldRadius)??0)*X;e.registerShield(n,l)}}deactivate(){this.active=!1,ji.getInstance().clearVisualsForShip(this.ownerShip.id);for(const i of this.protectedBlocks)i.isShielded=!1,i.shieldEfficiency=void 0,i.shieldHighlightColor=void 0,i.shieldSourceId=void 0}isActive(){return this.active}hasShieldBlocks(){for(const e of this.ownerShip.getShieldBlocks())return!0;return!1}}class BT{constructor(e,i=5,n=5){this.BASE_MAX_FUEL=100,this.RECHARGE_DURATION_SECONDS=8,this.speedMultiplier=1.5,this.accelerationMultiplier=2,this.pulseMultiplier=1.5,this.superPulseBonusMultiplier=.5,this.TRIGGER_COOLDOWN=1,this.triggerCooldownRemaining=0,this.PULSE_WINDOW=.4,this.PULSE_DURATION=6,this.PULSE_COOLDOWN=2,this.PULSE_PERFECT_WINDOW=.2,this.pulsePerfectTimingFuelRefundAmount=25,this.pulseDurationRemaining=0,this.pulseCooldownRemaining=0,this.superPulseDurationRemaining=0,this.afterburnerJustActivated=!1,this.pulseJustActivated=!1,this.superPulseJustActivated=!1,this.lastDeactivationTime=null,this.active=!1,this.max=e,this.current=e,this.rechargePerSecond=e/this.RECHARGE_DURATION_SECONDS,this.consumptionPerSecond=n}update(e){if(this.triggerCooldownRemaining>0&&(this.triggerCooldownRemaining-=e,this.triggerCooldownRemaining<0&&(this.triggerCooldownRemaining=0)),this.active){const i=this.consumptionPerSecond*e;this.current-=i,this.current<=0&&(this.current=0,this.active=!1,this.lastDeactivationTime=performance.now()/1e3,this.pulseDurationRemaining=0)}else this.rechargePerSecond>0&&(this.current=Math.min(this.current+this.rechargePerSecond*e,this.max));this.pulseDurationRemaining>0&&(this.pulseDurationRemaining-=e,this.pulseDurationRemaining<=0&&(this.pulseDurationRemaining=0)),this.superPulseDurationRemaining>0&&(this.superPulseDurationRemaining-=e,this.superPulseDurationRemaining<=0&&(this.superPulseDurationRemaining=0)),this.pulseCooldownRemaining>0&&(this.pulseCooldownRemaining-=e,this.pulseCooldownRemaining<0&&(this.pulseCooldownRemaining=0))}consume(e){return this.current<e?!1:(this.current-=e,!0)}refill(e){this.current=Math.min(this.current+e,this.max)}reset(){this.current=this.max,this.active=!1,this.lastDeactivationTime=null,this.pulseDurationRemaining=0,this.pulseCooldownRemaining=0,this.pulseJustActivated=!1,this.superPulseJustActivated=!1}setActive(e){const i=performance.now()/1e3;if(e){if(this.active)return!0;if(this.triggerCooldownRemaining>0)return!1;if(this.current>=10){const n=this.lastDeactivationTime!==null?i-this.lastDeactivationTime:1/0;return this.pulseCooldownRemaining<=0&&n<=this.PULSE_WINDOW&&(this.pulseDurationRemaining=this.PULSE_DURATION,this.pulseCooldownRemaining=this.PULSE_COOLDOWN,this.pulseJustActivated=!0,n>=this.PULSE_WINDOW-this.PULSE_PERFECT_WINDOW&&(this.current=Math.min(this.current+this.pulsePerfectTimingFuelRefundAmount,this.max),this.superPulseJustActivated=!0,this.superPulseDurationRemaining=this.PULSE_DURATION)),this.active=!0,this.triggerCooldownRemaining=this.TRIGGER_COOLDOWN,this.afterburnerJustActivated=!0,!0}return!1}else return this.active&&(this.lastDeactivationTime=i),this.active=!1,!1}isActive(){return this.active}isPulsing(){return this.pulseDurationRemaining>0}getCurrent(){return this.current}getMax(){return this.max}setMax(e){this.max=e+this.BASE_MAX_FUEL,this.current=Math.min(this.current,this.max),this.rechargePerSecond=this.max/this.RECHARGE_DURATION_SECONDS}getConsumptionRatePerSecond(){return this.consumptionPerSecond}setConsumptionRatePerSecond(e){this.consumptionPerSecond=e}getSpeedMultiplier(){const e=this.getPulseDecayFactor(),i=this.getSuperPulseDecayFactor();return this.speedMultiplier+this.pulseMultiplier*e+this.superPulseBonusMultiplier*i}getAccelerationMultiplier(){const e=this.getPulseDecayFactor(),i=this.getSuperPulseDecayFactor();return this.accelerationMultiplier+this.pulseMultiplier*e+this.superPulseBonusMultiplier*i}getPulseMultiplier(){return this.pulseMultiplier}getPulseDecayFactor(){return this.pulseDurationRemaining>0?this.pulseDurationRemaining/this.PULSE_DURATION:0}wasAfterburnerJustActivated(){const e=this.afterburnerJustActivated;return this.afterburnerJustActivated=!1,e}wasPulseJustActivated(){const e=this.pulseJustActivated;return this.pulseJustActivated=!1,e}wasSuperPulseJustActivated(){const e=this.superPulseJustActivated;return this.superPulseJustActivated=!1,e}getPulseCooldownRemaining(){return this.pulseCooldownRemaining}wouldTriggerPulseNow(){const e=performance.now()/1e3;return this.pulseCooldownRemaining<=0&&this.lastDeactivationTime!==null&&e-this.lastDeactivationTime<=this.PULSE_WINDOW}getPulseWindowRemaining(){if(this.lastDeactivationTime===null)return 0;const i=performance.now()/1e3-this.lastDeactivationTime;return Math.max(0,this.PULSE_WINDOW-i)}getSuperPulseWindowRemaining(){if(this.lastDeactivationTime===null)return 0;const i=performance.now()/1e3-this.lastDeactivationTime,n=this.PULSE_WINDOW-this.PULSE_PERFECT_WINDOW;return i<n||i>this.PULSE_WINDOW?0:Math.max(0,this.PULSE_WINDOW-i)}getSuperPulseDecayFactor(){return this.superPulseDurationRemaining>0?this.superPulseDurationRemaining/this.PULSE_DURATION:0}}class zt extends ef{constructor(e,i,n,o,l,h){super(e,i,n),this.afterburnerComponent=null,this.energyComponent=null,this.shieldBlocks=new Set,this.fuelTankBlocks=new Set,this.firingPlan=[],this.firingPlanIndex=new Map,this.turretSequenceState={},this.firingMode=Xt.Synced,this.harvesterBlocks=new Map,this.haloBladeBlocks=new Map,this.destroyedListeners=[],this.lightAuraId=null,this.thrusting=!0,this.strafingLeft=!1,this.strafingRight=!1,this.affixes={},this.shieldComponent=new ET(this),this.afterburnerComponent=new BT(100,5),this.validateFiringPlan(),this.isPlayerShip=o??!1,this.affixes=l??{},this.faction=h??xs.Enemy}generateId(){return"ship-"+Math.random().toString(36).slice(2,9)}getIsPlayerShip(){return this.isPlayerShip}setIsPlayerShip(e){this.isPlayerShip=e}getAffixes(){return this.affixes}setAffixes(e){this.affixes=e}getAfterburnerComponent(){return this.afterburnerComponent}triggerAfterburner(){this.afterburnerComponent&&this.afterburnerComponent.setActive(!0)}deactivateAfterburner(){this.afterburnerComponent&&this.afterburnerComponent.setActive(!1)}isAfterburnerActive(){var e;return((e=this.afterburnerComponent)==null?void 0:e.isActive())??!1}getAfterburnerSpeedMultiplier(){var e;return((e=this.afterburnerComponent)==null?void 0:e.getSpeedMultiplier())??1}getAfterburnerAccelMultiplier(){var e;return((e=this.afterburnerComponent)==null?void 0:e.getAccelerationMultiplier())??1}registerAuraLight(e="#ffffff",i=64,n=1.25){if(!Ze.hasInstance()||this.lightAuraId)return;const o=Ze.getInstance();this.lightAuraId=`aura-${this.id}`;const l=ai({id:this.lightAuraId,x:this.getTransform().position.x,y:this.getTransform().position.y,radius:i,color:e,intensity:n});o.registerLight(l)}cleanupAuraLight(){this.lightAuraId&&(Ze.getInstance().removeLight(this.lightAuraId),this.lightAuraId=null)}getLightAuraId(){return this.lightAuraId}isThrusting(){return this.thrusting}isStrafingLeft(){return this.strafingLeft}isStrafingRight(){return this.strafingRight}setThrusting(e){this.thrusting=e}setStrafingLeft(e){this.strafingLeft=e}setStrafingRight(e){this.strafingRight=e}getCockpit(){return this.blocks.get(qe({x:0,y:0}))}getCockpitHp(){const e=this.getCockpit();return e?e.hp:(console.warn(`[Ship ${this.id}] Cockpit block missing.`),null)}getCockpitCoord(){if(this.getCockpit())return{x:0,y:0}}getFiringPlan(){return this.firingPlan}getFiringMode(){return this.firingMode}setFiringMode(e){this.firingMode=e,this.isPlayerShip&&Es.getInstance().setFiringMode(e)}validateFiringPlan(){const e=[],i=new Map;for(const n of this.firingPlan)if(this.blocks.has(qe(n.coord))&&this.blocks.get(qe(n.coord))===n.block){const l=e.length;e.push(n),i.set(n.block,l)}this.firingPlan=e,this.firingPlanIndex=i}addWeaponToPlanIfApplicable(e,i){var h,u,d;const n=(h=i.type.behavior)==null?void 0:h.fire;if(!n||!((d=(u=i.type)==null?void 0:u.behavior)!=null&&d.canFire))return;const o={coord:e,block:i,fireRate:n.fireRate||1,fireCooldown:1/(n.fireRate||1),timeSinceLastShot:0},l=this.firingPlan.length;this.firingPlan.push(o),this.firingPlanIndex.set(i,l)}removeWeaponFromPlanIfApplicable(e){const i=this.firingPlanIndex.get(e);if(i===void 0)return;const n=this.firingPlan.length-1,o=this.firingPlan[n];i!==n&&(this.firingPlan[i]=o,this.firingPlanIndex.set(o.block,i)),this.firingPlan.pop(),this.firingPlanIndex.delete(e)}removeWeaponsFromPlan(e){if(e.length===0)return;const i=new Set(e),n=[],o=new Map;for(const l of this.firingPlan)if(!i.has(l.block)){const h=n.length;n.push(l),o.set(l.block,h)}this.firingPlan=n,this.firingPlanIndex=o}resetTurretSequenceState(){this.turretSequenceState={}}getFuelTankBlocks(){return this.fuelTankBlocks}updateFuelCapacity(){let e=0;for(const i of this.fuelTankBlocks){const n=i.type.behavior;n!=null&&n.fuelCapacityIncrease&&(e+=n.fuelCapacityIncrease)}this.afterburnerComponent&&this.afterburnerComponent.setMax(e)}getEnergyComponent(){return this.energyComponent}getShieldComponent(){return this.shieldComponent}getShieldBlocks(){return this.shieldBlocks}updateEnergy(e){var i;(i=this.energyComponent)==null||i.update(e)}recomputeEnergyStats(){this.energyComponent||this.enableEnergyComponent();const e=this.getEnergyComponent();if(!e)return;const{max:i,regen:n}=this.computeEnergyStats();e.setMax(i),e.setRechargeRate(n)}enableEnergyComponent(){if(this.energyComponent)return;const{max:e,regen:i}=this.computeEnergyStats();e!==0&&(this.energyComponent=new RT(e,i))}computeEnergyStats(){let e=0,i=0;for(const[,n]of this.blocks.entries()){const o=n.type.behavior;o!=null&&o.energyMaxIncrease&&(e+=o.energyMaxIncrease),o!=null&&o.energyChargeRate&&(i+=o.energyChargeRate)}return{max:e,regen:i>0?i:10}}getHaloBladeBlocks(){return this.haloBladeBlocks}getTotalHarvestRate(){let e=0;for(const i of this.harvesterBlocks.values())e+=i;return e}rebuildHaloBladeIndex(){var e;this.haloBladeBlocks.clear();for(const[,i]of this.blocks.entries()){const n=(e=i.type.behavior)==null?void 0:e.haloBladeProperties;n&&this.haloBladeBlocks.set(i,n)}}placeBlockById(e,i,n){const o=oi(i);if(!o)throw new Error(`Unknown block type: ${i}`);const l=qe(e);if(this.blocks.has(l))return!1;const h=this.calculateBlockWorldPosition(e),u=crypto.randomUUID(),d={ownerFaction:this.faction,id:u,type:o,hp:o.armor,ownerShipId:this.id,position:h,...n!==void 0?{rotation:n}:{}};return this.placeBlock(e,d),!0}placeBlock(e,i){var h,u,d;const n=qe(e);this.blocks.set(n,i),this.grid.addBlockToCell(i),this.blockToCoordMap.set(i,e),Vt.registerBlock(i,this),(h=i.type.behavior)!=null&&h.shieldRadius&&this.shieldBlocks.add(i);const o=(u=i.type.behavior)==null?void 0:u.harvestRate;o&&this.harvesterBlocks.set(i,o);const l=(d=i.type.behavior)==null?void 0:d.haloBladeProperties;l&&this.haloBladeBlocks.set(i,l),i.type.id.startsWith("fuelTank")&&this.fuelTankBlocks.add(i),this.updateFuelCapacity(),this.invalidateMass(),this.recomputeEnergyStats(),this.addWeaponToPlanIfApplicable(e,i),this.shieldComponent.recalculateCoverage()}removeBlock(e){const i=qe(e),n=this.blocks.get(i);n&&(this.grid.removeBlockFromCell(n),this.blockToCoordMap.delete(n),this.harvesterBlocks.delete(n),this.shieldBlocks.delete(n),this.haloBladeBlocks.delete(n),this.fuelTankBlocks.delete(n),this.removeWeaponFromPlanIfApplicable(n),Vt.unregisterBlock(n)),this.blocks.delete(i),this.updateFuelCapacity(),this.invalidateMass(),this.recomputeEnergyStats(),this.shieldComponent.recalculateCoverage()}removeBlocks(e,i){if(e.length===0)return;const n=i??[];if(i)for(const o of i){const l=this.blockToCoordMap.get(o);if(l){const h=qe(l);this.blocks.delete(h)}this.blockToCoordMap.delete(o)}else for(const o of e){const l=qe(o),h=this.blocks.get(l);h&&(n.push(h),this.blocks.delete(l),this.blockToCoordMap.delete(h))}if(n.length!==0){this.grid.removeBlocksFromCells(n);for(const o of n)this.harvesterBlocks.delete(o),this.shieldBlocks.delete(o),this.haloBladeBlocks.delete(o),this.fuelTankBlocks.delete(o),Vt.unregisterBlock(o);this.removeWeaponsFromPlan(n),this.updateFuelCapacity(),this.invalidateMass(),this.recomputeEnergyStats(),this.shieldComponent.recalculateCoverage()}}isDeletionSafe(e){var u;const i=qe(e);if(!this.blocks.has(i))return!0;const n=new Map(this.blocks);n.delete(i);const o=((u=[...n.entries()].find(([,d])=>d.type.id.startsWith("cockpit")))==null?void 0:u[0])??[...n.keys()][0];if(!o)return!0;const l=new Set,h=[o];for(;h.length>0;){const d=h.pop();if(l.has(d))continue;l.add(d);const{x:g,y:m}=hn(d),y=[{x:g+1,y:m},{x:g-1,y:m},{x:g,y:m+1},{x:g,y:m-1}];for(const v of y){const M=qe(v);n.has(M)&&!l.has(M)&&h.push(M)}}return l.size===n.size}loadFromJson(e){const i=this.getTransform();i.position=e.transform.position,i.rotation=e.transform.rotation,e.blocks.forEach(n=>{const{coord:o,id:l,rotation:h}=n;this.placeBlockById(o,l,h)}),this.updateFuelCapacity(),this.validateFiringPlan(),this.rebuildHaloBladeIndex()}destroyInstantly(){if(!this.destroyed){this.destroyed=!0,this.deathTimestamp=performance.now()-1e4;for(const e of this.blocks.values())this.grid.removeBlockFromCell(e);this.blocks.clear(),this.blockToCoordMap.clear(),this.cleanupAuraLight();for(const e of this.destroyedListeners)e(this);this.destroyedListeners.length=0}}onDestroyedCallback(e){if(this.destroyed){e(this);return}this.destroyedListeners.push(e)}onDestroyed(){this.cleanupAuraLight();for(const e of this.destroyedListeners)e(this);this.destroyedListeners.length=0}}function IT(a,e,i,n,o=200,l="#00AAFF",h=20){n=Math.max(0,Math.min(1,n));const u=l,d=2,g=.35,m=.5;for(let y=0;y<d;y++){const v=y*g,M=Math.max(0,(n-v)/(1-v));if(M<=0)continue;const b=M*o,C=Math.pow(1-M,1.5)*(1-y*m);if(C<=.01)continue;const w=a.createRadialGradient(e,i,Math.max(0,b-h),e,i,b+h),[A,E,x]=lm(u);w.addColorStop(0,`rgba(${A}, ${E}, ${x}, 0)`),w.addColorStop(.5,`rgba(${A}, ${E}, ${x}, ${(C*.8).toFixed(3)})`),w.addColorStop(1,`rgba(${A}, ${E}, ${x}, 0)`),a.save(),a.globalCompositeOperation="screen",a.fillStyle=w,a.beginPath(),a.arc(e,i,b,0,Math.PI*2),a.fill(),a.restore()}if(n<.4){const v=(1-n/.4)*.4,M=a.createRadialGradient(e,i,0,e,i,40),[b,C,w]=lm(u);M.addColorStop(0,`rgba(255, 255, 255, ${v.toFixed(3)})`),M.addColorStop(.5,`rgba(${b}, ${C}, ${w}, ${(v*.6).toFixed(3)})`),M.addColorStop(1,`rgba(${b}, ${C}, ${w}, 0)`),a.save(),a.globalCompositeOperation="screen",a.fillStyle=M,a.beginPath(),a.arc(e,i,40,0,Math.PI*2),a.fill(),a.restore()}}function lm(a){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:[0,170,255]}function si(a,e,{file:i,channel:n,maxSimultaneous:o=5,baseVolume:l=1,pitchRange:h=[.7,1],volumeJitter:u=.2}){let d=0,g=1;if(e&&a!==e){const A=a.getTransform().position,E=e.getTransform().position,x=A.x-E.x,I=A.y-E.y,D=Math.sqrt(x*x+I*I),N=2450,H=300,W=Math.max(0,1-(D-H)/(N-H));g=Math.min(1,W),d=Math.max(-.7,Math.min(.7,x/300))}if(l*(1-u)*g<.01)return;const[v,M]=h,b=v+Math.random()*(M-v),w=l*(1-u*Math.random())*g;$.play(i,n,{pitch:b,volume:w,pan:d,maxSimultaneous:o})}class xT{constructor(e,i,n){this.activeShips=[],this.animationDuration=500,this.startBlockRevealInterval=200,this.decrementPerBlock=5,this.finalBlockRevealInterval=5,this.basePitch=.5,this.pitchIncrement=.03,this.maxPitch=2,this.playerShip=e,this.camera=i,this.ctx=n.getCanvas("fx").getContext("2d")}animateShipConstruction(e,i){const n=e.getAllBlocks();for(const[,o]of n)o.hidden=!0;this.activeShips.push({ship:e,queue:[...n],revealed:new Set,animationTimers:new Map,timeSinceLastReveal:0,blockRevealInterval:this.startBlockRevealInterval,totalBlockCount:n.length,blocksRevealed:0,phase:"building",shockwaveTimer:this.animationDuration,auraLightOptions:i})}update(e){const i=e*1e3;for(let n=this.activeShips.length-1;n>=0;n--){const o=this.activeShips[n];for(o.timeSinceLastReveal+=i;o.timeSinceLastReveal>=o.blockRevealInterval&&o.queue.length>0;){const[l,h]=o.queue.shift();h.hidden=!1;const u=qe(l);o.revealed.add(u),o.animationTimers.set(u,this.animationDuration),o.timeSinceLastReveal-=o.blockRevealInterval;const d=Math.min(this.basePitch+o.blocksRevealed*this.pitchIncrement,this.maxPitch);si(o.ship,this.playerShip,{file:"assets/sounds/sfx/ship/gather_00.wav",channel:"sfx",baseVolume:1,pitchRange:[d,d],volumeJitter:.2,maxSimultaneous:5});const g=this.startBlockRevealInterval,m=this.decrementPerBlock,y=this.finalBlockRevealInterval;o.blockRevealInterval=Math.max(y,g-m*o.blocksRevealed),o.blocksRevealed++}for(const[l,h]of o.animationTimers.entries()){const u=h-i;u<=0?o.animationTimers.delete(l):o.animationTimers.set(l,u)}o.phase==="building"?o.revealed.size===o.ship.getBlockCount()&&(o.phase="shockwave",o.shockwaveTimer=this.animationDuration,si(o.ship,this.playerShip,{file:"assets/sounds/sfx/ship/repair_00.wav",channel:"sfx",baseVolume:1,pitchRange:[.7,1.2],volumeJitter:.1,maxSimultaneous:3}),o.auraLightOptions&&o.ship.registerAuraLight(o.auraLightOptions.color,o.auraLightOptions.radius,o.auraLightOptions.intensity)):o.phase==="shockwave"&&(o.shockwaveTimer-=i,o.shockwaveTimer<=0&&this.activeShips.splice(n,1))}}render(e){var y;const i=this.playerShip.getTransform().position,n=this.playerShip.getGrid(),o=3e3,l=i.x-o,h=i.y-o,u=i.x+o,d=i.y+o,g=n.getBlocksInArea(l,h,u,d),m=new Set;for(const v of g){const M=Vt.getObject(v);if(!M||!(M instanceof zt))continue;const b=this.activeShips.find(ee=>ee.ship===M);if(!b)continue;const C=(y=[...b.ship.getBlockMap().entries()].find(([,ee])=>ee===v))==null?void 0:y[0];if(!C)continue;const w=C,A=b.animationTimers.get(w);if(!A)continue;if(!m.has(M)){if(m.add(M),b.phase!=="shockwave")continue;const ee=M.getTransform(),_=this.camera.worldToScreen(ee.position.x,ee.position.y),z=1-b.shockwaveTimer/this.animationDuration,se=M.getBlockMap().size,oe=250,k=Math.sqrt(se)*20,G=(oe+k)*this.camera.getZoom(),te=Math.max(8,Math.sqrt(se)*2)*this.camera.getZoom();IT(this.ctx,_.x,_.y,z,G,"#00AAFF",te)}const E=M.getTransform(),x=hn(C),I=x.x*X,D=x.y*X,N=Math.cos(E.rotation),H=Math.sin(E.rotation),W=I*N-D*H,K=I*H+D*N,Z=E.position.x+W,Q=E.position.y+K,Y=this.camera.worldToScreen(Z,Q),J=(1-(1-A/this.animationDuration))*.6;this.ctx.save(),this.ctx.translate(Y.x,Y.y),this.ctx.scale(this.camera.getZoom(),this.camera.getZoom()),Qm(this.ctx,v.type.id,v.rotation??0,`rgba(0,255,255,${J.toFixed(3)})`),this.ctx.restore()}}}const _T=`
  precision mediump float;

  attribute vec2 aPosition;

  uniform mat4 uProjectionMatrix;
  uniform mat4 uViewMatrix;
  uniform vec2 uWorldPosition;  // world-space center position
  uniform vec2 uWorldSize;      // half extents in world units

  varying vec2 vUV;

  void main() {
    vec2 scaled = aPosition * uWorldSize; // convert [-1, 1] to world-size quad
    vec2 world = scaled + uWorldPosition;

    gl_Position = uProjectionMatrix * uViewMatrix * vec4(world, 0.0, 1.0);

    vUV = vec2((aPosition.x + 1.0) / 2.0, 1.0 - (aPosition.y + 1.0) / 2.0);
  }
`,DT=`
  precision mediump float;
  uniform sampler2D uTexture;
  uniform float uAlpha;
  varying vec2 vUV;

  void main() {
    vec4 texColor = texture2D(uTexture, vUV);
    gl_FragColor = vec4(texColor.rgb, texColor.a * uAlpha);
  }
`,Il=class Il{constructor(e){this.attribs={aPosition:0},this.gl=e,this.program=Mt(e,_T,DT),this.quadBuffer=Gl(e),this.uniforms={uProjectionMatrix:e.getUniformLocation(this.program,"uProjectionMatrix"),uViewMatrix:e.getUniformLocation(this.program,"uViewMatrix"),uWorldPosition:e.getUniformLocation(this.program,"uWorldPosition"),uWorldSize:e.getUniformLocation(this.program,"uWorldSize"),uTexture:e.getUniformLocation(this.program,"uTexture"),uAlpha:e.getUniformLocation(this.program,"uAlpha")}}static getInstance(e){return this.instance||(this.instance=new Il(e)),this.instance}static destroyInstance(){this.instance&&(this.instance.destroy(),this.instance=null)}renderTexture(e,i,n,o,l,h=1){const u=this.gl,d=ut.getInstance(),g=ae();u.useProgram(this.program),u.bindBuffer(u.ARRAY_BUFFER,this.quadBuffer),u.enableVertexAttribArray(this.attribs.aPosition),u.vertexAttribPointer(this.attribs.aPosition,2,u.FLOAT,!1,0,0);const m=ny(-d.getViewportWidth()/(2*d.getZoom()),d.getViewportWidth()/(2*d.getZoom()),d.getViewportHeight()/(2*d.getZoom()),-d.getViewportHeight()/(2*d.getZoom())),y=d.getPosition(),v=Ju(-y.x,-y.y),M=1/g,b=o*M,C=l*M;u.uniformMatrix4fv(this.uniforms.uProjectionMatrix,!1,m),u.uniformMatrix4fv(this.uniforms.uViewMatrix,!1,v),u.uniform2f(this.uniforms.uWorldPosition,i,n),u.uniform2f(this.uniforms.uWorldSize,b,C),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e),u.uniform1i(this.uniforms.uTexture,0),u.uniform1f(this.uniforms.uAlpha,h),u.enable(u.BLEND),u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA),u.drawArrays(u.TRIANGLE_STRIP,0,4),u.disableVertexAttribArray(this.attribs.aPosition),u.bindTexture(u.TEXTURE_2D,null),u.bindBuffer(u.ARRAY_BUFFER,null),u.disable(u.BLEND),u.useProgram(null)}destroy(){const e=this.gl;e.deleteBuffer(this.quadBuffer),e.deleteProgram(this.program)}};Il.instance=null;let _u=Il;class PT{constructor(e,i,n,o,l,h,u,d,g){this.text=e,this.getPosition=i,this.fontSize=n,this.fontFamily=o,this.life=l,this.speed=h,this.alpha=u,this.color=d,this.behavior=g,this.elapsed=0,this.yOffset=0,this.originalFontSize=n}update(e){var i,n;if(this.elapsed+=e,this.yOffset-=this.speed*e,(i=this.behavior)!=null&&i.impactScale){const o=Math.min(this.elapsed/.15,1),l=1+(this.behavior.impactScale-1)*(1-o);this.fontSize=this.originalFontSize*l}if(((n=this.behavior)==null?void 0:n.fadeOut)!==!1){const o=Math.max(0,this.life-this.elapsed);this.alpha=Math.min(1,o/this.life)}}isExpired(){return this.elapsed>=this.life}render(e){const i=ae(),n=this.getPosition(),o=n.y+this.yOffset;e.save(),e.globalAlpha=this.alpha,e.fillStyle=this.color,e.font=`${Math.round(this.fontSize*i)}px ${this.fontFamily}`,e.textAlign="center",e.textBaseline="middle",e.fillText(this.text,n.x,o),e.restore()}}class LT{constructor(){this.floatingTexts=[],this.channelMap=new Map,this.MERGE_WINDOW_MS=250,this.canvasManager=Ai.getInstance(),this.ctx=this.canvasManager.getContext("ui")}update(e){for(const i of this.floatingTexts)i.update(e);this.floatingTexts=this.floatingTexts.filter(i=>!i.isExpired())}render(){for(const e of this.floatingTexts)e.render(this.ctx)}clear(){this.floatingTexts.length=0,this.channelMap.clear()}createScreenText(e,i,n,o=14,l="monospace",h=.6,u=30,d=1,g="#FFFFFF",m,y){const v=()=>({x:i,y:n});this.create(e,v,o,l,h,u,d,g,m,y)}createWorldText(e,i,n,o,l=14,h="monospace",u=.6,d=30,g=1,m="#FFFFFF",y,v){const M=()=>o.worldToScreen(i,n);this.create(e,M,l,h,u,d,g,m,y,v)}create(e,i,n,o,l,h,u,d,g,m){const y=performance.now();if(m){const M=this.channelMap.get(m);if(M&&y-M.lastUpdate<this.MERGE_WINDOW_MS){const b=parseFloat(M.entity.text),C=parseFloat(e);if(!isNaN(b)&&!isNaN(C)){const w=b+C;M.entity.text=`${Math.round(w)}`,M.entity.alpha=1,M.entity.life=l,M.lastUpdate=y;return}}}const v=new PT(e,i,n,o,l,h,u,d,g);this.floatingTexts.push(v),m&&this.channelMap.set(m,{entity:v,lastUpdate:y})}}class OT{constructor(e,i,n,o,l){this.grid=i,this.combatService=n,this.particleManager=o,this.playerShip=l,this.projectiles=[]}spawnProjectile(e,i,n,o,l=300,h=2,u=1,d,g,m,y){const v=i.x-e.x,M=i.y-e.y;if(Math.sqrt(v*v+M*M)===0)return;let C=Math.atan2(M,v);const w=(1-u)*Math.PI/8;u<1&&(C+=(Math.random()*2-1)*w);const A=Math.cos(C)*l,E=Math.sin(C)*l,x=this.particleManager.emitParticle(e,{colors:m??["#ffff88","#ffaa00","#ffcc33"],baseSpeed:0,sizeRange:[2.2,2.8],lifeRange:[h,h+.1],velocity:{x:A,y:E},light:!0,lightRadiusScalar:20,lightIntensity:.8,fadeMode:y});this.projectiles.push({position:{x:e.x,y:e.y},velocity:{x:A,y:E},type:n,damage:o,life:h,ownerShipId:d,ownerFaction:g,particle:x})}update(e){for(const i of this.projectiles)i.position.x+=i.velocity.x*e,i.position.y+=i.velocity.y*e,i.life-=e;this.projectiles=this.projectiles.filter(i=>i.life>0),this.checkCollisions()}checkCollisions(){for(const e of this.projectiles){const n=this.grid.getBlocksInArea(e.position.x-32,e.position.y-32,e.position.x+32,e.position.y+32,e.ownerFaction);for(const o of n){if(!this.checkCollision(e,o))continue;const l=Vt.getObject(o);if(!l)continue;const h=l.getBlockCoord(o);if(!h)continue;const u=Tt.getInstance().getById(e.ownerShipId);if(u){this.combatService.applyDamageToBlock(l,u,o,h,e.damage,"projectile",this.playerShip),this.removeProjectile(e);return}}}}checkCollision(e,i){if(!i.position)return!1;const n=15,o=i.type.size||32,l=e.position.x-i.position.x,h=e.position.y-i.position.y;return Math.sqrt(l*l+h*h)<n+o/2}removeProjectile(e){this.projectiles=this.projectiles.filter(i=>i!==e),this.particleManager.removeParticle(e.particle)}}let FT=0;function UT(){return`beam-light-${FT++}`}function NT(a){const{start:e,end:i,width:n=16,color:o="#00ffff",intensity:l=1,life:h,expires:u=!1,id:d=UT()}=a;return{id:d,type:"beam",start:e,end:i,width:n,color:o,intensity:l,life:h,maxLife:h,expires:u}}function oy(a){if(!a.length)throw new Error("randomFromArray: cannot select from an empty array");const e=Math.floor(Math.random()*a.length);return a[e]}class un{constructor(){this.objects=new Set,this.idMap=new Map}static getInstance(){return un.instance||(un.instance=new un),un.instance}getById(e){return this.idMap.get(e)}add(e){this.objects.add(e),this.idMap.set(e.id,e)}remove(e){this.objects.delete(e),this.idMap.delete(e.id)}getAll(){return this.objects}getAllIds(){return Array.from(this.idMap.keys())}getFirst5Ids(){return Array.from(this.idMap.keys()).slice(0,5)}clear(){this.objects.clear(),this.idMap.clear()}count(){return this.objects.size}}function tf(a){const i=Tt.getInstance().getById(a.ownerShipId);return i||un.getInstance().getById(a.ownerShipId)||null}function ry(a,e){return e.getBlockCoord(a)}function ua(a,e){const i=e.x*32,n=e.y*32,o=Math.cos(a.rotation),l=Math.sin(a.rotation);return{x:a.position.x+i*o-n*l,y:a.position.y+i*l+n*o}}function cm(a,e,i){const n=Math.cos(i),o=Math.sin(i);return{x:a*n-e*o,y:a*o+e*n}}class HT{constructor(e,i,n,o,l,h){this.camera=i,this.grid=n,this.combatService=o,this.particleManager=l,this.playerShip=h,this.beamLength=2e3,this.activeBeams=[],this.intentMap=new Map,this.ctx=e.getContext("fx")}queueUpdate(e,i,n){this.intentMap.set(e,{intent:n,transform:i})}update(e){var i,n;for(const o of this.activeBeams)o.age+=e,o.intensity=.75+.25*Math.sin(o.age*10),o.glowPulse=.5+.5*Math.sin(o.age*4);this.activeBeams=[];for(const[o,{intent:l,transform:h}]of this.intentMap.entries()){if(!(l!=null&&l.fireSecondary))continue;const u=o.getAllBlocks().filter(([m,y])=>{var v,M;return y.type.id.startsWith("laser")&&((v=y.type.behavior)==null?void 0:v.canFire)&&((M=y.type.behavior.fire)==null?void 0:M.fireType)==="laser"});if(u.length===0)continue;let d=o.getEnergyComponent();if(d||(o.enableEnergyComponent(),d=o.getEnergyComponent()),!d)continue;let g=0;for(const[,m]of u){const y=((n=(i=m.type.behavior)==null?void 0:i.fire)==null?void 0:n.energyCost)??.25;g+=y}if(d.spend(g))for(const[m,y]of u){const v=y.type.behavior.fire,M=ua(h,m);if(!l.aimAt)continue;const C=(typeof y.rotation=="number"?y.rotation:0)*(Math.PI/180),w={x:0,y:-1},A=cm(w.x,w.y,C),E=cm(A.x,A.y,h.rotation),x=E.x,I=E.y,D=M.x+x*this.beamLength,N=M.y+I*this.beamLength;let H=D,W=N;const K=this.grid.getFirstBlockAlongRay(M,{x:D,y:N},o.getFaction());if(K){H=K.point.x,W=K.point.y;const z=tf(K.block),se=z?ry(K.block,z):null;z&&se&&this.combatService.applyDamageToBlock(z,o,K.block,se,v.fireDamage,"laser",this.playerShip)}const Z=128,Q=H-M.x,Y=W-M.y,ne=Q*Q+Y*Y;let J=H,ee=W,_=0;if(ne>1e-4&&(_=1/Math.sqrt(ne),J+=Q*_*Z,ee+=Y*_*Z),this.activeBeams.push({origin:{x:M.x,y:M.y},target:{x:J,y:ee},age:0,intensity:Math.random()*.5+.75,coreWidth:3+Math.random(),glowPulse:Math.random()*Math.PI*2,blockTypeId:y.type.id}),Math.random()<.1){const z=Vp[y.type.id],se=Ze.getInstance();if(ke.getInstance().isLightingEnabled()&&z){const oe=oy(z),k=NT({start:{x:M.x,y:M.y},end:{x:J,y:ee},width:30+Math.random()*4,color:oe,intensity:.15+Math.random()*.4,life:.1+Math.random()*.15,expires:!0});se.registerLight(k);const G=ai({x:M.x,y:M.y,radius:186+Math.random()*32,color:oe,intensity:.4+Math.random()*.3,life:.05+Math.random()*.1,expires:!0});se.registerLight(G)}}}}this.intentMap.clear()}render(){const e=this.ctx;e.save();for(const i of this.activeBeams){const n=this.camera.worldToScreen(i.origin.x,i.origin.y),o=this.camera.worldToScreen(i.target.x,i.target.y),l=Vp[i.blockTypeId]??["#FFFFFF","#00CCFF","#00FFFF"],[h,u,d]=l;e.globalAlpha=i.intensity,e.strokeStyle=h,e.lineWidth=i.coreWidth+Math.sin(i.age*20)*.5,e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(o.x,o.y),e.stroke(),e.globalAlpha=.2+.2*i.glowPulse,e.strokeStyle=u,e.lineWidth=7+Math.sin(i.age*4),e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(o.x,o.y),e.stroke(),e.globalAlpha=.1,e.strokeStyle=d,e.lineWidth=11+2*Math.sin(i.age*2),e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(o.x,o.y),e.stroke()}e.restore()}}function WT(a,e,i){if(e<=0)return;const n=a.getAllBlocks().filter(([,o])=>o.hp<o.type.armor);for(const[,o]of n){const l=o.type.armor-o.hp,h=Math.min(l,e);h>0&&(o.hp+=h,i.createRepairEffect(o.position))}}function zl(a,e,i=300,n=1,o=.5,l="#ffffff"){const h=ai({x:a,y:e,radius:i,intensity:n,life:o,color:l,expires:!0});Ze.getInstance().registerLight(h)}const hm=1,um=3.2,fm=16,GT=48,zT=10,XT=2,VT={currency:1,block:1,repair:1},fl=128,YT={colors:["#ffcc00","#ffaa00","#ff8800","#cc6600"]},mt=class mt{constructor(e,i,n,o,l,h,u){this.camera=e,this.pickups=[],this.blockPickups=[],this.resourcePickups=[],this.currencyPickupPitch=mt.BASE_PICKUP_PITCH,this.blockPickupPitch=mt.BASE_PICKUP_PITCH,this.timeSinceLastCurrencyPickup=0,this.timeSinceLastBlockPickup=0,this.playerResources=Be.getInstance(),this.playerShip=i,this.sparkManager=n,this.screenEffects=o,this.popupMessageSystem=l,this.shipBuilderEffects=h,this.blockDropDecisionMenu=u}spawnCurrencyPickup(e,i){const n=Ze.getInstance(),o=ai({x:e.x,y:e.y,radius:200,color:"#ffcc00",intensity:1,life:1e4,expires:!0});n.registerLight(o);const l={type:{id:"currency",name:"Gold Coin",currencyAmount:i,category:"currency",sprite:"currency",repairAmount:0},position:e,isPickedUp:!1,repairAmount:0,currencyAmount:i,rotation:0,lightId:o.id};this.pickups.push(l),this.resourcePickups.push(l)}spawnRepairPickup(e,i){const n=Ze.getInstance(),o=ai({x:e.x,y:e.y,radius:200,color:"#ff4444",intensity:1,life:1e4,expires:!0});n.registerLight(o);const l={type:{id:"repair",name:"Repair Nanobot Swarm",sprite:"repair",category:"repair",currencyAmount:0,repairAmount:i},position:e,isPickedUp:!1,currencyAmount:0,repairAmount:i,rotation:0,lightId:o.id};this.pickups.push(l),this.resourcePickups.push(l)}spawnBlockPickup(e,i){const n=Ze.getInstance(),o=Si(i.id),l=Yp[o]??"#ffffff",h=ai({x:e.x,y:e.y,radius:300,color:l,intensity:.75,life:1e4,expires:!0});n.registerLight(h);const u={type:{id:`unlock-${i.id}`,name:`${i.name} Blueprint`,sprite:i.sprite,currencyAmount:0,category:"block",blockTypeId:i.id,repairAmount:0},position:e,isPickedUp:!1,repairAmount:0,currencyAmount:0,rotation:0,lightId:h.id};this.pickups.push(u),this.blockPickups.push(u)}render(e){}update(e){var b;this.timeSinceLastCurrencyPickup+=e,this.timeSinceLastBlockPickup+=e,this.timeSinceLastCurrencyPickup>=mt.PITCH_RESET_DELAY&&(this.currencyPickupPitch=mt.BASE_PICKUP_PITCH),this.timeSinceLastBlockPickup>=mt.PITCH_RESET_DELAY&&(this.blockPickupPitch=mt.BASE_PICKUP_PITCH);const i=this.playerShip.getTransform().position,n=600,o=this.playerShip.getTotalHarvestRate()*GT,l=n+o,h=l*l,u=fm*fm,d=Math.random()<.2,g=this.camera.getViewportBounds(),m=g.x-fl,y=g.y-fl,v=g.x+g.width+fl,M=g.y+g.height+fl;for(const C of this.pickups){if(C.isPickedUp)continue;const w=C.position.x,A=C.position.y;if(w<m||w>v||A<y||A>M)continue;if(C.rotation+=(VT[C.type.category]??0)*e,d){let Y;switch(C.type.category){case"block":{const ne=C.type.blockTypeId;if(ne){const J=Si(ne);Y=kM[J]??YT.colors}else Y=["#00ffff"];break}case"repair":Y=["#ff4444","#cc2222","#ff0000","#aa0000"];break;case"currency":default:Y=["#ffcc00","#ffaa00","#ff8800","#cc6600"];break}this.sparkManager.emitParticle(C.position,{colors:Y,baseSpeed:250,sizeRange:[1,2.5],lifeRange:[1,2],fadeOut:!0})}const E=i.x-C.position.x,x=i.y-C.position.y,I=E*E+x*x,D=(()=>{switch(C.type.category){case"currency":case"repair":try{return mS(C.type.id).texture}catch(Y){return console.error(`[PickupSystem] Missing GL sprite for pickup: ${C.type.id}`,Y),null}case"block":try{const Y=wm(C.type.blockTypeId,an.NONE);return(Y==null?void 0:Y.base)??null}catch(Y){return console.error(`[PickupSystem] Failed to load block sprite for pickup: ${C.type.blockTypeId}`,Y),null}default:return console.warn(`[PickupSystem] Unhandled pickup category: ${C.type.category}`),null}})();if(D){let Y=1,ne=X,J=X;if(C.type.category==="currency"){const ee=hm+Math.log2(C.currencyAmount+1)/5;ne*=ee,J*=ee}else if(C.type.category==="repair"){const ee=hm+Math.log2(C.repairAmount+1)/5;ne*=ee,J*=ee}else C.type.category==="block"&&(ne*=um,J*=um);Ku.add({texture:D,worldX:C.position.x,worldY:C.position.y,widthPx:ne,heightPx:J,alpha:Y,rotation:C.rotation})}if(I>h)continue;const N=I/h,H=Math.pow(1-N,XT),W=zT*H,K=Math.sqrt(I),Z=E/K,Q=x/K;if(C.position.x+=Z*W,C.position.y+=Q*W,C.lightId){const Y=Ze.getInstance(),ne=(b=Y.getLightById)==null?void 0:b.call(Y,C.lightId);ne&&ne.type==="point"&&(ne.x=C.position.x,ne.y=C.position.y)}I<u&&this.collectPickup(C)}}async collectPickup(e){e.isPickedUp=!0,e.lightId&&Ze.getInstance().removeLight(e.lightId);const i=d=>{const g=d.indexOf(e);g!==-1&&d.splice(g,1)};i(this.pickups),e.type.category==="block"?i(this.blockPickups):i(this.resourcePickups);const n=this.playerShip.getTransform().position,o=Ze.getInstance();let l=BM[e.type.category]??"#ffffff";if(e.type.category==="block"&&e.type.blockTypeId){const d=Si(e.type.blockTypeId);l=Yp[d]??l}const h=ai({x:n.x,y:n.y,radius:320+Math.random()*100,color:l,intensity:1.2,life:.5,expires:!0});o.registerLight(h);let u=!1;if(e.type.category==="currency"){const d=e.currencyAmount;this.playerResources.addCurrency(d),Te.addCurrency(d),u=await $.play("assets/sounds/sfx/ship/gather_00.wav","sfx",{volume:1.25,pitch:this.currencyPickupPitch+.25,maxSimultaneous:8}),u&&(this.timeSinceLastCurrencyPickup=0,this.currencyPickupPitch=Math.min(this.currencyPickupPitch+mt.PICKUP_PITCH_INCREMENT,mt.MAX_PICKUP_PITCH))}else if(e.type.category==="block"&&e.type.blockTypeId){Te.incrementBlockCollectedCount(),u=await $.play("assets/sounds/sfx/ui/start_00.wav","sfx",{volume:.8,pitch:this.blockPickupPitch,maxSimultaneous:8}),u&&(this.timeSinceLastBlockPickup=0,this.blockPickupPitch=Math.min(this.blockPickupPitch+mt.PICKUP_PITCH_INCREMENT,mt.MAX_PICKUP_PITCH));const d=Si(e.type.blockTypeId),g=ey[d]??["#fff"];zl(n.x,n.y,360,1,.5,g);const m=oi(e.type.blockTypeId);this.blockDropDecisionMenu.enqueueBlock(qb(m))}else if(e.type.category==="repair"){const d=e.repairAmount;WT(this.playerShip,d,this.shipBuilderEffects),$.play("assets/sounds/sfx/ship/repair_00.wav","sfx",{maxSimultaneous:3})}else console.warn("Unhandled pickup category or malformed pickup:",e)}};mt.BASE_PICKUP_PITCH=.8,mt.PICKUP_PITCH_INCREMENT=.05,mt.MAX_PICKUP_PITCH=2.2,mt.PITCH_RESET_DELAY=3.2;let Du=mt;function dl(a,e){return Math.random()*(e-a)+a}function qT(a,e){return Math.floor(Math.random()*(e-a+1))+a}function dm(){return Math.random()*2*Math.PI}const jT=3;class KT{constructor(e){this.lightingOrchestrator=e,this.activeParticles=[],this.particlePool=[],this.CULL_PADDING=128,this.emissionAccumulator=0}_createAndRegisterParticle(e,i){var g,m;const{colors:n=["#00f","#009","#00a9f4","#1e90ff"],sizeRange:o=[1,4],lifeRange:l=[1,2]}=i;let h,u;if(i.randomDirection){const y=dm(),v=((g=i.speedRange)==null?void 0:g[0])??0,M=((m=i.speedRange)==null?void 0:m[1])??i.baseSpeed??1,b=dl(v,M);h=Math.cos(y)*b,u=Math.sin(y)*b}else if(i.velocity)h=i.velocity.x,u=i.velocity.y;else{const y=dm(),v=dl(0,i.baseSpeed??1);h=Math.cos(y)*v,u=Math.sin(y)*v}const d=this.getParticle();if(d.x=e.x,d.y=e.y,d.vx=h,d.vy=u,d.size=dl(o[0],o[1])*jT,d.life=dl(l[0],l[1]),d.initialLife=d.life,d.fadeOut=i.fadeOut??!1,d.fadeMode=i.fadeMode??"linear",d.renderAlpha=1,d.color=n[qT(0,n.length-1)],this.lightingOrchestrator&&i.light){const y=ai({x:d.x,y:d.y,radius:d.size*(i.lightRadiusScalar??3),color:d.color,intensity:i.lightIntensity??1,life:d.life,expires:!0,fadeMode:i.fadeMode??"linear"});this.lightingOrchestrator.registerLight(y),d.lightId=y.id}return this.activeParticles.push(d),d}emitBurst(e,i,n={}){for(let o=0;o<i;o++)this.spawnParticle(e,n)}emitContinuous(e,i,n,o={}){const l=Math.min(i,.05);this.emissionAccumulator+=n*l;const h=Math.floor(this.emissionAccumulator);this.emissionAccumulator-=h;for(let u=0;u<h;u++)this.spawnParticle(e,o)}emitParticle(e,i={}){return this._createAndRegisterParticle(e,i)}spawnParticle(e,i={}){this._createAndRegisterParticle(e,i)}update(e){if(ke.getInstance().isParticlesEnabled()){for(const i of this.activeParticles){if(i.x+=i.vx*e,i.y+=i.vy*e,i.life-=e,i.lightId){const l=this.lightingOrchestrator.getLightById(i.lightId);l&&(l.type==="point"||l.type==="spot")&&(l.x=i.x,l.y=i.y)}const n=i.initialLife?i.life/i.initialLife:1,o=.1;switch(i.fadeMode){case"delayed":i.renderAlpha=n>=o?1:n/o;break;case"linear":default:i.renderAlpha=n;break}}this.activeParticles=this.activeParticles.filter(i=>{const n=i.life>0;return n||this.recycleParticle(i),n})}}getActiveParticles(){return this.activeParticles}getParticle(){return this.particlePool.pop()||{x:0,y:0,vx:0,vy:0,size:1,life:1,color:"#fff",speed:0}}removeParticle(e){const i=this.activeParticles.indexOf(e);i!==-1&&(this.activeParticles.splice(i,1),this.recycleParticle(e))}recycleParticle(e){e.lightId&&(this.lightingOrchestrator.removeLight(e.lightId),e.lightId=void 0),e.initialLife=void 0,e.fadeOut=void 0,e.fadeMode=void 0,e.renderAlpha=void 0,this.particlePool.push(e)}}const ZT=["#fff","#f90","#ff0"],gm=32,QT=16,pm=100,$T=.1;class ly{constructor(e){this.sparkManager=e,this.colorCache=new Map,this.playerSettings=ke.getInstance(),this.lightingOrchestrator=Ze.getInstance()}emit(e){if(!this.playerSettings.isParticlesEnabled())return;const{coord:i,blockRotation:n,shipRotation:o,shipPosition:l,block:h,afterBurner:u,afterBurnerJustActivated:d,pulseJustActivated:g,superPulseJustActivated:m}=e,y=(h==null?void 0:h.type.id)??"",v=this.colorCache.get(y)??RM[y]??ZT;this.colorCache.set(y,v);const M=Math.cos(o),b=Math.sin(o),C=n*(Math.PI/180),w=i.x*gm,A=i.y*gm,E=l.x+(w*M-A*b),x=l.y+(w*b+A*M),I=Math.cos(C),D=Math.sin(C),N=-16*D,H=QT*I,W=E+(N*M-H*b),K=x+(N*b+H*M),Z=D*M-I*b,Q=D*b+I*M,Y=Z*pm,ne=Q*pm,J={x:Y*(u?3:1),y:ne*(u?3:1)};if(this.sparkManager.emitBurst({x:W,y:K},2,{colors:v,velocity:J,baseSpeed:1,sizeRange:u?[2,4]:[1,3],lifeRange:[.08,.18],fadeOut:!0}),d){const ee={x:W,y:K};let _=220,z="#ffffff",se=["#ffffcc","#ffee88","#ffaa44"],oe=12;g&&(_=300,z="#ffcc00",se=["#ffcc00","#ffaa00","#ff8800"],oe=18),m&&(_=300,z="#00ffff",se=["#ccffff","#88ddff","#ffffff"],oe=24),zl(ee.x,ee.y,_,1,.35,z),this.sparkManager.emitBurst(ee,oe,{colors:se,randomDirection:!0,speedRange:[120,320],sizeRange:[1,3],lifeRange:[.25,.65],fadeOut:!0})}if(this.playerSettings.isLightingEnabled()&&Math.random()<$T){const ee=ai({x:W,y:K,radius:25+Math.random()*50,color:v[0],intensity:1+Math.random()*.5,life:.45+Math.random()*.15,expires:!0});this.lightingOrchestrator.registerLight(ee)}}}class JT{constructor(e,i,n,o){this.camera=e,this.inputManager=i,this.cursorRenderer=n,this.playerShip=o,this.isEnginePlaying=!1,this.lastFiringModeSwitchTime=-1/0}getIntent(){const e=this.inputManager.isShiftPressed(),i=this.inputManager.getGamepadMovementVector(),n=Math.hypot(i.x,i.y),o=wt.getInstance().getLastUsed()==="gamepad",l=o&&!e&&n>.1,h=this.inputManager.isActionPressed("brake");let u=!1;h||(o?u=n>.1:u=this.inputManager.isActionPressed("thrustForward"));const d=this.inputManager.isActionPressed("afterburner"),g=u&&d,m={thrustForward:u,brake:h,rotateLeft:this.inputManager.isActionPressed("rotateLeft")&&!(o&&l),rotateRight:this.inputManager.isActionPressed("rotateRight")&&!(o&&l),strafeLeft:this.inputManager.isActionPressed("strafeLeft")||e&&n>.1,strafeRight:this.inputManager.isActionPressed("strafeRight")||e&&n>.1,turnToAngle:l?Math.atan2(i.y,i.x)+Math.PI/2:void 0,afterburner:g},y=this.inputManager.isActionPressed("firePrimary"),v=this.inputManager.isActionPressed("fireSecondary"),M=this.playerShip.getTransform().position,b=this.inputManager.getGamepadAimVector(),C=800,A=b.x!==0||b.y!==0?this.normalize(b.x,b.y):o?{x:Math.cos(this.playerShip.getTransform().rotation-Math.PI/2),y:Math.sin(this.playerShip.getTransform().rotation-Math.PI/2)}:null,E=A?{x:M.x+A.x*C,y:M.y+A.y*C}:this.camera.screenToWorld(this.inputManager.getMousePosition().x,this.inputManager.getMousePosition().y),x={firePrimary:y,fireSecondary:v,aimAt:E,firingMode:this.playerShip.getFiringMode()};y||v?this.cursorRenderer.setTargetCrosshairCursor():this.cursorRenderer.setDefaultCursor();const D={toggleShields:this.inputManager.wasActionJustPressed("fireTertiary")},N=performance.now();if(this.inputManager.wasActionJustPressed("switchFiringMode")&&N-this.lastFiringModeSwitchTime>=1e3){this.lastFiringModeSwitchTime=N;const W=this.playerShip.getFiringMode()===Xt.Synced?Xt.Sequence:Xt.Synced;this.playerShip.setFiringMode(W),$.play("assets/sounds/sfx/ship/attach_00.wav","sfx");const K=W===Xt.Synced?"#00ffff":"#ff0000";zl(M.x,M.y,520,1.2,.4,K)}return{movement:m,weapons:x,utility:D}}normalize(e,i){const n=Math.hypot(e,i);return n>1e-5?{x:e/n,y:i/n}:{x:0,y:0}}}class ew{constructor(e,i,n,o,l){this.inputManager=e,this.canvasManager=i,this.waveSpawner=n,this.playerShip=o,this.coachMarkManager=l,this.dialogueQueueManager=No.create(),this.scriptQueue=[]}initialize(){this.enqueueInitialDialogues(),this.tryStartNextScript()}enqueueInitialDialogues(){const e=Qi.getMissionDialogue();e&&mn(e,this.getDialogueContext())&&this.scriptQueue.push(e)}getDialogueContext(){return{inputManager:this.inputManager,playerShip:this.playerShip,waveSpawner:this.waveSpawner,coachMarkManager:this.coachMarkManager}}tryStartNextScript(){if(this.dialogueQueueManager.isRunning()||this.scriptQueue.length===0)return;const e=this.scriptQueue.shift(),i=mn(e,this.getDialogueContext());i&&this.dialogueQueueManager.startScript(i)}update(e){this.dialogueQueueManager.update(e),this.dialogueQueueManager.isRunning()||this.tryStartNextScript()}render(){const e=this.canvasManager.getContext("dialogue");this.dialogueQueueManager.render(e)}destroy(){this.dialogueQueueManager.clear(),this.dialogueQueueManager.destroy();const e=this.canvasManager.getContext("dialogue");e.clearRect(0,0,e.canvas.width,e.canvas.height)}}const tw=a=>{const e=(a%360+360)%360;return e===0?"forward":e===90?"strafeRight":e===270?"strafeLeft":null},Su=500,mm=.4,iw=2,sw=12,nw=15,aw=.5,ow=3,ym=2,rw=.94,lw=.6,cw=.6,hw=1,uw=1,Mu=8,fw=.15,dw=1.6,gw=2.2,pw=1.4,mw=3.5,yw=1.5;class cy{constructor(e,i,n){this.ship=e,this.emitter=i,this.collisionSystem=n,this.fallbackThrustPower=10,this.baseThrust=5,this.externalImpulse={x:0,y:0},this.afterburnerCharge=0,this.wasAfterburnerActiveLastFrame=!1,this.currentIntent={thrustForward:!1,brake:!1,rotateLeft:!1,rotateRight:!1,strafeLeft:!1,strafeRight:!1}}setIntent(e){this.currentIntent=e}applyExternalImpulse(e,i){this.externalImpulse.x+=e,this.externalImpulse.y+=i}getAfterburnerCharge(){return this.afterburnerCharge}rotateVector(e,i,n){const o=Math.cos(n),l=Math.sin(n);return{x:e*o-i*l,y:e*l+i*o}}getBlockThrustDirection(e){const i=e*(Math.PI/180),n=Math.sin(i),o=-Math.cos(i);return{x:n,y:o}}updateAfterburnerCharge(e){const i=this.ship.getAfterburnerComponent(),n=this.currentIntent.afterburner??!1;let o=!1;if(i){i.setActive(n),i.update(e);const l=i.isActive();o=l&&!this.wasAfterburnerActiveLastFrame,this.wasAfterburnerActiveLastFrame=l,l?this.afterburnerCharge=Math.min(1,this.afterburnerCharge+mw*e):this.afterburnerCharge=Math.max(0,this.afterburnerCharge-yw*e)}else this.afterburnerCharge=0,this.wasAfterburnerActiveLastFrame=!1;return o}getAfterburnerMultipliers(){const e=this.afterburnerCharge,i=this.ship.getAfterburnerSpeedMultiplier()||dw,n=this.ship.getAfterburnerAccelMultiplier()||gw;return{speed:1+(i-1)*e,accel:1+(n-1)*e,turning:1+(pw-1)*e}}update(e){var W,K;const i=this.ship.getTransform(),{position:n,velocity:o}=i,{rotateLeft:l,rotateRight:h,thrustForward:u,brake:d,strafeLeft:g,strafeRight:m}=this.currentIntent,y=this.updateAfterburnerCharge(e),v=this.getAfterburnerMultipliers();this.ship.setThrusting(u),this.ship.setStrafingLeft(g),this.ship.setStrafingRight(m),o.x+=this.externalImpulse.x,o.y+=this.externalImpulse.y,this.externalImpulse.x=0,this.externalImpulse.y=0;const M=this.ship.getTotalMass(),b=Math.min(1,Math.pow(Su/Math.max(M,1),cw)),C={forward:[],strafeLeft:[],strafeRight:[]};let w=iw;for(const[Z,Q]of this.ship.getAllBlocks()){const Y=Q.type.behavior;if(Y!=null&&Y.canThrust){const ne=Y.thrustPower??this.baseThrust,J=tw(Q.rotation??0);J&&C[J].push({coord:Z,power:ne,rotation:Q.rotation??0})}Q.type.id.startsWith("fin")&&(w+=(Y==null?void 0:Y.turnPower)??0)}const A=Math.min(sw,Math.pow(w,rw)),E=Math.min(A*b*lw*v.turning,nw);let x=0;if(this.currentIntent.turnToAngle!==void 0){const{rotation:Z}=i;let Y=this.currentIntent.turnToAngle-Z;for(;Y>Math.PI;)Y-=2*Math.PI;for(;Y<-Math.PI;)Y+=2*Math.PI;x=Y*ym*v.turning,x=Math.max(-E,Math.min(x,E))}else l?x=-E:h&&(x=E);const I=x-i.angularVelocity;if(i.angularVelocity+=I*ym*v.turning*e,i.angularVelocity=Math.max(-E,Math.min(i.angularVelocity,E)),u&&this.applyDirectionalThrust(e,"forward",C.forward,i,n,v,y),g&&this.applyDirectionalThrust(e,"strafeLeft",C.strafeLeft,i,n,v,y),m&&this.applyDirectionalThrust(e,"strafeRight",C.strafeRight,i,n,v,y),!u&&!g&&!m){const Z=Math.pow(aw,e);o.x*=Z,o.y*=Z}if(d){const Z=Math.hypot(o.x,o.y);if(Z>0){const Q=o.x/Z,Y=o.y/Z,ee=([...C.forward,...C.strafeLeft,...C.strafeRight].reduce((oe,k)=>oe+k.power,0)+this.fallbackThrustPower)*e*hw,_=o.x-Q*ee,z=o.y-Y*ee;_*o.x+z*o.y<0?(o.x=0,o.y=0):(o.x=_,o.y=z)}}if(this.ship.getIsPlayerShip()){this.collisionSystem.resolveCollisions(this.ship);const Z=i.velocity;Z.x=Math.round(Z.x*1e3)/1e3,Z.y=Math.round(Z.y*1e3)/1e3}const{thrustPowerMulti:D=1,turnPowerMulti:N=1}=this.ship.getAffixes()??{};i.rotation+=i.angularVelocity*e*N,n.x+=o.x*e*D,n.y+=o.y*e*D;const H=(K=(W=this.ship).getLightAuraId)==null?void 0:K.call(W);if(H)try{Ze.getInstance().updateLight(H,n)}catch(Z){console.warn(`[MovementSystem] Aura light update failed for ship ${this.ship.id}`,Z)}this.ship.updateBlockPositions()}applyDirectionalThrust(e,i,n,o,l,h,u){var ee,_,z,se,oe;let d=0,g=0;const m=this.fallbackThrustPower,y=n.length+1,v=uw,b=n.reduce((k,G)=>k+G.power,0)+m,C=(()=>{if(y<=Mu)return b*v;const k=b/y*Mu,G=y-Mu,te=b/y,ie=1/(1+fw*G),re=te*G*ie;return(k+re)*v})(),w=this.ship.getTotalMass(),A=Math.min(1,Math.pow(Su/Math.max(w,1),mm)),E=C*h.speed*A,x=(()=>{switch(i){case"forward":return this.rotateVector(0,-1,o.rotation);case"strafeLeft":return this.rotateVector(-1,0,o.rotation);case"strafeRight":return this.rotateVector(1,0,o.rotation)}})();d+=x.x*m,g+=x.y*m;const I=Tt.getInstance().getPlayerShip();let D=!1,N=!1,H=!1,W=!1,K=!1;if(I&&I!==this.ship){const k=ut.getInstance().getViewportBounds(),G=100,te=k.x-G,ie=k.y-G,re=k.x+k.width+G,ve=k.y+k.height+G,ue=this.ship.getTransform().position;D=ue.x>=te&&ue.x<=re&&ue.y>=ie&&ue.y<=ve}else N=((ee=this.ship.getAfterburnerComponent())==null?void 0:ee.wasAfterburnerJustActivated())??!1,H=((_=this.ship.getAfterburnerComponent())==null?void 0:_.wasPulseJustActivated())??!1,W=((z=this.ship.getAfterburnerComponent())==null?void 0:z.isPulsing())??!1,K=((se=this.ship.getAfterburnerComponent())==null?void 0:se.wasSuperPulseJustActivated())??!1,D=!0;this.ship.getIsPlayerShip()&&((H||K||N)&&this.emitPulseSoundAndShake(this.ship.id,H,K),K&&zl(this.ship.getTransform().position.x,this.ship.getTransform().position.y,300,1.5,.5,"#ffffff"));for(const{coord:k,power:G,rotation:te}of n){const ie=this.ship.getBlock(k);if(!ie)continue;const re=this.getBlockThrustDirection(te),ve=this.rotateVector(re.x,re.y,o.rotation);d+=ve.x*G,g+=ve.y*G,D&&this.emitter.emit({coord:k,block:ie,blockRotation:te,shipRotation:o.rotation,shipPosition:l,afterBurner:((oe=this.ship.getAfterburnerComponent())==null?void 0:oe.isActive())??!1,afterBurnerJustActivated:u,isPulsing:W,pulseJustActivated:H,superPulseJustActivated:K})}const Z=Math.min(1,Math.pow(Su/Math.max(w,1),mm)),Q=d*e*Z*h.accel,Y=g*e*Z*h.accel;o.velocity.x+=Q,o.velocity.y+=Y;const ne=Math.sqrt(o.velocity.x**2+o.velocity.y**2);if(ne>0){const k=o.velocity.x/ne,G=o.velocity.y/ne,te=x.x-k,ie=x.y-G,re=ow*h.turning;o.velocity.x+=te*re*ne*e,o.velocity.y+=ie*re*ne*e}const J=o.velocity.x*x.x+o.velocity.y*x.y;if(J>E){const G=1/(1+.5*(J/E-1)),te=J-J*G;o.velocity.x-=x.x*te,o.velocity.y-=x.y*te}}emitPulseSoundAndShake(e,i=!1,n=!1){const o=Tt.getInstance(),l=o.getPlayerShip(),h=o.getById(e);let u="assets/sounds/sfx/explosions/afterburner_00.wav";if(n?u="assets/sounds/sfx/ui/sub_00.wav":i&&(u="assets/sounds/sfx/explosions/afterburner_00.wav"),h&&(si(h,l,{file:u,channel:"sfx",baseVolume:1,pitchRange:[1,1.3],volumeJitter:.15,maxSimultaneous:5}),n&&si(h,l,{file:"assets/sounds/sfx/explosions/superpulse_00.wav",channel:"sfx",baseVolume:1,pitchRange:[1.1,1.4],volumeJitter:.1,maxSimultaneous:5})),h&&h===l){let d=4,g=.16;i&&(d=6,g=.18),n&&(d=9,g=.2),pe.emit("camera:shake",{strength:d,duration:g,frequency:10})}}}const nf=class nf{static register(e,i){this.registry.set(e.id,i)}static unregister(e){this.registry.delete(e.id)}static get(e){return this.registry.get(e.id)}static clear(){this.registry.clear()}};nf.registry=new Map;let Lo=nf;function vm(a){return typeof a.getAffixes=="function"?a.getAffixes()??{}:{}}const rt=class rt{constructor(e){this.combatService=e,this._blockCache=new Map}resolveCollisions(e){if(!ke.getInstance().isCollisionsEnabled())return;this._blockCache.clear();const i=this.getNearbyObjects(e);for(const n of i){if(!this.aabbOverlap(e,n))continue;e.setColliding(!0),n.setColliding(!0),this.applyCollisionDamage(e,n);const o=this.computeMinimumSeparationVector(e,n);o&&(this.resolvePenetration(e,n,o),this.resolveImpulse(e,n,o))}}getCachedBlocks(e){const i=this._blockCache.get(e);if(i)return i;const n=Array.from(e.getAllBlocks());return this._blockCache.set(e,n),n}getNearbyObjects(e){const i=this.computeAABB(e),n=e.getGrid().getBlocksInArea(i.x,i.y,i.x+i.width,i.y+i.height),o=new Set;for(const l of n){const h=Vt.getObject(l);h&&h!==e&&o.add(h)}return Array.from(o)}aabbOverlap(e,i){const n=this.computeAABB(e),o=this.computeAABB(i);return!(n.x+n.width<o.x||n.x>o.x+o.width||n.y+n.height<o.y||n.y>o.y+o.height)}computeAABB(e){let i=1/0,n=-1/0,o=1/0,l=-1/0;for(const[h]of this.getCachedBlocks(e)){const u=ua(e.getTransform(),h);i=Math.min(i,u.x),n=Math.max(n,u.x),o=Math.min(o,u.y),l=Math.max(l,u.y)}return{x:i,y:o,width:n-i+rt.BLOCK_SIZE,height:l-o+rt.BLOCK_SIZE}}computeMinimumSeparationVector(e,i){const n=[],o=e.getTransform(),l=i.getTransform();e:for(const[b]of this.getCachedBlocks(e)){const C=ua(o,b);for(const[w]of this.getCachedBlocks(i)){const A=ua(l,w);if(this.blocksOverlap(C,A)&&(n.push({a:C,b:A}),n.length>=rt.MAX_OVERLAP_PAIRS))break e}}if(n.length===0)return null;let h=0,u=0;for(const b of n)h+=b.a.x-b.b.x,u+=b.a.y-b.b.y;const d=n.length;h/=d,u/=d;const g=Math.sqrt(h*h+u*u);if(g===0)return null;const m=rt.BLOCK_SIZE/2,y=rt.PENETRATION_SLOP,v=rt.PENETRATION_CORRECTION_RATIO,M=Math.max(m-y,0)*v;return{x:h/g*M,y:u/g*M}}blocksOverlap(e,i){const n=rt.BLOCK_SIZE;return Math.abs(e.x-i.x)<n&&Math.abs(e.y-i.y)<n}resolvePenetration(e,i,n){var d,g;const o=((d=e.isImmoveable)==null?void 0:d.call(e))??!1,l=((g=i.isImmoveable)==null?void 0:g.call(i))??!1,h=e.getTransform(),u=i.getTransform();if(!(o&&l))if(o)u.position.x-=n.x,u.position.y-=n.y,i.updateBlockPositions();else if(l)h.position.x+=n.x,h.position.y+=n.y,e.updateBlockPositions();else{const m=e.getTotalMass(),y=i.getTotalMass(),v=m+y||1,M=y/v,b=m/v;h.position.x+=n.x*M,h.position.y+=n.y*M,u.position.x-=n.x*b,u.position.y-=n.y*b,e.updateBlockPositions(),i.updateBlockPositions()}}resolveImpulse(e,i,n){var N,H;const o=((N=e.isImmoveable)==null?void 0:N.call(e))??!1,l=((H=i.isImmoveable)==null?void 0:H.call(i))??!1,h=e.getTransform(),u=i.getTransform(),d=h.velocity,g=u.velocity,m=d.x-g.x,y=d.y-g.y,v=m*n.x+y*n.y;if(v>=0)return;const M=e.getTotalMass(),b=i.getTotalMass(),C=M+b||1,w=rt.RESTITUTION,A=Math.max(v,-200),E=-(1+w)*A/C;if(Math.abs(E)<rt.IMPULSE_EPSILON)return;const x=E*n.x,I=E*n.y,D=.95;o&&l||(o?(g.x+=x,g.y+=I,g.x*=D,g.y*=D):l?(d.x-=x,d.y-=I,d.x*=D,d.y*=D):(d.x-=x*b/C,d.y-=I*b/C,g.x+=x*M/C,g.y+=I*M/C,d.x*=D,d.y*=D,g.x*=D,g.y*=D))}applyCollisionDamage(e,i){const n=this.computeRelativeVelocity(e,i),o=Math.sqrt(n.x**2+n.y**2),l=70,h=1500,u=50;if(o<l)return;const g=(Math.min(o,h)-l)/(h-l),y=Math.pow(g,1.35)*u;let v=0;const M=10;e:for(const[b,C]of this.getCachedBlocks(e)){const w=ua(e.getTransform(),b);for(const[A,E]of this.getCachedBlocks(i)){const x=ua(i.getTransform(),A);if(!this.blocksOverlap(w,x))continue;const I=C.type.behavior??{},D=E.type.behavior??{},N=I.rammingDamageMultiplier??1,H=D.rammingDamageMultiplier??1,W=I.rammingArmor??0,K=D.rammingArmor??0,Z=vm(e)??{},Q=vm(i)??{},Y=Z.rammingDamageInflictMultiplier??1,ne=Q.rammingDamageInflictMultiplier??1,J=Z.rammingArmorMultiplier??1,ee=Q.rammingArmorMultiplier??1,_=W*J,z=K*ee,se=y*N*Y,oe=Math.max(0,se-z);if(this.combatService.applyDamageToBlock(i,e,E,A,oe,"collision",null),v++,v>=M)break e;const k=y*H*ne,G=Math.max(0,k-_);if(this.combatService.applyDamageToBlock(e,i,C,b,G,"collision",null),v++,v>=M)break e}}}computeRelativeVelocity(e,i){const n=e.getTransform().velocity,o=i.getTransform().velocity;return{x:n.x-o.x,y:n.y-o.y}}};rt.BLOCK_SIZE=32,rt.PENETRATION_SLOP=4,rt.PENETRATION_CORRECTION_RATIO=.4,rt.RESTITUTION=.2,rt.IMPULSE_EPSILON=.05,rt.MAX_OVERLAP_PAIRS=10;let Pu=rt;class hy{constructor(...e){this.currentIntent=null,this.backends=e}setIntent(e){this.currentIntent=e}update(e,i,n){for(const o of this.backends)o.update(e,i,n,this.currentIntent)}render(e){for(const i of this.backends)i.render&&i.render(e)}destroy(){for(const e of this.backends)e.destroy&&e.destroy()}}class uy{constructor(...e){this.currentIntent=null,this.backends=e}setIntent(e){this.currentIntent=e}update(e,i,n){for(const o of this.backends)o.update(e,i,n,this.currentIntent)}}class vw{constructor(e){this.name=e}render(e,i,n,o){if(n&&!o){const l=ae(),h=i.getViewportWidth()/2,u=32*l;xt(e,h,u,this.name,{font:`${l*24}px "Courier New", monospace`,align:"center",baseline:"top",glow:!0,chromaticAberration:!0}),xt(e,h,u+32*l,"Open Communications: [C]",{font:`${l*16}px "Courier New", monospace`,align:"center",baseline:"top",glow:!0,chromaticAberration:!0})}}update(e){}}class fy{constructor(e,i,n,o,l,h,u){this.x=e,this.y=i,this.playerShip=n,this.inputManager=o,this.camera=l,this.definition=h,this.waveSpawner=u,this.isInteracting=!1,this.renderer=new vw(h.name),this.dialogueQueueManager=No.create()}calculateRanges(){const e=this.playerShip.getTransform().position.x,i=this.playerShip.getTransform().position.y,n=this.x-e,o=this.y-i,l=n*n+o*o,h=this.definition.scale*1e3+1e3,u=h*h,d=(h*.5)**2,g=(h*.25)**2;return{inDrawingRange:l<=u,inTransmissionRange:l<=d,inInteractionRange:l<=g,dx:n,dy:o}}update(e){const{inTransmissionRange:i,inInteractionRange:n}=this.calculateRanges();if(this.renderer.update(e),n&&this.inputManager.wasKeyJustPressed("KeyC")&&!this.isInteracting){this.isInteracting=!0;const o=mn(this.definition.interactionDialogueId,{inputManager:this.inputManager,playerShip:this.playerShip,waveSpawner:this.waveSpawner});o&&this.dialogueQueueManager.startScript(o)}this.dialogueQueueManager.isRunning()?(this.dialogueQueueManager.update(e),this.inputManager.wasMouseClicked()&&this.dialogueQueueManager.skipOrAdvance()):this.isInteracting=!1}render(e,i,n){const{inDrawingRange:o,inTransmissionRange:l,inInteractionRange:h,dx:u,dy:d}=this.calculateRanges();o&&this.renderer.render(i,this.camera,h,this.isInteracting),this.dialogueQueueManager.render(n)}getPosition(){return{x:this.x,y:this.y}}}const bw={name:"Ferrust",imagePath:"assets/planets/17.png",scale:5,interactionDialogueId:"planet-generic"},Sw={name:"Gilipe",imagePath:"assets/planets/5.png",scale:8,interactionDialogueId:"planet-generic"},Mw={name:"Arsea",imagePath:"assets/planets/6.png",scale:10,interactionDialogueId:"planet-generic"},El=new Map;function sf(a){if(El.has(a.name))throw new Error(`Duplicate planet registration: ${a.name}`);El.set(a.name,a)}sf(bw);sf(Sw);sf(Mw);const dy={getPlanetByName(a){const e=El.get(a);if(!e)throw new Error(`Planet "${a}" not found in registry`);return e},getAll(){return Array.from(El.values())}},Cw={createPlanetByName(a,e,i,n,o,l,h){const u=dy.getPlanetByName(a);return new fy(e,i,n,o,l,u,h)}};class Tw{constructor(e,i,n,o,l,h){this.playerShip=e,this.inputManager=i,this.camera=n,this.canvasManager=o,this.waveSpawner=l,this.unifiedRenderer=h,this.planets=new Set,this.ctx=o.getContext("background"),this.overlayCtx=o.getContext("ui"),this.dialogueCtx=o.getContext("dialogue"),this.unifiedRenderer=h}registerPlanetsFromConfigs(e){for(const{name:i,x:n,y:o}of e)this.registerPlanetByName(i,n,o)}registerPlanet(e,i,n){const o=new fy(i,n,this.playerShip,this.inputManager,this.camera,e,this.waveSpawner);this.planets.add(o),this.unifiedRenderer.addPlanet({name:e.name,x:i,y:n},e.scale??1,e.imagePath)}registerPlanetByName(e,i,n){const o=Cw.createPlanetByName(e,i,n,this.playerShip,this.inputManager,this.camera,this.waveSpawner);this.planets.add(o);const l=dy.getPlanetByName(e);this.unifiedRenderer.addPlanet({name:e,x:i,y:n},l.scale??1,l.imagePath)}getPlanets(){return Array.from(this.planets)}clear(){this.planets.clear()}update(e){for(const i of this.planets)i.update(e)}render(e){for(const i of this.planets)i.render(this.ctx,this.overlayCtx,this.dialogueCtx)}}class ww{constructor(e){this.pickupSystem=e}spawnPickupOnBlockDestruction(e){var h,u,d,g;const i=e.type,n=i.dropRate??0,o=Qi.getDropMultiplier(),l=Math.min(n*o,1);if(Math.random()<l){const m={x:((h=e.position)==null?void 0:h.x)??0,y:((u=e.position)==null?void 0:u.y)??0};this.pickupSystem.spawnBlockPickup(m,i);return}if(Math.random()<.2){const m={x:((d=e.position)==null?void 0:d.x)??0,y:((g=e.position)==null?void 0:g.y)??0};if(Math.random()<.07){const y=this.getRepairAmountForBlock(e);this.pickupSystem.spawnRepairPickup(m,y)}else{const y=this.getCurrencyAmountForBlock(e);this.pickupSystem.spawnCurrencyPickup(m,y)}}}getCurrencyAmountForBlock(e){const i=e.type.id,n=Si(i),l={0:5,1:10,2:15,3:25,4:35,5:40,6:45,7:50,8:60,9:75,10:80}[n]??0,h=Math.floor(Math.random()*1.5);return l+h}getRepairAmountForBlock(e){const i=e.type.id,n=Si(i),l={0:10,1:15,2:20,3:30,4:40,5:55,6:70,7:80,8:90,9:95,10:100}[n]??5,h=Math.floor(Math.random()*2);return l+h}}function Aw(a,e){const i=a.getTransform(),n={position:i.position,rotation:i.rotation},o=a.getAllBlocks().map(([l,h])=>(e.addBlockToCell(h),{id:h.type.id,coord:l,rotation:h.rotation??0}));return{transform:n,blocks:o,behavior:{type:"default"}}}function kw(a,e){return fetch(wi(`/assets/ships/${a}`)).then(i=>i.json()).then(i=>{var o;const n=new zt(e);return n.loadFromJson(i),{ship:n,behaviorType:(o=i.behavior)==null?void 0:o.type}})}function Rw(a,e,i){const n=Aw(a,e),o=JSON.stringify(n,null,2);localStorage.setItem(i,o);const l=new Blob([o],{type:"application/json"}),h=document.createElement("a");h.href=URL.createObjectURL(l),h.download=i,h.click()}class Ew{constructor(e,i,n,o,l){this.ship=e,this.menu=i,this.camera=n,this.shipBuilderEffects=o,this.inputManager=l,this.rotation=0,this.lastBlockId=null,this.hasSaved=!1,this.hoveredShipCoord=null}update(e){var u;this.inputManager.wasKeyJustPressed("Space")&&(this.rotation=(this.rotation+90)%360);const i=this.inputManager.getMousePosition();if(this.isCursorOverMenu(i))return;const n=Ma(i,this.camera,e.position,e.rotation);if(this.menu.getActiveTool()===_e.REPAIR){const d=this.ship.getBlock(n);this.menu.setHoveredShipBlock(d),d&&this.inputManager.wasMouseClicked()&&($.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n));return}const o=this.menu.getSelectedBlockId();if(!o||(o!==this.lastBlockId&&(this.rotation=0,this.lastBlockId=o),!Ki(o)))return;const h=Tm(o);if(h!==void 0){if(this.inputManager.wasRightClicked()){const d=this.ship.getBlock(n);if(!d)return;if(!d.type.id.startsWith("cockpit")){if(!this.ship.isDeletionSafe(n)){$.play("assets/sounds/sfx/ui/error_00.wav","sfx",{maxSimultaneous:3});return}this.shipBuilderEffects.createSellEffect(d.position),this.ship.removeBlock(n),$.play("assets/sounds/sfx/ui/click_00.wav","sfx",{maxSimultaneous:3});const m=Math.round(h/2);Be.getInstance().addCurrency(m)}}if(Be.getInstance().hasEnoughCurrency(h)&&this.inputManager.wasMouseClicked()&&!this.ship.hasBlockAt(n)&&$u(this.ship,n)){this.ship.placeBlockById(n,o,this.rotation);const d=this.ship.getBlock(n);d!=null&&d.position&&this.shipBuilderEffects.createRepairEffect(d.position);const g=((u=oi(o))==null?void 0:u.placementSound)??"assets/sounds/sfx/ship/gather_00.wav";$.play(g,"sfx",{maxSimultaneous:3}),Be.getInstance().spendCurrency(h),Te.incrementBlockPlacedCount()}this.inputManager.isLPressed()&&!this.hasSaved&&(Rw(this.ship,this.ship.getGrid(),"saved_player_ship.json"),this.hasSaved=!0),!this.inputManager.isLPressed()&&this.hasSaved&&(this.hasSaved=!1)}}render(e,i){const n=this.inputManager.getMousePosition();if(this.isCursorOverMenu(n))return;const o=Ma(n,this.camera,i.position,i.rotation),l=o.x*X,h=o.y*X,u=Math.cos(i.rotation),d=Math.sin(i.rotation),g=l*u-h*d,m=l*d+h*u,y=i.position.x+g,v=i.position.y+m,M=this.camera.worldToScreen(y,v);e.save(),e.translate(M.x,M.y),e.scale(this.camera.getZoom(),this.camera.getZoom()),e.rotate(i.rotation);const b=this.menu.getActiveTool();if(b===_e.REPAIR)this.ship.getBlock(o)&&$m(e,"rgba(0,255,0,0.3)");else if(b===_e.PLACE){const C=this.menu.getSelectedBlockId();if(!C){e.restore();return}if(this.ship.getBlock(o)){const A=this.ship.isDeletionSafe(o);Qu(e,A)}else{const A=Ki(C);e.save(),e.rotate(this.rotation*Math.PI/180),e.globalAlpha=.6,e.drawImage(A.base,-32/2,-32/2,X,X),e.restore()}}e.restore()}isCursorOverMenu(e){return this.menu.isPointInBounds(e.x,e.y)}repairBlockAt(e){const i=this.ship.getBlock(e);if(!i||i.type.armor-i.hp<=0)return;const o=Ci(i),l=Be.getInstance();l.hasEnoughCurrency(o)&&(l.spendCurrency(o),i.hp=i.type.armor,this.shipBuilderEffects.createRepairEffect(i.position))}repairAllBlocks(){const e=Be.getInstance(),i=this.ship.getAllBlocks().filter(([,n])=>n.hp<n.type.armor).map(([n,o])=>({coord:n,block:o})).sort((n,o)=>{const l=n.block.type.armor-n.block.hp,h=o.block.type.armor-o.block.hp;if(l!==h)return h-l;const u=Ci(n.block),d=Ci(o.block);return u-d});for(const{coord:n,block:o}of i){const l=Ci(o);if(e.hasEnoughCurrency(l))$.play("assets/sounds/sfx/ship/repair_00.wav","sfx"),this.repairBlockAt(n);else{console.log("Stopped repair: insufficient funds.");break}}}getHoveredShipBlock(){return this.hoveredShipCoord?this.ship.getBlock(this.hoveredShipCoord):void 0}}class Bw{constructor(e,i,n,o){this.explosionSystem=e,this.pickupSpawner=i,this.shipRegistry=n,this.aiOrchestrator=o,this.destructionCallbacks=new Set}onEntityDestroyed(e){this.destructionCallbacks.add(e)}offEntityDestroyed(e){this.destructionCallbacks.delete(e)}destroyEntity(e,i="scripted"){var h,u,d;const n=e.getTransform(),o=e.getAllBlocks();e.getTotalMass();const l=e.id;if(this.destructionCallbacks.forEach(g=>{try{g(e,i)}catch(m){console.error("Error in destruction callback:",m)}}),e instanceof zt&&(this.shipRegistry.remove(e),Lo.unregister(e),(u=(h=this.aiOrchestrator).removeControllersForShip)==null||u.call(h,l)),e.destroy(),o.forEach(([g,m],y)=>{setTimeout(()=>{this.explosionSystem.createBlockExplosion(n.position,n.rotation,g,50+Math.random()*40,.5+Math.random()*.5,void 0,fa),this.pickupSpawner.spawnPickupOnBlockDestruction(m)},y*50)}),e instanceof zt){if(ke.getInstance().isLightingEnabled()){const v=Ze.getInstance(),M="#ffffff",b=1.25,C=4*e.getTotalMass(),A=ai({x:n.position.x,y:n.position.y,radius:C,color:M,intensity:b,life:.5,expires:!0});v.registerLight(A)}const g=(d=e.getCockpitCoord)==null?void 0:d.call(e);if(!g)return;const m=ay(e,g),y=v=>`${v.x},${v.y}`;for(const[v,M]of o)m.has(y(v))||setTimeout(()=>{this.explosionSystem.createBlockExplosion(n.position,n.rotation,v,60+Math.random()*20,.5+Math.random()*.3,void 0,fa),this.pickupSpawner.spawnPickupOnBlockDestruction(M)},50+Math.random()*100)}}}class Iw{constructor(){this.formations=new Map}registerFormation(e){this.formations.set(e.formationId,e)}getFormation(e){return this.formations.get(e)}removeFormation(e){this.formations.delete(e)}clear(){this.formations.clear()}getLeaderIdForShip(e){for(const i of this.formations.values())if(i.leaderId===e||i.members.some(n=>n.shipId===e))return i.leaderId;return null}getOffsetForShip(e){for(const i of this.formations.values()){const n=i.members.find(o=>o.shipId===e);if(n)return n.offset}return null}getFormationByShipId(e){for(const i of this.formations.values())if(i.leaderId===e||i.members.some(n=>n.shipId===e))return i;return null}}const gl=5e3,xl=class xl{constructor(){this.playerShip=null,this.grid=null,this.controllerToShipMap=new Map,this.shipIdToControllerMap=new Map,this.formationRegistry=new Iw,this.cachedRelevantBlocks=[],this.frameCounter=0,this.REEVALUATE_FRAMES=60,this.uncullableControllers=new Set,xl.instance=this}registerPlayerShip(e){this.playerShip=e,this.grid=e.getGrid()}addController(e,i=!1){const n=e.getShip();if(!n)return;n.updateBlockPositions(),this.controllerToShipMap.set(e,n),this.shipIdToControllerMap.set(n.id,e),this.setUncullable(e,i||e.isHunter()),e.setCullabilityDelegate(this);const o=this.formationRegistry.getFormationByShipId(n.id);if(o)if(o.leaderId===n.id)e.setFormationContext(o.formationId,"leader");else{const l=this.shipIdToControllerMap.get(o.leaderId)??null;l&&e.setFormationContext(o.formationId,"follower",this.formationRegistry,l)}}removeController(e){const i=this.controllerToShipMap.get(e);i&&this.shipIdToControllerMap.delete(i.id),this.controllerToShipMap.delete(e),this.uncullableControllers.delete(e)}getAllControllers(){return this.controllerToShipMap.entries()}removeControllersForShip(e){const i=[];for(const[n,o]of this.controllerToShipMap.entries())o.id===e&&i.push(n);for(const n of i)this.removeController(n)}getControllerCount(){return this.controllerToShipMap.size}getFormationRegistry(){return this.formationRegistry}getUncullableControllerCount(){return this.uncullableControllers.size}setUncullable(e,i){if(!this.controllerToShipMap.has(e)){console.warn("[AIOrchestrator] Attempted to set uncullable status for unregistered controller.");return}const n=this.uncullableControllers.has(e);i&&!n?this.uncullableControllers.add(e):!i&&n&&this.uncullableControllers.delete(e)}setCullable(e){if(!this.controllerToShipMap.has(e)){console.warn("[AIOrchestrator] Attempted to set cullable status for unregistered controller.");return}this.uncullableControllers.has(e)&&this.uncullableControllers.delete(e)}clear(){this.controllerToShipMap.clear(),this.shipIdToControllerMap.clear(),this.uncullableControllers.clear()}update(e){if(!this.playerShip||!this.grid)return;if(this.frameCounter++%this.REEVALUATE_FRAMES===0){const l=this.playerShip.getTransform().position,h=l.x-gl,u=l.x+gl,d=l.y-gl,g=l.y+gl;this.cachedRelevantBlocks=this.grid.getBlocksInArea(h,d,u,g)}const i=new Set;for(const l of this.uncullableControllers){if(l.getShip().isDestroyed()){this.removeController(l);continue}i.add(l)}const n=new Set;for(const l of this.cachedRelevantBlocks)l.ownerShipId&&n.add(l.ownerShipId);for(const l of n){const h=this.shipIdToControllerMap.get(l);h&&i.add(h)}const o=[];for(const l of i)try{const h=l.getShip();if(!h||typeof h.getAllBlocks!="function"){o.push(l);continue}l.update(e)}catch(h){console.error("Error updating AI controller:",h),o.push(l)}for(const l of o)this.removeController(l)}render(e){for(const[i]of this.controllerToShipMap)try{typeof i.render=="function"&&i.render(e)}catch(n){console.error("Error rendering AI controller:",n)}}getUncullableControllerStates(){return Array.from(this.uncullableControllers).map(e=>e.getCurrentStateString())}};xl.instance=null;let Lu=xl;const Oo={default:Hm,rammer:tn,strafe:T1,spaceStation:Wm};function bm(a){return a in Oo}var pl,xw=new Uint8Array(16);function _w(){if(!pl&&(pl=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!pl))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return pl(xw)}const Dw=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Pw(a){return typeof a=="string"&&Dw.test(a)}var ot=[];for(var Cu=0;Cu<256;++Cu)ot.push((Cu+256).toString(16).substr(1));function Lw(a){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=(ot[a[e+0]]+ot[a[e+1]]+ot[a[e+2]]+ot[a[e+3]]+"-"+ot[a[e+4]]+ot[a[e+5]]+"-"+ot[a[e+6]]+ot[a[e+7]]+"-"+ot[a[e+8]]+ot[a[e+9]]+"-"+ot[a[e+10]]+ot[a[e+11]]+ot[a[e+12]]+ot[a[e+13]]+ot[a[e+14]]+ot[a[e+15]]).toLowerCase();if(!Pw(i))throw TypeError("Stringified UUID is invalid");return i}function Ow(a,e,i){a=a||{};var n=a.random||(a.rng||_w)();return n[6]=n[6]&15|64,n[8]=n[8]&63|128,Lw(n)}class Fw{constructor(e){this.shipFactory=e}async spawnFormation(e,i,n){const o=new Map,l=this.shipFactory.getOrchestrator(),h=l.getFormationRegistry(),u=Ow(),d=[],g=e.layout,m=e.leader,y=e.followers;let v;typeof m.behaviorProfile=="string"&&bm(m.behaviorProfile)?v=Oo[m.behaviorProfile]:typeof m.behaviorProfile=="object"&&(v=m.behaviorProfile);const{ship:M,controller:b}=await this.shipFactory.createShip(m.shipId,i,n,m.hunter??!1,v,m.affixes??{},void 0,!1,e.unCullable??!1),C=[];for(let w=0;w<y.length;w++){const A=y[w],E=g[w],x=i+E.x,I=n+E.y;let D;typeof A.behaviorProfile=="string"&&bm(A.behaviorProfile)?D=Oo[A.behaviorProfile]:typeof A.behaviorProfile=="object"&&(D=A.behaviorProfile);const{ship:N,controller:H}=await this.shipFactory.createShip(A.shipId,x,I,A.hunter??!1,D,A.affixes??{},void 0,!1,e.unCullable??!1);H.setInitialState(new Ul(H,N)),d.push({shipId:N.id,offset:E}),C.push(H),o.set(N,H)}h.registerFormation({formationId:u,leaderId:M.id,members:d}),l.addController(b,e.unCullable??!1);for(const w of C)l.addController(w,e.unCullable??!1);return o.set(M,b),o}}class gy{constructor(e,i){this.projectileSystem=e,this.playerShip=i,this.fireSoundTimer=0,this.wasFiringLastFrame=!1}update(e,i,n,o){const l=i.getFiringPlan().filter(y=>y.block.type.id.startsWith("turret")||y.block.type.id.startsWith("cockpit"));if(l.length===0)return;const{fireRateMulti:h=1}=i.getAffixes(),u=o==null?void 0:o.aimAt,d=(o==null?void 0:o.firePrimary)??!1,g=(o==null?void 0:o.firingMode)??Xt.Synced;this.fireSoundTimer++;for(const y of l)y.timeSinceLastShot+=e;const m=d&&!this.wasFiringLastFrame;this.wasFiringLastFrame=d,!(!d||!u)&&(g===Xt.Synced?this.handleSyncedFiring(l,i,n,u,h,e):g===Xt.Sequence&&this.handleSequenceFiring(l,i,n,u,h,e,m))}handleSyncedFiring(e,i,n,o,l,h){for(let u=e.length-1;u>=0;u--){const d=e[u];i.getBlockCoord(d.block)&&(d.timeSinceLastShot<d.fireCooldown/l||(this.spawnTurretProjectile(i,n,d,o),d.timeSinceLastShot=0))}}handleSequenceFiring(e,i,n,o,l,h,u){const d=new Map;for(const m of e){const y=m.block.type.id;d.has(y)||d.set(y,[]),d.get(y).push(m)}const g=i.turretSequenceState;for(const[m,y]of d.entries()){if(y.length===0)continue;const M=y[0].fireCooldown/l,b=M/y.length;let C=g[m];if(C||(C=g[m]={nextIndex:0,lastFiredAt:b}),u){const w=y.find(A=>A.timeSinceLastShot>=M);if(w){const A=y.indexOf(w);this.spawnTurretProjectile(i,n,w,o),w.timeSinceLastShot=0,C.nextIndex=(A+1)%y.length,C.lastFiredAt=0;continue}}if(C.lastFiredAt+=h,C.lastFiredAt>=b){const w=y[C.nextIndex%y.length];if(!i.getBlockCoord(w.block))continue;w.timeSinceLastShot>=M&&(this.spawnTurretProjectile(i,n,w,o),w.timeSinceLastShot=0,C.nextIndex=(C.nextIndex+1)%y.length,C.lastFiredAt=0)}}}spawnTurretProjectile(e,i,n,o){const{coord:l,block:h}=n;n.timeSinceLastShot=0;const u=l.x*32,d=l.y*32,g=Math.cos(i.rotation),m=Math.sin(i.rotation),y=i.position.x+u*g-d*m,v=i.position.y+u*m+d*g,M=h.type.behavior.fire,b=h.type.id,C=Xp[b]??Xp.turret0;this.fireSoundTimer>5&&(si(e,this.playerShip,{file:"assets/sounds/sfx/weapons/turret_00.wav",channel:"sfx",pitchRange:[.7,1.4],volumeJitter:.2,baseVolume:1,maxSimultaneous:7}),this.fireSoundTimer=0),this.projectileSystem.spawnProjectile({x:y,y:v},o,M.fireType,M.fireDamage,M.projectileSpeed??300,M.lifetime??2,M.accuracy??1,e.id,e.getFaction(),C,"delayed")}render(e){}}class py{constructor(e){this.laserSystem=e,this.fireEligibility=new WeakMap}update(e,i,n,o){if(!(o!=null&&o.fireSecondary)){this.fireEligibility.set(i,!1);return}const l=i.getEnergyComponent();if(!l)return;if(!(this.fireEligibility.get(i)??!1))if(l.getCurrent()>=15)this.fireEligibility.set(i,!0);else return;i.getAllBlocks().filter(([d,g])=>{var m,y;return g.type.id.startsWith("laser")&&((m=g.type.behavior)==null?void 0:m.canFire)&&((y=g.type.behavior.fire)==null?void 0:y.fireType)==="laser"}).length!==0&&this.laserSystem.queueUpdate(i,n,o)}render(e){}}class my{constructor(e,i,n,o,l){this.combatService=e,this.particleManager=i,this.grid=n,this.explosionSystem=o,this.playerShip=l,this.activeLances=[]}update(e,i,n,o){const l=i.getFiringPlan().filter(d=>{var g,m;return((m=(g=d.block.type.behavior)==null?void 0:g.fire)==null?void 0:m.fireType)==="explosiveLance"});if(l.length===0)return;const h=o==null?void 0:o.aimAt,u=(o==null?void 0:o.firePrimary)??!1;for(let d=l.length-1;d>=0;d--){const g=l[d];if(!i.getBlockCoord(g.block)||(g.timeSinceLastShot+=e,!u||g.timeSinceLastShot<g.fireCooldown))continue;g.timeSinceLastShot=0;const m=g.block.type.behavior.fire,y=m.lifetime??1.5,v=g.coord,M=Math.cos(n.rotation),b=Math.sin(n.rotation),C=v.x*32,w=v.y*32,A=n.position.x+C*M-w*b,E=n.position.y+C*b+w*M,x=h.x-A,I=h.y-E;if(Math.sqrt(x*x+I*I)===0)continue;let N=Math.atan2(I,x);const H=(1-(m.accuracy??1))*Math.PI/8;N+=(Math.random()*2-1)*H;const W=Math.cos(N)*(m.projectileSpeed??300),K=Math.sin(N)*(m.projectileSpeed??300),Z=Bo[g.block.type.id]??["#ccc","#aaa","#888"],Q=this.particleManager.emitParticle({x:A,y:E},{colors:Z,baseSpeed:0,sizeRange:[4,4],lifeRange:[m.lifetime??1.5,(m.lifetime??1.5)+.1],velocity:{x:W,y:K}}),Y=ai({x:A,y:E,radius:600,color:Z[0],intensity:.9,life:y+.4,expires:!0});Ze.getInstance().registerLight(Y),si(i,this.playerShip,{file:"assets/sounds/sfx/weapons/lance_00.wav",channel:"sfx",baseVolume:.8,pitchRange:[.8,1.2],volumeJitter:.1,maxSimultaneous:3}),this.activeLances.push({position:{x:A,y:E},velocity:{x:W,y:K},fireDamage:m.fireDamage??10,explosionDamage:m.explosionDamage??30,explosionRadius:m.explosionRadiusBlocks??2,detonationDelay:m.detonationDelayMs/1e3,elapsed:0,stuck:!1,targetBlock:null,targetShip:null,coord:null,ownerShipId:i.id,particle:Q,ttl:y,age:0,emissionAccumulatorTrail:0,emissionAccumulatorStuck:0,firingBlockId:g.block.type.id,light:Y})}this.updateLances(e,i)}updateLances(e,i){const n=new Set;for(const o of this.activeLances){o.age+=e;const l=Bo[o.firingBlockId]??["#ccc","#aaa","#888"];o.emissionAccumulatorTrail+=e*20;const h=Math.floor(o.emissionAccumulatorTrail);o.emissionAccumulatorTrail-=h;for(let d=0;d<h;d++)this.particleManager.emitParticle(o.position,{colors:l,baseSpeed:20,sizeRange:[1,2],lifeRange:[.3,.5],fadeOut:!0});if(o.age>o.ttl&&!o.stuck){this.particleManager.removeParticle(o.particle),n.add(o);continue}if(o.stuck){if(o.targetShip&&o.anchorOffset){const m=o.targetShip.getTransform().position;o.position.x=m.x+o.anchorOffset.x,o.position.y=m.y+o.anchorOffset.y,o.particle.x=o.position.x,o.particle.y=o.position.y}o.emissionAccumulatorStuck+=e*20;const d=Math.floor(o.emissionAccumulatorStuck);o.emissionAccumulatorStuck-=d;const g=Bo[o.firingBlockId]??["#ccc","#aaa","#888"];for(let m=0;m<d;m++)this.particleManager.emitParticle(o.position,{colors:g,baseSpeed:300,sizeRange:[1,3],lifeRange:[.4,.9],fadeOut:!0});o.elapsed+=e,o.elapsed>=o.detonationDelay&&(this.explodeLance(o,i),n.add(o));continue}o.position.x+=o.velocity.x*e,o.position.y+=o.velocity.y*e,o.light.x=o.position.x,o.light.y=o.position.y;const u=this.grid.getRelevantCells(o.position);for(const d of u){const g=this.grid.getBlocksInCellByCoords(d.x,d.y,i.getFaction());for(const m of g){if(m.ownerShipId===o.ownerShipId||!m.position)continue;const y=o.position.x-m.position.x,v=o.position.y-m.position.y;if(Math.sqrt(y*y+v*v)<32){const b=tf(m),C=b?ry(m,b):null;if(b&&C){o.stuck=!0,o.targetBlock=m,o.targetShip=b,o.coord=C;const w=b.getTransform().position;if(o.anchorOffset={x:o.position.x-w.x,y:o.position.y-w.y},o.velocity={x:0,y:0},o.particle.vx=0,o.particle.vy=0,o.particle.life=o.detonationDelay+.2,o.particle.size*=1.25,si(this.playerShip,i,{file:"assets/sounds/sfx/weapons/lance_01.wav",channel:"sfx",baseVolume:.9,pitchRange:[.8,1.2],volumeJitter:.1,maxSimultaneous:5}),pe.emit("camera:shake",{strength:6,duration:.16,frequency:10}),this.combatService.applyDamageToBlock(b,i,m,C,o.fireDamage,"explosiveLance",this.playerShip)){this.explodeLance(o,i),n.add(o);continue}}break}}}}this.activeLances=this.activeLances.filter(o=>!n.has(o))}explodeLance(e,i){var o;if(!e.targetShip||!e.coord)return;Ze.getInstance().removeLight(e.light.id);const n=e.targetShip.getBlocksWithinGridDistance(e.coord,e.explosionRadius);for(const l of n){const h=e.targetShip.getBlockCoord(l);h&&(this.explosionSystem.createBlockExplosion(e.targetShip.getTransform().position,e.targetShip.getTransform().rotation,h,e.explosionRadius*64,.7,(o=Bo[e.firingBlockId])==null?void 0:o[0],Bo[e.firingBlockId]),this.combatService.applyDamageToBlock(e.targetShip,i,l,h,e.explosionDamage,"explosiveLanceAoE",this.playerShip))}this.particleManager.removeParticle(e.particle)}render(e){}}class yy{constructor(e,i,n,o){this.combatService=e,this.particleManager=i,this.grid=n,this.ship=o,this.orbiters=[],this.tierPhases=new Map,this.energyRingSprites=new Map,this.energyRingSprites=new Map([["energyRing0",wo("energyRing0")],["energyRing1",wo("energyRing1")],["energyRing2",wo("energyRing2")],["energyRing3",wo("energyRing3")],["energyRing4",wo("energyRing4")]])}render(e){}update(e,i,n,o){const l=this.ship.getHaloBladeBlocks(),h=Array.from(l.keys());this.orbiters=this.orbiters.filter(m=>l.has(m.block));for(const m of h)if(!this.orbiters.find(y=>y.block===m)){const y=l.get(m);this.orbiters.push({block:m,angle:0,radius:y.orbitingRadius,position:{x:0,y:0},sprite:this.energyRingSprites.get(y.sprite)})}const u=i.getTransform().position,d=new Map;for(const m of this.orbiters){const y=m.block.type.id;d.has(y)||d.set(y,[]),d.get(y).push(m)}for(const[m,y]of d.entries()){if(y.length===0)continue;const v=l.get(y[0].block);if(!v)continue;const M=i.getFiringMode()===Xt.Sequence,b=M?1:-1;let C=this.tierPhases.get(m)??Math.random()*Math.PI*2;C+=v.orbitingSpeed*e*b,this.tierPhases.set(m,C),y.sort((A,E)=>{const x=A.block.id,I=E.block.id;return x.localeCompare(I)});const w=y.length;for(let A=0;A<w;A++){const E=y[A],x=C+A/w*Math.PI*2;E.angle=x,E.radius=v.orbitingRadius;const I=M?E.radius:E.radius*.5;E.position.x=u.x+Math.cos(x)*I,E.position.y=u.y+Math.sin(x)*I,Ku.add({texture:E.sprite.texture,worldX:E.position.x,worldY:E.position.y,widthPx:64,heightPx:64,alpha:1}),this.particleManager.emitParticle(E.position,{colors:[v.color,"#fff"],baseSpeed:0,sizeRange:[.8,1.2],lifeRange:[.3,.8],fadeOut:!0,light:!0,lightRadiusScalar:32,lightIntensity:.7})}}const g=new Set(d.keys());for(const m of this.tierPhases.keys())g.has(m)||this.tierPhases.delete(m);for(const m of this.orbiters){const y=l.get(m.block);if(!y)continue;const v=m.position.x,M=m.position.y,b=this.grid.getRelevantCells({x:v,y:M});for(const C of b){const w=this.grid.getBlocksInCellByCoords(C.x,C.y,i.getFaction());for(const A of w){if(!A.position)continue;const E=v-A.position.x,x=M-A.position.y;if(Math.sqrt(E*E+x*x)<y.size/2+16){const D=tf(A),N=D==null?void 0:D.getBlockCoord(A);D&&N&&this.combatService.applyDamageToBlock(D,i,A,N,y.damage,"haloBlade",this.ship)}}}}}}class vy{constructor(){this.wasPressedLastFrame=new WeakMap}update(e,i,n,o){var d;const l=!!(o!=null&&o.toggleShields),h=this.wasPressedLastFrame.get(i)??!1;if(this.wasPressedLastFrame.set(i,l),!l||h)return;const u=(d=i.getShieldComponent)==null?void 0:d.call(i);u&&u.hasShieldBlocks()&&(u.isActive()?($.play("assets/sounds/sfx/ship/energy-shield-reverse_00.wav","sfx",{maxSimultaneous:3}),u.deactivate()):($.play("assets/sounds/sfx/ship/energy-shield_00.wav","sfx",{maxSimultaneous:3}),u.activate()))}}class Uw{constructor(e,i,n,o,l){this.initialState=null,this.cullabilityDelegate=null,this.formationId=null,this.formationRole=null,this.formationRegistry=null,this.leaderController=null,this.hunter=!1,this.ship=e,this.movementSystem=i,this.weaponSystem=n,this.utilitySystem=o,this.behaviorProfile=l,this.currentState=new Nl(this,e)}update(e){if(!(!this.ship||!this.ship.getTransform))try{const i=this.currentState.update(e);this.movementSystem.setIntent(i.movement),this.weaponSystem.setIntent(i.weapons),this.movementSystem.update(e),this.utilitySystem.setIntent(i.utility),this.utilitySystem.update(e,this.ship,this.ship.getTransform()),this.weaponSystem.update(e,this.ship,this.ship.getTransform());const n=this.currentState.transitionIfNeeded();n&&this.setState(n)}catch(i){console.error("Error in AIControllerSystem update:",i)}}setState(e){this.currentState=e,e.onEnter()}render(e){try{this.weaponSystem.render(e)}catch(i){console.error("Error in AIControllerSystem render:",i)}}getShip(){return this.ship}getBehaviorProfile(){return this.behaviorProfile}getCurrentState(){return this.currentState}getCurrentStateString(){return this.currentState.constructor.name}setHunter(e){this.hunter=e}setCullabilityDelegate(e){this.cullabilityDelegate=e}makeUncullable(){var e;(e=this.cullabilityDelegate)==null||e.setUncullable(this,!0)}makeCullable(){var e;(e=this.cullabilityDelegate)==null||e.setCullable(this)}isHunter(){return this.hunter}setFormationContext(e,i,n,o){this.formationId=e,this.formationRole=i,i==="follower"&&n&&o&&(this.formationRegistry=n,this.leaderController=o)}getFormationRegistry(){return this.formationRegistry}getFormationLeaderController(){return this.leaderController}clearFormationContext(){this.formationId=null,this.formationRole=null,this.formationRegistry=null,this.leaderController=null}getFormationId(){return this.formationId}isInFormation(){return this.formationId!==null}isFormationLeader(){return this.formationRole==="leader"}isFormationFollower(){return this.formationRole==="follower"}setInitialState(e){this.initialState=e,this.setState(e)}getInitialState(){return this.initialState}}function Sm(a){return a in Oo}class Nw{constructor(e,i,n,o,l,h,u,d,g,m,y){this.grid=e,this.registry=i,this.orchestrator=n,this.playerShip=o,this.particleManager=l,this.projectileSystem=h,this.laserSystem=u,this.combatService=d,this.explosionSystem=g,this.collisionSystem=m,this.shipConstructionAnimator=y}async createShip(e,i,n,o=!1,l,h={},u=xs.Enemy,d=!0,g=!1){const{ship:m,behaviorType:y}=await kw(`${e}.json`,this.grid);y&&!Sm(y)&&console.warn(`[AI] Unknown behaviorType "${y}"  falling back to default.`),m.setAffixes(h),m.setFaction(u);const v=m.getTransform();v.position.x=i,v.position.y=n,this.registry.add(m);const M=new ly(this.particleManager),b=new cy(m,M,this.collisionSystem),C=new hy(new gy(this.projectileSystem,this.playerShip),new py(this.laserSystem),new my(this.combatService,this.particleManager,this.grid,this.explosionSystem,this.playerShip),new yy(this.combatService,this.particleManager,this.grid,m)),w=new uy(new vy),A=l??(typeof y=="string"&&Sm(y)?Oo[y]:void 0)??Hm,E=new Uw(m,b,C,w,A);if(A.initialStateFactory){const I=A.initialStateFactory(E);E.setInitialState(I)}E.setHunter(o),d&&this.orchestrator.addController(E,g),m.hideAllBlocks(),m.updateBlockPositions();const x={color:"#ff0000",radius:96,intensity:.8};return this.shipConstructionAnimator.animateShipConstruction(m,x),{ship:m,controller:E}}getOrchestrator(){return this.orchestrator}}const Mm=0;class Hw{constructor(e,i,n,o,l,h,u,d,g,m,y,v,M,b){this.waves=e,this.shipRegistry=i,this.aiOrchestrator=n,this.playerShip=o,this.projectileSystem=l,this.laserSystem=h,this.particleManager=u,this.grid=d,this.combatService=g,this.explosionSystem=m,this.collisionSystem=y,this.shipConstructionAnimator=v,this.incidentSystem=M,this.popupMessageSystem=b,this.currentWaveIndex=Mm,this.elapsedTime=0,this.timeSinceStart=0,this.isRunning=!1,this.isPaused=!1,this.hasSpawnedFirstWave=!1,this.initialDelay=10,this.defaultWaveInterval=10,this.interWaveDelay=10,this.interWaveCountdown=-1,this.waitingToSpawnNextWave=!1,this.activeWave=null,this.activeShips=new Set,this.activeControllers=new Map,this.onMissionComplete=null,this.missionCompleteTriggered=!1,this.shipFactory=new Nw(this.grid,this.shipRegistry,this.aiOrchestrator,this.playerShip,this.particleManager,this.projectileSystem,this.laserSystem,this.combatService,this.explosionSystem,this.collisionSystem,this.shipConstructionAnimator),this.shipFormationFactory=new Fw(this.shipFactory)}setMissionCompleteHandler(e){this.onMissionComplete=e}start(){this.isRunning=!0,this.timeSinceStart=0}pause(){this.isPaused=!0}resume(){this.isPaused=!1}getIsRunning(){return this.isRunning}getIsPaused(){return this.isPaused}update(e){var i,n;if(!(!this.isRunning||this.isPaused)){if(!this.hasSpawnedFirstWave){if(this.timeSinceStart+=e,this.timeSinceStart<this.initialDelay)return;const o=this.waves[this.currentWaveIndex];this.spawnWave(o),this.currentWaveIndex++,this.elapsedTime=0,this.hasSpawnedFirstWave=!0;return}if(this.waitingToSpawnNextWave){if(this.interWaveCountdown-=e,this.interWaveCountdown<=0&&(this.waitingToSpawnNextWave=!1,this.currentWaveIndex<this.waves.length)){const o=this.waves[this.currentWaveIndex];this.spawnWave(o),this.currentWaveIndex++,this.elapsedTime=0}return}if(!(((i=this.activeWave)==null?void 0:i.type)==="boss"&&!this.activeWave.isComplete)){if(this.shouldCompleteMission()){this.missionCompleteTriggered||(this.missionCompleteTriggered=!0,console.log("Mission completed!"),(n=this.onMissionComplete)==null||n.call(this),this.onMissionComplete=null);return}if(this.elapsedTime+=e,this.currentWaveIndex<this.waves.length){const o=this.waves[this.currentWaveIndex],l=o.waveDurationSeconds??this.defaultWaveInterval;this.elapsedTime>=l&&(Te.incrementWavesCleared(),this.spawnWave(o),this.currentWaveIndex++,this.elapsedTime=0)}}}}shouldCompleteMission(){const e=this.currentWaveIndex>=this.waves.length,i=this.activeShips.size===0,n=!this.waitingToSpawnNextWave;return e&&i&&n}clearCurrentWave(){for(const e of this.activeShips){this.shipRegistry.remove(e);const i=this.activeControllers.get(e);i&&(this.aiOrchestrator.removeController(i),this.activeControllers.delete(e)),e.destroy()}this.activeShips.clear(),this.activeWave&&this.incidentSystem.clear(this.activeWave.id)}async spawnWave(e){var o,l;this.activeWave={id:e.id,type:e.type,mods:e.mods,isComplete:!1},e.type==="boss"&&this.clearCurrentWave();const i=this.currentWaveIndex===1&&e.type!=="boss",n=[];if((o=e.formations)!=null&&o.length)for(const h of e.formations){const u=h.count??1;for(let d=0;d<u;d++){const{x:g,y:m}=this.getSpawnCoordinates(e.type,i),y=await this.shipFormationFactory.spawnFormation(h,g,m);for(const[v,M]of y)this.applyModifiers(v,e.mods),this.activeShips.add(v),this.activeControllers.set(v,M),n.push(v)}}for(const h of e.ships)for(let u=0;u<h.count;u++){const{x:d,y:g}=this.getSpawnCoordinates(e.type,i),{ship:m,controller:y}=await this.shipFactory.createShip(h.shipId,d,g,h.hunter??!1,h.behaviorProfile,h.affixes??{});this.applyModifiers(m,e.mods),this.activeShips.add(m),this.activeControllers.set(m,y),n.push(m)}for(const h of e.incidents??[])Math.random()<=h.spawnChance&&(console.log(`[WaveSpawner] Triggering incident '${h.script}' (wave ${e.id})`),this.incidentSystem.trigger(h.script,h.options??{},e.id));e.type==="boss"?($.playMusic(e.music??{file:"assets/sounds/music/track_03_boss.mp3"}),this.popupMessageSystem.displayMessage(" DANGER ",{color:"#ff5555",duration:4,glow:!0,font:"28px monospace"}),(l=e.lightingSettings)!=null&&l.clearColor,this.monitorBossWaveCompletion(n)):this.popupMessageSystem.displayMessage("Wave "+e.id,{color:"#00ff00",duration:3,glow:!0,font:"28px monospace"})}getSpawnCoordinates(e,i=!1){const n={xMin:-1200,xMax:1200,yMin:-1200,yMax:1200},o=10;for(let u=0;u<o;u++){const d=e==="boss"?(Math.random()-.5)*200:Math.random()*gn-gn/2,g=e==="boss"?(Math.random()-.5)*200:Math.random()*ba-ba/2;if(!i)return{x:d,y:g};if(d<n.xMin||d>n.xMax||g<n.yMin||g>n.yMax||e==="boss")return{x:d,y:g}}const l=Math.random()<.5?n.xMin-200-Math.random()*200:n.xMax+200+Math.random()*200,h=Math.random()<.5?n.yMin-200-Math.random()*200:n.yMax+200+Math.random()*200;return{x:l,y:h}}skipToNextWave(){var i;if(this.currentWaveIndex>=this.waves.length||(this.activeWave&&(this.activeWave.isComplete=!0),this.currentWaveIndex>=this.waves.length))return;const e=this.waves[this.currentWaveIndex];if(((i=this.activeWave)==null?void 0:i.type)==="boss"){this.waitingToSpawnNextWave=!0,this.interWaveCountdown=this.interWaveDelay,this.activeWave=null;return}this.spawnWave(e),this.currentWaveIndex++,this.elapsedTime=0,this.waitingToSpawnNextWave=!1}applyModifiers(e,i){for(const n of i)switch(n){case"shielded":break;case"extra-aggressive":break;default:console.warn(`Unknown wave modifier: ${n}`)}}monitorBossWaveCompletion(e){const i=new Set(e);for(const n of e)n.onDestroyedCallback(()=>{var o;i.has(n)&&(i.delete(n),i.size===0&&((o=this.activeWave)==null?void 0:o.type)==="boss"&&(this.activeWave.isComplete=!0,console.log(`Boss wave ${this.activeWave.id} defeated.`),this.currentWaveIndex>=this.waves.length||(this.waitingToSpawnNextWave=!0,this.interWaveCountdown=this.interWaveDelay)))})}getCurrentWaveNumber(){return this.currentWaveIndex}getTimeUntilNextWave(){var n;if(this.waitingToSpawnNextWave)return Math.ceil(this.interWaveCountdown);if(this.currentWaveIndex===0&&this.timeSinceStart<this.initialDelay)return Math.ceil(this.initialDelay-this.timeSinceStart);if(((n=this.activeWave)==null?void 0:n.type)==="boss"&&!this.activeWave.isComplete||this.shouldCompleteMission())return-1;const e=this.waves[this.currentWaveIndex],i=(e==null?void 0:e.waveDurationSeconds)??this.defaultWaveInterval;return Math.max(0,i-this.elapsedTime)}isBossWaveActive(){var e;return((e=this.activeWave)==null?void 0:e.type)==="boss"&&!this.activeWave.isComplete}isBossWaveComplete(){var e;return((e=this.activeWave)==null?void 0:e.type)==="boss"&&this.activeWave.isComplete}notifyShipDestruction(e){this.activeShips.has(e)&&Te.incrementKillCount(),this.activeShips.delete(e),this.activeControllers.get(e)&&this.activeControllers.delete(e)}reset(){this.clearCurrentWave(),this.currentWaveIndex=Mm,this.isRunning=!1,this.hasSpawnedFirstWave=!1,this.elapsedTime=0,this.timeSinceStart=0,this.interWaveCountdown=-1,this.waitingToSpawnNextWave=!1,this.activeWave=null,this.activeShips.clear(),this.activeControllers.clear(),this.onMissionComplete=null,this.missionCompleteTriggered=!1}}function Ww(a){pe.emit("incident:minimap:marker",a)}function Cm(a){pe.emit("incident:minimap:clear",{id:a})}class by{constructor(e,i,n,o){this.minimapRegistered=!1,this.id=e,this.options=i,this.waveId=n,this.context=o}getId(){return this.id}getWaveId(){return this.waveId}getMinimapIcon(){return null}onTrigger(){const e=this.getMinimapIcon(),{x:i,y:n}=this.options;e&&typeof i=="number"&&typeof n=="number"&&(Ww({id:this.id,icon:e,x:i,y:n}),this.minimapRegistered=!0)}onComplete(){this.minimapRegistered&&(Cm(this.id),this.minimapRegistered=!1),Te.incrementIncidentsCompleted()}destroy(){this.minimapRegistered&&(Cm(this.id),this.minimapRegistered=!1)}}class Gw extends by{constructor(e,i,n,o){super(e,i,n,o),this.elapsed=0,this.lifetime=5,this.nextLogTime=0}getMinimapIcon(){return"skullAndBones"}onTrigger(){super.onTrigger(),console.log(`[BlackHoleIncident] Triggered at (${this.options.x}, ${this.options.y})`),this.context.popupMessageSystem.displayMessage(" BLACK HOLE SPAWNED ",{color:"#ff5555",duration:3,glow:!0,font:"28px monospace"})}update(e){this.elapsed+=e,this.elapsed>=this.nextLogTime&&(console.log(`[BlackHoleIncident] ${this.elapsed.toFixed(1)}s elapsed (id=${this.getId()})`),this.nextLogTime=Math.ceil(this.elapsed))}isComplete(){return this.elapsed>=this.lifetime}onComplete(){console.log(`[BlackHoleIncident] Complete (total time: ${this.elapsed.toFixed(1)}s)`)}destroy(){console.log(`[BlackHoleIncident] Destroyed prematurely (elapsed: ${this.elapsed.toFixed(1)}s)`)}}class zw extends by{constructor(e,i,n,o){super(e,i,n,o),this.elapsed=0,this.lifetime=6,this.nextLogTime=0}getMinimapIcon(){return"greenCross"}onTrigger(){console.log(`[HealingBeaconIncident] Deployed at (${this.options.x}, ${this.options.y})`),this.context.popupMessageSystem.displayMessage(" Healing Beacon Online ",{color:"#00ffaa",duration:3,font:"26px monospace",glow:!0})}update(e){this.elapsed+=e,this.elapsed>=this.nextLogTime&&(console.log(`[HealingBeaconIncident] Active for ${this.elapsed.toFixed(1)}s (id=${this.getId()})`),this.nextLogTime=Math.ceil(this.elapsed))}isComplete(){return this.elapsed>=this.lifetime}onComplete(){console.log(`[HealingBeaconIncident] Completed after ${this.elapsed.toFixed(1)}s`)}destroy(){console.log(`[HealingBeaconIncident] Destroyed early at ${this.elapsed.toFixed(1)}s`)}}class Xw{constructor(){this.scriptConstructors=new Map,this.registerAll()}registerAll(){this.register("BlackHoleIncident",Gw),this.register("HealingBeaconIncident",zw)}register(e,i){if(this.scriptConstructors.has(e)){console.warn(`[IncidentRegistry] Duplicate script ID: '${e}'`);return}this.scriptConstructors.set(e,i)}has(e){return this.scriptConstructors.has(e)}create(e,i,n,o){const l=this.scriptConstructors.get(e);return l?new l(e,i,n,o):(console.warn(`[IncidentRegistry] Unknown incident script ID: '${e}'`),null)}getRegisteredScriptIds(){return Array.from(this.scriptConstructors.keys())}}class Vw{constructor(e){this.activeIncidents=new Map,this.registry=new Xw,this.context=e}trigger(e,i={},n){const o=this.registry.create(e,i,n,this.context);if(!o){console.warn(`[IncidentOrchestrator] Unknown incident script: '${e}'`);return}const l=o.getId();if(this.activeIncidents.has(l)){console.warn(`[IncidentOrchestrator] Duplicate incident ID '${l}'  skipping trigger.`);return}this.activeIncidents.set(l,o),o.onTrigger()}update(e){var i,n;for(const[o,l]of this.activeIncidents)l.update(e),l.isComplete()&&((i=l.onComplete)==null||i.call(l),(n=l.destroy)==null||n.call(l),this.activeIncidents.delete(o))}render(e){var n;const i=this.context.canvasManager;for(const o of this.activeIncidents.values())(n=o.render)==null||n.call(o,i,e)}clear(e){var i;for(const[n,o]of this.activeIncidents)(e===void 0||o.getWaveId()===e)&&((i=o.destroy)==null||i.call(o),this.activeIncidents.delete(n))}destroy(){var e;for(const i of this.activeIncidents.values())(e=i.destroy)==null||e.call(i);this.activeIncidents.clear()}getActiveCount(){return this.activeIncidents.size}getActiveIncidentIds(){return Array.from(this.activeIncidents.keys())}}class Yw extends ef{constructor(e,i,n){super(e,i,n)}update(e){const i=this.transform;i.position.x+=i.velocity.x*e,i.position.y+=i.velocity.y*e,i.rotation+=i.angularVelocity*e,this.updateBlockPositions()}onDestroyed(){}}const Tu=new Map;async function qw(a){if(Tu.has(a))return Tu.get(a);const e=wi(`/assets/environment/asteroids/${a}`),i=await fetch(e).then(n=>n.json());return Tu.set(a,i),i}async function jw(a,e){const i=await qw(a),n=new Yw(e,[],{position:i.transform.position,rotation:i.transform.rotation,velocity:{x:0,y:0},angularVelocity:0});for(const o of i.blocks){const l=Rm(o.id);if(!l)throw new Error(`Unknown block type: ${o.id}`);const h={id:crypto.randomUUID(),ownerFaction:xs.Neutral,type:l,hp:l.armor,ownerShipId:n.id,position:{x:0,y:0},rotation:o.rotation};n.placeBlock(o.coord,h)}return n}class Kw{constructor(e,i){this.grid=e,this.registry=i}async createAsteroid(e,i,n={x:0,y:0},o=0){const l=await jw(e+".json",this.grid),h=l.getTransform();return h.position={...i},h.velocity={...n},h.angularVelocity=o,this.registry.add(l),l}}const Zw={id:"asteroid-field-01",asteroids:[{asteroidId:"asteroid_0_00",count:100},{asteroidId:"asteroid_0_01",count:100}],velocityRange:{x:[-50,50],y:[-50,50]},angularVelocityRange:[-1,1]},Qw={id:"asteroid-field-02",bounds:{x:-2e3,y:-1500,width:4e3,height:3e3},density:.8,velocityRange:{x:[-.2,.2],y:[-.1,.1]},angularVelocityRange:[-.1,.1],asteroids:[{asteroidId:"asteroid_0_00",count:30},{asteroidId:"asteroid_0_01",count:20},{asteroidId:"asteroid_0_02",count:15}]},$w=new Map([["asteroid-field-01",Zw],["asteroid-field-02",Qw]]);function Jw(a){return $w.get(a)}class eA{constructor(e,i){this.factory=new Kw(e,i)}spawnFieldById(e){const i=Jw(e);if(!i){console.warn(`[AsteroidSpawningSystem] Unknown field id: ${e}`);return}this.spawnField(i)}spawnField(e){var n,o;const i=e.bounds??{x:wl.x-gn/2,y:wl.y-ba/2,width:gn,height:ba};for(const l of e.asteroids)for(let h=0;h<l.count;h++){const u=i.x+Math.random()*i.width,d=i.y+Math.random()*i.height,g=this.randomInRange(((n=e.velocityRange)==null?void 0:n.x)??[-.1,.1]),m=this.randomInRange(((o=e.velocityRange)==null?void 0:o.y)??[-.1,.1]),y=this.randomInRange(e.angularVelocityRange??[-.05,.05]);this.factory.createAsteroid(l.asteroidId,{x:u,y:d},{x:g,y:m},y)}}randomInRange([e,i]){return e+Math.random()*(i-e)}}class tA{constructor(e,i,n,o){this.explosionSystem=e,this.pickupSpawner=i,this.destructionService=n,this.floatingTextManager=o}applyDamageToBlock(e,i,n,o,l,h="scripted",u=null){var M,b,C,w,A,E;if(n.indestructible||i.getFaction()===e.getFaction())return!1;const d=Qi.getEnemyPower();if(u!=null&&u.getIsPlayerShip()&&!(e instanceof zt&&e.getIsPlayerShip())?l/=d:!(u!=null&&u.getIsPlayerShip())&&e instanceof zt&&e.getIsPlayerShip()&&(l*=d),n.isShielded&&e instanceof zt){const x=(M=e.getEnergyComponent)==null?void 0:M.call(e),I=n.shieldEfficiency??0;if(I>0){const D=Math.random()*5+5,N=ke.getInstance().isLightingEnabled()&&h!=="collision"?{lightRadiusScalar:D,lightIntensity:1.2,lightLifeScalar:.5,lightColor:"#00ffff"}:void 0,H=Math.max(.001,I),W=l/H;if(x&&x.spend(W))return n.position&&(si(e,u,{file:"assets/sounds/sfx/ship/energy-shield-hit_00.wav",channel:"sfx",baseVolume:.65,pitchRange:[2,2.5],volumeJitter:.1,maxSimultaneous:5}),this.explosionSystem.createShieldDeflection(n.position,n.shieldSourceId??"shield0",N)),!1}}n.hp-=l;const m=ke.getInstance().isLightingEnabled()&&h!=="collision"?{lightRadiusScalar:12,lightIntensity:1,lightLifeScalar:.7,lightColor:h==="laser"?"#00ffff":void 0}:void 0;if(n.position){let x=!0;(h==="laser"||h==="collision")&&(x=Math.random()<.2),x&&this.explosionSystem.createExplosion(n.position,20,.3,void 0,fa,m);const I=e.getTransform().position.x+o.x,D=e.getTransform().position.y+o.y;(b=this.floatingTextManager)==null||b.createWorldText(`${Math.floor(l)}`,I,D,ut.getInstance(),10,"monospace",.8,140,1,"#FFFFFF",{impactScale:1.5},n.ownerShipId)}if(si(e,u,{file:"assets/sounds/sfx/explosions/hit_00.wav",channel:"sfx",baseVolume:.25,pitchRange:[.2,.4],volumeJitter:.1,maxSimultaneous:3}),n.hp>0)return!1;if(o.x===0&&o.y===0)return this.destructionService.destroyEntity(e,h),!0;const v=n.type.id.startsWith("cockpit");if(this.explosionSystem.createBlockExplosion(e.getTransform().position,e.getTransform().rotation,o,70*(v?2:1),.7*(v?2:1),void 0,fa),si(e,u,{file:"assets/sounds/sfx/explosions/explosion_00.wav",channel:"sfx",baseVolume:1,pitchRange:[.7,1],volumeJitter:.2,maxSimultaneous:3}),this.pickupSpawner.spawnPickupOnBlockDestruction(n),e.removeBlock(o),e instanceof zt&&((C=e.getIsPlayerShip)!=null&&C.call(e))&&Te.incrementBlocksLost(1),e instanceof zt){if(v)return this.destructionService.destroyEntity(e,h),si(e,u,{file:"assets/sounds/sfx/explosions/explosion_01.wav",channel:"sfx",baseVolume:.8,pitchRange:[.7,1],volumeJitter:.2}),!0;const x=(w=e.getCockpitCoord)==null?void 0:w.call(e);if(!x)return!0;const I=ay(e,x),D=e.getBlockMap(),N=[],H=[];for(const[K,Z]of D.entries()){if(I.has(K))continue;const Q=hn(K);this.explosionSystem.createBlockExplosion(e.getTransform().position,e.getTransform().rotation,Q,60+Math.random()*20,.5+Math.random()*.3,void 0,fa),this.pickupSpawner.spawnPickupOnBlockDestruction(Z),N.push(Q),H.push(Z)}N.length>0&&(e.removeBlocks(N,H),e instanceof zt&&((A=e.getIsPlayerShip)!=null&&A.call(e))&&Te.incrementBlocksLost(N.length));const W=Array.from(e.getBlockMap().values());if(W.length===1&&W[0].type.id.startsWith("cockpit")){const K=(E=e.getCockpitCoord)==null?void 0:E.call(e);if(K){const Z=W[0];this.explosionSystem.createBlockExplosion(e.getTransform().position,e.getTransform().rotation,K,140,1.2,void 0,fa),this.pickupSpawner.spawnPickupOnBlockDestruction(Z),e.removeBlock(K),this.destructionService.destroyEntity(e,h),si(e,u,{file:"assets/sounds/sfx/explosions/explosion_01.wav",channel:"sfx",baseVolume:.8,pitchRange:[.7,1],volumeJitter:.2})}}}return!0}}class iA{constructor(e){this.shipRegistry=e}update(e){var i;for(const n of this.shipRegistry.getAll()){const o=n.getEnergyComponent(),l=n.getShieldComponent();if(o&&(o.update(e),l.isActive())){let h=0;for(const g of n.getShieldBlocks()){const m=((i=g.type.behavior)==null?void 0:i.shieldEnergyDrain)??0;h+=m}const u=h*e;o.spend(u)||l.deactivate()}}}}function sA(a,e){const i="assets/sounds/sfx/ship/engine_loop_00.wav";return a&&!e?($.startLoop(i,"sfx",{volume:1,pitch:1,pan:0}),!0):!a&&e?($.stopLoop(i),!1):e}function nA({inputManager:a,pause:e,resume:i,shipBuilderMenu:n,pauseMenu:o,settingsMenu:l,blockDropDecisionMenu:h,menuManager:u}){const d=a.wasActionJustPressed("openShipBuilder"),g=a.wasActionJustPressed("pause"),m=u.getTop();if(d){if(h.isOpen())return;if(!l.isOpen()&&!o.isOpen()&&!n.isOpen()&&!h.isOpen())if(console.log("Attempting to open blockDropDecisionMenu..."),h.hasBlocksInQueue()){console.log("Called openMenu on blockDropDecisionMenu"),h.openMenu();return}else console.log("No blocks in queue, not opening blockDropDecisionMenu"),$.play("assets/sounds/sfx/ui/error_00.wav","sfx");console.log("Failed to open blockDropDecisionMenu");return}if(g){if(h.isOpen())return;m?(u.pop(),u.anyOpen()||i()):(e(),u.open(o))}}class aA{constructor(e,i){this.grid=e,this.camera=i}getVisibleShips(){return this.queryShipsInBounds(250)}getActiveAIShips(){return this.queryShipsInBounds(2e3)}queryShipsInBounds(e){const i=this.camera.getViewportBounds(),n=i.x-e,o=i.y-e,l=i.x+i.width+e,h=i.y+i.height+e,u=this.grid.getBlocksInArea(n,o,l,h),d=new Set;for(const g of u){const m=Vt.getObject(g);m&&m instanceof zt&&d.add(m)}return Array.from(d)}}class oA{constructor(e,i){this.grid=e,this.camera=i}getVisibleObjects(){const e=this.camera.getViewportBounds();return this.queryObjectsInBounds(e.x,e.y,e.x+e.width,e.y+e.height)}getNearbyObjects(){const e=this.camera.getViewportBounds(),i=2e3;return this.queryObjectsInBounds(e.x-i,e.y-i,e.x+e.width+i,e.y+e.height+i)}queryObjectsInBounds(e,i,n,o){const l=this.grid.getBlocksInArea(e,i,n,o),h=new Set;for(const u of l){const d=Vt.getObject(u);d&&h.add(d)}return Array.from(h)}}class rA{constructor(e){this.registry=e}update(e){for(const i of this.registry.getAll())i.update(e)}}function lA(a){const e=new zt(a,void 0,void 0,!0,void 0,xs.Player);return e.setIsPlayerShip(!0),e.placeBlockById({x:0,y:-3},"hull1"),e.placeBlockById({x:0,y:0},"cockpit1"),e.placeBlockById({x:0,y:-1},"hull1"),e.placeBlockById({x:0,y:-2},"turret1"),e.placeBlockById({x:-1,y:-1},"fin1"),e.placeBlockById({x:1,y:-1},"fin1",90),e.placeBlockById({x:1,y:0},"hull1"),e.placeBlockById({x:-1,y:0},"hull1"),e.placeBlockById({x:2,y:0},"turret1",90),e.placeBlockById({x:-2,y:0},"turret1"),e.placeBlockById({x:0,y:1},"engine1"),e.placeBlockById({x:-1,y:1},"engine1"),e.placeBlockById({x:1,y:1},"engine1"),e.hideAllBlocks(),e.setFiringMode(Xt.Sequence),e}class cA extends ef{constructor(e,i,n){super(e,i,n),this.setImmoveable(!0)}update(e){}onDestroyed(){}placeBlockById(e,i,n){const o=oi(i);if(!o)throw new Error(`Unknown block type: ${i}`);const l=this.calculateBlockWorldPosition(e),h={ownerFaction:xs.Neutral,id:crypto.randomUUID(),type:o,hp:o.armor,ownerShipId:this.id,position:l,...n!==void 0?{rotation:n}:{}};this.placeBlock(e,h)}}function hA(a){const e=new cA(a);return e.placeBlockById({x:-1e4,y:1e4},"hull1"),e}class uA{constructor(e=256){this.cells=new Map,this.factionCells=new Map,this.cellSize=e}getCellCoords(e,i){return[Math.floor(e/this.cellSize),Math.floor(i/this.cellSize)]}getOrCreateCell(e,i,n){let o=e.get(i);o||(o=new Map,e.set(i,o));let l=o.get(n);return l||(l=[],o.set(n,l)),l}getFactionMap(e){let i=this.factionCells.get(e);return i||(i=new Map,this.factionCells.set(e,i)),i}getCellSources(e){if(!e)return[this.cells];const i=[];for(const[n,o]of this.factionCells)n!==e&&i.push(o);return i}addBlockToCell(e){const{x:i,y:n}=e.position,[o,l]=this.getCellCoords(i,n),h=this.getOrCreateCell(this.cells,o,l);h.includes(e)||h.push(e);const u=this.getFactionMap(e.ownerFaction),d=this.getOrCreateCell(u,o,l);d.includes(e)||d.push(e)}removeBlockFromCell(e){const{x:i,y:n}=e.position,[o,l]=this.getCellCoords(i,n),h=this.cells.get(o),u=h==null?void 0:h.get(l);if(u){const m=u.indexOf(e);m!==-1&&u.splice(m,1)}const d=this.getFactionMap(e.ownerFaction).get(o),g=d==null?void 0:d.get(l);if(g){const m=g.indexOf(e);m!==-1&&g.splice(m,1)}}removeBlocksFromCells(e){for(const i of e)this.removeBlockFromCell(i)}getBlocksInCell(e,i,n){const[o,l]=this.getCellCoords(e,i);return this.getBlocksInCellByCoords(o,l,n)}getBlocksInCellByCoords(e,i,n){const o=this.getCellSources(n),l=[];for(const h of o){const u=h.get(e);if(!u)continue;const d=u.get(i);d&&l.push(...d)}return l}getRelevantCells(e){const i=Math.floor(e.x/this.cellSize),n=Math.floor(e.y/this.cellSize),o=[];for(let l=-1;l<=1;l++)for(let h=-1;h<=1;h++)o.push({x:i+l,y:n+h});return o}getAllBlocksInCells(e,i,n,o,l){const h=[],u=this.getCellSources(l);for(let d=e;d<=n;d++)for(let g=i;g<=o;g++)for(const m of u){const y=m.get(d);if(!y)continue;const v=y.get(g);v&&h.push(...v)}return h}getBlocksInArea(e,i,n,o,l){const h=Math.floor(e/this.cellSize),u=Math.floor(i/this.cellSize),d=Math.floor(n/this.cellSize),g=Math.floor(o/this.cellSize);return this.getAllBlocksInCells(h,u,d,g,l)}getBlocksAlongRay(e,i,n=0,o){const l=new Set,h=i.x-e.x,u=i.y-e.y,d=h>0?1:-1,g=u>0?1:-1,m=Math.abs(this.cellSize/h),y=Math.abs(this.cellSize/u);let v=Math.floor(e.x/this.cellSize),M=Math.floor(e.y/this.cellSize);const b=Math.floor(i.x/this.cellSize),C=Math.floor(i.y/this.cellSize),w=h>0?(v+1)*this.cellSize-e.x:e.x-v*this.cellSize,A=u>0?(M+1)*this.cellSize-e.y:e.y-M*this.cellSize;let E=Math.abs(w/h),x=Math.abs(A/u);const I=500;let D=[[0,0]];if(n>0){const N=n/2,H=Math.sqrt(h*h+u*u),W=h/H,Z=-(u/H),Q=W,Y=Math.ceil(N/this.cellSize),ne=new Set;D=[];for(let J=-Y;J<=Y;J++){const ee=Math.round(Z*J),_=Math.round(Q*J),z=ee<<8^_;ne.has(z)||(ne.add(z),D.push([ee,_]))}}for(let N=0;N<I;N++){for(const[H,W]of D){const K=v+H,Z=M+W,Q=this.getBlocksInCellByCoords(K,Z,o);for(const Y of Q)l.add(Y)}if(v===b&&M===C)break;E<x?(E+=m,v+=d):(x+=y,M+=g)}return Array.from(l)}getFirstBlockAlongRay(e,i,n){const o=i.x-e.x,l=i.y-e.y,h=Math.sqrt(o*o+l*l);if(h===0)return null;const u={x:o/h,y:l/h},d=this.getBlocksAlongRay(e,i,0,n);let g=null,m=1/0;for(const y of d){const v=y.position,M=this.cellSize/2,b={x:v.x-M,y:v.y-M},C={x:v.x+M,y:v.y+M},w=fA(e,u,b,C);w.hit&&w.tmin>=0&&w.tmin<m&&w.tmin<=h&&(m=w.tmin,g={block:y,point:{x:e.x+u.x*w.tmin,y:e.y+u.y*w.tmin}})}return g}clear(){this.cells.clear(),this.factionCells.clear()}}function fA(a,e,i,n){const o=1/e.x,l=1/e.y;let h=(i.x-a.x)*o,u=(n.x-a.x)*o,d=(i.y-a.y)*l,g=(n.y-a.y)*l;const m=Math.max(Math.min(h,u),Math.min(d,g));return{hit:Math.min(Math.max(h,u),Math.max(d,g))>=Math.max(0,m),tmin:m}}class dA{constructor(e,i,n,o){this.camera=i,this.particleManager=n,this.lightingOrchestrator=o,this.explosions=[],this.ctx=e.getContext("fx")}createExplosion(e,i=60,n=.6,o,l,h){if(this.particleManager.emitBurst(e,10+Math.floor(i/10),{colors:l,baseSpeed:200,sizeRange:[1,3],lifeRange:[.4,1],fadeOut:!0}),this.lightingOrchestrator&&ke.getInstance().isLightingEnabled()&&h){const u=l1(o),d=ai({x:e.x,y:e.y,radius:i*(h.lightRadiusScalar??5),color:h.lightColor??u,intensity:h.lightIntensity??.3,life:n*(h.lightLifeScalar??1),expires:!0});this.lightingOrchestrator.registerLight(d)}this.explosions.push({position:{...e},size:1,maxSize:i,life:n,maxLife:n,color:o??this.getRandomExplosionColor()})}createBlockExplosion(e,i,n,o=70,l=.7,h,u,d){const m=n.x*32,y=n.y*32,v=Math.cos(i),M=Math.sin(i),b=m*v-y*M,C=m*M+y*v,w=e.x+b,A=e.y+C;this.createExplosion({x:w,y:A},o,l,h,u,d)}createShieldDeflection(e,i,n){const o=Jm[i],l=(o==null?void 0:o[0])??"rgba(100, 255, 255, 0.6)",h=o??["#ffff00","#ff9900","#ff6600"],u=n?{...n,lightColor:n.lightColor??oy(o??["#00ffff"])}:void 0;this.createExplosion(e,34,.3,l,h,u)}update(e){for(const i of this.explosions){i.life-=e;const n=1-i.life/i.maxLife;n<.5?i.size=i.maxSize*(n*2):i.size=i.maxSize*(1-(n-.5)*2)}this.explosions=this.explosions.filter(i=>i.life>0)}render(){const e=this.ctx;e.save(),e.scale(this.camera.getZoom(),this.camera.getZoom());for(const i of this.explosions){const n=this.camera.worldToScreen(i.position.x,i.position.y),o=n.x/this.camera.getZoom(),l=n.y/this.camera.getZoom(),h=e.createRadialGradient(o,l,0,o,l,i.size),u=i.life/i.maxLife;h.addColorStop(0,`rgba(255, 255, 200, ${u})`),h.addColorStop(.2,`${i.color}`),h.addColorStop(1,"rgba(0, 0, 0, 0)"),e.globalAlpha=u,e.fillStyle=h,e.beginPath(),e.arc(o,l,i.size,0,Math.PI*2),e.fill()}e.restore()}getRandomExplosionColor(){const e=["rgba(255, 100, 0, 0.8)","rgba(255, 50, 0, 0.8)","rgba(255, 200, 0, 0.8)","rgba(200, 0, 0, 0.8)"];return e[Math.floor(Math.random()*e.length)]}}class gA{constructor(e,i){this.camera=i,this.runWhilePaused=!0,this.effects=[],this.ctx=e.getContext("fx")}createRepairEffect(e,i=48,n=.5){this.effects.push(this.createEffect(e,i,n,"repair"))}createSellEffect(e,i=48,n=.5){this.effects.push(this.createEffect(e,i,n,"sell"))}createEffect(e,i,n,o){const l=this.generateSparkles(e,8+Math.floor(i/8),o);return{kind:o,position:{...e},size:0,maxSize:i,life:n,maxLife:n,color:this.getRandomColor(o),sparkles:l}}generateSparkles(e,i,n){const o=n==="repair"?["#00ffff","#66ffcc","#66ccff","#33ffee","#ccffff"]:["#ff6666","#ff3333","#ff9999","#ff4444","#ff2200"],l=[];for(let h=0;h<i;h++){const u=Math.random()*Math.PI*2,d=20+Math.random()*40;l.push({x:e.x,y:e.y,vx:Math.cos(u)*d,vy:Math.sin(u)*d,size:1+Math.random()*2,life:.4+Math.random()*.4,color:o[Math.floor(Math.random()*o.length)]})}return l}update(e){for(const i of this.effects){i.life-=e;const n=1-i.life/i.maxLife;i.size=n<.5?i.maxSize*(n*2):i.maxSize*(1-(n-.5)*2);for(const o of i.sparkles)o.x+=o.vx*e,o.y+=o.vy*e,o.life-=e;i.sparkles=i.sparkles.filter(o=>o.life>0)}this.effects=this.effects.filter(i=>i.life>0)}render(){const e=this.ctx;e.save(),e.scale(this.camera.getZoom(),this.camera.getZoom());for(const i of this.effects){const n=this.camera.worldToScreen(i.position.x,i.position.y),o=n.x/this.camera.getZoom(),l=n.y/this.camera.getZoom(),h=i.life/i.maxLife,u=e.createRadialGradient(o,l,0,o,l,i.size);u.addColorStop(0,`rgba(255,255,255,${h})`),u.addColorStop(.3,i.color),u.addColorStop(1,"rgba(0,0,0,0)"),e.globalAlpha=h,e.fillStyle=u,e.beginPath(),e.arc(o,l,i.size,0,Math.PI*2),e.fill();for(const d of i.sparkles){const g=this.camera.worldToScreen(d.x,d.y);e.globalAlpha=d.life,e.fillStyle=d.color,e.beginPath(),e.arc(g.x/this.camera.getZoom(),g.y/this.camera.getZoom(),d.size,0,Math.PI*2),e.fill()}}e.restore()}getRandomColor(e){const n={repair:["rgba(100, 255, 255, 0.8)","rgba(100, 255, 200, 0.8)","rgba(150, 255, 240, 0.8)","rgba(120, 255, 220, 0.8)"],sell:["rgba(255, 100, 100, 0.8)","rgba(255, 80, 80, 0.8)","rgba(255, 120, 120, 0.8)","rgba(255, 60, 60, 0.8)"]}[e];return n[Math.floor(Math.random()*n.length)]}}class pA{constructor(e){this.flashes=[];try{this.ctx=e.getContext("overlay"),this.width=e.getWidth(),this.height=e.getHeight()}catch(i){console.error("Failed to initialize ScreenEffectsSystem:",i);const n=document.createElement("canvas");this.ctx=n.getContext("2d"),this.width=1,this.height=1}}createFlash(e="white",i=.5,n=.3){this.flashes.push({color:e,intensity:Math.max(0,Math.min(1,i)),duration:n,currentTime:0})}createExplosionFlash(e=.3){this.createFlash("rgba(255, 255, 220, 1)",e,.2)}createDamageFlash(e=.2){this.createFlash("rgba(255, 0, 0, 1)",e,.15)}update(e){for(const i of this.flashes)i.currentTime+=e;this.flashes=this.flashes.filter(i=>i.currentTime<i.duration)}render(){if(!(!this.ctx||this.flashes.length===0))try{const e=this.ctx;e.clearRect(0,0,this.width,this.height);for(const i of this.flashes){const n=i.currentTime/i.duration,o=i.intensity*(1-n);e.fillStyle=this.getColorWithAlpha(i.color,o),e.fillRect(0,0,this.width,this.height)}}catch(e){console.error("Error rendering screen effects:",e)}}getColorWithAlpha(e,i){if(e.startsWith("rgba"))return e.replace(/[\d.]+\)$/,`${i})`);if(e.startsWith("rgb"))return e.replace("rgb","rgba").replace(")",`, ${i})`);const n=document.createElement("div");n.style.color=e,document.body.appendChild(n);const o=getComputedStyle(n).color;return document.body.removeChild(n),o.replace("rgb","rgba").replace(")",`, ${i})`)}}class mA{constructor(){var u;this.boundUpdate=d=>this.update(d),this.boundRender=d=>this.render(d),this.menuManager=Rs.getInstance(),this.camera=null,this.shipRegistry=Tt.getInstance(),this.blockObjectRegistry=un.getInstance(),this.grid=null,this.ship=null,this.spaceStation=null,this.engineSoundPlaying=!1,this.updatables=[],this.renderables=[],this.isPaused=!1,this.isDestroyed=!1,this.update=d=>{if(!this.isDestroyed){if(this.engineSoundPlaying=sA(this.inputManager.isKeyPressed("KeyW"),this.engineSoundPlaying),nA({inputManager:this.inputManager,pause:this.pause.bind(this),resume:this.resume.bind(this),shipBuilderMenu:this.shipBuilderMenu,pauseMenu:this.pauseMenu,settingsMenu:this.settingsMenu,blockDropDecisionMenu:this.blockDropDecisionMenu,menuManager:this.menuManager}),this.blockDropDecisionMenu.isOpen()&&(this.blockDropDecisionMenu.update(d),this.ship&&this.blockPlacementController.update(this.ship.getTransform())),this.pauseMenu.isOpen()&&this.pauseMenu.update(),this.settingsMenu.isOpen()&&this.settingsMenu.update(),this.shipBuilderMenu.isOpen()&&this.shipBuilderMenu.update(),this.spaceStationBuilderMenu.isOpen()&&this.spaceStationBuilderMenu.update(),this.inputManager.wasKeyJustPressed("Digit2")&&Ee.unlockAllFlags(),this.inputManager.wasKeyJustPressed("KeyG")&&(xo("bloom"),xo("chromaticAberration")),this.inputManager.wasKeyJustPressed("Digit4")&&$p(),this.inputManager.wasKeyJustPressed("Digit5")&&yC(),this.inputManager.wasKeyJustPressed("Digit6")&&vC(),this.inputManager.wasKeyJustPressed("Digit7")&&bC(),this.inputManager.wasKeyJustPressed("KeyH")&&vu(),this.inputManager.wasKeyJustPressed("Digit1")){const g=["engine1","engine2","engine3","engine4","hull1","hull2","hull3","fin1","fin2","facetplate1","facetplate2","turret1","turret2","turret3","turret4","laser1","harvester1","battery1","shield1","turret2","fuelTank1"];for(let m=0;m<20;m++)this.blockDropDecisionMenu.enqueueBlock(oi(g[Math.floor(Math.random()*g.length)]))}this.inputManager.wasKeyJustPressed("KeyN")&&(this.waveSpawner.getIsPaused()?this.waveSpawner.resume():this.waveSpawner.pause()),this.inputManager.wasKeyJustPressed("Digit0")&&Be.getInstance().addCurrency(1e3),this.inputManager.wasKeyJustPressed("KeyO")&&(this.shipBuilderMenu.isOpen()?(this.shipBuilderMenu.closeMenu(),this.resume()):(this.pause(),this.shipBuilderMenu.openMenu())),this.inputManager.wasKeyJustPressed("KeyU")&&ni.getInstance().unlockAll(),this.inputManager.wasRightBracketPressed()&&this.waveSpawner.skipToNextWave(),this.inputManager.wasKeyJustPressed("KeyI")&&(this.spaceStationBuilderMenu.isOpen()?(this.resume(),console.log("Closing space station builder menu..."),this.spaceStationBuilderMenu.closeMenu()):(this.pause(),console.log("Opening space station builder menu..."),this.spaceStationBuilderMenu.openMenu()));try{if(!this.ship||typeof this.ship.getTransform!="function"||!this.camera)return;const g=this.ship.getTransform();this.camera.adjustZoom(this.inputManager.consumeZoomDelta()),this.camera.follow(g.position),this.camera.update(d),this.shipBuilderMenu.isOpen()&&this.shipBuilderController.update(g),this.spaceStationBuilderMenu.isOpen()&&this.spaceStation&&this.spaceStationBuilderController.update(this.spaceStation.getTransform())}catch(g){console.error("Error getting ship transform:",g)}this.isPaused||this.updatables.forEach(g=>g.update(d)),this.hud.update(d),this.shipBuilderEffects.update(d),this.inputManager.updateFrame(),this.missionDialogueManager.update(d),this.floatingTextManager.update(d),this.coachMarkManager.update(d)}},this.render=d=>{if(!this.ship||this.isDestroyed)return;const g=this.ship.getTransform();if(this.canvasManager.clearLayer("fx"),this.canvasManager.clearLayer("particles"),this.canvasManager.clearLayer("ui"),this.canvasManager.clearLayer("overlay"),this.canvasManager.clearLayer("dialogue"),this.renderables.forEach(m=>m.render(d)),this.camera){const m=this.shipCulling.getVisibleShips(),y=this.blockObjectCulling.getVisibleObjects(),v=[...m,...y],M=this.lightingOrchestrator.collectVisibleLights(this.camera),b=this.particleManager.getActiveParticles(),C=Ku.getAndClear();this.unifiedSceneRenderer.render(this.camera,v,M,C,b)}this.shipBuilderEffects.render(),this.shipBuilderMenu.isOpen()&&(this.shipBuilderController.render(this.canvasManager.getContext("entities"),g),this.shipBuilderMenu.render(this.canvasManager.getContext("ui"))),this.blockDropDecisionMenu.isOpen()&&(this.blockDropDecisionMenu.render(this.canvasManager.getContext("ui")),this.blockPlacementController.render(this.canvasManager.getContext("entities"),g)),this.spaceStationBuilderMenu.isOpen()&&this.spaceStation&&(this.spaceStationBuilderController.render(this.canvasManager.getContext("entities"),this.spaceStation.getTransform()),this.spaceStationBuilderMenu.render(this.canvasManager.getContext("ui"))),this.pauseMenu.isOpen()&&this.pauseMenu.render(this.canvasManager.getContext("ui")),this.settingsMenu.isOpen()&&this.settingsMenu.render(this.canvasManager.getContext("ui")),this.cursorRenderer.render()},this.canvasManager=Ai.getInstance(),this.inputManager=new Dm(this.canvasManager.getCanvas("ui")),this.grid=new uA,this.gameLoop=new Pm,this.camera=ut.getInstance(ui(),bi()),_S(this.canvasManager.getWebGL2Context("unifiedgl2")),rS(this.canvasManager.getWebGL2Context("unifiedgl2")),gS(this.canvasManager.getWebGL2Context("unifiedgl2")),AS(this.canvasManager.getWebGL2Context("unifiedgl2")),Rl(this.canvasManager,this.camera),this.popupMessageSystem=new _C(this.canvasManager),this.lightingOrchestrator=Ze.getInstance(),this.particleManager=new KT(this.lightingOrchestrator),ji.initialize(this.canvasManager,this.camera),this.mission=Qi.getMission(),Te.initialize(),Be.getInstance().initialize(0),Es.getInstance().initialize(),this.ship=lA(this.grid),this.shipRegistry.add(this.ship),this.shipRegistry.setPlayerShip(this.ship),this.shipCulling=new aA(this.grid,this.camera),this.blockObjectCulling=new oA(this.grid,this.camera),this.explosionSystem=new dA(this.canvasManager,this.camera,this.particleManager,this.lightingOrchestrator),this.screenEffects=new pA(this.canvasManager),this.shipBuilderEffects=new gA(this.canvasManager,this.camera),this.cursorRenderer=new ju(this.canvasManager,this.inputManager,this.ship),this.aiOrchestrator=new Lu,this.aiOrchestrator.registerPlayerShip(this.ship),this.shipBuilderMenu=new $2(this.inputManager,this.cursorRenderer),this.settingsMenu=new pC(this.inputManager,this.menuManager,this.canvasManager,this.camera),this.pauseMenu=new SC(this.inputManager,this.handlePlayerFailure.bind(this),this.menuManager),this.menuManager.registerMenu("pauseMenu",this.pauseMenu),this.menuManager.registerMenu("settingsMenu",this.settingsMenu),this.menuManager.registerMenu("shipBuilderMenu",this.shipBuilderMenu),this.menuManager.registerPauseHandlers(this.pause.bind(this),this.resume.bind(this)),this.shipBuilderController=new Ew(this.ship,this.shipBuilderMenu,this.camera,this.shipBuilderEffects,this.inputManager),this.shipBuilderMenu.setRepairAllHandler(()=>{this.shipBuilderController.repairAllBlocks()}),this.blockDropDecisionMenu=new aC(this.ship,this.inputManager,this.shipBuilderEffects,this.pause.bind(this),this.resume.bind(this)),this.blockPlacementController=new oC(this.ship,this.blockDropDecisionMenu,this.camera,this.shipBuilderEffects,this.inputManager),this.pickupSystem=new Du(this.camera,this.ship,this.particleManager,this.screenEffects,this.popupMessageSystem,this.shipBuilderEffects,this.blockDropDecisionMenu);const n=new ww(this.pickupSystem),o=new Bw(this.explosionSystem,n,this.shipRegistry,this.aiOrchestrator);this.floatingTextManager=new LT;const l=new tA(this.explosionSystem,n,o,this.floatingTextManager);this.collisionSystem=new Pu(l),this.projectileSystem=new OT(this.canvasManager,this.grid,l,this.particleManager,this.ship),this.laserSystem=new HT(this.canvasManager,this.camera,this.grid,l,this.particleManager,this.ship),this.energyRechargeSystem=new iA(this.shipRegistry),this.shipConstructionAnimator=new xT(this.ship,this.camera,this.canvasManager),this.unifiedSceneRenderer=new wT(this.camera,this.inputManager),this.unifiedSceneRenderer.setAmbientLight([.4,.4,.4]),this.unifiedSceneRenderer.setBackgroundImage(((u=this.mission.environmentSettings)==null?void 0:u.backgroundId)??null),this.blockObjectUpdate=new rA(this.blockObjectRegistry);const h=new ly(this.particleManager);this.movement=new cy(this.ship,h,this.collisionSystem),Lo.register(this.ship,this.movement),this.weaponSystem=new hy(new gy(this.projectileSystem,this.ship),new py(this.laserSystem),new my(l,this.particleManager,this.grid,this.explosionSystem,this.ship),new yy(l,this.particleManager,this.grid,this.ship)),this.utilitySystem=new uy(new vy),this.playerController=new JT(this.camera,this.inputManager,this.cursorRenderer,this.ship),this.spaceStationBuilderMenu=new aM(this.inputManager,this.cursorRenderer),this.spaceStation=hA(this.grid),this.spaceStationBuilderController=new oM(this.spaceStation,this.spaceStationBuilderMenu,this.camera,this.shipBuilderEffects,this.inputManager),this.incidentOrchestrator=new Vw({canvasManager:this.canvasManager,camera:this.camera,inputManager:this.inputManager,playerShip:this.ship,aiOrchestrator:this.aiOrchestrator,popupMessageSystem:this.popupMessageSystem}),this.waveSpawner=new Hw(this.mission.waves,this.shipRegistry,this.aiOrchestrator,this.ship,this.projectileSystem,this.laserSystem,this.particleManager,this.grid,l,this.explosionSystem,this.collisionSystem,this.shipConstructionAnimator,this.incidentOrchestrator,this.popupMessageSystem),this.waveSpawner.setMissionCompleteHandler(()=>this.handlePlayerVictory()),o.onEntityDestroyed((d,g)=>{d instanceof zt&&this.waveSpawner.notifyShipDestruction(d)}),this.planetSystem=new Tw(this.ship,this.inputManager,this.camera,this.canvasManager,this.waveSpawner,this.unifiedSceneRenderer),this.planetSystem.registerPlanetsFromConfigs(Qi.getPlanetSpawnConfigs()),this.asteroidSpawner=new eA(this.grid,this.blockObjectRegistry),this.coachMarkManager=Ti.getInstance(),this.missionDialogueManager=new ew(this.inputManager,this.canvasManager,this.waveSpawner,this.ship,this.coachMarkManager),this.wavesOverlay=new xC(this.canvasManager,this.waveSpawner),this.debugOverlay=new DC(this.canvasManager,this.shipRegistry,this.aiOrchestrator),this.hud=new IC(this.canvasManager,this.ship,this.floatingTextManager,this.blockDropDecisionMenu,this.inputManager),this.miniMap=new FC(this.canvasManager,this.ship,this.aiOrchestrator,this.planetSystem,ae()),this.updatables=[this.movement,this.projectileSystem,this.laserSystem,this.particleManager,this.aiOrchestrator,this.blockObjectUpdate,this.explosionSystem,ji.getInstance(),this.screenEffects,this.pickupSystem,this.waveSpawner,this.energyRechargeSystem,{update:d=>{var m;if(!this.ship)return;const g=this.playerController.getIntent();this.movement.setIntent(g.movement),this.weaponSystem.setIntent(g.weapons),this.utilitySystem.setIntent(g.utility);try{this.weaponSystem.update(d,this.ship,this.ship.getTransform()),this.utilitySystem.update(d,this.ship,this.ship.getTransform()),(m=this.ship.getAfterburnerComponent())==null||m.update(d)}catch(y){console.error("Error updating system:",y)}}},this.popupMessageSystem,this.shipConstructionAnimator,this.planetSystem,this.lightingOrchestrator],this.renderables=[this.laserSystem,this.hud,this.miniMap,this.explosionSystem,ji.getInstance(),this.screenEffects,this.wavesOverlay,this.debugOverlay,this.popupMessageSystem,this.missionDialogueManager,this.shipConstructionAnimator,this.planetSystem,this.aiOrchestrator,this.floatingTextManager,this.coachMarkManager],this.registerLoopHandlers()}registerLoopHandlers(){this.gameLoop.onUpdate(this.boundUpdate),this.gameLoop.onRender(this.boundRender)}pause(){this.isPaused=!0,this.waveSpawner.pause()}resume(){this.isPaused=!1,this.waveSpawner.resume()}async load(){await Promise.all([])}start(){this.gameLoop.start(),this.asteroidSpawner.spawnFieldById("asteroid-field-01"),this.inputManager.disableAllActions(),$p(),setTimeout(()=>{this.ship&&this.shipConstructionAnimator.animateShipConstruction(this.ship,{color:"#ADD8E6",radius:96,intensity:1.25})},1e3),setTimeout(()=>{this.inputManager.enableAllActions(),this.missionDialogueManager.initialize()},4200)}handlePlayerVictory(e=1e4){console.log("Player victorious  debriefing will begin in 10 seconds..."),setTimeout(()=>{vu(),xo("sepia")},e-5),setTimeout(()=>{Te.finalize("victory",this.gameLoop.getElapsedSeconds()),this.destroy(),bt.setScene("debriefing")},e)}handlePlayerFailure(){vu(),xo("sepia"),console.log("Player defeated  transitioning to debriefing screen."),Te.finalize("defeat",this.gameLoop.getElapsedSeconds()),this.destroy(),bt.setScene("debriefing")}destroy(){console.log("EngineRuntime: Performing cleanup before scene transition."),this.isDestroyed=!0,this.gameLoop.offUpdate(this.boundUpdate),this.gameLoop.offRender(this.boundRender),this.gameLoop.stop(),this.waveSpawner.reset(),this.shipRegistry.clear(),this.aiOrchestrator.clear(),ji.getInstance().clear(),Be.getInstance().postMissionClear(),Es.getInstance().destroy(),Lo.clear(),Vt.clear(),ut.destroy(),Rs.getInstance().reset(),Ti.getInstance().clear(),_u.destroyInstance(),this.cursorRenderer.destroy(),this.hud.destroy(),this.miniMap.destroy(),this.lightingOrchestrator.destroy(),this.missionDialogueManager.destroy(),this.blockDropDecisionMenu.destroy(),DS(this.canvasManager.getWebGL2Context("unifiedgl2")),pS(this.canvasManager.getWebGL2Context("unifiedgl2")),kS(this.canvasManager.getWebGL2Context("unifiedgl2")),this.updatables.length=0,this.renderables.length=0,this.inputManager.destroy(),this.menuManager.reset(),this.ship=null,this.camera=null,this.grid=null,console.log("EngineRuntime: Cleanup complete.")}}let en=null;function yA(){const[a,e]=Cl.useState(!1);return Cl.useEffect(()=>{let i=!1;return(async()=>{en=new mA;try{await en.load(),i||(en.start(),e(!0))}catch(o){console.error("Failed to load runtime assets:",o)}})(),()=>{i=!0,en==null||en.destroy(),en=null}},[]),Gt.jsx("div",{style:{position:"fixed",inset:0,backgroundColor:"black",transition:"opacity 1.5s ease-in-out",opacity:a?0:1,pointerEvents:"none",zIndex:9999}})}function Sy(){try{const a=document.createElement("canvas");return a.getContext("webgl")||a.getContext("experimental-webgl")?{supported:!0}:{supported:!1,error:"WebGL context creation failed"}}catch(a){return{supported:!1,error:a instanceof Error?a.message:"An unknown error occurred"}}}const vA=Sy();console.log("WebGL Support Check:",vA);function bA(){const[a,e]=Cl.useState(bt.getScene());return Cl.useEffect(()=>{Nu()&&window.electronAPI.toggleFullscreen();const i=Sy();i.supported||console.error("WebGL is not supported on this device or browser. Lighting will not work.",i.error);const n=ct.getFirstAvailableResolution(),o=ke.getInstance();o.setViewportWidth(n.width),o.setViewportHeight(n.height);const l=Ai.getInstance();Rl(l),o.onResolutionChange(()=>{Rl(l)});const h=()=>{$.unlock(),window.removeEventListener("pointerdown",h)};window.addEventListener("pointerdown",h,{once:!0});const u=bt.onSceneChange(e);return setTimeout(()=>{bt.setScene("title")},0),()=>u()},[]),Gt.jsxs("div",{id:"canvas-root",children:[Gt.jsx("canvas",{id:"background-canvas"}),Gt.jsx("canvas",{id:"entity-canvas"}),Gt.jsx("canvas",{id:"polygon-canvas"}),Gt.jsx("canvas",{id:"fx-canvas"}),Gt.jsx("canvas",{id:"particles-canvas"}),Gt.jsx("canvas",{id:"unifiedgl2-canvas"}),Gt.jsx("canvas",{id:"ui-canvas"}),Gt.jsx("canvas",{id:"overlay-canvas"}),Gt.jsx("canvas",{id:"dialogue-canvas"}),a==="mission"&&Gt.jsx(yA,{})]})}Yb();xS();oS();dS();wS();GS.createRoot(document.getElementById("root")).render(Gt.jsx(bA,{}));
